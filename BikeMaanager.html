<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Manager</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- jsPDF for PDF exports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Base styling */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* Prevents "pull-to-refresh" on mobile */
        }
        
        /* iOS-style tap highlight color */
        [data-page], button, [data-action] {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }

        /* Active bottom navigation icon color */
        .nav-item.active svg {
            color: #0d6efd; /* Use a distinct blue */
        }
        .nav-item.active span {
            color: #0d6efd;
        }

        /* iOS-style segmented control (filters) */
        .segmented-control {
            display: flex;
            background-color: #e9e9eb; /* Light gray background */
            border-radius: 9px;
            padding: 2px;
        }
        .segmented-control button {
            flex: 1;
            padding: 5px 10px;
            border: none;
            background-color: transparent;
            color: #555;
            font-size: 13px;
            font-weight: 500;
            border-radius: 7px;
            transition: all 0.2s ease-in-out;
        }
        .segmented-control button.active {
            background-color: #ffffff;
            color: #000;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Custom scrollbar */
        .page-content::-webkit-scrollbar,
        #transaction-list::-webkit-scrollbar,
        #dashboard-reminders::-webkit-scrollbar {
            width: 4px;
        }
        .page-content::-webkit-scrollbar-thumb,
        #transaction-list::-webkit-scrollbar-thumb,
        #dashboard-reminders::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 4px;
        }
        .page-content::-webkit-scrollbar-track,
        #transaction-list::-webkit-scrollbar-track,
        #dashboard-reminders::-webkit-scrollbar-track {
            background: transparent;
        }

        /* Form input styling */
        .form-input {
            width: 100%;
            padding: 12px;
            background-color: #f3f4f6; /* bg-gray-100 */
            border-radius: 10px;
            border: 1px solid #f3f4f6;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6; /* focus:ring-blue-500 */
            background-color: #fff;
            box-shadow: 0 0 0 2px #bfdbfe; /* focus:ring-2 */
        }
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #6b7280; /* text-gray-500 */
            margin-bottom: 6px;
            padding-left: 4px;
        }
        
        /* Modal animation */
        .modal-sheet {
            transition: transform 0.3s ease-out;
            transform: translateY(100%);
        }
        .modal-sheet.open {
            transform: translateY(0);
        }
        .modal-overlay {
            transition: opacity 0.3s ease-out;
            opacity: 0;
        }
        .modal-overlay.open {
            opacity: 1;
        }

        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Sensitive data masking */
        .sensitive-mask {
            filter: blur(6px);
            opacity: 0.5;
            pointer-events: none;
            user-select: none;
        }
        .sensitive-wrapper {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }
        .lock-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 9999px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            background: rgba(219, 234, 254, 0.6);
            color: #2563eb;
            font-size: 14px;
            transition: all 0.2s ease-in-out;
        }
        .lock-button:hover {
            background: rgba(37, 99, 235, 0.1);
        }
        .lock-button.locked {
            background: rgba(248, 113, 113, 0.15);
            border-color: rgba(248, 113, 113, 0.35);
            color: #dc2626;
        }
        .analytics-locked {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            border-radius: 1rem;
            border: 1px dashed rgba(59, 130, 246, 0.4);
            background: rgba(219, 234, 254, 0.35);
            color: #1d4ed8;
            text-align: center;
            gap: 1.5rem;
        }

        /* Lucide icon sizing */
        .lucide {
            width: 1.5rem;
            height: 1.5rem;
            stroke-width: 1.8;
        }

        .highlight-pulse {
            position: relative;
            animation: highlightFade 2.5s ease-out;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
        }

        @keyframes highlightFade {
            0% {
                box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.45);
            }
            40% {
                box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
            }
            80% {
                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
            }
            100% {
                box-shadow: none;
            }
        }

        .pr-action-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 9999px;
            background: rgba(59, 130, 246, 0.08);
            color: #2563eb;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .pr-action-button:hover {
            background: rgba(59, 130, 246, 0.18);
            transform: translateY(-1px);
        }

        .pr-bike-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            background: rgba(37, 99, 235, 0.08);
            color: #1d4ed8;
            font-size: 0.75rem;
            font-weight: 600;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .pr-bike-chip:hover {
            background: rgba(37, 99, 235, 0.16);
            transform: translateY(-1px);
        }
    </style>
</head>

<body class="bg-gray-200">

    <!-- 
      Main App Wrapper
      Simulates a mobile phone screen, centered on desktop.
    -->
    <div id="app-wrapper" class="max-w-md mx-auto h-[100dvh] flex flex-col bg-gray-100 shadow-xl overflow-hidden hidden">

        <!-- App Header (Dynamic Title) -->
        <header class="bg-white/90 backdrop-blur-sm border-b border-gray-200 sticky top-0 z-20">
            <div class="px-4 py-4 flex justify-between items-center">
                <h1 id="page-title" class="text-xl font-bold text-gray-900">Dashboard</h1>
                <!-- Add Button (context-aware) -->
                <div class="flex items-center gap-3">
                    <button id="sensitive-toggle" class="lock-button locked" title="Unlock sensitive data" aria-pressed="false">
                        <i data-lucide="lock"></i>
                    </button>
                    <button id="add-button" class="text-blue-500 hidden" title="Add new item">
                        <i data-lucide="plus" class="w-7 h-7"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- 
          Content Area
          Pages will be swapped here.
        -->
        <main class="flex-1 overflow-y-auto page-content">
            
            <!-- Page: Dashboard (Home) -->
            <div id="page-dashboard" class="page p-4 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white rounded-2xl p-4 shadow-sm">
                        <span class="text-sm font-medium text-gray-500">Cash in Hand</span>
                        <div class="sensitive-wrapper mt-1">
                            <div id="dashboard-cash" class="text-2xl font-bold text-gray-900 sensitive-mask" data-sensitive="currency">••••</div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-4 shadow-sm">
                        <span class="text-sm font-medium text-gray-500">Total Revenue</span>
                        <div class="sensitive-wrapper mt-1">
                            <div id="dashboard-revenue" class="text-2xl font-bold text-gray-900 sensitive-mask" data-sensitive="currency">••••</div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-4 shadow-sm">
                        <span class="text-sm font-medium text-gray-500">Total Profit</span>
                        <div class="sensitive-wrapper mt-1">
                            <div id="dashboard-profit" class="text-2xl font-bold text-gray-900 sensitive-mask" data-sensitive="currency">••••</div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-4 shadow-sm">
                        <span class="text-sm font-medium text-gray-500">Brand New Earnings</span>
                        <div class="sensitive-wrapper mt-1">
                            <div id="dashboard-brand" class="text-2xl font-bold text-gray-900 sensitive-mask" data-sensitive="currency">••••</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white rounded-2xl p-4 shadow-sm">
                        <span class="text-sm font-medium text-gray-500">Unsold Investment</span>
                        <div id="metric-investment" class="text-2xl font-bold text-gray-900 mt-1">₹0</div>
                    </div>
                    <div class="bg-white rounded-2xl p-4 shadow-sm">
                        <span class="text-sm font-medium text-gray-500">Inventory (S/U)</span>
                        <div id="metric-inventory" class="text-2xl font-bold text-gray-900 mt-1">0 / 0</div>
                    </div>
                </div>

                <!-- Payment Reminders -->
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <h2 class="text-lg font-semibold mb-2">Payment Reminders (Next 7 Days)</h2>
                    <div id="dashboard-reminders" class="max-h-40 overflow-y-auto space-y-3 pr-2">
                        <!-- Reminders injected here -->
                    </div>
                </div>

                <!-- Recent Unsold -->
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-semibold">Unsold Bikes</h2>
                        <select id="dashboard-sort" class="form-input !p-2 !py-1 !text-sm !w-auto !rounded-lg !bg-gray-200 border-none focus:ring-0 focus:border-none">
                            <option value="recent">Recent</option>
                            <option value="high_price">High Price</option>
                            <option value="low_price">Low Price</option>
                        </select>
                    </div>
                    <div id="dashboard-recent-bikes" class="space-y-2">
                        <!-- Recent bikes injected here -->
                    </div>
                </div>
            </div>

            <!-- Page: Bikes -->
            <div id="page-bikes" class="page p-4 space-y-4 hidden">
                <!-- Filters -->
                <div class="sticky top-0 bg-gray-100 py-2 space-y-3">
                    <input type="search" id="bike-search" placeholder="Search by name, plate, or owner..." class="form-input">
                    <div class="segmented-control" id="bike-type-toggle">
                        <button data-type="second_hand" class="active">Second Hand</button>
                        <button data-type="brand_new">Brand New</button>
                    </div>
                    <div class="segmented-control" id="bike-filter">
                        <button data-filter="all" class="active">All</button>
                        <button data-filter="unsold">Unsold</button>
                        <button data-filter="sold">Sold</button>
                    </div>
                    <!-- NEW: Sort Dropdown -->
                    <div class="relative">
                        <button id="bike-sort-trigger" class="flex items-center justify-between w-full px-4 py-2 text-sm text-gray-700 bg-white border border-gray-200 rounded-lg shadow-sm">
                            <span id="bike-sort-label" class="font-medium">Sort: Recent</span>
                            <i data-lucide="chevron-down" class="w-4 h-4 ml-2 text-gray-500"></i>
                        </button>
                        <div id="bike-sort-menu" class="absolute z-10 w-full mt-1 bg-white rounded-lg shadow-lg hidden">
                            <ul class="py-1 text-sm text-gray-700">
                                <li data-sort="dateDesc" class="bike-sort-item px-4 py-2 hover:bg-gray-100 cursor-pointer">Recent</li>
                                <li data-sort="az" class="bike-sort-item px-4 py-2 hover:bg-gray-100 cursor-pointer">A-Z</li>
                                <li data-sort="za" class="bike-sort-item px-4 py-2 hover:bg-gray-100 cursor-pointer">Z-A</li>
                                <li data-sort="purchaseHigh" class="bike-sort-item px-4 py-2 hover:bg-gray-100 cursor-pointer">Purchase (High)</li>
                                <li data-sort="purchaseLow" class="bike-sort-item px-4 py-2 hover:bg-gray-100 cursor-pointer">Purchase (Low)</li>
                                <li data-sort="saleHigh" class="bike-sort-item px-4 py-2 hover:bg-gray-100 cursor-pointer">Sales (High)</li>
                                <li data-sort="saleLow" class="bike-sort-item px-4 py-2 hover:bg-gray-100 cursor-pointer">Sales (Low)</li>
                                <li data-sort="profitHigh" class="bike-sort-item px-4 py-2 hover:bg-gray-100 cursor-pointer">Profit (High)</li>
                                <li data-sort="profitLow" class="bike-sort-item px-4 py-2 hover:bg-gray-100 cursor-pointer">Profit (Low)</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- Bike List -->
                <div id="bike-list" class="space-y-3">
                    <!-- Bike card template -->
                </div>
            </div>

            <!-- Page: Credit -->
            <div id="page-credit" class="page p-4 space-y-4 hidden">
                <div class="bg-white rounded-2xl p-4 shadow-sm space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-blue-50 rounded-xl p-3">
                            <p class="text-xs text-blue-600 font-medium uppercase tracking-wide">Total Credit Given</p>
                            <p id="credit-total" class="text-xl font-bold text-blue-900 mt-1">₹0</p>
                        </div>
                        <div class="bg-green-50 rounded-xl p-3">
                            <p class="text-xs text-green-600 font-medium uppercase tracking-wide">Collected</p>
                            <p id="credit-collected" class="text-xl font-bold text-green-900 mt-1">₹0</p>
                        </div>
                        <div class="bg-orange-50 rounded-xl p-3">
                            <p class="text-xs text-amber-600 font-medium uppercase tracking-wide">Pending</p>
                            <p id="credit-pending" class="text-xl font-bold text-amber-900 mt-1">₹0</p>
                        </div>
                        <div class="bg-purple-50 rounded-xl p-3">
                            <p class="text-xs text-purple-600 font-medium uppercase tracking-wide">Active Customers</p>
                            <p id="credit-active" class="text-xl font-bold text-purple-900 mt-1">0</p>
                        </div>
                    </div>
                    <button id="credit-export" class="w-full py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition">Export Credit Data</button>
                </div>
                <div id="credit-list" class="space-y-3">
                    <!-- Credit cards injected here -->
                </div>
            </div>

            <!-- Page: Analytics -->
            <div id="page-analytics" class="page p-4 space-y-4 hidden">
                <div id="analytics-locked-state" class="hidden analytics-locked">
                    <div class="text-lg font-semibold">Sensitive analytics locked</div>
                    <p class="text-sm text-blue-700">Unlock with your PIN to review financial analytics.</p>
                    <button id="analytics-unlock" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition">Unlock Analytics</button>
                </div>
                <div id="analytics-content" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white rounded-2xl p-4 shadow-sm">
                            <span class="text-sm font-medium text-gray-500">Cash in Hand</span>
                            <div class="sensitive-wrapper mt-1">
                                <div id="analytics-cash" class="text-2xl font-bold text-gray-900 sensitive-mask" data-sensitive="currency">••••</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-4 shadow-sm">
                            <span class="text-sm font-medium text-gray-500">Total Profit</span>
                            <div class="sensitive-wrapper mt-1">
                                <div id="analytics-profit" class="text-2xl font-bold text-gray-900 sensitive-mask" data-sensitive="currency">••••</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-4 shadow-sm">
                            <span class="text-sm font-medium text-gray-500">Realized Profit</span>
                            <div class="sensitive-wrapper mt-1">
                                <div id="analytics-realized" class="text-2xl font-bold text-gray-900 sensitive-mask" data-sensitive="currency">••••</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-4 shadow-sm">
                            <span class="text-sm font-medium text-gray-500">This Month</span>
                            <div class="sensitive-wrapper mt-1">
                                <div id="analytics-month" class="text-2xl font-bold text-gray-900 sensitive-mask" data-sensitive="currency">••••</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-4 shadow-sm">
                            <span class="text-sm font-medium text-gray-500">Total Cash Inflow</span>
                            <div class="sensitive-wrapper mt-1">
                                <div id="analytics-inflow" class="text-2xl font-bold text-green-600 sensitive-mask" data-sensitive="currency">••••</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-4 shadow-sm">
                            <span class="text-sm font-medium text-gray-500">Total Cash Outflow</span>
                            <div class="sensitive-wrapper mt-1">
                                <div id="analytics-outflow" class="text-2xl font-bold text-red-600 sensitive-mask" data-sensitive="currency">••••</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl p-4 shadow-sm">
                        <h2 class="text-lg font-semibold mb-2">Cash Transaction Log</h2>
                        <div id="analytics-transaction-list" class="max-h-60 overflow-y-auto space-y-2 pr-2">
                            <!-- Transactions injected here -->
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl p-4 shadow-sm space-y-3">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold">Expenses</h2>
                            <span id="analytics-expense-total" class="text-sm font-medium text-gray-500">₹0</span>
                        </div>
                        <div id="analytics-expense-list" class="space-y-2">
                            <!-- Expenses summary -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: Expenses -->
            <div id="page-expenses" class="page p-4 space-y-3 hidden">
                <div id="expense-list" class="space-y-3">
                    <!-- Expense card template -->
                </div>
            </div>

            <!-- Page: PR (Personal Relationship) -->
            <div id="page-pr" class="page p-4 space-y-4 hidden">
                <!-- Filters -->
                <div class="sticky top-0 bg-gray-100 py-2">
                    <input type="search" id="pr-search" placeholder="Search by name, contact, or bike..." class="form-input mb-2">
                    <div class="segmented-control flex-wrap gap-2" id="pr-filter">
                        <button data-filter="all" class="active">All</button>
                        <button data-filter="Buyer">Buyers</button>
                        <button data-filter="Owner">Owners</button>
                        <button data-filter="Supplier">Suppliers</button>
                    </div>
                </div>
                <!-- PR List -->
                <div id="pr-list" class="space-y-3">
                    <!-- PR card template -->
                </div>
            </div>

            <!-- Page: Settings -->
            <div id="page-settings" class="page p-4 space-y-4">
                <!-- Cash Adjustments -->
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <h2 class="text-lg font-semibold mb-2">Cash Adjustments</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="form-label" for="cash-adj-amount">Amount *</label>
                            <input type="number" id="cash-adj-amount" placeholder="50000" class="form-input">
                        </div>
                        <div>
                            <label class="form-label" for="cash-adj-desc">Description *</label>
                            <input type="text" id="cash-adj-desc" placeholder="e.g., Initial Investment, Salary" class="form-input">
                        </div>
                        <div class="flex gap-3">
                            <button id="cash-adj-remove" class="w-full py-3 bg-red-500 text-white rounded-lg font-semibold transition hover:bg-red-600">
                                Remove Cash (-)
                            </button>
                            <button id="cash-adj-add" class="w-full py-3 bg-green-500 text-white rounded-lg font-semibold transition hover:bg-green-600">
                                Add Cash (+)
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Security Settings -->
                <div class="bg-white rounded-2xl p-4 shadow-sm space-y-3">
                    <h2 class="text-lg font-semibold">Security</h2>
                    <p id="pin-status" class="text-sm text-gray-600">
                        Sensitive data is currently <span class="font-medium">locked</span>.
                    </p>
                    <div class="space-y-3">
                        <div>
                            <label class="form-label" for="pin-current">Current PIN *</label>
                            <input type="password" id="pin-current" class="form-input" placeholder="Enter current PIN" maxlength="6" inputmode="numeric">
                        </div>
                        <div>
                            <label class="form-label" for="pin-new">New PIN *</label>
                            <input type="password" id="pin-new" class="form-input" placeholder="Choose 4-6 digit PIN" maxlength="6" inputmode="numeric">
                        </div>
                        <button id="pin-update" class="w-full py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition">
                            Update PIN
                        </button>
                    </div>
                </div>
                
                <!-- NEW: Backup & Restore Section -->
                <div class="bg-white rounded-2xl p-4 shadow-sm space-y-3">
                    <h2 class="text-lg font-semibold">Backup & Restore</h2>
                    <button id="setting-backup" class="w-full text-left px-3 py-2 bg-blue-100 rounded-lg text-blue-700 font-medium">Backup Data</button>
                    <button id="setting-restore" class="w-full text-left px-3 py-2 bg-green-100 rounded-lg text-green-700 font-medium">Restore Data</button>
                    <input type="file" id="restore-file-input" accept=".json" class="hidden">
                    <p class="text-xs text-gray-500 text-center mt-1">
                        Current Mode: <span id="backup-mode-display" class="font-medium">Local</span>
                    </p>
                </div>
                
                <!-- Data Management -->
                <div class="bg-white rounded-2xl p-4 shadow-sm space-y-3">
                    <h2 class="text-lg font-semibold">Data Management</h2>
                    <button id="setting-logout" class="w-full text-left px-3 py-2 bg-gray-100 rounded-lg text-blue-600 font-medium">Log Out / Change Sync</button>
                    <button id="setting-reset" class="w-full text-left px-3 py-2 bg-red-100 rounded-lg text-red-600 font-medium">Reset All Data</button>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation Bar -->
        <nav class="flex justify-around items-center h-16 bg-white/90 backdrop-blur-sm border-t border-gray-200 sticky bottom-0 z-20">
            <button class="nav-item flex flex-col items-center justify-center text-gray-500 active" data-page="dashboard">
                <i data-lucide="layout-dashboard"></i>
                <span class="text-xs font-medium">Home</span>
            </button>
            <button class="nav-item flex flex-col items-center justify-center text-gray-500" data-page="bikes">
                <i data-lucide="bike"></i>
                <span class="text-xs font-medium">Bikes</span>
            </button>
            <button class="nav-item flex flex-col items-center justify-center text-gray-500" data-page="credit">
                <i data-lucide="wallet"></i>
                <span class="text-xs font-medium">Credit</span>
            </button>
            <button class="nav-item flex flex-col items-center justify-center text-gray-500" data-page="analytics">
                <i data-lucide="line-chart"></i>
                <span class="text-xs font-medium">Analytics</span>
            </button>
            <button class="nav-item flex flex-col items-center justify-center text-gray-500" data-page="expenses">
                <i data-lucide="receipt"></i>
                <span class="text-xs font-medium">Expenses</span>
            </button>
            <button class="nav-item flex flex-col items-center justify-center text-gray-500" data-page="pr">
                <i data-lucide="users"></i>
                <span class="text-xs font-medium">PR</span>
            </button>
            <button class="nav-item flex flex-col items-center justify-center text-gray-500" data-page="settings">
                <i data-lucide="settings"></i>
                <span class="text-xs font-medium">Settings</span>
            </button>
        </nav>
    </div>

    <!-- 
      PAT Authentication Modal
    -->
    <div id="pat-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100 p-4 hidden">
        <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-sm">
            <h2 class="text-xl font-bold text-center mb-2">GitHub Access</h2>
            <p class="text-sm text-gray-600 text-center mb-4">
                Enter a GitHub PAT with <code class="text-xs bg-gray-200 px-1 py-0.5 rounded">gist</code> permissions to sync data.
            </p>
            <div class="space-y-3">
                <label for="pat-input" class="form-label">Personal Access Token</label>
                <input type="password" id="pat-input" class="form-input" placeholder="ghp_...">
                <button id="pat-save" class="w-full py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition">
                    Connect & Load Data
                </button>
                <button id="pat-skip" class="w-full py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition">
                    Skip & Use Locally
                </button>
            </div>
            <p id="pat-error" class="text-red-500 text-sm text-center mt-3"></p>
        </div>
    </div>
    
    <!-- 
      Global Loading Overlay
    -->
    <div id="loader" class="fixed inset-0 z-[100] flex items-center justify-center bg-white/70 backdrop-blur-sm hidden">
        <i data-lucide="loader-2" class="animate-spin h-8 w-8 text-blue-500"></i>
    </div>
    
    <!-- 
      Global Confirmation Modal
    -->
    <div id="confirm-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden">
        <div class="modal-overlay fixed inset-0 bg-black/40 backdrop-blur-sm"></div>
        <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-sm z-10">
            <h2 id="confirm-title" class="text-lg font-semibold text-center mb-2">Are you sure?</h2>
            <p id="confirm-message" class="text-sm text-gray-600 text-center mb-5">This action cannot be undone.</p>
            <div class="grid grid-cols-2 gap-3">
                <button id="confirm-cancel" class="w-full py-3 bg-gray-200 text-gray-800 rounded-lg font-medium">Cancel</button>
                <button id="confirm-ok" class="w-full py-3 bg-red-500 text-white rounded-lg font-medium">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- 
      PIN Verification Modal
    -->
    <div id="pin-modal" class="fixed inset-0 z-[70] flex items-center justify-center p-4 hidden">
        <div class="modal-overlay fixed inset-0 bg-black/40 backdrop-blur-sm"></div>
        <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-sm z-10 space-y-4">
            <div class="space-y-1 text-center">
                <h2 class="text-xl font-bold text-gray-900">Unlock Sensitive Data</h2>
                <p class="text-sm text-gray-600" id="pin-modal-message">Enter your 4-digit PIN to continue.</p>
            </div>
            <div class="space-y-3">
                <input type="password" maxlength="6" inputmode="numeric" id="pin-input" class="form-input text-center tracking-widest text-lg" placeholder="••••">
                <p id="pin-error" class="text-xs text-red-500 text-center"></p>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button id="pin-cancel" class="w-full py-3 bg-gray-200 text-gray-800 rounded-lg font-medium">Cancel</button>
                <button id="pin-submit" class="w-full py-3 bg-blue-500 text-white rounded-lg font-medium hover:bg-blue-600 transition">Unlock</button>
            </div>
        </div>
    </div>
    
    <!-- 
      Main Form Modal (Sheet style)
    -->
    <div id="form-modal" class="fixed inset-0 z-40 hidden">
        <!-- Overlay -->
        <div id="modal-overlay" class="modal-overlay fixed inset-0 bg-black/40 backdrop-blur-sm"></div>
        
        <!-- Sheet Content -->
        <div id="modal-sheet" class="modal-sheet fixed bottom-0 left-0 right-0 max-w-md mx-auto z-50 bg-gray-100 rounded-t-2xl shadow-t-lg">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <button id="modal-close" class="text-blue-500 font-medium">Cancel</button>
                <h2 id="modal-title" class="text-lg font-semibold">Modal Title</h2>
                <button id="modal-save" class="text-blue-500 font-bold">Save</button>
            </div>
            
            <!-- Modal Body (Dynamic) -->
            <div id="modal-body" class="p-4 h-[75dvh] overflow-y-auto space-y-4">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <script type="module">
        // --- DOM Elements ---
        const $ = (selector) => document.querySelector(selector);
        
        // App containers
        const appWrapper = $('#app-wrapper');
        const patModal = $('#pat-modal');
        const loader = $('#loader');
        const formModal = $('#form-modal');
        const modalOverlay = $('#modal-overlay');
        const modalSheet = $('#modal-sheet');
        const confirmModal = $('#confirm-modal');
        
        // Navigation
        const navBar = $('nav');
        const pageTitle = $('#page-title');
        const addButton = $('#add-button');
        const sensitiveToggle = $('#sensitive-toggle');
        
        // Pages
        const pages = document.querySelectorAll('.page');
        
        // Dashboard Page
        const metricInvestment = $('#metric-investment');
        const metricInventory = $('#metric-inventory');
        const dashboardRecentBikes = $('#dashboard-recent-bikes');
        const dashboardReminders = $('#dashboard-reminders');
        const dashboardSort = $('#dashboard-sort');
        const dashboardCash = $('#dashboard-cash');
        const dashboardRevenue = $('#dashboard-revenue');
        const dashboardProfit = $('#dashboard-profit');
        const dashboardBrand = $('#dashboard-brand');
        
        // Bikes Page
        const bikeList = $('#bike-list');
        const bikeFilter = $('#bike-filter');
        const bikeSearch = $('#bike-search');
        const bikeTypeToggle = $('#bike-type-toggle');
        const bikeSortTrigger = $('#bike-sort-trigger');
        const bikeSortMenu = $('#bike-sort-menu');
        const bikeSortLabel = $('#bike-sort-label');

        // Credit Page
        const creditList = $('#credit-list');
        const creditTotal = $('#credit-total');
        const creditCollected = $('#credit-collected');
        const creditPending = $('#credit-pending');
        const creditActive = $('#credit-active');
        const creditExport = $('#credit-export');

        // Expenses Page
        const expenseList = $('#expense-list');

        // PR Page
        const prList = $('#pr-list');
        const prFilter = $('#pr-filter');
        const prSearch = $('#pr-search');
        
        // Analytics Page
        const analyticsContent = $('#analytics-content');
        const analyticsLockedState = $('#analytics-locked-state');
        const analyticsUnlockBtn = $('#analytics-unlock');
        const analyticsCash = $('#analytics-cash');
        const analyticsProfit = $('#analytics-profit');
        const analyticsRealized = $('#analytics-realized');
        const analyticsMonth = $('#analytics-month');
        const analyticsExpenseTotal = $('#analytics-expense-total');
        const analyticsExpenseList = $('#analytics-expense-list');
        const analyticsInflow = $('#analytics-inflow');
        const analyticsOutflow = $('#analytics-outflow');
        const analyticsTransactionList = $('#analytics-transaction-list');

        // Settings Page
        const cashAdjAmount = $('#cash-adj-amount');
        const cashAdjDesc = $('#cash-adj-desc');
        const cashAdjAdd = $('#cash-adj-add');
        const cashAdjRemove = $('#cash-adj-remove');
        const settingLogout = $('#setting-logout');
        const settingReset = $('#setting-reset');
        const pinStatus = $('#pin-status');
        const pinCurrentInput = $('#pin-current');
        const pinNewInput = $('#pin-new');
        const pinUpdateBtn = $('#pin-update');
        
        // NEW: Backup/Restore Selectors
        const settingBackup = $('#setting-backup');
        const settingRestore = $('#setting-restore');
        const restoreFileInput = $('#restore-file-input');
        const backupModeDisplay = $('#backup-mode-display');
        
        // PAT Modal
        const patInput = $('#pat-input');
        const patSave = $('#pat-save');
        const patSkip = $('#pat-skip');
        const patError = $('#pat-error');
        
        // Form Modal
        const modalTitle = $('#modal-title');
        const modalBody = $('#modal-body');
        const modalSave = $('#modal-save');
        const modalClose = $('#modal-close');
        
        // Confirm Modal
        const confirmTitle = $('#confirm-title');
        const confirmMessage = $('#confirm-message');
        const confirmOk = $('#confirm-ok');
        const confirmCancel = $('#confirm-cancel');

        // PIN Modal
        const pinModal = $('#pin-modal');
        const pinInput = $('#pin-input');
        const pinSubmit = $('#pin-submit');
        const pinCancel = $('#pin-cancel');
        const pinError = $('#pin-error');
        const pinModalMessage = $('#pin-modal-message');

        // --- Gist API Constants ---
        const GIST_API_URL = 'https://api.github.com/gists';
        const GIST_FILENAME = 'secondHandBikeManager.data.json';
        const LOCAL_STORAGE_KEY = 'bikeManagerData';
        const DEFAULT_DATA = {
            bikes: [
                {
                    id: 'bike-splendor',
                    bikeName: 'Splendor+',
                    bikeNumberPlate: 'GJ07AC0000',
                    ownerName: 'Devgna',
                    ownerContact: '1472580369',
                    supplierName: 'Devgna',
                    supplierContact: '1472580369',
                    purchaseDate: '2025-11-09',
                    purchasePrice: 25000,
                    repairPrice: 7000,
                    createdAt: '2025-11-09T08:30:00.000Z',
                    sold: false,
                    category: 'second_hand'
                },
                {
                    id: 'bike-activa',
                    bikeName: 'Activa 5G',
                    bikeNumberPlate: 'GJ01AB4321',
                    ownerName: 'Ravi Patel',
                    ownerContact: '9510292044',
                    supplierName: 'Wheel Hub',
                    supplierContact: '9510292044',
                    purchaseDate: '2025-11-07',
                    purchasePrice: 30000,
                    repairPrice: 5000,
                    createdAt: '2025-11-07T07:45:00.000Z',
                    sold: false,
                    category: 'second_hand'
                },
                {
                    id: 'bike-hunter',
                    bikeName: 'Hunter 350',
                    bikeNumberPlate: 'GJ05CD9876',
                    ownerName: 'Akhil',
                    ownerContact: '9825123456',
                    supplierName: 'Akhil Motors',
                    supplierContact: '9825123456',
                    purchaseDate: '2025-11-05',
                    purchasePrice: 27000,
                    repairPrice: 7997,
                    createdAt: '2025-11-05T06:20:00.000Z',
                    sold: false,
                    category: 'second_hand'
                },
                {
                    id: 'bike-pulsar',
                    bikeName: 'Pulsar 150',
                    bikeNumberPlate: 'GJ09AB5554',
                    ownerName: 'Harsh',
                    ownerContact: '656565665',
                    supplierName: 'Harsh Motors',
                    supplierContact: '656565665',
                    purchaseDate: '2025-11-03',
                    purchasePrice: 22000,
                    repairPrice: 2500,
                    createdAt: '2025-11-03T05:15:00.000Z',
                    sold: true,
                    soldAt: '2025-11-08T10:00:00.000Z',
                    soldDate: '2025-11-08',
                    customerName: 'Harsh',
                    customerContact: '656565665',
                    sellingPrice: 64000,
                    paymentMode: 'credit',
                    creditInfo: {
                        initialPayment: 24000,
                        remaining: 36000,
                        dueDate: '2025-12-08'
                    },
                    referral: {
                        name: 'Ramesh',
                        contact: '9876501234',
                        commission: 2000
                    },
                    category: 'second_hand'
                }
            ],
            expenses: [],
            pr: [
                {
                    id: 'pr-devgna-buyer',
                    name: 'devgna',
                    contact: '9510292044',
                    relationType: 'Buyer',
                    relatedBikeName: 'Pulsar 150'
                },
                {
                    id: 'pr-devgna-supplier',
                    name: 'Devgna',
                    contact: '1472580369',
                    relationType: 'Supplier',
                    relatedBikeName: 'Splendor+'
                }
            ],
            cashEntries: [
                {
                    id: 'cash-init',
                    type: 'add',
                    amount: 40000,
                    description: 'Initial Capital',
                    createdAt: '2025-11-01T09:00:00.000Z'
                },
                {
                    id: 'cash-rent',
                    type: 'remove',
                    amount: 26500,
                    description: 'Workshop Rent & Utilities',
                    createdAt: '2025-11-04T12:00:00.000Z'
                }
            ],
            payments: [
                {
                    id: 'payment-initial',
                    bikeId: 'bike-pulsar',
                    bikeName: 'Pulsar 150',
                    amount: 24000,
                    date: '2025-11-08T10:30:00.000Z',
                    type: 'Initial Payment'
                },
                {
                    id: 'payment-emi-1',
                    bikeId: 'bike-pulsar',
                    bikeName: 'Pulsar 150',
                    amount: 4000,
                    date: '2025-11-08T10:45:00.000Z',
                    type: 'Credit Payment'
                }
            ],
            settings: {
                baseInvestment: 0,
                pin: '1111'
            },
            brandNewDeliveries: [
                {
                    id: 'brand-himalayan',
                    bikeModel: 'Royal Enfield Himalayan 450',
                    deliveryDate: '2025-11-06',
                    customerName: 'Amit Shah',
                    customerContact: '9876543210',
                    showroomName: 'Royal Enfield Prime',
                    commissionReceived: 12000,
                    invoiceNumber: 'RE-INV-450',
                    notes: '',
                    commissionToGive: [
                        {
                            id: 'ref-ramesh',
                            referrerName: 'Ramesh Patel',
                            referrerContact: '9876500000',
                            commissionAmount: 3000,
                            paymentStatus: 'pending'
                        }
                    ],
                    createdAt: '2025-11-06T12:15:00.000Z'
                }
            ]
        };
        
        const renderBrandNewBikes = () => {
            const search = (state.ui.currentBikeSearch || '').toLowerCase();
            const deliveries = (state.data.brandNewDeliveries || [])
                .slice()
                .sort((a, b) => new Date(b.deliveryDate || b.createdAt) - new Date(a.deliveryDate || a.createdAt))
                .filter(delivery => {
                    if (!search) return true;
                    const haystack = [
                        delivery.bikeModel,
                        delivery.customerName,
                        delivery.customerContact,
                        delivery.showroomName,
                        delivery.invoiceNumber
                    ].map(value => (value || '').toString().toLowerCase());
                    return haystack.some(field => field.includes(search));
                });
            
            if (deliveries.length === 0) {
                bikeList.innerHTML = `<p class="text-gray-500 text-center mt-4">No brand new deliveries recorded yet.</p>`;
                return;
            }

            bikeList.innerHTML = deliveries.map(delivery => {
                const commissionReceived = delivery.commissionReceived || 0;
                const paidOut = (delivery.commissionToGive || []).reduce((sum, ref) => {
                    return sum + (ref.paymentStatus === 'paid' ? (ref.commissionAmount || 0) : 0);
                }, 0);
                const pendingOut = (delivery.commissionToGive || []).reduce((sum, ref) => {
                    return sum + (ref.paymentStatus !== 'paid' ? (ref.commissionAmount || 0) : 0);
                }, 0);
                const netEarnings = commissionReceived - paidOut;
                
                const referrersHTML = (delivery.commissionToGive || []).length === 0
                    ? '<p class="text-sm text-gray-500">No referrer commissions configured.</p>'
                    : delivery.commissionToGive.map(ref => {
                        const statusPaid = ref.paymentStatus === 'paid';
                        const statusClass = statusPaid ? 'text-green-600' : 'text-amber-600';
                        const statusText = statusPaid ? 'Paid' : 'Pending';
                        const toggleLabel = statusPaid ? 'Mark Pending' : 'Mark Paid';
                        const contactInfo = ref.referrerContact
                            ? `<p class="text-xs text-gray-500">${ref.referrerContact}</p>`
                            : '';
                        return `
                            <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0" data-ref-id="${ref.id}">
                                <div>
                                    <p class="font-medium text-gray-800">${ref.referrerName || 'Unnamed Referrer'}</p>
                                    ${contactInfo}
                                </div>
                                <div class="text-right space-y-1">
                                    <p class="font-semibold text-gray-900">${formatCurrency(ref.commissionAmount || 0)}</p>
                                    <span class="text-xs font-medium ${statusClass}">${statusText}</span>
                                    <button data-action="toggle-commission" class="block text-xs text-blue-600 font-semibold"> ${toggleLabel}</button>
                                </div>
                            </div>
                        `;
                    }).join('');

                const invoiceRow = delivery.invoiceNumber
                    ? `<p class="text-xs text-gray-500">Invoice: ${delivery.invoiceNumber}</p>`
                    : '';
                const notesRow = delivery.notes
                    ? `<p class="text-xs text-gray-500">Notes: ${delivery.notes}</p>`
                    : '';

                return `
                <div class="bg-white rounded-xl p-4 shadow-sm space-y-3" data-brand-id="${delivery.id}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${delivery.bikeModel}</h3>
                            <p class="text-sm text-gray-600">${delivery.customerName || 'Customer'} • ${delivery.showroomName || 'Showroom'}</p>
                            ${invoiceRow}
                            ${notesRow}
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500">Commission Received</p>
                            <p class="text-lg font-bold text-blue-600">${formatCurrency(commissionReceived)}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 text-sm bg-gray-50 rounded-lg p-3">
                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Delivery Date</p>
                            <p class="font-semibold text-gray-800">${formatDate(delivery.deliveryDate || delivery.createdAt)}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Net Earnings</p>
                            <p class="font-semibold ${netEarnings >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(netEarnings)}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Paid Out</p>
                            <p class="font-semibold text-gray-800">${formatCurrency(paidOut)}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Pending Payout</p>
                            <p class="font-semibold text-amber-600">${formatCurrency(pendingOut)}</p>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs font-semibold text-gray-600 uppercase tracking-wide mb-2">Referrer Commissions</p>
                        <div class="space-y-2">
                            ${referrersHTML}
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-2 border-t border-gray-200">
                        <button data-action="edit-brand-new" class="text-blue-500 font-medium text-sm">Edit</button>
                        <button data-action="delete-brand-new" class="text-red-500 font-medium text-sm">Delete</button>
                    </div>
                </div>
                `;
            }).join('');
            applyPendingHighlight();
        };
        
        // --- App State ---
        let state = {
            storageMode: null, // 'gist' or 'local'
            githubPAT: null,
            gistId: null,
            data: {
                bikes: [],
                expenses: [],
                pr: [],
                cashEntries: [],
                payments: [],
                brandNewDeliveries: [],
                settings: {
                    baseInvestment: 0, // Deprecated
                    pin: '1111'
                }
            },
            ui: {
                currentPage: 'dashboard',
                currentBikeFilter: 'all',
                currentBikeSearch: '',
                currentBikeSort: 'dateDesc', // NEW
                currentBikeType: 'second_hand',
                currentDashboardSort: 'recent', // NEW
                currentPRFilter: 'all',
                currentPRSearch: '',
                modal: {
                    isOpen: false,
                    type: null,
                    data: null
                },
                isGistSaving: false,
                pendingHighlight: null,
            },
            security: {
                isUnlocked: false,
                pendingResolve: null
            },
            metrics: {
                cashInHand: 0,
                totalProfit: 0,
                totalRevenue: 0,
                brandNewEarnings: 0,
                realizedProfit: 0,
                thisMonthProfit: 0,
                unsoldInvestment: 0,
                inventorySold: 0,
                inventoryUnsold: 0,
                totalCashInflow: 0, // NEW
                totalCashOutflow: 0, // NEW
                pendingReceivables: 0,
                creditCustomers: 0,
            }
        };

        // --- Cross Navigation Helpers ---

        const setBikePageState = ({ type = 'second_hand', filter = 'all', search = '' } = {}) => {
            state.ui.currentBikeType = type;
            state.ui.currentBikeFilter = filter;
            state.ui.currentBikeSearch = search;
        };

        const scheduleBikeHighlight = (payload) => {
            state.ui.pendingHighlight = payload;
        };

        const applyPendingHighlight = () => {
            const highlight = state.ui.pendingHighlight;
            if (!highlight || state.ui.currentPage !== 'bikes') return;

            const selector = highlight.type === 'brand_new'
                ? `[data-brand-id="${highlight.id}"]`
                : `[data-bike-id="${highlight.id}"]`;

            const target = document.querySelector(selector);
            if (!target) return;

            target.classList.add('highlight-pulse');
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => target.classList.remove('highlight-pulse'), 3500);
            state.ui.pendingHighlight = null;
        };

        const navigateToBikeRecord = (bikeName) => {
            if (!bikeName) {
                showToast('No bike linked yet.', true);
                return;
            }

            const normalized = bikeName.toLowerCase();
            const matchBike = state.data.bikes.find(bike => {
                const names = [
                    (bike.bikeName || '').toLowerCase(),
                    (bike.bikeNumberPlate || '').toLowerCase()
                ];
                return names.includes(normalized);
            });

            if (matchBike) {
                setBikePageState({
                    type: 'second_hand',
                    filter: 'all',
                    search: matchBike.bikeName || matchBike.bikeNumberPlate || ''
                });
                scheduleBikeHighlight({ type: 'second_hand', id: matchBike.id });
                renderPage('bikes');
                return;
            }

            const matchBrand = state.data.brandNewDeliveries.find(delivery => (delivery.bikeModel || '').toLowerCase() === normalized);
            if (matchBrand) {
                setBikePageState({
                    type: 'brand_new',
                    filter: 'all',
                    search: matchBrand.bikeModel || ''
                });
                scheduleBikeHighlight({ type: 'brand_new', id: matchBrand.id });
                renderPage('bikes');
                return;
            }

            showToast('Could not find the linked bike yet.', true);
        };

        const filterBikesBySupplier = (supplierName) => {
            if (!supplierName) return;
            setBikePageState({
                type: 'second_hand',
                filter: 'all',
                search: supplierName
            });
            renderPage('bikes');
            showToast(`Filtered bikes by supplier: ${supplierName}`);
        };

        const filterBikesByOwner = (ownerName) => {
            if (!ownerName) return;
            setBikePageState({
                type: 'second_hand',
                filter: 'unsold',
                search: ownerName
            });
            renderPage('bikes');
            showToast(`Showing unsold bikes for ${ownerName}`);
        };

        const logPaymentForBuyer = (buyerName) => {
            if (!buyerName) {
                showToast('Buyer details missing.', true);
                return;
            }
            const normalized = buyerName.toLowerCase();
            const matches = state.data.bikes.filter(bike => (bike.customerName || '').toLowerCase() === normalized);

            if (!matches.length) {
                showToast('No bike sales linked to this buyer yet.', true);
                return;
            }

            const pendingBike = matches.find(bike => {
                if (bike.paymentMode === 'credit' && bike.creditInfo) {
                    return (bike.creditInfo.remaining || 0) > EPSILON;
                }
                if (bike.paymentMode === 'emi' && bike.emiInfo) {
                    return (bike.emiInfo.installmentsPaid || 0) < (bike.emiInfo.totalInstallments || 0);
                }
                return false;
            });

            const targetBike = pendingBike || matches[0];
            openModal('logPayment', targetBike);
        };

        const copyTextToClipboard = async (text) => {
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
                showToast('Contact copied.');
            } catch (error) {
                console.error('Clipboard error:', error);
                showToast('Unable to copy contact.', true);
            }
        };

        // --- Utility Functions ---
        
        const SENSITIVE_MASK = '••••';

        const setSensitiveValue = (element, value, formatter = (val) => val) => {
            if (!element) return;
            if (state.security.isUnlocked) {
                element.textContent = formatter(value);
                element.classList.remove('sensitive-mask');
            } else {
                element.textContent = SENSITIVE_MASK;
                element.classList.add('sensitive-mask');
            }
        };

        const setSensitiveCurrency = (element, value) => {
            setSensitiveValue(element, value ?? 0, (val) => formatCurrency(val || 0));
        };

        const refreshIcons = () => {
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
        };

        const updateSensitiveToggle = () => {
            if (!sensitiveToggle) return;
            sensitiveToggle.classList.toggle('locked', !state.security.isUnlocked);
            sensitiveToggle.setAttribute('title', state.security.isUnlocked ? 'Lock sensitive data' : 'Unlock sensitive data');
            sensitiveToggle.setAttribute('aria-pressed', state.security.isUnlocked ? 'true' : 'false');
            sensitiveToggle.innerHTML = `<i data-lucide="${state.security.isUnlocked ? 'unlock' : 'lock'}"></i>`;
            refreshIcons();
        };

        const lockSensitiveData = () => {
            state.security.isUnlocked = false;
            updateSensitiveToggle();
            render();
        };

        const ensureSensitiveState = () => {
            updateSensitiveToggle();
        };

        const sanitizePhone = (value = '') => value.toString().replace(/\D/g, '');

        const formatCurrency = (num) => {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0
            }).format(num);
        };
        
        const formatDate = (dateString) => {
            if (!dateString) return '';
            try {
                return new Date(dateString).toISOString().split('T')[0];
            } catch (e) {
                return '';
            }
        };

        const formatDateTime = (dateString) => {
            if (!dateString) return 'No date';
            try {
                const d = new Date(dateString);
                if (dateString.includes('T')) {
                    return d.toLocaleString('en-IN', { dateStyle: 'short', timeStyle: 'short', hour12: true });
                }
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    const utcDate = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                    return utcDate.toLocaleDateString('en-IN', { dateStyle: 'short' });
                }
                return d.toLocaleDateString('en-IN', { dateStyle: 'short' });
            } catch (e) {
                console.warn(`Invalid date string: ${dateString}`);
                return dateString;
            }
        };

        const getNextMonthDate = (dateString) => {
            const date = new Date(dateString);
            date.setMonth(date.getMonth() + 1);
            return date.toISOString().split('T')[0];
        };
        
        const EPSILON = 0.01; // For floating point comparisons

        const showLoader = () => {
            loader.classList.remove('hidden');
        };
        
        const hideLoader = () => {
            loader.classList.add('hidden');
        };

        const showToast = (message, isError = false) => {
            const toast = document.createElement('div');
            toast.className = `fixed top-5 left-1/2 -translate-x-1/2 p-3 rounded-lg shadow-md text-white z-[110] ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        };
        
        const showConfirm = (title, message) => {
            return new Promise((resolve) => {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                confirmModal.classList.remove('hidden');

                confirmOk.onclick = () => {
                    confirmModal.classList.add('hidden');
                    resolve(true);
                };
                confirmCancel.onclick = () => {
                    confirmModal.classList.add('hidden');
                    resolve(false);
                };
            });
        };

        const showExportChoice = (title = 'Export Data', message = 'Select export format.') => {
            return new Promise((resolve) => {
                const previousState = {
                    title: confirmTitle.textContent,
                    message: confirmMessage.textContent,
                    okLabel: confirmOk.textContent,
                    cancelLabel: confirmCancel.textContent,
                    okHandler: confirmOk.onclick,
                    cancelHandler: confirmCancel.onclick,
                    overlayHandler: confirmModal.querySelector('.modal-overlay').onclick
                };

                const overlay = confirmModal.querySelector('.modal-overlay');

                const cleanup = () => {
                    confirmModal.classList.add('hidden');
                    confirmTitle.textContent = previousState.title;
                    confirmMessage.textContent = previousState.message;
                    confirmOk.textContent = previousState.okLabel;
                    confirmCancel.textContent = previousState.cancelLabel;
                    confirmOk.onclick = previousState.okHandler;
                    confirmCancel.onclick = previousState.cancelHandler;
                    overlay.onclick = previousState.overlayHandler;
                    document.removeEventListener('keydown', handleKeyDown);
                };

                const handleKeyDown = (event) => {
                    if (event.key === 'Escape') {
                        cleanup();
                        resolve(null);
                    }
                };

                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                confirmOk.textContent = 'CSV';
                confirmCancel.textContent = 'PDF';
                confirmModal.classList.remove('hidden');
                document.addEventListener('keydown', handleKeyDown);

                confirmOk.onclick = () => {
                    cleanup();
                    resolve('csv');
                };
                confirmCancel.onclick = () => {
                    cleanup();
                    resolve('pdf');
                };

                overlay.onclick = () => {
                    cleanup();
                    resolve(null);
                };
            });
        };
        
        const runDataMigration = () => {
            let migrated = false;
            
            if (!state.data || typeof state.data !== 'object') {
                state.data = JSON.parse(JSON.stringify(DEFAULT_DATA));
                migrated = true;
            }
            
            state.data.bikes = Array.isArray(state.data.bikes) ? state.data.bikes : [];
            state.data.expenses = Array.isArray(state.data.expenses) ? state.data.expenses : [];
            state.data.pr = Array.isArray(state.data.pr) ? state.data.pr : [];
            state.data.cashEntries = Array.isArray(state.data.cashEntries) ? state.data.cashEntries : [];
            state.data.payments = Array.isArray(state.data.payments) ? state.data.payments : [];
            state.data.brandNewDeliveries = Array.isArray(state.data.brandNewDeliveries) ? state.data.brandNewDeliveries : [];
            state.data.settings = state.data.settings || {};
            if (!state.data.settings.pin) {
                state.data.settings.pin = '1111';
                migrated = true;
            }
            
            if (!state.data.cashEntries) {
                state.data.cashEntries = [];
                migrated = true;
            }
            if (!state.data.payments) {
                state.data.payments = [];
                migrated = true;
            }
            
            if (state.data.settings && state.data.settings.baseInvestment > 0) {
                state.data.cashEntries.push({
                    id: crypto.randomUUID(),
                    type: 'add',
                    amount: state.data.settings.baseInvestment,
                    description: 'Initial Base Investment (Migrated)',
                    createdAt: new Date().toISOString()
                });
                state.data.settings.baseInvestment = 0;
                migrated = true;
            }

            state.data.bikes.forEach(bike => {
                if (!bike.referral) {
                    bike.referral = null;
                } else {
                    bike.referral.name = (bike.referral.name || '').trim();
                    bike.referral.contact = (bike.referral.contact || '').trim();
                    bike.referral.commission = parseFloat(bike.referral.commission || 0) || 0;
                }

                if (bike.sold && bike.sellingPrice > 0 && !bike.paymentMode) {
                    bike.paymentMode = 'cash';
                    
                    const existingPayment = state.data.payments.find(p => p.bikeId === bike.id && p.type === 'Initial Payment');
                    if (!existingPayment) {
                        state.data.payments.push({
                            id: crypto.randomUUID(),
                            bikeId: bike.id,
                            bikeName: bike.bikeName || bike.bikeNumberPlate,
                            amount: bike.sellingPrice,
                            date: bike.soldAt || bike.soldDate,
                            type: 'Initial Payment'
                        });
                        migrated = true;
                    }
                }

                if (bike.paymentMode === 'emi' && bike.emiInfo && typeof bike.emiInfo.totalInstallments === 'undefined') {
                    bike.emiInfo.totalInstallments = 0; 
                    bike.emiInfo.installmentsPaid = 0;
                    migrated = true;
                }
            });

            state.data.pr = state.data.pr.filter(pr => pr.relationType !== 'Showroom' && pr.relationType !== 'Referrer');

            state.data.brandNewDeliveries = state.data.brandNewDeliveries.map(delivery => {
                const safeDelivery = {
                    ...delivery,
                    commissionToGive: Array.isArray(delivery.commissionToGive) ? delivery.commissionToGive : delivery.commission_to_give || [],
                };

                safeDelivery.commissionToGive = safeDelivery.commissionToGive.map(ref => ({
                    id: ref.id || crypto.randomUUID(),
                    referrerName: ref.referrerName || ref.referrer_name || '',
                    referrerContact: ref.referrerContact || ref.referrer_contact || '',
                    commissionAmount: parseFloat(ref.commissionAmount ?? ref.commission_amount ?? 0) || 0,
                    paymentStatus: (ref.paymentStatus || ref.payment_status || 'pending') === 'paid' ? 'paid' : 'pending'
                }));

                safeDelivery.commissionReceived = parseFloat(safeDelivery.commissionReceived ?? safeDelivery.commission_received ?? 0) || 0;
                delete safeDelivery.commission_received;
                delete safeDelivery.commission_to_give;
                safeDelivery.createdAt = safeDelivery.createdAt || safeDelivery.created_at || new Date().toISOString();
                delete safeDelivery.created_at;

                return safeDelivery;
            });
            
            if (migrated) {
                console.log("Data migration complete.");
            }

            const isCompletelyEmpty = state.data.bikes.length === 0
                && state.data.expenses.length === 0
                && state.data.pr.length === 0
                && state.data.cashEntries.length === 0
                && state.data.payments.length === 0;

            if (isCompletelyEmpty) {
                state.data = JSON.parse(JSON.stringify(DEFAULT_DATA));
                console.info('Loaded default demo dataset.');
                saveData();
            } else if (migrated) {
                saveData();
            }
        };

        // --- Gist API Service ---

        const getHeaders = () => {
            if (!state.githubPAT) throw new Error('GitHub PAT is not set.');
            return {
                'Authorization': `token ${state.githubPAT}`,
                'Accept': 'application/vnd.github.v3+json',
                'X-GitHub-Api-Version': '2022-11-28'
            };
        };

        const findGist = async () => {
            patError.textContent = '';
            let page = 1;
            try {
                while (true) {
                    const res = await fetch(`${GIST_API_URL}?page=${page}&per_page=100`, {
                        headers: getHeaders()
                    });
                    
                    if (!res.ok) {
                        if (res.status === 401) throw new Error('Invalid or expired token.');
                        throw new Error(`Failed to fetch gists (Status ${res.status}).`);
                    }
                    
                    const gists = await res.json();
                    if (gists.length === 0) return null;

                    const dataGist = gists.find(gist => gist.files[GIST_FILENAME]);
                    
                    if (dataGist) {
                        const gistRes = await fetch(`${GIST_API_URL}/${dataGist.id}`, { headers: getHeaders() });
                        if (!gistRes.ok) throw new Error('Found Gist but failed to fetch content.');
                        
                        const fullGist = await gistRes.json();
                        const content = fullGist.files[GIST_FILENAME].content;
                        return { id: dataGist.id, content: JSON.parse(content) };
                    }
                    page++;
                }
            } catch (error) {
                console.error('Error finding Gist:', error);
                patError.textContent = error.message;
                return null;
            }
        };

        const createGist = async () => {
            patError.textContent = '';
            try {
                const res = await fetch(GIST_API_URL, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        description: 'Second Hand Bike Manager Data',
                        public: false,
                        files: {
                            [GIST_FILENAME]: {
                                content: JSON.stringify(state.data)
                            }
                        }
                    })
                });
                
                if (!res.ok) throw new Error('Failed to create Gist.');
                
                const newGist = await res.json();
                return { id: newGist.id, content: state.data };
                
            } catch (error) {
                console.error('Error creating Gist:', error);
                patError.textContent = error.message;
                return null;
            }
        };

        let saveTimeout;
        const saveData = () => {
            if (!state.storageMode) return;
            clearTimeout(saveTimeout);
            
            if (state.storageMode === 'local') {
                saveTimeout = setTimeout(() => {
                    try {
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state.data));
                        // Quieter local save, no toast on every save
                        // showToast('Data saved locally.'); 
                    } catch (error) {
                        console.error('Error saving to localStorage:', error);
                        showToast('Failed to save data locally.', true);
                    }
                }, 500);

            } else if (state.storageMode === 'gist') {
                if (state.ui.isGistSaving) return;
                
                saveTimeout = setTimeout(async () => {
                    state.ui.isGistSaving = true;
                    // Quieter Gist save, only show loader on manual backup
                    // showLoader(); 
                    
                    try {
                        const res = await fetch(`${GIST_API_URL}/${state.gistId}`, {
                            method: 'PATCH',
                            headers: getHeaders(),
                            body: JSON.stringify({
                                files: {
                                    [GIST_FILENAME]: {
                                        content: JSON.stringify(state.data)
                                    }
                                }
                            })
                        });
                        
                        if (!res.ok) {
                            if (res.status === 401) {
                                showToast('Token expired. Please log out and log back in.', true);
                                logout();
                            } else {
                                throw new Error(`Failed to save data (Status ${res.status})`);
                            }
                        } else {
                            // Quieter Gist save, no toast on autosave
                            // showToast('Data synced successfully!');
                        }

                    } catch (error) {
                        console.error('Error saving data:', error);
                        showToast(`Sync failed: ${error.message}`, true);
                    } finally {
                        state.ui.isGistSaving = false;
                        // hideLoader();
                    }
                }, 1000);
            }
        };

        // --- Core App Logic ---

        const autoCreatePRContact = ({ name, contact, relationType = 'Other', relatedBikeName }) => {
            if (relationType === 'Showroom' || relationType === 'Referrer') {
                return;
            }
            const trimmedName = (name || '').trim();
            const displayContact = (contact || '').trim();
            const normalizedContact = sanitizePhone(displayContact);
            if (!trimmedName) {
                return;
            }

            const relation = relationType || 'Other';
            const bikeName = (relatedBikeName || '').trim();
            const identityKey = normalizedContact || trimmedName.toLowerCase();

            const existingEntry = state.data.pr.find(pr => {
                const existingKey = sanitizePhone(pr.contact) || pr.name.toLowerCase();
                return existingKey === identityKey && pr.relationType === relation;
            });

            if (existingEntry) {
                existingEntry.name = trimmedName;
                existingEntry.contact = displayContact || existingEntry.contact || '';
                if (bikeName) {
                    const bikes = new Set(
                        (existingEntry.relatedBikeName || '')
                            .split(',')
                            .map(entry => entry.trim())
                            .filter(Boolean)
                    );
                    bikes.add(bikeName);
                    existingEntry.relatedBikeName = Array.from(bikes).join(', ');
                }
                return;
            }

            state.data.pr.push({
                id: crypto.randomUUID(),
                name: trimmedName,
                contact: displayContact,
                relationType: relation,
                relatedBikeName: bikeName
            });
        };
        
        const calculateMetrics = () => {
            const { bikes, expenses, cashEntries, payments } = state.data;
            
            const soldBikes = bikes.filter(b => b.sold);
            const unsoldBikes = bikes.filter(b => !b.sold);
            
            const totalProfit = soldBikes.reduce((sum, b) => {
                const cost = (b.purchasePrice || 0) + (b.repairPrice || 0);
                const sale = b.sellingPrice || 0;
                return sum + (sale - cost);
            }, 0);
            const totalRevenue = soldBikes.reduce((sum, b) => sum + (b.sellingPrice || 0), 0);
            const brandNewDeliveries = state.data.brandNewDeliveries || [];
            const brandNewEarnings = brandNewDeliveries.reduce((sum, delivery) => sum + (delivery.commissionReceived || 0), 0);
            const brandNewCommissionsPaid = brandNewDeliveries.reduce((sum, delivery) => {
                return sum + (delivery.commissionToGive || []).reduce((s, ref) => {
                    return s + (ref.paymentStatus === 'paid' ? (ref.commissionAmount || 0) : 0);
                }, 0);
            }, 0);
            
            const unsoldInvestment = unsoldBikes.reduce((sum, b) => {
                return sum + (b.purchasePrice || 0) + (b.repairPrice || 0);
            }, 0);
            
            const totalCashAdded = (cashEntries || []).reduce((sum, e) => e.type === 'add' ? sum + e.amount : sum, 0);
            const totalCashRemoved = (cashEntries || []).reduce((sum, e) => e.type === 'remove' ? sum + e.amount : sum, 0);
            const totalSalesReceived = (payments || []).reduce((sum, p) => sum + p.amount, 0);
            const totalPurchases = bikes.reduce((sum, b) => sum + (b.purchasePrice || 0) + (b.repairPrice || 0), 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            
            const cashInHand = (totalCashAdded + totalSalesReceived + brandNewEarnings) - (totalCashRemoved + totalPurchases + totalExpenses + brandNewCommissionsPaid);
            
            const totalCashInflow = totalCashAdded + totalSalesReceived + brandNewEarnings;
            const totalCashOutflow = totalCashRemoved + totalPurchases + totalExpenses + brandNewCommissionsPaid;

            const pendingReceivables = soldBikes.reduce((sum, bike) => {
                if (bike.paymentMode === 'credit' && bike.creditInfo) {
                    return sum + Math.max(0, bike.creditInfo.remaining || 0);
                }
                if (bike.paymentMode === 'emi' && bike.emiInfo) {
                    const installmentsPaid = bike.emiInfo.installmentsPaid || 0;
                    const totalInstallments = bike.emiInfo.totalInstallments || 0;
                    const monthlyAmount = bike.emiInfo.monthlyAmount || 0;
                    const installmentsLeft = Math.max(totalInstallments - installmentsPaid, 0);
                    return sum + (installmentsLeft * monthlyAmount);
                }
                return sum;
            }, 0);

            const creditCustomers = soldBikes.filter(bike => {
                if (bike.paymentMode === 'credit' && bike.creditInfo) {
                    return (bike.creditInfo.remaining || 0) > EPSILON;
                }
                if (bike.paymentMode === 'emi' && bike.emiInfo) {
                    const installmentsPaid = bike.emiInfo.installmentsPaid || 0;
                    const totalInstallments = bike.emiInfo.totalInstallments || 0;
                    return installmentsPaid < totalInstallments;
                }
                return false;
            }).length;

            const paymentsThisMonth = payments.filter(p => {
                if (!p.date) return false;
                const d = new Date(p.date);
                const now = new Date();
                return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
            }).reduce((sum, p) => sum + (p.amount || 0), 0);

            const purchasesThisMonth = bikes.filter(b => {
                if (!b.purchaseDate) return false;
                const d = new Date(b.purchaseDate);
                const now = new Date();
                return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
            }).reduce((sum, b) => sum + (b.purchasePrice || 0) + (b.repairPrice || 0), 0);

            const expensesThisMonth = expenses.filter(e => {
                if (!e.date) return false;
                const d = new Date(e.date);
                const now = new Date();
                return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
            }).reduce((sum, e) => sum + (e.amount || 0), 0);

            const realizedProfit = totalSalesReceived - totalPurchases - totalExpenses;
            const thisMonthProfit = paymentsThisMonth - purchasesThisMonth - expensesThisMonth;
            
            state.metrics = {
                cashInHand,
                totalProfit,
                totalRevenue,
                brandNewEarnings,
                realizedProfit,
                thisMonthProfit,
                unsoldInvestment,
                inventorySold: soldBikes.length,
                inventoryUnsold: unsoldBikes.length,
                totalCashInflow,
                totalCashOutflow,
                pendingReceivables,
                creditCustomers,
            };
        };

        // --- Rendering Functions ---

        const render = () => {
            calculateMetrics();
            
            const pageId = `page-${state.ui.currentPage}`;
            const pageRenderFunction = {
                'page-dashboard': renderDashboard,
                'page-bikes': renderBikesPage,
                'page-credit': renderCreditPage,
                'page-analytics': renderAnalyticsPage,
                'page-expenses': renderExpensesPage,
                'page-pr': renderPRPage,
                'page-settings': renderSettingsPage,
            }[pageId];
            
            if (pageRenderFunction) pageRenderFunction();
            
            renderDashboardReminders();
            if (state.ui.currentPage !== 'dashboard') {
                renderDashboard();
            }
            ensureSensitiveState();
            refreshIcons();
        };

        const renderPage = (pageId) => {
            state.ui.currentPage = pageId;
            
            pages.forEach(p => p.classList.add('hidden'));
            const activePage = $(`#page-${pageId}`);
            if (activePage) {
                activePage.classList.remove('hidden');
            }
            
            navBar.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.page === pageId);
            });
            
            const pageTitles = {
                'dashboard': 'Dashboard',
                'bikes': 'Bikes',
                'credit': 'Credit Desk',
                'analytics': 'Analytics',
                'expenses': 'Expenses',
                'pr': 'PR Contacts',
                'settings': 'Settings'
            };
            pageTitle.textContent = pageTitles[pageId] || 'Manager';

            const showAddButton = ['bikes', 'expenses', 'pr'];
            addButton.classList.toggle('hidden', !showAddButton.includes(pageId));
            
            render();
        };

        const renderDashboard = () => {
            const { unsoldInvestment, inventorySold, inventoryUnsold } = state.metrics;
            const sortMode = state.ui.currentDashboardSort;

            setSensitiveCurrency(dashboardCash, state.metrics.cashInHand);
            setSensitiveCurrency(dashboardRevenue, state.metrics.totalRevenue);
            setSensitiveCurrency(dashboardProfit, state.metrics.totalProfit);
            setSensitiveCurrency(dashboardBrand, state.metrics.brandNewEarnings);

            metricInvestment.textContent = formatCurrency(unsoldInvestment);
            metricInventory.textContent = `${inventoryUnsold} unsold / ${inventorySold} sold`;
            dashboardSort.value = sortMode;
            
            // Render unsold bikes
            let unsoldBikes = state.data.bikes
                .filter(b => !b.sold);
            
            const getBikeCost = b => (b.purchasePrice || 0) + (b.repairPrice || 0);

            if (sortMode === 'recent') {
                unsoldBikes.sort((a, b) => new Date(b.createdAt || b.purchaseDate) - new Date(a.createdAt || a.purchaseDate));
            } else if (sortMode === 'high_price') {
                unsoldBikes.sort((a, b) => getBikeCost(b) - getBikeCost(a));
            } else if (sortMode === 'low_price') {
                unsoldBikes.sort((a, b) => getBikeCost(a) - getBikeCost(b));
            }
            
            // Show all unsold, not just 3, since it's sortable now
            if (unsoldBikes.length === 0) {
                dashboardRecentBikes.innerHTML = `<p class="text-gray-500 text-sm text-center">No unsold bikes yet.</p>`;
            } else {
                dashboardRecentBikes.innerHTML = unsoldBikes.map(bike => `
                    <div class="flex justify-between items-center py-1">
                        <div>
                            <span class="font-medium">${bike.bikeName || bike.bikeNumberPlate}</span>
                            <span class="text-xs text-gray-500 block">${bike.bikeNumberPlate}</span>
                        </div>
                        <span class="text-sm text-gray-600">${formatCurrency(getBikeCost(bike))}</span>
                    </div>
                `).join('');
            }
            renderDashboardReminders();
        };
        
        const renderDashboardReminders = () => {
            const reminders = [];
            const today = new Date();
            const reminderCutoff = new Date();
            reminderCutoff.setDate(today.getDate() + 7);

            state.data.bikes
                .filter(b => b.sold)
                .forEach(bike => {
                    const bikeName = bike.bikeName || bike.bikeNumberPlate;
                    if (bike.paymentMode === 'credit' && bike.creditInfo && bike.creditInfo.remaining > EPSILON) {
                        const dueDate = new Date(bike.creditInfo.dueDate);
                        if (dueDate <= reminderCutoff) {
                            reminders.push({
                                bikeId: bike.id,
                                date: dueDate,
                                text: `Call ${bike.customerName || 'Customer'} (${bike.customerContact || 'N/A'}) for ${bikeName}`,
                                amount: bike.creditInfo.remaining,
                                dueText: `Credit due: ${formatDate(dueDate)}`
                            });
                        }
                    } else if (bike.paymentMode === 'emi' && bike.emiInfo && bike.emiInfo.installmentsPaid < bike.emiInfo.totalInstallments) {
                        const dueDate = new Date(bike.emiInfo.nextDueDate);
                         if (dueDate <= reminderCutoff) {
                            reminders.push({
                                bikeId: bike.id,
                                date: dueDate,
                                text: `Call ${bike.customerName || 'Customer'} (${bike.customerContact || 'N/A'}) for ${bikeName}`,
                                amount: bike.emiInfo.monthlyAmount,
                                dueText: `EMI due: ${formatDate(dueDate)}`
                            });
                        }
                    }
                });
                
            reminders.sort((a, b) => a.date - b.date);
            
            if (reminders.length === 0) {
                dashboardReminders.innerHTML = `<p class="text-gray-500 text-sm text-center">No upcoming payments due.</p>`;
                return;
            }
            
            dashboardReminders.innerHTML = reminders.map(r => `
                <div class="py-2 border-b border-gray-200 last:border-0 cursor-pointer" data-action="log-payment" data-bike-id="${r.bikeId}">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-sm">${r.text}</span>
                        <span class="font-bold text-blue-600">${formatCurrency(r.amount)}</span>
                    </div>
                    <p class="text-xs text-gray-500">${r.dueText}</p>
                </div>
            `).join('');
        };
        
        const renderBikesPage = () => {
            const { currentBikeFilter, currentBikeSearch, currentBikeSort, currentBikeType } = state.ui;
            const search = currentBikeSearch.toLowerCase();

            if (bikeTypeToggle) {
                bikeTypeToggle.querySelectorAll('button').forEach(button => {
                    button.classList.toggle('active', button.dataset.type === currentBikeType);
                });
            }

            if (bikeSearch && bikeSearch !== document.activeElement) {
                bikeSearch.value = currentBikeSearch;
            }

            if (bikeFilter) {
                bikeFilter.querySelectorAll('button').forEach(button => {
                    button.classList.toggle('active', button.dataset.filter === currentBikeFilter);
                });
            }

            if (currentBikeType === 'brand_new') {
                bikeFilter.classList.add('hidden');
                bikeSortTrigger.classList.add('hidden');
                bikeSortMenu.classList.add('hidden');
                bikeSearch.placeholder = 'Search by model, customer, showroom...';
                renderBrandNewBikes();
                return;
            }

            bikeFilter.classList.remove('hidden');
            bikeSortTrigger.classList.remove('hidden');
            bikeSearch.placeholder = 'Search by name, plate, or owner...';
            
            let filteredBikes = state.data.bikes.filter(bike => {
                if (currentBikeFilter === 'sold' && !bike.sold) return false;
                if (currentBikeFilter === 'unsold' && bike.sold) return false;
                
                if (search) {
                    const plate = bike.bikeNumberPlate.toLowerCase();
                    const owner = bike.ownerName.toLowerCase();
                    const name = (bike.bikeName || '').toLowerCase();
                    if (!plate.includes(search) && !owner.includes(search) && !name.includes(search)) {
                        return false;
                    }
                }
                return true;
            });

            // NEW: Sorting Logic
            const getBikeCost = b => (b.purchasePrice || 0) + (b.repairPrice || 0);
            const getBikeProfit = b => b.sold ? (b.sellingPrice || 0) - getBikeCost(b) : 0;

            filteredBikes.sort((a, b) => {
                switch (currentBikeSort) {
                    case 'az': return (a.bikeName || '').localeCompare(b.bikeName || '');
                    case 'za': return (b.bikeName || '').localeCompare(a.bikeName || '');
                    case 'purchaseHigh': return getBikeCost(b) - getBikeCost(a);
                    case 'purchaseLow': return getBikeCost(a) - getBikeCost(b);
                    case 'saleHigh': return (b.sellingPrice || 0) - (a.sellingPrice || 0);
                    case 'saleLow': return (a.sellingPrice || 0) - (b.sellingPrice || 0);
                    case 'profitHigh': return getBikeProfit(b) - getBikeProfit(a);
                    case 'profitLow': return getBikeProfit(a) - getBikeProfit(b);
                    case 'dateDesc':
                    default:
                        return new Date(b.createdAt || b.purchaseDate) - new Date(a.createdAt || a.purchaseDate);
                }
            });
            
            if (filteredBikes.length === 0) {
                bikeList.innerHTML = `<p class="text-gray-500 text-center mt-4">No bikes found.</p>`;
                return;
            }
            
            bikeList.innerHTML = filteredBikes.map(bike => {
                const totalCost = getBikeCost(bike);
                
                let statusHTML = '';
                let showLogPayment = false;

                if (bike.sold) {
                    if (bike.paymentMode === 'cash') {
                        statusHTML = `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-green-100 text-green-800">Paid</span>`;
                    } else if (bike.paymentMode === 'credit' && bike.creditInfo) {
                        if (bike.creditInfo.remaining > EPSILON) {
                            statusHTML = `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-orange-100 text-orange-800">Credit: ${formatCurrency(bike.creditInfo.remaining)} due</span>`;
                            showLogPayment = true;
                        } else {
                            statusHTML = `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-green-100 text-green-800">Paid</span>`;
                        }
                    } else if (bike.paymentMode === 'emi' && bike.emiInfo) {
                        if (bike.emiInfo.installmentsPaid < bike.emiInfo.totalInstallments) {
                            statusHTML = `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-blue-100 text-blue-800">EMI: ${bike.emiInfo.installmentsPaid}/${bike.emiInfo.totalInstallments} paid</span>`;
                            showLogPayment = true;
                        } else {
                            statusHTML = `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-green-100 text-green-800">Paid</span>`;
                        }
                    }
                } else {
                     statusHTML = `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800">Unsold</span>`;
                }

                
                return `
                <div class="bg-white rounded-xl p-4 shadow-sm space-y-2" data-bike-id="${bike.id}">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-semibold text-lg text-gray-800">${bike.bikeName || bike.bikeNumberPlate}</span>
                            <span class="font-medium text-sm text-gray-500 block">${bike.bikeNumberPlate}</span>
                        </div>
                        ${statusHTML}
                    </div>
                    <p class="text-gray-600 text-sm">Owner: ${bike.ownerName}</p>
                    
                    ${bike.sold ? `
                        <div class="text-sm space-y-1 pt-2 border-t mt-2">
                            <p class="flex justify-between">
                                <span>Sale: ${formatCurrency(bike.sellingPrice)}</span> 
                                <span>Cost: ${formatCurrency(totalCost)}</span>
                            </p>
                            <p class="flex justify-between font-semibold">
                                <span>Profit:</span> 
                                <span class="${(getBikeProfit(bike)) >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${formatCurrency(getBikeProfit(bike))}
                                </span>
                            </p>
                        </div>
                    ` : `
                        <div class="text-sm pt-2 border-t mt-2">
                            <p class="flex justify-between"><span>Purchase: ${formatCurrency(bike.purchasePrice)}</span> <span>Repair: ${formatCurrency(bike.repairPrice)}</span></p>
                            <p class="flex justify-between font-semibold"><span>Total Cost:</span> <span>${formatCurrency(totalCost)}</span></p>
                        </div>
                    `}

                    ${bike.referral ? `
                        <div class="mt-2 pt-2 border-t text-xs text-gray-600">
                            <p class="font-medium text-gray-700">Reference: ${bike.referral.name || 'N/A'}</p>
                            ${bike.referral.contact ? `<p>Contact: ${bike.referral.contact}</p>` : ''}
                            ${bike.referral.commission ? `<p>Commission Share: ${formatCurrency(bike.referral.commission)}</p>` : ''}
                        </div>
                    ` : ''}
                    
                    <div class="flex justify-end gap-3 pt-2">
                        ${!bike.sold ? `<button data-action="mark-sold" class="text-green-600 font-medium text-sm">Mark Sold</button>` : ''}
                        ${showLogPayment ? `<button data-action="log-payment" class="text-blue-600 font-medium text-sm">Log Payment</button>` : ''}
                        <button data-action="edit-bike" class="text-blue-500 font-medium text-sm">Edit</button>
                    </div>
                </div>
                `;
            }).join('');
            applyPendingHighlight();
        };
        
        const renderExpensesPage = () => {
            const expenses = state.data.expenses.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
            
            if (expenses.length === 0) {
                expenseList.innerHTML = `<p class="text-gray-500 text-center mt-4">No expenses recorded.</p>`;
                return;
            }
            
            expenseList.innerHTML = expenses.map(expense => `
                <div class="bg-white rounded-xl p-4 shadow-sm flex justify-between items-center" data-expense-id="${expense.id}">
                    <div>
                        <p class="font-semibold">${expense.description}</p>
                        <p class="text-sm text-gray-500">${formatDate(expense.date)}</p>
                    </div>
                    <span class="font-bold text-lg text-red-600">- ${formatCurrency(expense.amount)}</span>
                </div>
            `).join('');
        };
        
        const renderPRPage = () => {
            const { currentPRFilter, currentPRSearch } = state.ui;
            const search = currentPRSearch.toLowerCase();

            const filteredPR = state.data.pr.filter(pr => {
                if (currentPRFilter !== 'all' && pr.relationType !== currentPRFilter) return false;
                
                if (search) {
                    const name = pr.name.toLowerCase();
                    const contact = pr.contact.toString().toLowerCase();
                    const bikeName = (pr.relatedBikeName || '').toLowerCase();
                    if (!name.includes(search) && !contact.includes(search) && !bikeName.includes(search)) {
                        return false;
                    }
                }
                return true;
            }).sort((a, b) => a.name.localeCompare(b.name));
            
            if (filteredPR.length === 0) {
                prList.innerHTML = `<p class="text-gray-500 text-center mt-4">No contacts found.</p>`;
                return;
            }
            
            const relationClassMap = {
                Buyer: 'bg-blue-100 text-blue-800',
                Supplier: 'bg-purple-100 text-purple-800',
                Owner: 'bg-amber-100 text-amber-800',
                Other: 'bg-gray-100 text-gray-700'
            };
            
            prList.innerHTML = filteredPR.map(pr => {
                const relationType = pr.relationType || 'Other';
                const relationClass = relationClassMap[relationType] || relationClassMap.Other;
                const relatedBikes = (pr.relatedBikeName || '')
                    .split(',')
                    .map(name => name.trim())
                    .filter((value, index, arr) => value && arr.indexOf(value) === index);
                const contactDigits = sanitizePhone(pr.contact);

                const bikeButtons = relatedBikes.length
                    ? relatedBikes.map(name => `
                        <button type="button" class="pr-bike-chip" data-action="pr-go-bike" data-bike-name="${name}">
                            <i data-lucide="navigation"></i>
                            ${name}
                        </button>
                    `).join('')
                    : '<span class="text-xs text-gray-400">No linked bikes yet.</span>';

                const baseActions = `
                    ${contactDigits ? `<button type="button" class="pr-action-button" data-action="pr-call" data-contact="${contactDigits}" title="Call">
                        <i data-lucide="phone"></i>
                    </button>` : ''}
                    ${contactDigits ? `<button type="button" class="pr-action-button" data-action="pr-whatsapp" data-contact="${contactDigits}" title="WhatsApp">
                        <i data-lucide="message-circle"></i>
                    </button>` : ''}
                    ${pr.contact ? `<button type="button" class="pr-action-button" data-action="pr-copy" data-contact="${pr.contact}" title="Copy contact">
                        <i data-lucide="copy"></i>
                    </button>` : ''}
                `;

                let relationActions = '';
                if (relationType === 'Buyer') {
                    relationActions += `
                        <button type="button" class="pr-action-button" data-action="pr-log-payment" data-pr-name="${pr.name}" title="Log credit payment">
                            <i data-lucide="wallet"></i>
                        </button>
                    `;
                } else if (relationType === 'Supplier') {
                    relationActions += `
                        <button type="button" class="pr-action-button" data-action="pr-filter-supplier" data-pr-name="${pr.name}" title="Show supplier bikes">
                            <i data-lucide="filter"></i>
                        </button>
                    `;
                } else if (relationType === 'Owner') {
                    relationActions += `
                        <button type="button" class="pr-action-button" data-action="pr-filter-owner" data-pr-name="${pr.name}" title="Show owner bikes">
                            <i data-lucide="target"></i>
                        </button>
                    `;
                }
                
                return `
                <div class="bg-white rounded-xl p-4 shadow-sm" data-pr-id="${pr.id}">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-lg">${pr.name}</span>
                        <span class="text-xs font-medium px-2 py-0.5 rounded-full ${relationClass}">${relationType}</span>
                    </div>
                    <p class="text-gray-600 text-sm mt-1">Contact: ${pr.contact || 'N/A'}</p>
                    <div class="flex flex-wrap gap-2 mt-3">
                        ${bikeButtons}
                    </div>
                    <div class="flex flex-wrap gap-2 mt-3">
                        ${baseActions}
                        ${relationActions}
                    </div>
                </div>
                `;
            }).join('');
        };
        
        const renderSettingsPage = () => {
            if (pinStatus) {
                const lockState = state.security.isUnlocked ? 'unlocked' : 'locked';
                const color = state.security.isUnlocked ? 'text-green-600' : 'text-amber-600';
                pinStatus.innerHTML = `Sensitive data is currently <span class="font-medium ${color}">${lockState}</span>.`;
            }

            // NEW: Update backup mode display
            const backupMode = state.storageMode === 'gist' ? 'GitHub Gist' : 'Local File';
            backupModeDisplay.textContent = backupMode;
        };

        // --- Modal & Form Handling ---
        
        const openModal = (type, data = null) => {
            state.ui.modal = { isOpen: true, type, data };
            
            let title = '';
            let body = '';
            
            const today = formatDate(new Date());
            
            switch (type) {
                case 'addBike':
                    title = 'Add New Bike';
                    body = getBikeFormHTML({ purchaseDate: today });
                    break;
                case 'editBike':
                    title = 'Edit Bike';
                    body = getBikeFormHTML(data);
                    setTimeout(() => addSalesFormListeners(data), 10);
                    break;
                case 'markSold':
                    title = 'Mark Bike as Sold';
                    body = getBikeSaleFormHTML(data);
                    setTimeout(() => addSalesFormListeners(data), 10);
                    break;
                case 'logPayment':
                    title = 'Log Payment';
                    body = getLogPaymentFormHTML(data);
                    setTimeout(() => addLogPaymentListeners(data), 10);
                    break;
                case 'addExpense':
                    title = 'Add Expense';
                    body = getExpenseFormHTML({ date: today });
                    break;
                case 'editExpense':
                    title = 'Edit Expense';
                    body = getExpenseFormHTML(data);
                    break;
                case 'addPR':
                    title = 'Add Contact';
                    body = getPRFormHTML({});
                    break;
                case 'editPR':
                    title = 'Edit Contact';
                    body = getPRFormHTML(data);
                    break;
                case 'addBrandNew':
                    title = 'Add Brand New Delivery';
                    body = getBrandNewFormHTML({});
                    setTimeout(() => addBrandNewFormListeners(), 10);
                    break;
                case 'editBrandNew':
                    title = 'Edit Brand New Delivery';
                    body = getBrandNewFormHTML(data);
                    setTimeout(() => addBrandNewFormListeners(), 10);
                    break;
            }
            
            modalTitle.textContent = title;
            modalBody.innerHTML = body;
            
            formModal.classList.remove('hidden');
            refreshIcons();
            setTimeout(() => {
                modalOverlay.classList.add('open');
                modalSheet.classList.add('open');
            }, 10);
        };
        
        const closeModal = () => {
            state.ui.modal = { isOpen: false, type: null, data: null };
            modalOverlay.classList.remove('open');
            modalSheet.classList.remove('open');
            setTimeout(() => {
                formModal.classList.add('hidden');
                modalBody.innerHTML = '';
            }, 300);
        };
        
        const getBikeFormHTML = (bike = {}) => {
            const isEditing = !!bike.id;
            
            return `
            <input type="hidden" id="bike-id" value="${bike.id || ''}">
            <div class="bg-white rounded-xl p-4 space-y-3">
                <h3 class="font-semibold">Bike Details</h3>
                <div>
                    <label class="form-label" for="bike-name">Bike Name *</label>
                    <input type="text" id="bike-name" class="form-input" placeholder="e.g., Pulsar 150" value="${bike.bikeName || ''}">
                </div>
                 <div>
                    <label class="form-label" for="bike-plate">Bike Number Plate *</label>
                    <input type="text" id="bike-plate" class="form-input uppercase" placeholder="GJ01AB1234" value="${bike.bikeNumberPlate || ''}" ${isEditing && bike.sold ? 'readonly' : ''}>
                </div>
            </div>

            <div class="bg-white rounded-xl p-4 space-y-3">
                <h3 class="font-semibold">Purchase Details</h3>
                <div>
                    <label class="form-label" for="bike-owner">Owner Name *</label>
                    <input type="text" id="bike-owner" class="form-input" placeholder="John Doe" value="${bike.ownerName || ''}">
                </div>
                <div>
                    <label class="form-label" for="bike-owner-contact">Owner Contact</label>
                    <input type="tel" id="bike-owner-contact" class="form-input" placeholder="9876543210" value="${bike.ownerContact || ''}">
                </div>
                <div>
                    <label class="form-label" for="bike-supplier">Supplier Name</label>
                    <input type="text" id="bike-supplier" class="form-input" placeholder="Bike Supplier Co." value="${bike.supplierName || ''}">
                </div>
                <div>
                    <label class="form-label" for="bike-supplier-contact">Supplier Contact</label>
                    <input type="tel" id="bike-supplier-contact" class="form-input" placeholder="9876543210" value="${bike.supplierContact || ''}">
                </div>
                <div>
                    <label class="form-label" for="bike-purchase-date">Purchase Date *</label>
                    <input type="date" id="bike-purchase-date" class="form-input" value="${formatDate(bike.purchaseDate)}">
                </div>
                <div>
                    <label class="form-label" for="bike-purchase-price">Purchase Price *</label>
                    <input type="number" id="bike-purchase-price" class="form-input" placeholder="50000" value="${bike.purchasePrice || ''}">
                </div>
                <div>
                    <label class="form-label" for="bike-repair-price">Repair Price</label>
                    <input type="number" id="bike-repair-price" class="form-input" placeholder="5000" value="${bike.repairPrice || ''}">
                </div>
            </div>

            <div class="bg-white rounded-xl p-4 space-y-3">
                <h3 class="font-semibold">Reference / Agent Commission</h3>
                <p class="text-xs text-gray-500">Track referral partners who shared commission on this purchase.</p>
                <div>
                    <label class="form-label" for="bike-ref-name">Reference Name</label>
                    <input type="text" id="bike-ref-name" class="form-input" placeholder="Agent name" value="${bike.referral?.name || ''}">
                </div>
                <div>
                    <label class="form-label" for="bike-ref-contact">Reference Contact</label>
                    <input type="tel" id="bike-ref-contact" class="form-input" placeholder="Contact number" value="${bike.referral?.contact || ''}">
                </div>
                <div>
                    <label class="form-label" for="bike-ref-commission">Commission Amount</label>
                    <input type="number" id="bike-ref-commission" class="form-input" placeholder="2000" value="${bike.referral?.commission ?? ''}">
                </div>
            </div>
            
            ${isEditing ? getBikeSaleFormHTML(bike) : ''}
            
            ${isEditing ? `
            <div class="mt-4">
                <button id="delete-bike-btn" class="w-full py-3 bg-red-100 text-red-600 rounded-lg font-semibold transition hover:bg-red-200">
                    Delete Bike
                </button>
            </div>
            ` : ''}
            `;
        };
        
        const getBikeSaleFormHTML = (bike = {}) => {
            const today = formatDate(new Date());
            const soldDate = bike.sold ? bike.soldDate : today;
            const creditDueDate = bike.creditInfo ? bike.creditInfo.dueDate : today;
            const emiStartDate = bike.emiInfo ? bike.emiInfo.startDate : today;

            return `
            <div class="bg-white rounded-xl p-4 space-y-3">
                <h3 class="font-semibold">Sales Details ${bike.sold ? `(Sold on ${formatDate(bike.soldDate)})` : ''}</h3>
                
                <div>
                    <label class="form-label" for="sale-customer-name">Customer Name</label>
                    <input type="text" id="sale-customer-name" class="form-input" placeholder="Jane Smith" value="${bike.customerName || ''}">
                </div>
                <div>
                    <label class="form-label" for="sale-customer-contact">Customer Contact</label>
                    <input type="tel" id="sale-customer-contact" class="form-input" placeholder="9876543210" value="${bike.customerContact || ''}">
                </div>
                <div>
                    <label class="form-label" for="sale-total-price">Total Selling Price *</label>
                    <input type="number" id="sale-total-price" class="form-input" placeholder="70000" value="${bike.sellingPrice || ''}">
                </div>
                <div>
                    <label class="form-label" for="sale-payment-mode">Payment Mode *</label>
                    <select id="sale-payment-mode" class="form-input">
                        <option value="cash" ${bike.paymentMode === 'cash' ? 'selected' : ''}>Cash</option>
                        <option value="credit" ${bike.paymentMode === 'credit' ? 'selected' : ''}>Credit</option>
                        <option value="emi" ${bike.paymentMode === 'emi' ? 'selected' : ''}>EMI</option>
                    </select>
                </div>

                <!-- Fields for Cash -->
                <div id="sale-cash-fields" class="hidden space-y-3">
                    <div>
                        <label class="form-label" for="sale-cash-received">Amount Received</label>
                        <input type="number" id="sale-cash-received" class="form-input bg-gray-200" readonly value="${bike.sellingPrice || ''}">
                    </div>
                    <div>
                        <label class="form-label" for="sale-cash-date">Payment Date *</label>
                        <input type="date" id="sale-cash-date" class="form-input" value="${formatDate(soldDate)}">
                    </div>
                </div>

                <!-- Fields for Credit -->
                <div id="sale-credit-fields" class="hidden space-y-3">
                    <div>
                        <label class="form-label" for="sale-credit-initial">Initial Payment *</label>
                        <input type="number" id="sale-credit-initial" class="form-input" placeholder="50000" value="${(bike.creditInfo && bike.creditInfo.initialPayment) || ''}">
                    </div>
                    <div>
                        <label class="form-label" for="sale-credit-remaining">Remaining Amount</label>
                        <input type="number" id="sale-credit-remaining" class="form-input bg-gray-200" readonly placeholder="20000" value="${(bike.creditInfo && bike.creditInfo.remaining) || ''}">
                    </div>
                    <div>
                        <label class="form-label" for="sale-credit-due-date">Remaining Due Date *</label>
                        <input type="date" id="sale-credit-due-date" class="form-input" value="${formatDate(creditDueDate)}">
                    </div>
                </div>

                <!-- Fields for EMI -->
                <div id="sale-emi-fields" class="hidden space-y-3">
                    <div>
                        <label class="form-label" for="sale-emi-downpayment">Down Payment *</label>
                        <input type="number" id="sale-emi-downpayment" class="form-input" placeholder="30000" value="${(bike.emiInfo && bike.emiInfo.downPayment) || ''}">
                    </div>
                    <div>
                        <label class="form-label" for="sale-emi-monthly">Monthly EMI Amount *</label>
                        <input type="number" id="sale-emi-monthly" class="form-input" placeholder="5000" value="${(bike.emiInfo && bike.emiInfo.monthlyAmount) || ''}">
                    </div>
                    <div>
                        <label class="form-label" for="sale-emi-installments">Number of Installments *</label>
                        <input type="number" id="sale-emi-installments" class="form-input" placeholder="12" value="${(bike.emiInfo && bike.emiInfo.totalInstallments) || ''}">
                    </div>
                    <div>
                        <label class="form-label" for="sale-emi-start-date">EMI Start Date *</label>
                        <input type="date" id="sale-emi-start-date" class="form-input" value="${formatDate(emiStartDate)}">
                    </div>
                </div>
            </div>
            `;
        };
        
        const getBrandNewFormHTML = (delivery = {}) => {
            const referrers = (delivery.commissionToGive || []).map(ref => `
                <div class="brand-referrer-item flex items-center justify-between bg-blue-50 rounded-lg p-3" 
                    data-ref-id="${ref.id || crypto.randomUUID()}"
                    data-ref-name="${ref.referrerName || ref.referrer_name || ''}"
                    data-ref-contact="${ref.referrerContact || ref.referrer_contact || ''}"
                    data-ref-amount="${ref.commissionAmount ?? ref.commission_amount ?? 0}"
                    data-status="${ref.paymentStatus || ref.payment_status || 'pending'}">
                    <div>
                        <p class="font-semibold text-gray-800">${ref.referrerName || ref.referrer_name || 'Referrer'}</p>
                        ${(ref.referrerContact || ref.referrer_contact) ? `<p class="text-xs text-gray-500">${ref.referrerContact || ref.referrer_contact}</p>` : ''}
                        <p class="text-sm font-medium text-gray-700 mt-1">${formatCurrency(ref.commissionAmount || ref.commission_amount || 0)}</p>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <select class="brand-referrer-status form-input !py-1 !px-2 !w-auto">
                            <option value="pending" ${(ref.paymentStatus || ref.payment_status) !== 'paid' ? 'selected' : ''}>Pending</option>
                            <option value="paid" ${(ref.paymentStatus || ref.payment_status) === 'paid' ? 'selected' : ''}>Paid</option>
                        </select>
                        <button type="button" class="brand-referrer-remove text-xs text-red-500 font-semibold">Remove</button>
                    </div>
                </div>
            `).join('');

            return `
            <input type="hidden" id="brand-delivery-id" value="${delivery.id || ''}">
            <div class="bg-white rounded-xl p-4 space-y-3">
                <h3 class="font-semibold text-gray-800">Delivery Details</h3>
                <div>
                    <label class="form-label" for="brand-bike-model">Bike Model *</label>
                    <input type="text" id="brand-bike-model" class="form-input" placeholder="e.g., Pulsar 150" value="${delivery.bikeModel || ''}">
                </div>
                <div>
                    <label class="form-label" for="brand-delivery-date">Delivery Date *</label>
                    <input type="date" id="brand-delivery-date" class="form-input" value="${formatDate(delivery.deliveryDate) || formatDate(new Date())}">
                </div>
                <div>
                    <label class="form-label" for="brand-commission-received">Commission Received *</label>
                    <input type="number" id="brand-commission-received" class="form-input" placeholder="5000" value="${delivery.commissionReceived ?? ''}">
                </div>
                <div>
                    <label class="form-label" for="brand-invoice-number">Invoice Number</label>
                    <input type="text" id="brand-invoice-number" class="form-input" placeholder="Optional invoice reference" value="${delivery.invoiceNumber || ''}">
                </div>
                <div>
                    <label class="form-label" for="brand-notes">Notes</label>
                    <textarea id="brand-notes" class="form-input" rows="3" placeholder="Additional notes...">${delivery.notes || ''}</textarea>
                </div>
            </div>

            <div class="bg-white rounded-xl p-4 space-y-3">
                <h3 class="font-semibold text-gray-800">Customer & Showroom</h3>
                <div>
                    <label class="form-label" for="brand-customer-name">Customer Name *</label>
                    <input type="text" id="brand-customer-name" class="form-input" placeholder="Customer name" value="${delivery.customerName || ''}">
                </div>
                <div>
                    <label class="form-label" for="brand-customer-contact">Customer Contact</label>
                    <input type="tel" id="brand-customer-contact" class="form-input" placeholder="9876543210" value="${delivery.customerContact || ''}">
                </div>
                <div>
                    <label class="form-label" for="brand-showroom-name">Showroom Name *</label>
                    <input type="text" id="brand-showroom-name" class="form-input" placeholder="Showroom or partner" value="${delivery.showroomName || ''}">
                </div>
            </div>

            <div class="bg-white rounded-xl p-4 space-y-3">
                <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-gray-800">Referrer Commissions</h3>
                    <button type="button" id="brand-add-referrer" class="text-blue-500 text-sm font-semibold">Add Referrer</button>
                </div>
                <div id="brand-referrer-list" class="space-y-3">
                    ${referrers || '<p class="text-sm text-gray-500">No referrers added yet.</p>'}
                </div>
                <div class="bg-gray-50 rounded-lg p-3 space-y-2">
                    <div>
                        <label class="form-label" for="brand-ref-name">Referrer Name</label>
                        <input type="text" id="brand-ref-name" class="form-input" placeholder="Agent or partner name">
                    </div>
                    <div>
                        <label class="form-label" for="brand-ref-contact">Referrer Contact</label>
                        <input type="tel" id="brand-ref-contact" class="form-input" placeholder="Contact (optional)">
                    </div>
                    <div>
                        <label class="form-label" for="brand-ref-amount">Commission Amount</label>
                        <input type="number" id="brand-ref-amount" class="form-input" placeholder="Commission amount">
                    </div>
                </div>
            </div>
            `;
        };
        
        const getLogPaymentFormHTML = (bike = {}) => {
            const bikeName = bike.bikeName || bike.bikeNumberPlate;
            let expectedAmount = 0;
            let paymentType = '';
            let balanceInfo = '';
            let emiFinalCheckbox = '';

            if (bike.paymentMode === 'credit' && bike.creditInfo) {
                expectedAmount = bike.creditInfo.remaining;
                paymentType = 'Credit Payment';
                balanceInfo = `<p class="text-gray-600">Remaining Due: <span class="font-medium">${formatCurrency(bike.creditInfo.remaining)}</span></p>`;
            } else if (bike.paymentMode === 'emi' && bike.emiInfo) {
                expectedAmount = bike.emiInfo.monthlyAmount;
                paymentType = 'EMI Payment';
                const emiLeft = (bike.emiInfo.totalInstallments || 0) - (bike.emiInfo.installmentsPaid || 0);
                const totalRemaining = emiLeft * bike.emiInfo.monthlyAmount;
                balanceInfo = `<p class="text-gray-600">EMIs Left: <span class="font-medium">${emiLeft} of ${bike.emiInfo.totalInstallments} (Est. ${formatCurrency(totalRemaining)})</span></p>`;
                
                emiFinalCheckbox = `
                <div class="flex items-center mt-3">
                    <input type="checkbox" id="payment-emi-final" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="payment-emi-final" class="ml-2 block text-sm text-gray-700">Log as Final Settlement?</label>
                </div>
                `;
            }

            return `
            <input type="hidden" id="payment-bike-id" value="${bike.id || ''}">
            <div class="bg-white rounded-xl p-4">
                <p class="text-lg font-semibold">${bikeName}</p>
                <p class="text-gray-600">Customer: ${bike.customerName || 'N/A'}</p>
                ${balanceInfo}
            </div>
            <div class="bg-white rounded-xl p-4 space-y-3">
                <h3 class="font-semibold">Log New Payment</h3>
                <div>
                    <label class="form-label" for="payment-amount">Amount Received *</label>
                    <input type="number" id="payment-amount" class="form-input" value="${expectedAmount || ''}" ${paymentType === 'EMI Payment' ? 'readonly' : ''}>
                </div>
                ${emiFinalCheckbox}
                <div>
                    <label class="form-label" for="payment-date">Payment Date *</label>
                    <input type="date" id="payment-date" class="form-input" value="${formatDate(new Date())}">
                </div>
                <div>
                    <label class="form-label" for="payment-type">Payment Type</label>
                    <input type="text" id="payment-type" class="form-input bg-gray-200" readonly value="${paymentType}">
                </div>
            </div>
            `;
        };
        
        const getExpenseFormHTML = (expense = {}) => {
            return `
            <input type="hidden" id="expense-id" value="${expense.id || ''}">
            <div class="bg-white rounded-xl p-4 space-y-3">
                <div>
                    <label class="form-label" for="expense-desc">Description *</label>
                    <input type="text" id="expense-desc" class="form-input" placeholder="Office rent" value="${expense.description || ''}">
                </div>
                <div>
                    <label class="form-label" for="expense-amount">Amount *</label>
                    <input type="number" id="expense-amount" class="form-input" placeholder="5000" value="${expense.amount || ''}">
                </div>
                <div>
                    <label class="form-label" for="expense-date">Date *</label>
                    <input type="date" id="expense-date" class="form-input" value="${formatDate(expense.date)}">
                </div>
            </div>
            `;
        };
        
        const getPRFormHTML = (pr = {}) => {
            return `
            <input type="hidden" id="pr-id" value="${pr.id || ''}">
            <div class="bg-white rounded-xl p-4 space-y-3">
                <div>
                    <label class="form-label" for="pr-name">Name *</label>
                    <input type="text" id="pr-name" class="form-input" placeholder="Contact Name" value="${pr.name || ''}">
                </div>
                <div>
                    <label class="form-label" for="pr-contact">Contact *</label>
                    <input type="tel" id="pr-contact" class="form-input" placeholder="9876543210" value="${pr.contact || ''}">
                </div>
                <div>
                    <label class="form-label" for="pr-type">Relation Type *</label>
                    <select id="pr-type" class="form-input">
                        <option value="Buyer" ${pr.relationType === 'Buyer' ? 'selected' : ''}>Buyer</option>
                        <option value="Supplier" ${pr.relationType === 'Supplier' ? 'selected' : ''}>Supplier</option>
                    </select>
                </div>
                <div>
                    <label class="form-label" for="pr-bike-name">Related Bike</label>
                    <input type="text" id="pr-bike-name" class="form-input" placeholder="e.g., Pulsar 150" value="${pr.relatedBikeName || ''}">
                </div>
            </div>
            `;
        };
        
        const addSalesFormListeners = (bike = {}) => {
            const paymentMode = $('#sale-payment-mode');
            const totalPrice = $('#sale-total-price');
            
            const cashFields = $('#sale-cash-fields');
            const cashReceived = $('#sale-cash-received');
            
            const creditFields = $('#sale-credit-fields');
            const creditInitial = $('#sale-credit-initial');
            const creditRemaining = $('#sale-credit-remaining');
            
            const emiFields = $('#sale-emi-fields');

            const toggleFields = () => {
                const mode = paymentMode.value;
                cashFields.classList.toggle('hidden', mode !== 'cash');
                creditFields.classList.toggle('hidden', mode !== 'credit');
                emiFields.classList.toggle('hidden', mode !== 'emi');
                updateCalculations();
            };
            
            const updateCalculations = () => {
                const total = parseFloat(totalPrice.value) || 0;
                cashReceived.value = total;
                const initial = parseFloat(creditInitial.value) || 0;
                creditRemaining.value = total - initial;
            };

            paymentMode.addEventListener('change', toggleFields);
            totalPrice.addEventListener('input', updateCalculations);
            creditInitial.addEventListener('input', updateCalculations);

            const deleteBtn = $('#delete-bike-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => handleDeleteBike(bike.id));
            }
            
            toggleFields();
        };

        const addLogPaymentListeners = (bike = {}) => {
            const isEMI = bike.paymentMode === 'emi' && bike.emiInfo;
            if (!isEMI) return;

            const finalCheckbox = $('#payment-emi-final');
            const amountInput = $('#payment-amount');
            
            finalCheckbox.addEventListener('change', () => {
                if (finalCheckbox.checked) {
                    const emiLeft = (bike.emiInfo.totalInstallments || 0) - (bike.emiInfo.installmentsPaid || 0);
                    const totalRemaining = emiLeft * bike.emiInfo.monthlyAmount;
                    amountInput.value = totalRemaining;
                    amountInput.readOnly = false;
                } else {
                    amountInput.value = bike.emiInfo.monthlyAmount;
                    amountInput.readOnly = true;
                }
            });
        };
        
        const addBrandNewFormListeners = () => {
            const addButton = $('#brand-add-referrer');
            const listContainer = $('#brand-referrer-list');
            const nameInput = $('#brand-ref-name');
            const contactInput = $('#brand-ref-contact');
            const amountInput = $('#brand-ref-amount');

            if (!addButton || !listContainer) return;

            const ensurePlaceholder = () => {
                if (!listContainer.querySelector('.brand-referrer-item')) {
                    listContainer.innerHTML = '<p class="text-sm text-gray-500">No referrers added yet.</p>';
                }
            };

            const createReferrerItem = ({ id, name, contact, amount, status }) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'brand-referrer-item flex items-center justify-between bg-blue-50 rounded-lg p-3';
                wrapper.dataset.refId = id || crypto.randomUUID();
                wrapper.dataset.refName = name;
                wrapper.dataset.refContact = contact;
                wrapper.dataset.refAmount = amount;
                wrapper.dataset.status = status || 'pending';
                wrapper.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${name}</p>
                        ${contact ? `<p class="text-xs text-gray-500">${contact}</p>` : ''}
                        <p class="text-sm font-medium text-gray-700 mt-1">${formatCurrency(parseFloat(amount) || 0)}</p>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <select class="brand-referrer-status form-input !py-1 !px-2 !w-auto">
                            <option value="pending" ${status !== 'paid' ? 'selected' : ''}>Pending</option>
                            <option value="paid" ${status === 'paid' ? 'selected' : ''}>Paid</option>
                        </select>
                        <button type="button" class="brand-referrer-remove text-xs text-red-500 font-semibold">Remove</button>
                    </div>
                `;
                return wrapper;
            };

            addButton.addEventListener('click', () => {
                const name = (nameInput?.value || '').trim();
                const contact = (contactInput?.value || '').trim();
                const amountValue = parseFloat(amountInput?.value || '0');

                if (!name) {
                    showToast('Referrer name is required.', true);
                    return;
                }
                if (isNaN(amountValue) || amountValue <= 0) {
                    showToast('Commission amount must be greater than 0.', true);
                    return;
                }

                if (!listContainer.querySelector('.brand-referrer-item')) {
                    listContainer.innerHTML = '';
                }

                const item = createReferrerItem({
                    id: crypto.randomUUID(),
                    name,
                    contact,
                    amount: amountValue,
                    status: 'pending'
                });
                listContainer.appendChild(item);

                nameInput.value = '';
                contactInput.value = '';
                amountInput.value = '';
            });

            listContainer.addEventListener('click', (event) => {
                const target = event.target;
                if (target && target.classList.contains('brand-referrer-remove')) {
                    const item = target.closest('.brand-referrer-item');
                    item?.remove();
                    ensurePlaceholder();
                }
            });

            listContainer.addEventListener('change', (event) => {
                const select = event.target;
                if (select && select.classList.contains('brand-referrer-status')) {
                    const item = select.closest('.brand-referrer-item');
                    if (item) {
                        item.dataset.status = select.value;
                    }
                }
            });

            ensurePlaceholder();
        };
        
        const handleDeleteBike = async (bikeId) => {
            const confirmed = await showConfirm(
                'Delete this bike?',
                'This will permanently delete this bike and all its associated sales and payment logs. This action cannot be undone.'
            );
            
            if (confirmed) {
                try {
                    state.data.bikes = state.data.bikes.filter(b => b.id !== bikeId);
                    state.data.payments = state.data.payments.filter(p => p.bikeId !== bikeId);
                    
                    showToast('Bike deleted successfully.');
                    closeModal();
                    render();
                    saveData();
                } catch (error) {
                    showToast(`Error: ${error.message}`, true);
                }
            }
        };

        const handleDeleteBrandNew = async (deliveryId) => {
            const confirmed = await showConfirm(
                'Delete this delivery?',
                'This will permanently delete this brand new delivery record. This action cannot be undone.'
            );
            if (!confirmed) return;

            try {
                state.data.brandNewDeliveries = (state.data.brandNewDeliveries || []).filter(delivery => delivery.id !== deliveryId);
                showToast('Brand new delivery deleted.');
                closeModal();
                render();
                saveData();
            } catch (error) {
                showToast(`Error: ${error.message}`, true);
            }
        };

        const toggleBrandNewCommissionStatus = (deliveryId, refId) => {
            const delivery = (state.data.brandNewDeliveries || []).find(entry => entry.id === deliveryId);
            if (!delivery) {
                showToast('Delivery not found.', true);
                return;
            }
            const ref = (delivery.commissionToGive || []).find(entry => entry.id === refId);
            if (!ref) {
                showToast('Referrer not found.', true);
                return;
            }
            ref.paymentStatus = ref.paymentStatus === 'paid' ? 'pending' : 'paid';
            showToast(`Referrer marked as ${ref.paymentStatus}.`);
            render();
            saveData();
        };

        const summarizeCreditRecords = () => {
            const creditBikes = (state.data.bikes || []).filter(bike => bike.sold && (bike.paymentMode === 'credit' || bike.paymentMode === 'emi'));
            if (!creditBikes.length) {
                return {
                    records: [],
                    totals: {
                        totalCredit: 0,
                        collected: 0,
                        pending: 0,
                        activeCustomers: 0
                    }
                };
            }

            const creditIds = new Set(creditBikes.map(b => b.id));
            const paymentsByBike = new Map();
            let collected = 0;

            (state.data.payments || []).forEach(payment => {
                if (!creditIds.has(payment.bikeId)) return;
                const list = paymentsByBike.get(payment.bikeId) || [];
                list.push(payment);
                paymentsByBike.set(payment.bikeId, list);
                collected += payment.amount || 0;
            });

            const totalCredit = creditBikes.reduce((sum, bike) => sum + (bike.sellingPrice || 0), 0);

            const records = creditBikes.map(bike => {
                const payments = (paymentsByBike.get(bike.id) || []).slice().sort((a, b) => new Date(b.date) - new Date(a.date));
                const totalPaid = payments.reduce((sum, payment) => sum + (payment.amount || 0), 0);

                let pendingAmount = Math.max((bike.sellingPrice || 0) - totalPaid, 0);
                let nextDueText = 'Paid in full';
                let dueDate = null;
                let initialPayment = 0;
                let monthlyAmount = 0;
                let installmentsPaid = 0;
                let totalInstallments = 0;

                if (bike.paymentMode === 'credit' && bike.creditInfo) {
                    pendingAmount = Math.max(bike.creditInfo.remaining ?? pendingAmount, 0);
                    dueDate = bike.creditInfo.dueDate || null;
                    initialPayment = bike.creditInfo.initialPayment || 0;
                    nextDueText = pendingAmount > EPSILON
                        ? (dueDate ? `Due by ${formatDate(dueDate)}` : 'Pending balance')
                        : 'All dues cleared';
                } else if (bike.paymentMode === 'emi' && bike.emiInfo) {
                    monthlyAmount = bike.emiInfo.monthlyAmount || 0;
                    installmentsPaid = bike.emiInfo.installmentsPaid || 0;
                    totalInstallments = bike.emiInfo.totalInstallments || 0;
                    initialPayment = bike.emiInfo.downPayment || 0;
                    dueDate = bike.emiInfo.nextDueDate || null;
                    const installmentsLeft = Math.max(totalInstallments - installmentsPaid, 0);
                    pendingAmount = Math.max(installmentsLeft * monthlyAmount, 0);
                    nextDueText = installmentsLeft > 0
                        ? (dueDate ? `Next EMI ${formatDate(dueDate)}` : 'EMI pending')
                        : 'All EMIs completed';
                }

                return {
                    bikeId: bike.id,
                    customerName: bike.customerName || 'Customer',
                    contact: bike.customerContact || 'N/A',
                    phoneHref: sanitizePhone(bike.customerContact || ''),
                    bikeName: bike.bikeName || bike.bikeNumberPlate,
                    bikeNumberPlate: bike.bikeNumberPlate,
                    salePrice: bike.sellingPrice || 0,
                    paymentMode: bike.paymentMode,
                    pendingAmount,
                    nextDueText,
                    dueDate,
                    initialPayment,
                    monthlyAmount,
                    installmentsPaid,
                    totalInstallments,
                    payments
                };
            });

            const totals = {
                totalCredit,
                collected,
                pending: records.reduce((sum, record) => sum + record.pendingAmount, 0),
                activeCustomers: records.filter(record => record.pendingAmount > EPSILON).length
            };

            return { records, totals };
        };

        const renderCreditPage = () => {
            const { records, totals } = summarizeCreditRecords();

            if (!records.length) {
                creditTotal.textContent = formatCurrency(0);
                creditCollected.textContent = formatCurrency(0);
                creditPending.textContent = formatCurrency(0);
                creditActive.textContent = '0';
                creditList.innerHTML = `<p class="text-gray-500 text-center mt-4">No credit or EMI sales yet.</p>`;
                return;
            }

            creditTotal.textContent = formatCurrency(totals.totalCredit);
            creditCollected.textContent = formatCurrency(totals.collected);
            creditPending.textContent = formatCurrency(totals.pending);
            creditActive.textContent = totals.activeCustomers.toString();

            const creditCards = records.map(record => {
                let scheduleInfo = '';
                if (record.paymentMode === 'credit') {
                    scheduleInfo = `
                        <p class="text-sm text-gray-500">
                            Initial Payment: <span class="font-medium text-gray-700">${formatCurrency(record.initialPayment)}</span>
                        </p>
                    `;
                } else if (record.paymentMode === 'emi') {
                    scheduleInfo = `
                        <p class="text-sm text-gray-500">
                            EMI Progress: <span class="font-medium text-gray-700">${record.installmentsPaid}/${record.totalInstallments}</span> • 
                            Monthly: <span class="font-medium text-gray-700">${formatCurrency(record.monthlyAmount)}</span>
                        </p>
                    `;
                }

                const recentPayments = record.payments.slice(0, 3).map(payment => `
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>${formatDate(payment.date)}</span>
                        <span class="font-medium text-gray-600">${formatCurrency(payment.amount)}</span>
                        <span class="uppercase">${payment.type}</span>
                    </div>
                `).join('');

                const paymentHistory = recentPayments
                    ? `<div class="mt-3 border-t border-gray-100 pt-3 space-y-1">${recentPayments}</div>`
                    : '<p class="text-xs text-gray-400 mt-3">No payments logged yet.</p>';

                const callHref = record.phoneHref ? `tel:${record.phoneHref}` : '#';
                const whatsappHref = record.phoneHref ? `https://wa.me/${record.phoneHref}` : '#';
                const contactDisabledClass = record.phoneHref ? '' : 'opacity-60 pointer-events-none cursor-not-allowed';

                return `
                    <div class="bg-white rounded-xl p-4 shadow-sm space-y-3" data-bike-id="${record.bikeId}">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-lg font-semibold text-gray-900">${record.customerName}</p>
                                <p class="text-sm text-gray-500">${record.bikeName}</p>
                            </div>
                            <span class="text-xs font-medium px-2 py-1 rounded-full bg-blue-100 text-blue-700">
                                ${record.paymentMode === 'emi' ? 'EMI' : 'Credit'}
                            </span>
                        </div>

                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <p class="text-gray-500">Sale Price</p>
                                <p class="font-semibold text-gray-900">${formatCurrency(record.salePrice)}</p>
                            </div>
                            <div>
                                <p class="text-gray-500">Pending</p>
                                <p class="font-semibold ${record.pendingAmount > 0 ? 'text-amber-600' : 'text-green-600'}">${formatCurrency(record.pendingAmount)}</p>
                            </div>
                        </div>

                        <p class="text-sm text-blue-600 font-medium">${record.nextDueText}</p>
                        ${scheduleInfo}

                        <div class="flex flex-wrap gap-2 pt-2">
                            <a href="${callHref}" class="px-3 py-1.5 text-sm bg-blue-100 text-blue-700 rounded-lg font-medium ${contactDisabledClass}">Call</a>
                            <a href="${whatsappHref}" target="_blank" class="px-3 py-1.5 text-sm bg-green-100 text-green-700 rounded-lg font-medium ${contactDisabledClass}">WhatsApp</a>
                            <button data-action="log-payment" class="px-3 py-1.5 text-sm bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition">
                                Record Payment
                            </button>
                        </div>

                        ${paymentHistory}
                    </div>
                `;
            }).join('');

            creditList.innerHTML = creditCards;
        };

        const renderAnalyticsPage = () => {
            const { cashInHand, totalProfit, totalCashInflow, totalCashOutflow } = state.metrics;
            const { bikes, expenses, cashEntries, payments } = state.data;

            setSensitiveCurrency(analyticsCash, cashInHand);
            setSensitiveCurrency(analyticsProfit, totalProfit);
            setSensitiveCurrency(analyticsRealized, state.metrics.realizedProfit);
            setSensitiveCurrency(analyticsMonth, state.metrics.thisMonthProfit);
            setSensitiveCurrency(analyticsInflow, totalCashInflow);
            setSensitiveCurrency(analyticsOutflow, totalCashOutflow);

            if (!state.security.isUnlocked) {
                analyticsLockedState.classList.remove('hidden');
                analyticsContent.classList.add('hidden');
            } else {
                analyticsLockedState.classList.add('hidden');
                analyticsContent.classList.remove('hidden');
            }

            let transactions = [];

            (cashEntries || []).forEach(entry => {
                transactions.push({
                    timestamp: entry.createdAt,
                    amount: entry.type === 'add' ? entry.amount : -entry.amount,
                    description: entry.description
                });
            });

            (bikes || []).forEach(bike => {
                const totalCost = (bike.purchasePrice || 0) + (bike.repairPrice || 0);
                if (totalCost > 0) {
                    transactions.push({
                        timestamp: bike.createdAt || bike.purchaseDate,
                        amount: -totalCost,
                        description: `Purchase: ${bike.bikeName || bike.bikeNumberPlate}`
                    });
                }
            });

            (payments || []).forEach(payment => {
                transactions.push({
                    timestamp: payment.date,
                    amount: payment.amount,
                    description: `${payment.type}: ${payment.bikeName || 'N/A'}`
                });
            });

            (state.data.brandNewDeliveries || []).forEach(delivery => {
                transactions.push({
                    timestamp: delivery.createdAt || delivery.deliveryDate,
                    amount: delivery.commissionReceived || 0,
                    description: `Brand New Commission: ${delivery.bikeModel || delivery.customerName || 'Delivery'}`
                });

                (delivery.commissionToGive || []).forEach(ref => {
                    if (ref.paymentStatus === 'paid' && ref.commissionAmount) {
                        transactions.push({
                            timestamp: delivery.createdAt || delivery.deliveryDate,
                            amount: -(ref.commissionAmount || 0),
                            description: `Referrer Payout: ${ref.referrerName || 'Agent'}`
                        });
                    }
                });
            });

            (expenses || []).filter(e => e.amount > 0).forEach(expense => {
                transactions.push({
                    timestamp: expense.createdAt || expense.date,
                    amount: -expense.amount,
                    description: `Expense: ${expense.description}`
                });
            });

            transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (analyticsTransactionList) {
                if (!transactions.length) {
                    analyticsTransactionList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No transactions yet.</p>';
                } else {
                    analyticsTransactionList.innerHTML = transactions.map(t => `
                        <div class="flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0">
                            <div>
                                <p class="font-medium text-sm">${t.description}</p>
                                <p class="text-xs text-gray-500">${formatDateTime(t.timestamp)}</p>
                            </div>
                            <span class="font-semibold ${t.amount > 0 ? 'text-green-600' : 'text-red-600'}">
                                ${t.amount > 0 ? '+' : ''}${formatCurrency(t.amount)}
                            </span>
                        </div>
                    `).join('');
                }
            }

            const expenseRecords = (expenses || [])
                .slice()
                .sort((a, b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt));

            if (!expenseRecords.length) {
                analyticsExpenseTotal.textContent = formatCurrency(0);
                analyticsExpenseList.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">No expenses recorded.</p>';
            } else {
                const totalExpenses = expenseRecords.reduce((sum, expense) => sum + (expense.amount || 0), 0);
                analyticsExpenseTotal.textContent = formatCurrency(totalExpenses);

                analyticsExpenseList.innerHTML = expenseRecords.slice(0, 5).map(expense => `
                    <div class="flex justify-between text-sm">
                        <div>
                            <p class="font-medium text-gray-800">${expense.description}</p>
                            <p class="text-xs text-gray-500">${formatDate(expense.date || expense.createdAt)}</p>
                        </div>
                        <span class="font-semibold text-red-600">- ${formatCurrency(expense.amount || 0)}</span>
                    </div>
                `).join('');
            }
        };

        // --- PIN Handling ---

        const openPinModal = (message = 'Enter your PIN to continue.') => {
            pinModalMessage.textContent = message;
            pinError.textContent = '';
            pinInput.value = '';
            pinModal.classList.remove('hidden');
            setTimeout(() => pinInput.focus(), 50);
        };

        const closePinModal = () => {
            pinModal.classList.add('hidden');
            pinInput.value = '';
        };

        const resolvePinRequest = (value) => {
            if (state.security.pendingResolve) {
                state.security.pendingResolve.resolve(value);
                state.security.pendingResolve = null;
            }
        };

        const rejectPinRequest = (reason) => {
            if (state.security.pendingResolve) {
                state.security.pendingResolve.reject(reason);
                state.security.pendingResolve = null;
            }
        };

        const requestPinUnlock = (message = 'Enter your PIN to unlock sensitive data.') => {
            if (state.security.isUnlocked) {
                return Promise.resolve(true);
            }
            if (state.security.pendingResolve) {
                rejectPinRequest('replaced');
            }
            return new Promise((resolve, reject) => {
                state.security.pendingResolve = { resolve, reject };
                openPinModal(message);
            });
        };

        const handlePinSubmission = () => {
            const enteredPin = pinInput.value.trim();
            if (!enteredPin) {
                pinError.textContent = 'Please enter your PIN.';
                return;
            }
            const currentPin = state.data?.settings?.pin || '1111';
            if (enteredPin !== currentPin) {
                pinError.textContent = 'Incorrect PIN. Try again.';
                pinInput.select();
                return;
            }
            closePinModal();
            state.security.isUnlocked = true;
            updateSensitiveToggle();
            render();
            resolvePinRequest(true);
            showToast('Sensitive data unlocked.');
        };

        const handleModalSave = async () => {
            const { type, data } = state.ui.modal;
            
            try {
                switch (type) {
                    case 'addBike': {
                        const plate = $('#bike-plate').value.toUpperCase();
                        const bikeName = $('#bike-name').value;
                        const ownerName = $('#bike-owner').value;
                        const purchaseDate = $('#bike-purchase-date').value;
                        const purchasePrice = parseFloat($('#bike-purchase-price').value);
                        
                        if (!bikeName) throw new Error('Bike Name is required.');
                        if (!/^[A-Z]{2}[0-9]{1,2}[A-Z]{1,2}[0-9]{1,4}$/.test(plate)) throw new Error('Invalid bike number plate format.');
                        if (!ownerName || !purchaseDate || !purchasePrice) throw new Error('Owner, Purchase Date, and Purchase Price are required.');
                        if (state.data.bikes.some(b => b.bikeNumberPlate === plate)) throw new Error('A bike with this number plate already exists.');

                        const referralName = ($('#bike-ref-name')?.value || '').trim();
                        const referralContact = ($('#bike-ref-contact')?.value || '').trim();
                        const referralComm = parseFloat($('#bike-ref-commission')?.value || '0') || 0;

                        const newBike = {
                            id: crypto.randomUUID(),
                            bikeName: bikeName,
                            bikeNumberPlate: plate,
                            ownerName: ownerName,
                            ownerContact: $('#bike-owner-contact').value,
                            supplierName: $('#bike-supplier').value,
                            supplierContact: $('#bike-supplier-contact').value,
                            purchaseDate: purchaseDate,
                            purchasePrice: purchasePrice,
                            repairPrice: parseFloat($('#bike-repair-price').value) || 0,
                            createdAt: new Date().toISOString(),
                            sold: false,
                            referral: referralName ? {
                                name: referralName,
                                contact: referralContact,
                                commission: referralComm
                            } : null
                        };
                        state.data.bikes.push(newBike);
                        
                        autoCreatePRContact({
                            name: newBike.ownerName,
                            contact: newBike.ownerContact,
                            relationType: 'Owner',
                            relatedBikeName: newBike.bikeName || newBike.bikeNumberPlate
                        });
                        autoCreatePRContact({
                            name: newBike.supplierName,
                            contact: newBike.supplierContact,
                            relationType: 'Supplier',
                            relatedBikeName: newBike.bikeName || newBike.bikeNumberPlate
                        });
                        if (newBike.referral) {
                            autoCreatePRContact({
                                name: newBike.referral.name,
                                contact: newBike.referral.contact,
                                relationType: 'Referrer',
                                relatedBikeName: newBike.bikeName || newBike.bikeNumberPlate
                            });
                        }
                        
                        showToast('Bike added successfully!');
                        break;
                    }

                    case 'editBike': {
                        const index = state.data.bikes.findIndex(b => b.id === data.id);
                        if (index === -1) throw new Error('Bike not found.');
                        
                        const bikeName = $('#bike-name').value;
                        const ownerName = $('#bike-owner').value;
                        if (!bikeName) throw new Error('Bike Name is required.');
                        if (!ownerName) throw new Error('Owner Name is required.');

                        const referralName = ($('#bike-ref-name')?.value || '').trim();
                        const referralContact = ($('#bike-ref-contact')?.value || '').trim();
                        const referralComm = parseFloat($('#bike-ref-commission')?.value || '0') || 0;

                        const purchaseData = {
                            bikeName: bikeName,
                            ownerName: ownerName,
                            ownerContact: $('#bike-owner-contact').value,
                            supplierName: $('#bike-supplier').value,
                            supplierContact: $('#bike-supplier-contact').value,
                            purchaseDate: $('#bike-purchase-date').value,
                            purchasePrice: parseFloat($('#bike-purchase-price').value) || 0,
                            repairPrice: parseFloat($('#bike-repair-price').value) || 0,
                            referral: referralName ? {
                                name: referralName,
                                contact: referralContact,
                                commission: referralComm
                            } : null
                        };
                        
                        const totalSellingPrice = parseFloat($('#sale-total-price').value) || 0;
                        let salesData = {};
                        
                        if (totalSellingPrice > 0) {
                            const wasSold = state.data.bikes[index].sold;
                            const paymentDate = wasSold ? state.data.bikes[index].soldDate : formatDate(new Date());
                            
                            salesData = {
                                ...purchaseData,
                                sold: true,
                                soldAt: wasSold ? state.data.bikes[index].soldAt : new Date().toISOString(),
                                soldDate: paymentDate,
                                customerName: $('#sale-customer-name').value,
                                customerContact: $('#sale-customer-contact').value,
                                sellingPrice: totalSellingPrice,
                                paymentMode: $('#sale-payment-mode').value,
                                creditInfo: null,
                                emiInfo: null,
                            };
                            
                            const paymentMode = salesData.paymentMode;
                            let initialPaymentAmount = 0;
                            
                            if (paymentMode === 'cash') {
                                initialPaymentAmount = totalSellingPrice;
                                salesData.soldDate = $('#sale-cash-date').value;
                            } else if (paymentMode === 'credit') {
                                const initial = parseFloat($('#sale-credit-initial').value) || 0;
                                initialPaymentAmount = initial;
                                salesData.creditInfo = {
                                    initialPayment: initial,
                                    remaining: totalSellingPrice - initial,
                                    dueDate: $('#sale-credit-due-date').value
                                };
                            } else if (paymentMode === 'emi') {
                                const downPayment = parseFloat($('#sale-emi-downpayment').value) || 0;
                                initialPaymentAmount = downPayment;
                                salesData.emiInfo = {
                                    downPayment: downPayment,
                                    monthlyAmount: parseFloat($('#sale-emi-monthly').value) || 0,
                                    totalInstallments: parseInt($('#sale-emi-installments').value) || 0,
                                    installmentsPaid: wasSold ? state.data.bikes[index].emiInfo.installmentsPaid : 0,
                                    startDate: $('#sale-emi-start-date').value,
                                    nextDueDate: wasSold ? state.data.bikes[index].emiInfo.nextDueDate : $('#sale-emi-start-date').value
                                };
                            }

                            const paymentIndex = state.data.payments.findIndex(p => p.bikeId === data.id && p.type === 'Initial Payment');
                            
                            if (paymentIndex > -1) {
                                state.data.payments[paymentIndex].amount = initialPaymentAmount;
                                state.data.payments[paymentIndex].date = (paymentMode === 'cash' ? salesData.soldDate : salesData.soldAt);
                            } else if (!wasSold) {
                                state.data.payments.push({
                                    id: crypto.randomUUID(),
                                    bikeId: data.id,
                                    bikeName: bikeName || data.bikeNumberPlate,
                                    amount: initialPaymentAmount,
                                    date: (paymentMode === 'cash' ? salesData.soldDate : salesData.soldAt),
                                    type: 'Initial Payment'
                                });
                                
                                autoCreatePRContact({
                                    name: salesData.customerName,
                                    contact: salesData.customerContact,
                                    relationType: 'Buyer',
                                    relatedBikeName: bikeName
                                });
                            }
                            
                        } else {
                            salesData = { ...purchaseData, sold: false, sellingPrice: 0 };
                        }
                        
                        state.data.bikes[index] = { ...state.data.bikes[index], ...salesData };
                        
                        autoCreatePRContact({
                            name: purchaseData.ownerName,
                            contact: purchaseData.ownerContact,
                            relationType: 'Owner',
                            relatedBikeName: bikeName || data.bikeNumberPlate
                        });
                        autoCreatePRContact({
                            name: purchaseData.supplierName,
                            contact: purchaseData.supplierContact,
                            relationType: 'Supplier',
                            relatedBikeName: bikeName
                        });
                        if (purchaseData.referral) {
                            autoCreatePRContact({
                                name: purchaseData.referral.name,
                                contact: purchaseData.referral.contact,
                                relationType: 'Referrer',
                                relatedBikeName: bikeName
                            });
                        }
                        if (salesData.sold && salesData.customerName && salesData.customerContact) {
                            autoCreatePRContact({
                                name: salesData.customerName,
                                contact: salesData.customerContact,
                                relationType: 'Buyer',
                                relatedBikeName: bikeName
                            });
                        }
                        
                        showToast('Bike updated successfully!');
                        break;
                    }
                    
                    case 'markSold': {
                        const index = state.data.bikes.findIndex(b => b.id === data.id);
                        if (index === -1) throw new Error('Bike not found.');
                        if (state.data.bikes[index].sold) throw new Error('Bike is already sold.');

                        const totalSellingPrice = parseFloat($('#sale-total-price').value) || 0;
                        if (totalSellingPrice <= 0) throw new Error('Total Selling Price is required.');
                        
                        const paymentMode = $('#sale-payment-mode').value;
                        let initialPaymentAmount = 0;
                        let paymentDate = new Date().toISOString();
                        let bikeUpdate = {
                            sold: true,
                            soldAt: paymentDate,
                            customerName: $('#sale-customer-name').value,
                            customerContact: $('#sale-customer-contact').value,
                            sellingPrice: totalSellingPrice,
                            paymentMode: paymentMode,
                            creditInfo: null,
                            emiInfo: null,
                        };
                        
                        if (paymentMode === 'cash') {
                            initialPaymentAmount = totalSellingPrice;
                            paymentDate = new Date($('#sale-cash-date').value).toISOString();
                            bikeUpdate.soldDate = paymentDate;
                        } else if (paymentMode === 'credit') {
                            const initial = parseFloat($('#sale-credit-initial').value) || 0;
                            initialPaymentAmount = initial;
                            bikeUpdate.soldDate = formatDate(new Date());
                            bikeUpdate.creditInfo = {
                                initialPayment: initial,
                                remaining: totalSellingPrice - initial,
                                dueDate: $('#sale-credit-due-date').value
                            };
                            if (!bikeUpdate.creditInfo.dueDate) throw new Error('Remaining Due Date is required for Credit.');
                        } else if (paymentMode === 'emi') {
                            const downPayment = parseFloat($('#sale-emi-downpayment').value) || 0;
                            initialPaymentAmount = downPayment;
                            bikeUpdate.soldDate = formatDate(new Date());
                            bikeUpdate.emiInfo = {
                                downPayment: downPayment,
                                monthlyAmount: parseFloat($('#sale-emi-monthly').value) || 0,
                                totalInstallments: parseInt($('#sale-emi-installments').value) || 0,
                                installmentsPaid: 0,
                                startDate: $('#sale-emi-start-date').value,
                                nextDueDate: $('#sale-emi-start-date').value
                            };
                            if (!bikeUpdate.emiInfo.monthlyAmount || !bikeUpdate.emiInfo.startDate) throw new Error('Monthly Amount and Start Date are required for EMI.');
                            if (!bikeUpdate.emiInfo.totalInstallments) throw new Error('Number of Installments is required for EMI.');
                        }
                        
                        state.data.bikes[index] = { ...state.data.bikes[index], ...bikeUpdate };
                        
                        state.data.payments.push({
                            id: crypto.randomUUID(),
                            bikeId: data.id,
                            bikeName: data.bikeName || data.bikeNumberPlate,
                            amount: initialPaymentAmount,
                            date: paymentDate,
                            type: 'Initial Payment'
                        });
                        
                        autoCreatePRContact({
                            name: bikeUpdate.customerName,
                            contact: bikeUpdate.customerContact,
                            relationType: 'Buyer',
                            relatedBikeName: data.bikeName || data.bikeNumberPlate
                        });
                        
                        showToast('Bike marked as sold!');
                        break;
                    }
                    
                    case 'logPayment': {
                        const index = state.data.bikes.findIndex(b => b.id === $('#payment-bike-id').value);
                        if (index === -1) throw new Error('Bike not found.');
                        
                        const bike = state.data.bikes[index];
                        const amount = parseFloat($('#payment-amount').value) || 0;
                        const date = $('#payment-date').value;
                        let type = $('#payment-type').value;
                        const isEMIFinal = $('#payment-emi-final') && $('#payment-emi-final').checked;
                        
                        if (amount <= 0) throw new Error('Payment amount must be positive.');
                        if (!date) throw new Error('Payment date is required.');
                        
                        if (bike.paymentMode === 'credit' && bike.creditInfo) {
                            if (amount > bike.creditInfo.remaining + EPSILON) {
                                throw new Error('Payment cannot be greater than remaining balance.');
                            }
                            if (amount >= bike.creditInfo.remaining - EPSILON) {
                                type = 'Final Credit Payment';
                                bike.creditInfo.remaining = 0;
                            } else {
                                bike.creditInfo.remaining -= amount;
                            }
                        } else if (bike.paymentMode === 'emi' && bike.emiInfo) {
                            if (isEMIFinal) {
                                const emiLeft = (bike.emiInfo.totalInstallments || 0) - (bike.emiInfo.installmentsPaid || 0);
                                const totalRemaining = emiLeft * bike.emiInfo.monthlyAmount;
                                if (amount > totalRemaining + EPSILON) {
                                    throw new Error('Settlement cannot be greater than total remaining balance.');
                                }
                                type = 'Final EMI Installment';
                                bike.emiInfo.installmentsPaid = bike.emiInfo.totalInstallments;
                            } else {
                                if (amount > bike.emiInfo.monthlyAmount + EPSILON) {
                                     throw new Error('Payment cannot be greater than monthly EMI amount.');
                                }
                                bike.emiInfo.installmentsPaid = (bike.emiInfo.installmentsPaid || 0) + 1;
                                if (bike.emiInfo.installmentsPaid === bike.emiInfo.totalInstallments) {
                                    type = 'Final EMI Installment';
                                } else {
                                    bike.emiInfo.nextDueDate = getNextMonthDate(bike.emiInfo.nextDueDate);
                                }
                            }
                        }
                        
                        state.data.payments.push({
                            id: crypto.randomUUID(),
                            bikeId: bike.id,
                            bikeName: bike.bikeName || bike.bikeNumberPlate,
                            amount: amount,
                            date: new Date(date).toISOString(),
                            type: type
                        });
                        
                        state.data.bikes[index] = bike;
                        showToast('Payment logged successfully!');
                        break;
                    }
                    
                    case 'addExpense':
                    case 'editExpense':
                        const description = $('#expense-desc').value;
                        const amount = parseFloat($('#expense-amount').value);
                        const date = $('#expense-date').value;
                        
                        if (!description || !amount || !date) throw new Error('All fields are required.');
                        
                        if (type === 'addExpense') {
                            state.data.expenses.push({ 
                                id: crypto.randomUUID(), 
                                description, 
                                amount, 
                                date,
                                createdAt: new Date().toISOString()
                            });
                            showToast('Expense added!');
                        } else {
                            const index = state.data.expenses.findIndex(e => e.id === data.id);
                            if (index === -1) throw new Error('Expense not found.');
                            state.data.expenses[index] = { ...data, description, amount, date };
                            showToast('Expense updated!');
                        }
                        break;
                    
                    case 'addPR':
                    case 'editPR':
                        const name = $('#pr-name').value;
                        const contact = $('#pr-contact').value;
                        
                        if (!name || !contact) throw new Error('Name and Contact are required.');
                        
                        const prData = {
                            name,
                            contact,
                            relationType: $('#pr-type').value,
                            relatedBikeName: $('#pr-bike-name').value,
                        };
                        
                        if (type === 'addPR') {
                            state.data.pr.push({ id: crypto.randomUUID(), ...prData });
                            showToast('Contact added!');
                        } else {
                            const index = state.data.pr.findIndex(p => p.id === data.id);
                            if (index === -1) throw new Error('Contact not found.');
                            state.data.pr[index] = { ...data, ...prData };
                            showToast('Contact updated!');
                        }
                        break;
                    
                    case 'addBrandNew':
                    case 'editBrandNew': {
                        const deliveryId = type === 'editBrandNew' && data ? data.id : crypto.randomUUID();
                        const bikeModel = ($('#brand-bike-model')?.value || '').trim();
                        const deliveryDate = $('#brand-delivery-date')?.value;
                        const commissionReceived = parseFloat($('#brand-commission-received')?.value || '0');
                        const customerName = ($('#brand-customer-name')?.value || '').trim();
                        const customerContact = ($('#brand-customer-contact')?.value || '').trim();
                        const showroomName = ($('#brand-showroom-name')?.value || '').trim();
                        const invoiceNumber = ($('#brand-invoice-number')?.value || '').trim();
                        const notes = ($('#brand-notes')?.value || '').trim();

                        if (!bikeModel || !deliveryDate || !customerName || !showroomName) {
                            throw new Error('Bike Model, Delivery Date, Customer Name, and Showroom Name are required.');
                        }
                        if (isNaN(commissionReceived) || commissionReceived < 0) {
                            throw new Error('Commission received must be a non-negative number.');
                        }

                        const referrerElements = modalBody.querySelectorAll('.brand-referrer-item');
                        const commissionToGive = Array.from(referrerElements).map(element => {
                            const amount = parseFloat(element.dataset.refAmount || '0');
                            if (isNaN(amount) || amount < 0) {
                                throw new Error('Referrer commission amounts must be valid numbers.');
                            }
                            return {
                                id: element.dataset.refId || crypto.randomUUID(),
                                referrerName: element.dataset.refName || 'Referrer',
                                referrerContact: element.dataset.refContact || '',
                                commissionAmount: amount,
                                paymentStatus: element.dataset.status === 'paid' ? 'paid' : 'pending'
                            };
                        });

                        const payload = {
                            id: deliveryId,
                            bikeModel,
                            deliveryDate,
                            commissionReceived,
                            customerName,
                            customerContact,
                            showroomName,
                            invoiceNumber: invoiceNumber || undefined,
                            notes: notes || undefined,
                            commissionToGive,
                            createdAt: type === 'editBrandNew' && data?.createdAt ? data.createdAt : new Date().toISOString()
                        };

                        if (type === 'addBrandNew') {
                            state.data.brandNewDeliveries.push(payload);
                            showToast('Brand new delivery added!');
                        } else {
                            const index = state.data.brandNewDeliveries.findIndex(delivery => delivery.id === deliveryId);
                            if (index === -1) throw new Error('Delivery not found.');
                            state.data.brandNewDeliveries[index] = payload;
                            showToast('Brand new delivery updated!');
                        }

                        autoCreatePRContact({
                            name: customerName,
                            contact: customerContact,
                            relationType: 'Buyer',
                            relatedBikeName: bikeModel
                        });

                        autoCreatePRContact({
                            name: showroomName,
                            contact: '',
                            relationType: 'Showroom',
                            relatedBikeName: bikeModel
                        });

                        commissionToGive.forEach(ref => {
                            autoCreatePRContact({
                                name: ref.referrerName,
                                contact: ref.referrerContact,
                                relationType: 'Referrer',
                                relatedBikeName: bikeModel
                            });
                        });
                        break;
                    }
                }
                
                closeModal();
                render();
                saveData();
                
            } catch (error) {
                showToast(error.message, true);
            }
        };
        
        const handleCashAdjustment = (type) => {
            try {
                const amount = parseFloat(cashAdjAmount.value);
                const description = cashAdjDesc.value.trim();
                
                if (!amount || amount <= 0) throw new Error('Please enter a valid amount.');
                if (!description) throw new Error('Please enter a description.');
                
                state.data.cashEntries.push({
                    id: crypto.randomUUID(),
                    type: type,
                    amount: amount,
                    description: description,
                    createdAt: new Date().toISOString()
                });
                
                cashAdjAmount.value = '';
                cashAdjDesc.value = '';
                
                showToast(`Cash ${type === 'add' ? 'added' : 'removed'} successfully.`);
                render();
                saveData();

            } catch (error) {
                showToast(error.message, true);
            }
        };
        
        // --- NEW: Backup & Restore Functions ---

        const backupToLocalFile = () => {
            try {
                const dataStr = JSON.stringify(state.data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `bike-manager-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Data backup downloaded.');
            } catch (error) {
                console.error('Local backup failed:', error);
                showToast('Local backup failed.', true);
            }
        };
        
        const backupToGist = async () => {
            if (state.ui.isGistSaving) {
                showToast('Sync already in progress.');
                return;
            }
            state.ui.isGistSaving = true;
            showLoader();
            try {
                const res = await fetch(`${GIST_API_URL}/${state.gistId}`, {
                    method: 'PATCH',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        files: { [GIST_FILENAME]: { content: JSON.stringify(state.data) } }
                    })
                });
                if (!res.ok) {
                    if (res.status === 401) {
                        showToast('Token expired. Please log out.', true);
                        logout();
                    } else {
                        throw new Error(`Failed to save data (Status ${res.status})`);
                    }
                } else {
                    showToast('Data backed up to Gist!');
                }
            } catch (error) {
                console.error('Gist backup error:', error);
                showToast(`Gist backup failed: ${error.message}`, true);
            } finally {
                state.ui.isGistSaving = false;
                hideLoader();
            }
        };

        const restoreFromGist = async () => {
            const confirmed = await showConfirm(
                'Restore from Gist?',
                'This will overwrite local changes with the data currently saved on GitHub. Are you sure?'
            );
            if (!confirmed) return;
            
            showLoader();
            try {
                const res = await fetch(`${GIST_API_URL}/${state.gistId}`, { headers: getHeaders() });
                if (!res.ok) {
                    if (res.status === 401 || res.status === 404) {
                        throw new Error('Invalid token or Gist not found.');
                    }
                    throw new Error(`Failed to load data (Status ${res.status})`);
                }
                const gist = await res.json();
                const restoredData = JSON.parse(gist.files[GIST_FILENAME].content);

                state.data = restoredData; 
                runDataMigration(); // Ensure data structure is up-to-date
                saveData(); // Re-save this restored data
                render();
                showToast('Data restored from Gist.');

            } catch (err) {
                console.error(err);
                showToast(`Gist restore failed: ${err.message}`, true);
            } finally {
                hideLoader();
            }
        };
        
        const handleLocalFileRestore = (file) => {
            showLoader();
            const reader = new FileReader();
            
            reader.onload = (event) => {
                try {
                    const parsedData = JSON.parse(event.target.result);
                    
                    if (typeof parsedData.bikes === 'undefined' || typeof parsedData.expenses === 'undefined') {
                        throw new Error('Invalid backup file.');
                    }
                    
                    state.data = parsedData;
                    runDataMigration(); // Ensure data structure
                    saveData(); // Save this new data to local storage
                    render();   
                    
                    showToast('Data restored successfully.');
                } catch (error) {
                    console.error('Restore failed:', error);
                    showToast(`Restore failed: ${error.message}`, true);
                } finally {
                    hideLoader();
                    restoreFileInput.value = null; // Reset file input
                }
            };
            
            reader.onerror = () => {
                showToast('Failed to read file.', true);
                hideLoader();
                restoreFileInput.value = null;
            };
            
            reader.readAsText(file);
        };

        const csvEscape = (value) => {
            if (value === null || value === undefined) return '';
            const str = String(value).replace(/"/g, '""');
            return /[",\n]/.test(str) ? `"${str}"` : str;
        };

        const exportCreditAsCSV = (records, totals) => {
            const lines = [];
            lines.push(`Generated At,${csvEscape(new Date().toISOString())}`);
            lines.push(`Total Credit Given,${csvEscape((totals.totalCredit || 0).toFixed(2))}`);
            lines.push(`Collected,${csvEscape((totals.collected || 0).toFixed(2))}`);
            lines.push(`Pending,${csvEscape((totals.pending || 0).toFixed(2))}`);
            lines.push(`Active Customers,${csvEscape(totals.activeCustomers || 0)}`);
            lines.push('');

            const headers = [
                'Customer Name',
                'Contact',
                'Bike Name',
                'Number Plate',
                'Sale Price',
                'Pending Amount',
                'Payment Mode',
                'Next Due',
                'Initial Payment',
                'Monthly EMI',
                'Installments Paid',
                'Installments Total'
            ];
            lines.push(headers.map(csvEscape).join(','));

            records.forEach(record => {
                const row = [
                    csvEscape(record.customerName),
                    csvEscape(record.contact),
                    csvEscape(record.bikeName),
                    csvEscape(record.bikeNumberPlate),
                    csvEscape((record.salePrice || 0).toFixed(2)),
                    csvEscape((record.pendingAmount || 0).toFixed(2)),
                    csvEscape(record.paymentMode?.toUpperCase() || ''),
                    csvEscape(record.nextDueText),
                    csvEscape((record.initialPayment || 0).toFixed(2)),
                    csvEscape((record.monthlyAmount || 0).toFixed(2)),
                    csvEscape(record.installmentsPaid || 0),
                    csvEscape(record.totalInstallments || 0)
                ];
                lines.push(row.join(','));
            });

            const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `bike-credit-export-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Credit data exported as CSV.');
        };

        const exportCreditAsPDF = (records, totals) => {
            const { jsPDF } = window.jspdf || {};
            if (!jsPDF) {
                showToast('PDF export unavailable. Please try CSV instead.', true);
                return;
            }

            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            const margin = 48;
            const pageHeight = doc.internal.pageSize.getHeight();

            const addHeader = () => {
                doc.setFontSize(16);
                doc.text('Credit Portfolio Export', margin, margin);
                doc.setFontSize(10);
                doc.text(`Generated: ${new Date().toLocaleString()}`, margin, margin + 18);
                doc.text(`Total Credit: ${formatCurrency(totals.totalCredit || 0)}`, margin, margin + 32);
                doc.text(`Collected: ${formatCurrency(totals.collected || 0)} • Pending: ${formatCurrency(totals.pending || 0)}`, margin, margin + 46);
                doc.text(`Active Customers: ${totals.activeCustomers || 0}`, margin, margin + 60);
            };

            const ensureSpace = (y, extra = 0) => {
                if (y + extra > pageHeight - margin) {
                    doc.addPage();
                    addHeader();
                    return margin + 80;
                }
                return y;
            };

            addHeader();
            let y = margin + 90;

            records.forEach((record, index) => {
                y = ensureSpace(y, 80);
                doc.setFontSize(12);
                doc.text(`${index + 1}. ${record.customerName}`, margin, y);
                doc.setFontSize(10);
                y += 16;

                const details = [
                    `Bike: ${record.bikeName} (${record.bikeNumberPlate})`,
                    `Contact: ${record.contact}`,
                    `Sale Price: ${formatCurrency(record.salePrice)} • Pending: ${formatCurrency(record.pendingAmount)}`,
                    `Mode: ${record.paymentMode?.toUpperCase() || ''} • Next Due: ${record.nextDueText}`
                ];

                if (record.paymentMode === 'credit') {
                    details.push(`Initial Payment: ${formatCurrency(record.initialPayment)}`);
                } else if (record.paymentMode === 'emi') {
                    details.push(`EMI: ${formatCurrency(record.monthlyAmount)} • Installments: ${record.installmentsPaid}/${record.totalInstallments}`);
                }

                details.forEach(textLine => {
                    const lines = doc.splitTextToSize(textLine, doc.internal.pageSize.getWidth() - margin * 2);
                    lines.forEach(line => {
                        y = ensureSpace(y, 14);
                        doc.text(line, margin + 12, y);
                        y += 14;
                    });
                });

                const paymentHeader = 'Recent Payments:';
                y = ensureSpace(y, 14);
                doc.text(paymentHeader, margin + 12, y);
                y += 14;

                const payments = record.payments.slice(0, 3);
                if (!payments.length) {
                    y = ensureSpace(y, 14);
                    doc.text('None recorded.', margin + 24, y);
                    y += 14;
                } else {
                    payments.forEach(payment => {
                        const paymentLine = `${formatDate(payment.date)} • ${formatCurrency(payment.amount)} • ${payment.type}`;
                        y = ensureSpace(y, 14);
                        doc.text(paymentLine, margin + 24, y);
                        y += 14;
                    });
                }

                y += 10;
            });

            doc.save(`bike-credit-export-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('Credit data exported as PDF.');
        };

        const exportCreditData = async () => {
            const { records, totals } = summarizeCreditRecords();
            if (!records.length) {
                showToast('No credit or EMI records to export.', true);
                return;
            }

            const choice = await showExportChoice('Export Credit Data', 'Select your preferred export format.');
            if (!choice) {
                return;
            }

            if (choice === 'csv') {
                exportCreditAsCSV(records, totals);
            } else if (choice === 'pdf') {
                exportCreditAsPDF(records, totals);
            }
        };

        // --- Event Listeners ---
        
        const addEventListeners = () => {
            sensitiveToggle.addEventListener('click', () => {
                if (state.security.isUnlocked) {
                    lockSensitiveData();
                    showToast('Sensitive data locked.');
                } else {
                    requestPinUnlock('Enter your PIN to unlock sensitive data.').catch(() => {});
                }
            });

            pinSubmit.addEventListener('click', handlePinSubmission);
            pinCancel.addEventListener('click', () => {
                closePinModal();
                rejectPinRequest('cancelled');
            });
            pinInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    handlePinSubmission();
                } else if (event.key === 'Escape') {
                    closePinModal();
                    rejectPinRequest('cancelled');
                }
            });
            pinModal.addEventListener('click', (event) => {
                if ((event.target).classList?.contains('modal-overlay')) {
                    closePinModal();
                    rejectPinRequest('cancelled');
                }
            });

            if (analyticsUnlockBtn) {
                analyticsUnlockBtn.addEventListener('click', () => {
                    requestPinUnlock('Unlock analytics with your PIN.').catch(() => {});
                });
            }

            // PAT Modal Save
            patSave.addEventListener('click', async () => {
                const token = patInput.value;
                if (!token) {
                    patError.textContent = 'Please enter a token.';
                    return;
                }
                
                showLoader();
                state.githubPAT = token;
                state.storageMode = 'gist';
                
                const gist = await findGist();
                
                if (gist) {
                    state.gistId = gist.id;
                    state.data = gist.content;
                    showToast('Data loaded successfully!');
                } else if (!patError.textContent) {
                    const newGist = await createGist();
                    if (newGist) {
                        state.gistId = newGist.id;
                        state.data = newGist.content;
                        showToast('New data store created!');
                    } else {
                        hideLoader();
                        return;
                    }
                } else {
                    hideLoader();
                    return;
                }
                
                sessionStorage.setItem('githubPAT', state.githubPAT);
                sessionStorage.setItem('gistId', state.gistId);
                
                runDataMigration();
                
                hideLoader();
                patModal.classList.add('hidden');
                appWrapper.classList.remove('hidden');
                
                renderPage('dashboard');
            });
            
            // PAT Modal Skip
            patSkip.addEventListener('click', () => {
                state.storageMode = 'local';
                
                try {
                    const localData = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (localData) {
                        state.data = JSON.parse(localData);
                        showToast('Loaded local data.');
                    } else {
                        showToast('Starting fresh. Data will be saved locally.');
                    }
                } catch (error) {
                    console.error('Failed to parse local data:', error);
                    showToast('Could not load local data, starting fresh.', true);
                }
                
                runDataMigration();
                
                patModal.classList.add('hidden');
                appWrapper.classList.remove('hidden');
                renderPage('dashboard');
            });

            // Bottom Navigation
            navBar.addEventListener('click', (e) => {
                const navItem = e.target.closest('.nav-item');
                if (navItem) {
                    renderPage(navItem.dataset.page);
                }
            });
            
            // Global "Add" Button
            addButton.addEventListener('click', () => {
                const page = state.ui.currentPage;
                if (page === 'bikes') {
                    if (state.ui.currentBikeType === 'brand_new') {
                        openModal('addBrandNew');
                    } else {
                        openModal('addBike');
                    }
                }
                if (page === 'expenses') openModal('addExpense');
                if (page === 'pr') openModal('addPR');
            });
            
            // Modal Close/Save
            modalClose.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', closeModal);
            modalSave.addEventListener('click', handleModalSave);

            // Settings: Cash Adjustments
            cashAdjAdd.addEventListener('click', () => handleCashAdjustment('add'));
            cashAdjRemove.addEventListener('click', () => handleCashAdjustment('remove'));

            if (pinUpdateBtn) {
                pinUpdateBtn.addEventListener('click', () => {
                    const current = (pinCurrentInput?.value || '').trim();
                    const next = (pinNewInput?.value || '').trim();
                    const existing = state.data?.settings?.pin || '1111';

                    if (!current || !next) {
                        showToast('Please fill in both PIN fields.', true);
                        return;
                    }
                    if (current !== existing) {
                        showToast('Current PIN is incorrect.', true);
                        pinCurrentInput?.focus();
                        return;
                    }
                    if (next.length < 4 || next.length > 6 || /\D/.test(next)) {
                        showToast('PIN must be 4-6 digits.', true);
                        pinNewInput?.focus();
                        pinNewInput?.select();
                        return;
                    }
                    state.data.settings.pin = next;
                    pinCurrentInput.value = '';
                    pinNewInput.value = '';
                    lockSensitiveData();
                    showToast('PIN updated. Sensitive data locked.');
                    saveData();
                });
            }
            
            // Settings: Logout
            settingLogout.addEventListener('click', () => {
                logout();
            });
            
            // Settings: Reset Data
            settingReset.addEventListener('click', async () => {
                const confirmed = await showConfirm(
                    'Reset All Data?',
                    'This will erase ALL bikes, expenses, contacts, payments, and cash transactions.'
                );
                if (confirmed) {
                    state.data = {
                        bikes: [], expenses: [], pr: [], cashEntries: [], payments: [],
                        settings: { baseInvestment: 0, pin: '1111' }
                    };
                    lockSensitiveData();
                    saveData();
                    showToast('All data has been reset.');
                }
            });

            // --- NEW: Backup & Restore Listeners ---
            
            settingBackup.addEventListener('click', () => {
                if (state.storageMode === 'gist') {
                    backupToGist();
                } else {
                    backupToLocalFile();
                }
            });
            
            settingRestore.addEventListener('click', () => {
                if (state.storageMode === 'gist') {
                    restoreFromGist();
                } else {
                    // Trigger local file input
                    restoreFileInput.click();
                }
            });

            if (creditExport) {
                creditExport.addEventListener('click', exportCreditData);
            }
            
            restoreFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const confirmed = await showConfirm(
                    'Restore from File?',
                    'This will overwrite ALL current data in the app with the data from this file. This action cannot be undone.'
                );
                
                if (confirmed) {
                    handleLocalFileRestore(file);
                } else {
                    e.target.value = null; // Reset file input if cancelled
                }
            });
            
            // --- Page-specific Listeners ---
            
            // Dashboard: Sort
            dashboardSort.addEventListener('change', (e) => {
                state.ui.currentDashboardSort = e.target.value;
                renderDashboard();
            });

            // Dashboard: Reminder Clicks
            dashboardReminders.addEventListener('click', (e) => {
                const item = e.target.closest('[data-action="log-payment"]');
                if (!item) return;

                const bikeId = item.dataset.bikeId;
                const bike = state.data.bikes.find(b => b.id === bikeId);
                if (bike) {
                    openModal('logPayment', bike);
                }
            });

            // Bike Page: Filters
            bikeFilter.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    bikeFilter.querySelector('button.active').classList.remove('active');
                    e.target.classList.add('active');
                    state.ui.currentBikeFilter = e.target.dataset.filter;
                    renderBikesPage();
                }
            });
            bikeSearch.addEventListener('input', (e) => {
                state.ui.currentBikeSearch = e.target.value;
                renderBikesPage();
            });
            if (bikeTypeToggle) {
                bikeTypeToggle.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        bikeTypeToggle.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        state.ui.currentBikeType = e.target.dataset.type;
                        renderBikesPage();
                    }
                });
            }
            
            // Bike Page: Sort Dropdown
            bikeSortTrigger.addEventListener('click', () => {
                bikeSortMenu.classList.toggle('hidden');
            });

            bikeSortMenu.addEventListener('click', (e) => {
                const item = e.target.closest('.bike-sort-item');
                if (item) {
                    state.ui.currentBikeSort = item.dataset.sort;
                    bikeSortLabel.textContent = `Sort: ${item.textContent}`;
                    bikeSortMenu.classList.add('hidden');
                    renderBikesPage();
                }
            });
            
            // Bike Page: List Clicks
            bikeList.addEventListener('click', (e) => {
                const button = e.target.closest('[data-action]');
                if (!button) return;

                const bikeWrapper = button.closest('[data-bike-id]');
                const brandWrapper = button.closest('[data-brand-id]');
                const action = button.dataset.action;

                if (brandWrapper) {
                    const deliveryId = brandWrapper.dataset.brandId;
                    if (action === 'edit-brand-new') {
                        const delivery = state.data.brandNewDeliveries.find(entry => entry.id === deliveryId);
                        if (delivery) {
                            openModal('editBrandNew', delivery);
                        }
                    } else if (action === 'delete-brand-new') {
                        handleDeleteBrandNew(deliveryId);
                    } else if (action === 'toggle-commission') {
                        const refWrapper = button.closest('[data-ref-id]');
                        if (refWrapper) {
                            toggleBrandNewCommissionStatus(deliveryId, refWrapper.dataset.refId);
                        }
                    }
                    return;
                }

                if (!bikeWrapper) return;

                const bikeId = bikeWrapper.dataset.bikeId;
                const bike = state.data.bikes.find(b => b.id === bikeId);
                if (!bike) return;

                if (action === 'edit-bike') {
                    openModal('editBike', bike);
                } else if (action === 'mark-sold') {
                    openModal('markSold', bike);
                } else if (action === 'log-payment') {
                    openModal('logPayment', bike);
                }
            });

            if (creditList) {
                creditList.addEventListener('click', (e) => {
                    const button = e.target.closest('[data-action="log-payment"]');
                    if (!button) return;
                    const wrapper = button.closest('[data-bike-id]');
                    if (!wrapper) return;
                    const bike = state.data.bikes.find(b => b.id === wrapper.dataset.bikeId);
                    if (bike) {
                        openModal('logPayment', bike);
                    }
                });
            }
            
            // Expense Page: List Clicks
            expenseList.addEventListener('click', (e) => {
                const item = e.target.closest('[data-expense-id]');
                if (!item) return;
                
                const expense = state.data.expenses.find(ex => ex.id === item.dataset.expenseId);
                if (expense) {
                    openModal('editExpense', expense);
                }
            });
            
            // PR Page: Filters
            prFilter.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    prFilter.querySelector('button.active').classList.remove('active');
                    e.target.classList.add('active');
                    state.ui.currentPRFilter = e.target.dataset.filter;
                    renderPRPage();
                }
            });
            prSearch.addEventListener('input', (e) => {
                state.ui.currentPRSearch = e.target.value;
                renderPRPage();
            });
            
            // PR Page: List Clicks
            prList.addEventListener('click', (e) => {
                const actionButton = e.target.closest('[data-action]');
                if (actionButton) {
                    e.preventDefault();
                    const action = actionButton.dataset.action;
                    switch (action) {
                        case 'pr-call': {
                            const contact = actionButton.dataset.contact;
                            if (contact) {
                                window.open(`tel:${contact}`, '_self');
                            } else {
                                showToast('No contact number available.', true);
                            }
                            break;
                        }
                        case 'pr-whatsapp': {
                            const contact = actionButton.dataset.contact;
                            if (contact) {
                                window.open(`https://wa.me/${contact}`, '_blank');
                            } else {
                                showToast('No contact number available.', true);
                            }
                            break;
                        }
                        case 'pr-copy': {
                            const contact = actionButton.dataset.contact;
                            if (contact) {
                                copyTextToClipboard(contact);
                            }
                            break;
                        }
                        case 'pr-go-bike': {
                            const bikeName = actionButton.dataset.bikeName;
                            navigateToBikeRecord(bikeName);
                            break;
                        }
                        case 'pr-filter-supplier': {
                            const supplierName = actionButton.dataset.prName;
                            filterBikesBySupplier(supplierName);
                            break;
                        }
                        case 'pr-filter-owner': {
                            const ownerName = actionButton.dataset.prName;
                            filterBikesByOwner(ownerName);
                            break;
                        }
                        case 'pr-log-payment': {
                            const buyerName = actionButton.dataset.prName;
                            logPaymentForBuyer(buyerName);
                            break;
                        }
                        default:
                            break;
                    }
                    return;
                }

                const item = e.target.closest('[data-pr-id]');
                if (!item) return;
                
                const pr = state.data.pr.find(p => p.id === item.dataset.prId);
                if (pr) {
                    openModal('editPR', pr);
                }
            });

            // Global: Close sort dropdown on click outside
            document.addEventListener('click', (e) => {
                if (!bikeSortTrigger.contains(e.target) && !bikeSortMenu.contains(e.target)) {
                    bikeSortMenu.classList.add('hidden');
                }
            });
        };
        
        const logout = () => {
            sessionStorage.clear();
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            location.reload();
        };

        // --- App Initialization ---
        
        const init = () => {
            const pat = sessionStorage.getItem('githubPAT');
            const gistId = sessionStorage.getItem('gistId');
            
            if (pat && gistId) {
                state.githubPAT = pat;
                state.gistId = gistId;
                state.storageMode = 'gist';
                
                showLoader();
                fetch(`${GIST_API_URL}/${gistId}`, { headers: getHeaders() })
                    .then(res => {
                        if (!res.ok) {
                            if (res.status === 401 || res.status === 404) {
                                throw new Error('Invalid token or Gist not found. Please log in again.');
                            }
                            throw new Error(`Failed to load data (Status ${res.status})`);
                        }
                        return res.json();
                    })
                    .then(gist => {
                        state.data = JSON.parse(gist.files[GIST_FILENAME].content);
                        runDataMigration();
                        appWrapper.classList.remove('hidden');
                        renderPage('dashboard');
                    })
                    .catch(err => {
                        console.error(err);
                        sessionStorage.clear();
                        patModal.classList.remove('hidden');
                        patError.textContent = err.message;
                    })
                    .finally(() => {
                        hideLoader();
                    });
                
            } else {
                patModal.classList.remove('hidden');
            }
            
            addEventListeners();
        };

        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
