<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bike Inventory (Gist Edition)</title>
  <meta name="description" content="Streamlined bike inventory manager using GitHub Gist month-wise architecture." />

  <!--
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘                 BIKE MANAGER (GIST EDITION) - v8.0 CHANGELOG                 â•‘
  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
  â•‘ This is a complete refactor based on the "Streamlined Month-Wise Gist        â•‘
  â•‘ Architecture" plan.                                                        â•‘
  â•‘                                                                            â•‘
  â•‘ KEY CHANGES:                                                               â•‘
  â•‘ âœ“ ARCHITECTURE: Removed Dexie (IndexedDB). All data is now managed via       â•‘
  â•‘   a month-wise file structure on a single GitHub Gist.                       â•‘
  â•‘ âœ“ STORAGE: Uses localStorage as a cache for loaded months. Gist is the       â•‘
  â•‘   source of truth.                                                         â•‘
  â•‘ âœ“ SYNC: Simplified sync logic. Writes to cache instantly, then batches       â•‘
  â•‘   Gist updates.                                                            â•‘
  â•‘ âœ“ MONTHS: Added month-wise navigation and auto-creation of new month files.  â•‘
  â•‘   Bike assignment is based on 'datePurchase'.                                â•‘
  â•‘ âœ“ UI: New bike cards, 8-card stats grid, new bike entry form (Quick/Full),   â•‘
  â•‘   and new 3-tab analytics dashboard structure.                               â•‘
  â•‘ âœ“ ANALYTICS: Rebuilt stats page with 3-tabs (Financial, Inventory, Insights).â•‘
  â•‘ âœ“ EXPORT: New export options (CSV, Monthly PDF, WhatsApp Summary).           â•‘
  â•‘ âœ“ STACK: Added jsPDF & jsPDF-AutoTable. Removed Dexie.                       â•‘
  â•‘ -------------------------------------------------------------------------- â•‘
  â•‘ âŒ REMOVED: Photo uploads, PWA features, complex sync UI, bulk actions,     â•‘
  â•‘   XLSX/JSON export (per plan), AI Analyst, pagination (monthly view).        â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -->

  <!-- Libraries (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- jsPDF libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <!-- Inline Styles -->
  <style>
    /* --- 1. Fonts & Root Variables --- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    :root {
      /* Base Dark Theme (Default) */
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --bg-gradient-start: #071026;
      --bg-gradient-end: #020511;
      --bg-page: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      --bg-card: #071b2b;
      --bg-card-subtle: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      --bg-header: rgba(7, 27, 43, 0.85);
      --bg-modal: rgba(7, 16, 38, 0.9);
      --bg-input: rgba(0, 0, 0, 0.2);
      --bg-input-focus: rgba(0, 0, 0, 0.1);
      --bg-hover: rgba(255, 255, 255, 0.05);
      --bg-active: rgba(255, 255, 255, 0.08);
      --bg-nav: var(--bg-header);

      --accent-gradient: linear-gradient(90deg, #00D0FF, #6EE7B7);
      --accent-1: #00D0FF;
      --accent-2: #6EE7B7;
      --accent-text: #00242f;

      --text-primary: #e6f6ff;
      --text-secondary: #9fb0c2;
      --text-disabled: #6a7f96;
      --text-placeholder: #6a7f96;

      --border-color: rgba(255, 255, 255, 0.1);
      --border-color-subtle: rgba(255, 255, 255, 0.04);
      --border-focus: var(--accent-1);

      --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.6);
      --shadow-nav: 0 -4px 12px rgba(0, 0, 0, 0.3);
      --shadow-btn: 0 2px 8px rgba(0, 0, 0, 0.3);

      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
      --aging-good: #22c55e;
      --aging-ok: #f59e0b;
      --aging-warn: #e1791f;
      --aging-bad: #ef4444;

      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-full: 9999px;

      --nav-height-mobile: 60px;
      --header-height: 60px;
      --tap-target: 44px;
      --transition-speed: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Light mode theme */
    .theme-light {
      --bg-gradient-start: #f4f7fa;
      --bg-gradient-end: #e8eef3;
      --bg-card: #ffffff;
      --bg-card-subtle: linear-gradient(180deg, #ffffff, #fdfdfd);
      --bg-header: rgba(255, 255, 255, 0.85);
      --bg-modal: rgba(244, 247, 250, 0.9);
      --bg-input: rgba(0, 0, 0, 0.04);
      --bg-input-focus: rgba(0, 0, 0, 0.02);
      --bg-hover: rgba(0, 0, 0, 0.05);
      --bg-active: rgba(0, 0, 0, 0.08);
      --bg-nav: var(--bg-header);

      --text-primary: #071026;
      --text-secondary: #4a5a70;
      --text-disabled: #9fb0c2;
      --text-placeholder: #9fb0c2;

      --border-color: rgba(0, 0, 0, 0.1);
      --border-color-subtle: rgba(0, 0, 0, 0.04);

      --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.08);
      --shadow-nav: 0 -4px 12px rgba(0, 0, 0, 0.05);
    }

    /* --- 3. Base & Reset --- */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html {
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      font-family: var(--font-family);
      background: var(--bg-page);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-size: 16px;
      line-height: 1.5;
      transition: background 0.3s ease, color 0.3s ease;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    input,
    button,
    select,
    textarea {
      font-family: inherit;
      color: inherit;
      font-size: 1rem;
    }

    button {
      cursor: pointer;
      border: none;
      background: none;
      padding: 0;
      -webkit-appearance: none;
      appearance: none;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      margin: 0;
      font-weight: 700;
    }

    a {
      color: var(--accent-1);
      text-decoration: none;
    }

    svg {
      display: block;
    }

    ::placeholder {
      color: var(--text-placeholder);
    }

    *:focus-visible {
      outline: 2px solid var(--accent-1);
      outline-offset: 2px;
      border-radius: var(--radius-sm);
    }

    /* --- 4. Main App Layout --- */
    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .app-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 16px;
      height: var(--header-height);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      background: var(--bg-header);
      border-bottom: 1px solid var(--border-color-subtle);
    }

    .app-header h1 {
      font-size: 1.25rem;
      margin-right: auto;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .app-main {
      flex-grow: 1;
      padding: 16px;
      padding-bottom: calc(var(--nav-height-mobile) + 32px);
    }

    .app-bottom-nav {
      display: flex;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--nav-height-mobile);
      background: var(--bg-nav);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow-nav);
      z-index: 100;
      border-top: 1px solid var(--border-color-subtle);
    }

    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-secondary);
      transition: var(--transition-speed);
      position: relative;
    }

    .nav-btn svg {
      width: 22px;
      height: 22px;
    }

    .nav-btn.active {
      color: var(--accent-1);
    }

    .nav-btn.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 3px;
      background: var(--accent-gradient);
      border-radius: 0 0 3px 3px;
    }

    /* Desktop layout */
    @media (min-width: 768px) {
      .app-container {
        flex-direction: row;
      }

      .app-bottom-nav {
        position: sticky;
        top: 0;
        left: 0;
        flex-direction: column;
        width: 80px;
        height: 100vh;
        border-top: none;
        border-right: 1px solid var(--border-color-subtle);
        box-shadow: none;
        justify-content: flex-start;
        padding-top: var(--header-height);
      }

      .nav-btn {
        width: 100%;
        height: 70px;
        font-size: 0.75rem;
      }

      .nav-btn.active::before {
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        width: 3px;
        height: 40px;
        border-radius: 0 3px 3px 0;
      }

      .app-header {
        width: calc(100% - 80px);
        position: sticky;
        left: 80px;
        border-bottom: 1px solid var(--border-color-subtle);
      }

      .app-content-wrapper {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        width: calc(100% - 80px);
      }

      .app-main {
        width: 100%;
        padding: 32px;
        padding-bottom: 32px;
      }
    }

    /* --- 5. Core Components --- */

    .view {
      display: none;
    }

    .view.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
      min-height: var(--tap-target);
      transition: var(--transition-speed);
      box-shadow: var(--shadow-btn);
      position: relative;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
    }

    .btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
      transform: scale(0);
      transition: transform 0.5s ease;
      opacity: 0;
    }

    .btn:active::after {
      transform: scale(2);
      opacity: 1;
      transition-duration: 0.1s;
    }

    .btn-primary {
      background: var(--accent-gradient);
      color: var(--accent-text);
    }

    .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--bg-card-subtle);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--accent-1);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
      min-height: 36px;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      box-shadow: none;
    }

    .btn-ghost:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .btn-danger {
      background: var(--error);
      color: #fff;
    }

    .btn-icon {
      padding: 10px;
      min-height: var(--tap-target);
      min-width: var(--tap-target);
      border-radius: var(--radius-full);
      box-shadow: none;
    }

    .btn-icon svg {
      width: 24px;
      height: 24px;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-card);
      border: 1px solid var(--border-color-subtle);
      transition: var(--transition-speed);
    }

    /* --- 6. Form & Input Elements --- */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-input);
      color: var(--text-primary);
      transition: var(--transition-speed);
      -webkit-appearance: none;
      appearance: none;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--border-focus);
      background: var(--bg-input-focus);
      box-shadow: 0 0 0 2px rgba(0, 208, 255, 0.3);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .form-section-divider {
      border-top: 1px solid var(--border-color);
      margin: 20px 0;
    }

    /* --- 7. Modals & Panels --- */
    /* Base modal styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg-modal);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 24px;
      width: 100%;
      max-width: 500px;
      box-shadow: var(--shadow-card);
      transform: scale(0.95);
      transition: transform 0.3s;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .modal-overlay.active .modal-content {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-shrink: 0;
    }

    .modal-header h2 {
      font-size: 1.25rem;
    }

    .modal-body {
      max-height: 70vh;
      overflow-y: auto;
      flex-grow: 1;
      -webkit-overflow-scrolling: touch;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      flex-shrink: 0;
    }

    /* Bottom Sheet Modal Variant */
    @media (max-width: 640px) {
      .modal-overlay.bottom-sheet {
        align-items: flex-end;
      }
      .modal-overlay.bottom-sheet .modal-content {
        max-width: 100%;
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        transform: translateY(100%);
      }
      .modal-overlay.bottom-sheet.active .modal-content {
        transform: translateY(0);
      }
    }

    /* --- 8. Specific UI Elements --- */

    .app-loader {
      position: fixed;
      inset: 0;
      background: var(--bg-page);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      transition: opacity 0.5s ease;
    }

    .app-loader.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .app-loader .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border-color);
      border-top-color: var(--accent-1);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .app-loader h2 {
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-size: 1.5rem;
    }

    .sync-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 6px 10px;
      border-radius: var(--radius-full);
      background: var(--bg-card-subtle);
      border: 1px solid var(--border-color-subtle);
      color: var(--text-secondary);
      transition: var(--transition-speed);
    }

    .sync-status.syncing .status-dot {
      background: var(--warning);
      animation: pulse 1.5s infinite;
    }

    .sync-status.success .status-dot {
      background: var(--success);
    }

    .sync-status.error .status-dot {
      background: var(--error);
    }

    .sync-status.offline .status-dot {
      background: var(--text-disabled);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
    }

    .toast-container {
      position: fixed;
      bottom: calc(var(--nav-height-mobile) + 20px);
      left: 16px;
      right: 16px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      pointer-events: none;
    }

    .toast {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #2a3b4d;
      color: var(--text-primary);
      padding: 12px 16px;
      border-radius: var(--radius-md);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      animation: toast-in 0.3s ease;
      width: 100%;
      max-width: 400px;
      pointer-events: auto;
    }

    .toast.success {
      background: var(--success);
      color: #fff;
    }

    .toast.error {
      background: var(--error);
      color: #fff;
    }
    
    @media (min-width: 768px) {
      .toast-container {
        bottom: 20px;
        left: auto;
        right: 20px;
        align-items: flex-end;
      }
    }

    /* Bike List */
    .bike-list {
      display: grid;
      gap: 12px;
    }

    .bike-card {
      background: var(--bg-card-subtle);
      border: 1px solid var(--border-color-subtle);
      border-radius: var(--radius-md);
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
      transition: var(--transition-speed);
      cursor: pointer;
    }
    .bike-card:hover {
      border-color: var(--border-color);
      transform: translateY(-2px);
    }
    .bike-card-main {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
      overflow: hidden;
    }
    .bike-card-details {
      overflow: hidden;
    }
    .bike-card-plate {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .bike-card-sub {
      font-size: 0.9rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .bike-card-aging {
      font-size: 0.8rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      white-space: nowrap;
    }
    .bike-card-aging.good { background-color: var(--aging-good); color: #fff; }
    .bike-card-aging.ok { background-color: var(--aging-ok); color: #000; }
    .bike-card-aging.warn { background-color: var(--aging-warn); color: #fff; }
    .bike-card-aging.bad { background-color: var(--aging-bad); color: #fff; }

    .bike-card-profit {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    .profit-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--success);
      white-space: nowrap;
    }
    .investment-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    .profit-value.loss {
      color: var(--error);
    }
    
    .bike-card-actions {
      grid-column: 1 / -1;
      border-top: 1px solid var(--border-color-subtle);
      margin-top: 12px;
      padding-top: 12px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .bike-card-actions .btn-sm {
      min-height: 32px;
      padding: 4px 12px;
    }

    /* Month Navigator */
    .month-navigator {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 8px;
      background: var(--bg-card);
      border-radius: var(--radius-md);
    }
    .month-navigator h2 {
      font-size: 1.25rem;
      color: var(--accent-1);
    }

    /* View Toggle */
    .view-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .view-toggle .chip {
      padding: 8px 16px;
      font-size: 0.9rem;
    }
    
    .filter-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    #search-input {
      flex-grow: 1;
      min-width: 200px;
      border-radius: var(--radius-full);
      padding-left: 16px;
    }

    /* Filter Chips */
    .filter-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .chip {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--bg-input);
      color: var(--text-secondary);
      padding: 6px 12px;
      border-radius: var(--radius-full);
      font-size: 0.85rem;
      border: 1px solid var(--border-color-subtle);
      cursor: pointer;
      transition: var(--transition-speed);
    }
    .chip:hover {
      border-color: var(--border-color);
    }
    .chip.active {
      background: var(--accent-1);
      color: var(--accent-text);
      font-weight: 600;
      border-color: var(--accent-1);
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
      color: var(--text-secondary);
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-lg);
    }
    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.7;
    }
    .empty-state h3 {
      font-size: 1.1rem;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    /* Stats Grid (8-card) */
    .stats-grid-8 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (min-width: 1024px) {
      .stats-grid-8 {
        grid-template-columns: 1fr 1fr 1fr 1fr;
      }
    }
    .stat-card {
      background: var(--bg-card-subtle);
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color-subtle);
      display: flex;
      flex-direction: column;
    }
    .stat-card-title {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    .stat-card-value {
      font-size: 1.25rem;
      font-weight: 700;
      min-height: 1.2em;
    }
    .stat-card-value.small {
      font-size: 1rem;
    }
    .stat-card-context {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    /* Analytics Tabs */
    .tabs-nav {
      display: flex;
      gap: 4px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 16px;
    }
    .tab-btn {
      padding: 10px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 3px solid transparent;
      transition: var(--transition-speed);
    }
    .tab-btn.active {
      color: var(--accent-1);
      border-bottom-color: var(--accent-1);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .chart-container {
      margin-top: 24px;
      position: relative;
    }
    .chart-container h3 {
      font-size: 1.1rem;
      margin-bottom: 12px;
    }
    .chart-container canvas {
      max-width: 100%;
      height: auto;
    }
    .key-insight-card {
      background: var(--bg-card-subtle);
      padding: 16px;
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      border-left: 4px solid var(--accent-1);
    }
    .key-insight-card p {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      line-height: 1.6;
    }
    .key-insight-card .icon {
      font-size: 1.5rem;
      margin-right: 12px;
    }

    /* Settings Page */
    .settings-section {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 24px;
      margin-bottom: 24px;
    }
    .settings-section:last-child {
      border-bottom: none;
    }
    .settings-section h2 {
      font-size: 1.25rem;
      margin-bottom: 16px;
    }
    .settings-section p {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 0;
      margin-bottom: 16px;
      line-height: 1.6;
    }
    
    /* Theme toggle switch */
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-input);
      border-radius: var(--radius-md);
      margin-bottom: 16px;
    }
    .theme-toggle label {
      flex-grow: 1;
      font-weight: 600;
      color: var(--text-primary);
    }
    .switch {
      position: relative;
      width: 52px;
      height: 28px;
      background: var(--border-color);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: var(--transition-speed);
      flex-shrink: 0;
    }
    .switch::before {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: var(--transition-speed);
    }
    .switch.active {
      background: var(--accent-gradient);
    }
    .switch.active::before {
      left: 27px;
    }

    /* --- 9. Utility & Animations --- */
    .hidden {
      display: none !important;
    }
    .text-success { color: var(--success); }
    .text-error { color: var(--error); }
    .text-warning { color: var(--warning); }
    .text-secondary { color: var(--text-secondary); }
    .text-center { text-align: center; }
    .mt-2 { margin-top: 16px; }
    .mb-2 { margin-bottom: 16px; }
    .mb-4 { margin-bottom: 24px; }
    
    .skeleton {
      background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-hover) 50%, var(--bg-card) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: var(--radius-sm);
    }
    .skeleton-card {
      height: 120px;
      margin-bottom: 12px;
      border-radius: var(--radius-md);
    }
    .bike-list-skeleton {
      display: grid;
      gap: 12px;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    @keyframes toast-in {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    @media (max-width: 768px) {
      .chart-container canvas {
        height: 250px !important;
      }
      .form-grid {
        grid-template-columns: 1fr;
      }
      .stats-grid-8 {
        grid-template-columns: 1fr 1fr;
      }
      .app-main {
        padding: 16px;
        padding-bottom: calc(var(--nav-height-mobile) + 32px);
      }
    }
  </style>
</head>

<body>

  <!-- SVG Icon Definitions -->
  <svg width="0" height="0" style="position:absolute; overflow:hidden;">
    <symbol id="icon-list" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" /></symbol>
    <symbol id="icon-chart" viewBox="0 0 24 24"><path fill="currentColor" d="M3 22v-9h4v9H3zm0-11V3h4v8H3zm6 11v-5h4v5H9zm0-7V3h4v12H9zm6 7v-9h4v9h-4zm0-11V3h4v8h-4z" /></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24"><path fill="currentColor" d="M19.4 12c0-.2.1-.4.1-.6c0-.2-.1-.4-.1-.6l1.7-1.3c.2-.1.2-.4 0-.6l-1.6-2.8c-.1-.2-.4-.3-.6-.2l-2 .8c-.4-.3-.8-.5-1.3-.7l-.3-2.1c0-.3-.2-.4-.5-.4h-3.2c-.3 0-.5.1-.5.4l-.3 2.1c-.5.2-.9.4-1.3.7l-2-.8c-.2-.1-.5 0-.6.2l-1.6 2.8c-.1.2-.1.5 0 .6l1.7 1.3c-.1.2-.1.4-.1.6c0 .2.1.4.1.6l-1.7 1.3c-.2.1-.2.4 0 .6l1.6 2.8c.1.2.4.3.6.2l2-.8c.4.3.8.5 1.3.7l.3 2.1c0 .3.2.4.5.4h3.2c.3 0 .5-.1.5.4l.3-2.1c.5-.2.9-.4 1.3-.7l2 .8c.2.1.5 0 .6-.2l1.6-2.8c.1-.2.1-.5 0-.6l-1.7-1.3zm-7.4 2.5c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5s2.5 1.1 2.5 2.5s-1.1 2.5-2.5 2.5z" /></symbol>
    <symbol id="icon-add" viewBox="0 0 24 24"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" /></symbol>
    <symbol id="icon-close" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41z" /></symbol>
    <symbol id="icon-search" viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5S14 7.01 14 9.5S11.99 14 9.5 14z" /></symbol>
    <symbol id="icon-save" viewBox="0 0 24 24"><path fill="currentColor" d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3s3 1.34 3 3s-1.34 3-3 3zm3-10H5V5h10v4z" /></symbol>
    <symbol id="icon-delete" viewBox="0 0 24 24"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" /></symbol>
    <symbol id="icon-sync" viewBox="0 0 24 24"><path fill="currentColor" d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6s-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8s-3.58-8-8-8z" /></symbol>
    <symbol id="icon-download" viewBox="0 0 24 24"><path fill="currentColor" d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" /></symbol>
    <symbol id="icon-edit" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83l3.75 3.75l1.83-1.83z" /></symbol>
    <symbol id="icon-sell" viewBox="0 0 24 24"><path fill="currentColor" d="M5 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm14-4H7v14h14v-2h-4v-2h4v-2h-4v-2h4V8h-4V6h4V4zM12.01 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM9 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" /></symbol>
    <symbol id="icon-chevron-left" viewBox="0 0 24 24"><path fill="currentColor" d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12l4.58-4.59z" /></symbol>
    <symbol id="icon-chevron-right" viewBox="0 0 24 24"><path fill="currentColor" d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12l-4.58 4.59z" /></symbol>
    <symbol id="icon-today" viewBox="0 0 24 24"><path fill="currentColor" d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V9h14v10zM5 7V5h14v2H5zm5 5h4v4h-4z" /></symbol>
    <symbol id="icon-export" viewBox="0 0 24 24"><path fill="currentColor" d="M18 15v3H6v-3H4v3c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-3h-2zM7 9l1.41 1.41L11 7.83V16h2V7.83l2.59 2.58L17 9l-5-5l-5 5z" /></symbol>
    <symbol id="icon-file-csv" viewBox="0 0 24 24"><path fill="currentColor" d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6zm2-8h1.5v1.5h-1.5V12zm0-3h1.5v1.5h-1.5V9zm0 6h1.5v1.5h-1.5V15zm3-6h1.5v1.5h-1.5V9zm0 3h1.5v1.5h-1.5V12zm0 3h1.5v1.5h-1.5V15zm3-6h1.5v1.5h-1.5V9zm0 3h1.5v1.5h-1.5V12z" /></symbol>
    <symbol id="icon-file-pdf" viewBox="0 0 24 24"><path fill="currentColor" d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM9.5 18H8v-5h1.5v5zm3-2.5c0 .83-.67 1.5-1.5 1.5H10v-5h1.5c.83 0 1.5.67 1.5 1.5v2zm4-2.5h-1.5v5H15v-1.5h1.5v-1h-1.5v-1h1.5V13zm-2-6.5V4h7v5h-7z" /></symbol>
    <symbol id="icon-whatsapp" viewBox="0 0 24 24"><path fill="currentColor" d="M19.1 4.9C17 2.8 14.6 1.8 12 1.8c-5.5 0-9.9 4.4-9.9 9.9c0 1.8.5 3.5 1.4 5l-1.5 5.5l5.6-1.5c1.4.8 3 1.3 4.8 1.3h.1c5.5 0 9.9-4.4 9.9-9.9c0-2.6-1-5-2.8-6.9zm-7.1 14.8c-1.6 0-3.1-.4-4.4-1.2l-.3-.2l-3.3.9l.9-3.2l-.2-.3c-.8-1.3-1.3-2.9-1.3-4.5c0-4.3 3.5-7.8 7.8-7.8s7.8 3.5 7.8 7.8c0 4.3-3.5 7.8-7.8 7.8zm4.4-5.9c-.2-.1-1.4-.7-1.6-.8c-.2-.1-.4-.1-.6.1c-.2.2-.6.7-.8.9c-.1.1-.3.2-.6.1c-.3-.1-1.1-.4-2.2-1.3c-.8-.7-1.4-1.6-1.6-1.9c-.2-.3 0-.4.1-.5c.1-.1.2-.2.4-.3c.1-.1.2-.2.2-.4c.1-.1.1-.3 0-.4c0-.1-.6-1.4-.8-1.9c-.2-.5-.4-.4-.6-.4h-.5c-.2 0-.4.1-.6.3c-.2.2-.8.8-.8 1.9c0 1.1.8 2.2 1 2.4c.1.2 1.6 2.5 4 3.5c.6.2 1 .4 1.4.5c.6.2 1.1.1 1.5-.1c.5-.2 1.4-.6 1.6-1.1c.2-.5.2-.9.1-1z" /></symbol>
  </svg>

  <!-- App Loader -->
  <div class="app-loader" id="app-loader">
    <div class="spinner"></div>
    <h2 id="app-loader-title">Bike Manager</h2>
    <p class="text-secondary" id="app-loader-status">Loading application...</p>
  </div>

  <!-- Main App Container -->
  <div class="app-container" id="app-container">

    <!-- Navigation -->
    <nav class="app-bottom-nav" id="app-nav" role="navigation" aria-label="Main navigation">
      <button class="nav-btn active" data-view="view-list" aria-label="Bikes list">
        <svg><use href="#icon-list"></use></svg>
        <span>Bikes</span>
      </button>
      <button class="nav-btn" data-view="view-stats" aria-label="Statistics and analytics">
        <svg><use href="#icon-chart"></use></svg>
        <span>Stats</span>
      </button>
      <button class="nav-btn" data-view="view-settings" aria-label="Settings">
        <svg><use href="#icon-settings"></use></svg>
        <span>Settings</span>
      </button>
    </nav>

    <!-- Content Wrapper (for desktop) -->
    <div class="app-content-wrapper">

      <!-- App Header -->
      <header class="app-header">
        <h1 id="header-title">Bike Manager</h1>
        <div id="sync-status" class="sync-status" role="status" aria-live="polite">
          <div class="status-dot"></div>
          <span id="sync-status-text">Offline</span>
        </div>
        <button class="btn-icon btn-ghost" id="sync-now-btn" title="Sync Now" aria-label="Sync now">
          <svg><use href="#icon-sync"></use></svg>
        </button>
      </header>

      <main class="app-main" role="main">

        <!-- =================== -->
        <!-- LIST VIEW           -->
        <!-- =================== -->
        <section id="view-list" class="view active">

          <!-- New 8-Card Stats Grid -->
          <h3 class="text-secondary font-semibold text-sm mb-2">STATS DASHBOARD</h3>
          <div class="stats-grid-8 mb-4" id="stats-grid-8">
            <!-- Row 1 - This Month -->
            <div class="stat-card">
              <div class="stat-card-title">Month Profit</div>
              <div class="stat-card-value" id="stat-month-profit">â‚¹0</div>
              <div class="stat-card-context" id="stat-month-profit-context">-- vs last month</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-title">Month Unsold</div>
              <div class="stat-card-value" id="stat-month-unsold">0</div>
              <div class="stat-card-context" id="stat-month-unsold-value">â‚¹0 locked</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-title">Month Sold</div>
              <div class="stat-card-value" id="stat-month-sold">0</div>
              <div class="stat-card-context" id="stat-month-sold-value">â‚¹0 revenue</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-title">Month ROI</div>
              <div class="stat-card-value" id="stat-month-roi">0%</div>
              <div class="stat-card-context">--</div>
            </div>
            <!-- Row 2 - All-Time -->
            <div class="stat-card">
              <div class="stat-card-title">Total Profit</div>
              <div class="stat-card-value small" id="stat-total-profit">â‚¹0</div>
              <div class="stat-card-context">(lifetime)</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-title">Total Unsold</div>
              <div class="stat-card-value small" id="stat-total-unsold">â‚¹0</div>
              <div class="stat-card-context" id="stat-total-unsold-count">(0 bikes)</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-title">Avg Profit/Sale</div>
              <div class="stat-card-value small" id="stat-avg-profit">â‚¹0</div>
              <div class="stat-card-context" id="stat-avg-margin">(0% margin)</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-title">Avg Days to Sell</div>
              <div class="stat-card-value small" id="stat-avg-days">0</div>
              <div class="stat-card-context">(lifetime)</div>
            </div>
          </div>

          <!-- Month Navigator -->
          <div class="month-navigator">
            <button class="btn-icon btn-ghost" id="month-prev" aria-label="Previous month">
              <svg><use href="#icon-chevron-left"></use></svg>
            </button>
            <h2 id="month-current-display">Loading...</h2>
            <div>
              <button class="btn-icon btn-ghost" id="month-today" aria-label="Go to current month">
                <svg><use href="#icon-today"></use></svg>
              </button>
              <button class="btn-icon btn-ghost" id="month-next" aria-label="Next month">
                <svg><use href="#icon-chevron-right"></use></svg>
              </button>
            </div>
          </div>

          <!-- Add Bike Button -->
          <button class="btn btn-primary w-full mb-4" id="add-bike-btn">
            <svg width="20" height="20"><use href="#icon-add"></use></svg>
            <span>Add New Bike</span>
          </button>

          <!-- View Toggle -->
          <div class="view-toggle" role="group" aria-label="Data view range">
            <button class="chip active" id="view-toggle-month" data-view="this-month" role="radio" aria-checked="true">This Month</button>
            <button class="chip" id="view-toggle-3month" data-view="last-3-months" role="radio" aria-checked="false">Last 3 Months</button>
          </div>

          <!-- Search and Filter Bar -->
          <div class="filter-bar">
            <input type="search" class="form-input" id="search-input" placeholder="Search plate, owner, or model..." aria-label="Search bikes" />
          </div>

          <!-- Status Filter Chips -->
          <div class="filter-chips" role="group" aria-label="Filter bikes by status">
            <button class="chip active" id="filter-all" data-filter="all" role="radio" aria-checked="true">All</button>
            <button class="chip" id="filter-sold" data-filter="sold" role="radio" aria-checked="false">Sold</button>
            <button class="chip" id="filter-unsold" data-filter="unsold" role="radio" aria-checked="false">Unsold</button>
            <button class="chip" id="filter-aging" data-filter="aging" role="radio" aria-checked="false">ðŸ”´ Aging (60+d)</button>
          </div>

          <!-- Bike List container -->
          <div class="bike-list-skeleton" id="bike-list-skeleton">
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
          </div>
          <div class="bike-list" id="bike-list" role="list">
            <!-- Bike cards will be injected here by JS -->
          </div>

          <!-- Empty State -->
          <div id="bike-list-empty" class="empty-state hidden">
            <svg><use href="#icon-list"></use></svg>
            <h3>No Bikes Found</h3>
            <p>Tap 'Add New Bike' to get started.</p>
          </div>

        </section>

        <!-- =================== -->
        <!-- STATS VIEW          -->
        <!-- =================== -->
        <section id="view-stats" class="view">
          <div class="flex justify-between items-center mb-4">
            <h2>Analytics Dashboard</h2>
            <button class="btn btn-secondary btn-sm" id="analytics-load-all">
              <svg width="16" height="16"><use href="#icon-sync"></use></svg>
              <span>Load Full History</span>
            </button>
          </div>
          <p class="text-secondary mb-2" id="analytics-data-range">Showing analytics for last 3 months.</p>

          <!-- Key Insights -->
          <div class="mb-4">
            <h3 class="text-secondary font-semibold text-sm mb-2">ðŸ’¡ KEY INSIGHTS</h3>
            <div class="key-insight-card">
              <p id="key-insight-text">Loading insights...</p>
            </div>
          </div>

          <!-- 3-Tab Navigation -->
          <nav class="tabs-nav" id="analytics-tabs-nav">
            <button class="tab-btn active" data-tab="tab-financial">Financials</button>
            <button class="tab-btn" data-tab="tab-inventory">Inventory</button>
            <button class="tab-btn" data-tab="tab-insights">Performance</button>
          </nav>

          <!-- Tab Content -->
          <div id="analytics-tabs-content">
            <!-- Tab 1: Financial Analytics -->
            <div class="tab-content active" id="tab-financial">
              <div class="stats-grid-8 mb-4">
                <div class="stat-card">
                  <div class="stat-card-title">Total Profit</div>
                  <div class="stat-card-value" id="stat-fin-total-profit">â‚¹0</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-title">This Month Profit</div>
                  <div class="stat-card-value" id="stat-fin-month-profit">â‚¹0</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-title">Average Profit/Sale</div>
                  <div class="stat-card-value" id="stat-fin-avg-profit">â‚¹0</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-title">Best Month</div>
                  <div class="stat-card-value small" id="stat-fin-best-month">--</div>
                </div>
              </div>

              <div class="chart-container card">
                <h3>Monthly Profit Trend</h3>
                <canvas id="chart-profit-trend" role="img" aria-label="Monthly profit trend chart"></canvas>
              </div>
              <div class="chart-container card">
                <h3>Profit Distribution</h3>
                <canvas id="chart-profit-dist" role="img" aria-label="Profit distribution bar chart"></canvas>
              </div>
              <div class="chart-container card">
                <h3>Category Performance (By Source)</h3>
                <canvas id="chart-category-source" role="img" aria-label="Profit by source bar chart"></canvas>
              </div>
            </div>

            <!-- Tab 2: Inventory Intelligence -->
            <div class="tab-content" id="tab-inventory">
              <div class="stats-grid-8 mb-4">
                <div class="stat-card">
                  <div class="stat-card-title">Capital Locked</div>
                  <div class="stat-card-value" id="stat-inv-locked">â‚¹0</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-title">Unsold Bikes</div>
                  <div class="stat-card-value" id="stat-inv-unsold-count">0</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-title">Avg Time to Sell</div>
                  <div class="stat-card-value" id="stat-inv-avg-days">0 days</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-title">Inventory Turnover</div>
                  <div class="stat-card-value" id="stat-inv-turnover">0x</div>
                </div>
              </div>
              <div class="chart-container card">
                <h3>Aging Inventory</h3>
                <canvas id="chart-aging" role="img" aria-label="Aging inventory donut chart"></canvas>
              </div>
              <div class="card mt-2">
                <h3>ðŸ”´ Action Required (60+ Days Unsold)</h3>
                <ul id="list-aging-bikes" class="text-secondary">
                  <li>Loading...</li>
                </ul>
              </div>
            </div>

            <!-- Tab 3: Performance Insights -->
            <div class="tab-content" id="tab-insights">
              <div class="card mb-2">
                <h3>ðŸ¥‡ Top 5 Profitable Bikes</h3>
                <ul id="list-top-bikes" class="text-secondary"><li>Loading...</li></ul>
              </div>
              <div class="card mb-2">
                <h3>ðŸ”» Bottom 5 Performers</h3>
                <ul id="list-bottom-bikes" class="text-secondary"><li>Loading...</li></ul>
              </div>
              <div class="card mb-2">
                <h3>ðŸ“ˆ Best Source</h3>
                <p id="insight-best-source" class="text-lg font-bold text-accent-1">Loading...</p>
              </div>
              <div class="card mb-2">
                <h3>ðŸ“Š Sweet Spot (Model)</h3>
                <p id="insight-best-model" class="text-lg font-bold text-accent-1">Loading...</p>
              </div>
            </div>
          </div>
          
          <div id="stats-empty" class="empty-state hidden">
            <svg><use href="#icon-chart"></use></svg>
            <h3>No Data for Analytics</h3>
            <p>Add and sell bikes to see your stats.</p>
          </div>

        </section>

        <!-- =================== -->
        <!-- SETTINGS VIEW       -->
        <!-- =================== -->
        <section id="view-settings" class="view">
          <h2>Settings</h2>

          <!-- Gist Config -->
          <div class="settings-section">
            <h3>Gist Sync Configuration</h3>
            <p>Syncs your data to a private GitHub Gist. Get your Gist ID from the Gist URL.</p>

            <div class="form-group">
              <label for="setting-gist-id">Gist ID *</label>
              <input type="text" class="form-input" id="setting-gist-id" placeholder="e.g., a1b2c3d4e5f6a7b8c9d0" />
            </div>
            <div class="form-group">
              <label for="setting-github-pat">GitHub Personal Access Token (PAT) *</label>
              <input type="password" class="form-input" id="setting-github-pat" placeholder="ghp_... (stored in session)" autocomplete="password" />
              <p class="text-secondary" style="font-size: 0.8rem; margin-top: 6px;">
                Requires `gist` scope. Stored in session storage (cleared on browser close).
              </p>
            </div>
            <div class="form-group">
              <label for="setting-auto-sync">Auto-sync Timer</label>
              <select class="form-select" id="setting-auto-sync">
                <option value="0">Off (Manual Sync Only)</option>
                <option value="3">Every 3 minutes</option>
                <option value="5">Every 5 minutes</option>
                <option value="10">Every 10 minutes</option>
              </select>
            </div>
            <button class="btn btn-secondary" id="save-sync-settings">
              <svg width="20" height="20"><use href="#icon-save"></use></svg>
              <span>Save Sync Settings</span>
            </button>
          </div>

          <!-- App Settings -->
          <div class="settings-section">
            <h3>App Settings</h3>
            <!-- Theme Toggle -->
            <div class="theme-toggle">
              <label for="theme-switch-label">Dark Mode</label>
              <div class="switch active" id="theme-switch" role="switch" aria-checked="true" tabindex="0" aria-labelledby="theme-switch-label"></div>
            </div>
            <!-- Currency -->
            <div class="form-group">
              <label for="setting-currency">Currency Symbol</label>
              <input type="text" class="form-input" id="setting-currency" placeholder="â‚¹" style="width: 100px;" />
            </div>
            <!-- Default Margin -->
            <div class="form-group">
              <label for="setting-default-margin">Default Margin (%)</label>
              <input type="number" class="form-input" id="setting-default-margin" placeholder="15" style="width: 100px;" />
            </div>
            <button class="btn btn-secondary" id="save-app-settings">Save App Settings</button>
          </div>
          
          <!-- Data Management -->
          <div class="settings-section">
            <h3>Export & Reporting</h3>
            <p>Export your data or generate reports.</p>
            <button class="btn btn-primary w-full" id="export-btn">
              <svg width="20" height="20"><use href="#icon-export"></use></svg>
              <span>Export & Reports...</span>
            </button>
            <h4 class="mt-2">Data Cache</h4>
            <p>Your data is cached in this browser. Clearing it will force a re-download from your Gist.</p>
            <button class="btn btn-danger" id="wipe-local-cache-btn">
              <svg width="16" height="16"><use href="#icon-delete"></use></svg>
              <span>Wipe Local Cache</span>
            </button>
          </div>

        </section>

      </main>
    </div>
  </div>

  <!-- =================== -->
  <!-- MODALS              -->
  <!-- =================== -->

  <!-- Form Modal (Add/Edit Bike) -->
  <div class="modal-overlay bottom-sheet" id="form-modal" role="dialog" aria-labelledby="form-title" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="form-title">Add New Bike</h2>
        <button class="btn-icon btn-ghost" id="close-form-modal" aria-label="Close">
          <svg><use href="#icon-close"></use></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="bike-form" onsubmit="return false;">
          <input type="hidden" id="form-bike-id" />
          
          <!-- Quick Add Section -->
          <div id="form-quick-add">
            <div class="form-group">
              <label for="form-plate">Bike Number (Plate) *</label>
              <input type="text" class="form-input" id="form-plate" placeholder="GJ01AB1234" required aria-required="true" />
            </div>
            <div class="form-group">
              <label for="form-owner">Owner Name *</label>
              <input type="text" class="form-input" id="form-owner" required aria-required="true" />
            </div>
            <div class="form-group">
              <label for="form-purchasePrice">Purchase Price *</label>
              <input type="number" class="form-input" id="form-purchasePrice" placeholder="0" step="1" inputmode="numeric" required aria-required="true" />
            </div>
          </div>
          
          <!-- Full Add Section (Initially hidden) -->
          <div id="form-full-add" class="hidden">
            <div class="form-section-divider"></div>
            <div class="form-group">
              <label for="form-model">Model</label>
              <input type="text" class="form-input" id="form-model" placeholder="e.g., Hero Splendor" />
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label for="form-datePurchase">Purchase Date</label>
                <input type="date" class="form-input" id="form-datePurchase" />
              </div>
               <div class="form-group">
                <label for="form-source">Source</label>
                <select class="form-select" id="form-source">
                  <option value="Direct Owner">Direct Owner</option>
                  <option value="Dealer">Dealer</option>
                  <option value="Auction">Auction</option>
                  <option value="Trade-in">Trade-in</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label for="form-repairCost">Repair Cost</label>
                <input type="number" class="form-input" id="form-repairCost" placeholder="0" step="1" inputmode="numeric" />
              </div>
              <div class="form-group">
                <label for="form-otherExpenses">Other Expenses</label>
                <input type="number" class="form-input" id="form-otherExpenses" placeholder="0" step="1" inputmode="numeric" />
              </div>
            </div>
            <div class="form-group">
              <label for="form-notes">Notes (max 200 chars)</label>
              <textarea id="form-notes" class="form-textarea" placeholder="e.g., Good condition, new tires" maxlength="200"></textarea>
            </div>
            <div class="form-section-divider"></div>
          </div>

          <!-- Sold Section (Hidden on new) -->
          <div id="form-section-sold" class="hidden">
             <h3 class="text-lg font-bold text-success mb-2">Sold Details</h3>
             <div class="form-grid">
                <div class="form-group">
                  <label for="form-dateSelling">Selling Date</label>
                  <input type="date" class="form-input" id="form-dateSelling" />
                </div>
                <div class="form-group">
                  <label for="form-sellingPrice">Selling Price</label>
                  <input type="number" class="form-input" id="form-sellingPrice" placeholder="0" step="1" inputmode="numeric" />
                </div>
             </div>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="delete-bike-btn" style="margin-right: auto;" class="hidden">
          <svg width="20" height="20"><use href="#icon-delete"></use></svg>
        </button>
        <button class="btn btn-secondary" id="toggle-full-form-btn" data-mode="quick">Show Full Form</button>
        <button class="btn btn-primary" id="save-form-btn">
          <svg width="20" height="20"><use href="#icon-save"></use></svg>
          <span id="save-form-btn-text">Save Bike</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Mark Sold Modal -->
  <div class="modal-overlay bottom-sheet" id="sold-modal" role="dialog" aria-labelledby="sold-title" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="sold-title">Mark Bike as Sold</h2>
        <button class="btn-icon btn-ghost" id="close-sold-modal" aria-label="Close">
          <svg><use href="#icon-close"></use></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="sold-form" onsubmit="return false;">
          <input type="hidden" id="sold-bike-id" />
          <p class="mb-4 text-secondary">Enter the selling price and date for <strong id="sold-bike-plate" class="text-primary"></strong>.</p>
          <div class="form-group">
            <label for="sold-sellingPrice">Selling Price *</label>
            <input type="number" class="form-input" id="sold-sellingPrice" placeholder="0" step="1" inputmode="numeric" required />
          </div>
          <div class="form-group">
            <label for="sold-dateSelling">Selling Date *</label>
            <input type="date" class="form-input" id="sold-dateSelling" required />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancel-sold-btn">Cancel</button>
        <button class="btn btn-primary" id="save-sold-btn">
          <svg width="20" height="20"><use href="#icon-save"></use></svg>
          <span>Save Sale</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal-overlay bottom-sheet" id="export-modal" role="dialog" aria-labelledby="export-title" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="export-title">Export & Reports</h2>
        <button class="btn-icon btn-ghost" id="close-export-modal" aria-label="Close">
          <svg><use href="#icon-close"></use></svg>
        </button>
      </div>
      <div class="modal-body">
        <p class="text-secondary mb-4">Choose an export option.</p>
        <div class="flex flex-col gap-3">
          <button class="btn btn-secondary w-full" id="export-csv-view">
            <svg width="20" height="20"><use href="#icon-file-csv"></use></svg>
            <span>Export Current View (CSV)</span>
          </button>
          <button class="btn btn-secondary w-full" id="export-csv-month">
            <svg width="20" height="20"><use href="#icon-file-csv"></use></svg>
            <span>Export This Month (CSV)</span>
          </button>
          <button class="btn btn-secondary w-full" id="export-csv-all">
            <svg width="20" height="20"><use href="#icon-file-csv"></use></svg>
            <span>Export All Data (CSV)</span>
          </button>
          <div class="form-section-divider"></div>
          <button class="btn btn-secondary w-full" id="export-pdf-month">
            <svg width="20" height="20"><use href="#icon-file-pdf"></use></svg>
            <span>Generate Monthly Report (PDF)</span>
          </button>
          <div class="form-section-divider"></div>
          <button class="btn btn-secondary w-full" id="export-whatsapp">
            <svg width="20" height="20"><use href="#icon-whatsapp"></use></svg>
            <span>Share Month Summary (WhatsApp)</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal-overlay" id="confirm-modal" role="dialog" aria-labelledby="confirm-title" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="confirm-title">Are you sure?</h2>
      </div>
      <div class="modal-body">
        <p id="confirm-message" class="text-secondary">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="confirm-cancel">Cancel</button>
        <button class="btn btn-danger" id="confirm-ok">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container" role="region" aria-live="polite" aria-label="Notifications"></div>

  <!-- Inline Application JavaScript -->
  <script>
    // --- APP CONSTANTS ---
    const METADATA_FILENAME = 'bikes_metadata.json';
    const SETTINGS_KEY = 'bike_manager_settings_v8';
    const CACHE_KEY = 'bike_manager_cache_v8';
    const PAT_KEY = 'bike_manager_pat_v8';
    const THEME_KEY = 'bike_manager_theme_v8';
    const SYNC_DEBOUNCE_MS = 10000; // 10 seconds

    /**
     * @class BikeManagerApp
     * Main application class v8.0 (Gist Edition)
     */
    class BikeManagerApp {

      constructor() {
        // --- Core State ---
        this.settings = {
          gistId: '',
          githubPat: '', // Session-only
          theme: 'dark',
          currency: 'â‚¹',
          defaultMargin: 15,
          autoSyncInterval: 0, // 0 = off
        };
        this.syncState = {
          status: 'offline', // 'synced' | 'syncing' | 'offline' | 'error'
          lastSyncTime: null,
          pendingChanges: {}, // { '2024-11': true, 'metadata': true }
        };
        this.appState = {
          currentMonthView: this.getYearMonthString(new Date()), // e.g., '2024-11'
          currentDataView: 'this-month', // 'this-month' | 'last-3-months'
          availableMonths: [],
          allBikes: [], // Used for analytics
          isAllDataLoaded: false,
        };
        this.localCache = {}; // { '2024-11': { month: '2024-11', bikes: [...] } }
        this.charts = {};
        this.autoSyncTimer = null;
        this.isOnline = navigator.onLine;

        // Debounced functions
        this.debouncedSync = this.debounce(() => this.syncChanges(), SYNC_DEBOUNCE_MS);
        this.debouncedRenderList = this.debounce(() => this.renderBikeList(), 100);

        // DOM element cache
        this.dom = {
          loader: document.getElementById('app-loader'),
          loaderStatus: document.getElementById('app-loader-status'),
          headerTitle: document.getElementById('header-title'),
          views: document.querySelectorAll('.view'),
          navButtons: document.querySelectorAll('.nav-btn'),
          syncStatus: document.getElementById('sync-status'),
          syncStatusText: document.getElementById('sync-status-text'),
          // ... (add other critical elements as needed)
        };
        
        // Ensure jsPDF is available
        if (window.jspdf) {
            this.jsPDF = window.jspdf.jsPDF;
            this.autoTable = window.jspdf.plugin.autotable;
        } else {
            console.error("jsPDF or jsPDF-AutoTable not loaded!");
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', () => this.init());
      }

      /**
       * Primary initialization function.
       */
      async init() {
        try {
          console.log('Starting initialization v8.0 (Gist Edition)...');
          this.updateLoaderStatus('Loading settings...');
          this.loadSettings();
          this.applyTheme();

          this.updateLoaderStatus('Initializing UI listeners...');
          this.initEventListeners();
          
          this.updateLoaderStatus('Loading cached data...');
          this.loadCacheFromLocalStorage();

          this.updateLoaderStatus('Connecting to Gist...');
          await this.initialLoad();

        } catch (error) {
          console.error("Critical initialization failed:", error);
          this.updateLoaderStatus("Error: " + error.message);
          this.setSyncStatus('error', error.message);
          // Even on fail, try to render from cache
          await this.renderAll(); 
        } finally {
          this.dom.loader.classList.add('hidden');
          console.log('Initialization complete!');
        }
      }

      updateLoaderStatus(text) {
        console.log('Status:', text);
        this.dom.loaderStatus.textContent = text;
      }

      /**
       * The main data loading sequence on app start.
       */
      async initialLoad() {
        if (!this.settings.gistId || !this.settings.githubPat) {
          this.setSyncStatus('offline', 'Gist ID or PAT missing');
          this.showToast('Go to Settings to enter Gist ID and PAT', 'warning');
          await this.renderAll(); // Render empty state
          return;
        }
        
        if (!this.isOnline) {
          this.setSyncStatus('offline', 'No internet connection');
          this.showToast('Offline. Showing cached data.', 'info');
          await this.renderAll(); // Render from cache
          return;
        }

        this.setSyncStatus('syncing', 'Loading metadata...');
        const metadata = await this.loadMetadata();
        
        if (metadata) {
          this.appState.availableMonths = metadata.availableMonths || [this.appState.currentMonthView];
          this.appState.currentMonthView = metadata.currentMonth || this.appState.currentMonthView;
          
          // Load current and previous month
          this.setSyncStatus('syncing', `Loading ${this.appState.currentMonthView}...`);
          await this.loadMonth(this.appState.currentMonthView);
          
          const prevMonth = this.getRelativeMonth(this.appState.currentMonthView, -1);
          if (this.appState.availableMonths.includes(prevMonth)) {
            this.setSyncStatus('syncing', `Loading ${prevMonth}...`);
            await this.loadMonth(prevMonth);
          }

          this.setSyncStatus('synced', 'Data loaded');
          this.syncState.lastSyncTime = new Date();
        } else {
          // No metadata, probably a new Gist.
          this.setSyncStatus('syncing', 'Creating new inventory...');
          await this.createInitialMetadata();
          this.setSyncStatus('synced', 'Inventory created');
        }
        
        // Render everything with the new data
        await this.renderAll();
      }

      // --- 2. SETTINGS & THEME ---

      loadSettings() {
        // Load settings from localStorage
        const savedSettings = localStorage.getItem(SETTINGS_KEY);
        if (savedSettings) {
          this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
        }
        // Load PAT from session storage
        const savedPat = sessionStorage.getItem(PAT_KEY);
        if (savedPat) {
          this.settings.githubPat = savedPat;
        }
        // Load theme
        const savedTheme = localStorage.getItem(THEME_KEY);
        this.settings.theme = savedTheme || 'dark';

        this.startAutoSync(); // Start timer based on loaded settings
      }
      
      saveSettings() {
        const { githubPat, ...settingsToSave } = this.settings;
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settingsToSave));
        localStorage.setItem(THEME_KEY, this.settings.theme);
        // PAT is saved to session storage separately
        if (this.settings.githubPat) {
          sessionStorage.setItem(PAT_KEY, this.settings.githubPat);
        }
        this.startAutoSync(); // Restart timer with new interval
        this.showToast('Settings saved', 'success');
      }

      applyTheme() {
        if (this.settings.theme === 'light') {
          document.documentElement.classList.remove('dark');
          document.documentElement.classList.add('theme-light');
          document.getElementById('theme-switch').classList.remove('active');
        } else {
          document.documentElement.classList.add('dark');
          document.documentElement.classList.remove('theme-light');
          document.getElementById('theme-switch').classList.add('active');
        }
        // Update Chart.js defaults for new theme
        if (window.Chart) {
            const isDark = this.settings.theme === 'dark';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)';
            const textColor = isDark ? '#9fb0c2' : '#4a5a70';
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
        }
      }
      
      toggleTheme() {
        this.settings.theme = (this.settings.theme === 'dark') ? 'light' : 'dark';
        this.applyTheme();
        this.saveSettings();
        // Re-render stats if active
        if (this.currentView === 'view-stats') {
            this.renderAnalyticsDashboard(false); // Don't re-fetch, just re-draw
        }
      }
      
      updateSettingsUI() {
        document.getElementById('setting-gist-id').value = this.settings.gistId;
        document.getElementById('setting-github-pat').value = this.settings.githubPat;
        document.getElementById('setting-auto-sync').value = this.settings.autoSyncInterval;
        document.getElementById('setting-currency').value = this.settings.currency;
        document.getElementById('setting-default-margin').value = this.settings.defaultMargin;
      }

      // --- 3. CACHE MANAGEMENT ---

      loadCacheFromLocalStorage() {
        const cachedData = localStorage.getItem(CACHE_KEY);
        if (cachedData) {
          this.localCache = JSON.parse(cachedData);
        }
      }

      saveCacheToLocalStorage() {
        localStorage.setItem(CACHE_KEY, JSON.stringify(this.localCache));
      }
      
      clearLocalCache() {
         this.showConfirmModal(
          'Clear Local Cache?',
          'This will clear all locally cached bike data. The app will re-download from your Gist on next load.',
          () => {
            localStorage.removeItem(CACHE_KEY);
            this.localCache = {};
            this.appState.allBikes = [];
            this.appState.isAllDataLoaded = false;
            this.showToast('Local cache cleared.', 'success');
            this.renderAll();
          }
        );
      }
      
      /**
       * Gets all bike data for the current view.
       * @returns {Array} An array of bike objects.
       */
      getDataForView() {
        if (this.appState.currentDataView === 'this-month') {
          return this.localCache[this.appState.currentMonthView]?.bikes || [];
        } else {
          // 'last-3-months'
          let bikes = [];
          const m1 = this.appState.currentMonthView;
          const m2 = this.getRelativeMonth(m1, -1);
          const m3 = this.getRelativeMonth(m1, -2);
          
          if (this.localCache[m1]) bikes = bikes.concat(this.localCache[m1].bikes);
          if (this.localCache[m2]) bikes = bikes.concat(this.localCache[m2].bikes);
          if (this.localCache[m3]) bikes = bikes.concat(this.localCache[m3].bikes);
          
          return bikes;
        }
      }
      
      /**
       * Gets a flat array of all bikes from the cache.
       * @returns {Array} All bike objects.
       */
      getAllBikesFromCache() {
        let allBikes = [];
        for (const month of this.appState.availableMonths) {
            if (this.localCache[month] && this.localCache[month].bikes) {
                allBikes = allBikes.concat(this.localCache[month].bikes);
            }
        }
        return allBikes;
      }

      // --- 4. GIST SYNC & API ---

      setSyncStatus(status, message = '') {
        this.syncState.status = status;
        const statusEl = this.dom.syncStatus;
        const textEl = this.dom.syncStatusText;
        if (!statusEl || !textEl) return;
        
        // Remove old classes
        statusEl.classList.remove('success', 'syncing', 'error', 'offline');
        
        switch (status) {
          case 'synced':
            statusEl.classList.add('success');
            const time = this.syncState.lastSyncTime 
                ? `Synced ${this.timeAgo(this.syncState.lastSyncTime)}` 
                : 'Synced';
            textEl.textContent = message || time;
            break;
          case 'syncing':
            statusEl.classList.add('syncing');
            textEl.textContent = message || 'Syncing...';
            break;
          case 'error':
            statusEl.classList.add('error');
            textEl.textContent = message || 'Sync Error';
            break;
          case 'offline':
          default:
            statusEl.classList.add('offline');
            textEl.textContent = message || 'Offline';
            break;
        }
      }
      
      startAutoSync() {
        if (this.autoSyncTimer) clearInterval(this.autoSyncTimer);
        const interval = parseInt(this.settings.autoSyncInterval, 10);
        if (interval > 0) {
          this.autoSyncTimer = setInterval(() => {
            console.log('Auto-sync triggered...');
            this.syncChanges();
          }, interval * 60 * 1000);
        }
      }

      /**
       * Generic GitHub Gist API fetch helper.
       */
      async githubApi(endpoint, method = 'GET', body = null) {
        if (!this.settings.gistId || !this.settings.githubPat) {
          throw new Error('Gist ID or PAT is not set.');
        }
        if (!this.isOnline) {
          throw new Error('Offline. Cannot connect to GitHub.');
        }

        const url = `https://api.github.com/gists/${this.settings.gistId}${endpoint ? '/' + endpoint : ''}`;
        
        const headers = {
          'Accept': 'application/vnd.github.v3+json',
          'Authorization': `token ${this.settings.githubPat}`,
          'X-GitHub-Api-Version': '2022-11-28',
        };

        const options = {
          method,
          headers,
        };

        if (body) {
          options.body = JSON.stringify(body);
        }

        try {
          const response = await fetch(url, options);
          if (response.status === 404) {
             throw new Error('Gist not found. Check Gist ID.');
          }
          if (response.status === 401) {
             throw new Error('Invalid GitHub PAT. Check token.');
          }
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(`GitHub API error: ${response.status} ${errorData.message || 'Unknown error'}`);
          }
          if (response.status === 204) return null; // No content, e.g., on successful PATCH
          return await response.json();
        } catch (e) {
          console.error('githubApi error:', e);
          this.setSyncStatus('error', e.message);
          throw e; // Re-throw to be caught by callers
        }
      }
      
      async loadMetadata() {
        try {
          const gist = await this.githubApi('');
          const metadataFile = gist.files[METADATA_FILENAME];
          
          if (!metadataFile) {
            console.warn('bikes_metadata.json not found in Gist.');
            return null; // Will trigger creation
          }
          
          const metadata = JSON.parse(metadataFile.content);
          // Update local settings from metadata (Gist is source of truth for these)
          this.settings.defaultMargin = metadata.settings.defaultMargin || 15;
          // Don't overwrite Gist ID/PAT
          this.saveSettings();
          
          console.log('Metadata loaded:', metadata);
          return metadata;
        } catch (error) {
          console.error('Failed to load metadata:', error);
          throw new Error(`Failed to load metadata: ${error.message}`);
        }
      }
      
      async createInitialMetadata() {
        console.log('Creating initial metadata file...');
        const currentMonth = this.getYearMonthString(new Date());
        const metadata = {
          version: "1.0",
          lastUpdated: new Date().toISOString(),
          currentMonth: currentMonth,
          availableMonths: [currentMonth],
          settings: {
            gistId: this.settings.gistId,
            defaultMargin: this.settings.defaultMargin,
          }
        };
        
        const monthData = {
          month: currentMonth,
          bikes: []
        };
        
        const filesToUpdate = {
          [METADATA_FILENAME]: { content: JSON.stringify(metadata, null, 2) },
          [`bikes_${currentMonth}.json`]: { content: JSON.stringify(monthData, null, 2) }
        };

        try {
          await this.githubApi('', 'PATCH', {
            description: "Bike Inventory Data",
            files: filesToUpdate
          });
          this.appState.availableMonths = [currentMonth];
          this.localCache[currentMonth] = monthData;
          this.saveCacheToLocalStorage();
        } catch (error) {
           console.error('Failed to create initial Gist files:', error);
           throw new Error(`Failed to create inventory: ${error.message}`);
        }
      }

      async loadMonth(monthString) {
        // 1. Check if already in cache
        if (this.localCache[monthString]) {
          console.log(`Loading ${monthString} from cache.`);
          return this.localCache[monthString];
        }
        
        // 2. If not, fetch from Gist
        console.log(`Fetching ${monthString} from Gist...`);
        this.setSyncStatus('syncing', `Loading ${monthString}...`);
        
        try {
            const gist = await this.githubApi('');
            const monthFilename = `bikes_${monthString}.json`;
            const monthFile = gist.files[monthFilename];
            
            if (!monthFile) {
                console.warn(`${monthFilename} not found in Gist.`);
                // Create an empty placeholder in cache so we don't re-fetch
                this.localCache[monthString] = { month: monthString, bikes: [] };
                this.saveCacheToLocalStorage();
                return this.localCache[monthString];
            }
            
            const monthData = JSON.parse(monthFile.content);
            this.localCache[monthString] = monthData;
            this.saveCacheToLocalStorage();
            console.log(`Loaded and cached ${monthString}.`);
            return monthData;
        } catch (error) {
            console.error(`Failed to load month ${monthString}:`, error);
            this.setSyncStatus('error', `Failed to load ${monthString}`);
            return null;
        }
      }

      /**
       * Manually trigger a sync.
       */
      async syncNow() {
        if (this.syncState.status === 'syncing') {
          this.showToast('Sync already in progress.', 'info');
          return;
        }
        // Clear any pending debounced sync
        if (this.debouncedSync.cancel) {
          this.debouncedSync.cancel();
        }
        await this.syncChanges();
      }
      
      /**
       * Batches all pending changes and PATCHes them to the Gist.
       */
      async syncChanges() {
        if (Object.keys(this.syncState.pendingChanges).length === 0) {
          console.log('No changes to sync.');
          return;
        }
        if (!this.isOnline) {
          this.showToast('Offline. Sync postponed.', 'warning');
          return;
        }
        
        this.setSyncStatus('syncing', 'Uploading changes...');
        
        const filesToUpdate = {};
        const updatedMetadata = {
            version: "1.0",
            lastUpdated: new Date().toISOString(),
            currentMonth: this.getYearMonthString(new Date()),
            availableMonths: this.appState.availableMonths,
            settings: {
              gistId: this.settings.gistId,
              defaultMargin: this.settings.defaultMargin,
            }
        };
        
        // Always update metadata
        filesToUpdate[METADATA_FILENAME] = { content: JSON.stringify(updatedMetadata, null, 2) };
        
        // Add all pending month files
        for (const monthString in this.syncState.pendingChanges) {
            if (monthString === 'metadata') continue;
            
            const monthData = this.localCache[monthString];
            if (monthData) {
                const filename = `bikes_${monthString}.json`;
                filesToUpdate[filename] = { content: JSON.stringify(monthData, null, 2) };
            }
        }
        
        try {
            await this.githubApi('', 'PATCH', { files: filesToUpdate });
            
            this.syncState.pendingChanges = {};
            this.syncState.lastSyncTime = new Date();
            this.setSyncStatus('synced', 'Changes saved');
            this.showToast('Changes synced to Gist', 'success');
        } catch (error) {
            console.error('Sync failed:', error);
            this.setSyncStatus('error', 'Sync failed');
            this.showToast(`Sync failed: ${error.message}`, 'error');
        }
      }

      // --- 5. UI & EVENT LISTENERS ---

      initEventListeners() {
        // Navigation
        this.dom.navButtons.forEach(btn => btn.addEventListener('click', () => this.navigateTo(btn.dataset.view)));
        this.dom.syncNowBtn.addEventListener('click', () => this.syncNow());

        // List View
        document.getElementById('add-bike-btn').addEventListener('click', () => this.handleNewBike());
        document.getElementById('month-prev').addEventListener('click', () => this.navigateMonth(-1));
        document.getElementById('month-next').addEventListener('click', () => this.navigateMonth(1));
        document.getElementById('month-today').addEventListener('click', () => this.navigateMonth(0));
        document.getElementById('view-toggle-month').addEventListener('click', () => this.setDataView('this-month'));
        document.getElementById('view-toggle-3month').addEventListener('click', () => this.setDataView('last-3-months'));
        document.getElementById('search-input').addEventListener('input', (e) => this.debouncedRenderList());
        document.querySelectorAll('.filter-chips .chip').forEach(chip => {
            chip.addEventListener('click', () => this.handleFilterClick(chip));
        });
        document.getElementById('bike-list').addEventListener('click', (e) => this.handleBikeListClick(e));

        // Stats View
        document.getElementById('analytics-load-all').addEventListener('click', () => this.renderAnalyticsDashboard(true));
        document.querySelectorAll('#analytics-tabs-nav .tab-btn').forEach(btn => {
            btn.addEventListener('click', () => this.handleTabClick(btn));
        });

        // Settings View
        document.getElementById('theme-switch').addEventListener('click', () => this.toggleTheme());
        document.getElementById('save-sync-settings').addEventListener('click', () => this.handleSaveSyncSettings());
        document.getElementById('save-app-settings').addEventListener('click', () => this.handleSaveAppSettings());
        document.getElementById('export-btn').addEventListener('click', () => this.openModal('export-modal'));
        document.getElementById('wipe-local-cache-btn').addEventListener('click', () => this.clearLocalCache());

        // Bike Form Modal
        this.initFormModalListeners();
        
        // Sold Modal
        this.initSoldModalListeners();

        // Export Modal
        this.initExportModalListeners();

        // Confirm Modal
        document.getElementById('confirm-cancel').addEventListener('click', () => this.closeModal('confirm-modal'));
        
        // System
        window.addEventListener('online', () => { this.isOnline = true; this.syncChanges(); });
        window.addEventListener('offline', () => { this.isOnline = false; this.setSyncStatus('offline', 'No internet'); });
      }
      
      initFormModalListeners() {
        const modal = document.getElementById('form-modal');
        modal.addEventListener('click', (e) => { if (e.target === modal) this.closeModal('form-modal'); });
        document.getElementById('close-form-modal').addEventListener('click', () => this.closeModal('form-modal'));
        document.getElementById('save-form-btn').addEventListener('click', () => this.handleSaveBike());
        document.getElementById('delete-bike-btn').addEventListener('click', () => this.handleDeleteBike());
        
        document.getElementById('toggle-full-form-btn').addEventListener('click', (e) => {
            const btn = e.currentTarget;
            const fullForm = document.getElementById('form-full-add');
            if (btn.dataset.mode === 'quick') {
                fullForm.classList.remove('hidden');
                btn.textContent = 'Show Quick Form';
                btn.dataset.mode = 'full';
            } else {
                fullForm.classList.add('hidden');
                btn.textContent = 'Show Full Form';
                btn.dataset.mode = 'quick';
            }
        });
      }

      initSoldModalListeners() {
        const modal = document.getElementById('sold-modal');
        modal.addEventListener('click', (e) => { if (e.target === modal) this.closeModal('sold-modal'); });
        document.getElementById('close-sold-modal').addEventListener('click', () => this.closeModal('sold-modal'));
        document.getElementById('cancel-sold-btn').addEventListener('click', () => this.closeModal('sold-modal'));
        document.getElementById('save-sold-btn').addEventListener('click', () => this.handleSaveSale());
      }
      
      initExportModalListeners() {
        const modal = document.getElementById('export-modal');
        modal.addEventListener('click', (e) => { if (e.target === modal) this.closeModal('export-modal'); });
        document.getElementById('close-export-modal').addEventListener('click', () => this.closeModal('export-modal'));
        
        document.getElementById('export-csv-view').addEventListener('click', () => this.exportCSV('view'));
        document.getElementById('export-csv-month').addEventListener('click', () => this.exportCSV('month'));
        document.getElementById('export-csv-all').addEventListener('click', () => this.exportCSV('all'));
        document.getElementById('export-pdf-month').addEventListener('click', () => this.exportPDF());
        document.getElementById('export-whatsapp').addEventListener('click', () => this.exportWhatsApp());
      }

      navigateTo(viewId) {
        this.currentView = viewId;
        this.dom.views.forEach(v => v.classList.toggle('active', v.id === viewId));
        this.dom.navButtons.forEach(b => b.classList.toggle('active', b.dataset.view === viewId));

        if (viewId === 'view-list') {
          this.renderBikeList();
          this.renderStatsGrid();
        }
        if (viewId === 'view-stats') {
          this.renderAnalyticsDashboard(false); // Render with existing data
        }
        if (viewId === 'view-settings') {
          this.updateSettingsUI();
        }
      }
      
      openModal(modalId) {
        document.getElementById(modalId)?.classList.add('active');
      }
      
      closeModal(modalId) {
        document.getElementById(modalId)?.classList.remove('active');
      }

      showConfirmModal(title, message, onConfirm) {
        document.getElementById('confirm-title').textContent = title;
        document.getElementById('confirm-message').textContent = message;
        
        const confirmBtn = document.getElementById('confirm-ok');
        // Clone and replace to remove old listeners
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        newConfirmBtn.addEventListener('click', () => {
          onConfirm();
          this.closeModal('confirm-modal');
        }, { once: true });
        
        this.openModal('confirm-modal');
      }

      showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toast.setAttribute('role', 'alert');

        container.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 3000);
      }
      
      handleFilterClick(clickedChip) {
          const filterGroup = clickedChip.closest('.filter-chips');
          filterGroup.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));
          clickedChip.classList.add('active');
          this.renderBikeList();
      }
      
      handleTabClick(clickedTab) {
          // Nav
          document.querySelectorAll('#analytics-tabs-nav .tab-btn').forEach(btn => btn.classList.remove('active'));
          clickedTab.classList.add('active');
          // Content
          document.querySelectorAll('#analytics-tabs-content .tab-content').forEach(content => content.classList.remove('active'));
          document.getElementById(clickedTab.dataset.tab).classList.add('active');
      }

      // --- 6. CORE CRUD OPERATIONS ---

      handleNewBike() {
        document.getElementById('bike-form').reset();
        document.getElementById('form-bike-id').value = '';
        document.getElementById('form-title').textContent = 'Add New Bike';
        document.getElementById('form-datePurchase').value = new Date().toISOString().split('T')[0];
        
        // Set defaults
        document.getElementById('form-source').value = 'Direct Owner';
        
        // Hide delete btn, show quick form
        document.getElementById('delete-bike-btn').classList.add('hidden');
        document.getElementById('form-section-sold').classList.add('hidden');
        document.getElementById('form-full-add').classList.add('hidden');
        document.getElementById('toggle-full-form-btn').textContent = 'Show Full Form';
        document.getElementById('toggle-full-form-btn').dataset.mode = 'quick';
        
        this.openModal('form-modal');
      }

      handleEditBike(bike) {
        document.getElementById('bike-form').reset();
        document.getElementById('form-bike-id').value = bike.id;
        document.getElementById('form-title').textContent = `Edit ${bike.plate}`;
        
        // Populate all fields
        document.getElementById('form-plate').value = bike.plate;
        document.getElementById('form-owner').value = bike.owner;
        document.getElementById('form-purchasePrice').value = bike.purchasePrice;
        document.getElementById('form-model').value = bike.model || '';
        document.getElementById('form-datePurchase').value = bike.datePurchase;
        document.getElementById('form-source').value = bike.source || 'Direct Owner';
        document.getElementById('form-repairCost').value = bike.repairCost || '';
        document.getElementById('form-otherExpenses').value = bike.otherExpenses || '';
        document.getElementById('form-notes').value = bike.notes || '';
        
        // Show delete btn, show full form
        document.getElementById('delete-bike-btn').classList.remove('hidden');
        document.getElementById('form-full-add').classList.remove('hidden');
        document.getElementById('toggle-full-form-btn').textContent = 'Show Quick Form';
        document.getElementById('toggle-full-form-btn').dataset.mode = 'full';
        
        // Show sold section if sold
        if (bike.isSold) {
            document.getElementById('form-section-sold').classList.remove('hidden');
            document.getElementById('form-dateSelling').value = bike.dateSelling;
            document.getElementById('form-sellingPrice').value = bike.sellingPrice;
        } else {
            document.getElementById('form-section-sold').classList.add('hidden');
        }
        
        this.openModal('form-modal');
      }
      
      handleOpenSoldModal(bike) {
        document.getElementById('sold-form').reset();
        document.getElementById('sold-bike-id').value = bike.id;
        document.getElementById('sold-bike-plate').textContent = bike.plate;
        document.getElementById('sold-dateSelling').value = new Date().toISOString().split('T')[0];
        
        // Pre-fill projected price
        const investment = (bike.purchasePrice || 0) + (bike.repairCost || 0) + (bike.otherExpenses || 0);
        const margin = (this.settings.defaultMargin || 15) / 100;
        const projectedPrice = Math.ceil((investment * (1 + margin)) / 100) * 100; // Round to nearest 100
        document.getElementById('sold-sellingPrice').value = projectedPrice;
        
        this.openModal('sold-modal');
      }
      
      handleSaveBike() {
        const id = document.getElementById('form-bike-id').value;
        const plate = document.getElementById('form-plate').value.trim().toUpperCase();
        const owner = document.getElementById('form-owner').value.trim();
        const purchasePrice = parseFloat(document.getElementById('form-purchasePrice').value) || 0;
        
        if (!plate || !owner || purchasePrice === 0) {
          this.showToast('Plate, Owner, and Purchase Price are required.', 'error');
          return;
        }
        
        const datePurchase = document.getElementById('form-datePurchase').value || new Date().toISOString().split('T')[0];
        const purchaseMonth = this.getYearMonthString(new Date(datePurchase));
        
        const bikeData = {
          id: id || `bike_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          plate: plate,
          owner: owner,
          model: document.getElementById('form-model').value.trim() || '',
          datePurchase: datePurchase,
          purchasePrice: purchasePrice,
          repairCost: parseFloat(document.getElementById('form-repairCost').value) || 0,
          otherExpenses: parseFloat(document.getElementById('form-otherExpenses').value) || 0,
          source: document.getElementById('form-source').value || 'Direct Owner',
          notes: document.getElementById('form-notes').value.trim() || '',
          isSold: false,
          dateSelling: '',
          sellingPrice: 0,
        };
        
        // Handle edit-specific sold data
        if (id) {
            const isSold = !document.getElementById('form-section-sold').classList.contains('hidden');
            if (isSold) {
                bikeData.isSold = true;
                bikeData.dateSelling = document.getElementById('form-dateSelling').value;
                bikeData.sellingPrice = parseFloat(document.getElementById('form-sellingPrice').value) || 0;
            }
        }
        
        // --- DATA LOGIC ---
        
        // 1. Find original month if this is an edit
        let originalMonth = null;
        if (id) {
            for (const month in this.localCache) {
                const bikeIndex = this.localCache[month].bikes.findIndex(b => b.id === id);
                if (bikeIndex !== -1) {
                    originalMonth = month;
                    // Remove from original month
                    this.localCache[originalMonth].bikes.splice(bikeIndex, 1);
                    break;
                }
            }
        }
        
        // 2. Ensure target month exists
        if (!this.localCache[purchaseMonth]) {
            this.localCache[purchaseMonth] = { month: purchaseMonth, bikes: [] };
            if (!this.appState.availableMonths.includes(purchaseMonth)) {
                this.appState.availableMonths.push(purchaseMonth);
                this.appState.availableMonths.sort().reverse(); // Keep newest first
                this.syncState.pendingChanges['metadata'] = true;
            }
        }
        
        // 3. Add to new month
        this.localCache[purchaseMonth].bikes.push(bikeData);
        
        // 4. Mark changes as pending
        if (originalMonth && originalMonth !== purchaseMonth) {
            this.syncState.pendingChanges[originalMonth] = true;
        }
        this.syncState.pendingChanges[purchaseMonth] = true;
        
        // 5. Save and sync
        this.saveCacheToLocalStorage();
        this.closeModal('form-modal');
        this.showToast(id ? 'Bike updated' : 'Bike added', 'success');
        this.renderAll();
        this.debouncedSync();
      }
      
      handleSaveSale() {
        const id = document.getElementById('sold-bike-id').value;
        const sellingPrice = parseFloat(document.getElementById('sold-sellingPrice').value) || 0;
        const dateSelling = document.getElementById('sold-dateSelling').value;
        
        if (sellingPrice === 0 || !dateSelling) {
            this.showToast('Selling Price and Date are required.', 'error');
            return;
        }
        
        // Find the bike and its month
        let bike = null;
        let purchaseMonth = null;
        for (const month in this.localCache) {
            bike = this.localCache[month].bikes.find(b => b.id === id);
            if (bike) {
                purchaseMonth = month;
                break;
            }
        }
        
        if (!bike || !purchaseMonth) {
            this.showToast('Error: Could not find bike to sell.', 'error');
            return;
        }
        
        // Update the bike object
        bike.isSold = true;
        bike.sellingPrice = sellingPrice;
        bike.dateSelling = dateSelling;
        
        // Mark month as pending
        this.syncState.pendingChanges[purchaseMonth] = true;
        
        // Save, close, and sync
        this.saveCacheToLocalStorage();
        this.closeModal('sold-modal');
        this.showToast(`${bike.plate} marked as sold`, 'success');
        this.renderAll();
        this.debouncedSync();
      }

      handleDeleteBike() {
        const id = document.getElementById('form-bike-id').value;
        if (!id) return;

        let bikeToDelete = null;
        let purchaseMonth = null;
        for (const month in this.localCache) {
            const bikeIndex = this.localCache[month].bikes.findIndex(b => b.id === id);
            if (bikeIndex !== -1) {
                bikeToDelete = this.localCache[month].bikes[bikeIndex];
                purchaseMonth = month;
                break;
            }
        }
        
        if (!bikeToDelete || !purchaseMonth) {
            this.showToast('Error: Could not find bike to delete.', 'error');
            return;
        }

        this.showConfirmModal(
          'Delete Bike?',
          `Are you sure you want to delete "${bikeToDelete.plate}"? This is permanent and will sync.`,
          () => {
            // Find and remove the bike
            const bikeIndex = this.localCache[purchaseMonth].bikes.findIndex(b => b.id === id);
            if (bikeIndex !== -1) {
                this.localCache[purchaseMonth].bikes.splice(bikeIndex, 1);
            }
            
            // Mark as pending
            this.syncState.pendingChanges[purchaseMonth] = true;
            
            // Save, close, and sync
            this.saveCacheToLocalStorage();
            this.closeModal('form-modal');
            this.showToast('Bike deleted', 'success');
            this.renderAll();
            this.debouncedSync();
          }
        );
      }
      
      handleBikeListClick(e) {
        const button = e.target.closest('button');
        if (!button) {
            // Click on card body
            const card = e.target.closest('.bike-card');
            if (!card) return;
            
            const bike = this.findBikeById(card.dataset.id);
            if (bike) this.handleEditBike(bike);
            return;
        }

        const action = button.dataset.action;
        const card = e.target.closest('.bike-card');
        if (!action || !card) return;

        const bike = this.findBikeById(card.dataset.id);
        if (!bike) return;
        
        if (action === 'edit') {
            this.handleEditBike(bike);
        } else if (action === 'sell') {
            this.handleOpenSoldModal(bike);
        } else if (action === 'delete') {
            // Set form ID for delete handler, then call it
            document.getElementById('form-bike-id').value = bike.id;
            this.handleDeleteBike();
        }
      }
      
      findBikeById(id) {
         for (const month in this.localCache) {
            const bike = this.localCache[month].bikes.find(b => b.id === id);
            if (bike) return bike;
        }
        return null;
      }

      // --- 7. RENDERING ---

      async renderAll() {
        this.updateMonthNavigator();
        this.renderStatsGrid(); // Quick stats
        this.renderBikeList(); // Main list
        
        // Re-render analytics if view is active
        if (this.currentView === 'view-stats') {
            this.renderAnalyticsDashboard(false);
        }
      }
      
      updateMonthNavigator() {
        const display = document.getElementById('month-current-display');
        if (!display) return;
        
        try {
            const date = new Date(this.appState.currentMonthView + '-02'); // Use 2nd day to avoid TZ issues
            const formatter = new Intl.DateTimeFormat('default', { month: 'long', year: 'numeric' });
            display.textContent = formatter.format(date);
        } catch (e) {
            display.textContent = this.appState.currentMonthView;
        }
        
        // Disable/enable next button
        const nextMonth = this.getRelativeMonth(this.appState.currentMonthView, 1);
        const currentRealMonth = this.getYearMonthString(new Date());
        document.getElementById('month-next').disabled = this.appState.currentMonthView === currentRealMonth;
      }
      
      async navigateMonth(delta) {
        let newMonth;
        if (delta === 0) { // Go to Today
            newMonth = this.getYearMonthString(new Date());
        } else {
            newMonth = this.getRelativeMonth(this.appState.currentMonthView, delta);
        }
        
        // Don't go into the future
        const currentRealMonth = this.getYearMonthString(new Date());
        if (newMonth > currentRealMonth) {
            newMonth = currentRealMonth;
        }

        this.appState.currentMonthView = newMonth;
        
        // Check if month is loaded. If not, load it.
        if (!this.localCache[newMonth]) {
            await this.loadMonth(newMonth);
        }
        
        this.updateMonthNavigator();
        this.renderBikeList();
        this.renderStatsGrid();
      }

      async setDataView(view) {
        this.appState.currentDataView = view;
        document.getElementById('view-toggle-month').classList.toggle('active', view === 'this-month');
        document.getElementById('view-toggle-3month').classList.toggle('active', view === 'last-3-months');
        
        // Ensure data is loaded
        if (view === 'last-3-months') {
            const m2 = this.getRelativeMonth(this.appState.currentMonthView, -1);
            const m3 = this.getRelativeMonth(this.appState.currentMonthView, -2);
            if (!this.localCache[m2]) await this.loadMonth(m2);
            if (!this.localCache[m3]) await this.loadMonth(m3);
        }
        
        this.renderBikeList();
      }

      /**
       * Renders the 8-card stats grid.
       */
      renderStatsGrid() {
        const monthBikes = this.localCache[this.appState.currentMonthView]?.bikes || [];
        const allBikes = this.getAllBikesFromCache();
        
        const soldThisMonth = monthBikes.filter(b => b.isSold);
        const unsoldThisMonth = monthBikes.filter(b => !b.isSold);
        const soldAllTime = allBikes.filter(b => b.isSold);
        const unsoldAllTime = allBikes.filter(b => !b.isSold);
        
        const f = this.formatCurrency;
        const c = this.settings.currency;
        
        // Month Stats
        const monthProfit = soldThisMonth.reduce((sum, b) => sum + (b.sellingPrice - (b.purchasePrice + b.repairCost + b.otherExpenses)), 0);
        const monthInvestment = soldThisMonth.reduce((sum, b) => sum + (b.purchasePrice + b.repairCost + b.otherExpenses), 0);
        const monthUnsoldValue = unsoldThisMonth.reduce((sum, b) => sum + (b.purchasePrice + b.repairCost + b.otherExpenses), 0);
        const monthRevenue = soldThisMonth.reduce((sum, b) => sum + b.sellingPrice, 0);
        const monthROI = monthInvestment > 0 ? (monthProfit / monthInvestment) * 100 : 0;

        document.getElementById('stat-month-profit').textContent = `${c}${f(monthProfit)}`;
        document.getElementById('stat-month-profit-context').textContent = 'This month'; // Context vs last month removed
        document.getElementById('stat-month-unsold').textContent = unsoldThisMonth.length;
        document.getElementById('stat-month-unsold-value').textContent = `${c}${f(monthUnsoldValue)} locked`;
        document.getElementById('stat-month-sold').textContent = soldThisMonth.length;
        document.getElementById('stat-month-sold-value').textContent = `${c}${f(monthRevenue)} revenue`;
        document.getElementById('stat-month-roi').textContent = `${monthROI.toFixed(0)}%`;
        
        // All-Time Stats
        const totalProfit = soldAllTime.reduce((sum, b) => sum + (b.sellingPrice - (b.purchasePrice + b.repairCost + b.otherExpenses)), 0);
        const totalUnsoldValue = unsoldAllTime.reduce((sum, b) => sum + (b.purchasePrice + b.repairCost + b.otherExpenses), 0);
        const totalRevenue = soldAllTime.reduce((sum, b) => sum + b.sellingPrice, 0);
        const totalInvestment = soldAllTime.reduce((sum, b) => sum + (b.purchasePrice + b.repairCost + b.otherExpenses), 0);
        const avgProfit = soldAllTime.length > 0 ? totalProfit / soldAllTime.length : 0;
        const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
        
        const daysToSell = soldAllTime
            .map(b => this.getDaysBetween(b.datePurchase, b.dateSelling))
            .filter(d => d >= 0);
        const avgDays = daysToSell.length > 0 ? daysToSell.reduce((a, b) => a + b, 0) / daysToSell.length : 0;

        document.getElementById('stat-total-profit').textContent = `${c}${f(totalProfit)}`;
        document.getElementById('stat-total-unsold').textContent = `${c}${f(totalUnsoldValue)}`;
        document.getElementById('stat-total-unsold-count').textContent = `(${unsoldAllTime.length} bikes)`;
        document.getElementById('stat-avg-profit').textContent = `${c}${f(avgProfit)}`;
        document.getElementById('stat-avg-margin').textContent = `(${avgMargin.toFixed(0)}% margin)`;
        document.getElementById('stat-avg-days').textContent = avgDays.toFixed(0);
      }

      /**
       * Renders the main list of bikes.
       */
      renderBikeList() {
        const skeleton = document.getElementById('bike-list-skeleton');
        const list = document.getElementById('bike-list');
        const empty = document.getElementById('bike-list-empty');
        
        skeleton.classList.remove('hidden');
        list.classList.add('hidden');
        empty.classList.add('hidden');
        
        let bikes = this.getDataForView();
        
        // Apply Filters
        const search = document.getElementById('search-input').value.toLowerCase();
        if (search) {
            bikes = bikes.filter(b => 
                b.plate.toLowerCase().includes(search) ||
                b.owner.toLowerCase().includes(search) ||
                b.model.toLowerCase().includes(search)
            );
        }
        
        const activeFilter = document.querySelector('.filter-chips .chip.active').dataset.filter;
        if (activeFilter === 'sold') {
            bikes = bikes.filter(b => b.isSold);
        } else if (activeFilter === 'unsold') {
            bikes = bikes.filter(b => !b.isSold);
        } else if (activeFilter === 'aging') {
            bikes = bikes.filter(b => !b.isSold && this.getDaysBetween(b.datePurchase, new Date()) >= 60);
        }
        
        // Apply Sort (Newest first by default)
        bikes.sort((a, b) => new Date(b.datePurchase) - new Date(a.datePurchase));
        
        skeleton.classList.add('hidden');
        
        if (bikes.length === 0) {
            list.innerHTML = '';
            empty.classList.remove('hidden');
        } else {
            list.innerHTML = bikes.map(b => this.createBikeCardHTML(b)).join('');
            list.classList.remove('hidden');
        }
      }
      
      createBikeCardHTML(bike) {
        const investment = (bike.purchasePrice || 0) + (bike.repairCost || 0) + (bike.otherExpenses || 0);
        let profitHTML = '';
        
        if (bike.isSold) {
            const profit = (bike.sellingPrice || 0) - investment;
            const profitClass = profit < 0 ? 'loss' : '';
            profitHTML = `
                <div class_name="bike-card-profit">
                    <div class="profit-value ${profitClass}">${this.settings.currency}${this.formatCurrency(profit)}</div>
                </div>
            `;
        } else {
            profitHTML = `
                <div class="bike-card-profit">
                    <div class="investment-value">Invest: ${this.settings.currency}${this.formatCurrency(investment)}</div>
                </div>
            `;
        }
        
        // Aging
        const daysHeld = this.getDaysBetween(bike.datePurchase, bike.isSold ? bike.dateSelling : new Date());
        let agingClass = 'good';
        if (daysHeld >= 90) agingClass = 'bad';
        else if (daysHeld >= 60) agingClass = 'warn';
        else if (daysHeld >= 30) agingClass = 'ok';
        
        const agingText = bike.isSold ? `Sold in ${daysHeld}d` : `${daysHeld}d old`;
        
        return `
          <div class="bike-card" data-id="${bike.id}">
            <div class="bike-card-main">
              <div class="bike-card-details">
                <div class="bike-card-plate">${this.escapeHtml(bike.plate)}</div>
                <div class="bike-card-sub">${this.escapeHtml(bike.model) || 'No Model'} | ${this.escapeHtml(bike.owner)}</div>
              </div>
              <span class="bike-card-aging ${agingClass}">${agingText}</span>
            </div>
            
            ${profitHTML}
            
            <div class="bike-card-actions">
              <button class="btn btn-secondary btn-sm" data-action="edit">
                <svg width="16" height="16"><use href="#icon-edit"></use></svg> Edit
              </button>
              ${!bike.isSold ? `
              <button class="btn btn-primary btn-sm" data-action="sell">
                <svg width="16" height="16"><use href="#icon-sell"></use></svg> Sell
              </button>` : ''}
              <button class="btn btn-ghost btn-sm text-error" data-action="delete" style="margin-left: auto;">
                <svg width="16" height="16"><use href="#icon-delete"></use></svg>
              </button>
            </div>
          </div>
        `;
      }
      
      /**
       * Renders the full analytics dashboard.
       */
      async renderAnalyticsDashboard(forceLoadAll = false) {
        if (forceLoadAll && !this.appState.isAllDataLoaded) {
            this.setSyncStatus('syncing', 'Loading full history...');
            const promises = this.appState.availableMonths.map(month => this.loadMonth(month));
            await Promise.all(promises);
            this.appState.isAllDataLoaded = true;
            this.setSyncStatus('synced', 'Full history loaded');
            document.getElementById('analytics-data-range').textContent = 'Showing analytics for all time.';
        }
        
        const allBikes = this.getAllBikesFromCache();
        const soldBikes = allBikes.filter(b => b.isSold);
        
        if (allBikes.length === 0) {
            document.getElementById('stats-empty').classList.remove('hidden');
            return;
        } else {
            document.getElementById('stats-empty').classList.add('hidden');
        }

        // --- Calculate All Metrics ---
        const c = this.settings.currency;
        const f = this.formatCurrency;
        
        // --- Key Insight ---
        const totalProfit = soldBikes.reduce((sum, b) => this.getProfit(b) + sum, 0);
        const unsoldValue = allBikes.filter(b => !b.isSold).reduce((sum, b) => this.getInvestment(b) + sum, 0);
        const avgDays = this.getAverageDaysToSell(soldBikes);
        document.getElementById('key-insight-text').innerHTML = `
          ðŸŽ¯ Avg profit: <strong>${c}${f(totalProfit / soldBikes.length || 0)}/bike</strong><br>
          âš ï¸ <strong>${c}${f(unsoldValue)}</strong> locked in <strong>${allBikes.length - soldBikes.length}</strong> unsold bikes<br>
          â±ï¸ Avg sale time: <strong>${avgDays.toFixed(0)} days</strong>
        `;

        // --- Tab 1: Financial ---
        const currentMonthString = this.getYearMonthString(new Date());
        const thisMonthProfit = soldBikes
            .filter(b => b.dateSelling.startsWith(currentMonthString))
            .reduce((sum, b) => this.getProfit(b) + sum, 0);
        
        const monthlyProfit = {};
        soldBikes.forEach(b => {
            const month = b.dateSelling.substring(0, 7);
            monthlyProfit[month] = (monthlyProfit[month] || 0) + this.getProfit(b);
        });
        const bestMonth = Object.entries(monthlyProfit).sort((a, b) => b[1] - a[1])[0];

        document.getElementById('stat-fin-total-profit').textContent = `${c}${f(totalProfit)}`;
        document.getElementById('stat-fin-month-profit').textContent = `${c}${f(thisMonthProfit)}`;
        document.getElementById('stat-fin-avg-profit').textContent = `${c}${f(totalProfit / soldBikes.length || 0)}`;
        document.getElementById('stat-fin-best-month').textContent = bestMonth ? `${bestMonth[0]} (${c}${f(bestMonth[1])})` : '--';
        
        this.renderChart('chart-profit-trend', 'line', {
            labels: Object.keys(monthlyProfit).sort(),
            datasets: [{
                label: 'Monthly Profit',
                data: Object.keys(monthlyProfit).sort().map(m => monthlyProfit[m]),
                borderColor: 'var(--accent-1)',
                fill: true,
                backgroundColor: 'rgba(0, 208, 255, 0.1)',
                tension: 0.1
            }]
        });

        const profitBrackets = { '<0': 0, '0-5k': 0, '5k-10k': 0, '10k+': 0 };
        soldBikes.forEach(b => {
            const p = this.getProfit(b);
            if (p <= 0) profitBrackets['<0']++;
            else if (p <= 5000) profitBrackets['0-5k']++;
            else if (p <= 10000) profitBrackets['5k-10k']++;
            else profitBrackets['10k+']++;
        });
        this.renderChart('chart-profit-dist', 'bar', {
            labels: Object.keys(profitBrackets),
            datasets: [{ 
                label: 'Number of Bikes', 
                data: Object.values(profitBrackets),
                backgroundColor: 'var(--accent-2)',
            }]
        });
        
        const sourceProfit = {};
        soldBikes.forEach(b => {
            const source = b.source || 'Other';
            sourceProfit[source] = (sourceProfit[source] || 0) + this.getProfit(b);
        });
        this.renderChart('chart-category-source', 'bar', {
            labels: Object.keys(sourceProfit),
            datasets: [{ 
                label: 'Total Profit by Source', 
                data: Object.values(sourceProfit),
                backgroundColor: 'var(--accent-1)',
            }]
        });
        
        // --- Tab 2: Inventory ---
        const unsoldBikes = allBikes.filter(b => !b.isSold);
        document.getElementById('stat-inv-locked').textContent = `${c}${f(unsoldValue)}`;
        document.getElementById('stat-inv-unsold-count').textContent = unsoldBikes.length;
        document.getElementById('stat-inv-avg-days').textContent = `${avgDays.toFixed(0)} days`;
        document.getElementById('stat-inv-turnover').textContent = 'N/A'; // Need to define calculation
        
        const agingBrackets = { '0-30d': 0, '31-60d': 0, '61-90d': 0, '90d+': 0 };
        const agingList = [];
        unsoldBikes.forEach(b => {
            const days = this.getDaysBetween(b.datePurchase, new Date());
            if (days <= 30) agingBrackets['0-30d']++;
            else if (days <= 60) agingBrackets['31-60d']++;
            else if (days <= 90) agingBrackets['61-90d']++;
            else agingBrackets['90d+']++;
            
            if (days >= 60) agingList.push(b);
        });
        
        this.renderChart('chart-aging', 'doughnut', {
            labels: Object.keys(agingBrackets),
            datasets: [{
                data: Object.values(agingBrackets),
                backgroundColor: ['var(--aging-good)', 'var(--aging-ok)', 'var(--aging-warn)', 'var(--aging-bad)'],
            }]
        }, { responsive: true, maintainAspectRatio: false });
        
        const agingListEl = document.getElementById('list-aging-bikes');
        agingList.sort((a, b) => this.getDaysBetween(b.datePurchase, new Date()) - this.getDaysBetween(a.datePurchase, new Date()));
        agingListEl.innerHTML = agingList.length === 0 ? '<li>No bikes over 60 days. Good job!</li>' : 
            agingList.map(b => `<li><strong>${b.plate}</strong> (${this.getDaysBetween(b.datePurchase, new Date())}d) - ${c}${f(this.getInvestment(b))}</li>`).join('');
            
        // --- Tab 3: Performance ---
        const sortedByProfit = [...soldBikes].sort((a, b) => this.getProfit(b) - this.getProfit(a));
        document.getElementById('list-top-bikes').innerHTML = sortedByProfit.slice(0, 5)
            .map(b => `<li><strong>${b.plate}</strong> (${b.model}) - ${c}${f(this.getProfit(b))}</li>`).join('');
        document.getElementById('list-bottom-bikes').innerHTML = sortedByProfit.slice(-5).reverse()
            .map(b => `<li><strong>${b.plate}</strong> (${b.model}) - ${c}${f(this.getProfit(b))}</li>`).join('');
            
        const bestSource = Object.entries(sourceProfit).sort((a, b) => b[1] - a[1])[0];
        document.getElementById('insight-best-source').textContent = bestSource ? `${bestSource[0]} (${c}${f(bestSource[1])})` : 'N/A';
        
        const modelProfit = {};
        soldBikes.forEach(b => {
            const model = b.model || 'Unknown';
            modelProfit[model] = (modelProfit[model] || { profit: 0, count: 0 });
            modelProfit[model].profit += this.getProfit(b);
            modelProfit[model].count++;
        });
        const bestModel = Object.entries(modelProfit).sort((a, b) => b[1].profit - a[1].profit)[0];
        document.getElementById('insight-best-model').textContent = bestModel ? `${bestModel[0]} (${c}${f(bestModel[1].profit)} from ${bestModel[1].count} sales)` : 'N/A';
      }
      
      renderChart(canvasId, type, data, options = {}) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (this.charts[canvasId]) {
          this.charts[canvasId].destroy();
        }
        this.charts[canvasId] = new Chart(ctx, { type, data, options });
      }

      // --- 8. EXPORTING ---
      
      async exportCSV(scope) {
        let bikes = [];
        let filename = 'bike_export.csv';
        const allData = this.getAllBikesFromCache();
        
        if (scope === 'view') {
            bikes = this.getDataForView(); // Already filtered by 3-month/1-month
            filename = `bike_export_view_${this.appState.currentMonthView}.csv`;
        } else if (scope === 'month') {
            bikes = this.localCache[this.appState.currentMonthView]?.bikes || [];
            filename = `bike_export_${this.appState.currentMonthView}.csv`;
        } else if (scope === 'all') {
            if (!this.appState.isAllDataLoaded) {
                this.showToast('Loading all data for export...', 'info');
                await this.renderAnalyticsDashboard(true); // Force load all
            }
            bikes = this.getAllBikesFromCache();
            filename = 'bike_export_all_time.csv';
        }
        
        if (bikes.length === 0) {
            this.showToast('No data to export.', 'warning');
            return;
        }

        const csvData = bikes.map(b => ({
            id: b.id,
            plate: b.plate,
            owner: b.owner,
            model: b.model,
            datePurchase: b.datePurchase,
            purchasePrice: b.purchasePrice,
            repairCost: b.repairCost,
            otherExpenses: b.otherExpenses,
            investment: this.getInvestment(b),
            source: b.source,
            isSold: b.isSold,
            dateSelling: b.dateSelling,
            sellingPrice: b.sellingPrice,
            profit: b.isSold ? this.getProfit(b) : 0,
            daysHeld: this.getDaysBetween(b.datePurchase, b.isSold ? b.dateSelling : new Date()),
            notes: b.notes,
        }));
        
        this.downloadFile(this.jsonToCsv(csvData), filename, 'text/csv;charset=utf-8;');
        this.closeModal('export-modal');
      }
      
      exportPDF() {
        const monthString = this.appState.currentMonthView;
        const bikes = this.localCache[monthString]?.bikes || [];
        if (bikes.length === 0) {
            this.showToast('No data in current month to export.', 'warning');
            return;
        }
        
        const doc = new this.jsPDF();
        
        // Title
        doc.setFontSize(18);
        doc.text(`Monthly Report: ${monthString}`, 14, 22);
        
        // Summary Stats
        const sold = bikes.filter(b => b.isSold);
        const unsold = bikes.filter(b => !b.isSold);
        const profit = sold.reduce((sum, b) => sum + this.getProfit(b), 0);
        const unsoldValue = unsold.reduce((sum, b) => sum + this.getInvestment(b), 0);
        
        doc.setFontSize(11);
        doc.text(`Bikes Bought: ${bikes.length}`, 14, 32);
        doc.text(`Bikes Sold: ${sold.length}`, 14, 38);
        doc.text(`Total Profit: ${this.settings.currency}${this.formatCurrency(profit)}`, 14, 44);
        doc.text(`Unsold Investment: ${this.settings.currency}${this.formatCurrency(unsoldValue)} (${unsold.length} bikes)`, 14, 50);

        // Table
        const head = [['Plate', 'Model', 'Status', 'Investment', 'Selling Price', 'Profit']];
        const body = bikes.map(b => {
            const investment = this.getInvestment(b);
            const profit = b.isSold ? this.getProfit(b) : 'N/A';
            return [
                b.plate,
                b.model,
                b.isSold ? 'Sold' : 'Unsold',
                this.formatCurrency(investment),
                b.isSold ? this.formatCurrency(b.sellingPrice) : 'N/A',
                b.isSold ? this.formatCurrency(profit) : 'N/A',
            ];
        });

        this.autoTable(doc, {
            startY: 60,
            head: head,
            body: body,
            theme: 'grid',
            headStyles: { fillColor: [7, 27, 43] },
        });
        
        doc.save(`Bike_Report_${monthString}.pdf`);
        this.closeModal('export-modal');
      }
      
      exportWhatsApp() {
        const monthString = this.appState.currentMonthView;
        const bikes = this.localCache[monthString]?.bikes || [];
        
        const boughtCount = bikes.length;
        const sold = bikes.filter(b => b.isSold);
        const unsold = bikes.filter(b => !b.isSold);
        
        const boughtValue = bikes.reduce((sum, b) => sum + this.getInvestment(b), 0);
        const soldValue = sold.reduce((sum, b) => sum + b.sellingPrice, 0);
        const profit = sold.reduce((sum, b) => sum + this.getProfit(b), 0);
        const profitMargin = (soldValue - boughtValue) > 0 ? (profit / (soldValue-profit)) * 100 : 0;
        const unsoldValue = unsold.reduce((sum, b) => sum + this.getInvestment(b), 0);
        
        const c = this.settings.currency;
        const f = this.formatCurrency;

        const summary = `
ðŸ“Š *${this.formatMonthDisplay(monthString)} Summary*
---
Bought: ${boughtCount} bikes (${c}${f(boughtValue)})
Sold: ${sold.length} bikes (${c}${f(soldValue)})
Profit: *${c}${f(profit)}* (${profitMargin.toFixed(0)}% ROI)
Unsold: ${unsold.length} bikes (${c}${f(unsoldValue)} locked)
        `.trim().replace(/\n/g, '%0A').replace(/ /g, '%20');
        
        const url = `https://api.whatsapp.com/send?text=${summary}`;
        window.open(url, '_blank');
        this.closeModal('export-modal');
      }
      
      // --- 9. SETTINGS HANDLERS ---
      
      handleSaveSyncSettings() {
        this.settings.gistId = document.getElementById('setting-gist-id').value.trim();
        const newPat = document.getElementById('setting-github-pat').value.trim();
        this.settings.autoSyncInterval = document.getElementById('setting-auto-sync').value;
        
        if (newPat) {
          this.settings.githubPat = newPat;
        }
        
        this.saveSettings(); // This saves to localStorage and session storage
        
        if (newPat) {
            this.showToast('Gist ID and PAT saved for this session.', 'success');
        } else {
            this.showToast('Settings saved.', 'success');
        }
        
        // If settings were empty, trigger initial load
        if (this.syncState.status === 'offline' && this.settings.gistId && this.settings.githubPat) {
            this.initialLoad();
        }
      }
      
      handleSaveAppSettings() {
        this.settings.currency = document.getElementById('setting-currency').value.trim() || 'â‚¹';
        this.settings.defaultMargin = parseFloat(document.getElementById('setting-default-margin').value) || 15;
        this.saveSettings();
        this.renderAll(); // Re-render to apply currency etc.
      }

      // --- 10. UTILITIES ---

      getInvestment(bike) {
        return (bike.purchasePrice || 0) + (bike.repairCost || 0) + (bike.otherExpenses || 0);
      }
      
      getProfit(bike) {
        if (!bike.isSold) return 0;
        return (bike.sellingPrice || 0) - this.getInvestment(bike);
      }
      
      getDaysBetween(date1, date2) {
        try {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            const diffTime = Math.abs(d2 - d1);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        } catch (e) {
            return 0;
        }
      }
      
      getAverageDaysToSell(soldBikes) {
        const daysToSell = soldBikes
            .map(b => this.getDaysBetween(b.datePurchase, b.dateSelling))
            .filter(d => d >= 0);
        return daysToSell.length > 0 ? daysToSell.reduce((a, b) => a + b, 0) / daysToSell.length : 0;
      }

      getYearMonthString(date) {
        return date.toISOString().substring(0, 7); // 'YYYY-MM'
      }
      
      getRelativeMonth(monthString, delta) {
        const date = new Date(monthString + '-02'); // Use 2nd day
        date.setMonth(date.getMonth() + delta);
        return this.getYearMonthString(date);
      }
      
      formatMonthDisplay(monthString) {
        try {
            const date = new Date(monthString + '-02');
            return new Intl.DateTimeFormat('default', { month: 'long', year: 'numeric' }).format(date);
        } catch (e) {
            return monthString;
        }
      }

      formatCurrency(value) {
        return new Intl.NumberFormat('en-IN', { 
            maximumFractionDigits: 0 
        }).format(value || 0);
      }
      
      timeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + "y ago";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + "mo ago";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + "d ago";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + "h ago";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + "m ago";
        return "just now";
      }
      
      jsonToCsv(items) {
        if (!items || items.length === 0) return "";
        const header = Object.keys(items[0]);
        const csv = [
          header.join(','), 
          ...items.map(row => header.map(fieldName => {
            let field = row[fieldName];
            if (typeof field === 'string') {
              // Handle commas and quotes
              field = `"${field.replace(/"/g, '""')}"`;
            }
            return field;
          }).join(','))
        ].join('\r\n');
        return csv;
      }

      downloadFile(content, fileName, contentType) {
        const a = document.createElement("a");
        const file = new Blob([content], { type: contentType });
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(a.href);
      }

      debounce(func, wait, immediate) {
        let timeout;
        return function() {
          const context = this, args = arguments;
          const later = function() {
            timeout = null;
            if (!immediate) func.apply(context, args);
          };
          const callNow = immediate && !timeout;
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
          if (callNow) func.apply(context, args);
        };
      }
      
      escapeHtml(str) {
        return String(str || '').replace(/[&<>"']/g, match => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[match]));
      }
      
    }

    // Initialize the app
    window.app = new BikeManagerApp();

  </script>
</body>

</html>
