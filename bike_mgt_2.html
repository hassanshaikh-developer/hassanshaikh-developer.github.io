<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Inventory</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- 3. jsPDF & jsPDF-AutoTable for PDF Reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf-autotable.umd.min.js"></script>
    <!-- 4. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <style>
        /* Custom styles for mobile-first UI elements */
        
        /* Bottom Sheet Modal */
        .bottom-sheet {
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
        }
        .bottom-sheet.is-open {
            transform: translateY(0);
        }

        /* Toast Notification */
        .toast {
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .toast.is-visible {
            transform: translateY(0);
            opacity: 1;
        }

        /* Swipe-to-action */
        .swipe-card {
            transition: transform 0.2s ease-out;
        }
        .swipe-actions {
            transition: opacity 0.2s;
        }

        /* Haptic feedback simulation (subtle shake) */
        @keyframes subtle-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-1px); }
            75% { transform: translateX(1px); }
        }
        .haptic-feedback {
            animation: subtle-shake 0.1s linear;
        }

        /* Chart.js responsive container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased" style="font-family: 'Inter', sans-serif;">

    <!-- Main Application Container -->
    <div id="app" class="max-w-4xl mx-auto min-h-screen bg-white shadow-lg">

        <!-- App Header -->
        <header class="sticky top-0 z-40 bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
            <h1 class="text-xl font-bold text-gray-800">Bike Inventory</h1>
            <div class="flex items-center space-x-3">
                <!-- Sync Status -->
                <div id="sync-status" class="text-sm text-gray-500 flex items-center">
                    <!-- Status updated by JS -->
                </div>
                <!-- Settings Button -->
                <button id="btn-show-settings" class="text-gray-600 hover:text-gray-900">
                    <i data-lucide="settings"></i>
                </button>
            </div>
        </header>

        <!-- Main Content (Tabbed Views) -->
        <main class="p-4 pb-20">
            <!-- Inventory View (Default) -->
            <div id="view-inventory">
                <!-- 10. Stats Grid -->
                <section id="stats-grid" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                    <!-- Cards injected by JS -->
                </section>

                <!-- 5. Month Navigation & View Toggle -->
                <div class="bg-gray-50 p-2 rounded-lg mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <button id="btn-prev-month" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <div class="flex flex-col items-center">
                            <h3 id="month-navigator-title" class="text-lg font-semibold text-gray-900">November 2024</h3>
                            <span id="month-navigator-summary" class="text-xs text-gray-500">Showing: 0 bikes (0 sold, 0 unsold)</span>
                        </div>
                        <button id="btn-next-month" class="p-2 rounded-full hover:bg-gray-200"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <button id="btn-view-toggle-this-month" class="bg-blue-600 text-white text-sm py-2 px-3 rounded-md font-medium">This Month</button>
                        <button id="btn-view-toggle-3-months" class="bg-white text-gray-700 border border-gray-300 text-sm py-2 px-3 rounded-md font-medium">Last 3 Months</button>
                        <button id="btn-jump-today" class="bg-white text-gray-700 border border-gray-300 text-sm py-2 px-3 rounded-md font-medium">Today</button>
                    </div>
                </div>

                <!-- 9. Filtering & Sorting -->
                <div class="mb-4 space-y-3">
                    <!-- Search -->
                    <div class="relative">
                        <input type="search" id="search-box" placeholder="Search plate, owner, model..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                    </div>
                    <!-- Status Filter -->
                    <div class="grid grid-cols-3 gap-2">
                        <button class="filter-status-btn bg-blue-600 text-white py-2 rounded-lg text-sm font-medium" data-filter="all">All</button>
                        <button class="filter-status-btn bg-white text-gray-700 border border-gray-300 py-2 rounded-lg text-sm font-medium" data-filter="unsold">Unsold</button>
                        <button class="filter-status-btn bg-white text-gray-700 border border-gray-300 py-2 rounded-lg text-sm font-medium" data-filter="sold">Sold</button>
                    </div>
                    <!-- Sort & Filter Chips -->
                    <div class="flex items-center justify-between">
                        <select id="sort-select" class="border border-gray-300 rounded-lg text-sm px-3 py-2 focus:outline-none">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="profit-hi">Highest Profit</option>
                            <option value="profit-lo">Lowest Profit/Loss</option>
                            <option value="held-long">Longest Held</option>
                        </select>
                        <div class="flex space-x-2 overflow-x-auto py-1">
                            <button class="filter-chip-btn flex-shrink-0 text-xs px-3 py-1 rounded-full border" data-chip="aging">üî¥ Aging (60+)</button>
                            <button class="filter-chip-btn flex-shrink-0 text-xs px-3 py-1 rounded-full border" data-chip="critical">üî¥üî¥ Critical (90+)</button>
                            <button class="filter-chip-btn flex-shrink-0 text-xs px-3 py-1 rounded-full border" data-chip="high-value">üí∞ High Value</button>
                        </div>
                    </div>
                </div>

                <!-- 8. Bike List -->
                <div id="bike-list" class="space-y-3">
                    <!-- Bike cards injected by JS -->
                    <!-- Card Template -->
                    <!--
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-4 relative overflow-hidden">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-lg text-gray-900">GJ01AB1234</h4>
                                <p class="text-sm text-gray-600">Hero Splendor</p>
                                <p class="text-sm text-gray-500">Rajesh Kumar</p>
                            </div>
                            <span class="text-xs font-medium bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">üü° 60d</span>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-yellow-700">Investment: ‚Çπ45,000</p>
                        </div>
                        <div class="flex space-x-2 mt-3 border-t border-gray-100 pt-3">
                            <button class="text-sm text-blue-600 font-medium">‚úèÔ∏è Edit</button>
                            <button class="text-sm text-green-600 font-medium">‚úÖ Sold</button>
                            <button class="text-sm text-red-600 font-medium">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    -->
                </div>
                <p id="empty-list-msg" class="text-center text-gray-500 py-10 hidden">No bikes found.</p>

            </div>

            <!-- Analytics View -->
            <div id="view-analytics" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Analytics</h2>
                    <button id="btn-load-all-analytics" class="text-sm bg-blue-500 text-white py-2 px-3 rounded-lg flex items-center">
                        <i data-lucide="bar-chart-3" class="w-4 h-4 mr-1"></i> Load All Data
                    </button>
                </div>
                <p id="analytics-scope-msg" class="text-sm text-gray-500 mb-4">Showing analytics for last 3 months.</p>

                <!-- Key Insights Panel -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h4 class="text-lg font-semibold text-blue-800 mb-2">üí° Key Insights</h4>
                    <ul id="key-insights-list" class="list-disc list-inside space-y-1 text-sm text-blue-700">
                        <li>Loading insights...</li>
                    </ul>
                </div>

                <!-- Analytics Tabs -->
                <div class="mb-4 border-b border-gray-200">
                    <nav class="flex -mb-px space-x-4" aria-label="Tabs">
                        <button class="analytics-tab-btn border-blue-600 text-blue-600 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-tab="financial">Financial</button>
                        <button class="analytics-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-tab="inventory">Inventory</button>
                        <button class="analytics-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-tab="performance">Performance</button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div id="analytics-content-financial">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                        <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Total Profit</div><div id="metric-total-profit" class="text-lg font-bold">‚Çπ0</div></div>
                        <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">This Month Profit</div><div id="metric-this-month-profit" class="text-lg font-bold">‚Çπ0</div></div>
                        <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Avg Profit/Sale</div><div id="metric-avg-profit" class="text-lg font-bold">‚Çπ0</div></div>
                        <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Best Month</div><div id="metric-best-month" class="text-lg font-bold">-</div></div>
                        <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Overall ROI</div><div id="metric-overall-roi" class="text-lg font-bold">0%</div></div>
                        <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Capital Locked</div><div id="metric-capital-locked" class="text-lg font-bold">‚Çπ0</div></div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <h5 class="font-semibold mb-2">Monthly Profit Trend</h5>
                            <div class="chart-container"><canvas id="chart-profit-trend"></canvas></div>
                        </div>
                        <div>
                            <h5 class="font-semibold mb-2">Top/Bottom Performers</h5>
                            <div class="chart-container"><canvas id="chart-top-bottom"></canvas></div>
                        </div>
                        <div>
                            <h5 class="font-semibold mb-2">Performance by Source</h5>
                            <div class="chart-container"><canvas id="chart-perf-source"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="analytics-content-inventory" class="hidden">
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Inventory Turnover</div><div id="metric-turnover" class="text-lg font-bold">0</div></div>
                        <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Success Rate</div><div id="metric-success-rate" class="text-lg font-bold">0%</div></div>
                    </div>
                    <div>
                        <h5 class="font-semibold mb-2">Aging Inventory</h5>
                        <div class="chart-container" style="height: 250px;"><canvas id="chart-aging-inventory"></canvas></div>
                    </div>
                    <div class="mt-4">
                        <h5 class="font-semibold mb-2">Action Required (60+ days)</h5>
                        <ul id="list-action-required" class="text-sm space-y-2"><li>-</li></ul>
                    </div>
                </div>

                <div id="analytics-content-performance" class="hidden">
                    <h5 class="font-semibold mb-2">Category Winners</h5>
                    <div class="space-y-2 mb-4 text-sm">
                        <p><strong>Best Source:</strong> <span id="insight-best-source">-</span></p>
                        <p><strong>Best Model Type:</strong> <span id="insight-best-model">-</span></p>
                        <p><strong>Best Price Range:</strong> <span id="insight-best-range">-</span></p>
                    </div>
                    <h5 class="font-semibold mb-2">ü•á Top 5 Most Profitable Bikes</h5>
                    <ul id="list-top-bikes" class="space-y-2"><li>-</li></ul>
                    <h5 class="font-semibold mb-2 mt-4">üîª Bottom 5 Bikes (Losses)</h5>
                    <ul id="list-bottom-bikes" class="space-y-2"><li>-</li></ul>
                </div>

            </div>
            
            <!-- Settings View -->
            <div id="view-settings" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Settings</h2>
                
                <!-- Gist Configuration -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">Gist Configuration</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="settings-gist-id" class="block text-sm font-medium text-gray-700">Gist ID*</label>
                            <input type="text" id="settings-gist-id" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 text-sm">
                        </div>
                        <div>
                            <label for="settings-gist-token" class="block text-sm font-medium text-gray-700">GitHub Personal Access Token*</label>
                            <input type="password" id="settings-gist-token" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 text-sm">
                        </div>
                        <button id="btn-save-settings" class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium">Save & Test Connection</button>
                    </div>
                </div>

                <!-- App Settings -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">App Settings</h3>
                    <div class="space-y-3">
                        <!-- Theme, Currency, etc. -->
                        <div>
                            <label for="settings-currency" class="block text-sm font-medium text-gray-700">Currency Symbol</label>
                            <select id="settings-currency" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 text-sm">
                                <option>‚Çπ</option>
                                <option>$</option>
                                <option>‚Ç¨</option>
                                <option>¬£</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Data Management -->
                <div>
                    <h3 class="text-lg font-semibold mb-2">Data Management</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="btn-export-all-json" class="bg-gray-200 text-gray-800 py-2 rounded-lg text-sm">Export All (JSON)</button>
                        <button id="btn-clear-cache" class="bg-gray-200 text-gray-800 py-2 rounded-lg text-sm">Clear Local Cache</button>
                        <button id="btn-force-download" class="bg-red-100 text-red-700 py-2 rounded-lg text-sm col-span-2">Force Download (Overwrite Local)</button>
                        <button id="btn-force-upload" class="bg-yellow-100 text-yellow-700 py-2 rounded-lg text-sm col-span-2">Force Upload (Overwrite Gist)</button>
                    </div>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-4xl mx-auto bg-white border-t border-gray-200 flex justify-around py-2 z-40">
            <button class="nav-btn flex flex-col items-center text-blue-600" data-view="inventory">
                <i data-lucide="layout-list"></i>
                <span class="text-xs">Inventory</span>
            </button>
            <button class="nav-btn flex flex-col items-center text-gray-500" data-view="analytics">
                <i data-lucide="bar-chart-3"></i>
                <span class="text-xs">Analytics</span>
            </button>
        </nav>

        <!-- 6. Floating Action Button -->
        <button id="btn-show-add-bike" class="fixed bottom-20 right-5 bg-blue-600 text-white p-4 rounded-full shadow-lg z-30">
            <i data-lucide="plus"></i>
        </button>
    </div>

    <!-- Modals & Overlays -->

    <!-- Add/Edit Bike Bottom Sheet -->
    <div id="modal-add-bike" class="bottom-sheet fixed inset-0 bg-black bg-opacity-50 z-50 hidden" data-modal-id="add-bike">
        <div class="absolute bottom-0 left-0 right-0 max-w-4xl mx-auto bg-white rounded-t-lg p-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="add-bike-title" class="text-xl font-semibold">Add New Bike</h3>
                <button class="btn-close-modal"><i data-lucide="x"></i></button>
            </div>
            <form id="form-add-bike" class="space-y-3">
                <input type="hidden" id="bike-id">
                <!-- Quick Add Fields -->
                <div>
                    <label for="bike-plate" class="block text-sm font-medium text-gray-700">Bike Plate*</label>
                    <input type="text" id="bike-plate" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 uppercase" placeholder="GJ01AB1234">
                </div>
                <div>
                    <label for="bike-owner" class="block text-sm font-medium text-gray-700">Owner Name*</label>
                    <input type="text" id="bike-owner" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2" placeholder="Rajesh Kumar">
                </div>
                <div>
                    <label for="bike-purchase-price" class="block text-sm font-medium text-gray-700">Purchase Price*</label>
                    <input type="number" id="bike-purchase-price" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2" placeholder="35000">
                </div>
                <div>
                    <label for="bike-purchase-date" class="block text-sm font-medium text-gray-700">Purchase Date*</label>
                    <input type="date" id="bike-purchase-date" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2">
                </div>

                <!-- Full Add Fields (Collapsible) -->
                <button type="button" id="btn-toggle-full-form" class="text-sm text-blue-600">Show More Details...</button>
                <div id="full-form-fields" class="hidden space-y-3 pt-2 border-t">
                    <div>
                        <label for="bike-model" class="block text-sm font-medium text-gray-700">Model</label>
                        <input type="text" id="bike-model" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2" placeholder="Hero Splendor">
                    </div>
                    <div>
                        <label for="bike-repair-cost" class="block text-sm font-medium text-gray-700">Repair Cost</label>
                        <input type="number" id="bike-repair-cost" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2" placeholder="5000">
                    </div>
                    <div>
                        <label for="bike-other-expenses" class="block text-sm font-medium text-gray-700">Other Expenses</label>
                        <input type="number" id="bike-other-expenses" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2" placeholder="1000">
                    </div>
                    <div>
                        <label for="bike-source" class="block text-sm font-medium text-gray-700">Source</label>
                        <select id="bike-source" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2">
                            <option>Direct Owner</option>
                            <option>Dealer</option>
                            <option>Auction</option>
                            <option>Trade-in</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="bike-notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea id="bike-notes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2" maxlength="200"></textarea>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium">Save Bike</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Mark Sold Bottom Sheet -->
    <div id="modal-mark-sold" class="bottom-sheet fixed inset-0 bg-black bg-opacity-50 z-50 hidden" data-modal-id="mark-sold">
        <div class="absolute bottom-0 left-0 right-0 max-w-4xl mx-auto bg-white rounded-t-lg p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Mark as Sold</h3>
                <button class="btn-close-modal"><i data-lucide="x"></i></button>
            </div>
            <form id="form-mark-sold" class="space-y-3">
                <input type="hidden" id="sold-bike-id">
                <h4 id="sold-bike-info" class="font-medium text-gray-800"></h4>
                <div>
                    <label for="bike-selling-price" class="block text-sm font-medium text-gray-700">Selling Price*</label>
                    <input type="number" id="bike-selling-price" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2" placeholder="48000">
                </div>
                <div>
                    <label for="bike-selling-date" class="block text-sm font-medium text-gray-700">Selling Date*</label>
                    <input type="date" id="bike-selling-date" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2">
                </div>
                <div class="pt-4">
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-medium">Save Sale</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="modal-export" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center" data-modal-id="export">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Export Data</h3>
                <button class="btn-close-modal"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-3">
                <h4 class="font-medium">CSV Export</h4>
                <button id="btn-export-csv-view" class="w-full text-left bg-gray-100 p-3 rounded-lg">Current View</button>
                <button id="btn-export-csv-month" class="w-full text-left bg-gray-100 p-3 rounded-lg">This Month</button>
                <button id="btn-export-csv-all" class="w-full text-left bg-gray-100 p-3 rounded-lg">All Data</button>
                
                <h4 class="font-medium pt-3 border-t">PDF Report</h4>
                <button id="btn-export-pdf-month" class="w-full text-left bg-gray-100 p-3 rounded-lg">Monthly PDF Report</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 z-[99] hidden items-center justify-center">
        <div class="flex flex-col items-center">
            <i data-lucide="loader-2" class="w-10 h-10 text-blue-600 animate-spin"></i>
            <span id="loading-text" class="mt-2 text-gray-700">Loading...</span>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast fixed bottom-24 right-5 bg-gray-900 text-white py-3 px-5 rounded-lg shadow-lg z-50 flex items-center">
        <span id="toast-message">Message</span>
        <button id="toast-undo" class="ml-4 text-blue-400 font-medium hidden">Undo</button>
    </div>

    <!-- JavaScript Application Logic -->
    <script type="module">
        // Initialize Icons
        lucide.createIcons();

        // --- STATE MANAGEMENT ---
        const GIST_API_URL = "https://api.github.com/gists/";
        let db = {
            settings: {
                gistId: null,
                gistToken: null,
                currency: "‚Çπ",
                lastSync: null,
                filenamePrefix: "bikes"
            },
            metadata: {
                version: "1.0",
                lastUpdated: null,
                currentMonth: "2024-01", // Initial, will be set
                availableMonths: [],
                settings: {} // From prompt, but we'll store ours in db.settings
            },
            bikes: {
                // "2024-11": [ { bike... } ]
            },
            pendingChanges: {
                // "2024-11": { action: 'update', content: [...] }
                // "metadata": { action: 'update', content: {...} }
            }
        };

        let uiState = {
            currentView: "inventory", // inventory, analytics, settings
            currentAnalyticsTab: "financial",
            currentMonthDisplay: "2024-11", // YYYY-MM
            currentInventoryView: "this-month", // this-month, 3-months
            loadedMonths: [], // e.g., ["2024-11", "2024-10"]
            syncState: "offline", // offline, syncing, synced, error
            filter: {
                status: "all", // all, unsold, sold
                sort: "newest",
                search: "",
                chip: null
            },
            charts: {} // To hold chart instances
        };

        // --- DOM ELEMENTS ---
        const el = {
            app: document.getElementById("app"),
            views: {
                inventory: document.getElementById("view-inventory"),
                analytics: document.getElementById("view-analytics"),
                settings: document.getElementById("view-settings"),
            },
            navButtons: document.querySelectorAll(".nav-btn"),
            syncStatus: document.getElementById("sync-status"),
            bikeList: document.getElementById("bike-list"),
            emptyListMsg: document.getElementById("empty-list-msg"),
            statsGrid: document.getElementById("stats-grid"),
            fab: document.getElementById("btn-show-add-bike"),
            // Modals
            modals: {
                addBike: document.getElementById("modal-add-bike"),
                markSold: document.getElementById("modal-mark-sold"),
                export: document.getElementById("modal-export"),
            },
            loadingOverlay: document.getElementById("loading-overlay"),
            loadingText: document.getElementById("loading-text"),
            toast: document.getElementById("toast"),
            toastMessage: document.getElementById("toast-message"),
            toastUndo: document.getElementById("toast-undo"),
            // Settings
            settingsBtn: document.getElementById("btn-show-settings"),
            settingsGistId: document.getElementById("settings-gist-id"),
            settingsGistToken: document.getElementById("settings-gist-token"),
            settingsSaveBtn: document.getElementById("btn-save-settings"),
            settingsCurrency: document.getElementById("settings-currency"),
            // Add/Edit Bike Form
            addBikeForm: document.getElementById("form-add-bike"),
            addBikeTitle: document.getElementById("add-bike-title"),
            toggleFullFormBtn: document.getElementById("btn-toggle-full-form"),
            fullFormFields: document.getElementById("full-form-fields"),
            bikeId: document.getElementById("bike-id"),
            // Mark Sold Form
            markSoldForm: document.getElementById("form-mark-sold"),
            soldBikeId: document.getElementById("sold-bike-id"),
            soldBikeInfo: document.getElementById("sold-bike-info"),
            // Month Navigator
            monthNavTitle: document.getElementById("month-navigator-title"),
            monthNavSummary: document.getElementById("month-navigator-summary"),
            prevMonthBtn: document.getElementById("btn-prev-month"),
            nextMonthBtn: document.getElementById("btn-next-month"),
            jumpTodayBtn: document.getElementById("btn-jump-today"),
            viewToggleThisMonth: document.getElementById("btn-view-toggle-this-month"),
            viewToggle3Months: document.getElementById("btn-view-toggle-3-months"),
            // Filters
            searchBox: document.getElementById("search-box"),
            sortSelect: document.getElementById("sort-select"),
            // Analytics
            analyticsTabButtons: document.querySelectorAll(".analytics-tab-btn"),
            analyticsContent: {
                financial: document.getElementById("analytics-content-financial"),
                inventory: document.getElementById("analytics-content-inventory"),
                performance: document.getElementById("analytics-content-performance"),
            },
            keyInsightsList: document.getElementById("key-insights-list"),
            loadAllAnalyticsBtn: document.getElementById("btn-load-all-analytics"),
            analyticsScopeMsg: document.getElementById("analytics-scope-msg"),
            // Export
            exportCsvViewBtn: document.getElementById("btn-export-csv-view"),
            exportCsvMonthBtn: document.getElementById("btn-export-csv-month"),
            exportCsvAllBtn: document.getElementById("btn-export-csv-all"),
            exportPdfMonthBtn: document.getElementById("btn-export-pdf-month"),
            // Data Management
            clearCacheBtn: document.getElementById("btn-clear-cache"),
            forceDownloadBtn: document.getElementById("btn-force-download"),
            forceUploadBtn: document.getElementById("btn-force-upload"),
        };
        
        // --- DATE & UTIL HELPERS ---
        const getToday = (format = "YYYY-MM-DD") => {
            const d = new Date();
            const YYYY = d.getFullYear();
            const MM = String(d.getMonth() + 1).padStart(2, '0');
            const DD = String(d.getDate()).padStart(2, '0');
            if (format === "YYYY-MM-DD") return `${YYYY}-${MM}-${DD}`;
            if (format === "YYYY-MM") return `${YYYY}-${MM}`;
            if (format === "long") return d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            return d;
        };
        
        const getMonthFromDate = (dateStr) => dateStr.substring(0, 7); // "2024-11-01" -> "2024-11"
        
        const formatMonthYear = (monthStr) => { // "2024-11"
            const [year, month] = monthStr.split('-').map(Number);
            const d = new Date(year, month - 1);
            return d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        };

        const addMonths = (monthStr, num) => {
            const [year, month] = monthStr.split('-').map(Number);
            const d = new Date(year, month - 1);
            d.setMonth(d.getMonth() + num);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        };
        
        const formatCurrency = (val) => {
            return `${db.settings.currency}${Number(val || 0).toLocaleString('en-IN')}`;
        };
        
        const getDaysBetween = (date1, date2) => {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            if (isNaN(d1) || isNaN(d2)) return 0;
            return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
        };
        
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // --- GIST API & SYNC LOGIC ---

        /**
         * Generic fetch wrapper for Gist API
         */
        const gistFetch = async (url, options = {}) => {
            const { gistId, gistToken } = db.settings;
            if (!gistId || !gistToken) {
                console.error("Gist ID or Token not set.");
                showToast("Error: Gist ID or Token not set.", "error");
                setSyncState("error");
                return null;
            }

            const headers = {
                "Accept": "application/vnd.github.v3+json",
                "Authorization": `token ${gistToken}`,
                "X-GitHub-Api-Version": "2022-11-28"
            };

            if (options.method === 'PATCH' || options.method === 'POST') {
                headers["Content-Type"] = "application/json";
            }
            
            try {
                const response = await fetch(url, { ...options, headers });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gist API Error:", errorData.message);
                    setSyncState("error");
                    showToast(`Sync Error: ${errorData.message}`, "error");
                    if (response.status === 404) return { status: 404, data: null };
                    if (response.status === 401) showToast("Sync Error: Invalid Token", "error");
                    return null;
                }
                
                // 204 No Content (e.g., successful PATCH)
                if (response.status === 204) return { status: 204, data: true };
                
                const data = await response.json();
                return { status: response.status, data };

            } catch (err) {
                console.error("Fetch Error:", err);
                setSyncState("offline");
                showToast("Sync Error: Network offline", "error");
                return null;
            }
        };

        /**
         * Fetches a single file or the whole Gist
         */
        const getGistFile = async (filename = null) => {
            const { gistId } = db.settings;
            const url = `${GIST_API_URL}${gistId}`;
            
            const response = await gistFetch(url);
            if (!response || !response.data) return null;

            const gist = response.data;
            // Update metadata's lastUpdated from Gist itself
            db.metadata.lastUpdated = gist.updated_at;

            if (filename) {
                if (gist.files[filename]) {
                    return JSON.parse(gist.files[filename].content);
                } else {
                    console.warn(`File ${filename} not found in Gist.`);
                    return null; // File not found
                }
            }
            return gist; // Return whole Gist object
        };

        /**
         * Updates one or more files in the Gist
         */
        const updateGistFiles = async (filesToUpdate) => {
            // filesToUpdate = { "filename.json": { content: "..." } }
            const { gistId } = db.settings;
            const url = `${GIST_API_URL}${gistId}`;
            
            setSyncState("syncing");
            
            const response = await gistFetch(url, {
                method: "PATCH",
                body: JSON.stringify({ files: filesToUpdate })
            });

            if (response && (response.status === 200 || response.status === 204)) {
                setSyncState("synced");
                db.settings.lastSync = new Date().toISOString();
                saveLocal("settings");
                // Update metadata lastUpdated from response if available
                if (response.data && response.data.updated_at) {
                    db.metadata.lastUpdated = response.data.updated_at;
                }
                return true;
            }
            setSyncState("error");
            return false;
        };

        const setSyncState = (state) => {
            uiState.syncState = state;
            let html = "";
            switch (state) {
                case "synced":
                    html = `<i data-lucide="check-circle-2" class="w-4 h-4 text-green-500 mr-1"></i> Synced`;
                    break;
                case "syncing":
                    html = `<i data-lucide="loader-2" class="w-4 h-4 text-blue-500 mr-1 animate-spin"></i> Syncing...`;
                    break;
                case "error":
                    html = `<i data-lucide="alert-triangle" class="w-4 h-4 text-red-500 mr-1"></i> Error`;
                    break;
                case "offline":
                    html = `<i data-lucide="wifi-off" class="w-4 h-4 text-gray-500 mr-1"></i> Offline`;
                    break;
            }
            el.syncStatus.innerHTML = html;
            lucide.createIcons();
        };

        /**
         * Debounced function to sync all pending changes
         */
        const syncPendingChanges = debounce(async () => {
            if (Object.keys(db.pendingChanges).length === 0) {
                console.log("No pending changes to sync.");
                return;
            }

            setSyncState("syncing");
            showToast("Syncing changes...", "info", 2000);

            const filesToUpdate = {};
            
            // 1. Prepare metadata update
            const metadataFile = `${db.settings.filenamePrefix}_metadata.json`;
            db.metadata.lastUpdated = new Date().toISOString();
            db.metadata.availableMonths = Object.keys(db.bikes).sort();
            db.metadata.currentMonth = getToday("YYYY-MM");
            
            filesToUpdate[metadataFile] = {
                content: JSON.stringify(db.metadata, null, 2)
            };
            
            // 2. Prepare bike month files
            for (const month of db.metadata.availableMonths) {
                // Check if this month is in pending changes, or just ensure it exists
                if (db.pendingChanges[month] || !db.metadata.availableMonths.includes(month)) {
                     const monthFilename = `${db.settings.filenamePrefix}_${month}.json`;
                     const monthData = {
                        month: month,
                        bikes: db.bikes[month] || []
                     };
                     filesToUpdate[monthFilename] = {
                        content: JSON.stringify(monthData, null, 2)
                     };
                }
            }

            // 3. Sync
            const success = await updateGistFiles(filesToUpdate);

            if (success) {
                db.pendingChanges = {};
                saveLocal("pendingChanges");
                showToast("Sync complete!", "success", 2000);
            } else {
                showToast("Sync failed. Changes saved locally.", "error");
            }
        }, 10000); // 10-second debounce

        /**
         * Queue a change for syncing
         */
        const queueChange = (month, changeData) => {
            // Simple queue: just mark the month as dirty
            // The sync function will grab the whole month's data
            db.pendingChanges[month] = { status: "dirty" };
            saveLocal("pendingChanges");
            setSyncState("syncing"); // Show immediate feedback
            syncPendingChanges();
        };


        // --- LOCAL STORAGE ---
        const saveLocal = (key) => {
            try {
                localStorage.setItem(`bikeInv_${key}`, JSON.stringify(db[key]));
            } catch (e) {
                console.error("Failed to save to localStorage", e);
            }
        };

        const loadLocal = () => {
            try {
                const settings = localStorage.getItem("bikeInv_settings");
                if (settings) db.settings = { ...db.settings, ...JSON.parse(settings) };
                
                const metadata = localStorage.getItem("bikeInv_metadata");
                if (metadata) db.metadata = JSON.parse(metadata);
                
                const bikes = localStorage.getItem("bikeInv_bikes");
                if (bikes) db.bikes = JSON.parse(bikes);
                
                const pendingChanges = localStorage.getItem("bikeInv_pendingChanges");
                if (pendingChanges) db.pendingChanges = JSON.parse(pendingChanges);

                return true;
            } catch (e) {
                console.error("Failed to load from localStorage", e);
                return false;
            }
        };
        
        const clearLocalCache = () => {
            if (window.confirm("This will delete all local data. Are you sure?")) {
                localStorage.removeItem("bikeInv_settings");
                localStorage.removeItem("bikeInv_metadata");
                localStorage.removeItem("bikeInv_bikes");
                localStorage.removeItem("bikeInv_pendingChanges");
                window.location.reload();
            }
        };

        // --- CORE APP LOGIC ---

        /**
         * Initial load on app start
         */
        const initialLoad = async () => {
            showLoading("Initializing...");
            loadLocal();
            
            // Update UI from local settings first
            el.settingsGistId.value = db.settings.gistId || "";
            el.settingsGistToken.value = db.settings.gistToken || "";
            el.settingsCurrency.value = db.settings.currency || "‚Çπ";

            if (!db.settings.gistId || !db.settings.gistToken) {
                showToast("Please set Gist ID and Token", "info");
                switchMainView("settings");
                hideLoading();
                return;
            }

            setSyncState("syncing");
            
            // 1. Fetch metadata
            showLoading("Syncing metadata...");
            const metadataFile = `${db.settings.filenamePrefix}_metadata.json`;
            const metadata = await getGistFile(metadataFile);
            
            if (metadata) {
                db.metadata = metadata;
                saveLocal("metadata");
                uiState.loadedMonths.push("metadata");
            } else if (metadata === null) {
                // Check if it was a 404 (not found) vs. other error
                const gist = await getGistFile(); // Get whole gist to check
                if (gist && gist.files && !gist.files[metadataFile]) {
                    // File doesn't exist. This is a new Gist.
                    showToast("New Gist. Creating metadata file.", "info");
                    await createInitialMetadata();
                } else {
                    // Other error (auth, network)
                    setSyncState("error");
                    hideLoading();
                    return;
                }
            }
            
            // 2. Set current month and load it
            const currentMonth = db.metadata.currentMonth || getToday("YYYY-MM");
            uiState.currentMonthDisplay = currentMonth;
            
            showLoading(`Loading ${formatMonthYear(currentMonth)}...`);
            await loadMonth(currentMonth);

            // 3. Load previous month
            const prevMonth = addMonths(currentMonth, -1);
            showLoading(`Loading ${formatMonthYear(prevMonth)}...`);
            await loadMonth(prevMonth);
            
            // Sync any pending changes from last session
            if (Object.keys(db.pendingChanges).length > 0) {
                showToast("Syncing pending local changes...", "info");
                syncPendingChanges(); // Don't await, let it run in background
            } else {
                setSyncState("synced");
            }

            hideLoading();
            renderApp();
        };
        
        const createInitialMetadata = async () => {
            const metadataFile = `${db.settings.filenamePrefix}_metadata.json`;
            const currentMonth = getToday("YYYY-MM");
            db.metadata = {
                version: "1.0",
                lastUpdated: new Date().toISOString(),
                currentMonth: currentMonth,
                availableMonths: [], // Will be populated as bikes are added
                settings: {
                    gistId: db.settings.gistId,
                    defaultMargin: 15 // As per prompt
                }
            };
            const success = await updateGistFiles({
                [metadataFile]: { content: JSON.stringify(db.metadata, null, 2) }
            });
            if (success) {
                saveLocal("metadata");
            }
        };

        /**
         * Lazy-loads a specific month from Gist if not already in state
         */
        const loadMonth = async (month) => {
            if (uiState.loadedMonths.includes(month)) {
                return true; // Already loaded
            }
            
            setSyncState("syncing");
            const filename = `${db.settings.filenamePrefix}_${month}.json`;
            const monthData = await getGistFile(filename);
            
            if (monthData) {
                // Gist file found
                db.bikes[month] = monthData.bikes || [];
                saveLocal("bikes");
                uiState.loadedMonths.push(month);
                setSyncState("synced");
                return true;
            } else {
                // File not found on Gist - could be a new month
                console.warn(`File ${filename} not found. Assuming empty month.`);
                db.bikes[month] = []; // Create empty array
                uiState.loadedMonths.push(month); // Mark as "loaded"
                setSyncState("synced");
                return false;
            }
        };
        
        // --- BIKE DATA HELPERS ---
        const getBikeHelpers = (bike) => {
            const purchasePrice = Number(bike.purchasePrice) || 0;
            const repairCost = Number(bike.repairCost) || 0;
            const otherExpenses = Number(bike.otherExpenses) || 0;
            const investment = purchasePrice + repairCost + otherExpenses;
            
            let profit = 0, margin = 0, daysHeld = 0;
            const today = getToday("YYYY-MM-DD");
            
            if (bike.isSold) {
                const sellingPrice = Number(bike.sellingPrice) || 0;
                profit = sellingPrice - investment;
                margin = investment > 0 ? (profit / investment) * 100 : 0;
                daysHeld = getDaysBetween(bike.datePurchase, bike.dateSelling);
            } else {
                daysHeld = getDaysBetween(bike.datePurchase, today);
            }
            
            const agingDays = daysHeld;
            let agingColor = "green"; // 0-30
            let agingEmoji = "üü¢";
            if (agingDays > 90) { agingColor = "red"; agingEmoji = "üî¥"; }
            else if (agingDays > 60) { agingColor = "orange"; agingEmoji = "üü†"; }
            else if (agingDays > 30) { agingColor = "yellow"; agingEmoji = "üü°"; }

            return {
                purchasePrice,
                repairCost,
                otherExpenses,
                investment,
                profit,
                margin,
                daysHeld,
                agingDays,
                agingColor,
                agingEmoji
            };
        };
        
        const getBikesForView = () => {
            let bikes = [];
            let monthsToView = [];

            if (uiState.currentInventoryView === 'this-month') {
                monthsToView = [uiState.currentMonthDisplay];
            } else { // 3-months
                monthsToView = [
                    uiState.currentMonthDisplay,
                    addMonths(uiState.currentMonthDisplay, -1),
                    addMonths(uiState.currentMonthDisplay, -2)
                ];
            }
            
            monthsToView.forEach(month => {
                if (db.bikes[month]) {
                    bikes = bikes.concat(db.bikes[month]);
                }
            });
            
            // Now, filter and sort
            const { status, sort, search, chip } = uiState.filter;
            const searchLower = search.toLowerCase();

            const filtered = bikes.filter(b => {
                // Status Filter
                if (status === "sold" && !b.isSold) return false;
                if (status === "unsold" && b.isSold) return false;
                
                // Search Filter
                if (searchLower) {
                    const plate = b.plate || "";
                    const owner = b.owner || "";
                    const model = b.model || "";
                    if (!plate.toLowerCase().includes(searchLower) &&
                        !owner.toLowerCase().includes(searchLower) &&
                        !model.toLowerCase().includes(searchLower)) {
                        return false;
                    }
                }
                
                // Chip Filter
                if (chip) {
                    const stats = getBikeHelpers(b);
                    if (chip === "aging" && (stats.agingDays <= 60 || b.isSold)) return false;
                    if (chip === "critical" && (stats.agingDays <= 90 || b.isSold)) return false;
                    if (chip === "high-value" && (stats.investment <= 50000 || b.isSold)) return false;
                }

                return true;
            });

            // Sort
            filtered.sort((a, b) => {
                const statsA = getBikeHelpers(a);
                const statsB = getBikeHelpers(b);
                
                switch (sort) {
                    case "oldest":
                        return new Date(a.datePurchase) - new Date(b.datePurchase);
                    case "profit-hi":
                        return statsB.profit - statsA.profit;
                    case "profit-lo":
                        return statsA.profit - statsB.profit;
                    case "held-long":
                        return statsB.daysHeld - statsA.daysHeld;
                    case "newest":
                    default:
                        return new Date(b.datePurchase) - new Date(a.datePurchase);
                }
            });
            
            return filtered;
        };
        
        const getAllBikes = (filterSold = null) => {
            let allBikes = [];
            Object.values(db.bikes).forEach(monthBikes => {
                allBikes = allBikes.concat(monthBikes);
            });
            
            if (filterSold === true) return allBikes.filter(b => b.isSold);
            if (filterSold === false) return allBikes.filter(b => !b.isSold);
            return allBikes;
        };

        // --- RENDER FUNCTIONS ---
        
        /**
         * Main render loop
         */
        const renderApp = () => {
            if (uiState.currentView === 'inventory') {
                renderMonthNavigator();
                renderBikeList();
                renderStatsGrid();
            } else if (uiState.currentView === 'analytics') {
                renderAnalytics();
            }
        };

        const renderMonthNavigator = () => {
            el.monthNavTitle.textContent = formatMonthYear(uiState.currentMonthDisplay);
            
            const bikes = db.bikes[uiState.currentMonthDisplay] || [];
            const sold = bikes.filter(b => b.isSold).length;
            const unsold = bikes.length - sold;
            el.monthNavSummary.textContent = `Showing: ${bikes.length} bikes (${sold} sold, ${unsold} unsold)`;
        };

        const renderBikeList = () => {
            const bikes = getBikesForView();
            
            if (bikes.length === 0) {
                el.emptyListMsg.classList.remove("hidden");
                el.bikeList.innerHTML = "";
                return;
            }
            
            el.emptyListMsg.classList.add("hidden");
            el.bikeList.innerHTML = bikes.map(bike => {
                const stats = getBikeHelpers(bike);
                
                const statusHtml = bike.isSold
                    ? `<p class="text-sm font-semibold text-green-700">Profit: ${formatCurrency(stats.profit)} (${stats.margin.toFixed(0)}%)</p>`
                    : `<p class="text-sm font-semibold text-yellow-700">Investment: ${formatCurrency(stats.investment)}</p>`;
                
                const agingHtml = bike.isSold
                    ? `<span class="text-xs font-medium bg-gray-100 text-gray-700 px-2 py-1 rounded-full">Sold: ${stats.daysHeld}d</span>`
                    : `<span class="text-xs font-medium bg-${stats.agingColor}-100 text-${stats.agingColor}-800 px-2 py-1 rounded-full">${stats.agingEmoji} ${stats.agingDays}d</span>`;
                
                const buttonsHtml = bike.isSold
                    ? `<button class="btn-edit-bike text-sm text-blue-600 font-medium" data-id="${bike.id}">‚úèÔ∏è View</button>
                       <button class="btn-mark-unsold text-sm text-yellow-600 font-medium" data-id="${bike.id}">‚Ü©Ô∏è Un-sell</button>
                       <button class="btn-delete-bike text-sm text-red-600 font-medium" data-id="${bike.id}">üóëÔ∏è Delete</button>`
                    : `<button class="btn-edit-bike text-sm text-blue-600 font-medium" data-id="${bike.id}">‚úèÔ∏è Edit</button>
                       <button class="btn-mark-sold text-sm text-green-600 font-medium" data-id="${bike.id}">‚úÖ Sold</button>
                       <button class="btn-delete-bike text-sm text-red-600 font-medium" data-id="${bike.id}">üóëÔ∏è Delete</button>`;

                return `
                <div class="swipe-card-container relative" data-id="${bike.id}">
                    <!-- Swipe Actions (Hidden) -->
                    <div class="swipe-actions absolute inset-y-0 left-0 right-0 flex justify-between items-center px-4 rounded-lg">
                        <button class="btn-mark-sold bg-green-500 text-white p-4 rounded-full" data-id="${bike.id}"><i data-lucide="check"></i></button>
                        <button class="btn-delete-bike bg-red-500 text-white p-4 rounded-full" data-id="${bike.id}"><i data-lucide="trash-2"></i></button>
                    </div>
                
                    <!-- Bike Card -->
                    <div class="swipe-card bg-white border border-gray-200 rounded-lg shadow-sm p-4 relative" data-id="${bike.id}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-lg text-gray-900">${bike.plate}</h4>
                                <p class="text-sm text-gray-600">${bike.model || 'N/A'}</p>
                                <p class="text-sm text-gray-500">${bike.owner || 'N/A'}</p>
                            </div>
                            ${agingHtml}
                        </div>
                        <div>
                            ${statusHtml}
                        </div>
                        <div class="flex space-x-4 mt-3 border-t border-gray-100 pt-3">
                            ${buttonsHtml}
                        </div>
                    </div>
                </div>
                `;
            }).join("");
            
            // Re-create icons
            lucide.createIcons();
        };

        const renderStatsGrid = () => {
            // 1. This Month Stats
            const thisMonthBikes = db.bikes[uiState.currentMonthDisplay] || [];
            const lastMonthBikes = db.bikes[addMonths(uiState.currentMonthDisplay, -1)] || [];
            
            const calcMonthProfit = (bikes) => bikes.filter(b => b.isSold).reduce((sum, b) => sum + getBikeHelpers(b).profit, 0);
            
            const thisMonthProfit = calcMonthProfit(thisMonthBikes);
            const lastMonthProfit = calcMonthProfit(lastMonthBikes);
            const profitDiff = thisMonthProfit - lastMonthProfit;
            const profitArrow = profitDiff > 0 ? '‚Üë' : (profitDiff < 0 ? '‚Üì' : '');
            
            const thisMonthSold = thisMonthBikes.filter(b => b.isSold);
            const thisMonthUnsold = thisMonthBikes.filter(b => !b.isSold);
            
            const thisMonthInvest = thisMonthSold.reduce((sum, b) => sum + getBikeHelpers(b).investment, 0);
            const thisMonthROI = thisMonthInvest > 0 ? (thisMonthProfit / thisMonthInvest) * 100 : 0;

            // 2. All-Time Stats
            const allSoldBikes = getAllBikes(true);
            const allUnsoldBikes = getAllBikes(false);
            
            const totalProfit = allSoldBikes.reduce((sum, b) => sum + getBikeHelpers(b).profit, 0);
            const totalUnsoldInvest = allUnsoldBikes.reduce((sum, b) => sum + getBikeHelpers(b).investment, 0);
            const totalSales = allSoldBikes.length;
            
            const avgProfit = totalSales > 0 ? totalProfit / totalSales : 0;
            const totalInvest = allSoldBikes.reduce((sum, b) => sum + getBikeHelpers(b).investment, 0);
            const avgMargin = totalInvest > 0 ? (totalProfit / totalInvest) * 100 : 0;
            
            const avgDaysToSell = totalSales > 0 ? allSoldBikes.reduce((sum, b) => sum + getBikeHelpers(b).daysHeld, 0) / totalSales : 0;

            const gridHtml = `
                <!-- Row 1: This Month -->
                <div class="bg-blue-50 p-3 rounded-lg"><div class="text-xs text-blue-700">Month Profit</div><div class="text-lg font-bold text-blue-900">${formatCurrency(thisMonthProfit)} <span class="text-sm ${profitDiff >= 0 ? 'text-green-600' : 'text-red-600'}">${profitArrow}</span></div></div>
                <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Unsold (Month)</div><div class="text-lg font-bold">${thisMonthUnsold.length}</div></div>
                <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Sold (Month)</div><div class="text-lg font-bold">${thisMonthSold.length}</div></div>
                <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Month ROI</div><div class="text-lg font-bold">${thisMonthROI.toFixed(0)}%</div></div>
                <!-- Row 2: All-Time -->
                <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Total Profit</div><div class="text-lg font-bold">${formatCurrency(totalProfit)}</div></div>
                <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Unsold Invest.</div><div class="text-lg font-bold">${formatCurrency(totalUnsoldInvest)}</div></div>
                <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Avg Profit/Sale</div><div class="text-lg font-bold">${formatCurrency(avgProfit)}</div></div>
                <div class="bg-gray-50 p-3 rounded-lg"><div class="text-xs text-gray-500">Avg Days to Sell</div><div class="text-lg font-bold">${avgDaysToSell.toFixed(0)}d</div></div>
            `;
            el.statsGrid.innerHTML = gridHtml;
        };

        const renderAnalytics = () => {
            // Get data for analytics (default: last 3 months)
            let monthsToAnalyze = [
                uiState.currentMonthDisplay,
                addMonths(uiState.currentMonthDisplay, -1),
                addMonths(uiState.currentMonthDisplay, -2)
            ];
            
            // Check if user requested all data
            if (el.analyticsScopeMsg.textContent.includes("all available")) {
                monthsToAnalyze = db.metadata.availableMonths;
            }

            let bikesToAnalyze = [];
            monthsToAnalyze.forEach(month => {
                if (db.bikes[month]) {
                    bikesToAnalyze = bikesToAnalyze.concat(db.bikes[month]);
                }
            });
            
            const soldBikes = bikesToAnalyze.filter(b => b.isSold).map(b => ({ ...b, stats: getBikeHelpers(b) }));
            const unsoldBikes = bikesToAnalyze.filter(b => !b.isSold).map(b => ({ ...b, stats: getBikeHelpers(b) }));
            const allBikes = soldBikes.concat(unsoldBikes);
            
            if (allBikes.length === 0) {
                el.keyInsightsList.innerHTML = "<li>No data to analyze.</li>";
                return;
            }

            // --- CALCULATIONS ---
            
            // Key Insights
            const totalProfit = soldBikes.reduce((sum, b) => sum + b.stats.profit, 0);
            const avgProfit = soldBikes.length > 0 ? totalProfit / soldBikes.length : 0;
            const totalInvest = soldBikes.reduce((sum, b) => sum + b.stats.investment, 0);
            const avgROI = totalInvest > 0 ? (totalProfit / totalInvest) * 100 : 0;
            
            const criticalUnsold = unsoldBikes.filter(b => b.stats.agingDays > 60);
            const criticalInvestment = criticalUnsold.reduce((sum, b) => sum + b.stats.investment, 0);
            
            const avgDays = soldBikes.length > 0 ? soldBikes.reduce((sum, b) => sum + b.stats.daysHeld, 0) / soldBikes.length : 0;

            const profitBySource = {};
            soldBikes.forEach(b => {
                const source = b.source || "Other";
                if (!profitBySource[source]) profitBySource[source] = { total: 0, count: 0 };
                profitBySource[source].total += b.stats.profit;
                profitBySource[source].count++;
            });
            let bestSource = { name: "-", avg: 0 };
            Object.keys(profitBySource).forEach(key => {
                const avg = profitBySource[key].total / profitBySource[key].count;
                if (avg > bestSource.avg) {
                    bestSource = { name: key, avg: avg };
                }
            });
            
            el.keyInsightsList.innerHTML = `
                <li>üéØ Your average: <strong>${formatCurrency(avgProfit)}</strong> profit per bike (<strong>${avgROI.toFixed(0)}%</strong> ROI)</li>
                <li>‚ö†Ô∏è Alert: <strong>${formatCurrency(criticalInvestment)}</strong> locked in <strong>${criticalUnsold.length}</strong> bikes for 60+ days</li>
                <li>‚è±Ô∏è Typical sale time: <strong>${avgDays.toFixed(0)}</strong> days</li>
                <li>üîç Sweet spot: <strong>${bestSource.name}</strong> bikes = <strong>${formatCurrency(bestSource.avg)}</strong> avg profit</li>
            `;
            
            // --- TAB 1: Financial ---
            const allSoldBikesAllTime = getAllBikes(true).map(b => ({ ...b, stats: getBikeHelpers(b) }));
            const allUnsoldBikesAllTime = getAllBikes(false).map(b => ({ ...b, stats: getBikeHelpers(b) }));
            const allTimeTotalProfit = allSoldBikesAllTime.reduce((sum, b) => sum + b.stats.profit, 0);
            const thisMonthProfit = soldBikes.filter(b => getMonthFromDate(b.datePurchase) === uiState.currentMonthDisplay)
                                      .reduce((sum, b) => sum + b.stats.profit, 0);
            const capitalLocked = allUnsoldBikesAllTime.reduce((sum, b) => sum + b.stats.investment, 0);

            document.getElementById("metric-total-profit").textContent = formatCurrency(allTimeTotalProfit);
            document.getElementById("metric-this-month-profit").textContent = formatCurrency(thisMonthProfit);
            document.getElementById("metric-avg-profit").textContent = `${formatCurrency(avgProfit)} (${avgROI.toFixed(0)}%)`;
            document.getElementById("metric-capital-locked").textContent = `${formatCurrency(capitalLocked)} (${allUnsoldBikesAllTime.length} bikes)`;
            //... other metrics
            
            // Chart: Monthly Profit Trend
            const months = [...new Set(soldBikes.map(b => getMonthFromDate(b.dateSelling)))].sort().slice(-12);
            const profitByMonth = {};
            soldBikes.forEach(b => {
                const month = getMonthFromDate(b.dateSelling);
                if (!profitByMonth[month]) profitByMonth[month] = 0;
                profitByMonth[month] += b.stats.profit;
            });
            renderChart("chart-profit-trend", "line", {
                labels: months.map(m => formatMonthYear(m)),
                datasets: [{
                    label: "Monthly Profit",
                    data: months.map(m => profitByMonth[m] || 0),
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            });
            
            // Chart: Top/Bottom
            const sortedByProfit = [...soldBikes].sort((a, b) => b.stats.profit - a.stats.profit);
            const top5 = sortedByProfit.slice(0, 5).reverse(); // Reverse for bar chart
            const bottom5 = sortedByProfit.filter(b => b.stats.profit < 0).slice(-5);
            const topBottomData = [...bottom5, ...top5];
            
            renderChart("chart-top-bottom", "bar", {
                labels: topBottomData.map(b => b.plate),
                datasets: [{
                    label: "Profit/Loss",
                    data: topBottomData.map(b => b.stats.profit),
                    backgroundColor: topBottomData.map(b => b.stats.profit >= 0 ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)'),
                }]
            }, { indexAxis: 'y' });

            // --- TAB 2: Inventory ---
            // Chart: Aging Inventory
            const agingData = { "0-30": 0, "31-60": 0, "61-90": 0, "90+": 0 };
            unsoldBikes.forEach(b => {
                if (b.stats.agingDays <= 30) agingData["0-30"]++;
                else if (b.stats.agingDays <= 60) agingData["31-60"]++;
                else if (b.stats.agingDays <= 90) agingData["61-90"]++;
                else agingData["90+"]++;
            });
            renderChart("chart-aging-inventory", "doughnut", {
                labels: ["0-30 days", "31-60 days", "61-90 days", "90+ days"],
                datasets: [{
                    data: Object.values(agingData),
                    backgroundColor: ['rgb(74, 222, 128)', 'rgb(250, 204, 21)', 'rgb(249, 115, 22)', 'rgb(239, 68, 68)']
                }]
            }, { responsive: true, maintainAspectRatio: false });
            
            // List: Action Required
            const actionList = criticalUnsold.sort((a,b) => b.stats.agingDays - a.stats.agingDays)
                .map(b => `<li>üî¥ ${b.plate} (${b.model}): <strong>${b.stats.agingDays} days</strong> held, ${formatCurrency(b.stats.investment)}</li>`)
                .join("");
            document.getElementById("list-action-required").innerHTML = actionList || "<li>No bikes over 60 days.</li>";

            // --- TAB 3: Performance ---
            const top5List = top5.reverse()
                .map(b => `<li>ü•á ${b.plate} (${b.model}): <strong>${formatCurrency(b.stats.profit)}</strong> profit (${b.stats.margin.toFixed(0)}%)</li>`)
                .join("");
            document.getElementById("list-top-bikes").innerHTML = top5List || "<li>-</li>";
                
            const bottom5List = bottom5
                .map(b => `<li>üîª ${b.plate} (${b.model}): <strong>${formatCurrency(b.stats.profit)}</strong> loss</li>`)
                .join("");
            document.getElementById("list-bottom-bikes").innerHTML = bottom5List || "<li>-</li>";

            document.getElementById("insight-best-source").textContent = `${bestSource.name} (${formatCurrency(bestSource.avg)} avg)`;
        };

        const renderChart = (canvasId, type, data, options = {}) => {
            if (uiState.charts[canvasId]) {
                uiState.charts[canvasId].destroy();
            }
            const ctx = document.getElementById(canvasId).getContext('2d');
            uiState.charts[canvasId] = new Chart(ctx, { type, data, options });
        };


        // --- UI & MODAL CONTROLS ---

        const switchMainView = (view) => {
            uiState.currentView = view;
            Object.keys(el.views).forEach(key => {
                el.views[key].classList.add("hidden");
            });
            el.views[view].classList.remove("hidden");

            el.navButtons.forEach(btn => {
                if (btn.dataset.view === view) {
                    btn.classList.add("text-blue-600");
                    btn.classList.remove("text-gray-500");
                } else {
                    btn.classList.remove("text-blue-600");
                    btn.classList.add("text-gray-500");
                }
            });
            
            // Hide FAB on settings/analytics page
            if (view === "inventory") {
                el.fab.classList.remove("hidden");
            } else {
                el.fab.classList.add("hidden");
            }

            renderApp(); // Re-render
        };

        const showModal = (modalId) => {
            const modal = document.getElementById(`modal-${modalId}`);
            if (modal) {
                modal.classList.remove("hidden");
                modal.classList.add("flex", "items-center", "justify-center"); // For center modal
                if (modal.classList.contains("bottom-sheet")) {
                    modal.classList.remove("items-center", "justify-center");
                    setTimeout(() => modal.classList.add("is-open"), 10); // Animate in
                }
            }
        };

        const hideModal = () => {
            const openModal = document.querySelector(".bottom-sheet.is-open, .fixed.flex[data-modal-id]");
            if (openModal) {
                if (openModal.classList.contains("bottom-sheet")) {
                    openModal.classList.remove("is-open");
                    setTimeout(() => openModal.classList.add("hidden"), 300); // Wait for animation
                } else {
                    openModal.classList.add("hidden");
                    openModal.classList.remove("flex", "items-center", "justify-center");
                }
            }
        };

        const showLoading = (text = "Loading...") => {
            el.loadingText.textContent = text;
            el.loadingOverlay.classList.remove("hidden");
            el.loadingOverlay.classList.add("flex");
        };

        const hideLoading = () => {
            el.loadingOverlay.classList.add("hidden");
            el.loadingOverlay.classList.remove("flex");
        };

        let toastTimeout;
        const showToast = (message, type = "info", duration = 3000) => {
            clearTimeout(toastTimeout);
            
            el.toastMessage.textContent = message;
            el.toastUndo.classList.add("hidden");
            
            el.toast.classList.remove("bg-gray-900", "bg-red-600", "bg-green-600");
            if (type === "error") el.toast.classList.add("bg-red-600");
            else if (type === "success") el.toast.classList.add("bg-green-600");
            else el.toast.classList.add("bg-gray-900");

            el.toast.classList.add("is-visible");

            toastTimeout = setTimeout(() => {
                el.toast.classList.remove("is-visible");
            }, duration);
        };
        
        const showUndoToast = (message, undoCallback) => {
            showToast(message, "info", 5000);
            el.toastUndo.classList.remove("hidden");
            
            const undoHandler = () => {
                undoCallback();
                el.toast.classList.remove("is-visible");
                el.toastUndo.removeEventListener("click", undoHandler);
                clearTimeout(toastTimeout);
            };
            
            el.toastUndo.addEventListener("click", undoHandler, { once: true });
        };
        
        const doHapticFeedback = () => {
            el.app.classList.add("haptic-feedback");
            setTimeout(() => el.app.classList.remove("haptic-feedback"), 100);
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        };
        
        // --- EVENT HANDLERS ---
        
        // Navigation
        el.navButtons.forEach(btn => {
            btn.addEventListener("click", () => switchMainView(btn.dataset.view));
        });
        el.settingsBtn.addEventListener("click", () => switchMainView("settings"));
        
        // Modals
        document.querySelectorAll(".btn-close-modal").forEach(btn => {
            btn.addEventListener("click", hideModal);
        });
        document.querySelectorAll("[data-modal-id]").forEach(modal => {
            modal.addEventListener("click", (e) => {
                if (e.target === modal) hideModal(); // Click on backdrop
            });
        });
        
        // Settings
        el.settingsSaveBtn.addEventListener("click", () => {
            db.settings.gistId = el.settingsGistId.value.trim();
            db.settings.gistToken = el.settingsGistToken.value.trim();
            db.settings.currency = el.settingsCurrency.value;
            saveLocal("settings");
            showToast("Settings saved. Reloading...", "success");
            setTimeout(() => window.location.reload(), 1000);
        });
        
        el.clearCacheBtn.addEventListener("click", clearLocalCache);
        
        el.forceDownloadBtn.addEventListener("click", async () => {
            if (window.confirm("This will overwrite all local data with data from the Gist. Are you sure?")) {
                showLoading("Force downloading...");
                localStorage.removeItem("bikeInv_bikes"); // Clear local bikes
                db.bikes = {};
                uiState.loadedMonths = [];
                await initialLoad(); // Full re-load
                hideLoading();
                showToast("Download complete!", "success");
            }
        });
        
        el.forceUploadBtn.addEventListener("click", async () => {
            if (window.confirm("This will overwrite Gist data with your local data. Are you sure?")) {
                // Mark all loaded months as pending
                Object.keys(db.bikes).forEach(month => {
                    db.pendingChanges[month] = { status: "dirty" };
                });
                db.pendingChanges["metadata"] = { status: "dirty" };
                saveLocal("pendingChanges");
                syncPendingChanges.flush(); // Run debounced function immediately
            }
        });

        // Add/Edit Bike
        el.fab.addEventListener("click", () => {
            el.addBikeForm.reset();
            el.addBikeTitle.textContent = "Add New Bike";
            el.bikeId.value = "";
            el.fullFormFields.classList.add("hidden");
            el.toggleFullFormBtn.textContent = "Show More Details...";
            document.getElementById("bike-purchase-date").value = getToday("YYYY-MM-DD");
            showModal("add-bike");
        });
        
        el.toggleFullFormBtn.addEventListener("click", (e) => {
            e.preventDefault();
            const isHidden = el.fullFormFields.classList.contains("hidden");
            el.fullFormFields.classList.toggle("hidden");
            e.target.textContent = isHidden ? "Show Less Details..." : "Show More Details...";
        });
        
        el.addBikeForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const bikeData = {
                id: el.bikeId.value || `bike_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`,
                plate: document.getElementById("bike-plate").value.toUpperCase(),
                owner: document.getElementById("bike-owner").value,
                model: document.getElementById("bike-model").value,
                datePurchase: document.getElementById("bike-purchase-date").value,
                purchasePrice: Number(document.getElementById("bike-purchase-price").value),
                repairCost: Number(document.getElementById("bike-repair-cost").value),
                otherExpenses: Number(document.getElementById("bike-other-expenses").value),
                source: document.getElementById("bike-source").value,
                notes: document.getElementById("bike-notes").value,
                isSold: false, // Default
                dateSelling: null,
                sellingPrice: null
            };
            
            const month = getMonthFromDate(bikeData.datePurchase);
            const isEditing = !!el.bikeId.value;
            
            // Check if month exists
            if (!db.metadata.availableMonths.includes(month)) {
                if (window.confirm(`This bike's purchase date is in ${formatMonthYear(month)}. This will create a new file for that month. Continue?`)) {
                    // Auto-create new month
                    db.metadata.availableMonths.push(month);
                    db.metadata.availableMonths.sort();
                    db.bikes[month] = [];
                    queueChange("metadata", db.metadata);
                } else {
                    return; // User cancelled
                }
            }
            
            // Load month data if not already loaded (e.g., editing old bike)
            if (!uiState.loadedMonths.includes(month)) {
                showLoading(`Loading ${formatMonthYear(month)}...`);
                await loadMonth(month);
                hideLoading();
            }

            if (isEditing) {
                // Find and update
                let originalMonth = null;
                let bikeIndex = -1;
                
                // Find the bike across all loaded months
                for (const m of uiState.loadedMonths) {
                    if (db.bikes[m]) {
                        bikeIndex = db.bikes[m].findIndex(b => b.id === bikeData.id);
                        if (bikeIndex > -1) {
                            originalMonth = m;
                            // Keep sold data
                            const originalBike = db.bikes[m][bikeIndex];
                            bikeData.isSold = originalBike.isSold;
                            bikeData.dateSelling = originalBike.dateSelling;
                            bikeData.sellingPrice = originalBike.sellingPrice;
                            break;
                        }
                    }
                }
                
                if (originalMonth) {
                    // Check if month changed
                    if (originalMonth !== month) {
                        // Remove from old month
                        db.bikes[originalMonth].splice(bikeIndex, 1);
                        queueChange(originalMonth, db.bikes[originalMonth]);
                        // Add to new month
                        db.bikes[month].push(bikeData);
                        queueChange(month, db.bikes[month]);
                    } else {
                        // Update in same month
                        db.bikes[month][bikeIndex] = bikeData;
                        queueChange(month, db.bikes[month]);
                    }
                } else {
                    showToast("Error: Could not find bike to update.", "error");
                    return;
                }
                
            } else {
                // Add new bike
                db.bikes[month].push(bikeData);
                queueChange(month, db.bikes[month]);
            }

            saveLocal("bikes");
            doHapticFeedback();
            hideModal();
            renderApp();
            showToast(isEditing ? "Bike updated!" : "Bike added!", "success");
        });
        
        // Bike Card Actions (Event Delegation)
        el.bikeList.addEventListener("click", async (e) => {
            const bikeId = e.target.closest("[data-id]")?.dataset.id;
            if (!bikeId) return;
            
            const [month, bike] = findBikeById(bikeId);
            if (!bike) return;

            if (e.target.closest(".btn-edit-bike")) {
                el.addBikeForm.reset();
                el.addBikeTitle.textContent = "Edit Bike";
                el.bikeId.value = bike.id;
                
                document.getElementById("bike-plate").value = bike.plate || "";
                document.getElementById("bike-owner").value = bike.owner || "";
                document.getElementById("bike-model").value = bike.model || "";
                document.getElementById("bike-purchase-date").value = bike.datePurchase || "";
                document.getElementById("bike-purchase-price").value = bike.purchasePrice || "";
                document.getElementById("bike-repair-cost").value = bike.repairCost || "";
                document.getElementById("bike-other-expenses").value = bike.otherExpenses || "";
                document.getElementById("bike-source").value = bike.source || "Direct Owner";
                document.getElementById("bike-notes").value = bike.notes || "";
                
                el.fullFormFields.classList.remove("hidden");
                el.toggleFullFormBtn.textContent = "Show Less Details...";
                showModal("add-bike");
            }
            
            if (e.target.closest(".btn-mark-sold")) {
                el.markSoldForm.reset();
                el.soldBikeId.value = bike.id;
                el.soldBikeInfo.textContent = `${bike.plate} (${bike.model || 'N/A'})`;
                document.getElementById("bike-selling-date").value = getToday("YYYY-MM-DD");
                showModal("mark-sold");
            }
            
            if (e.target.closest(".btn-mark-unsold")) {
                if (window.confirm("Mark this bike as unsold?")) {
                    bike.isSold = false;
                    bike.dateSelling = null;
                    bike.sellingPrice = null;
                    queueChange(month, db.bikes[month]);
                    saveLocal("bikes");
                    renderApp();
                    showToast("Bike marked as unsold.", "info");
                }
            }
            
            if (e.target.closest(".btn-delete-bike")) {
                if (window.confirm(`Are you sure you want to delete ${bike.plate}? This cannot be undone.`)) {
                    const bikeIndex = db.bikes[month].findIndex(b => b.id === bikeId);
                    const deletedBike = db.bikes[month].splice(bikeIndex, 1)[0];
                    
                    queueChange(month, db.bikes[month]); // This queues the *current* state
                    saveLocal("bikes");
                    renderApp();
                    
                    // Show undo
                    showUndoToast("Bike deleted.", () => {
                        db.bikes[month].splice(bikeIndex, 0, deletedBike); // Add back
                        queueChange(month, db.bikes[month]);
                        saveLocal("bikes");
                        renderApp();
                    });
                }
            }
        });
        
        const findBikeById = (bikeId) => {
            for (const month of Object.keys(db.bikes)) {
                const bike = db.bikes[month].find(b => b.id === bikeId);
                if (bike) {
                    return [month, bike];
                }
            }
            return [null, null];
        };
        
        // Mark Sold Form
        el.markSoldForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const bikeId = el.soldBikeId.value;
            const sellingPrice = Number(document.getElementById("bike-selling-price").value);
            const dateSelling = document.getElementById("bike-selling-date").value;
            
            const [month, bike] = findBikeById(bikeId);
            
            if (bike && sellingPrice > 0 && dateSelling) {
                bike.isSold = true;
                bike.sellingPrice = sellingPrice;
                bike.dateSelling = dateSelling;
                
                queueChange(month, db.bikes[month]);
                saveLocal("bikes");
                doHapticFeedback();
                hideModal();
                renderApp();
                showToast("Bike marked as sold!", "success");
            } else {
                showToast("Please fill all fields.", "error");
            }
        });
        
        // Month Navigation
        el.prevMonthBtn.addEventListener("click", async () => {
            const newMonth = addMonths(uiState.currentMonthDisplay, -1);
            showLoading(`Loading ${formatMonthYear(newMonth)}...`);
            await loadMonth(newMonth); // Ensure data is loaded
            uiState.currentMonthDisplay = newMonth;
            hideLoading();
            renderApp();
        });
        
        el.nextMonthBtn.addEventListener("click", async () => {
            const newMonth = addMonths(uiState.currentMonthDisplay, 1);
            showLoading(`Loading ${formatMonthYear(newMonth)}...`);
            await loadMonth(newMonth);
            uiState.currentMonthDisplay = newMonth;
            hideLoading();
            renderApp();
        });
        
        el.jumpTodayBtn.addEventListener("click", async () => {
            const todayMonth = getToday("YYYY-MM");
            showLoading(`Loading ${formatMonthYear(todayMonth)}...`);
            await loadMonth(todayMonth);
            uiState.currentMonthDisplay = todayMonth;
            hideLoading();
            renderApp();
        });
        
        el.viewToggleThisMonth.addEventListener("click", (e) => {
            uiState.currentInventoryView = "this-month";
            e.target.classList.add("bg-blue-600", "text-white");
            e.target.classList.remove("bg-white", "text-gray-700", "border");
            el.viewToggle3Months.classList.add("bg-white", "text-gray-700", "border");
            el.viewToggle3Months.classList.remove("bg-blue-600", "text-white");
            renderBikeList();
        });
        
        el.viewToggle3Months.addEventListener("click", async (e) => {
            uiState.currentInventoryView = "3-months";
            e.target.classList.add("bg-blue-600", "text-white");
            e.target.classList.remove("bg-white", "text-gray-700", "border");
            el.viewToggleThisMonth.classList.add("bg-white", "text-gray-700", "border");
            el.viewToggleThisMonth.classList.remove("bg-blue-600", "text-white");
            
            // Lazy load previous 2 months if not loaded
            showLoading("Loading previous months...");
            await loadMonth(addMonths(uiState.currentMonthDisplay, -1));
            await loadMonth(addMonths(uiState.currentMonthDisplay, -2));
            hideLoading();
            
            renderBikeList();
        });
        
        // Filtering
        document.querySelectorAll(".filter-status-btn").forEach(btn => {
            btn.addEventListener("click", (e) => {
                uiState.filter.status = e.target.dataset.filter;
                document.querySelectorAll(".filter-status-btn").forEach(b => {
                    b.classList.add("bg-white", "text-gray-700", "border");
                    b.classList.remove("bg-blue-600", "text-white");
                });
                e.target.classList.remove("bg-white", "text-gray-700", "border");
                e.target.classList.add("bg-blue-600", "text-white");
                renderBikeList();
            });
        });
        
        document.querySelectorAll(".filter-chip-btn").forEach(btn => {
            btn.addEventListener("click", (e) => {
                const chip = e.target.dataset.chip;
                if (uiState.filter.chip === chip) {
                    uiState.filter.chip = null;
                    e.target.classList.remove("bg-blue-600", "text-white");
                    e.target.classList.add("border");
                } else {
                    uiState.filter.chip = chip;
                    document.querySelectorAll(".filter-chip-btn").forEach(b => {
                        b.classList.remove("bg-blue-600", "text-white");
                        b.classList.add("border");
                    });
                    e.target.classList.add("bg-blue-600", "text-white");
                    e.target.classList.remove("border");
                }
                renderBikeList();
            });
        });

        el.sortSelect.addEventListener("change", (e) => {
            uiState.filter.sort = e.target.value;
            renderBikeList();
        });
        
        el.searchBox.addEventListener("input", debounce((e) => {
            uiState.filter.search = e.target.value;
            renderBikeList();
        }, 300));

        // Analytics
        el.analyticsTabButtons.forEach(btn => {
            btn.addEventListener("click", (e) => {
                const tab = e.target.dataset.tab;
                uiState.currentAnalyticsTab = tab;
                
                // Update button styles
                el.analyticsTabButtons.forEach(b => {
                    b.classList.remove("border-blue-600", "text-blue-600");
                    b.classList.add("border-transparent", "text-gray-500", "hover:text-gray-700", "hover:border-gray-300");
                });
                e.target.classList.add("border-blue-600", "text-blue-600");
                e.target.classList.remove("border-transparent", "text-gray-500");
                
                // Show/hide content
                Object.keys(el.analyticsContent).forEach(key => {
                    el.analyticsContent[key].classList.add("hidden");
                });
                el.analyticsContent[tab].classList.remove("hidden");
                
                // Re-render analytics in case new data was loaded
                renderAnalytics();
            });
        });
        
        el.loadAllAnalyticsBtn.addEventListener("click", async () => {
            showLoading("Loading all month data...");
            for (const month of db.metadata.availableMonths) {
                if (!uiState.loadedMonths.includes(month)) {
                    await loadMonth(month);
                }
            }
            hideLoading();
            el.analyticsScopeMsg.textContent = "Showing analytics for all available data.";
            renderAnalytics();
            showToast("All data loaded for analytics.", "success");
        });
        
        // --- EXPORT ---
        el.fab.addEventListener("contextmenu", (e) => {
            e.preventDefault(); // Show export on long-press/right-click
            showModal("export");
        });
        
        const getCSVHeader = () => "ID,Plate,Owner,Model,Purchase Date,Purchase Price,Repair Cost,Other Expenses,Total Investment,Sold (Y/N),Selling Date,Selling Price,Profit,Margin %,Days Held,Source,Notes\n";
        
        const bikeToCSVRow = (bike) => {
            const stats = getBikeHelpers(bike);
            const data = [
                bike.id,
                bike.plate,
                `"${bike.owner || ''}"`,
                `"${bike.model || ''}"`,
                bike.datePurchase,
                stats.purchasePrice,
                stats.repairCost,
                stats.otherExpenses,
                stats.investment,
                bike.isSold ? 'Y' : 'N',
                bike.dateSelling || '',
                bike.sellingPrice || '',
                stats.profit,
                stats.margin.toFixed(2),
                stats.daysHeld,
                bike.source || '',
                `"${(bike.notes || '').replace(/"/g, '""')}"`
            ];
            return data.join(",");
        };

        const downloadCSV = (filename, csvContent) => {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        el.exportCsvViewBtn.addEventListener("click", () => {
            const bikes = getBikesForView();
            let csv = getCSVHeader();
            csv += bikes.map(bikeToCSVRow).join("\n");
            downloadCSV("bikes_current_view.csv", csv);
            hideModal();
        });

        el.exportCsvMonthBtn.addEventListener("click", () => {
            const bikes = db.bikes[uiState.currentMonthDisplay] || [];
            let csv = getCSVHeader();
            csv += bikes.map(bikeToCSVRow).join("\n");
            downloadCSV(`bikes_${uiState.currentMonthDisplay}.csv`, csv);
            hideModal();
        });

        el.exportCsvAllBtn.addEventListener("click", async () => {
            showLoading("Loading all data for export...");
            for (const month of db.metadata.availableMonths) {
                await loadMonth(month);
            }
            const allBikes = getAllBikes();
            let csv = getCSVHeader();
            csv += allBikes.map(bikeToCSVRow).join("\n");
            hideLoading();
            downloadCSV("bikes_all_data.csv", csv);
            hideModal();
        });
        
        el.exportPdfMonthBtn.addEventListener("click", async () => {
            hideModal();
            const monthStr = window.prompt("Enter month to export (YYYY-MM):", uiState.currentMonthDisplay);
            if (!monthStr || !/^\d{4}-\d{2}$/.test(monthStr)) {
                showToast("Invalid month format.", "error");
                return;
            }
            
            showLoading("Generating PDF report...");
            await loadMonth(monthStr);
            
            const bikes = db.bikes[monthStr] || [];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text(`Bike Inventory Report: ${formatMonthYear(monthStr)}`, 14, 22);
            
            // Summary
            const soldBikes = bikes.filter(b => b.isSold).map(b => ({ ...b, stats: getBikeHelpers(b) }));
            const unsoldBikes = bikes.filter(b => !b.isSold).map(b => ({ ...b, stats: getBikeHelpers(b) }));
            
            const totalProfit = soldBikes.reduce((sum, b) => sum + b.stats.profit, 0);
            const unsoldInvest = unsoldBikes.reduce((sum, b) => sum + b.stats.investment, 0);
            
            doc.setFontSize(11);
            doc.text(`Total Bikes: ${bikes.length}`, 14, 35);
            doc.text(`Total Sold: ${soldBikes.length}`, 14, 40);
            doc.text(`Total Unsold: ${unsoldBikes.length}`, 14, 45);
            doc.text(`Total Profit: ${formatCurrency(totalProfit)}`, 14, 50);
            doc.text(`Unsold Investment: ${formatCurrency(unsoldInvest)}`, 14, 55);
            
            // Table
            const tableColumns = ["Plate", "Model", "Investment", "Status", "Profit/Loss", "Days Held"];
            const tableRows = bikes.map(b => {
                const stats = getBikeHelpers(b);
                return [
                    b.plate,
                    b.model || 'N/A',
                    formatCurrency(stats.investment),
                    b.isSold ? `Sold (${b.dateSelling})` : 'Unsold',
                    b.isSold ? formatCurrency(stats.profit) : '-',
                    stats.daysHeld
                ];
            });

            doc.autoTable(tableColumns, tableRows, { startY: 65 });
            
            doc.save(`Bike_Report_${monthStr}.pdf`);
            hideLoading();
        });


        // --- STARTUP ---
        initialLoad();

    </script>
</body>
</html>
