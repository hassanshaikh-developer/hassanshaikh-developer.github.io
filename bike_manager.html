<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bike Manager v4</title>
  <meta name="description" content="Offline-first bike inventory with GitHub sync, analytics, and invoices." />
  
  <!-- PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Bike Manager" />
  <meta name="theme-color" content="#071b2b" />
  <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiQmlrZSBNYW5hZ2VyIiwic2hvcnRfbmFtZSI6IkJpa2VNZ3IiLCJzdGFydF91cmwiOiIuIiwic3R5bGUiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwNzEwMjYiLCJ0aGVtZV9jb2xvciI6IiMwNzFiMmIiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImljb25zIjpbeyJzcmMiOiJodHRwc2ltZy1hcHBsZS5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">
  <link rel="apple-touch-icon" href="httpsimg-apple.png" />

  <!-- Security -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.github.com;">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    :root {
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --bg-gradient-start: #071026;
      --bg-gradient-end: #020511;
      --bg-page: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      --bg-card: #071b2b;
      --bg-card-subtle: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --bg-header: rgba(7, 27, 43, 0.85);
      --bg-modal: rgba(7, 16, 38, 0.9);
      --bg-input: rgba(0, 0, 0, 0.2);
      --bg-input-focus: rgba(0, 0, 0, 0.1);
      --bg-hover: rgba(255, 255, 255, 0.05);
      --bg-active: rgba(255, 255, 255, 0.08);
      --bg-nav: var(--bg-header);
      --accent-gradient: linear-gradient(90deg, #00D0FF, #6EE7B7);
      --accent-1: #00D0FF;
      --accent-2: #6EE7B7;
      --accent-text: #00242f;
      --text-primary: #e6f6ff;
      --text-secondary: #9fb0c2;
      --text-disabled: #6a7f96;
      --text-placeholder: #6a7f96;
      --border-color: rgba(255, 255, 255, 0.1);
      --border-color-subtle: rgba(255, 255, 255, 0.04);
      --border-focus: var(--accent-1);
      --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.6);
      --shadow-nav: 0 -4px 12px rgba(0, 0, 0, 0.3);
      --shadow-fab: 0 6px 16px rgba(0, 208, 255, 0.3);
      --shadow-btn: 0 2px 8px rgba(0, 0, 0, 0.3);
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-xl: 20px;
      --radius-full: 9999px;
      --nav-height-mobile: 60px;
      --header-height: 60px;
      --tap-target: 44px;
      --transition-speed: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg-gradient-start: #f4f7fa;
        --bg-gradient-end: #e8eef3;
        --bg-card: #ffffff;
        --bg-card-subtle: linear-gradient(180deg, #ffffff, #fdfdfd);
        --bg-header: rgba(255, 255, 255, 0.85);
        --bg-modal: rgba(244, 247, 250, 0.9);
        --bg-input: rgba(0, 0, 0, 0.04);
        --bg-input-focus: rgba(0, 0, 0, 0.02);
        --bg-hover: rgba(0, 0, 0, 0.05);
        --bg-active: rgba(0, 0, 0, 0.08);
        --text-primary: #071026;
        --text-secondary: #4a5a70;
        --text-disabled: #9fb0c2;
        --border-color: rgba(0, 0, 0, 0.1);
        --border-color-subtle: rgba(0, 0, 0, 0.04);
        --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.08);
        --shadow-nav: 0 -4px 12px rgba(0, 0, 0, 0.05);
      }
    }

    *, *::before, *::after { box-sizing: border-box; }
    html { -webkit-text-size-adjust: 100%; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      font-family: var(--font-family);
      background: var(--bg-page);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-size: 16px;
      line-height: 1.5;
    }
    input, button, select, textarea {
      font-family: inherit;
      color: inherit;
      font-size: 1rem;
    }
    button { cursor: pointer; border: none; background: none; padding: 0; }
    h1, h2, h3, h4, h5, h6 { margin: 0; font-weight: 700; }
    a { color: var(--accent-1); text-decoration: none; }
    svg { display: block; }
    ::placeholder { color: var(--text-placeholder); }

    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .app-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 16px;
      height: var(--header-height);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      background: var(--bg-header);
      border-bottom: 1px solid var(--border-color-subtle);
    }
    .app-header h1 {
      font-size: 1.25rem;
      margin-right: auto;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      color: transparent;
    }

    .app-main {
      flex-grow: 1;
      padding: 16px;
      padding-bottom: calc(var(--nav-height-mobile) + 32px);
    }

    .app-bottom-nav {
      display: flex;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--nav-height-mobile);
      background: var(--bg-nav);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow-nav);
      z-index: 100;
      border-top: 1px solid var(--border-color-subtle);
    }
    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-secondary);
      transition: var(--transition-speed);
    }
    .nav-btn svg { width: 22px; height: 22px; }
    .nav-btn.active, .nav-btn:focus-visible {
      color: var(--accent-1);
      outline: 2px solid var(--accent-1);
      outline-offset: 2px;
    }

    @media (min-width: 768px) {
      .app-container { flex-direction: row; }
      .app-bottom-nav {
        position: sticky;
        top: 0;
        left: 0;
        flex-direction: column;
        width: 80px;
        height: 100vh;
        border-top: none;
        border-right: 1px solid var(--border-color-subtle);
        box-shadow: none;
        justify-content: flex-start;
        padding-top: var(--header-height);
      }
      .nav-btn { width: 100%; height: 70px; font-size: 0.75rem; }
      .app-header { width: calc(100% - 80px); left: 80px; }
      .app-main { width: calc(100% - 80px); padding-bottom: 32px; }
    }

    .view { display: none; }
    .view.active { display: block; animation: fadeIn 0.3s ease; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
      min-height: var(--tap-target);
      transition: var(--transition-speed);
      box-shadow: var(--shadow-btn);
    }
    .btn:focus-visible { outline: 2px solid var(--accent-1); outline-offset: 2px; }
    .btn-primary { background: var(--accent-gradient); color: var(--accent-text); }
    .btn-primary:hover { opacity: 0.9; }
    .btn-secondary { background: var(--bg-card-subtle); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background: var(--bg-hover); }
    .btn-ghost { background: transparent; color: var(--text-secondary); box-shadow: none; }
    .btn-ghost:hover { background: var(--bg-hover); color: var(--text-primary); }
    .btn-danger { background: var(--error); color: #fff; }
    .btn-icon {
      padding: 10px;
      min-height: var(--tap-target);
      min-width: var(--tap-target);
      border-radius: var(--radius-full);
      box-shadow: none;
    }
    .btn-icon svg { width: 24px; height: 24px; }

    .fab {
      position: fixed;
      bottom: calc(var(--nav-height-mobile) + 16px);
      right: 16px;
      width: 56px;
      height: 56px;
      border-radius: var(--radius-xl);
      background: var(--accent-gradient);
      color: var(--accent-text);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-fab);
      z-index: 200;
      transition: transform 0.3s ease;
    }
    .fab:active { transform: scale(0.95); }
    .fab svg { width: 28px; height: 28px; }
    @media (min-width: 768px) { .fab { display: none; } }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-card);
      border: 1px solid var(--border-color-subtle);
    }

    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .form-input, .form-select {
      width: 100%;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-input);
      color: var(--text-primary);
      transition: var(--transition-speed);
      appearance: none;
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--border-focus);
      background: var(--bg-input-focus);
      box-shadow: 0 0 0 2px rgba(0, 208, 255, 0.3);
    }
    .form-input[readonly] { background: rgba(0,0,0,0.1); color: var(--text-secondary); }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg-modal);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 24px;
      width: 100%;
      max-width: 500px;
      box-shadow: var(--shadow-card);
      transform: scale(0.95);
      transition: transform 0.3s;
    }
    .modal-overlay.active .modal-content { transform: scale(1); }
    .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .modal-header h2 { font-size: 1.25rem; }
    .modal-body { max-height: 70vh; overflow-y: auto; }
    .modal-footer { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }

    .app-loader {
      position: fixed;
      inset: 0;
      background: var(--bg-page);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      transition: opacity 0.5s ease;
    }
    .app-loader.hidden { opacity: 0; pointer-events: none; }
    .app-loader .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border-color);
      border-top-color: var(--accent-1);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .app-loader h2 {
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 1.5rem;
    }

    .sync-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 6px 10px;
      border-radius: var(--radius-full);
      background: var(--bg-card-subtle);
      border: 1px solid var(--border-color-subtle);
      color: var(--text-secondary);
      transition: var(--transition-speed);
    }
    .sync-status.syncing .status-dot { background: var(--warning); animation: pulse 1.5s infinite; }
    .sync-status.success .status-dot { background: var(--success); }
    .sync-status.error .status-dot { background: var(--error); }
    .sync-status.offline .status-dot { background: var(--text-disabled); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-secondary); }

    .toast-container {
      position: fixed;
      bottom: calc(var(--nav-height-mobile) + 20px);
      left: 16px;
      right: 16px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    .toast {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #2a3b4d;
      color: var(--text-primary);
      padding: 12px 16px;
      border-radius: var(--radius-md);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: toast-in 0.3s ease;
      position: relative;
    }
    .toast.success { background: var(--success); color: #fff; }
    .toast.error { background: var(--error); color: #fff; }
    .toast-close {
      margin-left: auto;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.2rem;
      opacity: 0.7;
    }
    @media (min-width: 768px) {
      .toast-container { bottom: 20px; left: auto; right: 20px; align-items: flex-end; }
    }

    .bike-list { display: grid; gap: 12px; }
    .bike-card {
      display: grid;
      grid-template-columns: 1fr auto;
      background: var(--bg-card-subtle);
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color-subtle);
      transition: var(--transition-speed);
      position: relative;
    }
    .bike-card:hover { background: var(--bg-hover); border-color: var(--border-color); }
    .bike-card-main { display: flex; flex-direction: column; gap: 4px; }
    .bike-card-plate { font-weight: 700; font-size: 1.1rem; color: var(--text-primary); }
    .bike-card-owner { font-size: 0.9rem; color: var(--text-secondary); }
    .bike-card-profit { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; }
    .profit-value { font-size: 1.25rem; font-weight: 700; color: var(--success); }
    .profit-value.unrealized { color: var(--text-secondary); font-style: italic; }
    .profit-value.loss { color: var(--error); }

    .filter-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      align-items: center;
      position: relative;
    }
    #search-input { flex-grow: 1; border-radius: var(--radius-full); padding-left: 16px; padding-right: 40px; }
    #search-clear {
      position: absolute;
      right: 8px;
      top: 6px;
      display: none;
      background: transparent;
      color: var(--text-secondary);
    }

    .filter-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
    .chip {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--bg-input);
      color: var(--text-secondary);
      padding: 6px 12px;
      border-radius: var(--radius-full);
      font-size: 0.85rem;
      border: 1px solid var(--border-color-subtle);
    }
    .chip.active, .chip:focus-visible {
      background: var(--accent-1);
      color: var(--accent-text);
      font-weight: 600;
      border-color: var(--accent-1);
      outline: 2px solid var(--accent-1);
      outline-offset: 2px;
    }

    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (min-width: 1024px) { .stats-grid { grid-template-columns: 1fr 1fr 1fr 1fr; } }
    .stat-card { background: var(--bg-card-subtle); padding: 16px; border-radius: var(--radius-md); }
    .stat-card-title { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px; }
    .stat-card-value { font-size: 1.75rem; font-weight: 700; }
    .stat-card-value .currency { font-size: 1.25rem; font-weight: 600; color: var(--text-secondary); }

    .settings-section { border-bottom: 1px solid var(--border-color); padding-bottom: 24px; margin-bottom: 24px; }
    .settings-section h2 { font-size: 1.25rem; margin-bottom: 16px; }
    .settings-section p { font-size: 0.9rem; color: var(--text-secondary); margin-top: -12px; margin-bottom: 16px; }

    .hidden { display: none !important; }
    .text-success { color: var(--success); }
    .text-error { color: var(--error); }
    .text-warning { color: var(--warning); }
    .text-secondary { color: var(--text-secondary); }
    .text-center { text-align: center; }
    .mt-1 { margin-top: 8px; }
    .mt-2 { margin-top: 16px; }
    .mb-2 { margin-bottom: 16px; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    @keyframes toast-in { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Skeleton */
    .skeleton {
      background: linear-gradient(90deg, var(--bg-input) 25%, var(--bg-hover) 50%, var(--bg-input) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
    }
    @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body>

  <svg width="0" height="0" style="position:absolute">
    <symbol id="icon-list" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></symbol>
    <symbol id="icon-chart" viewBox="0 0 24 24"><path fill="currentColor" d="M3 22v-9h4v9H3zm0-11V3h4v8H3zm6 11v-5h4v5H9zm0-7V3h4v12H9zm6 7v-9h4v9h-4zm0-11V3h4v8h-4z"/></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24"><path fill="currentColor" d="M19.4 12c0-.2.1-.4.1-.6c0-.2-.1-.4-.1-.6l1.7-1.3c.2-.1.2-.4 0-.6l-1.6-2.8c-.1-.2-.4-.3-.6-.2l-2 .8c-.4-.3-.8-.5-1.3-.7l-.3-2.1c0-.3-.2-.4-.5-.4h-3.2c-.3 0-.5.1-.5.4l-.3 2.1c-.5.2-.9.4-1.3.7l-2-.8c-.2-.1-.5 0-.6.2l-1.6 2.8c-.1.2-.1.5 0 .6l1.7 1.3c-.1.2-.1.4-.1.6c0 .2.1.4.1.6l-1.7 1.3c-.2.1-.2.4 0 .6l1.6 2.8c.1.2.4.3.6.2l2-.8c.4.3.8.5 1.3.7l.3 2.1c0 .3.2.4.5.4h3.2c.3 0 .5-.1.5.4l.3-2.1c.5-.2.9-.4 1.3-.7l2-.8c.2-.1.5 0 .6-.2l1.6-2.8c.1-.2.1-.5 0-.6l-1.7-1.3zm-7.4 2.5c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5s2.5 1.1 2.5 2.5s-1.1 2.5-2.5 2.5z"/></symbol>
    <symbol id="icon-add" viewBox="0 0 24 24"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></symbol>
    <symbol id="icon-close" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41z"/></symbol>
    <symbol id="icon-search" viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5S14 7.01 14 9.5S11.99 14 9.5 14z"/></symbol>
    <symbol id="icon-save" viewBox="0 0 24 24"><path fill="currentColor" d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3s3 1.34 3 3s-1.34 3-3 3zm3-10H5V5h10v4z"/></symbol>
    <symbol id="icon-delete" viewBox="0 0 24 24"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></symbol>
    <symbol id="icon-sync" viewBox="0 0 24 24"><path fill="currentColor" d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6s-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8s-3.58-8-8-8z"/></symbol>
  </svg>

  <div class="app-loader" id="app-loader">
    <div class="spinner"></div>
    <h2>Bike Manager</h2>
    <p class="text-secondary" id="app-loader-status">Initializing...</p>
  </div>

  <div class="app-container">
    <nav class="app-bottom-nav" id="app-nav">
      <button class="nav-btn active" data-view="view-list" aria-label="Bikes">
        <svg><use href="#icon-list"></use></svg>
        <span>Bikes</span>
      </button>
      <button class="nav-btn" data-view="view-stats" aria-label="Stats">
        <svg><use href="#icon-chart"></use></svg>
        <span>Stats</span>
      </button>
      <button class="nav-btn" data-view="view-settings" aria-label="Settings">
        <svg><use href="#icon-settings"></use></svg>
        <span>Settings</span>
      </button>
    </nav>

    <div style="flex-grow: 1; display: flex; flex-direction: column;">
      <header class="app-header">
        <h1 id="header-title">Bike Manager</h1>
        <div id="sync-status" class="sync-status">
          <div class="status-dot"></div>
          <span id="sync-status-text">Offline</span>
        </div>
        <button class="btn-icon btn-ghost" id="sync-now-btn" title="Sync Now" aria-label="Sync">
          <svg><use href="#icon-sync"></use></svg>
        </button>
      </header>

      <main class="app-main">
        <section id="view-list" class="view active">
          <div class="stats-grid mb-2">
            <div class="stat-card"><div class="stat-card-title">Total Profit</div><div class="stat-card-value"><span class="currency">₹</span> <span id="stat-total-profit">0</span></div></div>
            <div class="stat-card"><div class="stat-card-title">Unsold Stock</div><div class="stat-card-value"><span class="currency">₹</span> <span id="stat-unsold-value">0</span></div></div>
            <div class="stat-card"><div class="stat-card-title">Sold</div><div class="stat-card-value" id="stat-sold-count">0</div></div>
            <div class="stat-card"><div class="stat-card-title">Unsold</div><div class="stat-card-value" id="stat-unsold-count">0</div></div>
          </div>

          <div class="filter-bar">
            <input type="text" class="form-input" id="search-input" placeholder="Search plate or owner..." aria-label="Search">
            <button id="search-clear" class="btn-icon btn-ghost" aria-label="Clear search">
              <svg><use href="#icon-close"></use></svg>
            </button>
            <button class="btn btn-primary" id="add-bike-desktop" style="display: none;">
              <svg width="20" height="20"><use href="#icon-add"></use></svg>
              <span>Add Bike</span>
            </button>
          </div>

          <div class="filter-chips">
            <button class="chip active" id="filter-all" data-filter="all">All</button>
            <button class="chip" id="filter-sold" data-filter="sold">Sold</button>
            <button class="chip" id="filter-unsold" data-filter="unsold">Unsold</button>
          </div>

          <div class="bike-list" id="bike-list">
            <p id="bike-list-empty" class="text-secondary text-center mt-2">No bikes found. Try adding one!</p>
          </div>
        </section>

        <section id="view-stats" class="view">
          <h2>Analytics Dashboard</h2>
          <p class="text-secondary mb-2">Live insights from your local data.</p>
          <div class="card"><h3>Quick Insights</h3><p id="auto-insight-text" class="text-secondary">Calculating...</p></div>
          <div class="chart-container card"><h3>Monthly Profit</h3><canvas id="chart-profit-trend"></canvas></div>
          <div class="chart-container card"><h3>Profit Distribution</h3><canvas id="chart-profit-pie"></canvas></div>
          <div class="chart-container card"><h3>Top 5 Profitable Bikes</h3><canvas id="chart-top-bikes"></canvas></div>
        </section>

        <section id="view-settings" class="view">
          <h2>Settings</h2>

          <div class="settings-section">
            <h3>GitHub Gist Sync</h3>
            <p>Syncs your data to a private GitHub Gist as a CSV backup.</p>
            <div class="form-group">
              <label for="setting-gist-id">Gist ID</label>
              <input type="text" class="form-input" id="setting-gist-id" placeholder="e.g., a1b2c3d4e5f6a7b8c9d0" />
            </div>
            <div class="form-group">
              <label for="setting-gist-filename">Gist Filename</label>
              <input type="text" class="form-input" id="setting-gist-filename" value="bikes_inventory.csv" />
            </div>
            <div class="form-group">
              <label for="setting-github-pat">GitHub PAT (gist scope)</label>
              <input type="password" class="form-input" id="setting-github-pat" placeholder="Enter on first use" />
              <p class="text-secondary" style="font-size:0.8rem;margin-top:6px;">Stored only in memory. Re-enter on new device.</p>
            </div>
            <button class="btn btn-secondary" id="save-sync-settings">Save Sync Settings</button>
          </div>

          <div class="settings-section">
            <h3>Personalization</h3>
            <div class="form-group">
              <label for="setting-business-name">Business Name</label>
              <input type="text" class="form-input" id="setting-business-name" placeholder="My Bike Shop" />
            </div>
            <div class="form-group">
              <label for="setting-currency">Currency Symbol</label>
              <input type="text" class="form-input" id="setting-currency" placeholder="₹" style="width:100px;" />
            </div>
            <div class="form-group">
              <label for="setting-theme">Theme</label>
              <select class="form-select" id="setting-theme">
                <option value="auto">Auto (System)</option>
                <option value="dark">Dark</option>
                <option value="light">Light</option>
              </select>
            </div>
            <button class="btn btn-secondary" id="save-display-settings">Save Display Settings</button>
          </div>

          <div class="settings-section">
            <h3>Data Management</h3>
            <div class="form-grid" style="gap:12px;">
              <button class="btn btn-secondary" id="export-csv">Export CSV</button>
              <button class="btn btn-secondary" id="export-json">Export JSON</button>
              <button class="btn btn-secondary" id="export-xlsx">Export XLSX</button>
              <button class="btn btn-secondary" id="download-template">CSV Template</button>
              <button class="btn btn-secondary" id="import-csv">Import CSV/JSON</button>
            </div>
            <input type="file" id="import-file-input" class="hidden" accept=".csv,.json" />
            <h4 class="mt-2">Danger Zone</h4>
            <button class="btn btn-danger" id="wipe-data-btn">Wipe All Local Data</button>
          </div>
        </section>
      </main>
    </div>
  </div>

  <button class="fab" id="fab-add" title="Add New Bike" aria-label="Add Bike">
    <svg><use href="#icon-add"></use></svg>
  </button>

  <div class="modal-overlay" id="form-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="form-title">Add New Bike</h2>
        <button class="btn-icon btn-ghost" id="close-form-modal" aria-label="Close">
          <svg><use href="#icon-close"></use></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="bike-form">
          <input type="hidden" id="form-bike-id" />
          <div class="form-group">
            <label for="form-no">Bike Number (Plate)</label>
            <input type="text" class="form-input" id="form-no" placeholder="GJ05AB1234" required />
          </div>
          <div class="form-group">
            <label for="form-owner">Owner Name</label>
            <input type="text" class="form-input" id="form-owner" required />
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="form-datePurchase">Purchase Date</label>
              <input type="date" class="form-input" id="form-datePurchase" />
            </div>
            <div class="form-group">
              <label for="form-dateSelling">Selling Date</label>
              <input type="date" class="form-input" id="form-dateSelling" />
            </div>
            <div class="form-group">
              <label for="form-purchasePrice">Purchase Price</label>
              <input type="number" class="form-input" id="form-purchasePrice" placeholder="0" />
            </div>
            <div class="form-group">
              <label for="form-repairCost">Repair Cost</label>
              <input type="number" class="form-input" id="form-repairCost" placeholder="0" />
            </div>
            <div class="form-group">
              <label for="form-sellingPrice">Selling Price</label>
              <input type="number" class="form-input" id="form-sellingPrice" placeholder="0" />
            </div>
            <div class="form-group">
              <label for="form-netProfit">Net Profit (Auto)</label>
              <input type="number" class="form-input" id="form-netProfit" readonly />
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger hidden" id="delete-bike-btn">Delete</button>
        <button class="btn btn-secondary" id="cancel-form-btn">Cancel</button>
        <button class="btn btn-primary" id="save-form-btn">Save</button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toast-container"></div>
  <canvas id="confetti-canvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9998;"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/dexie@4.0.1/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const SETTINGS_KEY = 'bike_manager_settings_v4';
    const VIEWS = { LIST: 'view-list', STATS: 'view-stats', SETTINGS: 'view-settings' };

    class BikeManagerApp {
      constructor() {
        this.db = null;
        this.charts = {};
        this.currentFilters = { search: '', status: 'all' };
        this.settings = { businessName: 'Bike Manager', currency: '₹', gistId: '', gistFilename: 'bikes_inventory.csv', githubPat: '', theme: 'auto' };
        this.currentView = VIEWS.LIST;
        this.isMobile = window.innerWidth < 768;
        this.isOnline = navigator.onLine;
        this.debouncedRenderList = this.debounce(this.renderBikeList.bind(this), 250);
        this.syncNow = this.debounce(this._syncNow.bind(this), 5000);

        this.dom = {
          loader: document.getElementById('app-loader'),
          loaderStatus: document.getElementById('app-loader-status'),
          headerTitle: document.getElementById('header-title'),
          views: document.querySelectorAll('.view'),
          navButtons: document.querySelectorAll('.nav-btn'),
          syncStatus: document.getElementById('sync-status'),
          syncStatusText: document.getElementById('sync-status-text'),
          syncNowBtn: document.getElementById('sync-now-btn'),
          searchInput: document.getElementById('search-input'),
          searchClear: document.getElementById('search-clear'),
          bikeList: document.getElementById('bike-list'),
          bikeListEmpty: document.getElementById('bike-list-empty'),
          modalOverlay: document.getElementById('form-modal'),
        };

        document.addEventListener('DOMContentLoaded', () => this.init());
      }

      async init() {
        try {
          this.updateLoaderStatus('Initializing...');
          this.initServiceWorker();
          await this.initDatabase();
          await this.loadSettings();
          this.migrateFromLocalStorage();
          this.initUI();
          this.initEventListeners();
          await this.renderAll();
          this.dom.loader.classList.add('hidden');
        } catch (err) {
          console.error(err);
          this.dom.loaderStatus.textContent = 'Failed to load. Refresh.';
          this.dom.loaderStatus.classList.add('text-error');
        }
      }

      initServiceWorker() {
        if ('serviceWorker' in navigator) {
          const swCode = `
            const CACHE = 'bm-v4';
            const ASSETS = ['.', 'https://cdn.jsdelivr.net/npm/dexie@4.0.1/dist/dexie.min.js'];
            self.addEventListener('install', e => e.waitUntil(caches.open(CACHE).then(c => c.addAll(ASSETS)).then(() => self.skipWaiting())));
            self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
            self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
            self.addEventListener('message', e => { if (e.data.type === 'SKIP_WAITING') self.skipWaiting(); });
          `;
          navigator.serviceWorker.register('data:application/javascript,' + encodeURIComponent(swCode));
        }
      }

      async initDatabase() {
        this.db = new Dexie('BikeDB_v4');
        this.db.version(1).stores({ bikes: '++_id, &no, owner, _updatedAt, dateSelling' });
        await this.db.open();
      }

      async loadSettings() {
        const saved = localStorage.getItem(SETTINGS_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          this.settings = { ...this.settings, ...parsed, githubPat: '' };
        }
        if (!this.settings.githubPat) {
          const pat = prompt('Enter GitHub PAT (gist scope):');
          if (pat) this.settings.githubPat = pat.trim();
        }
        this.applySettings();
      }

      async saveSettings() {
        const { githubPat, ...safe } = this.settings;
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(safe));
        this.applySettings();
      }

      applySettings() {
        this.dom.headerTitle.textContent = this.settings.businessName;
        document.title = this.settings.businessName;
        document.querySelectorAll('.currency').forEach(el => el.textContent = this.settings.currency);
        document.getElementById('setting-gist-id').value = this.settings.gistId;
        document.getElementById('setting-gist-filename').value = this.settings.gistFilename;
        document.getElementById('setting-business-name').value = this.settings.businessName;
        document.getElementById('setting-currency').value = this.settings.currency;
        document.getElementById('setting-theme').value = this.settings.theme;

        const isLight = this.settings.theme === 'light' || (this.settings.theme === 'auto' && window.matchMedia('(prefers-color-scheme: light)').matches);
        document.documentElement.classList.toggle('light', isLight);
        document.documentElement.classList.toggle('dark', !isLight);
      }

      async migrateFromLocalStorage() {
        const old = localStorage.getItem('bikes_db_v2');
        if (!old) return;
        try {
          const data = JSON.parse(old);
          if (Array.isArray(data)) {
            const now = new Date().toISOString();
            await this.db.bikes.bulkPut(data.map(b => ({ ...b, _updatedAt: b._updatedAt || now })));
            localStorage.removeItem('bikes_db_v2');
            this.showToast('Migrated old data.', 'success');
          }
        } catch (e) { console.error(e); }
      }

      initUI() {
        if (!this.isMobile) document.getElementById('add-bike-desktop').style.display = 'inline-flex';
        this.updateOnlineStatus();
      }

      initEventListeners() {
        this.dom.navButtons.forEach(btn => btn.addEventListener('click', () => this.navigateTo(btn.dataset.view)));
        this.dom.syncNowBtn.addEventListener('click', () => this.syncNow());
        this.dom.searchInput.addEventListener('input', e => {
          this.currentFilters.search = e.target.value.toLowerCase();
          this.dom.searchClear.style.display = e.target.value ? 'block' : 'none';
          this.debouncedRenderList();
        });
        this.dom.searchClear.addEventListener('click', () => {
          this.dom.searchInput.value = '';
          this.dom.searchClear.style.display = 'none';
          this.currentFilters.search = '';
          this.renderBikeList();
        });
        document.querySelectorAll('.filter-chips .chip').forEach(chip => chip.addEventListener('click', () => this.setFilterStatus(chip.dataset.filter)));
        this.dom.bikeList.addEventListener('click', e => {
          const card = e.target.closest('.bike-card');
          const printBtn = e.target.closest('.print-btn');
          if (printBtn) { this.printInvoiceById(card.dataset.id); }
          else if (card) { this.handleEditBike(card.dataset.id); }
        });
        [document.getElementById('fab-add'), document.getElementById('add-bike-desktop')].forEach(b => b.addEventListener('click', () => this.handleNewBike()));
        document.getElementById('close-form-modal').addEventListener('click', () => this.closeFormModal());
        this.dom.modalOverlay.addEventListener('click', e => { if (e.target === this.dom.modalOverlay) this.closeFormModal(); });
        document.getElementById('cancel-form-btn').addEventListener('click', () => this.closeFormModal());
        document.getElementById('save-form-btn').addEventListener('click', () => this.handleSaveBike());
        document.getElementById('delete-bike-btn').addEventListener('click', () => this.handleDeleteBike());
        ['form-purchasePrice', 'form-repairCost', 'form-sellingPrice'].forEach(id => document.getElementById(id).addEventListener('input', () => this.calculateFormProfit()));
        document.getElementById('save-sync-settings').addEventListener('click', () => this.handleSaveSyncSettings());
        document.getElementById('save-display-settings').addEventListener('click', () => this.handleSaveDisplaySettings());
        ['export-csv', 'export-json', 'export-xlsx'].forEach(id => document.getElementById(id).addEventListener('click', () => this.exportData(id.split('-')[1])));
        document.getElementById('download-template').addEventListener('click', () => this.downloadTemplate());
        document.getElementById('import-csv').addEventListener('click', () => document.getElementById('import-file-input').click());
        document.getElementById('import-file-input').addEventListener('change', e => this.handleImportFile(e));
        document.getElementById('wipe-data-btn').addEventListener('click', () => this.handleWipeData());
        window.addEventListener('online', () => this.updateOnlineStatus());
        window.addEventListener('offline', () => this.updateOnlineStatus());
        window.addEventListener('resize', this.debounce(() => { this.isMobile = window.innerWidth < 768; this.initUI(); }, 200));
      }

      async renderAll() {
        await this.renderBikeList();
        this.renderStatsDashboard();
      }

      async renderBikeList() {
        let bikes = await this.db.bikes.toArray();
        if (this.currentFilters.status === 'sold') bikes = bikes.filter(b => b.dateSelling);
        else if (this.currentFilters.status === 'unsold') bikes = bikes.filter(b => !b.dateSelling);
        if (this.currentFilters.search) {
          const s = this.currentFilters.search;
          bikes = bikes.filter(b => b.no.toLowerCase().includes(s) || b.owner.toLowerCase().includes(s));
        }
        bikes.sort((a, b) => new Date(b._updatedAt) - new Date(a._updatedAt));

        const fragment = document.createDocumentFragment();
        bikes.forEach(bike => fragment.appendChild(this.createBikeCardElement(bike)));
        this.dom.bikeList.innerHTML = '';
        this.dom.bikeList.appendChild(fragment);
        this.dom.bikeListEmpty.classList.toggle('hidden', bikes.length > 0);
      }

      createBikeCardElement(bike) {
        const isSold = !!bike.dateSelling;
        const profit = bike.netProfit || 0;
        const card = document.createElement('div');
        card.className = 'bike-card';
        card.dataset.id = bike._id;
        card.innerHTML = `
          <div class="bike-card-main">
            <div class="bike-card-plate">${bike.no}</div>
            <div class="bike-card-owner">${bike.owner}</div>
          </div>
          <div class="bike-card-profit">
            <div class="profit-value ${!isSold ? 'unrealized' : profit < 0 ? 'loss' : ''}">
              ${isSold ? this.settings.currency + ' ' + this.formatCurrency(profit) : 'Unsold'}
            </div>
            ${isSold ? `<button class="btn-icon btn-ghost print-btn" title="Print Invoice"><svg><use href="#icon-save"></use></svg></button>` : ''}
          </div>
        `;
        return card;
      }

      async renderStatsDashboard() {
        const bikes = await this.db.bikes.toArray();
        const sold = bikes.filter(b => b.dateSelling);
        const unsold = bikes.filter(b => !b.dateSelling);
        const totalProfit = sold.reduce((s, b) => s + b.netProfit, 0);
        const unsoldValue = unsold.reduce((s, b) => s + b.purchasePrice + b.repairCost, 0);
        document.getElementById('stat-total-profit').textContent = this.formatCurrency(totalProfit);
        document.getElementById('stat-unsold-value').textContent = this.formatCurrency(unsoldValue);
        document.getElementById('stat-sold-count').textContent = sold.length;
        document.getElementById('stat-unsold-count').textContent = unsold.length;
        const avg = sold.length ? totalProfit / sold.length : 0;
        document.getElementById('auto-insight-text').textContent = `Stock: ${unsold.length} bikes. Avg profit: ${this.settings.currency}${this.formatCurrency(avg)}.`;

        if (this.currentView === VIEWS.STATS) {
          this.renderProfitTrendChart(sold);
          this.renderProfitPieChart(sold);
          this.renderTopBikesChart(sold);
        }
      }

      renderProfitTrendChart(sold) {
        const ctx = document.getElementById('chart-profit-trend').getContext('2d');
        const monthly = sold.reduce((acc, b) => {
          if (!b.dateSelling) return acc;
          const m = b.dateSelling.substring(0, 7);
          acc[m] = (acc[m] || 0) + b.netProfit;
          return acc;
        }, {});
        const labels = Object.keys(monthly).sort().map(m => new Date(m + '-01'));
        const data = Object.values(monthly);

        if (this.charts.profitTrend) { this.charts.profitTrend.data.labels = labels; this.charts.profitTrend.data.datasets[0].data = data; this.charts.profitTrend.update(); return; }
        this.charts.profitTrend = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Profit', data, borderColor: '#00D0FF', backgroundColor: 'rgba(0,208,255,0.2)', fill: true, tension: 0.3 }] }, options: { responsive: true, scales: { x: { type: 'time', time: { unit: 'month' } } } } });
      }

      renderProfitPieChart(sold) {
        const ctx = document.getElementById('chart-profit-pie').getContext('2d');
        const ranges = { 'Loss': 0, '0-5k': 0, '5k-10k': 0, '>10k': 0 };
        sold.forEach(b => {
          if (b.netProfit < 0) ranges['Loss']++;
          else if (b.netProfit < 5000) ranges['0-5k']++;
          else if (b.netProfit < 10000) ranges['5k-10k']++;
          else ranges['>10k']++;
        });
        if (this.charts.profitPie) { this.charts.profitPie.data.datasets[0].data = Object.values(ranges); this.charts.profitPie.update(); return; }
        this.charts.profitPie = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(ranges), datasets: [{ data: Object.values(ranges), backgroundColor: ['#ef4444', '#f59e0b', '#22c55e', '#00D0FF'] }] } });
      }

      renderTopBikesChart(sold) {
        const ctx = document.getElementById('chart-top-bikes').getContext('2d');
        const top5 = sold.sort((a,b) => b.netProfit - a.netProfit).slice(0,5);
        if (this.charts.topBikes) { this.charts.topBikes.data.labels = top5.map(b => b.no); this.charts.topBikes.data.datasets[0].data = top5.map(b => b.netProfit); this.charts.topBikes.update(); return; }
        this.charts.topBikes = new Chart(ctx, { type: 'bar', data: { labels: top5.map(b => b.no), datasets: [{ label: 'Profit', data: top5.map(b => b.netProfit), backgroundColor: '#6EE7B7' }] }, options: { indexAxis: 'y' } });
      }

      handleNewBike() { this.openFormModal(); }
      async handleEditBike(id) {
        const bike = await this.db.bikes.get(Number(id));
        if (bike) this.openFormModal(bike);
      }

      async handleSaveBike() {
        const plate = document.getElementById('form-no').value.trim().toUpperCase();
        const owner = document.getElementById('form-owner').value.trim();
        if (!plate || !owner) return this.showToast('Plate and Owner required.', 'error');

        const data = {
          no: plate,
          owner,
          purchasePrice: parseFloat(document.getElementById('form-purchasePrice').value) || 0,
          repairCost: parseFloat(document.getElementById('form-repairCost').value) || 0,
          sellingPrice: parseFloat(document.getElementById('form-sellingPrice').value) || 0,
          datePurchase: document.getElementById('form-datePurchase').value || '',
          dateSelling: document.getElementById('form-dateSelling').value || '',
          _updatedAt: new Date().toISOString(),
        };
        data.netProfit = data.sellingPrice - (data.purchasePrice + data.repairCost);

        try {
          const id = document.getElementById('form-bike-id').value;
          if (id) await this.db.bikes.update(Number(id), data);
          else {
            await this.db.bikes.add(data);
            const count = await this.db.bikes.count();
            if (count === 1) this.showConfetti();
          }
          this.closeFormModal();
          this.renderAll();
          this.triggerAutoSync();
          this.showToast(id ? 'Updated!' : 'Added!', 'success');
        } catch (e) {
          this.showToast(e.name === 'ConstraintError' ? 'Plate exists.' : 'Save failed.', 'error');
        }
      }

      async handleDeleteBike() {
        if (confirm('Delete this bike?')) {
          await this.db.bikes.delete(Number(document.getElementById('form-bike-id').value));
          this.closeFormModal();
          this.renderAll();
          this.showToast('Deleted.', 'success');
        }
      }

      openFormModal(bike = null) {
        const form = document.getElementById('bike-form');
        form.reset();
        document.getElementById('form-title').textContent = bike ? 'Edit Bike' : 'Add New Bike';
        document.getElementById('delete-bike-btn').classList.toggle('hidden', !bike);
        if (bike) {
          Object.keys(bike).forEach(k => { const el = document.getElementById('form-' + k); if (el) el.value = bike[k]; });
          this.calculateFormProfit();
        } else {
          document.getElementById('form-datePurchase').value = new Date().toISOString().split('T')[0];
        }
        this.dom.modalOverlay.classList.add('active');
      }

      closeFormModal() { this.dom.modalOverlay.classList.remove('active'); }

      calculateFormProfit() {
        const p = parseFloat(document.getElementById('form-purchasePrice').value) || 0;
        const r = parseFloat(document.getElementById('form-repairCost').value) || 0;
        const s = parseFloat(document.getElementById('form-sellingPrice').value) || 0;
        const profit = s - p - r;
        document.getElementById('form-netProfit').value = isNaN(profit) ? '' : profit.toFixed(2);
      }

      handleSaveSyncSettings() {
        this.settings.gistId = document.getElementById('setting-gist-id').value.trim();
        this.settings.gistFilename = document.getElementById('setting-gist-filename').value.trim() || 'bikes_inventory.csv';
        this.settings.githubPat = document.getElementById('setting-github-pat').value.trim();
        this.saveSettings();
        this.showToast('Sync settings saved.', 'success');
      }

      handleSaveDisplaySettings() {
        this.settings.businessName = document.getElementById('setting-business-name').value.trim();
        this.settings.currency = document.getElementById('setting-currency').value.trim();
        this.settings.theme = document.getElementById('setting-theme').value;
        this.saveSettings();
        this.showToast('Display saved.', 'success');
        this.renderAll();
      }

      async exportData(format) {
        const bikes = await this.db.bikes.orderBy('no').toArray();
        if (!bikes.length) return this.showToast('No data.', 'warning');
        const clean = bikes.map(b => { const { _id, ...rest } = b; return rest; });
        const file = `bike_inventory_${new Date().toISOString().split('T')[0]}`;
        if (format === 'json') this.downloadFile(JSON.stringify(clean, null, 2), `${file}.json`, 'application/json');
        else if (format === 'csv') this.downloadFile(this.jsonToCsv(clean), `${file}.csv`, 'text/csv');
        else if (format === 'xlsx') { const ws = XLSX.utils.json_to_sheet(clean); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Bikes'); XLSX.writeFile(wb, `${file}.xlsx`); }
      }

      downloadTemplate() {
        this.downloadFile(this.jsonToCsv([]), 'bike_template.csv', 'text/csv');
      }

      async handleImportFile(e) {
        const file = e.target.files[0];
        if (!file || file.size > 2*1024*1024) return this.showToast('File too large.', 'error');
        const reader = new FileReader();
        reader.onload = async ev => {
          try {
            let data = file.name.endsWith('.json') ? JSON.parse(ev.target.result) : this.csvTojson(ev.target.result);
            if (!Array.isArray(data)) throw '';
            const now = new Date().toISOString();
            const prepared = data.map(b => ({
              no: (b.no || '').trim().toUpperCase(),
              owner: b.owner || '',
              purchasePrice: Number(b.purchasePrice) || 0,
              repairCost: Number(b.repairCost) || 0,
              sellingPrice: Number(b.sellingPrice) || 0,
              netProfit: Number(b.netProfit) || 0,
              datePurchase: b.datePurchase || '',
              dateSelling: b.dateSelling || '',
              _updatedAt: b._updatedAt || now,
            })).filter(b => b.no);
            if (confirm(`Import ${prepared.length} records?`)) {
              await this.db.bikes.bulkPut(prepared);
              this.renderAll();
              this.showToast('Imported!', 'success');
            }
          } catch { this.showToast('Invalid file.', 'error'); }
          e.target.value = '';
        };
        reader.readAsText(file);
      }

      async _syncNow() {
        if (!this.isOnline) return this.showToast('Offline.', 'warning');
        if (!this.settings.gistId || !this.settings.githubPat) return this.showToast('Set Gist ID & PAT.', 'error');
        this.setSyncStatus('syncing', 'Syncing...');
        try {
          const remote = await this.fetchFromGist();
          const local = await this.db.bikes.toArray();
          const map = new Map(local.map(b => [b.no, b]));
          (remote ? this.csvTojson(atob(remote.content)) : []).forEach(b => {
            const existing = map.get(b.no);
            if (!existing || new Date(b._updatedAt) > new Date(existing._updatedAt)) map.set(b.no, b);
          });
          const merged = Array.from(map.values());
          await this.db.transaction('rw', this.db.bikes, async () => {
            await this.db.bikes.clear();
            await this.db.bikes.bulkPut(merged);
          });
          const csv = this.jsonToCsv(merged.map(b => { const { _id, ...r } = b; return r; }));
          const b64 = btoa(csv);
          if (!remote || b64 !== remote.content) await this.pushToGist(b64, remote?.sha);
          this.settings.lastSync = new Date().toISOString();
          this.saveSettings();
          this.setSyncStatus('success', 'Synced');
          this.showToast('Sync complete.', 'success');
          this.renderAll();
        } catch (e) {
          this.setSyncStatus('error', 'Failed');
          this.showToast(e.message || 'Sync error.', 'error');
        }
      }

      async fetchFromGist() {
        const res = await fetch(`https://api.github.com/gists/${this.settings.gistId}`, { headers: { Authorization: `token ${this.settings.githubPat}` } });
        if (!res.ok) return null;
        const gist = await res.json();
        const file = gist.files[this.settings.gistFilename];
        if (!file) return null;
        let content = file.content;
        if (file.truncated) {
          const raw = await fetch(file.raw_url);
          content = await raw.text();
        }
        return { content: btoa(content), sha: gist.history[0].version };
      }

      async pushToGist(b64, sha) {
        const body = { files: { [this.settings.gistFilename]: { content: atob(b64) } } };
        if (sha) body.files[this.settings.gistFilename].sha = sha;
        const res = await fetch(`https://api.github.com/gists/${this.settings.gistId}`, {
          method: 'PATCH',
          headers: { Authorization: `token ${this.settings.githubPat}` },
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error('Push failed');
      }

      triggerAutoSync = this.debounce(() => { if (this.isOnline && this.settings.gistId && this.settings.githubPat) this.syncNow(); }, 10000);

      navigateTo(viewId) {
        if (this.currentView === viewId) return;
        this.currentView = viewId;
        this.dom.views.forEach(v => v.classList.toggle('active', v.id === viewId));
        this.dom.navButtons.forEach(b => b.classList.toggle('active', b.dataset.view === viewId));
        if (viewId === VIEWS.STATS) this.renderStatsDashboard();
      }

      setFilterStatus(status) {
        this.currentFilters.status = status;
        document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', c.dataset.filter === status));
        this.renderBikeList();
      }

      setSyncStatus(status, text) {
        this.dom.syncStatus.className = `sync-status ${status}`;
        this.dom.syncStatusText.textContent = text;
        this.dom.syncNowBtn.disabled = status === 'syncing';
      }

      updateOnlineStatus() {
        this.isOnline = navigator.onLine;
        this.setSyncStatus(this.isOnline ? 'success' : 'offline', this.isOnline ? 'Online' : 'Offline');
        if (this.isOnline) this.triggerAutoSync();
      }

      showToast(msg, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `${msg} <span class="toast-close">×</span>`;
        this.dom.toastContainer.appendChild(toast);
        toast.querySelector('.toast-close').onclick = () => toast.remove();
        setTimeout(() => toast.remove(), 5000);
      }

      async printInvoiceById(id) {
        const bike = await this.db.bikes.get(Number(id));
        if (!bike || !bike.dateSelling) return;
        const win = window.open('', '_blank');
        win.document.write(`
          <html><head><title>Invoice - ${bike.no}</title><style>
            body{font-family:sans-serif;padding:40px;} h1{font-size:24px;} table{width:100%;border-collapse:collapse;margin:20px 0;}
            th,td{border:1px solid #ccc;padding:8px;text-align:left;} th{background:#f0f0f0;}
          </style></head><body>
          <h1>${this.settings.businessName}</h1>
          <p>Date: ${new Date().toLocaleDateString()}</p>
          <table>
            <tr><th>Plate</th><td>${bike.no}</td></tr>
            <tr><th>Owner</th><td>${bike.owner}</td></tr>
            <tr><th>Purchase</th><td>${this.settings.currency}${bike.purchasePrice}</td></tr>
            <tr><th>Repair</th><td>${this.settings.currency}${bike.repairCost}</td></tr>
            <tr><th>Selling</th><td>${this.settings.currency}${bike.sellingPrice}</td></tr>
            <tr><th>Profit</th><td>${this.settings.currency}${bike.netProfit}</td></tr>
          </table>
          </body></html>
        `);
        win.document.close();
        win.print();
      }

      showConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = innerWidth; canvas.height = innerHeight;
        const pieces = Array.from({length: 100}, () => ({
          x: innerWidth/2, y: innerHeight/2,
          vx: Math.random()*10-5, vy: Math.random()*10-5,
          r: Math.random()*5+3, color: ['#00D0FF','#6EE7B7','#FFD700','#FF69B4'][Math.floor(Math.random()*4)],
          opacity: 1
        }));
        let frame = 0;
        const draw = () => {
          if (frame++ > 180) { canvas.width = 0; return; }
          ctx.clearRect(0,0,canvas.width,canvas.height);
          pieces.forEach(p => {
            ctx.globalAlpha = p.opacity;
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
            ctx.fill();
            p.x += p.vx; p.y += p.vy; p.vy += 0.1; p.opacity -= 0.005;
          });
          requestAnimationFrame(draw);
        };
        draw();
      }

      updateLoaderStatus(t) { this.dom.loaderStatus.textContent = t; }
      formatCurrency(v) { return Math.round(v || 0).toLocaleString(); }
      debounce(fn, d) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), d); }; }
      downloadFile(c, n, t) { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([c], {type:t})); a.download = n; a.click(); }
      jsonToCsv(items) {
        const headers = ['no','owner','purchasePrice',''repairCost','sellingPrice','netProfit','datePurchase','dateSelling','_updatedAt'];
        if (items.length === 0) return headers.join(',') + '\n';
        const escape = (s) => `"${String(s).replace(/"/g, '""')}"`;
        const rows = items.map(o => headers.map(h => escape(o[h] ?? '')).join(','));
        return [headers.join(','), ...rows].join('\n');
      }

      csvTojson(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
        if (lines.length < 2) return [];
        const headers = this.parseCsvLine(lines[0]);
        return lines.slice(1).map(line => {
          const values = this.parseCsvLine(line);
          const obj = {};
          headers.forEach((h, i) => obj[h] = values[i] || '');
          return obj;
        });
      }

      parseCsvLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const c = line[i];
          if (c === '"') {
            inQuotes = !inQuotes;
          } else if (c === ',' && !inQuotes) {
            result.push(current);
            current = '';
          } else {
            current += c;
          }
        }
        result.push(current);
        return result.map(v => v.replace(/^"|"$/g, '').replace(/""/g, '"'));
      }

      async handleWipeData() {
        if (confirm('Delete all local data? This cannot be undone.')) {
          await this.db.bikes.clear();
          localStorage.clear();
          this.showToast('Data wiped.', 'success');
          this.renderAll();
        }
      }
    }

    // Start the app
    new BikeManagerApp();
  </script>
</body>
</html>