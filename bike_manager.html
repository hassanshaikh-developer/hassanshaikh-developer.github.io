<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bike Manager v3 ‚Äî Offline PWA (Gist Sync)</title>
  <meta name="description" content="Bike Manager v3 ‚Äî Mobile-first, offline-first PWA. IndexedDB, CSV/Gist sync, import/export, analytics, backups, and more."/>
  <meta name="theme-color" content="#00D0FF" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle fill='%2300D0FF' cx='50' cy='50' r='50'/%3E%3Ctext x='50' y='58' font-size='48' text-anchor='middle' font-family='sans-serif' fill='%23071226'%3Eüö≤%3C/text%3E%3C/svg%3E">
  <style>
  /* ==================================================
     Bike Manager v3
     Mobile-first, offline-first single-file PWA UI styles
     ================================================== */
  :root{
    --bg:#071026; --card:#071b2b; --muted:#9fb0c2; --text:#E6F6FF;
    --accent-from:#00D0FF; --accent-to:#6EE7B7;
    --radius:14px; --glass: rgba(255,255,255,0.03);
    --tap:44px; --shadow: 0 10px 30px rgba(0,0,0,0.6);
    --safe-area: env(safe-area-inset-bottom);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter, Roboto, system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial;
    background: linear-gradient(180deg,#071026 0%, #020511 100%);
    color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    display:flex; align-items:flex-start; justify-content:center; padding:12px;
  }
  .app { width:100%; max-width:980px; min-height:100vh; display:flex; flex-direction:column; gap:12px; padding-bottom:calc(88px + var(--safe-area)); }

  /* Topbar */
  .topbar { position:sticky; top:12px; z-index:40; display:flex; gap:12px; align-items:center; background:transparent; }
  .logo { width:48px; height:48px; border-radius:12px; background:linear-gradient(135deg,var(--accent-from),var(--accent-to)); display:flex; align-items:center; justify-content:center; font-size:22px; box-shadow:var(--shadow); }
  .title { font-weight:700; font-size:1.1rem; background:linear-gradient(90deg,var(--accent-from),var(--accent-to)); -webkit-background-clip:text; color:transparent; }
  .subtitle { font-size:0.82rem; color:var(--muted) }

  .search { flex:1; min-width:140px; display:flex; align-items:center; gap:8px; background:var(--glass); border-radius:999px; padding:8px 12px; border:1px solid rgba(255,255,255,0.02); }
  .search input{ background:transparent; border:none; color:var(--text); font-size:0.95rem; outline:none; width:100% }
  .status-pill { padding:8px 12px; border-radius:999px; display:flex; gap:8px; align-items:center; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02); font-size:0.9rem; }

  /* Card style */
  .card { background:var(--card); border-radius:calc(var(--radius)); padding:12px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,0.03); }
  .wallet-card { border-radius:22px; padding:14px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); }

  /* layout helpers */
  .row { display:flex; gap:12px; align-items:center; }
  .col { display:flex; flex-direction:column; gap:8px; }
  label{ font-size:0.85rem; color:var(--muted) }
  input, select, textarea { padding:10px 12px; border-radius:12px; background:transparent; border:1px solid rgba(255,255,255,0.03); color:var(--text); outline:none; }
  .btn { cursor:pointer; border:0; padding:10px 12px; border-radius:12px; font-weight:600 }
  .btn-primary { background:linear-gradient(90deg,var(--accent-from),var(--accent-to)); color:#031019 }
  .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted) }

  /* Floating add */
  .fab { position:fixed; right:18px; bottom:100px; z-index:60; width:64px; height:64px; border-radius:18px; display:flex; align-items:center; justify-content:center; box-shadow:0 16px 40px rgba(0,0,0,0.6); background:linear-gradient(135deg,var(--accent-from),var(--accent-to)); color:#001; font-size:28px; }

  /* bottom nav */
  .bottom-nav { position:fixed; left:12px; right:12px; bottom:12px; z-index:60; display:flex; justify-content:space-between; align-items:center; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); padding:8px 12px; border-radius:20px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,0.03); }
  .nav-item { min-width:54px; height:48px; display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:12px; color:var(--muted); font-size:0.9rem; justify-content:center }
  .nav-item.active{ color:var(--text); background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }

  /* list */
  .list { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
  .list-item { display:flex; justify-content:space-between; gap:8px; padding:12px; border-radius:12px; background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid rgba(255,255,255,0.02); transition:transform .18s ease, box-shadow .18s ease; }
  .list-item:active{ transform:translateY(2px) }
  .meta { color:var(--muted); font-size:0.85rem }

  /* small helpers */
  .muted { color:var(--muted) }
  .hidden { display:none }
  .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:160px; z-index:80; background:linear-gradient(90deg,var(--accent-from),var(--accent-to)); color:#012; padding:10px 16px; border-radius:999px; box-shadow:0 10px 30px rgba(0,0,0,0.6); display:flex; gap:10px; align-items:center; }
  .chip { padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03) }

  /* charts */
  .charts { display:grid; grid-template-columns: 1fr; gap:12px; margin-top:8px; }
  @media(min-width:800px){ .charts{ grid-template-columns: 1fr 1fr } }

  /* animation for confetti area placeholder */
  .confetti-canvas { position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:9999 }

  /* responsive tweaks */
  @media(max-width:420px){
    .topbar{ flex-direction:column; align-items:stretch }
    .fab{ width:60px; height:60px; right:14px; bottom:110px }
  }
  </style>
</head>
<body>
  <main class="app" id="app" aria-live="polite">
    <!-- TOPBAR -->
    <div class="topbar">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="logo" title="Bike Manager">üö≤</div>
        <div>
          <div class="title">Bike Manager</div>
          <div class="subtitle">Offline PWA ‚Ä¢ IndexedDB ‚Ä¢ Gist Sync</div>
        </div>
      </div>

      <div class="search" role="search" aria-label="Search bikes">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:.75"><path d="M21 21l-4.35-4.35" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6.2" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <input id="q" placeholder="Search owner, plate, notes..." aria-label="Search" />
        <button id="clearSearch" class="btn-ghost" title="Clear search">‚úï</button>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div id="syncStatus" class="status-pill" title="Sync status">
          <span id="syncIcon">‚è∫</span>
          <span id="syncText">Offline</span>
        </div>
        <button id="openSettings" class="btn-ghost">Settings</button>
      </div>
    </div>

    <!-- DASHBOARD CARD -->
    <section id="dashboard" class="card wallet-card" aria-labelledby="dashTitle" >
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div>
          <div class="muted">Summary</div>
          <div style="display:flex;gap:12px;align-items:end;margin-top:6px">
            <div>
              <div class="muted">Total Profit</div>
              <div id="animatedProfit" style="font-weight:800;font-size:1.6rem;background:linear-gradient(90deg,var(--accent-from),var(--accent-to));-webkit-background-clip:text;color:transparent;">‚Çπ0</div>
            </div>
            <div>
              <div class="muted">Total Bikes</div>
              <div id="totalCount" style="font-weight:700;font-size:1.1rem">0</div>
            </div>
            <div>
              <div class="muted">Unsold</div>
              <div id="unsoldCount" style="font-weight:700;font-size:1.1rem">0</div>
            </div>
          </div>
          <div class="muted" style="margin-top:8px">Auto insights: <span id="insightsText">‚Äî</span></div>
        </div>

        <div style="width:320px;max-width:42vw">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="syncNow" class="btn-primary">Sync Now</button>
            <button id="backupNow" class="btn-ghost">Backup</button>
            <button id="importBtn" class="btn-ghost">Import</button>
            <button id="exportBtn" class="btn-ghost">Export</button>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <label class="chip">Currency: ‚Çπ</label>
            <label class="chip" id="gistLabel">Gist: ‚Äî</label>
          </div>
        </div>
      </div>

      <!-- charts -->
      <div class="charts" id="chartsArea" aria-hidden="false">
        <div class="card" style="padding:12px">
          <div class="muted">Monthly Profit</div>
          <canvas id="chartMonthly" height="160"></canvas>
        </div>
        <div class="card" style="padding:12px">
          <div class="muted">Profit Distribution</div>
          <canvas id="chartDist" height="160"></canvas>
        </div>
        <div class="card" style="padding:12px">
          <div class="muted">Sold vs Unsold</div>
          <canvas id="chartSold" height="160"></canvas>
        </div>
        <div class="card" style="padding:12px">
          <div class="muted">Top 5 Profits</div>
          <ul id="top5" style="margin:8px 0 0 0;padding:0;list-style:none"></ul>
        </div>
      </div>
    </section>

    <!-- LIST SECTION -->
    <section id="listView" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Bikes</strong> <span class="muted" id="filterChips"></span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="sortKey">
            <option value="no">Plate</option><option value="owner">Owner</option><option value="netProfit">Net Profit</option><option value="datePurchase">Purchased</option>
          </select>
          <select id="sortDir"><option value="-1">Desc</option><option value="1">Asc</option></select>
          <button id="addQuick" class="btn-primary">Add</button>
        </div>
      </div>

      <div id="list" class="list" style="margin-top:12px"></div>

      <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
        <div class="muted" id="listSummary">Showing 0 records</div>
        <div style="display:flex;gap:8px">
          <button id="prevPage" class="btn-ghost">Prev</button>
          <div id="pageInfo" class="muted">1</div>
          <button id="nextPage" class="btn-ghost">Next</button>
        </div>
      </div>
    </section>

    <!-- EDIT PANEL (slide-in modal) -->
    <aside id="editPanel" class="card" style="position:fixed; right:12px; top:84px; width:96%; max-width:480px; transform:translateY(20px); display:none; z-index:80">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong id="editTitle">Add Bike</strong>
        <div style="display:flex;gap:8px">
          <button id="closeEdit" class="btn-ghost">Close</button>
        </div>
      </div>
      <form id="form" onsubmit="return false" style="margin-top:8px;display:flex;flex-direction:column;gap:10px">
        <input id="f_id" type="hidden" />
        <div class="row">
          <div style="flex:1">
            <label>Plate (e.g. GJ05AB1234)</label>
            <input id="f_no" required placeholder="GJ05AB1234" />
            <div id="hint_plate" class="muted" style="font-size:0.82rem"></div>
          </div>
          <div style="width:120px">
            <label>Sold?</label>
            <select id="f_sold"><option value="no">No</option><option value="yes">Yes</option></select>
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label>Owner</label>
            <input id="f_owner" required />
            <div id="hint_owner" class="muted" style="font-size:0.82rem"></div>
          </div>
          <div style="width:140px">
            <label>Purchase ‚Çπ</label>
            <input id="f_purchase" type="number" step="0.01" />
          </div>
        </div>

        <div class="row">
          <div style="width:140px">
            <label>Repair ‚Çπ</label>
            <input id="f_repair" type="number" step="0.01" value="0" />
          </div>
          <div style="width:140px">
            <label>Selling ‚Çπ</label>
            <input id="f_selling" type="number" step="0.01" />
          </div>
          <div style="flex:1">
            <label>Notes</label>
            <input id="f_notes" />
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label>Purchase date</label>
            <input id="f_datePurchase" type="date" />
          </div>
          <div style="flex:1">
            <label>Selling date</label>
            <input id="f_dateSelling" type="date" />
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <div class="muted">Net:</div><div id="liveNet" style="font-weight:800">‚Çπ0</div>
          <div id="roiLabel" class="muted" style="margin-left:12px"></div>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="saveBtn" class="btn-primary">Save</button>
          <button id="saveNewBtn" class="btn-ghost">Save & New</button>
          <button id="deleteBtn" class="btn-ghost">Delete</button>
        </div>
      </form>
    </aside>

    <!-- SETTINGS PANEL -->
    <aside id="settings" class="card" style="position:fixed; left:12px; top:84px; width:96%; max-width:480px; transform:translateY(20px); display:none; z-index:80">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Settings</strong>
        <button id="closeSettings" class="btn-ghost">Close</button>
      </div>
      <div style="margin-top:8px;display:flex;flex-direction:column;gap:10px">
        <label>Gist ID (public)</label>
        <input id="gistId" placeholder="Leave blank to skip Gist sync" />
        <label>Gist Write Token (optional - saved locally if you choose)</label>
        <input id="gistToken" placeholder="Paste GitHub token with gist scope (kept locally)" />
        <div style="display:flex;gap:8px">
          <button id="testGist" class="btn-primary">Test Gist</button>
          <button id="createGist" class="btn-ghost">Create New Gist</button>
        </div>

        <label>Auto-backup interval (hours)</label>
        <select id="autoBackupInterval">
          <option value="0">Off</option>
          <option value="24">24h</option>
          <option value="168">Weekly</option>
        </select>

        <label>Appearance</label>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="accentReset" class="btn-ghost">Reset Accent</button>
          <button id="toggleTheme" class="btn-ghost">Toggle Theme</button>
        </div>

        <label>Security</label>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="enablePin" class="btn-ghost">Enable PIN (optional)</button>
          <button id="clearData" class="btn-ghost">Reset All Data</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <button id="exportAll" class="btn-ghost">Download Backup (encrypted)</button>
          <button id="importAll" class="btn-ghost">Restore Backup</button>
        </div>
      </div>
    </aside>

    <!-- hidden file input -->
    <input id="fileInput" type="file" accept=".csv,application/json,text/csv" class="hidden" />

    <!-- toast -->
    <div id="toast" class="toast hidden" role="status" aria-live="polite"><span id="toastMsg">Saved</span></div>

    <!-- confetti canvas -->
    <canvas id="confettiCanvas" class="confetti-canvas"></canvas>

    <!-- floating FAB -->
    <button id="fabAdd" class="fab" title="Add new bike">Ôºã</button>

    <!-- bottom nav -->
    <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
      <div id="navList" class="nav-item active">List</div>
      <div id="navAdd" class="nav-item">Add</div>
      <div id="navStats" class="nav-item">Stats</div>
      <div id="navSettings" class="nav-item">Settings</div>
    </nav>
  </main>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <script>
  /**
   * bike_manager_v3.html
   * Clean, documented single-file PWA implementing:
   * - IndexedDB primary store with migration from localStorage (bikes_db_v2)
   * - Service Worker registered via inline blob (self-contained)
   * - Gist sync manager (public read; write requires token)
   * - Auto-save, undo/redo, live validation, duplicate detection, auto-fill suggestions
   * - Charts, exports, AES-encrypted backup/restore
   *
   * NOTE: This file is intentionally verbose and well-commented for maintainability.
   */

  /* ===========================
     CONFIG & APP-LEVEL CONSTANTS
     =========================== */
  const APP_VERSION = '3.0.0';
  const DB_NAME = 'bike_manager_v3_db';
  const DB_STORE = 'bikes';
  const META_STORE = 'meta';
  const MIGRATION_VERSION = 2; // increment when schema changes
  const DEFAULT_PAGE_SIZE = 12;
  const CURRENCY = '‚Çπ';
  const ACCENT_FROM = '#00D0FF', ACCENT_TO = '#6EE7B7';

  // default gist filename (when creating/updating)
  const GIST_FILENAME = 'bikes_db.csv';

  // in-memory app state
  const STATE = {
    items: [], // full list (loaded from IndexedDB)
    page: 1,
    pageSize: DEFAULT_PAGE_SIZE,
    sort: { key: 'no', dir: -1 },
    filters: { q: '', sold: 'all', profitMin: null, profitMax: null, highProfitOnly: false, recentOnly:false },
    gistConfig: { id: null, token: null },
    undoStack: [],
    redoStack: [],
    isOnline: navigator.onLine,
    syncing: false,
    lastSync: null
  };

  // helper for querying elements
  const $ = sel => document.querySelector(sel);
  const el = id => document.getElementById(id);

  /* ===========================
     UTILITY FUNCTIONS
     =========================== */
  function nowISO(){ return (new Date()).toISOString(); }
  function uid(len=8){ const s='abcdefghijklmnopqrstuvwxyz0123456789'; let out=''; for(let i=0;i<len;i++) out+=s[Math.floor(Math.random()*s.length)]; return out; }
  function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
  function round2(v){ return Math.round((Number(v)||0 + Number.EPSILON)*100)/100; }
  function fmtMoney(n){ return CURRENCY + Number(n||0).toLocaleString(undefined,{maximumFractionDigits:2}); }
  function safeParse(s){ try{return JSON.parse(s);}catch(e){return null;} }
  function showToast(msg, time=2000){
    const t = el('toast'); el('toastMsg').textContent = msg; t.classList.remove('hidden');
    navigator.vibrate?.(10);
    clearTimeout(t._hide); t._hide = setTimeout(()=>t.classList.add('hidden'), time);
  }
  function haptic(type='light'){ try{ if(navigator.vibrate){ if(type==='light') navigator.vibrate(10); else if(type==='medium') navigator.vibrate([20,10,20]); } }catch(e){} }

  /* ===========================
     INDEXEDDB: wrapper & migrations
     =========================== */

  // Open the IndexedDB database, create stores if needed
  function openDb() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, MIGRATION_VERSION);
      req.onupgradeneeded = (ev) => {
        const db = ev.target.result;
        if(!db.objectStoreNames.contains(DB_STORE)) {
          const s = db.createObjectStore(DB_STORE, { keyPath: 'id' });
          s.createIndex('no','no',{ unique:false });
          s.createIndex('_updatedAt','_updatedAt',{ unique:false });
        }
        if(!db.objectStoreNames.contains(META_STORE)) {
          db.createObjectStore(META_STORE, { keyPath: 'k' }); // simple k/v store
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = e => reject(e);
    });
  }

  async function idbPut(store, value) {
    const db = await openDb();
    return new Promise((res,rej)=>{
      const tx = db.transaction(store,'readwrite');
      tx.objectStore(store).put(value);
      tx.oncomplete = ()=>res(true);
      tx.onerror = e=>rej(e);
    });
  }

  async function idbGet(store, key) {
    const db = await openDb();
    return new Promise((res,rej)=>{
      const tx = db.transaction(store,'readonly');
      const r = tx.objectStore(store).get(key);
      r.onsuccess = ()=>res(r.result);
      r.onerror = e=>rej(e);
    });
  }

  async function idbGetAll(store) {
    const db = await openDb();
    return new Promise((res,rej)=>{
      const tx = db.transaction(store,'readonly');
      const r = tx.objectStore(store).getAll();
      r.onsuccess = ()=>res(r.result);
      r.onerror = e=>rej(e);
    });
  }

  async function idbDelete(store, key) {
    const db = await openDb();
    return new Promise((res,rej)=>{
      const tx = db.transaction(store,'readwrite');
      tx.objectStore(store).delete(key);
      tx.oncomplete = ()=>res(true);
      tx.onerror = e=>rej(e);
    });
  }

  // Migrate from legacy localStorage key (bikes_db_v2)
  async function migrateFromLocalStorage() {
    try {
      const legacy = localStorage.getItem('bikes_db_v2');
      if(!legacy) return;
      const parsed = safeParse(legacy);
      if(!Array.isArray(parsed)) return;
      for(const r of parsed) {
        const rec = {
          id: r.no ? r.no + '_' + uid(4) : ('b_' + uid(8)),
          no: (r.no||'').toUpperCase(),
          owner: r.owner||'',
          purchasePrice: Number(r.purchasePrice||0),
          repairCost: Number(r.repairCost||0),
          sellingPrice: Number(r.sellingPrice||0),
          netProfit: round2(Number(r.sellingPrice||0) - (Number(r.purchasePrice||0) + Number(r.repairCost||0))),
          roi: 0,
          datePurchase: r.datePurchase||'',
          dateSelling: r.dateSelling||'',
          notes: r.notes||'',
          sold: (r.dateSelling && r.dateSelling.length>0) ? true : false,
          _createdAt: r._createdAt || nowISO(),
          _updatedAt: nowISO()
        };
        await idbPut(DB_STORE, rec);
      }
      showToast('Migrated localStorage ‚Üí IndexedDB ‚úì', 1600);
      localStorage.removeItem('bikes_db_v2');
    } catch(err) { console.warn('Migration failed', err); }
  }

  /* ===========================
     APPLICATION CORE: CRUD + AUTO-SAVE + UNDO/REDO
     =========================== */

  // Load all items into memory
  async function loadAllToMemory() {
    STATE.items = await idbGetAll(DB_STORE) || [];
    // ensure timestamps
    STATE.items.forEach(i=>{
      if(!i._createdAt) i._createdAt = nowISO();
      if(!i._updatedAt) i._updatedAt = nowISO();
    });
    // auto-clean invalid entries (self-healing)
    await autoCleanInvalid();
  }

  // Self-healing: remove records with no plate or invalid
  async function autoCleanInvalid() {
    let cleaned = 0;
    for(const it of STATE.items.slice()) {
      if(!it.no || String(it.no).trim().length < 3) {
        await idbDelete(DB_STORE, it.id);
        cleaned++;
      }
    }
    if(cleaned>0) {
      await loadAllToMemory();
      showToast(`Cleaned ${cleaned} invalid records`);
    }
  }

  // push a snapshot to undo stack
  function pushUndo() {
    STATE.undoStack.push(JSON.stringify(STATE.items));
    if(STATE.undoStack.length > 80) STATE.undoStack.shift();
    // clear redo on new action
    STATE.redoStack = [];
  }

  async function saveItem(item, push=true) {
    // compute derived fields
    item.netProfit = round2((Number(item.sellingPrice)||0) - ((Number(item.purchasePrice)||0) + (Number(item.repairCost)||0)));
    item.roi = (item.purchasePrice && item.purchasePrice>0) ? round2((item.netProfit / item.purchasePrice) * 100) : 0;
    item._updatedAt = nowISO();
    if(!item._createdAt) item._createdAt = item._updatedAt;
    if(!item.id) item.id = item.no ? (item.no + '_' + uid(4)) : ('b_' + uid(8));

    if(push) pushUndo();
    await idbPut(DB_STORE, item);
    await loadAllToMemory();
    renderAll();
  }

  async function deleteItem(id) {
    pushUndo();
    await idbDelete(DB_STORE, id);
    await loadAllToMemory();
    renderAll();
  }

  function undo() {
    if(STATE.undoStack.length===0) { showToast('Nothing to undo'); return; }
    STATE.redoStack.push(JSON.stringify(STATE.items));
    const prev = STATE.undoStack.pop();
    try {
      const arr = JSON.parse(prev);
      (async ()=>{
        const db = await openDb();
        const tx = db.transaction(DB_STORE,'readwrite');
        tx.objectStore(DB_STORE).clear();
        tx.oncomplete = async ()=>{
          for(const r of arr) await idbPut(DB_STORE, r);
          await loadAllToMemory();
          renderAll();
          showToast('Undo applied');
        };
      })();
    } catch(e){ console.error(e); showToast('Undo failed'); }
  }

  function redo() {
    if(STATE.redoStack.length===0) { showToast('Nothing to redo'); return; }
    const next = STATE.redoStack.pop();
    try {
      const arr = JSON.parse(next);
      (async ()=>{
        const db = await openDb();
        const tx = db.transaction(DB_STORE,'readwrite');
        tx.objectStore(DB_STORE).clear();
        tx.oncomplete = async ()=>{
          for(const r of arr) await idbPut(DB_STORE, r);
          await loadAllToMemory();
          renderAll();
          showToast('Redo applied');
        };
      })();
    } catch(e){ console.error(e); showToast('Redo failed'); }
  }

  /* ===========================
     VALIDATION, DUPLICATE DETECTION & SMART SUGGESTIONS
     =========================== */

  function isValidPlate(s) {
    if(!s) return false;
    const t = s.replace(/\s+/g,'').toUpperCase();
    if(t.length < 4) return false;
    // simple pattern: 2 letters then digits (loose)
    if(/^[A-Z]{2}\d{1,4}[A-Z0-9\-]*$/.test(t)) return true;
    return true; // accept many forms but still require length
  }

  function detectDuplicatePlate(plate) {
    const p = (plate||'').trim().toUpperCase();
    if(!p) return null;
    return STATE.items.find(i => (i.no||'').toUpperCase() === p);
  }

  // Suggest merge if typing a plate that already exists
  function showPlateHint(plate) {
    const hint = el('hint_plate');
    const dup = detectDuplicatePlate(plate);
    if(dup) {
      hint.textContent = `Plate exists ‚Äî owner: ${dup.owner || '‚Äî'} ‚Ä¢ Tap 'Copy' to duplicate or 'Edit' to modify.`;
      hint.style.color = '#FFD580';
      return dup;
    } else {
      hint.textContent = '';
      return null;
    }
  }

  // Auto-fill owner suggestions based on history for owner input
  function getOwnerSuggestions(prefix) {
    const p = (prefix||'').toLowerCase();
    const map = {};
    for(const it of STATE.items) {
      const name = (it.owner||'').trim();
      if(name.toLowerCase().startsWith(p) && name.length>0) map[name] = (map[name]||0) + 1;
    }
    return Object.keys(map).sort((a,b)=>map[b]-map[a]).slice(0,5);
  }

  /* ===========================
     UI RENDERING: List, Dashboard & Charts
     =========================== */

  // apply filters and search
  function applyFilters(items) {
    const q = (el('q').value||'').trim().toLowerCase();
    let out = items.slice();
    if(q) {
      out = out.filter(i=>{
        return (i.no||'').toLowerCase().includes(q) ||
               (i.owner||'').toLowerCase().includes(q) ||
               (i.notes||'').toLowerCase().includes(q);
      });
    }
    // sold filter
    if(STATE.filters.sold === 'sold') out = out.filter(i => i.sold);
    if(STATE.filters.sold === 'unsold') out = out.filter(i => !i.sold);
    // profit range
    if(STATE.filters.profitMin != null) out = out.filter(i => (i.netProfit||0) >= STATE.filters.profitMin);
    if(STATE.filters.profitMax != null) out = out.filter(i => (i.netProfit||0) <= STATE.filters.profitMax);
    if(STATE.filters.highProfitOnly) out = out.filter(i => (i.netProfit||0) >= 5000);
    if(STATE.filters.recentOnly) {
      const weekAgo = Date.now() - (7*24*3600*1000);
      out = out.filter(i => new Date(i._createdAt).getTime() >= weekAgo);
    }
    return out;
  }

  function applySort(items) {
    const s = STATE.sort;
    const k = s.key; const dir = Number(s.dir);
    if(!k) return items;
    return items.sort((a,b)=>{
      let va = a[k], vb = b[k];
      if(typeof va === 'string') va = va.toLowerCase();
      if(typeof vb === 'string') vb = vb.toLowerCase();
      if(va === vb) return 0;
      if(va == null) return 1;
      if(vb == null) return -1;
      return (va > vb ? 1 : -1) * dir;
    });
  }

  function paginate(items) {
    const p = STATE.page || 1;
    const ps = STATE.pageSize || DEFAULT_PAGE_SIZE;
    const total = Math.max(1, Math.ceil(items.length / ps));
    STATE.page = clamp(p,1,total);
    const start = (STATE.page-1) * ps;
    return { pageItems: items.slice(start, start+ps), totalPages: total };
  }

  // main render function for list
  function renderList() {
    const container = el('list');
    container.innerHTML = '';
    let items = applyFilters(STATE.items);
    items = applySort(items);
    const { pageItems, totalPages } = paginate(items);

    if(items.length === 0) {
      container.innerHTML = `<div class="card muted" style="text-align:center;padding:28px;border-radius:12px">
        <div style="font-size:1.2rem;margin-bottom:8px">No bikes yet</div>
        <div class="muted">Add your first bike with the + button. Import CSV to migrate data.</div>
      </div>`;
      el('listSummary').textContent = `Showing 0 records`;
      el('pageInfo').textContent = `‚Äî`;
      return;
    }

    for(const item of pageItems) {
      const li = document.createElement('div');
      li.className = 'list-item';
      // color code profit
      const profitColor = (item.netProfit >= 0) ? 'color:#7CFCB2;font-weight:800' : 'color:#FF7A7A;font-weight:800';
      li.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:6px">
          <div style="display:flex;gap:10px;align-items:center">
            <div style="font-weight:800">${escapeHtml(item.no)}</div>
            <div class="muted">${escapeHtml(item.owner)}</div>
            <div style="padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:700">${item.sold ? 'SOLD' : 'UNSOLD'}</div>
          </div>
          <div class="meta">${fmtMoney(item.sellingPrice)} ‚Ä¢ <span style="${profitColor}">${fmtMoney(item.netProfit)}</span></div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <div class="muted small">${item.datePurchase||''} ${item.dateSelling?('‚Üí '+item.dateSelling):''}</div>
          <div style="display:flex;gap:6px">
            <button class="btn-ghost" data-id="${item.id}" onclick="onEditClick(event)">Edit</button>
            <button class="btn-ghost" data-id="${item.id}" onclick="onCopyClick(event)">Copy</button>
          </div>
        </div>
      `;
      // tap-to-edit (mobile)
      li.addEventListener('click', (ev)=>{ if(ev.target.tagName.toLowerCase() === 'button') return; openEdit(item.id); });
      // swipe gestures basic (left to delete)
      addSwipeHandlers(li, item.id);
      container.appendChild(li);
    }

    el('listSummary').textContent = `Showing ${items.length} records (${pageItems.length} on this page)`;
    el('pageInfo').textContent = `${STATE.page} / ${totalPages}`;
    renderDashboardMetrics(items);
  }

  // small helper to escape html content
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // render dashboard metrics and charts
  let chartMonthly, chartDist, chartSold;
  function initCharts() {
    try {
      const ctxM = el('chartMonthly').getContext('2d');
      const ctxD = el('chartDist').getContext('2d');
      const ctxS = el('chartSold').getContext('2d');
      chartMonthly = new Chart(ctxM, { type:'line', data:{ labels:[], datasets:[{ label:'Net', data:[], tension:0.3, fill:true, backgroundColor:'rgba(0,208,255,0.12)', borderColor:ACCENT_FROM }] }, options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ x:{ display:true }, y:{ display:true } } } });
      chartDist = new Chart(ctxD, { type:'doughnut', data:{ labels:[], datasets:[{ data:[], backgroundColor: [ACCENT_FROM, ACCENT_TO, '#7C3AED', '#FB923C'] }] }, options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } } });
      chartSold = new Chart(ctxS, { type:'pie', data:{ labels:['Unsold','Sold'], datasets:[{ data:[1,1], backgroundColor:[ACCENT_FROM, ACCENT_TO] }] }, options:{ responsive:true } });
    } catch(e){ console.warn('Chart init failed', e); }
  }

  function updateCharts(items) {
    // monthly profit
    const map = {};
    items.forEach(it=>{
      const key = (it.dateSelling || it.datePurchase || '').slice(0,7) || 'Unknown';
      map[key] = (map[key]||0) + (Number(it.netProfit)||0);
    });
    const labels = Object.keys(map).sort();
    const values = labels.map(l=>round2(map[l]));
    if(chartMonthly){ chartMonthly.data.labels = labels; chartMonthly.data.datasets[0].data = values; chartMonthly.update(); }

    // distribution buckets
    const buckets = {'<0':0,'0-999':0,'1k-4.9k':0,'5k-9.9k':0,'10k+':0};
    items.forEach(i=>{
      const n = Number(i.netProfit||0);
      if(n<0) buckets['<0']++;
      else if(n<1000) buckets['0-999']++;
      else if(n<5000) buckets['1k-4.9k']++;
      else if(n<10000) buckets['5k-9.9k']++;
      else buckets['10k+']++;
    });
    if(chartDist){ chartDist.data.labels = Object.keys(buckets); chartDist.data.datasets[0].data = Object.values(buckets); chartDist.update(); }

    // sold vs unsold
    const sold = items.filter(i=>i.sold).length;
    const unsold = items.length - sold;
    if(chartSold){ chartSold.data.datasets[0].data = [unsold||0,sold||0]; chartSold.update(); }
  }

  function renderDashboardMetrics(filteredItems) {
    const totalPurchase = filteredItems.reduce((s,i)=>s+(Number(i.purchasePrice)||0),0);
    const totalRepair = filteredItems.reduce((s,i)=>s+(Number(i.repairCost)||0),0);
    const totalSelling = filteredItems.reduce((s,i)=>s+(Number(i.sellingPrice)||0),0);
    const totalNet = filteredItems.reduce((s,i)=>s+(Number(i.netProfit)||0),0);
    el('totalCount').textContent = filteredItems.length;
    el('unsoldCount').textContent = filteredItems.filter(i=>!i.sold).length;
    animateCounter(el('animatedProfit'), totalNet);

    const avgMargin = filteredItems.length ? Math.round((totalNet / Math.max(1, totalSelling)) * 100) : 0;
    el('insightsText').textContent = `Avg margin ${avgMargin}% ‚Ä¢ Avg profit ${fmtMoney(filteredItems.length ? (totalNet/filteredItems.length) : 0)}`;

    updateCharts(filteredItems);

    const top5 = filteredItems.slice().sort((a,b)=>b.netProfit - a.netProfit).slice(0,5);
    const top5El = el('top5'); top5El.innerHTML = '';
    top5.forEach(t=>{
      const li = document.createElement('li'); li.style.marginBottom='8px';
      li.innerHTML = `<div style="display:flex;justify-content:space-between"><div>${escapeHtml(t.no)} ‚Ä¢ ${escapeHtml(t.owner)}</div><div style="font-weight:800">${fmtMoney(t.netProfit)}</div></div>`;
      top5El.appendChild(li);
    });
  }

  // animate numeric counters (simple)
  let _animTick = null;
  function animateCounter(dom, target) {
    const current = Number(dom.getAttribute('data-val')||'0') || 0;
    const t = Number(target)||0;
    dom.setAttribute('data-val', String(t));
    if(_animTick) return;
    const steps = 24; let c = 0;
    const from = current; const delta = t - from;
    _animTick = setInterval(()=>{
      c++;
      const val = Math.round((from + (delta*(c/steps))) * 100)/100;
      dom.textContent = fmtMoney(val);
      if(c>=steps){ clearInterval(_animTick); _animTick = null; dom.textContent = fmtMoney(t); }
    }, 18);
  }

  /* ===========================
     IMPORT / EXPORT / BACKUP
     =========================== */

  // CSV helpers (naive but robust for our controlled format)
  function csvEscapeCell(v){ return `"${String(v||'').replace(/"/g,'""')}"`; }
  async function exportCSV(filename='bikes_export.csv') {
    const items = STATE.items.slice();
    if(items.length===0){ showToast('Nothing to export'); return; }
    const header = ['id','no','owner','purchasePrice','repairCost','sellingPrice','netProfit','roi','datePurchase','dateSelling','sold','notes','_updatedAt','_createdAt'];
    const rows = items.map(it => header.map(h => csvEscapeCell(it[h])).join(',')).join('\n');
    const blob = new Blob([header.join(',') + '\n' + rows], { type:'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
    showToast('CSV exported');
  }
  async function exportJSON(filename='bikes_export.json'){
    const blob = new Blob([JSON.stringify(STATE.items,null,2)], { type:'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
    showToast('JSON exported');
  }

  // import handlers
  async function importFromText(text, opts={confirmReplace:true}) {
    if(!text) return;
    if(text.trim().startsWith('{') || text.trim().startsWith('[')) {
      try {
        const arr = JSON.parse(text);
        if(Array.isArray(arr)) {
          if(opts.confirmReplace && !confirm('Importing JSON will merge with local data. Continue?')) return;
          for(const r of arr) {
            const rec = normalizeImportedRecord(r);
            const exists = STATE.items.find(i=>i.no === rec.no);
            if(exists) { rec.id = exists.id; } // replace
            await idbPut(DB_STORE,rec);
          }
          await loadAllToMemory(); renderAll(); showToast('JSON imported');
        }
      } catch(e){ showToast('JSON parse failed') }
      return;
    }
    // CSV parse
    const lines = text.split(/\r?\n/).filter(Boolean);
    if(lines.length<2) return showToast('No CSV rows found');
    const headers = lines.shift().split(',').map(h=>h.replace(/^"|"$/g,'').trim());
    for(const ln of lines) {
      const cells = ln.match(/("([^"]|"")*"|[^,]+)/g)?.map(c=>c.replace(/^"|"$/g,'').replace(/""/g,'"')) || [];
      const obj = {};
      headers.forEach((h,i)=> obj[h] = (cells[i] !== undefined ? cells[i] : ''));
      const rec = normalizeImportedRecord(obj);
      const conflict = STATE.items.find(i=>i.no === rec.no);
      if(conflict) {
        if(opts.confirmReplace) {
          const keep = confirm(`Record with plate ${rec.no} already exists. Replace? OK = replace, Cancel = keep both.`);
          if(keep){ rec.id = conflict.id; } else { rec.id = rec.no + '_' + uid(5); }
        } else { rec.id = rec.no + '_' + uid(5); }
      }
      await idbPut(DB_STORE,rec);
    }
    await loadAllToMemory(); renderAll(); showToast('CSV imported');
  }

  function normalizeImportedRecord(o) {
    const rec = {
      id: o.id || (o.no ? (o.no + '_' + uid(4)) : ('b_' + uid(8))),
      no: (o.no||o.No||'').toString().toUpperCase(),
      owner: o.owner || '',
      purchasePrice: Number(o.purchasePrice||0),
      repairCost: Number(o.repairCost||0),
      sellingPrice: Number(o.sellingPrice||0),
      netProfit: round2(Number(o.netProfit) || (Number(o.sellingPrice||0) - (Number(o.purchasePrice||0)+Number(o.repairCost||0)))),
      roi: Number(o.roi||0),
      datePurchase: o.datePurchase || '',
      dateSelling: o.dateSelling || '',
      notes: o.notes || '',
      sold: (o.sold === true || o.sold === 'true' || (o.dateSelling && o.dateSelling.length>0)) ? true : false,
      _createdAt: o._createdAt || nowISO(),
      _updatedAt: nowISO()
    };
    return rec;
  }

  /* AES-GCM encryption for backups using Web Crypto */
  async function generateKeyFromPassword(pw, salt) {
    const enc = new TextEncoder();
    const baseKey = await crypto.subtle.importKey('raw', enc.encode(pw), 'PBKDF2', false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey({ name:'PBKDF2', salt: enc.encode(salt), iterations: 250000, hash:'SHA-256' }, baseKey, { name:'AES-GCM', length:256 }, true, ['encrypt','decrypt']);
    return key;
  }
  async function encryptBackup(password, json) {
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const salt = uid(12);
    const key = await generateKeyFromPassword(password, salt);
    const enc = new TextEncoder();
    const ct = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, enc.encode(json));
    const combined = new Uint8Array(ct.byteLength + iv.byteLength);
    combined.set(iv, 0); combined.set(new Uint8Array(ct), iv.byteLength);
    const b64 = btoa(String.fromCharCode(...combined));
    return { salt, data: b64 };
  }
  async function decryptBackup(password, salt, b64) {
    const combined = Uint8Array.from(atob(b64), c=>c.charCodeAt(0));
    const iv = combined.slice(0,12);
    const ct = combined.slice(12);
    const key = await generateKeyFromPassword(password, salt);
    const plain = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, ct);
    const dec = new TextDecoder().decode(plain);
    return dec;
  }

  async function backupNow() {
    const items = await idbGetAll(DB_STORE);
    const json = JSON.stringify({ meta:{v:APP_VERSION, at:nowISO()}, items }, null, 2);
    const pw = prompt('Enter a password to encrypt backup (leave blank to download unencrypted)');
    if(pw) {
      const { salt, data } = await encryptBackup(pw, json);
      const payload = JSON.stringify({ salt, data });
      const blob = new Blob([payload], { type:'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `bike_backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.encrypted.json`; a.click();
      showToast('Encrypted backup downloaded');
    } else {
      const blob = new Blob([json], { type:'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `bike_backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`; a.click();
      showToast('Backup downloaded');
    }
  }

  /* ===========================
     GIST SYNC MANAGER
     - Read public gist by ID
     - Update or create gist requires token (scope: gist)
     - Merge logic uses _updatedAt timestamp
     =========================== */

  async function fetchGist(gistId) {
    const url = `https://api.github.com/gists/${gistId}`;
    const r = await fetch(url);
    if(!r.ok) throw new Error(`Gist fetch failed: ${r.status}`);
    return await r.json();
  }

  async function pushGist(gistId, token, filename, content, description='Bike Manager CSV backup') {
    const baseUrl = gistId ? `https://api.github.com/gists/${gistId}` : `https://api.github.com/gists`;
    const body = gistId ? { files: { [filename]: { content } }, description } : { files: { [filename]: { content } }, public: true, description };
    const r = await fetch(baseUrl, { method: gistId ? 'PATCH' : 'POST', headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' }, body: JSON.stringify(body) });
    if(!r.ok) { const txt = await r.text(); throw new Error(`Gist push failed: ${r.status} ${txt}`); }
    const j = await r.json();
    return j;
  }

  // Parse CSV text into normalized records
  function parseCsvToRecords(csvText) {
    const lines = csvText.split(/\r?\n/).filter(Boolean);
    if(lines.length===0) return [];
    const headers = lines.shift().split(',').map(h=>h.replace(/^"|"$/g,'').trim());
    const out = [];
    for(const ln of lines) {
      const cells = ln.match(/("([^"]|"")*"|[^,]+)/g)?.map(c=>c.replace(/^"|"$/g,'').replace(/""/g,'"')) || [];
      const o = {};
      headers.forEach((h,i)=> o[h] = (cells[i] !== undefined ? cells[i] : ''));
      out.push(normalizeImportedRecord(o));
    }
    return out;
  }

  async function syncNow() {
    if(STATE.syncing) { showToast('Already syncing‚Ä¶'); return; }
    if(!STATE.gistConfig.id) { showToast('No Gist ID configured ‚Äî set it in Settings'); return; }
    STATE.syncing = true; updateSyncUI();
    try {
      const gist = await fetchGist(STATE.gistConfig.id);
      // pick file: bikes_db.csv or first file
      let file = gist.files[GIST_FILENAME] || null;
      if(!file) {
        for(const k in gist.files){ file = gist.files[k]; break; }
      }
      if(!file){ showToast('No file in gist'); STATE.syncing=false; updateSyncUI(); return; }
      const remoteCsv = file.content;
      const remoteRecs = parseCsvToRecords(remoteCsv);
      const remoteMap = new Map(remoteRecs.map(r=>[r.no, r]));
      const local = await idbGetAll(DB_STORE);
      const localMap = new Map(local.map(r=>[r.no, r]));

      const merged = [];
      for(const key of new Set([...localMap.keys(), ...remoteMap.keys()])) {
        const localRec = localMap.get(key);
        const remoteRec = remoteMap.get(key);
        if(localRec && remoteRec) {
          const lt = new Date(localRec._updatedAt || 0).getTime();
          const rt = new Date(remoteRec._updatedAt || 0).getTime();
          // if local newer, keep local, else remote
          if(Math.abs(lt-rt) < 1000) {
            merged.push({...remoteRec, id: localRec.id, _updatedAt: localRec._updatedAt});
          } else if(lt > rt) {
            merged.push(localRec);
          } else {
            merged.push({...remoteRec, id: localRec.id || ('b_' + uid(6))});
          }
        } else if(localRec) merged.push(localRec);
        else if(remoteRec) merged.push({...remoteRec, id: remoteRec.id || ('b_' + uid(6))});
      }

      // write merged set to DB (clear then insert)
      const dbInstance = await openDb();
      await new Promise((res,rej)=>{
        const tx = dbInstance.transaction(DB_STORE,'readwrite');
        tx.objectStore(DB_STORE).clear();
        tx.oncomplete = ()=>res(true);
        tx.onerror = e=>rej(e);
      });
      for(const r of merged) await idbPut(DB_STORE, r);
      await loadAllToMemory();

      // push merged back if token available (update gist)
      if(STATE.gistConfig.token) {
        const header = ['id','no','owner','purchasePrice','repairCost','sellingPrice','netProfit','roi','datePurchase','dateSelling','sold','notes','_updatedAt','_createdAt'];
        const rows = merged.map(it => header.map(h => (it[h] === undefined ? '' : String(it[h]).replace(/"/g,'""'))).map(csvEscapeCell).join(',')).join('\n');
        const csv = header.join(',') + '\n' + rows;
        try {
          await pushGist(STATE.gistConfig.id, STATE.gistConfig.token, GIST_FILENAME, csv, 'Bike Manager sync ' + nowISO());
          showToast('Synced with Gist ‚úì');
        } catch(e) { console.warn('Push failed', e); showToast('Merged locally; Gist push failed (check token)'); }
      } else {
        showToast('Merged remote into local (no token to push)');
      }
      STATE.lastSync = nowISO(); STATE.syncing = false; updateSyncUI(); renderAll();
    } catch(e) {
      console.error(e);
      showToast('Sync failed: ' + (e.message||e));
      STATE.syncing = false; STATE.isOnline = navigator.onLine; updateSyncUI();
    }
  }

  /* ===========================
     SERVICE WORKER: dynamic blob registration
     - caches app shell and Chart.js
     - basic fetch strategy with cache-first fallback
     =========================== */

  async function registerSW() {
    if(!('serviceWorker' in navigator)) return;
    const swCode = `
      const CACHE_NAME = 'bike-manager-v3-cache-${APP_VERSION}';
      const ASSETS = [
        // app shell
        '/',
        location.pathname,
        'https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js'
      ];
      self.addEventListener('install', evt => {
        self.skipWaiting();
        evt.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(ASSETS).catch(()=>{})));
      });
      self.addEventListener('activate', evt => {
        evt.waitUntil(clients.claim());
        evt.waitUntil(caches.keys().then(keys => Promise.all(keys.filter(k=>k!==CACHE_NAME).map(k=>caches.delete(k)))));
      });
      self.addEventListener('fetch', evt => {
        if(evt.request.method !== 'GET') return;
        evt.respondWith(caches.match(evt.request).then(r => r || fetch(evt.request).then(res => { try{ caches.open(CACHE_NAME).then(c=>c.put(evt.request, res.clone())); }catch(e){} return res; }).catch(()=>caches.match('/'))));
      });
      self.addEventListener('message', ev => {
        if(ev.data && ev.data.type === 'CHECK_UPDATE') {
          self.clients.matchAll().then(clients => clients.forEach(c=>c.postMessage({ type:'SW_UPDATE' })));
        }
      });
    `;
    try {
      const blob = new Blob([swCode], { type:'text/javascript' });
      const url = URL.createObjectURL(blob);
      const reg = await navigator.serviceWorker.register(url);
      console.log('SW registered', reg);
      navigator.serviceWorker.addEventListener('message', (ev)=>{
        if(ev.data && ev.data.type === 'SW_UPDATE') {
          if(confirm('New version available ‚Äî refresh now?')) location.reload();
        }
      });
    } catch(e){ console.warn('SW register failed', e); }
  }

  /* ===========================
     UI INTERACTIONS & EVENT BINDINGS
     =========================== */

  function registerUI() {
    // search input
    el('q').addEventListener('input', debounce(()=>{ STATE.page = 1; renderList(); localStorage.setItem('bm_last_search', el('q').value); }, 200));
    el('clearSearch').addEventListener('click', ()=>{ el('q').value=''; renderList(); });

    // paging
    el('prevPage').addEventListener('click', ()=>{ STATE.page = Math.max(1, STATE.page-1); renderList(); });
    el('nextPage').addEventListener('click', ()=>{ STATE.page = STATE.page + 1; renderList(); });

    // sort
    el('sortKey').addEventListener('change', (e)=>{ STATE.sort.key = e.target.value; renderList(); saveViewPrefs(); });
    el('sortDir').addEventListener('change', (e)=>{ STATE.sort.dir = Number(e.target.value); renderList(); saveViewPrefs(); });

    // add quick
    el('addQuick').addEventListener('click', ()=>{ openEdit(); });

    // open settings / close
    el('openSettings').addEventListener('click', ()=>{ el('settings').style.display='block'; loadSettingsUI(); });
    el('closeSettings').addEventListener('click', ()=>{ el('settings').style.display='none'; saveSettingsUI(); });

    // Open add via bottom nav or fab
    el('fabAdd').addEventListener('click', ()=>openEdit());
    el('navAdd').addEventListener('click', ()=>openEdit());
    el('navList').addEventListener('click', ()=>{ scrollToTop(); });

    // open/close edit
    el('closeEdit').addEventListener('click', ()=> el('editPanel').style.display='none');

    // live net calculation & duplicate detection
    ['f_purchase','f_repair','f_selling','f_no','f_owner'].forEach(id=>{
      const elx = el(id);
      if(!elx) return;
      elx.addEventListener('input', debounce(()=> {
        const p = Number(el('f_purchase').value)||0;
        const r = Number(el('f_repair').value)||0;
        const s = Number(el('f_selling').value)||0;
        el('liveNet').textContent = fmtMoney(round2(s - (p + r)));
        // ROI label
        const roi = (p>0) ? round2(((s - (p+r)) / p) * 100) : 0;
        el('roiLabel').textContent = roi ? `ROI ${roi}%` : '';
        // plate duplicate hint
        if(id==='f_no') showPlateHint(el('f_no').value);
        // owner suggestions
        if(id==='f_owner') {
          const sug = getOwnerSuggestions(el('f_owner').value);
          el('hint_owner').textContent = sug.length ? `Suggestions: ${sug.join(', ')}` : '';
        }
        // smart alert if selling < cost
        if(s < (p + r)) {
          el('hint_plate').textContent = `Warning: Selling ‚Çπ${s} is less than cost ‚Çπ${p + r}`; el('hint_plate').style.color = '#FFB4B4';
        } else { if(!detectDuplicatePlate(el('f_no').value)) el('hint_plate').textContent=''; }
      }, 120));
    });

    // save
    el('saveBtn').addEventListener('click', async ()=>{
      const rec = gatherForm();
      if(!rec) return;
      await saveItem(rec, true);
      el('editPanel').style.display='none';
      haptic('light'); showToast('Saved locally ‚úì');
      // milestone confetti
      checkConfettiTheshold();
    });

    el('saveNewBtn').addEventListener('click', async ()=>{
      const rec = gatherForm();
      if(!rec) return;
      await saveItem(rec, true);
      clearFormInputs(); el('f_no').focus();
      haptic('light'); showToast('Saved ‚úì ‚Äî add next');
    });

    el('deleteBtn').addEventListener('click', async ()=>{
      const id = el('f_id').value;
      if(!id) { showToast('Select an existing record to delete'); return; }
      if(confirm('Delete this record?')) {
        await deleteItem(id);
        el('editPanel').style.display='none';
        showToast('Deleted ‚úì'); haptic('medium');
      }
    });

    // import/export/backup buttons
    el('importBtn').addEventListener('click', ()=> el('fileInput').click());
    el('fileInput').addEventListener('change', async (ev)=>{
      const f = ev.target.files[0]; if(!f) return;
      const text = await f.text(); await importFromText(text, {confirmReplace:true}); el('fileInput').value='';
    });
    el('exportBtn').addEventListener('click', ()=> {
      const which = prompt('Export as: csv / json', 'csv');
      if(which && which.toLowerCase().startsWith('j')) exportJSON();
      else exportCSV();
    });
    el('backupNow').addEventListener('click', backupNow);
    el('syncNow').addEventListener('click', async ()=>{
      // persist gist config to meta and then sync
      STATE.gistConfig.id = el('gistId').value.trim() || STATE.gistConfig.id;
      STATE.gistConfig.token = el('gistToken').value.trim() || STATE.gistConfig.token;
      await saveMeta('gistConfig', STATE.gistConfig);
      await syncNow();
    });

    // gist test/create
    el('testGist').addEventListener('click', async ()=>{
      const gid = el('gistId').value.trim();
      if(!gid) return showToast('Enter Gist ID first');
      try { const gist = await fetchGist(gid); el('gistLabel').textContent = 'Gist: ' + (gist.description || gist.id); showToast('Gist reachable ‚úì'); } catch(e){ showToast('Gist fetch failed'); }
    });
    el('createGist').addEventListener('click', async ()=>{
      const tok = prompt('Paste GitHub token with gist scope to create a public gist (it will be saved locally)');
      if(!tok) return;
      const sample = 'id,no,owner,purchasePrice,repairCost,sellingPrice,netProfit,roi,datePurchase,dateSelling,sold,notes,_updatedAt,_createdAt\n';
      try {
        const res = await pushGist(null, tok, GIST_FILENAME, sample, 'Bike Manager new gist');
        STATE.gistConfig.id = res.id; STATE.gistConfig.token = tok;
        await saveMeta('gistConfig', STATE.gistConfig);
        el('gistId').value = STATE.gistConfig.id; el('gistToken').value = STATE.gistConfig.token;
        el('gistLabel').textContent = 'Gist: ' + STATE.gistConfig.id;
        showToast('Created Gist ' + STATE.gistConfig.id);
      } catch(e){ showToast('Create gist failed'); }
    });

    // settings: backup/restore
    el('exportAll').addEventListener('click', backupNow);
    el('importAll').addEventListener('click', async ()=>{
      const f = await pickFile(); if(!f) return;
      const text = await f.text();
      try {
        const parsed = JSON.parse(text);
        if(parsed.salt && parsed.data) {
          const pw = prompt('Enter password to decrypt backup');
          if(!pw) return;
          const dec = await decryptBackup(pw, parsed.salt, parsed.data);
          const obj = JSON.parse(dec);
          if(obj.items) {
            if(confirm('Restore backup? This will merge with current data. OK to continue?')) {
              for(const r of obj.items) await idbPut(DB_STORE, r);
              await loadAllToMemory(); renderAll(); showToast('Restored');
            }
          }
        } else {
          const obj = JSON.parse(text);
          if(confirm('Restore backup? This will merge with current data. OK?')) {
            for(const r of obj.items) await idbPut(DB_STORE, r);
            await loadAllToMemory(); renderAll(); showToast('Restored');
          }
        }
      } catch(e){ showToast('Backup read failed'); }
    });

    // clear data
    el('clearData').addEventListener('click', async ()=>{
      if(!confirm('Reset all app data? This cannot be undone.')) return;
      const db = await openDb();
      const tx = db.transaction(DB_STORE,'readwrite'); tx.objectStore(DB_STORE).clear();
      const tx2 = db.transaction(META_STORE,'readwrite'); tx2.objectStore(META_STORE).clear();
      showToast('All data cleared'); await loadAllToMemory(); renderAll();
    });

    // nav handlers
    el('navList').addEventListener('click', ()=>{ scrollToTop(); });
    el('navStats').addEventListener('click', ()=>{ scrollToCharts(); });
    el('navSettings').addEventListener('click', ()=>{ el('settings').style.display='block'; });

    // keyboard shortcuts (desktop)
    window.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key === 'z') undo();
      if((e.ctrlKey||e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'Z'))) redo();
      if((e.ctrlKey||e.metaKey) && e.key === 'i'){ e.preventDefault(); el('fileInput').click(); }
      if((e.ctrlKey||e.metaKey) && e.key === 's'){ e.preventDefault(); showToast('Saved (auto)'); }
    });

    // service worker update listener is in registerSW

    // initial view prefs
    loadViewPrefs();
  }

  // helpers for file picking
  function pickFile(){ return new Promise(resolve => { const input = document.createElement('input'); input.type='file'; input.accept='.json,.encrypted.json'; input.onchange = ()=> resolve(input.files[0]); input.click(); }); }

  /* ===========================
     FORM & EDIT PANEL HELPERS
     =========================== */

  function openEdit(id=null) {
    el('editPanel').style.display = 'block';
    if(id) {
      const item = STATE.items.find(i=>i.id === id);
      if(item) fillForm(item);
    } else {
      clearFormInputs();
      // auto-fill date with today
      const today = new Date().toISOString().slice(0,10);
      el('f_datePurchase').value = today;
      el('f_dateSelling').value = '';
      el('f_no').focus();
    }
  }

  function fillForm(item) {
    el('f_id').value = item.id || '';
    el('f_no').value = item.no || '';
    el('f_owner').value = item.owner || '';
    el('f_purchase').value = item.purchasePrice || '';
    el('f_repair').value = item.repairCost || 0;
    el('f_selling').value = item.sellingPrice || '';
    el('f_notes').value = item.notes || '';
    el('f_datePurchase').value = item.datePurchase || '';
    el('f_dateSelling').value = item.dateSelling || '';
    el('f_sold').value = item.sold ? 'yes' : 'no';
    el('liveNet').textContent = fmtMoney(item.netProfit || 0);
    el('roiLabel').textContent = item.roi ? `ROI ${item.roi}%` : '';
  }

  function clearFormInputs() {
    el('f_id').value=''; el('f_no').value=''; el('f_owner').value=''; el('f_purchase').value=''; el('f_repair').value='0'; el('f_selling').value=''; el('f_notes').value=''; el('f_datePurchase').value=''; el('f_dateSelling').value=''; el('f_sold').value='no'; el('liveNet').textContent = fmtMoney(0); el('roiLabel').textContent='';
  }

  function gatherForm() {
    const no = (el('f_no').value||'').trim().toUpperCase();
    if(!isValidPlate(no)) { alert('Enter a valid plate (e.g. GJ05AB1234)'); return null; }
    const owner = (el('f_owner').value||'').trim(); if(!owner){ alert('Owner required'); return null; }
    const purchase = Number(el('f_purchase').value)||0;
    const repair = Number(el('f_repair').value)||0;
    const selling = Number(el('f_selling').value)||0;
    const net = round2(selling - (purchase + repair));
    const id = el('f_id').value || (no + '_' + uid(5));
    const rec = { id, no, owner, purchasePrice:purchase, repairCost:repair, sellingPrice:selling, netProfit:net, roi: (purchase>0? round2((net/purchase)*100) : 0), datePurchase: el('f_datePurchase').value||'', dateSelling: el('f_dateSelling').value||'', notes: el('f_notes').value||'', sold: el('f_sold').value === 'yes', _updatedAt: nowISO(), _createdAt: el('f_id').value ? (STATE.items.find(i=>i.id===el('f_id').value)? STATE.items.find(i=>i.id===el('f_id').value)._createdAt : nowISO()) : nowISO() };
    return rec;
  }

  // Edit and Copy handlers attached inline in renderList
  window.onEditClick = function(ev){ ev.stopPropagation(); const id = ev.target.dataset.id; openEdit(id); };
  window.onCopyClick = async function(ev){ ev.stopPropagation(); const id = ev.target.dataset.id; const item = STATE.items.find(i=>i.id===id); if(!item) return; const copy = {...item, id: item.no + '_' + uid(5), no: item.no + '_COPY', _createdAt: nowISO(), _updatedAt: nowISO() }; await idbPut(DB_STORE, copy); await loadAllToMemory(); renderAll(); showToast('Copied record'); };

  /* ===========================
     SWIPE HANDLERS (simple)
     =========================== */
  function addSwipeHandlers(elm, id) {
    let startX=0, startY=0, moved=false;
    elm.addEventListener('touchstart', (e)=>{ const t=e.touches[0]; startX=t.clientX; startY=t.clientY; moved=false; });
    elm.addEventListener('touchmove', (e)=>{ const t=e.touches[0]; const dx = t.clientX - startX; const dy = Math.abs(t.clientY - startY); if(Math.abs(dx) > 30 && dy < 40){ moved=true; elm.style.transform = `translateX(${dx}px)`; } });
    elm.addEventListener('touchend', async (e)=>{ if(!moved){ elm.style.transform=''; return; } const t = e.changedTouches[0]; const dx = t.clientX - startX; elm.style.transform=''; if(dx < -80){ // swipe left -> delete
        if(confirm('Delete this record?')){ await deleteItem(id); showToast('Deleted'); haptic('medium'); }
      } else if(dx > 80){ // swipe right -> open edit
        openEdit(id);
      } else { /* revert */ }
    });
  }

  /* ===========================
     VIEW PREFERENCES (save sort/filters)
     =========================== */
  function saveViewPrefs() {
    const prefs = { sort: STATE.sort, filters: STATE.filters, pageSize: STATE.pageSize };
    localStorage.setItem('bm_view_prefs', JSON.stringify(prefs));
  }
  function loadViewPrefs() {
    const saved = safeParse(localStorage.getItem('bm_view_prefs')||'null');
    if(saved) {
      STATE.sort = saved.sort || STATE.sort;
      STATE.filters = saved.filters || STATE.filters;
      STATE.pageSize = saved.pageSize || STATE.pageSize;
      el('sortKey').value = STATE.sort.key; el('sortDir').value = STATE.sort.dir;
    }
    // last search memory
    const q = localStorage.getItem('bm_last_search') || '';
    el('q').value = q;
  }

  /* ===========================
     STORAGE META (gist config etc.)
     =========================== */
  async function saveMeta(k,v){ await idbPut(META_STORE, { k, v }); if(k==='gistConfig'){ STATE.gistConfig = v; el('gistLabel').textContent = 'Gist: ' + (v.id||'‚Äî'); } }
  async function loadMeta(k){ const got = await idbGet(META_STORE, k); return got ? got.v : null; }

  async function loadSettingsUI(){
    const gc = await loadMeta('gistConfig'); if(gc){ STATE.gistConfig = gc; el('gistId').value = gc.id || ''; el('gistToken').value = gc.token || ''; el('gistLabel').textContent = 'Gist: ' + (gc.id || '‚Äî'); }
    const ai = await loadMeta('autoBackupInterval'); if(ai) el('autoBackupInterval').value = ai || '0';
  }

  async function saveSettingsUI(){
    const id = el('gistId').value.trim(); const tok = el('gistToken').value.trim();
    STATE.gistConfig.id = id || STATE.gistConfig.id; STATE.gistConfig.token = tok || STATE.gistConfig.token;
    await saveMeta('gistConfig', STATE.gistConfig);
    await saveMeta('autoBackupInterval', el('autoBackupInterval').value);
    showToast('Settings saved');
  }

  /* ===========================
     SYNC UI
     =========================== */
  function updateSyncUI(){
    const sIcon = el('syncIcon'), sText = el('syncText');
    if(STATE.syncing){ sIcon.textContent='‚è≥'; sText.textContent='Syncing‚Ä¶'; }
    else if(STATE.isOnline) { sIcon.textContent='‚úÖ'; sText.textContent = (STATE.lastSync ? 'Up to date' : 'Online'); }
    else { sIcon.textContent='‚è∫'; sText.textContent='Offline'; }
  }

  /* ===========================
     SMALL HELPERS
     =========================== */
  function debounce(fn, t=200){ let id; return (...args)=>{ clearTimeout(id); id=setTimeout(()=>fn(...args), t); }; }
  function scrollToTop(){ window.scrollTo({ top: 0, behavior:'smooth' }); }
  function scrollToCharts(){ const rect = el('chartsArea').getBoundingClientRect(); window.scrollTo({ top: window.scrollY + rect.top - 80, behavior:'smooth' }); }

  /* ===========================
     CONFETTI (simple)
     =========================== */
  const confetti = {
    canvas: null, ctx: null, particles: [], running:false,
    init() { this.canvas = el('confettiCanvas'); this.ctx = this.canvas.getContext('2d'); this.resize(); window.addEventListener('resize', ()=>this.resize()); },
    resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },
    burst(x, y) {
      for(let i=0;i<80;i++){
        this.particles.push({ x, y, vx:(Math.random()-0.5)*8, vy:Math.random()*-12 - 4, r:Math.random()*6+4, color: `hsl(${Math.round(Math.random()*360)}, 85%, 60%)`, life: Math.random()*60+60 });
      }
      if(!this.running) this.run();
    },
    run() {
      this.running = true;
      const loop = ()=>{
        const ctx = this.ctx; ctx.clearRect(0,0,this.canvas.width, this.canvas.height);
        for(let i=this.particles.length-1;i>=0;i--){
          const p = this.particles[i];
          p.vy += 0.4; p.x += p.vx; p.y += p.vy; p.life--;
          ctx.fillStyle = p.color; ctx.beginPath(); ctx.ellipse(p.x,p.y,p.r,p.r*0.6,0,0,Math.PI*2); ctx.fill();
          if(p.life<=0 || p.y>this.canvas.height+50) this.particles.splice(i,1);
        }
        if(this.particles.length>0) requestAnimationFrame(loop); else this.running=false;
      };
      requestAnimationFrame(loop);
    }
  };

  function checkConfettiTheshold(){
    // if total profit crosses a milestone (e.g., every 100000), burst
    const totalNet = STATE.items.reduce((s,i)=>s+(Number(i.netProfit)||0),0);
    const last = Number(localStorage.getItem('bm_last_milestone')||'0');
    const milestone = Math.floor(totalNet / 100000) * 100000;
    if(milestone > last && milestone > 0) {
      localStorage.setItem('bm_last_milestone', String(milestone));
      confetti.burst(window.innerWidth/2, window.innerHeight/3);
      showToast('Congrats! Profit milestone reached üéâ', 3200);
    }
  }

  /* ===========================
     BOOTSTRAP & INITIALIZATION
     =========================== */

  async function renderAll() {
    renderList();
    updateSyncUI();
  }

  async function initApp() {
    try {
      await openDb();
      await migrateFromLocalStorage();
      await loadAllToMemory();
      initCharts();
      registerUI();
      renderAll();
      if('serviceWorker' in navigator) await registerSW();
      confetti.init();
      // load meta
      const gc = await loadMeta('gistConfig'); if(gc) { STATE.gistConfig = gc; el('gistId').value = gc.id || ''; el('gistToken').value = gc.token || ''; el('gistLabel').textContent = 'Gist: ' + (gc.id||'‚Äî'); }
      window.addEventListener('online', ()=>{ STATE.isOnline = true; updateSyncUI(); showToast('Back online'); });
      window.addEventListener('offline', ()=>{ STATE.isOnline = false; updateSyncUI(); showToast('Offline mode'); });
      // auto-backup if configured
      const autoBackup = await loadMeta('autoBackupInterval'); if(autoBackup && Number(autoBackup)>0) setInterval(()=>backupNow(), Number(autoBackup)*3600*1000);
    } catch(e){ console.error(e); showToast('Init error: ' + (e.message || e)); }
  }

  // expose some functions for console/debug
  window.bm = { openDb, idbGetAll, exportCSV, exportJSON, syncNow, undo, redo, backupNow };

  // start
  initApp();

  // load previously saved view prefs
  loadViewPrefs();

  // load last search state
  el('q').value = localStorage.getItem('bm_last_search') || '';

  </script>
</body>
</html>
