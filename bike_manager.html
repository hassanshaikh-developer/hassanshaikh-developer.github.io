<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bike Manager — GitHub Hosted</title>
  <meta name="description" content="Advanced second-hand bike inventory manager. Stores data in bikes.csv on GitHub. Packed with features: search, sort, filter, pagination, dark/light mode, charts, backups, imports, validations, and more." />
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    :root {
      --bg: #0a1120;
      --card: #111b2e;
      --accent: #00d0ff;
      --muted: #a0aec0;
      --text: #f1f5f9;
      --radius: 14px;
      --shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      --danger: #ff4d4f;
      --success: #52c41a;
      --warning: #faad14;
      --border: rgba(255,255,255,0.08);
    }
    [data-theme="light"] {
      --bg: #f0f2f5;
      --card: #ffffff;
      --accent: #1890ff;
      --muted: #5c6b7a;
      --text: #1a1a1a;
      --shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      --danger: #f5222d;
      --success: #52c41a;
      --warning: #faad14;
      --border: rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Poppins', system-ui, sans-serif;
      background: radial-gradient(circle at top, #0d1a2b, #050912 70%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      transition: background 0.3s ease;
    }
    [data-theme="light"] body {
      background: #f0f2f5;
    }
    .wrap {
      width: 100%;
      max-width: 1200px;
      padding: 20px;
      animation: fadeIn 0.8s ease;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }
    h1 {
      font-size: 1.6rem;
      margin: 0;
      background: linear-gradient(to right, var(--accent), #38bdf8);
      -webkit-background-clip: text;
      color: transparent;
      font-weight: 600;
    }
    .note {
      font-size: 0.85rem;
      color: var(--muted);
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    button {
      padding: 10px 16px;
      border-radius: var(--radius);
      border: none;
      background: var(--accent);
      color: #031520;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }
    [data-theme="light"] button {
      color: #ffffff;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 208, 255, 0.4);
    }
    button.ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }
    button.danger { background: var(--danger); }
    button.success { background: var(--success); }
    button.warning { background: var(--warning); }
    section.card {
      background: rgba(255,255,255,0.03);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(8px);
      margin-bottom: 16px;
    }
    [data-theme="light"] section.card {
      background: #ffffff;
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 4px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      font-size: 0.9rem;
    }
    [data-theme="light"] input, [data-theme="light"] select, [data-theme="light"] textarea {
      background: #f9f9f9;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.08);
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      grid-column: 1 / -1;
      justify-content: space-between;
    }
    .search-sort {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    #search { flex: 1; min-width: 200px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      border-radius: var(--radius);
      overflow: hidden;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }
    th {
      color: var(--muted);
      font-weight: 500;
      background: rgba(255,255,255,0.04);
      cursor: pointer;
      user-select: none;
    }
    [data-theme="light"] th {
      background: #f0f2f5;
    }
    th.sort-asc::after { content: ' ▲'; }
    th.sort-desc::after { content: ' ▼'; }
    tr.selected {
      background: linear-gradient(90deg, rgba(0,208,255,0.08), rgba(0,208,255,0.03));
    }
    tr:hover {
      background: rgba(255,255,255,0.05);
      cursor: pointer;
    }
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
    }
    .pagination button {
      padding: 6px 12px;
      font-size: 0.8rem;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat-card {
      background: rgba(255,255,255,0.05);
      padding: 12px;
      border-radius: var(--radius);
      text-align: center;
    }
    [data-theme="light"] .stat-card {
      background: #f9f9f9;
    }
    .stat-value {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--accent);
    }
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }
    canvas {
      max-width: 100%;
      height: auto;
      margin-top: 16px;
      border-radius: var(--radius);
    }
    .backup-section {
      margin-top: 16px;
    }
    .import-input {
      display: none;
    }
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .modal.open {
      visibility: visible;
      opacity: 1;
    }
    .modal-content {
      background: var(--card);
      padding: 20px;
      border-radius: var(--radius);
      max-width: 500px;
      width: 90%;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.3rem; }
      button { flex: 1; }
      .search-sort { flex-direction: column; }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Bike Manager — GitHub Hosted</h1>
        <div class="note">Data stored in <code>bikes.csv</code> (same directory). Fork repo to edit. Read-only without auth token.</div>
      </div>
      <div class="controls">
        <button id="btnLoad" class="ghost">Load CSV</button>
        <button id="btnCommit" class="success">Commit Changes</button>
        <button id="btnTheme">Light Mode</button>
        <button id="btnBackup" class="ghost">Backup/Restore</button>
        <button id="btnClear" class="ghost danger">Clear Local</button>
      </div>
    </header>

    <section class="card">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="statTotal">0</div>
          <div>Total Bikes</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statInStock">0</div>
          <div>In Stock</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statSold">0</div>
          <div>Sold</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statProfit">0</div>
          <div>Total Profit</div>
        </div>
      </div>
    </section>

    <section class="card">
      <form id="bikeForm">
        <div>
          <label for="colNo">Bike Number <span class="note">(Indian plate)</span></label>
          <input id="colNo" type="text" placeholder="GJ05AB1234" required />
        </div>
        <div>
          <label for="owner">Owner Name</label>
          <input id="owner" type="text" required />
        </div>
        <div>
          <label for="model">Model</label>
          <input id="model" type="text" />
        </div>
        <div>
          <label for="status">Status</label>
          <select id="status">
            <option value="in_stock">In Stock</option>
            <option value="sold">Sold</option>
            <option value="repair">In Repair</option>
          </select>
        </div>
        <div>
          <label for="purchasePrice">Purchase Price</label>
          <input id="purchasePrice" type="number" step="0.01" required />
        </div>
        <div>
          <label for="repairCost">Repair Cost</label>
          <input id="repairCost" type="number" step="0.01" value="0" />
        </div>
        <div>
          <label for="sellingPrice">Selling Price</label>
          <input id="sellingPrice" type="number" step="0.01" />
        </div>
        <div>
          <label for="netProfit">Net Profit <span class="note">(auto)</span></label>
          <input id="netProfit" type="number" step="0.01" readonly />
        </div>
        <div>
          <label for="datePurchase">Purchase Date</label>
          <input id="datePurchase" type="date" />
        </div>
        <div>
          <label for="dateSelling">Selling Date</label>
          <input id="dateSelling" type="date" />
        </div>
        <div>
          <label for="notes">Notes</label>
          <textarea id="notes" rows="2"></textarea>
        </div>
        <div class="actions">
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="btnAdd" type="button">Add Bike</button>
            <button id="btnUpdate" type="button" class="ghost">Update</button>
            <button id="btnDelete" type="button" class="ghost danger">Delete</button>
            <button id="btnDuplicate" type="button" class="ghost warning">Duplicate</button>
            <label class="ghost" style="cursor:pointer;">
              <input type="file" id="importFile" accept=".csv,.xlsx" class="import-input"> Import CSV/Excel
            </label>
          </div>
        </div>
      </form>
    </section>

    <section class="card">
      <div class="search-sort">
        <input id="search" type="text" placeholder="Search any field..." />
        <select id="sortField">
          <option value="">Sort By...</option>
          <option value="no">Bike No</option>
          <option value="owner">Owner</option>
          <option value="purchasePrice">Purchase Price</option>
          <option value="netProfit">Net Profit</option>
          <option value="datePurchase">Purchase Date</option>
        </select>
        <select id="sortDir">
          <option value="asc">Asc</option>
          <option value="desc">Desc</option>
        </select>
      </div>
      <div class="filters">
        <select id="filterStatus">
          <option value="">All Status</option>
          <option value="in_stock">In Stock</option>
          <option value="sold">Sold</option>
          <option value="repair">In Repair</option>
        </select>
        <input id="filterProfitMin" type="number" placeholder="Min Profit" />
        <input id="filterProfitMax" type="number" placeholder="Max Profit" />
        <input id="filterDateFrom" type="date" placeholder="From Date" />
        <input id="filterDateTo" type="date" placeholder="To Date" />
      </div>
      <table id="table">
        <thead>
          <tr>
            <th data-field="no">No</th>
            <th data-field="owner">Owner</th>
            <th data-field="model">Model</th>
            <th data-field="status">Status</th>
            <th data-field="purchasePrice">Purchase</th>
            <th data-field="repairCost">Repair</th>
            <th data-field="sellingPrice">Selling</th>
            <th data-field="netProfit">Net</th>
            <th data-field="datePurchase">Purchased</th>
            <th data-field="dateSelling">Sold</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="pagination" id="pagination"></div>
      <div id="tableDesc" class="note">Tap row to edit/delete. Sort by clicking headers.</div>
    </section>

    <section class="card">
      <h2 style="font-size:1.2rem;margin-top:0;">Profit Trend Chart</h2>
      <canvas id="profitChart"></canvas>
    </section>

    <div class="note" style="margin-top:16px;">Tip: Add to home screen. For write access, enter GitHub token in backup modal.</div>
  </div>

  <div class="modal" id="backupModal">
    <div class="modal-content">
      <h2 style="margin-top:0;font-size:1.2rem;">Backup & Restore</h2>
      <label for="ghToken">GitHub Token (write access)</label>
      <input id="ghToken" type="password" placeholder="Optional for commits" />
      <label for="ghRepo">Repo (user/repo)</label>
      <input id="ghRepo" type="text" placeholder="yourusername/your-repo" value="" />
      <div style="margin-top:12px;display:flex;gap:8px;">
        <button id="btnDownloadBackup" class="ghost">Download JSON Backup</button>
        <label class="ghost" style="cursor:pointer;">
          <input type="file" id="restoreFile" accept=".json" class="import-input"> Restore JSON
        </label>
      </div>
      <button style="margin-top:12px;" class="danger" id="closeModal">Close</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script>
    const { DateTime } = luxon;
    const STORAGE_KEY = 'bikes_db_v2';
    const CSV_FILE = 'bikes.csv';
    let db = [];
    let selectedIndex = -1;
    let currentPage = 1;
    const pageSize = 10;
    let sortField = '';
    let sortDir = 'asc';
    let searchQuery = '';
    let filterStatus = '';
    let filterProfitMin = '';
    let filterProfitMax = '';
    let filterDateFrom = '';
    let filterDateTo = '';
    let chart = null;
    let ghToken = '';
    let ghRepo = '';
    let sha = null; // For CSV SHA

    const els = {
      colNo: document.getElementById('colNo'),
      owner: document.getElementById('owner'),
      model: document.getElementById('model'),
      status: document.getElementById('status'),
      purchasePrice: document.getElementById('purchasePrice'),
      repairCost: document.getElementById('repairCost'),
      sellingPrice: document.getElementById('sellingPrice'),
      netProfit: document.getElementById('netProfit'),
      datePurchase: document.getElementById('datePurchase'),
      dateSelling: document.getElementById('dateSelling'),
      notes: document.getElementById('notes'),
      btnAdd: document.getElementById('btnAdd'),
      btnUpdate: document.getElementById('btnUpdate'),
      btnDelete: document.getElementById('btnDelete'),
      btnDuplicate: document.getElementById('btnDuplicate'),
      importFile: document.getElementById('importFile'),
      tbody: document.querySelector('#table tbody'),
      search: document.getElementById('search'),
      sortField: document.getElementById('sortField'),
      sortDir: document.getElementById('sortDir'),
      filterStatus: document.getElementById('filterStatus'),
      filterProfitMin: document.getElementById('filterProfitMin'),
      filterProfitMax: document.getElementById('filterProfitMax'),
      filterDateFrom: document.getElementById('filterDateFrom'),
      filterDateTo: document.getElementById('filterDateTo'),
      pagination: document.getElementById('pagination'),
      statTotal: document.getElementById('statTotal'),
      statInStock: document.getElementById('statInStock'),
      statSold: document.getElementById('statSold'),
      statProfit: document.getElementById('statProfit'),
      btnLoad: document.getElementById('btnLoad'),
      btnCommit: document.getElementById('btnCommit'),
      btnTheme: document.getElementById('btnTheme'),
      btnBackup: document.getElementById('btnBackup'),
      btnClear: document.getElementById('btnClear'),
      profitChart: document.getElementById('profitChart'),
      backupModal: document.getElementById('backupModal'),
      ghToken: document.getElementById('ghToken'),
      ghRepo: document.getElementById('ghRepo'),
      btnDownloadBackup: document.getElementById('btnDownloadBackup'),
      restoreFile: document.getElementById('restoreFile'),
      closeModal: document.getElementById('closeModal')
    };

    // Theme
    function toggleTheme() {
      const isLight = document.body.getAttribute('data-theme') === 'light';
      document.body.setAttribute('data-theme', isLight ? 'dark' : 'light');
      els.btnTheme.textContent = isLight ? 'Light Mode' : 'Dark Mode';
      localStorage.setItem('theme', isLight ? 'dark' : 'light');
    }
    if (localStorage.getItem('theme') === 'light') toggleTheme();

    // GitHub API helpers
    async function getRepoPath() {
      const path = window.location.pathname;
      const repoMatch = path.match(/^\/([^\/]+)\/([^\/]+)/);
      if (repoMatch) {
        els.ghRepo.value = `${repoMatch[1]}/${repoMatch[2]}`;
        ghRepo = els.ghRepo.value;
      }
    }
    async function fetchCSV() {
      if (!ghRepo) return alert('Set repo in backup modal');
      try {
        const res = await fetch(`https://api.github.com/repos/${ghRepo}/contents/${CSV_FILE}?t=${Date.now()}`, {
          headers: { Authorization: ghToken ? `token ${ghToken}` : '', Accept: 'application/vnd.github.v3.raw' }
        });
        if (!res.ok) throw new Error('Not found or no access');
        const text = await res.text();
        sha = res.headers.get('etag') || (await res.json()).sha; // Fallback to json if no etag
        if (!sha) {
          const json = await res.json();
          sha = json.sha;
        }
        parseCSV(text);
        saveLocal();
        alert('Loaded from GitHub');
      } catch (e) {
        console.error(e);
        alert('Load failed: ' + e.message + '. Using local data.');
        loadLocal();
      }
    }
    async function commitCSV() {
      if (!ghRepo) return alert('Set repo');
      if (!ghToken) return alert('Enter GitHub token for write');
      const csv = generateCSV();
      const blob = btoa(csv); // Base64
      try {
        const res = await fetch(`https://api.github.com/repos/${ghRepo}/contents/${CSV_FILE}`, {
          method: 'PUT',
          headers: { Authorization: `token ${ghToken}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: `Update bikes.csv - ${new Date().toISOString()}`,
            content: blob,
            sha: sha,
            branch: 'main' // Assume main, change if gh-pages
          })
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        sha = data.content.sha;
        alert('Committed successfully!');
      } catch (e) {
        console.error(e);
        alert('Commit failed: ' + e.message);
      }
    }

    // CSV <-> DB
    function generateCSV() {
      if (db.length === 0) return '';
      const headers = Object.keys(db[0]).join(',') + '\n';
      const rows = db.map(r => Object.values(r).map(v => `"${(v+'').replace(/"/g, '""')}"`).join(',')).join('\n');
      return headers + rows;
    }
    function parseCSV(text) {
      if (!text.trim()) { db = []; return; }
      const lines = text.split(/\r?\n/);
      const headers = lines[0].split(',').map(h => h.replace(/^"|"$/g, '').trim());
      db = lines.slice(1).filter(l => l.trim()).map(l => {
        const vals = l.split(',').map(v => v.replace(/^"|"$/g, '').replace(/""/g, '"').trim());
        const rec = {};
        headers.forEach((h, i) => {
          let v = vals[i] || '';
          if (['purchasePrice', 'repairCost', 'sellingPrice', 'netProfit'].includes(h)) v = parseFloat(v) || 0;
          rec[h] = v;
        });
        return rec;
      });
    }

    // Local storage fallback
    function loadLocal() {
      try { db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { db = []; }
      renderAll();
    }
    function saveLocal() { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

    // Render
    function renderAll() {
      updateStats();
      renderTable();
      renderPagination();
      renderChart();
    }
    function updateStats() {
      const total = db.length;
      const inStock = db.filter(r => r.status !== 'sold').length;
      const sold = total - inStock;
      const profit = db.reduce((s, r) => s + (r.netProfit || 0), 0);
      els.statTotal.textContent = total;
      els.statInStock.textContent = inStock;
      els.statSold.textContent = sold;
      els.statProfit.textContent = formatNum(profit);
    }
    function getFilteredSorted() {
      let filtered = db.filter(r => {
        if (filterStatus && r.status !== filterStatus) return false;
        if (filterProfitMin !== '' && (r.netProfit || 0) < Number(filterProfitMin)) return false;
        if (filterProfitMax !== '' && (r.netProfit || 0) > Number(filterProfitMax)) return false;
        const dateP = r.datePurchase || '';
        if (filterDateFrom && dateP < filterDateFrom) return false;
        if (filterDateTo && dateP > filterDateTo) return false;
        if (searchQuery) {
          const q = searchQuery.toLowerCase();
          return Object.values(r).some(v => (v+'').toLowerCase().includes(q));
        }
        return true;
      });
      if (sortField) {
        filtered.sort((a, b) => {
          let va = a[sortField] || '', vb = b[sortField] || '';
          if (typeof va === 'number') return sortDir === 'asc' ? va - vb : vb - va;
          if (va instanceof Date || sortField.includes('date')) {
            va = va || ''; vb = vb || '';
            return sortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
          }
          return sortDir === 'asc' ? (va+'').localeCompare(vb+'') : (vb+'').localeCompare(va+'');
        });
      }
      return filtered;
    }
    function renderTable() {
      const filtered = getFilteredSorted();
      const start = (currentPage - 1) * pageSize;
      const pageData = filtered.slice(start, start + pageSize);
      els.tbody.innerHTML = '';
      pageData.forEach((r, i) => {
        const globalI = db.indexOf(r);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.no)}</td>
          <td>${escapeHtml(r.owner)}</td>
          <td>${escapeHtml(r.model || '')}</td>
          <td><span class="badge" style="background:${r.status === 'sold' ? 'var(--success)' : r.status === 'repair' ? 'var(--warning)' : 'var(--accent)'};padding:2px 6px;border-radius:4px;color:#fff;">${r.status.replace('_', ' ')}</span></td>
          <td>${formatNum(r.purchasePrice)}</td>
          <td>${formatNum(r.repairCost)}</td>
          <td>${formatNum(r.sellingPrice)}</td>
          <td>${formatNum(r.netProfit)}</td>
          <td>${r.datePurchase || ''}</td>
          <td>${r.dateSelling || ''}</td>`;
        tr.addEventListener('click', () => selectRow(globalI, tr));
        if (globalI === selectedIndex) tr.classList.add('selected');
        els.tbody.appendChild(tr);
      });
      // Update sort indicators
      document.querySelectorAll('th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.field === sortField) th.classList.add(sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
      });
    }
    function renderPagination() {
      const filtered = getFilteredSorted();
      const pages = Math.ceil(filtered.length / pageSize);
      els.pagination.innerHTML = '';
      for (let p = 1; p <= pages; p++) {
        const btn = document.createElement('button');
        btn.textContent = p;
        btn.disabled = p === currentPage;
        btn.addEventListener('click', () => { currentPage = p; renderTable(); });
        els.pagination.appendChild(btn);
      }
    }
    function renderChart() {
      const sold = db.filter(r => r.status === 'sold' && r.dateSelling).sort((a,b) => a.dateSelling.localeCompare(b.dateSelling));
      const labels = sold.map(r => r.dateSelling);
      const data = sold.map(r => r.netProfit);
      if (chart) chart.destroy();
      chart = new Chart(els.profitChart, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Net Profit', data, borderColor: 'var(--accent)', fill: false }] },
        options: { responsive: true, scales: { x: { type: 'time', time: { unit: 'month' } } } }
      });
    }

    // Row selection
    function selectRow(i, tr) {
      selectedIndex = i;
      const r = db[i];
      els.colNo.value = r.no;
      els.owner.value = r.owner;
      els.model.value = r.model || '';
      els.status.value = r.status || 'in_stock';
      els.purchasePrice.value = r.purchasePrice;
      els.repairCost.value = r.repairCost;
      els.sellingPrice.value = r.sellingPrice;
      els.netProfit.value = r.netProfit;
      els.datePurchase.value = r.datePurchase || '';
      els.dateSelling.value = r.dateSelling || '';
      els.notes.value = r.notes || '';
      Array.from(els.tbody.children).forEach((row, idx) => row.classList.toggle('selected', db.indexOf(row) === -1 ? false : db.indexOf(row) === i));
    }

    // Form
    function readForm() {
      const no = els.colNo.value.trim().toUpperCase();
      if (!no.match(/^[A-Z]{2}[0-9]{1,2}[A-Z]{1,3}[0-9]{1,4}$/)) { alert('Invalid Indian plate (e.g. GJ05AB1234)'); return null; }
      if (db.some((r, i) => r.no === no && i !== selectedIndex)) { alert('Duplicate bike number'); return null; }
      const owner = els.owner.value.trim();
      if (!owner) { alert('Owner required'); return null; }
      const model = els.model.value.trim();
      const status = els.status.value;
      const purchasePrice = Number(els.purchasePrice.value) || 0;
      const repairCost = Number(els.repairCost.value) || 0;
      let sellingPrice = Number(els.sellingPrice.value) || 0;
      if (status === 'sold' && sellingPrice <= 0) { alert('Selling price required for sold'); return null; }
      if (status !== 'sold') sellingPrice = 0;
      const netProfit = round2((status === 'sold' ? sellingPrice : 0) - (purchasePrice + repairCost));
      const datePurchase = els.datePurchase.value;
      const dateSelling = status === 'sold' ? els.dateSelling.value : '';
      const notes = els.notes.value.trim();
      return { no, owner, model, status, purchasePrice, repairCost, sellingPrice, netProfit, datePurchase, dateSelling, notes };
    }
    function addRecord() {
      const rec = readForm();
      if (!rec) return;
      db.push(rec);
      saveLocal();
      renderAll();
      clearForm();
    }
    function updateRecord() {
      if (selectedIndex < 0) return alert('Select a record');
      const rec = readForm();
      if (!rec) return;
      db[selectedIndex] = rec;
      saveLocal();
      renderAll();
    }
    function deleteRecord() {
      if (selectedIndex < 0) return alert('Select a record');
      if (!confirm('Delete?')) return;
      db.splice(selectedIndex, 1);
      selectedIndex = -1;
      saveLocal();
      renderAll();
      clearForm();
    }
    function duplicateRecord() {
      if (selectedIndex < 0) return alert('Select a record');
      const rec = { ...db[selectedIndex], no: '', datePurchase: '', dateSelling: '' };
      els.colNo.value = rec.no;
      els.owner.value = rec.owner;
      els.model.value = rec.model || '';
      els.status.value = rec.status;
      els.purchasePrice.value = rec.purchasePrice;
      els.repairCost.value = rec.repairCost;
      els.sellingPrice.value = rec.sellingPrice;
      els.netProfit.value = rec.netProfit;
      els.datePurchase.value = rec.datePurchase;
      els.dateSelling.value = rec.dateSelling;
      els.notes.value = rec.notes || '';
      selectedIndex = -1;
    }
    function clearForm() {
      els.colNo.value = ''; els.owner.value = ''; els.model.value = ''; els.status.value = 'in_stock';
      els.purchasePrice.value = ''; els.repairCost.value = '0'; els.sellingPrice.value = ''; els.netProfit.value = '';
      els.datePurchase.value = ''; els.dateSelling.value = ''; els.notes.value = '';
      selectedIndex = -1;
      Array.from(els.tbody.children).forEach(row => row.classList.remove('selected'));
    }
    function computeNet() {
      const p = Number(els.purchasePrice.value) || 0;
      const r = Number(els.repairCost.value) || 0;
      const s = Number(els.sellingPrice.value) || 0;
      els.netProfit.value = round2(s - (p + r));
    }

    // Import
    function handleImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        if (file.name.endsWith('.csv')) {
          parseCSV(ev.target.result);
        } else {
          const wb = XLSX.read(ev.target.result, { type: 'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          db = XLSX.utils.sheet_to_json(ws);
        }
        saveLocal();
        renderAll();
        alert('Imported successfully');
      };
      if (file.name.endsWith('.csv')) reader.readAsText(file);
      else reader.readAsArrayBuffer(file);
    }

    // Backup
    function downloadBackup() {
      const data = JSON.stringify(db);
      const blob = new Blob([data], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'bikes_backup.json';
      a.click();
    }
    function handleRestore(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          db = JSON.parse(ev.target.result);
          saveLocal();
          renderAll();
          alert('Restored');
        } catch { alert('Invalid JSON'); }
      };
      reader.readAsText(file);
    }

    // Events
    els.purchasePrice.addEventListener('input', computeNet);
    els.repairCost.addEventListener('input', computeNet);
    els.sellingPrice.addEventListener('input', computeNet);
    els.status.addEventListener('change', () => {
      const isSold = els.status.value === 'sold';
      els.sellingPrice.required = isSold;
      els.dateSelling.required = isSold;
      if (!isSold) { els.sellingPrice.value = ''; els.dateSelling.value = ''; }
      computeNet();
    });
    els.btnAdd.addEventListener('click', addRecord);
    els.btnUpdate.addEventListener('click', updateRecord);
    els.btnDelete.addEventListener('click', deleteRecord);
    els.btnDuplicate.addEventListener('click', duplicateRecord);
    els.importFile.addEventListener('change', handleImport);
    els.search.addEventListener('input', () => { searchQuery = els.search.value.toLowerCase(); currentPage = 1; renderTable(); renderPagination(); });
    els.sortField.addEventListener('change', () => { sortField = els.sortField.value; renderTable(); });
    els.sortDir.addEventListener('change', () => { sortDir = els.sortDir.value; renderTable(); });
    els.filterStatus.addEventListener('change', () => { filterStatus = els.filterStatus.value; currentPage = 1; renderTable(); renderPagination(); });
    els.filterProfitMin.addEventListener('input', () => { filterProfitMin = els.filterProfitMin.value; currentPage = 1; renderTable(); renderPagination(); });
    els.filterProfitMax.addEventListener('input', () => { filterProfitMax = els.filterProfitMax.value; currentPage = 1; renderTable(); renderPagination(); });
    els.filterDateFrom.addEventListener('change', () => { filterDateFrom = els.filterDateFrom.value; currentPage = 1; renderTable(); renderPagination(); });
    els.filterDateTo.addEventListener('change', () => { filterDateTo = els.filterDateTo.value; currentPage = 1; renderTable(); renderPagination(); });
    document.querySelectorAll('th[data-field]').forEach(th => {
      th.addEventListener('click', () => {
        const field = th.dataset.field;
        if (sortField === field) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        else { sortField = field; sortDir = 'asc'; }
        renderTable();
      });
    });
    els.btnLoad.addEventListener('click', fetchCSV);
    els.btnCommit.addEventListener('click', commitCSV);
    els.btnTheme.addEventListener('click', toggleTheme);
    els.btnBackup.addEventListener('click', () => { els.backupModal.classList.add('open'); getRepoPath(); });
    els.closeModal.addEventListener('click', () => els.backupModal.classList.remove('open'));
    els.ghToken.addEventListener('input', () => ghToken = els.ghToken.value.trim());
    els.ghRepo.addEventListener('input', () => ghRepo = els.ghRepo.value.trim());
    els.btnDownloadBackup.addEventListener('click', downloadBackup);
    els.restoreFile.addEventListener('change', handleRestore);
    els.btnClear.addEventListener('click', () => { if (confirm('Clear local data?')) { db = []; saveLocal(); renderAll(); } });

    // Utils
    function round2(v) { return Math.round((v + Number.EPSILON) * 100) / 100; }
    function formatNum(n) { return Number(n).toLocaleString(undefined, { maximumFractionDigits: 2 }); }
    function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;'})[c]); }

    // Init
    getRepoPath();
    loadLocal();
    if (db.length === 0) fetchCSV(); // Auto load if empty
  </script>
</body>
</html>