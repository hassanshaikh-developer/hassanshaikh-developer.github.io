<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bike Manager v3</title>
  <meta name="description" content="Offline-first bike inventory manager with GitHub sync and analytics." />
  
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Bike Manager" />
  <meta name="theme-color" content="#071b2b" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="httpsimg-apple.png" /> <style>
    /* --- 1. Fonts & Root Variables --- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    :root {
      /* Base Dark Theme (Default) */
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --bg-gradient-start: #071026;
      --bg-gradient-end: #020511;
      --bg-page: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      --bg-card: #071b2b;
      --bg-card-subtle: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --bg-header: rgba(7, 27, 43, 0.85);
      --bg-modal: rgba(7, 16, 38, 0.9);
      --bg-input: rgba(0, 0, 0, 0.2);
      --bg-input-focus: rgba(0, 0, 0, 0.1);
      --bg-hover: rgba(255, 255, 255, 0.05);
      --bg-active: rgba(255, 255, 255, 0.08);
      --bg-nav: var(--bg-header);

      --accent-gradient: linear-gradient(90deg, #00D0FF, #6EE7B7);
      --accent-1: #00D0FF;
      --accent-2: #6EE7B7;
      --accent-text: #00242f;

      --text-primary: #e6f6ff;
      --text-secondary: #9fb0c2;
      --text-disabled: #6a7f96;
      --text-placeholder: #6a7f96;

      --border-color: rgba(255, 255, 255, 0.1);
      --border-color-subtle: rgba(255, 255, 255, 0.04);
      --border-focus: var(--accent-1);
      
      --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.6);
      --shadow-nav: 0 -4px 12px rgba(0, 0, 0, 0.3);
      --shadow-fab: 0 6px 16px rgba(0, 208, 255, 0.3);
      --shadow-btn: 0 2px 8px rgba(0, 0, 0, 0.3);

      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;

      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-xl: 20px;
      --radius-full: 9999px;
      
      --nav-height-mobile: 60px;
      --header-height: 60px;
      --tap-target: 44px;
      --transition-speed: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* --- 2. Light Mode (via System Preference) --- */
    @media (prefers-color-scheme: light) {
      :root {
        --bg-gradient-start: #f4f7fa;
        --bg-gradient-end: #e8eef3;
        --bg-card: #ffffff;
        --bg-card-subtle: linear-gradient(180deg, #ffffff, #fdfdfd);
        --bg-header: rgba(255, 255, 255, 0.85);
        --bg-modal: rgba(244, 247, 250, 0.9);
        --bg-input: rgba(0, 0, 0, 0.04);
        --bg-input-focus: rgba(0, 0, 0, 0.02);
        --bg-hover: rgba(0, 0, 0, 0.05);
        --bg-active: rgba(0, 0, 0, 0.08);
        --bg-nav: var(--bg-header);

        --text-primary: #071026;
        --text-secondary: #4a5a70;
        --text-disabled: #9fb0c2;
        --text-placeholder: #9fb0c2;

        --border-color: rgba(0, 0, 0, 0.1);
        --border-color-subtle: rgba(0, 0, 0, 0.04);

        --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.08);
        --shadow-nav: 0 -4px 12px rgba(0, 0, 0, 0.05);
      }
    }

    /* --- 3. Base & Reset --- */
    *, *::before, *::after { box-sizing: border-box; }
    html { -webkit-text-size-adjust: 100%; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      font-family: var(--font-family);
      background: var(--bg-page);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-size: 16px;
      line-height: 1.5;
    }
    input, button, select, textarea {
      font-family: inherit;
      color: inherit;
      font-size: 1rem;
    }
    button { cursor: pointer; border: none; background: none; padding: 0; }
    h1, h2, h3, h4, h5, h6 { margin: 0; font-weight: 700; }
    a { color: var(--accent-1); text-decoration: none; }
    svg { display: block; }
    ::placeholder { color: var(--text-placeholder); }

    /* --- 4. Main App Layout --- */
    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .app-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 16px;
      height: var(--header-height);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      background: var(--bg-header);
      border-bottom: 1px solid var(--border-color-subtle);
    }
    .app-header h1 {
      font-size: 1.25rem;
      margin-right: auto;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      color: transparent;
    }

    .app-main {
      flex-grow: 1;
      padding: 16px;
      padding-bottom: calc(var(--nav-height-mobile) + 32px); /* Space for bottom nav + FAB */
    }

    .app-bottom-nav {
      display: flex;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--nav-height-mobile);
      background: var(--bg-nav);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow-nav);
      z-index: 100;
      border-top: 1px solid var(--border-color-subtle);
    }
    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-secondary);
      transition: var(--transition-speed);
    }
    .nav-btn svg { width: 22px; height: 22px; }
    .nav-btn.active {
      color: var(--accent-1);
    }

    /* Desktop layout */
    @media (min-width: 768px) {
      .app-container {
        flex-direction: row;
      }
      .app-bottom-nav {
        /* Becomes a side nav */
        position: sticky;
        top: 0;
        left: 0;
        flex-direction: column;
        width: 80px;
        height: 100vh;
        border-top: none;
        border-right: 1px solid var(--border-color-subtle);
        box-shadow: none;
        justify-content: flex-start;
        padding-top: var(--header-height);
      }
      .nav-btn {
        width: 100%;
        height: 70px;
        font-size: 0.75rem;
      }
      .app-header {
        /* Header becomes part of the main content area */
        width: calc(100% - 80px);
        position: sticky;
        left: 80px;
        border-bottom: 1px solid var(--border-color-subtle);
      }
      .app-main {
        width: calc(100% - 80px);
        padding-bottom: 32px; /* Reset mobile padding */
      }
    }

    /* --- 5. Core Components --- */
    .view {
      display: none; /* Hidden by default, JS toggles */
    }
    .view.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
      min-height: var(--tap-target);
      transition: var(--transition-speed);
      box-shadow: var(--shadow-btn);
    }
    .btn-primary {
      background: var(--accent-gradient);
      color: var(--accent-text);
    }
    .btn-primary:hover {
      opacity: 0.9;
    }
    .btn-secondary {
      background: var(--bg-card-subtle);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    .btn-secondary:hover { background: var(--bg-hover); }
    
    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      box-shadow: none;
    }
    .btn-ghost:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    .btn-danger {
      background: var(--error);
      color: #fff;
    }
    .btn-icon {
      padding: 10px;
      min-height: var(--tap-target);
      min-width: var(--tap-target);
      border-radius: var(--radius-full);
      box-shadow: none;
    }
    .btn-icon svg { width: 24px; height: 24px; }
    
    .fab {
      position: fixed;
      bottom: calc(var(--nav-height-mobile) + 16px);
      right: 16px;
      width: 56px;
      height: 56px;
      border-radius: var(--radius-xl);
      background: var(--accent-gradient);
      color: var(--accent-text);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-fab);
      z-index: 200;
      transition: transform 0.3s ease;
    }
    .fab:active {
      transform: scale(0.95);
    }
    .fab svg { width: 28px; height: 28px; }
    @media (min-width: 768px) {
      .fab { display: none; } /* Hide FAB on desktop, use header button */
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-card);
      border: 1px solid var(--border-color-subtle);
    }

    /* --- 6. Form & Input Elements --- */
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .form-input,
    .form-select {
      width: 100%;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-input);
      color: var(--text-primary);
      transition: var(--transition-speed);
      appearance: none;
    }
    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--border-focus);
      background: var(--bg-input-focus);
      box-shadow: 0 0 0 2px rgba(0, 208, 255, 0.3);
    }
    .form-input[readonly] {
      background: rgba(0,0,0,0.1);
      color: var(--text-secondary);
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    /* --- 7. Modals & Panels --- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg-modal);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 24px;
      width: 100%;
      max-width: 500px;
      box-shadow: var(--shadow-card);
      transform: scale(0.95);
      transition: transform 0.3s;
    }
    .modal-overlay.active .modal-content {
      transform: scale(1);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .modal-header h2 { font-size: 1.25rem; }
    .modal-body {
      max-height: 70vh;
      overflow-y: auto;
    }
    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    /* --- 8. Specific UI Elements --- */
    /* App Loader (Splash Screen) */
    .app-loader {
      position: fixed;
      inset: 0;
      background: var(--bg-page);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      transition: opacity 0.5s ease;
    }
    .app-loader.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .app-loader .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border-color);
      border-top-color: var(--accent-1);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .app-loader h2 {
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 1.5rem;
    }

    /* Sync Status */
    .sync-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 6px 10px;
      border-radius: var(--radius-full);
      background: var(--bg-card-subtle);
      border: 1px solid var(--border-color-subtle);
      color: var(--text-secondary);
      transition: var(--transition-speed);
    }
    .sync-status.syncing .status-dot {
      background: var(--warning);
      animation: pulse 1.5s infinite;
    }
    .sync-status.success .status-dot { background: var(--success); }
    .sync-status.error .status-dot { background: var(--error); }
    .sync-status.offline .status-dot { background: var(--text-disabled); }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: calc(var(--nav-height-mobile) + 20px);
      left: 16px;
      right: 16px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    .toast {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #2a3b4d;
      color: var(--text-primary);
      padding: 12px 16px;
      border-radius: var(--radius-md);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: toast-in 0.3s ease;
    }
    .toast.success { background: var(--success); color: #fff; }
    .toast.error { background: var(--error); color: #fff; }
    @media (min-width: 768px) {
      .toast-container {
        bottom: 20px;
        left: auto;
        right: 20px;
        align-items: flex-end;
      }
    }

    /* Bike List */
    .bike-list {
      display: grid;
      gap: 12px;
    }
    .bike-card {
      display: grid;
      grid-template-columns: 1fr auto;
      background: var(--bg-card-subtle);
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color-subtle);
      transition: var(--transition-speed);
    }
    .bike-card:hover {
      background: var(--bg-hover);
      border-color: var(--border-color);
    }
    .bike-card-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .bike-card-plate {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--text-primary);
    }
    .bike-card-owner {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    .bike-card-profit {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
    }
    .profit-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--success);
    }
    .profit-value.unrealized {
      color: var(--text-secondary);
      font-style: italic;
    }
    .profit-value.loss {
      color: var(--error);
    }

    /* Search/Filter Bar */
    .filter-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      align-items: center;
    }
    #search-input {
      flex-grow: 1;
      border-radius: var(--radius-full);
      padding-left: 16px;
      padding-right: 16px;
    }
    .filter-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .chip {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--bg-input);
      color: var(--text-secondary);
      padding: 6px 12px;
      border-radius: var(--radius-full);
      font-size: 0.85rem;
      border: 1px solid var(--border-color-subtle);
    }
    .chip.active {
      background: var(--accent-1);
      color: var(--accent-text);
      font-weight: 600;
      border-color: var(--accent-1);
    }
    .chip.clearable .chip-close {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(0,0,0,0.2);
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      line-height: 1;
      font-weight: bold;
    }

    /* Stats Dashboard */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (min-width: 1024px) {
      .stats-grid { grid-template-columns: 1fr 1fr 1fr 1fr; }
    }
    .stat-card {
      background: var(--bg-card-subtle);
      padding: 16px;
      border-radius: var(--radius-md);
    }
    .stat-card-title {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .stat-card-value {
      font-size: 1.75rem;
      font-weight: 700;
    }
    .stat-card-value .currency {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .chart-container {
      margin-top: 24px;
    }
    .chart-container h3 {
      font-size: 1.1rem;
      margin-bottom: 12px;
    }

    /* Settings Page */
    .settings-section {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 24px;
      margin-bottom: 24px;
    }
    .settings-section h2 {
      font-size: 1.25rem;
      margin-bottom: 16px;
    }
    .settings-section p {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: -12px;
      margin-bottom: 16px;
    }
    
    /* --- 9. Utility & Animations --- */
    .hidden { display: none !important; }
    .text-success { color: var(--success); }
    .text-error { color: var(--error); }
    .text-warning { color: var(--warning); }
    .text-secondary { color: var(--text-secondary); }
    .text-center { text-align: center; }
    .mt-1 { margin-top: 8px; }
    .mt-2 { margin-top: 16px; }
    .mb-2 { margin-bottom: 16px; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    @keyframes toast-in {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

  </style>
</head>
<body>

  <svg width="0" height="0" style="position:absolute">
    <symbol id="icon-list" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></symbol>
    <symbol id="icon-chart" viewBox="0 0 24 24"><path fill="currentColor" d="M3 22v-9h4v9H3zm0-11V3h4v8H3zm6 11v-5h4v5H9zm0-7V3h4v12H9zm6 7v-9h4v9h-4zm0-11V3h4v8h-4z"/></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24"><path fill="currentColor" d="M19.4 12c0-.2.1-.4.1-.6c0-.2-.1-.4-.1-.6l1.7-1.3c.2-.1.2-.4 0-.6l-1.6-2.8c-.1-.2-.4-.3-.6-.2l-2 .8c-.4-.3-.8-.5-1.3-.7l-.3-2.1c0-.3-.2-.4-.5-.4h-3.2c-.3 0-.5.1-.5.4l-.3 2.1c-.5.2-.9.4-1.3.7l-2-.8c-.2-.1-.5 0-.6.2l-1.6 2.8c-.1.2-.1.5 0 .6l1.7 1.3c-.1.2-.1.4-.1.6c0 .2.1.4.1.6l-1.7 1.3c-.2.1-.2.4 0 .6l1.6 2.8c.1.2.4.3.6.2l2-.8c.4.3.8.5 1.3.7l.3 2.1c0 .3.2.4.5.4h3.2c.3 0 .5-.1.5.4l.3-2.1c.5-.2.9-.4 1.3-.7l2-.8c.2-.1.5 0 .6-.2l1.6-2.8c.1-.2.1-.5 0-.6l-1.7-1.3zm-7.4 2.5c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5s2.5 1.1 2.5 2.5s-1.1 2.5-2.5 2.5z"/></symbol>
    <symbol id="icon-add" viewBox="0 0 24 24"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></symbol>
    <symbol id="icon-close" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41z"/></symbol>
    <symbol id="icon-search" viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5S14 7.01 14 9.5S11.99 14 9.5 14z"/></symbol>
    <symbol id="icon-filter" viewBox="0 0 24 24"><path fill="currentColor" d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/></symbol>
    <symbol id="icon-more" viewBox="0 0 24 24"><path fill="currentColor" d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2s-2 .9-2 2s.9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2s2-.9 2-2s-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2s2-.9 2-2s-.9-2-2-2z"/></symbol>
    <symbol id="icon-save" viewBox="0 0 24 24"><path fill="currentColor" d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3s3 1.34 3 3s-1.34 3-3 3zm3-10H5V5h10v4z"/></symbol>
    <symbol id="icon-delete" viewBox="0 0 24 24"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></symbol>
    <symbol id="icon-edit" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83l3.75 3.75l1.83-1.83z"/></symbol>
    <symbol id="icon-sync" viewBox="0 0 24 24"><path fill="currentColor" d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6s-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8s-3.58-8-8-8z"/></symbol>
    <symbol id="icon-check" viewBox="0 0 24 24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19L21 7l-1.41-1.41L9 16.17z"/></symbol>
  </svg>

  <div class="app-loader" id="app-loader">
    <div class="spinner"></div>
    <h2 id="app-loader-title">Bike Manager</h2>
    <p class="text-secondary" id="app-loader-status">Loading application...</p>
  </div>

  <div class="app-container">
    
    <nav class="app-bottom-nav" id="app-nav">
      <button class="nav-btn active" data-view="view-list">
        <svg><use href="#icon-list"></use></svg>
        <span>Bikes</span>
      </button>
      <button class="nav-btn" data-view="view-stats">
        <svg><use href="#icon-chart"></use></svg>
        <span>Stats</span>
      </button>
      <button class="nav-btn" data-view="view-settings">
        <svg><use href="#icon-settings"></use></svg>
        <span>Settings</span>
      </button>
    </nav>
    
    <div style="flex-grow: 1; display: flex; flex-direction: column;">
      
      <header class="app-header">
        <h1 id="header-title">Bike Manager</h1>
        <div id="sync-status" class="sync-status">
          <div class="status-dot"></div>
          <span id="sync-status-text">Offline</span>
        </div>
        <button class="btn-icon btn-ghost" id="sync-now-btn" title="Sync Now">
          <svg><use href="#icon-sync"></use></svg>
        </button>
      </header>
      
      <main class="app-main">
        
        <section id="view-list" class="view active">
          
          <div class="stats-grid mb-2">
            <div class="stat-card">
              <div class="stat-card-title">Total Profit</div>
              <div class="stat-card-value"><span class="currency" id="currency-symbol-1">₹</span> <span id="stat-total-profit">0</span></div>
            </div>
            <div class="stat-card">
              <div class="stat-card-title">Unsold Stock</div>
              <div class="stat-card-value"><span class="currency" id="currency-symbol-2">₹</span> <span id="stat-unsold-value">0</span></div>
            </div>
            <div class="stat-card">
              <div class="stat-card-title">Sold</div>
              <div class="stat-card-value" id="stat-sold-count">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-title">Unsold</div>
              <div class="stat-card-value" id="stat-unsold-count">0</div>
            </div>
          </div>
          
          <div class="filter-bar">
            <input type="text" class="form-input" id="search-input" placeholder="Search plate or owner..." />
            <button class="btn btn-primary" id="add-bike-desktop" style="display: none;">
              <svg width="20" height="20"><use href="#icon-add"></use></svg>
              <span>Add Bike</span>
            </button>
          </div>
          
          <div class="filter-chips">
            <button class="chip" id="filter-all" data-filter="all">All</button>
            <button class="chip" id="filter-sold" data-filter="sold">Sold</button>
            <button class="chip" id="filter-unsold" data-filter="unsold">Unsold</button>
            </div>

          <div class="bike-list" id="bike-list">
            <p id="bike-list-empty" class="text-secondary text-center mt-2">No bikes found. Try adding one!</p>
          </div>
          
        </section>
        
        <section id="view-stats" class="view">
          <h2>Analytics Dashboard</h2>
          <p class="text-secondary mb-2">Live insights from your local data.</p>
          
          <div class="card">
            <h3>Quick Insights</h3>
            <p id="auto-insight-text" class="text-secondary">Calculating insights...</p>
          </div>
          
          <div class="chart-container card">
            <h3>Monthly Profit</h3>
            <canvas id="chart-profit-trend"></canvas>
          </div>
          
          <div class="chart-container card">
            <h3>Profit Distribution</h3>
            <canvas id="chart-profit-pie"></canvas>
          </div>
          
          <div class="chart-container card">
            <h3>Top 5 Profitable Bikes</h3>
            <canvas id="chart-top-bikes"></canvas>
          </div>

        </section>
        
        <section id="view-settings" class="view">
          <h2>Settings</h2>
          
          <div class="settings-section">
            <h3>GitHub Gist Sync</h3>
            <p>Syncs your data to a private GitHub Gist as a CSV backup.</p>
            
            <div class="form-group">
              <label for="setting-gist-id">Gist ID</label>
              <input type="text" class="form-input" id="setting-gist-id" placeholder="e.g., a1b2c3d4e5f6a7b8c9d0" />
            </div>
            <div class="form-group">
              <label for="setting-gist-filename">Gist Filename</label>
              <input type="text" class="form-input" id="setting-gist-filename" value="bikes_inventory.csv" />
            </div>
            <div class="form-group">
              <label for="setting-github-pat">GitHub Personal Access Token (PAT)</label>
              <input type="password" class="form-input" id="setting-github-pat" placeholder="ghp_... (stored locally)" />
              <p class="text-secondary" style="font-size: 0.8rem; margin-top: 6px;">
                Requires `gist` scope. This token is stored **only** in your browser.
              </p>
            </div>
            <button class="btn btn-secondary" id="save-sync-settings">
              <svg width="20" height="20"><use href="#icon-save"></use></svg>
              <span>Save Sync Settings</span>
            </button>
          </div>
          
          <div class="settings-section">
            <h3>Personalization</h3>
            <div class="form-group">
              <label for="setting-business-name">Business Name</label>
              <input type="text" class="form-input" id="setting-business-name" placeholder="My Bike Shop" />
            </div>
            <div class="form-group">
              <label for="setting-currency">Currency Symbol</label>
              <input type="text" class="form-input" id="setting-currency" placeholder="₹" style="width: 100px;" />
            </div>
            <button class="btn btn-secondary" id="save-display-settings">Save Display Settings</button>
          </div>
          
          <div class="settings-section">
            <h3>Data Management</h3>
            <p>Manage your local and remote data.</p>
            <div class="form-grid" style="gap: 12px;">
              <button class="btn btn-secondary" id="export-csv">Export as CSV</button>
              <button class="btn btn-secondary" id="export-json">Export as JSON</button>
              <button class="btn btn-secondary" id="export-xlsx">Export as XLSX</button>
              <button class="btn btn-secondary" id="import-csv">Import CSV/JSON</button>
            </div>
            <input type="file" id="import-file-input" class="hidden" accept=".csv,.json" />
            
            <h4 class="mt-2">Danger Zone</h4>
            <button class="btn btn-danger" id="wipe-data-btn">
              <svg width="20" height="20"><use href="#icon-delete"></use></svg>
              <span>Wipe All Local Data</span>
            </button>
          </div>

        </section>
        
      </main>
    </div>
  </div>

  <button class="fab" id="fab-add" title="Add New Bike">
    <svg><use href="#icon-add"></use></svg>
  </button>
  
  <div class="modal-overlay" id="form-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="form-title">Add New Bike</h2>
        <button class="btn-icon btn-ghost" id="close-form-modal">
          <svg><use href="#icon-close"></use></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="bike-form">
          <input type="hidden" id="form-bike-id" />
          <div class="form-group">
            <label for="form-no">Bike Number (Plate)</label>
            <input type="text" class="form-input" id="form-no" placeholder="GJ05AB1234" required />
          </div>
          <div class="form-group">
            <label for="form-owner">Owner Name</label>
            <input type="text" class="form-input" id="form-owner" required />
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="form-datePurchase">Purchase Date</label>
              <input type="date" class="form-input" id="form-datePurchase" />
            </div>
            <div class="form-group">
              <label for="form-dateSelling">Selling Date</label>
              <input type="date" class="form-input" id="form-dateSelling" />
            </div>
            <div class="form-group">
              <label for="form-purchasePrice">Purchase Price</label>
              <input type="number" class="form-input" id="form-purchasePrice" placeholder="0" />
            </div>
            <div class="form-group">
              <label for="form-repairCost">Repair Cost</label>
              <input type="number" class="form-input" id="form-repairCost" placeholder="0" />
            </div>
            <div class="form-group">
              <label for="form-sellingPrice">Selling Price</label>
              <input type="number" class="form-input" id="form-sellingPrice" placeholder="0" />
            </div>
            <div class="form-group">
              <label for="form-netProfit">Net Profit (Auto)</label>
              <input type="number" class="form-input" id="form-netProfit" readonly />
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="delete-bike-btn" style="margin-right: auto;">
          <svg width="20" height="20"><use href="#icon-delete"></use></svg>
          <span>Delete</span>
        </button>
        <button class="btn btn-secondary" id="cancel-form-btn">Cancel</button>
        <button class="btn btn-primary" id="save-form-btn">
          <svg width="20" height="20"><use href="#icon-save"></use></svg>
          <span>Save</span>
        </button>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="update-modal">
    <div class="modal-content text-center">
      <h2>Update Available</h2>
      <p class="text-secondary mb-2">A new version of Bike Manager is ready. Refresh to get the latest features.</p>
      <button class="btn btn-primary" id="update-refresh-btn">Refresh Now</button>
    </div>
  </div>

  <div class="toast-container" id="toast-container"></div>
  
  <canvas id="confetti-canvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9998;"></canvas>


  <script src="https://cdn.jsdelivr.net/npm/dexie@4.0.1/dist/dexie.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  
  <script>
    // --- APP CONSTANTS ---
    const OLD_STORAGE_KEY = 'bikes_db_v2';
    const SETTINGS_KEY = 'bike_manager_settings_v3';
    
    /**
     * @class BikeManagerApp
     * Main application class. Manages all components,
     * views, database, and sync logic.
     */
    class BikeManagerApp {
      
      constructor() {
        this.db = null;
        this.charts = {};
        this.currentFilters = {
          search: '',
          status: 'all', // 'all', 'sold', 'unsold'
        };
        this.settings = {
          businessName: 'Bike Manager',
          currency: '₹',
          gistId: '',
          gistFilename: 'bikes_inventory.csv',
          githubPat: '',
          lastSync: null,
        };
        this.currentView = 'view-list';
        this.isMobile = window.innerWidth < 768;
        this.isOnline = navigator.onLine;

        // Debounce search input to avoid constant re-renders
        this.debouncedRenderList = this.debounce(this.renderBikeList, 250);
        
        // DOM element cache
        this.dom = {
          loader: document.getElementById('app-loader'),
          loaderStatus: document.getElementById('app-loader-status'),
          headerTitle: document.getElementById('header-title'),
          views: document.querySelectorAll('.view'),
          navButtons: document.querySelectorAll('.nav-btn'),
          syncStatus: document.getElementById('sync-status'),
          syncStatusText: document.getElementById('sync-status-text'),
          syncNowBtn: document.getElementById('sync-now-btn'),
          // ... (add more as needed)
        };
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', () => {
          this.init();
        });
      }
      
      /**
       * Primary initialization function.
       * Runs in order: Service Worker, DB, Settings, UI, Listeners.
       */
      async init() {
        try {
          this.vibrate(10);
          this.initServiceWorker();
          
          this.updateLoaderStatus('Initializing database...');
          await this.initDatabase();
          
          this.updateLoaderStatus('Loading settings...');
          await this.loadSettings();
          
          this.updateLoaderStatus('Migrating old data (if any)...');
          await this.migrateFromLocalStorage();
          
          this.updateLoaderStatus('Preparing UI...');
          this.initUI();
          this.initEventListeners();
          
          this.updateLoaderStatus('Rendering data...');
          await this.renderAll();
          
          // App is ready, hide loader
          this.dom.loader.classList.add('hidden');
          
        } catch (error) {
          console.error("Critical initialization failed:", error);
          this.dom.loaderStatus.textContent = "Error loading app. Please refresh.";
          this.dom.loaderStatus.classList.add('text-error');
        }
      }
      
      updateLoaderStatus(text) {
        this.dom.loaderStatus.textContent = text;
      }

      // --- 1. PWA & SERVICE WORKER ---
      
      initServiceWorker() {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('sw.js')
            .then(registration => {
              console.log('Service Worker registered with scope:', registration.scope);
              
              // Handle updates: Show "Update Available" modal
              registration.onupdatefound = () => {
                const installingWorker = registration.installing;
                if (installingWorker) {
                  installingWorker.onstatechange = () => {
                    if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                      this.showUpdateModal();
                    }
                  };
                }
              };
            })
            .catch(error => {
              console.error('Service Worker registration failed:', error);
            });
          
          // Handle controller change (app updated)
          navigator.serviceWorker.oncontrollerchange = () => {
            window.location.reload();
          };
        }
      }
      
      showUpdateModal() {
        const modal = document.getElementById('update-modal');
        modal.classList.add('active');
        document.getElementById('update-refresh-btn').onclick = () => {
          // Send message to SW to skip waiting
          navigator.serviceWorker.getRegistration().then(reg => {
            reg.waiting.postMessage({ type: 'SKIP_WAITING' });
          });
        };
      }
      
      // --- 2. DATABASE & DATA MIGRATION ---

      async initDatabase() {
        // Dexie.js makes IndexedDB simple
        this.db = new Dexie('BikeDB_v3');
        
        // Schema definition
        this.db.version(1).stores({
          bikes: '++_id, &no, owner, _updatedAt, dateSelling',
          // ++_id = Auto-incrementing primary key
          // &no = Unique index for bike plate
          // _updatedAt = Timestamp for sync
          // dateSelling = Indexed for 'sold'/'unsold' filter
        });
        
        await this.db.open();
        console.log("Database initialized.");
      }
      
      /**
       * Checks for data from the old v2 app in localStorage.
       * If found, migrates it to IndexedDB and clears the old key.
       */
      async migrateFromLocalStorage() {
        const oldDataRaw = localStorage.getItem(OLD_STORAGE_KEY);
        if (!oldDataRaw) {
          console.log("No old v2 data found to migrate.");
          return;
        }
        
        try {
          const oldDb = JSON.parse(oldDataRaw);
          if (!Array.isArray(oldDb) || oldDb.length === 0) {
            localStorage.removeItem(OLD_STORAGE_KEY);
            return;
          }
          
          console.log(`Migrating ${oldDb.length} records from localStorage...`);
          
          const now = new Date().toISOString();
          const recordsToMigrate = oldDb.map(record => ({
            ...record,
            purchasePrice: Number(record.purchasePrice) || 0,
            repairCost: Number(record.repairCost) || 0,
            sellingPrice: Number(record.sellingPrice) || 0,
            netProfit: Number(record.netProfit) || 0,
            _updatedAt: now, // Assign a standard "migrated" timestamp
          }));
          
          // Use bulkPut to add all, overwriting any conflicts (by 'no')
          await this.db.bikes.bulkPut(recordsToMigrate);
          
          // Success! Remove old data.
          localStorage.removeItem(OLD_STORAGE_KEY);
          this.showToast(`Successfully migrated ${oldDb.length} records from v2.`, 'success');
          
        } catch (error) {
          console.error("Migration failed:", error);
          this.showToast("Failed to migrate old data.", 'error');
        }
      }

      // --- 3. SETTINGS & PERSONALIZATION ---
      
      async loadSettings() {
        const savedSettings = localStorage.getItem(SETTINGS_KEY);
        if (savedSettings) {
          this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
        }
        this.applySettings();
      }
      
      async saveSettings() {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(this.settings));
        this.applySettings();
        this.vibrate(10);
      }
      
      /**
       * Applies settings to the UI (currency, name, etc.)
       */
      applySettings() {
        // Update header title
        this.dom.headerTitle.textContent = this.settings.businessName || 'Bike Manager';
        document.title = this.settings.businessName || 'Bike Manager';
        
        // Update currency symbols
        document.querySelectorAll('.currency').forEach(el => {
          el.textContent = this.settings.currency || '₹';
        });
        
        // Populate settings form
        document.getElementById('setting-gist-id').value = this.settings.gistId || '';
        document.getElementById('setting-gist-filename').value = this.settings.gistFilename || 'bikes_inventory.csv';
        document.getElementById('setting-github-pat').value = this.settings.githubPat || '';
        document.getElementById('setting-business-name').value = this.settings.businessName || '';
        document.getElementById('setting-currency').value = this.settings.currency || '';
      }
      
      // --- 4. UI & EVENT LISTENERS ---
      
      initUI() {
        // Adjust UI for desktop if needed
        if (!this.isMobile) {
          document.getElementById('add-bike-desktop').style.display = 'inline-flex';
        }
        
        // Set initial filter chip
        document.getElementById('filter-all').classList.add('active');
        
        // Set initial online status
        this.updateOnlineStatus();
      }
      
      initEventListeners() {
        // --- Navigation ---
        this.dom.navButtons.forEach(btn => {
          btn.addEventListener('click', () => this.navigateTo(btn.dataset.view));
        });
        
        // --- Header Actions ---
        this.dom.syncNowBtn.addEventListener('click', () => this.syncNow());
        
        // --- Main List View ---
        document.getElementById('search-input').addEventListener('input', (e) => {
          this.currentFilters.search = e.target.value.toLowerCase();
          this.debouncedRenderList();
        });
        document.getElementById('filter-all').addEventListener('click', () => this.setFilterStatus('all'));
        document.getElementById('filter-sold').addEventListener('click', () => this.setFilterStatus('sold'));
        document.getElementById('filter-unsold').addEventListener('click', () => this.setFilterStatus('unsold'));
        document.getElementById('bike-list').addEventListener('click', (e) => {
          const card = e.target.closest('.bike-card');
          if (card) {
            this.handleEditBike(card.dataset.id);
          }
        });
        
        // --- Add/Edit Modal ---
        const addBtns = [document.getElementById('fab-add'), document.getElementById('add-bike-desktop')];
        addBtns.forEach(btn => btn.addEventListener('click', () => this.handleNewBike()));
        
        document.getElementById('close-form-modal').addEventListener('click', () => this.closeFormModal());
        document.getElementById('cancel-form-btn').addEventListener('click', () => this.closeFormModal());
        document.getElementById('save-form-btn').addEventListener('click', () => this.handleSaveBike());
        document.getElementById('delete-bike-btn').addEventListener('click', () => this.handleDeleteBike());
        
        // Auto-calculate profit
        const profitInputs = ['form-purchasePrice', 'form-repairCost', 'form-sellingPrice'];
        profitInputs.forEach(id => {
          document.getElementById(id).addEventListener('input', () => this.calculateFormProfit());
        });
        
        // --- Settings View ---
        document.getElementById('save-sync-settings').addEventListener('click', () => this.handleSaveSyncSettings());
        document.getElementById('save-display-settings').addEventListener('click', () => this.handleSaveDisplaySettings());
        document.getElementById('export-csv').addEventListener('click', () => this.exportData('csv'));
        document.getElementById('export-json').addEventListener('click', () => this.exportData('json'));
        document.getElementById('export-xlsx').addEventListener('click', () => this.exportData('xlsx'));
        document.getElementById('import-csv').addEventListener('click', () => document.getElementById('import-file-input').click());
        document.getElementById('import-file-input').addEventListener('change', (e) => this.handleImportFile(e));
        document.getElementById('wipe-data-btn').addEventListener('click', () => this.handleWipeData());
        
        // --- Global Listeners ---
        window.addEventListener('online', () => this.updateOnlineStatus());
        window.addEventListener('offline', () => this.updateOnlineStatus());
        window.addEventListener('resize', this.debounce(() => {
          this.isMobile = window.innerWidth < 768;
          this.initUI();
        }, 200));
      }
      
      /**
       * Main render loop. Updates all dynamic parts of the UI.
       */
      async renderAll() {
        this.renderBikeList();
        this.renderStatsDashboard();
      }
      
      /**
       * Renders the list of bikes based on current filters.
       */
      async renderBikeList() {
        let bikes;
        const listEl = document.getElementById('bike-list');
        const emptyEl = document.getElementById('bike-list-empty');
        
        // Apply status filter (IndexedDB query)
        if (this.currentFilters.status === 'sold') {
          bikes = await this.db.bikes.where('dateSelling').notEqual('').toArray();
        } else if (this.currentFilters.status === 'unsold') {
          bikes = await this.db.bikes.where({ dateSelling: '' }).toArray();
        } else {
          bikes = await this.db.bikes.toArray();
        }
        
        // Apply search filter (JS filter)
        if (this.currentFilters.search) {
          const search = this.currentFilters.search;
          bikes = bikes.filter(b => 
            b.no.toLowerCase().includes(search) || 
            b.owner.toLowerCase().includes(search)
          );
        }
        
        // Sort (newest first)
        bikes.sort((a, b) => new Date(b._updatedAt) - new Date(a._updatedAt));
        
        // Render
        if (bikes.length === 0) {
          listEl.innerHTML = '';
          emptyEl.classList.remove('hidden');
          return;
        }
        
        emptyEl.classList.add('hidden');
        listEl.innerHTML = bikes.map(bike => this.createBikeCardHTML(bike)).join('');
      }
      
      createBikeCardHTML(bike) {
        const isSold = !!bike.dateSelling;
        const profit = bike.netProfit || 0;
        let profitClass = 'profit-value';
        let profitDisplay = `${this.settings.currency} ${this.formatCurrency(profit)}`;
        
        if (!isSold) {
          profitClass += ' unrealized';
          profitDisplay = 'Unsold';
        } else if (profit < 0) {
          profitClass += ' loss';
        } else if (profit === 0) {
          profitClass = 'text-secondary';
        }
        
        return `
          <div class="bike-card" data-id="${bike._id}">
            <div class="bike-card-main">
              <div class="bike-card-plate">${bike.no}</div>
              <div class="bike-card-owner">${bike.owner}</div>
            </div>
            <div class="bike-card-profit">
              <div class="${profitClass}">${profitDisplay}</div>
            </div>
          </div>
        `;
      }

      /**
       * Renders the stats cards and charts on the dashboard.
       */
      async renderStatsDashboard() {
        const bikes = await this.db.bikes.toArray();
        const soldBikes = bikes.filter(b => !!b.dateSelling);
        const unsoldBikes = bikes.filter(b => !b.dateSelling);
        
        // 1. Calculate Quick Stats
        const totalProfit = soldBikes.reduce((sum, b) => sum + b.netProfit, 0);
        const unsoldValue = unsoldBikes.reduce((sum, b) => sum + b.purchasePrice + b.repairCost, 0);
        
        document.getElementById('stat-total-profit').textContent = this.formatCurrency(totalProfit);
        document.getElementById('stat-unsold-value').textContent = this.formatCurrency(unsoldValue);
        document.getElementById('stat-sold-count').textContent = soldBikes.length;
        document.getElementById('stat-unsold-count').textContent = unsoldBikes.length;

        // 2. Generate Auto-Insight
        const avgProfit = soldBikes.length > 0 ? totalProfit / soldBikes.length : 0;
        document.getElementById('auto-insight-text').textContent = 
          `You have ${unsoldBikes.length} bikes in stock. Your average profit on a sold bike is ${this.settings.currency}${this.formatCurrency(avgProfit)}.`;

        // 3. Render Charts (only if on the stats view)
        if (this.currentView === 'view-stats') {
          this.renderProfitTrendChart(soldBikes);
          this.renderProfitPieChart(soldBikes);
          this.renderTopBikesChart(soldBikes);
        }
      }
      
      // --- 5. CHART.JS IMPLEMENTATION ---
      
      renderProfitTrendChart(soldBikes) {
        const ctx = document.getElementById('chart-profit-trend').getContext('2d');
        
        // Group profit by month
        const monthlyData = soldBikes.reduce((acc, bike) => {
          const month = bike.dateSelling.substring(0, 7); // 'YYYY-MM'
          acc[month] = (acc[month] || 0) + bike.netProfit;
          return acc;
        }, {});
        
        const sortedMonths = Object.keys(monthlyData).sort();
        const labels = sortedMonths.map(month => new Date(month + '-02')); // Use 2nd day to avoid TZ issues
        const data = sortedMonths.map(month => monthlyData[month]);

        if (this.charts.profitTrend) this.charts.profitTrend.destroy();
        this.charts.profitTrend = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Monthly Profit',
              data: data,
              borderColor: 'rgba(0, 208, 255, 1)',
              backgroundColor: 'rgba(0, 208, 255, 0.2)',
              fill: true,
              tension: 0.3,
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: {
                type: 'time',
                time: { unit: 'month' },
                ticks: { color: 'var(--text-secondary)' },
                grid: { color: 'var(--border-color-subtle)' }
              },
              y: {
                beginAtZero: true,
                ticks: { color: 'var(--text-secondary)' },
                grid: { color: 'var(--border-color-subtle)' }
              }
            },
            plugins: { legend: { display: false } }
          }
        });
      }
      
      renderProfitPieChart(soldBikes) {
        const ctx = document.getElementById('chart-profit-pie').getContext('2d');
        const profitRanges = {
          'Loss (< 0)': soldBikes.filter(b => b.netProfit < 0).length,
          'Low (0-5k)': soldBikes.filter(b => b.netProfit >= 0 && b.netProfit < 5000).length,
          'Mid (5k-10k)': soldBikes.filter(b => b.netProfit >= 5000 && b.netProfit < 10000).length,
          'High (> 10k)': soldBikes.filter(b => b.netProfit >= 10000).length,
        };

        if (this.charts.profitPie) this.charts.profitPie.destroy();
        this.charts.profitPie = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: Object.keys(profitRanges),
            datasets: [{
              data: Object.values(profitRanges),
              backgroundColor: ['#ef4444', '#f59e0b', '#22c55e', '#00D0FF'],
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top', labels: { color: 'var(--text-primary)' } }
            }
          }
        });
      }
      
      renderTopBikesChart(soldBikes) {
        const ctx = document.getElementById('chart-top-bikes').getContext('2d');
        const top5 = soldBikes.sort((a, b) => b.netProfit - a.netProfit).slice(0, 5);
        
        if (this.charts.topBikes) this.charts.topBikes.destroy();
        this.charts.topBikes = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: top5.map(b => b.no),
            datasets: [{
              label: 'Net Profit',
              data: top5.map(b => b.netProfit),
              backgroundColor: 'rgba(110, 231, 183, 0.6)',
              borderColor: 'rgba(110, 231, 183, 1)',
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            scales: {
              x: { ticks: { color: 'var(--text-secondary)' }, grid: { color: 'var(--border-color-subtle)' } },
              y: { ticks: { color: 'var(--text-secondary)' }, grid: { display: false } }
            },
            plugins: { legend: { display: false } }
          }
        });
      }

      // --- 6. CORE CRUD OPERATIONS ---
      
      handleNewBike() {
        this.openFormModal();
      }
      
      async handleEditBike(id) {
        try {
          const bike = await this.db.bikes.get(Number(id));
          if (bike) {
            this.openFormModal(bike);
          }
        } catch (error) {
          console.error("Failed to get bike for editing:", error);
          this.showToast("Could not load bike data.", 'error');
        }
      }
      
      async handleSaveBike() {
        const form = document.getElementById('bike-form');
        const id = document.getElementById('form-bike-id').value;
        
        // 1. Read & Validate Form
        const plate = document.getElementById('form-no').value.trim().toUpperCase();
        const owner = document.getElementById('form-owner').value.trim();
        
        if (!plate || !owner) {
          this.showToast("Bike Plate and Owner Name are required.", 'error');
          return;
        }
        
        const purchasePrice = Number(document.getElementById('form-purchasePrice').value) || 0;
        const repairCost = Number(document.getElementById('form-repairCost').value) || 0;
        const sellingPrice = Number(document.getElementById('form-sellingPrice').value) || 0;
        
        const bikeData = {
          no: plate,
          owner: owner,
          purchasePrice: purchasePrice,
          repairCost: repairCost,
          sellingPrice: sellingPrice,
          netProfit: sellingPrice - (purchasePrice + repairCost),
          datePurchase: document.getElementById('form-datePurchase').value || '',
          dateSelling: document.getElementById('form-dateSelling').value || '',
          _updatedAt: new Date().toISOString(),
        };
        
        try {
          // 2. Save to DB
          if (id) {
            // Update existing
            await this.db.bikes.update(Number(id), bikeData);
            this.showToast("Bike updated successfully.", 'success');
          } else {
            // Add new
            await this.db.bikes.add(bikeData);
            this.showToast("Bike added successfully.", 'success');
            
            // Confetti for first bike?
            const count = await this.db.bikes.count();
            if (count === 1) {
              this.showConfetti();
            }
          }
          
          // 3. Post-Save
          this.vibrate(20);
          this.closeFormModal();
          this.renderAll(); // Full re-render
          this.triggerAutoSync(); // Trigger a sync in the background
          
        } catch (error) {
          console.error("Save bike failed:", error);
          if (error.name === 'ConstraintError') {
            this.showToast("A bike with this plate number already exists.", 'error');
          } else {
            this.showToast("Failed to save bike.", 'error');
          }
        }
      }
      
      async handleDeleteBike() {
        const id = document.getElementById('form-bike-id').value;
        if (!id) return;
        
        if (confirm("Are you sure you want to delete this bike? This cannot be undone easily.")) {
          try {
            await this.db.bikes.delete(Number(id));
            this.showToast("Bike deleted.", 'success');
            this.vibrate(50);
            this.closeFormModal();
            this.renderAll();
            this.triggerAutoSync();
          } catch (error) {
            console.error("Delete failed:", error);
            this.showToast("Failed to delete bike.", 'error');
          }
        }
      }

      // --- 7. FORM & MODAL UI ---
      
      openFormModal(bike = null) {
        const modal = document.getElementById('form-modal');
        const title = document.getElementById('form-title');
        const deleteBtn = document.getElementById('delete-bike-btn');
        const form = document.getElementById('bike-form');
        
        form.reset(); // Clear form
        
        if (bike) {
          // Edit mode
          title.textContent = "Edit Bike";
          deleteBtn.classList.remove('hidden');
          
          document.getElementById('form-bike-id').value = bike._id;
          document.getElementById('form-no').value = bike.no;
          document.getElementById('form-owner').value = bike.owner;
          document.getElementById('form-datePurchase').value = bike.datePurchase;
          document.getElementById('form-dateSelling').value = bike.dateSelling;
          document.getElementById('form-purchasePrice').value = bike.purchasePrice;
          document.getElementById('form-repairCost').value = bike.repairCost;
          document.getElementById('form-sellingPrice').value = bike.sellingPrice;
          this.calculateFormProfit();
          
        } else {
          // Add mode
          title.textContent = "Add New Bike";
          deleteBtn.classList.add('hidden');
          document.getElementById('form-bike-id').value = '';
          // Set purchase date to today by default
          document.getElementById('form-datePurchase').value = new Date().toISOString().split('T')[0];
        }
        
        modal.classList.add('active');
      }
      
      closeFormModal() {
        document.getElementById('form-modal').classList.remove('active');
      }
      
      calculateFormProfit() {
        const p = Number(document.getElementById('form-purchasePrice').value) || 0;
        const r = Number(document.getElementById('form-repairCost').value) || 0;
        const s = Number(document.getElementById('form-sellingPrice').value) || 0;
        const profit = s - (p + r);
        document.getElementById('form-netProfit').value = profit.toFixed(2);
      }
      
      // --- 8. SETTINGS HANDLERS ---
      
      handleSaveSyncSettings() {
        this.settings.gistId = document.getElementById('setting-gist-id').value.trim();
        this.settings.gistFilename = document.getElementById('setting-gist-filename').value.trim() || 'bikes_inventory.csv';
        this.settings.githubPat = document.getElementById('setting-github-pat').value.trim();
        
        this.saveSettings();
        this.showToast("Sync settings saved.", 'success');
      }
      
      handleSaveDisplaySettings() {
        this.settings.businessName = document.getElementById('setting-business-name').value.trim();
        this.settings.currency = document.getElementById('setting-currency').value.trim();
        
        this.saveSettings();
        this.showToast("Display settings saved.", 'success');
        this.renderAll(); // Re-render to apply currency/etc.
      }
      
      async handleWipeData() {
        if (confirm("WARNING: This will delete ALL local bike data from your browser. This cannot be undone. Are you sure?")) {
          if (confirm("Final confirmation: Delete all data?")) {
            try {
              await this.db.bikes.clear();
              this.showToast("All local data has been wiped.", 'success');
              this.vibrate(100);
              this.renderAll();
            } catch (error) {
              console.error("Data wipe failed:", error);
              this.showToast("Data wipe failed.", 'error');
            }
          }
        }
      }
      
      // --- 9. IMPORT / EXPORT ---
      
      async exportData(format) {
        const bikes = await this.db.bikes.orderBy('no').toArray();
        if (bikes.length === 0) {
          this.showToast("No data to export.", 'warning');
          return;
        }
        
        // Clean data for export (remove _id)
        const exportBikes = bikes.map(b => {
          const { _id, ...rest } = b;
          return rest;
        });
        
        const timestamp = new Date().toISOString().split('T')[0];
        const filename = `bike_inventory_${timestamp}`;

        if (format === 'json') {
          const json = JSON.stringify(exportBikes, null, 2);
          this.downloadFile(json, `${filename}.json`, 'application/json');
        } else if (format === 'csv') {
          const csv = this.jsonToCsv(exportBikes);
          this.downloadFile(csv, `${filename}.csv`, 'text/csv');
        } else if (format === 'xlsx') {
          const ws = XLSX.utils.json_to_sheet(exportBikes);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Bikes');
          XLSX.writeFile(wb, `${filename}.xlsx`);
        }
        this.vibrate(10);
      }
      
      handleImportFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const content = e.target.result;
            let bikesToImport = [];
            
            if (file.name.endsWith('.json')) {
              bikesToImport = JSON.parse(content);
            } else if (file.name.endsWith('.csv')) {
              bikesToImport = this.csvTojson(content);
            } else {
              this.showToast("Unsupported file type. Please use .csv or .json", 'error');
              return;
            }
            
            if (!Array.isArray(bikesToImport)) throw new Error("Invalid file format.");
            
            // Add/update metadata
            const now = new Date().toISOString();
            const preparedBikes = bikesToImport.map(b => ({
              no: (b.no || '').trim().toUpperCase(),
              owner: b.owner || '',
              purchasePrice: Number(b.purchasePrice) || 0,
              repairCost: Number(b.repairCost) || 0,
              sellingPrice: Number(b.sellingPrice) || 0,
              netProfit: Number(b.netProfit) || (Number(b.sellingPrice) - (Number(b.purchasePrice) + Number(b.repairCost))),
              datePurchase: b.datePurchase || '',
              dateSelling: b.dateSelling || '',
              _updatedAt: b._updatedAt || now, // Preserve timestamp if it exists
            })).filter(b => b.no); // Must have a plate number
            
            if (confirm(`Found ${preparedBikes.length} records. This will ADD new records and UPDATE existing records based on bike plate. Continue?`)) {
              // bulkPut does an "upsert" based on the unique key '&no'
              await this.db.bikes.bulkPut(preparedBikes);
              this.showToast(`Successfully imported/updated ${preparedBikes.length} records.`, 'success');
              this.renderAll();
            }
            
          } catch (error) {
            console.error("Import failed:", error);
            this.showToast("Import failed. Check file format.", 'error');
          } finally {
            event.target.value = ''; // Reset file input
          }
        };
        
        if (file.name.endsWith('.json')) {
          reader.readAsText(file);
        } else if (file.name.endsWith('.csv')) {
          reader.readAsText(file);
        }
      }

      // --- 10. GITHUB GIST SYNC ---
      
      /**
       * This is the core disconnected sync logic.
       * It performs a 3-way merge between local, remote, and a stored "last sync" state.
       * This implementation is simpler: it merges based on timestamp.
       * Local and remote data are merged, with the newest `_updatedAt` timestamp winning.
       */
      async syncNow() {
        if (!this.isOnline) {
          this.showToast("Cannot sync. You are offline.", 'warning');
          return;
        }
        
        const { gistId, githubPat, gistFilename } = this.settings;
        if (!gistId || !githubPat) {
          this.showToast("Gist ID and GitHub PAT must be set in Settings.", 'error');
          this.navigateTo('view-settings');
          return;
        }
        
        this.setSyncStatus('syncing', 'Syncing...');
        
        try {
          // 1. Fetch Remote Data
          this.setSyncStatus('syncing', 'Fetching remote...');
          const remoteFile = await this.fetchFromGist();
          let remoteBikes = [];
          if (remoteFile) {
            remoteBikes = this.csvTojson(atob(remoteFile.content));
          }
          
          // 2. Get Local Data
          const localBikes = await this.db.bikes.toArray();
          
          // 3. Merge Data (timestamp wins)
          this.setSyncStatus('syncing', 'Merging data...');
          const mergedBikesMap = new Map();
          
          // Add all local bikes to map
          for (const bike of localBikes) {
            mergedBikesMap.set(bike.no, bike);
          }
          
          // Merge remote bikes
          for (const remoteBike of remoteBikes) {
            const localBike = mergedBikesMap.get(remoteBike.no);
            if (!localBike || new Date(remoteBike._updatedAt) > new Date(localBike._updatedAt)) {
              // Remote is newer or doesn't exist locally
              mergedBikesMap.set(remoteBike.no, remoteBike);
            }
          }
          
          const mergedBikes = Array.from(mergedBikesMap.values());
          
          // 4. Write merged data back to local DB
          this.setSyncStatus('syncing', 'Saving local...');
          await this.db.bikes.clear();
          await this.db.bikes.bulkPut(mergedBikes);
          
          // 5. Write merged data back to Gist
          this.setSyncStatus('syncing', 'Pushing remote...');
          const csvContent = this.jsonToCsv(mergedBikes);
          const newFileContent = btoa(csvContent);
          
          if (!remoteFile || newFileContent !== remoteFile.content) {
            await this.pushToGist(newFileContent, remoteFile ? remoteFile.sha : null);
          } else {
            console.log("No changes to push.");
          }
          
          // 6. Success
          this.settings.lastSync = new Date().toISOString();
          this.saveSettings();
          this.setSyncStatus('success', 'Up to date');
          this.showToast("Sync complete.", 'success');
          this.renderAll();
          
        } catch (error) {
          console.error("Sync failed:", error);
          this.setSyncStatus('error', 'Sync Failed');
          this.showToast(error.message, 'error');
        }
      }
      
      /**
       * Fetches the content of the Gist file.
       * Returns file object { content, sha } or null.
       */
      async fetchFromGist() {
        const { gistId, githubPat, gistFilename } = this.settings;
        const url = `https://api.github.com/gists/${gistId}`;
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `token ${githubPat}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (!response.ok) {
          if (response.status === 404) {
            this.showToast("Gist not found. Check Gist ID.", 'error');
            return null;
          }
          throw new Error(`GitHub API error: ${response.statusText}`);
        }
        
        const gist = await response.json();
        const file = gist.files[gistFilename];
        
        if (!file) {
          console.log(`File '${gistFilename}' not found in Gist. Will create it on next sync.`);
          return null; // File doesn't exist, will be created on push
        }
        
        // Gist API returns truncated content if too large,
        // so we must fetch the raw_url if truncated.
        if (file.truncated) {
          const rawResponse = await fetch(file.raw_url);
          const textContent = await rawResponse.text();
          return { content: btoa(textContent), sha: gist.history[0].version }; // We can't get SHA from raw file, this is a limitation
        }
        
        return { content: file.content, sha: gist.history[0].version };
      }
      
      /**
       * Pushes new content to the Gist file.
       */
      async pushToGist(base64Content) {
        const { gistId, githubPat, gistFilename } = this.settings;
        const url = `https://api.github.com/gists/${gistId}`;
        
        const body = {
          description: `Bike Manager DB updated ${new Date().toISOString()}`,
          files: {
            [gistFilename]: {
              content: atob(base64Content) // Gist API expects raw text, not base64
            }
          }
        };
        
        const response = await fetch(url, {
          method: 'PATCH',
          headers: {
            'Authorization': `token ${githubPat}`,
            'Accept': 'application/vnd.github.v3+json'
          },
          body: JSON.stringify(body)
        });
        
        if (!response.ok) {
          throw new Error(`Failed to push to Gist: ${response.statusText}`);
        }
      }
      
      /**
       * A simple background sync trigger with debouncing.
       */
      triggerAutoSync = this.debounce(() => {
        if (this.isOnline && this.settings.gistId && this.settings.githubPat) {
          console.log("Triggering auto-sync in background...");
          this.syncNow().catch(err => console.error("Background sync failed", err));
        }
      }, 10000); // Wait 10 seconds after last change
      
      // --- 11. UI HELPERS ---
      
      navigateTo(viewId) {
        if (this.currentView === viewId) return;
        
        this.currentView = viewId;
        
        // Update view visibility
        this.dom.views.forEach(view => {
          view.classList.toggle('active', view.id === viewId);
        });
        
        // Update nav button active state
        this.dom.navButtons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.view === viewId);
        });
        
        // If we navigated to stats, render them
        if (viewId === 'view-stats') {
          this.renderStatsDashboard();
        }
        this.vibrate(10);
      }
      
      setFilterStatus(status) {
        this.currentFilters.status = status;
        
        // Update chip UI
        document.querySelectorAll('.filter-chips .chip').forEach(chip => {
          chip.classList.toggle('active', chip.dataset.filter === status);
        });
        
        this.renderBikeList();
        this.vibrate(10);
      }
      
      setSyncStatus(status, text) {
        this.dom.syncStatus.className = `sync-status ${status}`;
        this.dom.syncStatusText.textContent = text;
        
        if (status === 'syncing') {
          this.dom.syncNowBtn.disabled = true;
          this.dom.syncNowBtn.style.animation = 'spin 1.5s linear infinite';
        } else {
          this.dom.syncNowBtn.disabled = false;
          this.dom.syncNowBtn.style.animation = 'none';
        }
      }
      
      updateOnlineStatus() {
        this.isOnline = navigator.onLine;
        if (this.isOnline) {
          this.setSyncStatus('success', 'Online');
          // Try a sync if we just came online
          this.triggerAutoSync();
        } else {
          this.setSyncStatus('offline', 'Offline');
        }
      }
      
      showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        
        container.appendChild(toast);
        
        setTimeout(() => {
          toast.remove();
        }, 3000);
      }
      
      vibrate(duration) {
        if ('vibrate' in navigator) {
          navigator.vibrate(duration);
        }
      }
      
      showConfetti() {
        // A simple, lightweight confetti implementation
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const pieces = [];
        const pieceCount = 100;
        const colors = ['#00D0FF', '#6EE7B7', '#FFD700', '#FF69B4'];

        for (let i = 0; i < pieceCount; i++) {
          pieces.push({
            x: canvas.width / 2,
            y: canvas.height / 2,
            rx: Math.random() * 10 + 5,
            ry: Math.random() * 5 + 2,
            color: colors[Math.floor(Math.random() * colors.length)],
            vx: Math.random() * 10 - 5,
            vy: Math.random() * 10 - 5,
            opacity: 1,
            angle: Math.random() * 360,
          });
        }

        let frame = 0;
        function drawConfetti() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          if (frame > 200) { // Stop after ~3 seconds
            canvas.width = 0; canvas.height = 0; // Clear canvas
            return;
          }
          
          pieces.forEach(p => {
            ctx.beginPath();
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.angle * Math.PI / 180);
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.opacity;
            ctx.ellipse(0, 0, p.rx, p.ry, 0, 0, 2 * Math.PI);
            ctx.fill();
            ctx.restore();
            
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.1; // Gravity
            p.opacity -= 0.005;
            p.angle += p.vx;
          });
          
          frame++;
          requestAnimationFrame(drawConfetti);
        }
        drawConfetti();
      }

      // --- 12. UTILITY FUNCTIONS ---

      formatCurrency(value) {
        return (value || 0).toLocaleString(undefined, {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });
      }
      
      debounce(func, delay) {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
        };
      }
      
      downloadFile(content, fileName, contentType) {
        const a = document.createElement('a');
        const file = new Blob([content], { type: contentType });
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(a.href);
      }
      
      jsonToCsv(items) {
        // Use the same headers as the old app, plus _updatedAt
        const headers = ['_id', '_updatedAt', 'no', 'owner', 'purchasePrice', 'repairCost', 'sellingPrice', 'netProfit', 'datePurchase', 'dateSelling'];
        const replacer = (key, value) => value === null ? '' : value;
        const headerRow = headers.map(h => `"${h}"`).join(',');
        
        const rows = items.map(row => 
          headers.map(header => 
            `"${String(row[header] || '').replace(/"/g, '""')}"`
          ).join(',')
        );
        
        return [headerRow, ...rows].join('\r\n');
      }
      
      csvTojson(text) {
        const lines = text.split('\n').filter(Boolean);
        if (lines.length < 2) return [];
        
        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
        
        return lines.slice(1).map(line => {
          // Simple CSV parse, not robust for commas in fields
          const values = line.split(',').map(v => v.replace(/"/g, '').trim());
          const obj = {};
          headers.forEach((header, index) => {
            obj[header] = values[index];
          });
          return obj;
        });
      }
      
    }
    
    // --- Initialize the application ---
    window.app = new BikeManagerApp();
    
  </script>
</body>
</html>