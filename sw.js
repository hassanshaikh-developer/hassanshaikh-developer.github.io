const VERSION='1.0.0';const CACHE_NAME=`bike-manager-v${VERSION}`;const ASSETS=['./','/index.html','./manifest.webmanifest','./icons/icon-192.png','./icons/icon-512.png'];self.addEventListener('install',e=>{console.log('[SW] Install v'+VERSION);e.waitUntil((async()=>{const cache=await caches.open(CACHE_NAME);await Promise.allSettled(ASSETS.map(url=>cache.add(url).catch(err=>console.warn('[SW] Failed to cache:',url,err))));await self.skipWaiting()})())});self.addEventListener('activate',e=>{console.log('[SW] Activate v'+VERSION);e.waitUntil((async()=>{const keys=await caches.keys();await Promise.all(keys.filter(k=>k!==CACHE_NAME).map(k=>caches.delete(k)));await self.clients.claim()})())});self.addEventListener('fetch',e=>{if(e.request.method!=='GET')return;const url=new URL(e.request.url);if(url.origin!==location.origin)return;const isNav=e.request.mode==='navigate';if(isNav){e.respondWith((async()=>{try{const net=await fetch(e.request);const cache=await caches.open(CACHE_NAME);cache.put(e.request,net.clone());return net}catch{const cached=await caches.match(e.request)||await caches.match('./index.html');return cached||new Response('Offline',{status:503,statusText:'Offline'})}})());return}
e.respondWith((async()=>{const cached=await caches.match(e.request);if(cached)return cached;try{const net=await fetch(e.request);if(net.ok){const cache=await caches.open(CACHE_NAME);cache.put(e.request,net.clone())}
return net}catch{return new Response('Offline',{status:503})}})())});self.addEventListener('message',e=>{if(e.data?.type==='SKIP_WAITING'){self.skipWaiting()}});
