<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' blob:; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src https://api.github.com; worker-src blob:; base-uri 'none'; form-action 'self'">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Bike Resell Manager</title>
<meta name="theme-color" content="#0A84FF" />
<!-- Inline Web App Manifest as data URL -->
<link rel="manifest" id="manifest-link" href='data:application/manifest+json,{
  "name":"Bike Resell Manager",
  "short_name":"BRM",
  "start_url":"./",
  "display":"standalone",
  "background_color":"#F5F7FB",
  "theme_color":"#0A84FF",
  "icons":[
    {"src":"data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 128 128%27%3E%3Crect width=%27128%27 height=%27128%27 rx=%2728%27 fill=%27%230A84FF%27/%3E%3Cpath fill=%27%23fff%27 d=%27M36 86a12 12 0 1 0 0-24 12 12 0 0 0 0 24zm56 0a12 12 0 1 0 0-24 12 12 0 0 0 0 24zM64 38h18a18 18 0 0 1 0 36H50l-6 12H30l9.2-18.5A18 18 0 0 1 46 38h18zm0 10H46a8 8 0 0 0 0 16h18a8 8 0 0 0 0-16z%27/%3E%3C/svg%3E","sizes":"128x128","type":"image/svg+xml","purpose":"any maskable"}
  ]
}' />
<style>
/* =========================================================
   Galaxy-like / One UI Light Theme
   - Large headers, generous spacing, rounded surfaces, subtle shadows
   - High-contrast text, clear forms & controls
   ========================================================= */
:root{
  /* Colors */
  --bg:#F5F7FB;            /* app background */
  --surface:#FFFFFF;       /* cards, sheets */
  --surface-2:#FAFBFF;     /* subtle alt */
  --text:#0B1A33;          /* primary text */
  --text-muted:#5A6B86;    /* secondary */
  --brand:#0A84FF;         /* primary accent (Galaxy-like) */
  --brand-ink:#064C9A;
  --ok:#17A34A;
  --warn:#FB8C00;
  --danger:#E73A39;
  --stroke:#E2E8F0;        /* borders */
  --chip:#EEF2F8;
  --focus:#0A84FF55;

  /* Radii & shadows */
  --r-xl:20px; --r-lg:16px; --r-md:12px; --r-sm:10px;
  --shadow:0 8px 24px rgba(12,21,46,.08), 0 2px 6px rgba(12,21,46,.06);

  /* Type */
  --h1:22px; --h2:16px; --h3:12px; --kpi:22px; --body:14px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--text);background:var(--bg);
  font:var(--body)/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
a{color:var(--brand);text-decoration:none}
button,input,select,textarea{font:inherit;color:inherit}

header{
  position:sticky;top:0;z-index:5;background:rgba(255,255,255,.8);backdrop-filter:saturate(1.3) blur(8px);
  border-bottom:1px solid var(--stroke)
}
.container{max-width:1024px;margin:0 auto;padding:0 14px}
.h-row{display:flex;align-items:center;gap:12px;min-height:64px}
h1{font-size:var(--h1);margin:0;font-weight:800;letter-spacing:.2px}
.brand-dot{width:8px;height:8px;border-radius:999px;background:var(--brand)}
.pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:var(--chip)}
.pill[data-state="offline"]{background:#FFF4F4;color:#D12E2E;border-color:#FFD9D9}
.pill[data-state="syncing"]{background:#FFF6E8;color:#B76100;border-color:#FFE2B3}
.pill[data-state="ok"]{background:#E8FFF4;color:#086B3C;border-color:#B6F0D1}

main{padding:16px 0 92px 0}
.grid{display:grid;gap:12px}
.cards{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (min-width:760px){ .cards{grid-template-columns:repeat(4,1fr)} }
.card{
  background:var(--surface); border:1px solid var(--stroke); border-radius:var(--r-xl); padding:14px; box-shadow:var(--shadow)
}
.card h3{margin:0 0 8px 0;font-size:var(--h3);color:var(--text-muted);text-transform:uppercase;letter-spacing:.08em}
.kpi{font-size:var(--kpi);font-weight:800}

.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

input[type="text"],input[type="number"],input[type="date"],input[type="datetime-local"],select,textarea{
  width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--stroke);background:var(--surface-2);
  outline:none; transition:.2s border-color;
}
input::placeholder{color:#94A3B8}
input:focus,select:focus,textarea:focus{border-color:#C3D7FF; box-shadow:0 0 0 3px var(--focus)}
label{display:block;margin:8px 0 6px 0;font-size:12px;color:var(--text-muted);font-weight:600}

.btn{
  border:1px solid var(--stroke); background:#FFF; border-radius:14px; padding:10px 14px; cursor:pointer; box-shadow:var(--shadow);
}
.btn.primary{background:linear-gradient(180deg,#0A84FF,#0064E6); color:#fff; border:0}
.btn.warn{background:linear-gradient(180deg,#FB8C00,#E27200); color:#fff; border:0}
.btn.danger{background:linear-gradient(180deg,#E73A39,#C71E1E); color:#fff; border:0}
.btn.ghost{background:#fff}
.btn:focus-visible{outline:3px solid var(--focus);outline-offset:2px}

.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{background:var(--chip);border:1px solid var(--stroke);border-radius:999px;padding:8px 12px;font-size:12px;cursor:pointer}
.chip[aria-pressed="true"]{background:#E6F0FF;border-color:#B7D3FF;color:#0A4FBF}

.list{display:grid;gap:10px}
.item{
  background:var(--surface); border:1px solid var(--stroke); border-radius:18px; padding:12px;
  display:grid;grid-template-columns:auto 1fr auto; gap:12px; align-items:center; box-shadow:var(--shadow)
}
.item .meta{font-size:12px;color:var(--text-muted)}
.item .title{font-weight:800}

.bulkbar{
  position:sticky;bottom:72px;z-index:4;background:#FFFFFFCC; backdrop-filter:blur(8px);
  border:1px solid var(--stroke); padding:12px; display:none; gap:8px; border-radius:16px; box-shadow:var(--shadow)
}
.bulkbar[data-show="true"]{display:flex}

.bottom-nav{
  position:fixed;left:0;right:0;bottom:0;z-index:6;background:#fff; border-top:1px solid var(--stroke);
  display:grid;grid-template-columns:repeat(3,1fr); box-shadow:0 -10px 30px rgba(9,30,66,.05)
}
.tabbtn{appearance:none;border:0;background:transparent;padding:10px 4px;font:inherit;color:#7A8CA8;display:flex;flex-direction:column;align-items:center;gap:4px}
.tabbtn[data-active="true"]{color:#0B1A33;font-weight:700}
.tabcontent{display:none;padding:12px}
.tabcontent[data-active="true"]{display:block}

.toast{
  position:fixed;left:50%;transform:translateX(-50%);bottom:104px;background:#0B1A33;color:#fff;border:0;
  padding:12px 16px;border-radius:14px;display:none;z-index:7; box-shadow:var(--shadow)
}
.toast[data-show="true"]{display:block;animation:fade 3.2s ease}
@keyframes fade{0%{opacity:0;transform:translate(-50%,10px)}10%,90%{opacity:1;transform:translate(-50%,0)}100%{opacity:0;transform:translate(-50%,5px)}}

.badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--stroke);background:var(--surface-2)}
hr.sep{border:0;border-top:1px solid var(--stroke);margin:8px 0}
.help{font-size:13px;color:var(--text-muted)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--stroke);padding:8px;text-align:left}
th{background:#F3F6FD;color:#374151}

dialog{
  border:1px solid var(--stroke);border-radius:18px;background:#fff;color:var(--text);padding:0;max-width:640px;width:calc(100% - 24px);box-shadow:var(--shadow)
}
dialog::backdrop{background:rgba(14,24,46,.25)}
.dhead{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid var(--stroke)}
.dhead strong{font-size:16px}
.dbody{padding:14px;max-height:65vh;overflow:auto}
.dfoot{padding:14px;border-top:1px solid var(--stroke);display:flex;gap:10px;justify-content:flex-end}
.small{font-size:12px;color:var(--text-muted)}
code.inline{background:#F3F6FD;border:1px solid var(--stroke);padding:2px 6px;border-radius:8px}
.hidden{display:none !important}
.sticky-undo{position:fixed;right:14px;bottom:120px;z-index:8}

.header-note{margin-left:auto;display:flex;gap:8px;align-items:center;font-size:12px;color:#5A6B86}
kbd{background:#EEF2F8;border:1px solid #DCE4F0;border-bottom-width:2px;border-radius:6px;padding:0 6px;font-size:12px}

.callout{background:#F3F9FF;border:1px solid #D8E9FF;color:#053B7A;border-radius:12px;padding:10px}
</style>
</head>
<body>
<header role="banner">
  <div class="container h-row" aria-live="polite">
    <span class="brand-dot" aria-hidden="true"></span>
    <h1 aria-label="App title">Bike Resell Manager</h1>
    <span class="pill" id="syncPill" data-state="offline" title="Sync status">Offline</span>
    <span class="header-note">
      <span id="lastSyncedText" aria-live="polite"></span>
      <span>Only <code class="inline">api.github.com</code></span>
    </span>
  </div>
</header>

<main class="container" id="app" role="main">
  <!-- Bikes / Dashboard Tab -->
  <section id="tab-bikes" class="tabcontent" data-active="true" aria-labelledby="nav-bikes">
    <div class="cards" role="region" aria-label="At a Glance">
      <div class="card" aria-live="polite"><h3>Cash in Hand</h3><div class="kpi" id="kpi-cash">‚Çπ0</div></div>
      <div class="card"><h3>Profit (Sold)</h3><div class="kpi" id="kpi-profit">‚Çπ0</div></div>
      <div class="card"><h3>Unsold Investment</h3><div class="kpi" id="kpi-unsold">‚Çπ0</div></div>
      <div class="card"><h3>Inventory S/U</h3><div class="kpi"><span id="kpi-stock">0</span> / <span id="kpi-sold">0</span></div></div>
    </div>

    <div class="card">
      <div class="toolbar" role="toolbar" aria-label="List actions">
        <label class="hidden" for="searchInput">Search</label>
        <input id="searchInput" type="text" placeholder="Search plate / model / owner" aria-label="Search all bikes (e.g., MH12.., Splendor, Rohit)" />
        <select id="sortSelect" aria-label="Sort">
          <option value="latest">Sort: Latest</option>
          <option value="oldest">Oldest</option>
          <option value="profitDesc">Profit high ‚Üí low</option>
          <option value="profitAsc">Profit low ‚Üí high</option>
        </select>
        <button class="btn" id="btnFilters" aria-haspopup="dialog" title="Advanced filters">Filters</button>
        <button class="btn primary" id="btnBuy">Buy Bike</button>
        <button class="btn" id="btnAdjust">Adjust Cash</button>
      </div>
      <div class="chips" role="tablist" aria-label="Status filter">
        <button class="chip" data-status="all" aria-pressed="true">All</button>
        <button class="chip" data-status="sold" aria-pressed="false">Sold</button>
        <button class="chip" data-status="available" aria-pressed="false">Unsold</button>
      </div>
      <p class="help callout" style="margin-top:8px">
        Tip: Press <kbd>F</kbd> to open filters quickly. Press <kbd>/</kbd> to jump to search.
      </p>
    </div>

    <div id="bikeList" class="list" role="list" aria-label="Bikes"></div>

    <div class="bulkbar" id="bulkBar" aria-live="polite" aria-label="Bulk actions">
      <span id="bulkCount"><strong>0</strong> selected</span>
      <button class="btn primary" id="bulkSell">Mass Sell</button>
      <button class="btn" id="bulkExport">Export CSV</button>
      <button class="btn danger" id="bulkWriteoff">Write-off</button>
    </div>

    <button id="undoSticky" class="btn sticky-undo hidden">Undo last action</button>
  </section>

  <!-- Analytics Tab -->
  <section id="tab-analytics" class="tabcontent" aria-labelledby="nav-analytics">
    <div class="card">
      <h3>Filters</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div><label for="anaFrom">From Date</label><input type="date" id="anaFrom"/></div>
        <div><label for="anaTo">To Date</label><input type="date" id="anaTo"/></div>
      </div>
      <div class="dfoot" style="padding:0;margin-top:8px"><button class="btn" id="btnApplyAnalytics">Apply</button></div>
    </div>

    <div class="card">
      <h3>Quick Insights</h3>
      <div class="grid">
        <div>Total Investment: <span class="badge" id="anaInvest">‚Çπ0</span></div>
        <div>Total Returns: <span class="badge" id="anaReturns">‚Çπ0</span></div>
        <div>Net Profit: <span class="badge" id="anaNet">‚Çπ0</span></div>
        <div>Total Repair Cost: <span class="badge" id="anaRepair">‚Çπ0</span></div>
        <div>Average ROI: <span class="badge" id="anaROI">0%</span></div>
        <div>Average Days to Sell: <span class="badge" id="anaDays">0</span></div>
      </div>
      <hr class="sep"/>
      <h3>Cash Flow (Last 30 days)</h3>
      <div class="grid">
        <div>Inflow: <span class="badge" id="anaInflow">‚Çπ0</span></div>
        <div>Outflow: <span class="badge" id="anaOutflow">‚Çπ0</span></div>
        <div>Net: <span class="badge" id="anaNetFlow">‚Çπ0</span></div>
        <div>Current Cash: <span class="badge" id="anaCash">‚Çπ0</span></div>
        <div>Largest Inflow: <span class="badge" id="anaLargestIn">‚Çπ0</span></div>
        <div>Largest Outflow: <span class="badge" id="anaLargestOut">‚Çπ0</span></div>
      </div>
      <hr class="sep"/>
      <h3>Top Models / Owners</h3>
      <div class="grid" id="anaTop"></div>
      <hr class="sep"/>
      <div id="anaMonthly" class="grid"></div>
      <div class="dfoot" style="padding:0;margin-top:8px;gap:8px">
        <button class="btn" id="btnDownloadCSV">Download All Data (CSV)</button>
        <button class="btn primary" id="btnDownloadPDF">Download Full Report (PDF)</button>
      </div>
    </div>
  </section>

  <!-- Settings Tab -->
  <section id="tab-settings" class="tabcontent" aria-labelledby="nav-settings">
    <div class="card">
      <h3>Business & Display</h3>
      <div class="grid" style="grid-template-columns:1fr 120px">
        <div><label for="setBiz">Business Name</label><input id="setBiz" type="text" placeholder="e.g., Apex Motors"/></div>
        <div><label for="setCurrency">Currency</label><input id="setCurrency" type="text" value="‚Çπ" maxlength="3"/></div>
      </div>
      <div class="dfoot" style="padding:0;margin-top:8px">
        <button class="btn primary" id="saveAppearance">Save</button>
        <button class="btn" id="btnAdjustSettings">Adjust Cash</button>
      </div>
    </div>

    <div class="card">
      <h3>GitHub Sync</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div><label for="setGist">Gist ID</label><input id="setGist" type="text" placeholder="a1b2c3..."/></div>
        <div><label for="setPAT">Session PAT (gist scope)</label><input id="setPAT" type="password" autocomplete="current-password" placeholder="ghp_... (not saved)"/></div>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn" id="btnValidateGist">Validate</button>
        <button class="btn" id="btnCreateGist">Create Gist</button>
        <button class="btn primary" id="btnSyncNow">Sync Now</button>
      </div>
      <p class="help">
        <strong>PAT is NOT saved</strong>. We keep it only for this session (you can store it in your browser‚Äôs password manager).
      </p>
    </div>

    <div class="card">
      <h3>Data Management</h3>
      <div class="toolbar">
        <button class="btn" id="dmFullPDF">Download Full PDF Report</button>
        <button class="btn" id="dmAllCSV">Download All Data CSV</button>
        <button class="btn" id="dmBikesCSV">Export Bikes CSV</button>
        <button class="btn" id="dmTxCSV">Export Transactions CSV</button>
        <button class="btn" id="dmCapCSV">Export Capital Log CSV</button>
      </div>
      <hr class="sep"/>
      <div class="toolbar">
        <button class="btn danger" id="btnReset">Reset Local Cache</button>
      </div>
      <p class="help callout">Reset only clears local data on this device. To fully remove cloud data, delete the Gist on GitHub.</p>
    </div>

    <div class="card">
      <h3>Help</h3>
      <p class="help">
        <strong>Personal Access Token (PAT)</strong>: Create a token with only the <em>gist</em> scope on GitHub. Paste it here each session to enable syncing with a private Gist holding a single <code class="inline">db.json</code> file. We never talk to any other server.
      </p>
    </div>
  </section>
</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav" role="tablist" aria-label="Primary">
  <button class="tabbtn" id="nav-bikes" data-active="true" aria-selected="true" aria-controls="tab-bikes">
    üèçÔ∏è<span>Bikes</span>
  </button>
  <button class="tabbtn" id="nav-analytics" aria-controls="tab-analytics">
    üìä<span>Analytics</span>
  </button>
  <button class="tabbtn" id="nav-settings" aria-controls="tab-settings">
    ‚öôÔ∏è<span>Settings</span>
  </button>
</nav>

<!-- Dialogs -->
<dialog id="dlgBuy" aria-labelledby="dlgBuyTitle">
  <div class="dhead"><strong id="dlgBuyTitle">Buy Bike</strong><button class="btn" onclick="closeDialog('dlgBuy')" aria-label="Close">‚úï</button></div>
  <form class="dbody" id="buyForm" method="dialog">
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div><label for="buyPlate">Bike No/Plate *</label><input id="buyPlate" required/></div>
      <div><label for="buyModel">Model *</label><input id="buyModel" required/></div>
      <div><label for="buyOwner">Owner Name *</label><input id="buyOwner" required/></div>
      <div><label for="buyPrice">Buying Price *</label><input id="buyPrice" type="number" min="0" required/></div>
      <div><label for="buyDate">Date of Purchase *</label><input id="buyDate" type="date" required/></div>
      <div><label for="buyRepair">Repair Cost</label><input id="buyRepair" type="number" min="0" value="0"/></div>
      <div style="grid-column:1/-1"><label for="buyNotes">Notes</label><textarea id="buyNotes" rows="2" placeholder="Optional notes"></textarea></div>
    </div>
    <p class="small">Total cost is calculated automatically: buying price + repair cost. Capital decreases by total cost.</p>
  </form>
  <div class="dfoot">
    <button class="btn" onclick="closeDialog('dlgBuy')">Cancel</button>
    <button class="btn primary" id="buySubmit">Add</button>
  </div>
</dialog>

<dialog id="dlgAdjust" aria-labelledby="dlgAdjustTitle">
  <div class="dhead"><strong id="dlgAdjustTitle">Manual Capital Adjustment</strong><button class="btn" onclick="closeDialog('dlgAdjust')" aria-label="Close">‚úï</button></div>
  <form class="dbody" id="adjustForm" method="dialog">
    <div class="grid" style="grid-template-columns:1fr 1fr 1fr">
      <div><label for="adjAmount">Amount (+/-) *</label><input id="adjAmount" type="number" required/></div>
      <div><label for="adjReason">Reason *</label><input id="adjReason" required placeholder="Required"/></div>
      <div><label for="adjDate">Date</label><input id="adjDate" type="date"/></div>
    </div>
    <p class="small">This creates a ledger entry. Use for deposits/withdrawals/expenses.</p>
  </form>
  <div class="dfoot">
    <button class="btn" onclick="closeDialog('dlgAdjust')">Cancel</button>
    <button class="btn primary" id="adjustSubmit">Apply</button>
  </div>
</dialog>

<dialog id="dlgFilters" aria-labelledby="dlgFiltersTitle">
  <div class="dhead"><strong id="dlgFiltersTitle">Advanced Filters</strong><button class="btn" onclick="closeDialog('dlgFilters')" aria-label="Close">‚úï</button></div>
  <form class="dbody" id="filterForm" method="dialog">
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div><label for="fFrom">From Date</label><input type="date" id="fFrom"/></div>
      <div><label for="fTo">To Date</label><input type="date" id="fTo"/></div>
      <div><label for="fPriceMin">Min Price</label><input type="number" id="fPriceMin" min="0"/></div>
      <div><label for="fPriceMax">Max Price</label><input type="number" id="fPriceMax" min="0"/></div>
      <div><label for="fProfitMin">Min Profit</label><input type="number" id="fProfitMin"/></div>
      <div><label for="fProfitMax">Max Profit</label><input type="number" id="fProfitMax"/></div>
    </div>
  </form>
  <div class="dfoot">
    <button class="btn" onclick="closeDialog('dlgFilters')">Close</button>
    <button class="btn primary" id="applyFilters">Apply</button>
  </div>
</dialog>

<dialog id="dlgMassSell" aria-labelledby="dlgMassSellTitle">
  <div class="dhead"><strong id="dlgMassSellTitle">Mass Sell</strong><button class="btn" onclick="closeDialog('dlgMassSell')" aria-label="Close">‚úï</button></div>
  <div class="dbody">
    <div class="grid" style="grid-template-columns:1fr 1fr 1fr">
      <div><label for="msDefaultPrice">Default Sell Price</label><input id="msDefaultPrice" type="number" min="0"/></div>
      <div><label for="msDefaultDate">Sell Date</label><input id="msDefaultDate" type="date"/></div>
      <div><label for="msBuyer">Buyer Info</label><input id="msBuyer" placeholder="Optional"/></div>
    </div>
    <hr class="sep"/>
    <div id="msList" class="grid" aria-live="polite"></div>
  </div>
  <div class="dfoot">
    <button class="btn" onclick="closeDialog('dlgMassSell')">Cancel</button>
    <button class="btn primary" id="msSubmit">Sell Selected</button>
  </div>
</dialog>

<dialog id="dlgConfirm" aria-labelledby="dlgConfirmTitle">
  <div class="dhead"><strong id="dlgConfirmTitle">Confirm</strong></div>
  <div class="dbody" id="dlgConfirmBody">Are you sure?</div>
  <div class="dfoot">
    <button class="btn" onclick="closeDialog('dlgConfirm')">Cancel</button>
    <button class="btn danger" id="confirmYes">Yes</button>
  </div>
</dialog>

<dialog id="dlgPAT" aria-labelledby="dlgPATTitle">
  <div class="dhead"><strong id="dlgPATTitle">Enter GitHub PAT (gist scope)</strong></div>
  <form class="dbody" id="patForm" method="dialog" autocomplete="on">
    <label for="patInput">Personal Access Token (not saved)</label>
    <input id="patInput" type="password" name="password" autocomplete="current-password" placeholder="ghp_..." required>
    <p class="small">We keep it only during this session. Your browser can remember it.</p>
  </form>
  <div class="dfoot">
    <button class="btn" onclick="closeDialog('dlgPAT')">Skip</button>
    <button class="btn primary" id="patSubmit">Save for Session</button>
  </div>
</dialog>

<!-- Toast -->
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* =========================================================
   Bike Resell Manager ‚Äî One UI Light Edition
   - Session-only PAT (password manager friendly)
   - Safer DOM (no innerHTML on user fields)
   - "Delete" becomes accounting-safe Write-off
   - Deterministic capital recompute (order-independent)
   - PDF generator fixed (no blank pages)
   - Keyboard shortcuts: / (search), F (filters)
   ========================================================= */

/* ---------- Utilities ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt = (n,curr) => (curr||state.settings.currency||'‚Çπ') + (Number(n||0).toLocaleString('en-IN'));
const todayISODate = () => new Date().toISOString().slice(0,10);
const toISO = (dateStr) => new Date(dateStr).toISOString();
const ym = (d) => new Date(d).toISOString().slice(0,7);
const uuid = (p='id_')=> p + Date.now().toString(36)+ Math.random().toString(36).slice(2,7);

/* ---------- PAT session handling ---------- */
const PAT_KEY = 'brm_session_pat';
const pat = {
  get(){ return sessionStorage.getItem(PAT_KEY)||''; },
  set(token){ if(token){ sessionStorage.setItem(PAT_KEY, token); } },
  clear(){ sessionStorage.removeItem(PAT_KEY); }
};

/* ---------- IndexedDB tiny wrapper ---------- */
const idb = (() => {
  let dbp;
  function open(){
    if(dbp) return dbp;
    dbp = new Promise((res,rej)=>{
      const req = indexedDB.open('bike-resell',5);
      req.onupgradeneeded = e=>{
        const db = req.result;
        if(!db.objectStoreNames.contains('kv')) db.createObjectStore('kv');
        if(!db.objectStoreNames.contains('ops')) db.createObjectStore('ops',{keyPath:'id'});
      };
      req.onsuccess = ()=>res(req.result);
      req.onerror = ()=>rej(req.error);
    });
    return dbp;
  }
  async function get(store,key){
    const db = await open(); return new Promise((res,rej)=>{
      const tx = db.transaction(store,'readonly'); const st=tx.objectStore(store);
      const r = st.get(key); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);
    });
  }
  async function set(store,key,val){
    const db = await open(); return new Promise((res,rej)=>{
      const tx = db.transaction(store,'readwrite'); const st=tx.objectStore(store);
      const r = st.put(val,key); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error);
    });
  }
  async function del(store,key){
    const db = await open(); return new Promise((res,rej)=>{
      const tx = db.transaction(store,'readwrite'); const st=tx.objectStore(store);
      const r = st.delete(key); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error);
    });
  }
  async function allOps(){
    const db = await open(); return new Promise((res,rej)=>{
      const tx = db.transaction('ops','readonly'); const st=tx.objectStore('ops');
      const arr=[]; const c = st.openCursor();
      c.onsuccess = e=>{
        const cur=e.target.result; if(cur){arr.push(cur.value);cur.continue()} else res(arr);
      };
      c.onerror=()=>rej(e.target.error);
    });
  }
  async function putOp(op){
    op.id ||= uuid('op_');
    const db = await open(); return new Promise((res,rej)=>{
      const tx = db.transaction('ops','readwrite'); const st=tx.objectStore('ops');
      const r = st.put(op); r.onsuccess=()=>res(op); r.onerror=()=>rej(r.error);
    });
  }
  async function clearOps(){
    const db = await open(); return new Promise((res,rej)=>{
      const tx = db.transaction('ops','readwrite'); const st=tx.objectStore('ops');
      const r = st.clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error);
    });
  }
  return {get,set,del,allOps,putOp,clearOps};
})();

/* ---------- Default DB ---------- */
function defaultDB(){
  const now = new Date().toISOString();
  return {
    meta:{app:'bike-resell',version:3,createdAt:now,updatedAt:now},
    settings:{businessName:'',currency:'‚Çπ',gistId:''}, // PAT never persisted
    months:{} // keyed YYYY-MM
  };
}

/* ---------- Global state (in-memory) ---------- */
const state = {
  db: null,
  settings: {businessName:'',currency:'‚Çπ',gistId:''},
  filters: {status:'all', search:'', sort:'latest', adv:{}},
  selection: new Set(),
  lastSync: null,
  syncing: false,
  lastUndo: null
};

/* ---------- Toast ---------- */
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.dataset.show="true"; setTimeout(()=>{t.dataset.show="";}, 3000);}

/* ---------- Dialog helpers ---------- */
function openDialog(id){ const d=$("#"+id); if(d){ d.showModal(); d.querySelector('button, [tabindex="0"], input, select, textarea')?.focus();}}
function closeDialog(id){ $("#"+id)?.close();}

/* ---------- DB helpers ---------- */
async function load(){
  let db = await idb.get('kv','db');
  if(!db){ db = defaultDB(); await idb.set('kv','db',db); }
  // Strip legacy PAT if present
  if(db.settings && 'pat' in db.settings){ delete db.settings.pat; await idb.set('kv','db',db); }
  state.db = db;
  state.settings = {...db.settings};
  $("#setBiz").value = state.settings.businessName || '';
  $("#setCurrency").value = state.settings.currency || '‚Çπ';
  $("#setGist").value = state.settings.gistId || '';
  $("#setPAT").value = pat.get() || '';
  state.lastSync = await idb.get('kv','lastSync');
  recomputeBalances(); // ensure balanceAfter fields are consistent
  renderAll();
  if(!pat.get()){ $("#patForm").reset(); openDialog('dlgPAT'); }
}
async function saveDB(){
  state.db.meta.updatedAt = new Date().toISOString();
  await idb.set('kv','db', state.db);
}
async function saveSettings(){
  state.db.settings = {...state.settings};
  await saveDB();
}

/* ---------- Normalized getters ---------- */
function monthEnsure(yyyyMM){
  if(!state.db.months[yyyyMM]){
    state.db.months[yyyyMM] = {bikes:[],transactions:[],capitalLedger:[]};
  }
  return state.db.months[yyyyMM];
}
function getAllMonths(){ return state.db.months || {}; }
function allBikes(){
  const res=[];
  const months = getAllMonths();
  for(const m in months) for(const b of months[m].bikes){ if(!b.deleted) res.push({...b, _month:m});}
  return res;
}
function allTx(){
  const res=[];
  const months = getAllMonths();
  for(const m in months) for(const t of months[m].transactions){ if(!t.deleted) res.push({...t, _month:m});}
  return res;
}
function allCap(){
  const res=[];
  const months = getAllMonths();
  for(const m in months) for(const c of months[m].capitalLedger){ if(!c.deleted) res.push({...c, _month:m});}
  return res;
}

/* ---------- Capital recompute (order-independent) ---------- */
function recomputeBalances(){
  const caps = allCap().slice().sort((a,b)=>new Date(a.date)-new Date(b.date));
  let bal = 0;
  for(const c of caps){
    bal += Number(c.change||0);
    const mm = monthEnsure(c._month);
    const ref = mm.capitalLedger.find(x=>x.id===c.id);
    if(ref){ ref.balanceAfter = bal; }
  }
}
function lastBalance(){
  const caps = allCap().sort((a,b)=>new Date(a.date)-new Date(b.date));
  return caps.reduce((s,c)=>s+Number(c.change||0),0);
}

/* ---------- Data model ops ---------- */
function setBalanceEntry(monthKey, change, type, reason, dateISO){
  const m = monthEnsure(monthKey);
  const cap = {
    id: uuid('cap_'), change: Number(change), balanceAfter: 0,
    type, reason, date: dateISO, updatedAt: new Date().toISOString()
  };
  m.capitalLedger.push(cap);
  return cap;
}
function addTransaction(monthKey, type, bikeId, amount, dateISO, meta={}){
  const m = monthEnsure(monthKey);
  const tx = {id: uuid('txn_'), type, bikeId, amount: Number(amount), date: dateISO, meta, updatedAt: new Date().toISOString()};
  m.transactions.push(tx);
  return tx;
}
function addBike(data){
  const dateISO = toISO(data.purchaseDate);
  const mKey = ym(dateISO);
  const m = monthEnsure(mKey);
  const totalCost = Number(data.purchasePrice||0) + Number(data.repairCost||0);
  const bike = {
    id: uuid('bike_'),
    plateNo: data.plateNo.trim(),
    model: data.model.trim(),
    ownerName: data.ownerName.trim(),
    purchasePrice: Number(data.purchasePrice),
    repairCost: Number(data.repairCost||0),
    totalCost,
    purchaseDate: dateISO,
    sellPrice: null,
    sellDate: null,
    profit: null,
    status: 'available',
    notes: data.notes||'',
    updatedAt: new Date().toISOString()
  };
  m.bikes.push(bike);
  addTransaction(mKey, 'buy', bike.id, totalCost, dateISO, {seller: data.ownerName||''});
  setBalanceEntry(mKey, -totalCost, 'buy', `Bought ${bike.plateNo}`, dateISO);
  recomputeBalances();
  return bike;
}
function sellBike(bikeId, price, buyer, dateISO){
  const bike = allBikes().find(b=>b.id===bikeId);
  if(!bike) throw new Error('Bike not found');
  const bm = monthEnsure(ym(bike.purchaseDate));
  const ref = bm.bikes.find(b=>b.id===bikeId);
  ref.sellPrice = Number(price); ref.sellDate = dateISO;
  ref.profit = Number(price) - Number(ref.totalCost);
  ref.status = 'sold';
  ref.updatedAt = new Date().toISOString();
  addTransaction(ym(dateISO), 'sell', bikeId, Number(price), dateISO, {buyer: buyer||''});
  setBalanceEntry(ym(dateISO), Number(price), 'sell', `Sold ${ref.plateNo}`, dateISO);
  recomputeBalances();
  return ref;
}
/* Accounting-safe write-off (replaces destructive delete) */
function writeOffBikes(ids){
  const months = getAllMonths();
  let total=0, count=0;
  for(const m in months){
    for(const b of months[m].bikes){
      if(ids.has(b.id) && !b.deleted){
        b.deleted = true; b.updatedAt = new Date().toISOString();
        total += Number(b.totalCost||0); count++;
      }
    }
  }
  const dateISO = new Date().toISOString();
  const mKey = ym(dateISO);
  if(total>0){
    addTransaction(mKey,'writeoff', null, 0, dateISO, {count, reason:'Write-off deleted bikes'});
    setBalanceEntry(mKey, +total, 'writeoff_reverse', `Write-off reverse ${count} bikes`, dateISO);
  }
  recomputeBalances();
  return {count,total};
}

/* ---------- Search / Filters / Sort ---------- */
function applyFiltersTo(list){
  const {search, sort, status, adv} = state.filters;
  let out = list;
  if(status!=='all'){ out = out.filter(b=>b.status===status); }
  if(search){ const s=search.toLowerCase();
    out = out.filter(b=>(b.plateNo+' '+b.model+' '+b.ownerName).toLowerCase().includes(s));
  }
  if(adv){
    if(adv.from) out = out.filter(b=>new Date(b.purchaseDate)>=new Date(adv.from));
    if(adv.to) out = out.filter(b=>new Date(b.purchaseDate)<=new Date(adv.to));
    if(adv.priceMin!=null && adv.priceMin!=="") out = out.filter(b=>b.purchasePrice>=Number(adv.priceMin));
    if(adv.priceMax!=null && adv.priceMax!=="") out = out.filter(b=>b.purchasePrice<=Number(adv.priceMax));
    if(adv.profitMin!=null && adv.profitMin!=="") out = out.filter(b=>(b.profit??-Infinity)>=Number(adv.profitMin));
    if(adv.profitMax!=null && adv.profitMax!=="") out = out.filter(b=>(b.profit??Infinity)<=Number(adv.profitMax));
  }
  switch(sort){
    case 'latest': out.sort((a,b)=>new Date(b.purchaseDate)-new Date(a.purchaseDate)); break;
    case 'oldest': out.sort((a,b)=>new Date(a.purchaseDate)-new Date(b.purchaseDate)); break;
    case 'profitDesc': out.sort((a,b)=>(b.profit??-Infinity)-(a.profit??-Infinity)); break;
    case 'profitAsc': out.sort((a,b)=>(a.profit??Infinity)-(b.profit??Infinity)); break;
  }
  return out;
}

/* ---------- Rendering ---------- */
function renderStats(){
  const currency = state.settings.currency||'‚Çπ';
  const cash = lastBalance();
  $("#kpi-cash").textContent = fmt(cash,currency);
  const bikes = allBikes();
  const sold = bikes.filter(b=>b.status==='sold');
  const profit = sold.reduce((s,b)=>s+(b.profit||0),0);
  $("#kpi-profit").textContent = fmt(profit,currency);
  const unsold = bikes.filter(b=>b.status!=='sold');
  const inv = unsold.reduce((s,b)=>s+(b.totalCost||0),0);
  $("#kpi-unsold").textContent = fmt(inv,currency);
  $("#kpi-stock").textContent = unsold.length;
  $("#kpi-sold").textContent = sold.length;
}
function renderList(){
  const list = $("#bikeList"); list.textContent='';
  const bikes = applyFiltersTo(allBikes());
  if(!bikes.length){
    const div=document.createElement('div'); div.className='card'; div.textContent='No bikes match your filters.';
    list.appendChild(div); return;
  }
  for(const b of bikes){
    const row=document.createElement('div'); row.className='item'; row.role='listitem';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.setAttribute('aria-label','Select '+b.plateNo);
    cb.checked = state.selection.has(b.id);
    cb.addEventListener('change',()=>{ if(cb.checked) state.selection.add(b.id); else state.selection.delete(b.id); updateBulkBar();});
    const info=document.createElement('div');
    const title=document.createElement('div'); title.className='title';
    title.textContent = `${b.plateNo} ‚Äî ${b.model}`;
    const meta=document.createElement('div'); meta.className='meta';
    const profitText = (b.status==='sold') ? `Profit: ${fmt(b.profit)}` : `Unrealized: ${fmt((b.sellPrice??0)-(b.totalCost||0))}`;
    meta.textContent = `Owner: ${b.ownerName} ‚Ä¢ Bought: ${new Date(b.purchaseDate).toLocaleDateString()} ‚Ä¢ ${profitText}`;
    info.appendChild(title); info.appendChild(meta);
    const actions=document.createElement('div'); actions.style.display='grid'; actions.style.gap='6px';
    if(b.status!=='sold'){
      const sellBtn=document.createElement('button'); sellBtn.className='btn'; sellBtn.textContent='Sell';
      sellBtn.addEventListener('click',()=>openQuickSell(b));
      actions.appendChild(sellBtn);
    } else {
      const badge=document.createElement('span'); badge.className='badge'; badge.textContent='Sold';
      actions.appendChild(badge);
    }
    row.appendChild(cb); row.appendChild(info); row.appendChild(actions);
    list.appendChild(row);
  }
  updateBulkBar();
}
function renderTopBlocks(){
  const container = $("#anaTop"); container.textContent = '';
  const bikes = allBikes().filter(b=>b.status==='sold');
  const modelProfit = new Map(); const ownerCount = new Map();
  for(const b of bikes){ modelProfit.set(b.model,(modelProfit.get(b.model)||0)+(b.profit||0)); ownerCount.set(b.ownerName,(ownerCount.get(b.ownerName)||0)+1); }
  const topModels = [...modelProfit.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5);
  const topOwners = [...ownerCount.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5);
  const mCard = document.createElement('div'); mCard.className='card';
  mCard.appendChild(Object.assign(document.createElement('strong'),{textContent:'Top Models (by profit)'}));
  const ul1=document.createElement('ul'); ul1.className='small';
  topModels.forEach(([m,p])=>{ const li=document.createElement('li'); li.textContent=`${m}: ${fmt(p)}`; ul1.appendChild(li); });
  if(ul1.children.length===0){ const li=document.createElement('div'); li.textContent='No data'; ul1.appendChild(li); }
  mCard.appendChild(ul1);

  const oCard = document.createElement('div'); oCard.className='card';
  oCard.appendChild(Object.assign(document.createElement('strong'),{textContent:'Top Owners (by sold count)'}));
  const ul2=document.createElement('ul'); ul2.className='small';
  topOwners.forEach(([o,c])=>{ const li=document.createElement('li'); li.textContent=`${o}: ${c}`; ul2.appendChild(li); });
  if(ul2.children.length===0){ const li=document.createElement('div'); li.textContent='No data'; ul2.appendChild(li); }
  oCard.appendChild(ul2);

  container.appendChild(mCard); container.appendChild(oCard);
}
function renderAnalytics(){
  const currency = state.settings.currency||'‚Çπ';
  const from = $("#anaFrom").value? new Date($("#anaFrom").value): null;
  const to = $("#anaTo").value? new Date($("#anaTo").value): null;
  const bikes = allBikes().filter(b=>{
    if(from && new Date(b.purchaseDate) < from) return false;
    if(to && new Date(b.purchaseDate) > to) return false;
    return true;
  });
  const invest = bikes.reduce((s,b)=>s+(b.totalCost||0),0);
  const returns = bikes.filter(b=>b.status==='sold').reduce((s,b)=>s+(b.sellPrice||0),0);
  const net = returns - invest;
  const repair = bikes.reduce((s,b)=>s+(b.repairCost||0),0);
  const sold = bikes.filter(b=>b.status==='sold');
  const avgROI = sold.length ? (sold.reduce((s,b)=>s+((b.profit||0)/(b.totalCost||1)),0)/sold.length*100) : 0;
  const avgDays = sold.length ? Math.round(sold.reduce((s,b)=>s+((new Date(b.sellDate)-new Date(b.purchaseDate))/(1000*60*60*24)),0)/sold.length) : 0;

  $("#anaInvest").textContent = fmt(invest,currency);
  $("#anaReturns").textContent = fmt(returns,currency);
  $("#anaNet").textContent = fmt(net,currency);
  $("#anaRepair").textContent = fmt(repair,currency);
  $("#anaROI").textContent = `${avgROI.toFixed(1)}%`;
  $("#anaDays").textContent = String(avgDays);

  // Cash flow last 30 days
  const now = new Date();
  const past = new Date(now.getTime()-30*24*3600*1000);
  const cap = allCap().filter(c=>new Date(c.date)>=past);
  const inflow = cap.filter(c=>c.change>0).reduce((s,c)=>s+c.change,0);
  const outflow = cap.filter(c=>c.change<0).reduce((s,c)=>s+Math.abs(c.change),0);
  $("#anaInflow").textContent = fmt(inflow,currency);
  $("#anaOutflow").textContent = fmt(outflow,currency);
  $("#anaNetFlow").textContent = fmt(inflow-outflow,currency);
  $("#anaCash").textContent = fmt(lastBalance(),currency);
  $("#anaLargestIn").textContent = fmt(Math.max(0,...cap.filter(c=>c.change>0).map(c=>c.change)),currency);
  $("#anaLargestOut").textContent = fmt(Math.max(0,...cap.filter(c=>c.change<0).map(c=>Math.abs(c.change))),currency);

  renderTopBlocks();

  // Monthly summaries
  const container = $("#anaMonthly"); container.textContent='';
  const grouped = {};
  for(const b of bikes){
    grouped[b._month] ||= {invest:0, returns:0, repair:0, sold:0, bought:0};
    grouped[b._month].invest += (b.totalCost||0);
    grouped[b._month].repair += (b.repairCost||0);
    if(b.status==='sold'){ grouped[b._month].returns += (b.sellPrice||0); grouped[b._month].sold++; }
    grouped[b._month].bought++;
  }
  const months = Object.keys(grouped).sort();
  for(const m of months){
    const g = grouped[m];
    const div=document.createElement('div'); div.className='card';
    const strong=document.createElement('strong'); strong.textContent=m;
    const p=document.createElement('div');
    p.innerText = `Investment: ${fmt(g.invest,currency)} | Returns: ${fmt(g.returns,currency)} | Repair: ${fmt(g.repair,currency)} ‚Ä¢ Bought: ${g.bought} ‚Ä¢ Sold: ${g.sold}`;
    div.appendChild(strong); div.appendChild(p);
    container.appendChild(div);
  }
}

/* ---------- Rendering entry ---------- */
function renderAll(){
  renderStats();
  renderList();
  renderAnalytics();
  updateSyncPill();
}

/* ---------- Quick Sell ---------- */
function openQuickSell(b){
  state.selection = new Set([b.id]); buildMassSellList();
  $("#msDefaultPrice").value = b.totalCost || '';
  $("#msDefaultDate").value = todayISODate();
  $("#msBuyer").value = '';
  openDialog('dlgMassSell');
}

/* ---------- CSV Builders ---------- */
function download(filename, content, mime='text/plain'){
  const a=document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content],{type:mime}));
  a.download = filename; a.click(); URL.revokeObjectURL(a.href);
}
function csvEscape(s){ if(s==null) return ''; s=String(s); return /[",\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s; }
function bikesCSV(rows){
  const cols=['month','id','plateNo','model','ownerName','purchasePrice','repairCost','totalCost','purchaseDate','sellPrice','sellDate','profit','status','notes'];
  const head=cols.join(','); const lines=[head];
  for(const b of rows){ const r=cols.map(k=>csvEscape(k==='month'?b._month:b[k])); lines.push(r.join(',')); }
  return lines.join('\n');
}
function txCSV(rows){
  const cols=['month','id','type','bikeId','amount','date','buyer','seller','reason'];
  const lines=[cols.join(',')];
  for(const t of rows){
    const buyer=t.meta?.buyer||''; const seller=t.meta?.seller||''; const reason=t.meta?.reason||'';
    const arr=[t._month,t.id,t.type,t.bikeId||'',t.amount,t.date,buyer,seller,reason].map(csvEscape);
    lines.push(arr.join(','));
  }
  return lines.join('\n');
}
function capCSV(rows){
  const cols=['month','id','change','balanceAfter','type','reason','date'];
  const lines=[cols.join(',')];
  for(const c of rows){ const arr=[c._month,c.id,c.change,c.balanceAfter,c.type,c.reason,c.date].map(csvEscape); lines.push(arr.join(',')); }
  return lines.join('\n');
}
function allDataCSV(){
  const lines=[];
  lines.push('# Bikes'); lines.push(bikesCSV(allBikes())); lines.push('');
  lines.push('# Transactions'); lines.push(txCSV(allTx())); lines.push('');
  lines.push('# Capital'); lines.push(capCSV(allCap()));
  return lines.join('\n');
}

/* ---------- Minimal PDF (text-only) ‚Äî FIXED ---------- */
/* Generates a clean, non-blank text PDF. Key fixes:
   - Proper /Kids [ ... ] array
   - Use Tm (absolute) for line placement (Td is relative)
   - Reasonable top/bottom margins
*/
function simplePDF(title, sections){
  const objects=[]; const xref=[];
  function addObject(str){ const off = objects.join('').length; xref.push(off); objects.push(str); }
  const header = '%PDF-1.4\n'; const pages=[];
  function escapePdf(s){ return String(s).replace(/([()\\])/g,'\\$1'); }
  function makePage(textLines){
    let content = 'BT\n/F1 12 Tf\n0 g\n';
    let y = 780; // top margin
    for(const line of textLines){
      content += `1 0 0 1 72 ${y} Tm (${escapePdf(line)}) Tj\n`;
      y -= 16;
      if(y<72){ break; }
    }
    content += 'ET\n';
    const stream = content;
    const len = stream.length;
    const n = xref.length+1;
    addObject(`${n} 0 obj\n<< /Length ${len} >>\nstream\n${stream}endstream\nendobj\n`);
    const contentRef = n;
    const m = xref.length+1;
    addObject(`${m} 0 obj\n<< /Type /Page /Parent 1 0 R /MediaBox [0 0 612 792] /Contents ${contentRef} 0 R /Resources << /Font << /F1 << /Type /Font /Subtype /Type1 /BaseFont /Helvetica >> >> >> >> >>\nendobj\n`);
    pages.push(m);
  }
  const lines = [];
  lines.push(title);
  lines.push(new Date().toLocaleString());
  lines.push('');
  for(const s of sections){
    lines.push(`== ${s.heading} ==`);
    for(const l of s.lines){ lines.push(l); }
    lines.push('');
  }
  const chunkSize = 44;
  for(let i=0;i<lines.length;i+=chunkSize){
    makePage(lines.slice(i,i+chunkSize));
  }
  addObject(`1 0 obj\n<< /Type /Pages /Kids [ ${pages.map(p=>p+' 0 R').join(' ')} ] /Count ${pages.length} >>\nendobj\n`);
  addObject(`2 0 obj\n<< /Type /Catalog /Pages 1 0 R >>\nendobj\n`);
  addObject(`3 0 obj\n<< /Producer (BRM) /Title (${escapePdf(title)}) >>\nendobj\n`);
  const xoff = header.length;
  const body = objects.join('');
  const xrefPos = xoff + body.length;
  let xrefTbl = `xref\n0 ${xref.length+1}\n0000000000 65535 f \n`;
  for(const off of xref){ xrefTbl += String(off + xoff).padStart(10,'0') + ' 00000 n \n'; }
  const trailer = `trailer\n<< /Size ${xref.length+1} /Root 2 0 R /Info 3 0 R >>\nstartxref\n${xrefPos}\n%%EOF`;
  return header + body + xrefTbl + trailer;
}
function buildFullReportSections(){
  const currency = state.settings.currency||'‚Çπ';
  const bikes = allBikes();
  const sold = bikes.filter(b=>b.status==='sold');
  const unsold = bikes.filter(b=>b.status!=='sold');
  const invest = bikes.reduce((s,b)=>s+(b.totalCost||0),0);
  const returns = sold.reduce((s,b)=>s+(b.sellPrice||0),0);
  const net = returns - invest;
  const repair = bikes.reduce((s,b)=>s+(b.repairCost||0),0);
  const cash = lastBalance();

  const modelMap = new Map(), ownerMap = new Map();
  for(const b of sold){ modelMap.set(b.model,(modelMap.get(b.model)||0)+ (b.profit||0)); ownerMap.set(b.ownerName,(ownerMap.get(b.ownerName)||0)+1); }
  const topModels = [...modelMap.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(([m,p])=>`${m}: ${fmt(p,currency)}`);
  const topOwners = [...ownerMap.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(([o,c])=>`${o}: ${c}`);
  const best = sold.slice().sort((a,b)=>(b.profit||-1)-(a.profit||-1))[0];
  const worst = sold.slice().sort((a,b)=>(a.profit||Infinity)-(b.profit||Infinity))[0];
  const avgROI = sold.length ? (sold.reduce((s,b)=>s+((b.profit||0)/(b.totalCost||1)),0)/sold.length*100) : 0;
  const avgDays = sold.length ? Math.round(sold.reduce((s,b)=>s+((new Date(b.sellDate)-new Date(b.purchaseDate))/(1000*60*60*24)),0)/sold.length) : 0;

  const grouped = {};
  for(const b of bikes){
    grouped[b._month] ||= {invest:0, returns:0, repair:0, sold:0, bought:0};
    grouped[b._month].invest += (b.totalCost||0);
    grouped[b._month].repair += (b.repairCost||0);
    if(b.status==='sold'){ grouped[b._month].returns += (b.sellPrice||0); grouped[b._month].sold++; }
    grouped[b._month].bought++;
  }
  const linesMonthly = Object.keys(grouped).sort().map(m=>{
    const g=grouped[m];
    return `${m} :: Invest ${fmt(g.invest,currency)} | Returns ${fmt(g.returns,currency)} | Repair ${fmt(g.repair,currency)} | Bought ${g.bought} | Sold ${g.sold}`;
  });

  const soldLines = sold.map(b=> `Plate ${b.plateNo} | ${b.model} | Cost ${fmt(b.totalCost,currency)} | Sold ${fmt(b.sellPrice,currency)} | Profit ${fmt(b.profit,currency)}`);

  return [
    {heading: `${state.settings.businessName||'Bike Resell Manager'} ‚Äî Summary`,
     lines:[
       `Currency: ${state.settings.currency||'‚Çπ'}`,
       `Investment: ${fmt(invest,currency)} | Returns: ${fmt(returns,currency)} | Net: ${fmt(net,currency)}`,
       `Repair Cost Total: ${fmt(repair,currency)} | Current Cash: ${fmt(cash,currency)}`,
       `Avg ROI: ${avgROI.toFixed(1)}% | Avg Days to Sell: ${avgDays}`,
       `Best: ${best?best.plateNo+' ('+fmt(best.profit,currency)+')':'-'} | Worst: ${worst?worst.plateNo+' ('+fmt(worst.profit,currency)+')':'-'}`
     ]},
    {heading:'Top Models (by profit)', lines: topModels.length?topModels:['No data']},
    {heading:'Top Owners (by sold count)', lines: topOwners.length?topOwners:['No data']},
    {heading:'Monthly Summaries', lines: linesMonthly.length?linesMonthly:['No data']},
    {heading:'Sold Bikes', lines: soldLines.length?soldLines:['No sold bikes yet']},
    {heading:'Cash Flow Snapshot (30d)',
     lines: (()=>{
       const now=new Date(), past=new Date(now.getTime()-30*24*3600*1000);
       const cap=allCap().filter(c=>new Date(c.date)>=past);
       const inflow = cap.filter(c=>c.change>0).reduce((s,c)=>s+c.change,0);
       const outflow = cap.filter(c=>c.change<0).reduce((s,c)=>s+Math.abs(c.change),0);
       const largestIn = Math.max(0,...cap.filter(c=>c.change>0).map(c=>c.change));
       const largestOut = Math.max(0,...cap.filter(c=>c.change<0).map(c=>Math.abs(c.change)));
       return [
         `Inflow: ${fmt(inflow)} | Outflow: ${fmt(outflow)} | Net: ${fmt(inflow-outflow)}`,
         `Largest Inflow: ${fmt(largestIn)} | Largest Outflow: ${fmt(largestOut)}`
       ];
     })()
    }
  ];
}

/* ---------- GitHub Gist sync ---------- */
const GH = {
  base: 'https://api.github.com',
  headers(){ const h={'Accept':'application/vnd.github+json'}; const token=pat.get(); if(token) h['Authorization']='token '+token; return h; },
  async validate(){
    if(!state.settings.gistId) throw new Error('No Gist ID');
    const r = await fetch(`${this.base}/gists/${state.settings.gistId}`, {headers:this.headers()});
    if(!r.ok) throw new Error('Gist not accessible ('+r.status+')');
    return await r.json();
  },
  async create(initial){
    const body = {description:'Bike Resell Manager DB', public:false, files:{'db.json':{content: JSON.stringify(initial,null,2)}}};
    const r = await fetch(`${this.base}/gists`, {method:'POST', headers:{...this.headers(),'Content-Type':'application/json'}, body: JSON.stringify(body)});
    if(!r.ok) throw new Error('Create failed ('+r.status+')');
    return await r.json();
  },
  async pull(){
    if(!state.settings.gistId) throw new Error('No Gist ID');
    const r = await fetch(`${this.base}/gists/${state.settings.gistId}`, {headers:this.headers()});
    if(!r.ok) throw new Error('Pull failed ('+r.status+')');
    const j = await r.json();
    const file = j.files?.['db.json'];
    if(!file?.content) throw new Error('db.json missing in Gist');
    return JSON.parse(file.content);
  },
  async push(fullDB){
    if(!state.settings.gistId) throw new Error('No Gist ID');
    const body = { files: { 'db.json': { content: JSON.stringify(fullDB,null,2) } } };
    const r = await fetch(`${this.base}/gists/${state.settings.gistId}`, {method:'PATCH', headers:{...this.headers(),'Content-Type':'application/json'}, body: JSON.stringify(body)});
    if(!r.ok) throw new Error('Push failed ('+r.status+')');
    return await r.json();
  }
};
function updateSyncPill(){
  const pill = $("#syncPill");
  if(state.syncing){ pill.textContent='Syncing‚Ä¶'; pill.dataset.state='syncing'; return; }
  if(!navigator.onLine){ pill.textContent='Offline'; pill.dataset.state='offline'; return; }
  if(state.lastSync){ pill.textContent='Last synced '+ new Date(state.lastSync).toLocaleString(); pill.dataset.state='ok'; }
  else { pill.textContent='Online'; pill.dataset.state='ok'; }
}
async function syncNow({pullFirst=true}={}){
  try{
    state.syncing=true; updateSyncPill();
    if(!state.settings.gistId){ toast('Set Gist ID in Settings and enter your PAT for this session'); return; }
    if(pullFirst){
      const remote = await GH.pull();
      mergeRemote(remote);
    }
    await GH.push(state.db);
    state.lastSync = new Date().toISOString();
    await idb.set('kv','lastSync', state.lastSync);
    toast('Synced successfully');
  }catch(e){
    console.warn(e); toast('Sync error: '+ e.message);
  }finally{
    state.syncing=false; updateSyncPill();
  }
}
/* Merge with deterministic capital recompute and last-write-wins via updatedAt */
function mergeRemote(remote){
  const local = state.db;
  const merged = defaultDB();
  merged.settings = {...local.settings}; // local settings win
  function mergeArray(localArr=[], remoteArr=[], key='id'){
    const map = new Map();
    for(const r of remoteArr){ map.set(r[key], r); }
    for(const l of localArr){
      const r = map.get(l[key]);
      if(!r){ map.set(l[key], l); }
      else {
        const lt = new Date(l.updatedAt||l.sellDate||l.purchaseDate||l.date||0).getTime();
        const rt = new Date(r.updatedAt||r.sellDate||r.purchaseDate||r.date||0).getTime();
        map.set(l[key], lt>=rt? l : r);
      }
    }
    return [...map.values()];
  }
  const months = new Set([...Object.keys(remote.months||{}), ...Object.keys(local.months||{})]);
  for(const m of months){
    const L = local.months[m]||{bikes:[],transactions:[],capitalLedger:[]};
    const R = remote.months[m]||{bikes:[],transactions:[],capitalLedger:[]};
    merged.months[m] = {
      bikes: mergeArray(L.bikes, R.bikes, 'id'),
      transactions: mergeArray(L.transactions, R.transactions, 'id'),
      capitalLedger: mergeArray(L.capitalLedger, R.capitalLedger, 'id')
    };
  }
  merged.meta = { ...local.meta, updatedAt: new Date().toISOString() };
  state.db = merged;
  recomputeBalances();
  saveDB();
  renderAll();
}

/* ---------- Operation queue (lightweight) ---------- */
async function queueAndSave(op){
  await idb.putOp({id: uuid('op_'), ts: Date.now(), op});
  await saveDB();
  triggerBackgroundSync();
}
async function flushOps(){
  const ops = await idb.allOps();
  if(ops.length===0) return;
  try{
    await GH.push(state.db);
    await idb.clearOps();
    state.lastSync = new Date().toISOString();
    await idb.set('kv','lastSync', state.lastSync);
    toast('Background sync complete');
  }catch(e){
    console.warn('Background sync failed', e.message);
  }
}
function triggerBackgroundSync(){
  if(navigator.onLine) flushOps();
}

/* ---------- Event bindings ---------- */
function setupUI(){
  // Tabs
  const tabs=[{btn:'#nav-bikes', tab:'#tab-bikes'},{btn:'#nav-analytics', tab:'#tab-analytics'},{btn:'#nav-settings', tab:'#tab-settings'}];
  tabs.forEach(({btn,tab})=>{
    $(btn).addEventListener('click',()=>{
      tabs.forEach(t=>{ $(t.btn).dataset.active=''; $(t.btn).setAttribute('aria-selected','false'); $(t.tab).dataset.active=''; });
      $(btn).dataset.active='true'; $(btn).setAttribute('aria-selected','true'); $(tab).dataset.active='true';
      if(tab==='#tab-analytics') renderAnalytics();
    });
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if(e.key==='/'){ e.preventDefault(); $("#searchInput").focus(); }
    if(e.key.toLowerCase()==='f'){ e.preventDefault(); openDialog('dlgFilters'); }
    if(e.key==='Escape'){ const open = $$('dialog').find(d=>d.open); if(open) open.close(); }
  });

  // Chips
  $$('.chip').forEach(ch=>{
    ch.addEventListener('click',()=>{
      $$('.chip').forEach(c=>c.setAttribute('aria-pressed','false'));
      ch.setAttribute('aria-pressed','true');
      state.filters.status = ch.dataset.status;
      renderList();
    });
  });

  // Search/sort
  $("#searchInput").addEventListener('input', e=>{ state.filters.search = e.target.value.trim(); renderList(); });
  $("#sortSelect").addEventListener('change', e=>{ state.filters.sort = e.target.value; renderList(); });

  // Filters dialog
  $("#btnFilters").addEventListener('click',()=>{ openDialog('dlgFilters'); });
  $("#applyFilters").addEventListener('click',()=>{
    state.filters.adv = {
      from: $("#fFrom").value || null,
      to: $("#fTo").value || null,
      priceMin: $("#fPriceMin").value || null,
      priceMax: $("#fPriceMax").value || null,
      profitMin: $("#fProfitMin").value || null,
      profitMax: $("#fProfitMax").value || null
    };
    closeDialog('dlgFilters'); renderList();
  });

  // Buy
  $("#btnBuy").addEventListener('click',()=>{ $("#buyForm").reset(); $("#buyDate").value=todayISODate(); openDialog('dlgBuy'); });
  $("#buySubmit").addEventListener('click', async ()=>{
    const plate=$("#buyPlate").value.trim(), model=$("#buyModel").value.trim(), owner=$("#buyOwner").value.trim(),
      price=Number($("#buyPrice").value), date=$("#buyDate").value, repair=Number($("#buyRepair").value||0);
    if(!plate||!model||!owner||!price||!date){ toast('Please fill all required fields'); return; }
    const bike = addBike({plateNo:plate, model, ownerName:owner, purchasePrice:price, repairCost:repair, purchaseDate:date, notes:$("#buyNotes").value});
    await queueAndSave({type:'buy', id: bike.id});
    closeDialog('dlgBuy'); renderAll(); toast('Bike added');
  });

  // Adjust
  const openAdjust = ()=>{ $("#adjustForm").reset(); $("#adjDate").value=todayISODate(); openDialog('dlgAdjust'); };
  $("#btnAdjust").addEventListener('click', openAdjust);
  $("#btnAdjustSettings").addEventListener('click', openAdjust);
  $("#adjustSubmit").addEventListener('click', async ()=>{
    const amount = Number($("#adjAmount").value); const reason = $("#adjReason").value.trim(); const date = $("#adjDate").value || todayISODate();
    if(!reason){ toast('Reason is required'); return; }
    if(!amount || amount===0){ toast('Amount must be non-zero'); return; }
    addTransaction(ym(date),'adjust', null, Number(amount), toISO(date), {reason});
    setBalanceEntry(ym(date), Number(amount), 'manual_adjust', reason, toISO(date));
    recomputeBalances();
    await queueAndSave({type:'adjust', amt: amount});
    closeDialog('dlgAdjust'); renderAll(); toast('Capital adjusted');
  });

  // Bulk actions
  $("#bulkWriteoff").addEventListener('click',()=>{
    const count = state.selection.size;
    if(count===0){ toast('Select bikes to write-off'); return; }
    $("#dlgConfirmBody").textContent = `Write-off ${count} selected bikes? Cash will be restored; bikes archived.`;
    openDialog('dlgConfirm');
    $("#confirmYes").onclick = async ()=>{
      const ids = new Set(state.selection);
      const res = writeOffBikes(ids);
      await queueAndSave({type:'writeoff', ids:[...ids]});
      state.lastUndo = {kind:'writeoff', ids:[...ids]};
      closeDialog('dlgConfirm');
      state.selection.clear();
      renderAll();
      toast(`Written off ${res.count} bikes`);
      showUndoSticky();
    };
  });
  $("#bulkExport").addEventListener('click',()=>{
    const rows = allBikes().filter(b=>state.selection.has(b.id));
    const csv = bikesCSV(rows);
    download('bikes_selected.csv', csv, 'text/csv');
  });
  $("#bulkSell").addEventListener('click',()=>{ buildMassSellList(); $("#msDefaultDate").value=todayISODate(); openDialog('dlgMassSell'); });
  $("#msSubmit").addEventListener('click', async ()=>{
    const defPrice = Number($("#msDefaultPrice").value||0);
    const defDate = $("#msDefaultDate").value? toISO($("#msDefaultDate").value) : new Date().toISOString();
    const buyer = $("#msBuyer").value;
    const rows = $$('#msList .msrow');
    let count=0;
    for(const r of rows){
      const id = r.dataset.id;
      const priceInput = r.querySelector('input[data-field="price"]');
      const dateInput = r.querySelector('input[data-field="date"]');
      const price = Number(priceInput.value || defPrice);
      const dateStr = dateInput.value;
      const dateISO = dateStr ? toISO(dateStr) : defDate;
      if(price>0){ sellBike(id, price, buyer, dateISO); count++; }
    }
    await queueAndSave({type:'mass-sell', n: count});
    closeDialog('dlgMassSell'); state.selection.clear(); renderAll(); toast(`Sold ${count} bikes`);
  });

  // Analytics
  $("#btnApplyAnalytics").addEventListener('click',()=>renderAnalytics());
  $("#btnDownloadCSV").addEventListener('click', async ()=>{ attemptQuickSync(); download('all_data.csv', allDataCSV(), 'text/csv'); });
  $("#btnDownloadPDF").addEventListener('click', async ()=>{
    attemptQuickSync();
    const pdf = simplePDF(`${state.settings.businessName||'Bike Resell Manager'} ‚Äî Full Report`, buildFullReportSections());
    download('full_report.pdf', pdf, 'application/pdf');
  });

  // Settings
  $("#saveAppearance").addEventListener('click', async ()=>{
    state.settings.businessName = $("#setBiz").value.trim();
    state.settings.currency = $("#setCurrency").value.trim() || '‚Çπ';
    await saveSettings(); renderAll(); toast('Saved');
  });
  $("#btnValidateGist").addEventListener('click', async ()=>{
    state.settings.gistId = $("#setGist").value.trim();
    await saveSettings();
    try{ const j = await GH.validate(); toast('Gist OK: '+(j.description||j.id)); }
    catch(e){ toast('Validation failed: '+e.message); }
  });
  $("#btnCreateGist").addEventListener('click', async ()=>{
    try{
      const j = await GH.create(state.db);
      state.settings.gistId = j.id; await saveSettings();
      $("#setGist").value = j.id;
      toast('Gist created');
    }catch(e){ toast('Create failed: '+e.message); }
  });
  $("#btnSyncNow").addEventListener('click', ()=>syncNow({pullFirst:true}));

  // Data management exports
  $("#dmFullPDF").addEventListener('click', ()=>{ const pdf = simplePDF(`${state.settings.businessName||'Bike Resell Manager'} ‚Äî Full Report`, buildFullReportSections()); download('full_report.pdf', pdf, 'application/pdf'); });
  $("#dmAllCSV").addEventListener('click', ()=> download('all_data.csv', allDataCSV(), 'text/csv'));
  $("#dmBikesCSV").addEventListener('click', ()=> download('bikes.csv', bikesCSV(allBikes()), 'text/csv'));
  $("#dmTxCSV").addEventListener('click', ()=> download('transactions.csv', txCSV(allTx()), 'text/csv'));
  $("#dmCapCSV").addEventListener('click', ()=> download('capital.csv', capCSV(allCap()), 'text/csv'));

  $("#btnReset").addEventListener('click', async ()=>{
    $("#dlgConfirmBody").textContent = 'This clears local data/settings on this device. Continue?';
    openDialog('dlgConfirm');
    $("#confirmYes").onclick = async ()=>{
      await idb.del('kv','db'); await idb.del('kv','lastSync'); await idb.clearOps(); pat.clear();
      closeDialog('dlgConfirm'); toast('Local cache cleared'); await load();
    };
  });

  // Session PAT dialog
  $("#patSubmit").addEventListener('click', ()=>{
    const v = $("#patInput").value.trim();
    if(v){ pat.set(v); $("#setPAT").value = v; closeDialog('dlgPAT'); toast('PAT ready for this session'); }
    else { toast('Enter a token or click Skip'); }
  });
  $("#setPAT").addEventListener('change', ()=>{ const v=$("#setPAT").value.trim(); pat.set(v); toast('Session PAT updated'); });

  // Connectivity
  window.addEventListener('online',()=>{ updateSyncPill(); triggerBackgroundSync(); });
  window.addEventListener('offline',()=>{ updateSyncPill(); });
}
function updateBulkBar(){
  const n = state.selection.size;
  $("#bulkBar").dataset.show = n>0 ? "true" : "";
  $("#bulkCount").innerHTML = `<strong>${n}</strong> selected`;
}
function showUndoSticky(){
  const b = $("#undoSticky"); b.classList.remove('hidden');
  setTimeout(()=>b.classList.add('hidden'), 60000);
}
async function doUndo(){
  const undo = state.lastUndo;
  if(!undo) return;
  if(undo.kind==='writeoff'){
    const ids = new Set(undo.ids);
    const months = getAllMonths();
    for(const m in months){
      for(const b of months[m].bikes){ if(ids.has(b.id)){ b.deleted=false; b.updatedAt=new Date().toISOString(); } }
    }
    // remove most recent writeoff_reverse entry
    const all = allCap().sort((a,b)=>new Date(b.date)-new Date(a.date));
    const tgt = all.find(c=>c.type==='writeoff_reverse');
    if(tgt){
      const mm = monthEnsure(tgt._month);
      const ix = mm.capitalLedger.findIndex(x=>x.id===tgt.id);
      if(ix>=0) mm.capitalLedger.splice(ix,1);
    }
    recomputeBalances();
    await saveDB();
    state.lastUndo = null;
    $("#undoSticky").classList.add('hidden');
    renderAll();
    toast('Undo complete');
  }
}
$("#undoSticky").addEventListener('click', doUndo);

/* ---------- Safe DOM builder for Mass Sell (no innerHTML on user data) ---------- */
function buildMassSellList(){
  const list = $("#msList"); list.textContent='';
  const sel = allBikes().filter(b=>state.selection.has(b.id) && b.status!=='sold');
  sel.forEach(b=>{
    const wrap=document.createElement('div'); wrap.className='msrow card'; wrap.dataset.id=b.id;
    const row=document.createElement('div'); row.style.display='flex'; row.style.alignItems='baseline'; row.style.gap='8px';
    const title=document.createElement('strong'); title.textContent=b.plateNo;
    const subtitle=document.createElement('span'); subtitle.className='small'; subtitle.textContent='‚Äî '+b.model;
    row.appendChild(title); row.appendChild(subtitle);
    const grid=document.createElement('div'); grid.className='grid'; grid.style.gridTemplateColumns='1fr 1fr';
    const f1=document.createElement('div'); const l1=document.createElement('label'); l1.textContent='Sell Price'; const i1=document.createElement('input'); i1.type='number'; i1.min='0'; i1.placeholder=String(b.totalCost||''); i1.setAttribute('data-field','price'); f1.appendChild(l1); f1.appendChild(i1);
    const f2=document.createElement('div'); const l2=document.createElement('label'); l2.textContent='Sell Date'; const i2=document.createElement('input'); i2.type='date'; i2.value=todayISODate(); i2.setAttribute('data-field','date'); f2.appendChild(l2); f2.appendChild(i2);
    grid.appendChild(f1); grid.appendChild(f2);
    wrap.appendChild(row); wrap.appendChild(grid);
    list.appendChild(wrap);
  });
}

/* ---------- Quick Sync attempt before exports (non-blocking) ---------- */
async function attemptQuickSync(){
  if(navigator.onLine && state.settings.gistId && pat.get()){
    try{ await syncNow({pullFirst:true}); }catch(e){}
  }
}

/* ---------- Service Worker (Blob) ---------- */
(function registerSW(){
  if(!('serviceWorker' in navigator)) return;
  const swCode = `
    const CACHE='brm-cache-v3';
    const APP_SHELL = ['.'];
    self.addEventListener('install', e=>{
      e.waitUntil((async()=>{ const c=await caches.open(CACHE); await c.addAll(APP_SHELL); })());
      self.skipWaiting();
    });
    self.addEventListener('activate', e=>{
      e.waitUntil((async()=>{
        const keys=await caches.keys();
        await Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)));
      })());
      self.clients.claim();
    });
    self.addEventListener('fetch', e=>{
      const url = new URL(e.request.url);
      if(url.origin===location.origin){
        e.respondWith((async()=>{
          const cached = await caches.match(e.request);
          return cached || fetch(e.request).then(async resp=>{
            const c = await caches.open(CACHE);
            try{ c.put(e.request, resp.clone()); }catch(e){}
            return resp;
          }).catch(()=>cached);
        })());
        return;
      }
      if(url.hostname==='api.github.com'){
        e.respondWith(fetch(e.request).catch(()=>new Response(JSON.stringify({message:'offline'}),{status:503,headers:{'Content-Type':'application/json'}})));
      }
    });
  `;
  const blob = new Blob([swCode], {type:'text/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(blob));
})();

/* ---------- Boot ---------- */
setupUI();
load();
</script>
</body>
</html>
