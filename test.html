<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Bike Resell Manager</title>
<meta name="theme-color" content="#0f172a" />
<!-- Inline Web App Manifest as data URL -->
<link rel="manifest" id="manifest-link" href='data:application/manifest+json,{
  "name":"Bike Resell Manager",
  "short_name":"BRM",
  "start_url":"./",
  "display":"standalone",
  "background_color":"#0f172a",
  "theme_color":"#0f172a",
  "icons":[
    {"src":"data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 128 128%27%3E%3Crect width=%27128%27 height=%27128%27 rx=%2724%27 fill=%27%230f172a%27/%3E%3Cpath fill=%27%23fff%27 d=%27M22 88h12l8-20h34l8 20h12l-9-22c6-4 9-10 9-16 0-12-10-22-22-22H53c-12 0-22 10-22 22 0 6 3 12 9 16l-18 22zm31-30c-7 0-13-6-13-13s6-13 13-13h25c7 0 13 6 13 13s-6 13-13 13H53zM38 100a10 10 0 1 1 0-20 10 10 0 0 1 0 20zm52 0a10 10 0 1 1 0-20 10 10 0 0 1 0 20z%27/%3E%3C/svg%3E","sizes":"128x128","type":"image/svg+xml","purpose":"any maskable"}
  ]
}' />
<style>
:root{
  --bg:#0b1220; --bg-soft:#0f172a; --bg-elev:#111827; --txt:#e5e7eb; --muted:#9ca3af; --brand:#22c55e;
  --danger:#ef4444; --warn:#f59e0b; --ok:#10b981; --card:#0f172a; --stroke:#1f2937; --chip:#1f2937;
  --focus:#60a5fa;
  --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";color:var(--txt);background:linear-gradient(180deg,#0b1220,#0a1020 40%,#0b1220)}
a{color:inherit}
button,input,select,textarea{font:inherit;color:inherit}
header{
  position:sticky;top:0;z-index:5;background:rgba(15,23,42,.9);backdrop-filter: blur(6px);
  border-bottom:1px solid var(--stroke)
}
.container{max-width:1000px;margin:0 auto;padding:0 12px}
.h-row{display:flex;align-items:center;gap:10px;min-height:56px}
h1{font-size:18px;margin:0}
.pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--stroke);background:var(--bg-elev)}
.pill[data-state="offline"]{background:#1f2937;color:#fca5a5;border-color:#374151}
.pill[data-state="syncing"]{background:#1f2937;color:#fde68a;border-color:#374151}
.pill[data-state="ok"]{background:#052e1a;color:#a7f3d0;border-color:#064e3b}
main{padding-bottom:72px}
.grid{display:grid;gap:12px}
.cards{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (min-width:720px){ .cards{grid-template-columns:repeat(4,1fr)} }
.card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);padding:12px}
.card h3{margin:0 0 6px 0;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
.kpi{font-size:18px;font-weight:700}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input[type="text"],input[type="number"],input[type="date"],input[type="datetime-local"],select,textarea{
  width:100%;padding:10px;border-radius:12px;border:1px solid var(--stroke);background:#0b1020
}
input::placeholder{color:#6b7280}
label{display:block;margin:8px 0 4px 0;font-size:12px;color:var(--muted)}
.btn{border:1px solid var(--stroke);background:#0b1020;border-radius:12px;padding:10px 12px;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,#16a34a,#15803d);border:0}
.btn.warn{background:linear-gradient(180deg,#f59e0b,#b45309);border:0}
.btn.ghost{background:transparent}
.btn.danger{background:linear-gradient(180deg,#ef4444,#b91c1c);border:0}
.btn:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{background:var(--chip);border:1px solid var(--stroke);border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
.chip[aria-pressed="true"]{background:#1f2937;outline:2px solid var(--brand)}
.list{display:grid;gap:8px}
.item{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:10px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
.item .meta{font-size:12px;color:var(--muted)}
.item .title{font-weight:700}
.bulkbar{position:sticky;bottom:56px;z-index:4;background:#0b1020;border-top:1px solid var(--stroke);padding:10px;display:none;gap:8px}
.bulkbar[data-show="true"]{display:flex}
.bottom-nav{
  position:fixed;left:0;right:0;bottom:0;z-index:6;background:rgba(15,23,42,.95);
  border-top:1px solid var(--stroke);display:grid;grid-template-columns:repeat(3,1fr)
}
.tabbtn{appearance:none;border:0;background:transparent;padding:8px 4px;font:inherit;color:var(--muted);display:flex;flex-direction:column;align-items:center;gap:4px}
.tabbtn[data-active="true"]{color:#e5e7eb}
.tabcontent{display:none;padding:12px}
.tabcontent[data-active="true"]{display:block}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:90px;background:#111827;border:1px solid var(--stroke);padding:10px 14px;border-radius:12px;display:none;z-index:7}
.toast[data-show="true"]{display:block;animation:fade 3.2s ease}
@keyframes fade{0%{opacity:0;transform:translate(-50%,10px)}10%,90%{opacity:1;transform:translate(-50%,0)}100%{opacity:0;transform:translate(-50%,5px)}}
.badge{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid var(--stroke);background:#0b1020}
hr.sep{border:0;border-top:1px solid var(--stroke);margin:8px 0}
.help{font-size:13px;color:var(--muted)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--stroke);padding:6px;text-align:left}
th{background:#0a1222;color:#cbd5e1}
dialog{border:1px solid var(--stroke);border-radius:14px;background:#0b1020;color:var(--txt);padding:0;max-width:560px;width:calc(100% - 24px)}
dialog::backdrop{background:rgba(0,0,0,.5)}
.dhead{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--stroke)}
.dbody{padding:12px;max-height:65vh;overflow:auto}
.dfoot{padding:12px;border-top:1px solid var(--stroke);display:flex;gap:8px;justify-content:flex-end}
.small{font-size:12px;color:var(--muted)}
code.inline{background:#0b1020;border:1px solid var(--stroke);padding:1px 6px;border-radius:6px}
.hidden{display:none !important}
</style>
</head>
<body>
<header role="banner">
  <div class="container h-row" aria-live="polite">
    <h1 aria-label="App title">Bike Resell Manager</h1>
    <span class="pill" id="syncPill" data-state="offline" title="Sync status">Offline</span>
    <span class="small" id="lastSyncedText" aria-live="polite"></span>
    <span class="small" style="margin-left:auto">Only talks to <code class="inline">api.github.com</code></span>
  </div>
</header>

<main class="container" id="app" role="main">
  <!-- Bikes / Dashboard Tab -->
  <section id="tab-bikes" class="tabcontent" data-active="true" aria-labelledby="nav-bikes">
    <div class="cards" role="region" aria-label="Stats">
      <div class="card" aria-live="polite"><h3>Cash in Hand</h3><div class="kpi" id="kpi-cash">‚Çπ0</div></div>
      <div class="card"><h3>Profit (Sold)</h3><div class="kpi" id="kpi-profit">‚Çπ0</div></div>
      <div class="card"><h3>Unsold Investment</h3><div class="kpi" id="kpi-unsold">‚Çπ0</div></div>
      <div class="card"><h3>Inventory S/U</h3><div class="kpi"><span id="kpi-stock">0</span> / <span id="kpi-sold">0</span></div></div>
    </div>
    <div class="card">
      <div class="toolbar" role="toolbar" aria-label="List actions">
        <label class="hidden" for="searchInput">Search</label>
        <input id="searchInput" type="text" placeholder="Search plate / model / owner" aria-label="Search" />
        <select id="sortSelect" aria-label="Sort">
          <option value="latest">Sort: Latest</option>
          <option value="oldest">Oldest</option>
          <option value="profitDesc">Profit high ‚Üí low</option>
          <option value="profitAsc">Profit low ‚Üí high</option>
        </select>
        <button class="btn" id="btnFilters" aria-haspopup="dialog">Filters</button>
        <button class="btn primary" id="btnBuy">Buy Bike</button>
        <button class="btn" id="btnAdjust">Adjust Cash</button>
      </div>
      <div class="chips" role="tablist" aria-label="Status filter">
        <button class="chip" data-status="all" aria-pressed="true">All</button>
        <button class="chip" data-status="sold" aria-pressed="false">Sold</button>
        <button class="chip" data-status="available" aria-pressed="false">Unsold</button>
      </div>
    </div>

    <div id="bikeList" class="list" role="list" aria-label="Bikes"></div>

    <div class="bulkbar" id="bulkBar" aria-live="polite" aria-label="Bulk actions">
      <span id="bulkCount">0 selected</span>
      <button class="btn primary" id="bulkSell">Mass Sell</button>
      <button class="btn" id="bulkExport">Export CSV</button>
      <button class="btn danger" id="bulkDelete">Delete</button>
    </div>
  </section>

  <!-- Analytics Tab -->
  <section id="tab-analytics" class="tabcontent" aria-labelledby="nav-analytics">
    <div class="card">
      <h3>Filters</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div><label for="anaFrom">From Date</label><input type="date" id="anaFrom"/></div>
        <div><label for="anaTo">To Date</label><input type="date" id="anaTo"/></div>
      </div>
      <div class="dfoot" style="padding:0;margin-top:8px"><button class="btn" id="btnApplyAnalytics">Apply</button></div>
    </div>

    <div class="card">
      <h3>Quick Insights</h3>
      <div class="grid">
        <div>Total Investment: <span class="badge" id="anaInvest">‚Çπ0</span></div>
        <div>Total Returns: <span class="badge" id="anaReturns">‚Çπ0</span></div>
        <div>Net Profit: <span class="badge" id="anaNet">‚Çπ0</span></div>
        <div>Total Repair Cost: <span class="badge" id="anaRepair">‚Çπ0</span></div>
        <div>Average ROI: <span class="badge" id="anaROI">0%</span></div>
        <div>Average Days to Sell: <span class="badge" id="anaDays">0</span></div>
      </div>
      <hr class="sep"/>
      <h3>Cash Flow (Last 30 days)</h3>
      <div class="grid">
        <div>Inflow: <span class="badge" id="anaInflow">‚Çπ0</span></div>
        <div>Outflow: <span class="badge" id="anaOutflow">‚Çπ0</span></div>
        <div>Net: <span class="badge" id="anaNetFlow">‚Çπ0</span></div>
        <div>Current Cash: <span class="badge" id="anaCash">‚Çπ0</span></div>
        <div>Largest Inflow: <span class="badge" id="anaLargestIn">‚Çπ0</span></div>
        <div>Largest Outflow: <span class="badge" id="anaLargestOut">‚Çπ0</span></div>
      </div>
      <hr class="sep"/>
      <div id="anaMonthly" class="grid"></div>
      <div class="dfoot" style="padding:0;margin-top:8px;gap:8px">
        <button class="btn" id="btnDownloadCSV">Download All Data (CSV)</button>
        <button class="btn primary" id="btnDownloadPDF">Download Full Report (PDF)</button>
      </div>
    </div>
  </section>

  <!-- Settings Tab -->
  <section id="tab-settings" class="tabcontent" aria-labelledby="nav-settings">
    <div class="card">
      <h3>Appearance & Finance</h3>
      <div class="grid">
        <div><label for="setBiz">Business Name</label><input id="setBiz" type="text" placeholder="e.g., RoadRunner Bikes"/></div>
        <div><label for="setCurrency">Default Currency</label><input id="setCurrency" type="text" value="‚Çπ" maxlength="3"/></div>
      </div>
      <div class="dfoot" style="padding:0;margin-top:8px">
        <button class="btn" id="saveAppearance">Save</button>
      </div>
    </div>

    <div class="card">
      <h3>GitHub Sync</h3>
      <div class="grid">
        <div><label for="setGist">Gist ID</label><input id="setGist" type="text" placeholder="e.g., a1b2c3d4e5..."/></div>
        <div><label for="setPAT">Personal Access Token (gist scope)</label><input id="setPAT" type="password" autocomplete="off" placeholder="ghp_... (gist only)"/></div>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn" id="btnValidateGist">Validate</button>
        <button class="btn" id="btnCreateGist">Create Gist</button>
        <button class="btn primary" id="btnSyncNow">Sync Now</button>
      </div>
      <p class="help">Your PAT is stored locally on this device. Use <strong>gist</strong>-only scope. You can revoke it anytime from your GitHub settings.</p>
    </div>

    <div class="card">
      <h3>Data Management</h3>
      <div class="toolbar">
        <button class="btn" id="dmFullPDF">Download Full PDF Report</button>
        <button class="btn" id="dmAllCSV">Download All Data CSV</button>
        <button class="btn" id="dmBikesCSV">Export Bikes CSV</button>
        <button class="btn" id="dmTxCSV">Export Transactions CSV</button>
        <button class="btn" id="dmCapCSV">Export Capital Log CSV</button>
      </div>
      <hr class="sep"/>
      <div class="toolbar">
        <button class="btn danger" id="btnReset">Reset Local Cache</button>
      </div>
    </div>

    <div class="card">
      <h3>Help</h3>
      <p class="help">
        <strong>Personal Access Token (PAT):</strong> Create a token with only the <em>gist</em> scope. Paste it above to enable syncing with a single private Gist that holds one <code class="inline">db.json</code> file.
        We never send data anywhere else. To revoke access, delete or regenerate the token on GitHub and/or delete the Gist.
      </p>
    </div>
  </section>
</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav" role="tablist" aria-label="Primary">
  <button class="tabbtn" id="nav-bikes" data-active="true" aria-selected="true" aria-controls="tab-bikes">
    üèçÔ∏è<span>Bikes</span>
  </button>
  <button class="tabbtn" id="nav-analytics" aria-controls="tab-analytics">
    üìä<span>Analytics</span>
  </button>
  <button class="tabbtn" id="nav-settings" aria-controls="tab-settings">
    ‚öôÔ∏è<span>Settings</span>
  </button>
</nav>

<!-- Dialogs -->
<dialog id="dlgBuy" aria-labelledby="dlgBuyTitle">
  <div class="dhead"><strong id="dlgBuyTitle">Buy Bike</strong><button class="btn ghost" onclick="closeDialog('dlgBuy')" aria-label="Close">‚úï</button></div>
  <form class="dbody" id="buyForm" method="dialog">
    <div class="grid">
      <div><label for="buyPlate">Bike No/Plate *</label><input id="buyPlate" required/></div>
      <div><label for="buyModel">Model *</label><input id="buyModel" required/></div>
      <div><label for="buyOwner">Owner Name *</label><input id="buyOwner" required/></div>
      <div><label for="buyPrice">Buying Price *</label><input id="buyPrice" type="number" min="0" required/></div>
      <div><label for="buyDate">Date of Purchase *</label><input id="buyDate" type="date" required/></div>
      <div><label for="buyRepair">Repair Cost</label><input id="buyRepair" type="number" min="0" value="0"/></div>
      <div><label for="buyNotes">Notes</label><textarea id="buyNotes" rows="2" placeholder="Optional notes"></textarea></div>
    </div>
    <p class="small">Total cost is calculated automatically: buying price + repair cost. Capital decreases by total cost on buy.</p>
  </form>
  <div class="dfoot">
    <button class="btn" onclick="closeDialog('dlgBuy')">Cancel</button>
    <button class="btn primary" id="buySubmit">Add</button>
  </div>
</dialog>

<dialog id="dlgAdjust" aria-labelledby="dlgAdjustTitle">
  <div class="dhead"><strong id="dlgAdjustTitle">Manual Capital Adjustment</strong><button class="btn ghost" onclick="closeDialog('dlgAdjust')" aria-label="Close">‚úï</button></div>
  <form class="dbody" id="adjustForm" method="dialog">
    <div class="grid">
      <div><label for="adjAmount">Amount (+/-) *</label><input id="adjAmount" type="number" required/></div>
      <div><label for="adjReason">Reason *</label><input id="adjReason" required placeholder="Required"/></div>
      <div><label for="adjDate">Date</label><input id="adjDate" type="date"/></div>
    </div>
    <p class="small">Reason is mandatory. Adjustment will create a capital ledger entry.</p>
  </form>
  <div class="dfoot">
    <button class="btn" onclick="closeDialog('dlgAdjust')">Cancel</button>
    <button class="btn primary" id="adjustSubmit">Apply</button>
  </div>
</dialog>

<dialog id="dlgFilters" aria-labelledby="dlgFiltersTitle">
  <div class="dhead"><strong id="dlgFiltersTitle">Advanced Filters</strong><button class="btn ghost" onclick="closeDialog('dlgFilters')" aria-label="Close">‚úï</button></div>
  <form class="dbody" id="filterForm" method="dialog">
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div><label for="fFrom">From Date</label><input type="date" id="fFrom"/></div>
      <div><label for="fTo">To Date</label><input type="date" id="fTo"/></div>
      <div><label for="fPriceMin">Min Price</label><input type="number" id="fPriceMin" min="0"/></div>
      <div><label for="fPriceMax">Max Price</label><input type="number" id="fPriceMax" min="0"/></div>
      <div><label for="fProfitMin">Min Profit</label><input type="number" id="fProfitMin"/></div>
      <div><label for="fProfitMax">Max Profit</label><input type="number" id="fProfitMax"/></div>
    </div>
  </form>
  <div class="dfoot">
    <button class="btn" onclick="closeDialog('dlgFilters')">Close</button>
    <button class="btn primary" id="applyFilters">Apply</button>
  </div>
</dialog>

<dialog id="dlgMassSell" aria-labelledby="dlgMassSellTitle">
  <div class="dhead"><strong id="dlgMassSellTitle">Mass Sell</strong><button class="btn ghost" onclick="closeDialog('dlgMassSell')" aria-label="Close">‚úï</button></div>
  <div class="dbody">
    <div class="grid">
      <div><label for="msDefaultPrice">Default Sell Price</label><input id="msDefaultPrice" type="number" min="0"/></div>
      <div><label for="msDefaultDate">Sell Date</label><input id="msDefaultDate" type="date"/></div>
      <div><label for="msBuyer">Buyer Info</label><input id="msBuyer" placeholder="Optional"/></div>
    </div>
    <hr class="sep"/>
    <div id="msList" class="grid"></div>
  </div>
  <div class="dfoot">
    <button class="btn" onclick="closeDialog('dlgMassSell')">Cancel</button>
    <button class="btn primary" id="msSubmit">Sell Selected</button>
  </div>
</dialog>

<dialog id="dlgConfirm" aria-labelledby="dlgConfirmTitle">
  <div class="dhead"><strong id="dlgConfirmTitle">Confirm</strong></div>
  <div class="dbody" id="dlgConfirmBody">Are you sure?</div>
  <div class="dfoot">
    <button class="btn" onclick="closeDialog('dlgConfirm')">Cancel</button>
    <button class="btn danger" id="confirmYes">Yes</button>
  </div>
</dialog>

<!-- Toast -->
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* =========================================================
   Bike Resell Manager ‚Äî Single-file PWA
   - Offline-first IndexedDB with operation queue
   - Single JSON file in a GitHub Gist (db.json)
   - Bikes / Analytics / Settings tabs
   - CSV + minimal PDF exports (text-based)
   - Service Worker via Blob for offline shell
   ========================================================= */

/* ---------- Utilities ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt = (n,curr) => (curr||state.settings.currency||'‚Çπ') + (Number(n||0).toLocaleString('en-IN'));
const todayISODate = () => new Date().toISOString().slice(0,10);
const toISO = (dateStr) => new Date(dateStr).toISOString();
const ym = (d) => new Date(d).toISOString().slice(0,7);
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const uuid = (p='id_')=> p + Date.now().toString(36)+ Math.random().toString(36).slice(2,7);

/* ---------- IndexedDB tiny wrapper ---------- */
const idb = (() => {
  let dbp;
  function open(){
    if(dbp) return dbp;
    dbp = new Promise((res,rej)=>{
      const req = indexedDB.open('bike-resell',3);
      req.onupgradeneeded = e=>{
        const db = req.result;
        if(!db.objectStoreNames.contains('kv')) db.createObjectStore('kv');
        if(!db.objectStoreNames.contains('ops')) db.createObjectStore('ops',{keyPath:'id'});
      };
      req.onsuccess = ()=>res(req.result);
      req.onerror = ()=>rej(req.error);
    });
    return dbp;
  }
  async function get(store,key){
    const db = await open(); return new Promise((res,rej)=>{
      const tx = db.transaction(store,'readonly'); const st=tx.objectStore(store);
      const r = st.get(key); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);
    });
  }
  async function set(store,key,val){
    const db = await open(); return new Promise((res,rej)=>{
      const tx = db.transaction(store,'readwrite'); const st=tx.objectStore(store);
      const r = st.put(val,key); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error);
    });
  }
  async function del(store,key){
    const db = await open(); return new Promise((res,rej)=>{
      const tx = db.transaction(store,'readwrite'); const st=tx.objectStore(store);
      const r = st.delete(key); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error);
    });
  }
  async function allOps(){
    const db = await open(); return new Promise((res,rej)=>{
      const tx = db.transaction('ops','readonly'); const st=tx.objectStore('ops');
      const arr=[]; st.openCursor().onsuccess = e=>{
        const cur=e.target.result; if(cur){arr.push(cur.value);cur.continue()} else res(arr);
      };
      st.openCursor().onerror=()=>rej(e.target.error);
    });
  }
  async function putOp(op){
    op.id ||= uuid('op_');
    const db = await open(); return new Promise((res,rej)=>{
      const tx = db.transaction('ops','readwrite'); const st=tx.objectStore('ops');
      const r = st.put(op); r.onsuccess=()=>res(op); r.onerror=()=>rej(r.error);
    });
  }
  async function clearOps(){
    const db = await open(); return new Promise((res,rej)=>{
      const tx = db.transaction('ops','readwrite'); const st=tx.objectStore('ops');
      const r = st.clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error);
    });
  }
  return {get,set,del,allOps,putOp,clearOps};
})();

/* ---------- Default DB ---------- */
function defaultDB(){
  const now = new Date().toISOString();
  return {
    meta:{app:'bike-resell',version:1,createdAt:now,updatedAt:now},
    settings:{businessName:'',currency:'‚Çπ',gistId:'',pat:''},
    months:{} // keyed YYYY-MM
  };
}

/* ---------- Global state (in-memory) ---------- */
const state = {
  db: null,
  settings: {businessName:'',currency:'‚Çπ',gistId:'',pat:''},
  filters: {status:'all', search:'', sort:'latest', adv:{}},
  selection: new Set(),
  lastSync: null,
  syncing: false,
  conflicts: []
};

/* ---------- Toast ---------- */
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.dataset.show="true"; setTimeout(()=>{t.dataset.show="";}, 3000);}

/* ---------- Dialog helpers ---------- */
function openDialog(id){ const d=$("#"+id); if(d){ d.showModal(); d.querySelector('button, [tabindex="0"], input, select, textarea')?.focus();}}
function closeDialog(id){ $("#"+id)?.close();}

/* ---------- DB helpers ---------- */
async function load(){
  let db = await idb.get('kv','db');
  if(!db){ db = defaultDB(); await idb.set('kv','db',db); }
  state.db = db;
  state.settings = {...db.settings};
  $("#setBiz").value = state.settings.businessName || '';
  $("#setCurrency").value = state.settings.currency || '‚Çπ';
  $("#setGist").value = state.settings.gistId || '';
  $("#setPAT").value = state.settings.pat || '';
  state.lastSync = await idb.get('kv','lastSync');
  renderAll();
}
async function saveDB(){
  state.db.meta.updatedAt = new Date().toISOString();
  await idb.set('kv','db', state.db);
}
async function saveSettings(){
  state.db.settings = {...state.settings};
  await saveDB();
}

/* ---------- Data model ops ---------- */
function monthEnsure(yyyyMM){
  if(!state.db.months[yyyyMM]){
    state.db.months[yyyyMM] = {bikes:[],transactions:[],capitalLedger:[]};
  }
  return state.db.months[yyyyMM];
}
function getAllMonths(){ return state.db.months || {}; }
function allBikes(){
  const res=[];
  const months = getAllMonths();
  for(const m in months) for(const b of months[m].bikes){ if(!b.deleted) res.push({...b, _month:m});}
  return res;
}
function allTx(){
  const res=[];
  const months = getAllMonths();
  for(const m in months) for(const t of months[m].transactions){ if(!t.deleted) res.push({...t, _month:m});}
  return res;
}
function allCap(){
  const res=[];
  const months = getAllMonths();
  for(const m in months) for(const c of months[m].capitalLedger){ if(!c.deleted) res.push({...c, _month:m});}
  return res;
}
function lastBalance(){
  const caps = allCap().sort((a,b)=>new Date(a.date)-new Date(b.date));
  return caps.length ? caps[caps.length-1].balanceAfter : 0;
}
function setBalanceEntry(monthKey, change, type, reason, dateISO){
  const m = monthEnsure(monthKey);
  const prevBal = lastBalance();
  const newBal = prevBal + change;
  const cap = {
    id: uuid('cap_'), change, balanceAfter: newBal,
    type, reason, date: dateISO, updatedAt: new Date().toISOString()
  };
  m.capitalLedger.push(cap);
  return cap;
}
function addTransaction(monthKey, type, bikeId, amount, dateISO, meta={}){
  const m = monthEnsure(monthKey);
  const tx = {id: uuid('txn_'), type, bikeId, amount, date: dateISO, meta, updatedAt: new Date().toISOString()};
  m.transactions.push(tx);
  return tx;
}
function addBike(data){
  const dateISO = toISO(data.purchaseDate);
  const mKey = ym(dateISO);
  const m = monthEnsure(mKey);
  const totalCost = Number(data.purchasePrice||0) + Number(data.repairCost||0);
  const bike = {
    id: uuid('bike_'),
    plateNo: data.plateNo.trim(),
    model: data.model.trim(),
    ownerName: data.ownerName.trim(),
    purchasePrice: Number(data.purchasePrice),
    repairCost: Number(data.repairCost||0),
    totalCost,
    purchaseDate: dateISO,
    sellPrice: null, sellDate: null, profit: null,
    status: 'available', notes: data.notes||'',
    updatedAt: new Date().toISOString()
  };
  m.bikes.push(bike);
  addTransaction(mKey, 'buy', bike.id, totalCost, dateISO, {seller: data.ownerName||''});
  setBalanceEntry(mKey, -totalCost, 'buy', `Bought ${bike.plateNo}`, dateISO);
  return bike;
}
function sellBike(bikeId, price, buyer, dateISO){
  const bike = allBikes().find(b=>b.id===bikeId);
  if(!bike) throw new Error('Bike not found');
  const mKey = ym(bike.purchaseDate);
  const bm = monthEnsure(mKey);
  const ref = bm.bikes.find(b=>b.id===bikeId);
  ref.sellPrice = Number(price); ref.sellDate = dateISO;
  ref.profit = Number(price) - Number(ref.totalCost);
  ref.status = 'sold';
  ref.updatedAt = new Date().toISOString();
  addTransaction(ym(dateISO), 'sell', bikeId, Number(price), dateISO, {buyer: buyer||''});
  setBalanceEntry(ym(dateISO), Number(price), 'sell', `Sold ${ref.plateNo}`, dateISO);
  return ref;
}
function deleteBikes(ids){
  const months = getAllMonths();
  for(const m in months){
    months[m].bikes.forEach(b=>{ if(ids.has(b.id)){ b.deleted = true; b.updatedAt = new Date().toISOString(); }});
    months[m].transactions.forEach(t=>{ if(ids.has(t.bikeId)){ /* keep tx, but allow delete if desired? */ }});
  }
}
function manualAdjust(amount, reason, dateISO){
  const mKey = ym(dateISO);
  addTransaction(mKey,'adjust', null, Number(amount), dateISO, {reason});
  setBalanceEntry(mKey, Number(amount), 'manual_adjust', reason, dateISO);
}

/* ---------- Search / Filters / Sort ---------- */
function applyFiltersTo(list){
  const {search, sort, status, adv} = state.filters;
  let out = list;
  if(status!=='all'){ out = out.filter(b=>b.status===status); }
  if(search){ const s=search.toLowerCase();
    out = out.filter(b=>(b.plateNo+b.model+b.ownerName).toLowerCase().includes(s));
  }
  if(adv){
    if(adv.from) out = out.filter(b=>new Date(b.purchaseDate)>=new Date(adv.from));
    if(adv.to) out = out.filter(b=>new Date(b.purchaseDate)<=new Date(adv.to));
    if(adv.priceMin!=null && adv.priceMin!=="") out = out.filter(b=>b.purchasePrice>=Number(adv.priceMin));
    if(adv.priceMax!=null && adv.priceMax!=="") out = out.filter(b=>b.purchasePrice<=Number(adv.priceMax));
    if(adv.profitMin!=null && adv.profitMin!=="") out = out.filter(b=>(b.profit??-Infinity)>=Number(adv.profitMin));
    if(adv.profitMax!=null && adv.profitMax!=="") out = out.filter(b=>(b.profit??Infinity)<=Number(adv.profitMax));
  }
  switch(sort){
    case 'latest': out.sort((a,b)=>new Date(b.purchaseDate)-new Date(a.purchaseDate)); break;
    case 'oldest': out.sort((a,b)=>new Date(a.purchaseDate)-new Date(b.purchaseDate)); break;
    case 'profitDesc': out.sort((a,b)=>(b.profit??-Infinity)-(a.profit??-Infinity)); break;
    case 'profitAsc': out.sort((a,b)=>(a.profit??Infinity)-(b.profit??Infinity)); break;
  }
  return out;
}

/* ---------- Rendering ---------- */
function renderStats(){
  const currency = state.settings.currency||'‚Çπ';
  const cash = lastBalance();
  $("#kpi-cash").textContent = fmt(cash,currency);
  const bikes = allBikes();
  const sold = bikes.filter(b=>b.status==='sold');
  const profit = sold.reduce((s,b)=>s+(b.profit||0),0);
  $("#kpi-profit").textContent = fmt(profit,currency);
  const unsold = bikes.filter(b=>b.status!=='sold');
  const inv = unsold.reduce((s,b)=>s+(b.totalCost||0),0);
  $("#kpi-unsold").textContent = fmt(inv,currency);
  $("#kpi-stock").textContent = unsold.length;
  $("#kpi-sold").textContent = sold.length;
}
function renderList(){
  const list = $("#bikeList"); list.innerHTML='';
  const bikes = applyFiltersTo(allBikes());
  if(!bikes.length){
    const div=document.createElement('div'); div.className='card'; div.textContent='No bikes match your filters.';
    list.appendChild(div); return;
  }
  for(const b of bikes){
    const row=document.createElement('div'); row.className='item'; row.role='listitem';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.setAttribute('aria-label','Select '+b.plateNo);
    cb.checked = state.selection.has(b.id);
    cb.addEventListener('change',()=>{ if(cb.checked) state.selection.add(b.id); else state.selection.delete(b.id); updateBulkBar();});
    const info=document.createElement('div');
    const title=document.createElement('div'); title.className='title';
    title.textContent = `${b.plateNo} ‚Äî ${b.model}`;
    const meta=document.createElement('div'); meta.className='meta';
    const profitText = (b.status==='sold') ? `Profit: ${fmt(b.profit)}` : `Unrealized: ${fmt((b.sellPrice??0)-(b.totalCost||0))}`;
    meta.textContent = `Owner: ${b.ownerName} ‚Ä¢ Bought: ${new Date(b.purchaseDate).toLocaleDateString()} ‚Ä¢ ${profitText}`;
    info.appendChild(title); info.appendChild(meta);
    const actions=document.createElement('div'); actions.style.display='grid'; actions.style.gap='6px';
    if(b.status!=='sold'){
      const sellBtn=document.createElement('button'); sellBtn.className='btn'; sellBtn.textContent='Sell';
      sellBtn.addEventListener('click',()=>openQuickSell(b));
      actions.appendChild(sellBtn);
    } else {
      const badge=document.createElement('span'); badge.className='badge'; badge.textContent='Sold';
      actions.appendChild(badge);
    }
    row.appendChild(cb); row.appendChild(info); row.appendChild(actions);
    list.appendChild(row);
  }
  updateBulkBar();
}
function updateBulkBar(){
  const n = state.selection.size;
  $("#bulkBar").dataset.show = n>0 ? "true" : "";
  $("#bulkCount").textContent = `${n} selected`;
}
function renderAnalytics(){
  const currency = state.settings.currency||'‚Çπ';
  const from = $("#anaFrom").value? new Date($("#anaFrom").value): null;
  const to = $("#anaTo").value? new Date($("#anaTo").value): null;
  const bikes = allBikes().filter(b=>{
    if(from && new Date(b.purchaseDate) < from) return false;
    if(to && new Date(b.purchaseDate) > to) return false;
    return true;
  });
  const invest = bikes.reduce((s,b)=>s+(b.totalCost||0),0);
  const returns = bikes.filter(b=>b.status==='sold').reduce((s,b)=>s+(b.sellPrice||0),0);
  const net = returns - invest;
  const repair = bikes.reduce((s,b)=>s+(b.repairCost||0),0);
  const sold = bikes.filter(b=>b.status==='sold');
  const avgROI = sold.length ? (sold.reduce((s,b)=>s+((b.profit||0)/(b.totalCost||1)),0)/sold.length*100) : 0;
  const avgDays = sold.length ? Math.round(sold.reduce((s,b)=>s+((new Date(b.sellDate)-new Date(b.purchaseDate))/(1000*60*60*24)),0)/sold.length) : 0;

  $("#anaInvest").textContent = fmt(invest,currency);
  $("#anaReturns").textContent = fmt(returns,currency);
  $("#anaNet").textContent = fmt(net,currency);
  $("#anaRepair").textContent = fmt(repair,currency);
  $("#anaROI").textContent = `${avgROI.toFixed(1)}%`;
  $("#anaDays").textContent = String(avgDays);

  // Cash flow last 30 days
  const now = new Date();
  const past = new Date(now.getTime()-30*24*3600*1000);
  const cap = allCap().filter(c=>new Date(c.date)>=past);
  const inflow = cap.filter(c=>c.change>0).reduce((s,c)=>s+c.change,0);
  const outflow = cap.filter(c=>c.change<0).reduce((s,c)=>s+Math.abs(c.change),0);
  $("#anaInflow").textContent = fmt(inflow,currency);
  $("#anaOutflow").textContent = fmt(outflow,currency);
  $("#anaNetFlow").textContent = fmt(inflow-outflow,currency);
  $("#anaCash").textContent = fmt(lastBalance(),currency);
  $("#anaLargestIn").textContent = fmt(Math.max(0,...cap.filter(c=>c.change>0).map(c=>c.change)),currency);
  $("#anaLargestOut").textContent = fmt(Math.max(0,...cap.filter(c=>c.change<0).map(c=>Math.abs(c.change))),currency);

  // Monthly summaries
  const container = $("#anaMonthly"); container.innerHTML='';
  const grouped = {};
  for(const b of bikes){
    grouped[b._month] ||= {invest:0, returns:0, repair:0, sold:0, bought:0};
    grouped[b._month].invest += (b.totalCost||0);
    grouped[b._month].repair += (b.repairCost||0);
    if(b.status==='sold'){ grouped[b._month].returns += (b.sellPrice||0); grouped[b._month].sold++; }
    grouped[b._month].bought++;
  }
  const months = Object.keys(grouped).sort();
  for(const m of months){
    const g = grouped[m];
    const div=document.createElement('div'); div.className='card';
    div.innerHTML = `<strong>${m}</strong><br/>
      Investment: <span class="badge">${fmt(g.invest,currency)}</span>
      Returns: <span class="badge">${fmt(g.returns,currency)}</span>
      Repair: <span class="badge">${fmt(g.repair,currency)}</span>
      ‚Ä¢ Bought: ${g.bought} ‚Ä¢ Sold: ${g.sold}`;
    container.appendChild(div);
  }
}

/* ---------- Rendering entry ---------- */
function renderAll(){
  renderStats();
  renderList();
  renderAnalytics();
  updateSyncPill();
}

/* ---------- Quick Sell ---------- */
function openQuickSell(b){
  // Reuse Mass Sell dialog for single item
  state.selection = new Set([b.id]); buildMassSellList();
  $("#msDefaultPrice").value = b.totalCost || '';
  $("#msDefaultDate").value = todayISODate();
  $("#msBuyer").value = '';
  openDialog('dlgMassSell');
}

/* ---------- CSV Builders ---------- */
function download(filename, content, mime='text/plain'){
  const a=document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content],{type:mime}));
  a.download = filename; a.click(); URL.revokeObjectURL(a.href);
}
function csvEscape(s){ if(s==null) return ''; s=String(s); return /[",\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s; }
function bikesCSV(rows){
  const cols=['month','id','plateNo','model','ownerName','purchasePrice','repairCost','totalCost','purchaseDate','sellPrice','sellDate','profit','status','notes'];
  const head=cols.join(','); const lines=[head];
  for(const b of rows){ const r=cols.map(k=>csvEscape(k==='month'?b._month:b[k])); lines.push(r.join(',')); }
  return lines.join('\n');
}
function txCSV(rows){
  const cols=['month','id','type','bikeId','amount','date','buyer','seller','reason'];
  const lines=[cols.join(',')];
  for(const t of rows){
    const buyer=t.meta?.buyer||''; const seller=t.meta?.seller||''; const reason=t.meta?.reason||'';
    const arr=[t._month,t.id,t.type,t.bikeId||'',t.amount,t.date,buyer,seller,reason].map(csvEscape);
    lines.push(arr.join(','));
  }
  return lines.join('\n');
}
function capCSV(rows){
  const cols=['month','id','change','balanceAfter','type','reason','date'];
  const lines=[cols.join(',')];
  for(const c of rows){ const arr=[c._month,c.id,c.change,c.balanceAfter,c.type,c.reason,c.date].map(csvEscape); lines.push(arr.join(',')); }
  return lines.join('\n');
}
function allDataCSV(){
  const lines=[];
  lines.push('# Bikes'); lines.push(bikesCSV(allBikes())); lines.push('');
  lines.push('# Transactions'); lines.push(txCSV(allTx())); lines.push('');
  lines.push('# Capital'); lines.push(capCSV(allCap()));
  return lines.join('\n');
}

/* ---------- Minimal PDF (text-only) ---------- */
/* Generates a single or multi-page simple-text PDF. No external libs. */
function simplePDF(title, sections){
  // Very small PDF writer: text only, Helvetica, 12pt, 72dpi. Splits pages at ~54 lines.
  const objects=[];
  const xref=[];
  function addObject(str){ const off = objects.join('').length; xref.push(off); objects.push(str); }
  const header = '%PDF-1.4\n';
  const pages=[]; const pageRefs=[];
  // Build content stream
  function makePage(textLines){
    const content = [];
    content.push('BT\n/F1 12 Tf\n0 g\n');
    let y = 780;
    for(const line of textLines){
      content.push(`72 ${y} Td (${line.replace(/([()\\])/g,'\\$1')}) Tj\n`);
      y -= 14;
      if(y<72){ content.push('ET\n'); break; }
    }
    if(!content[content.length-1].endsWith('ET\n')) content.push('ET\n');
    const stream = content.join('');
    const len = stream.length;
    const n = xref.length+1;
    addObject(`${n} 0 obj\n<< /Length ${len} >>\nstream\n${stream}endstream\nendobj\n`); // content
    const contentRef = n;
    const m = xref.length+1;
    addObject(`${m} 0 obj\n<< /Type /Page /Parent 1 0 R /MediaBox [0 0 612 792] /Contents ${contentRef} 0 R /Resources << /Font << /F1 << /Type /Font /Subtype /Type1 /BaseFont /Helvetica >> >> >> >> >>\nendobj\n`);
    pages.push(m);
    return m;
  }
  // Prepare lines
  const lines = [];
  lines.push(title);
  lines.push(new Date().toLocaleString());
  lines.push(''); // spacer
  for(const s of sections){
    lines.push(`== ${s.heading} ==`);
    for(const l of s.lines){ lines.push(l); }
    lines.push('');
  }
  // Split into pages
  const chunkSize = 52; // rough lines per page
  for(let i=0;i<lines.length;i+=chunkSize){
    makePage(lines.slice(i,i+chunkSize));
  }
  // Pages root
  addObject(`1 0 obj\n<< /Type /Pages /Kids ${pages.map(p=>p+' 0 R').join(' ')} /Count ${pages.length} >>\nendobj\n`);
  // Catalog
  addObject(`2 0 obj\n<< /Type /Catalog /Pages 1 0 R >>\nendobj\n`);
  // Info
  addObject(`3 0 obj\n<< /Producer (BRM) /Title (${title.replace(/([()\\])/g,'\\$1')}) >>\nendobj\n`);
  // XREF
  const xoff = header.length;
  let body = objects.join('');
  const xrefPos = xoff + body.length;
  let xrefTbl = `xref\n0 ${xref.length+1}\n0000000000 65535 f \n`;
  for(const off of xref){ xrefTbl += String(off + xoff).padStart(10,'0') + ' 00000 n \n'; }
  const trailer = `trailer\n<< /Size ${xref.length+1} /Root 2 0 R /Info 3 0 R >>\nstartxref\n${xrefPos}\n%%EOF`;
  return header + body + xrefTbl + trailer;
}
function buildFullReportSections(){
  const currency = state.settings.currency||'‚Çπ';
  const bikes = allBikes();
  const sold = bikes.filter(b=>b.status==='sold');
  const unsold = bikes.filter(b=>b.status!=='sold');
  const invest = bikes.reduce((s,b)=>s+(b.totalCost||0),0);
  const returns = sold.reduce((s,b)=>s+(b.sellPrice||0),0);
  const net = returns - invest;
  const repair = bikes.reduce((s,b)=>s+(b.repairCost||0),0);
  const cash = lastBalance();

  // Top models/owners
  const modelMap = new Map(), ownerMap = new Map();
  for(const b of sold){ modelMap.set(b.model,(modelMap.get(b.model)||0)+ (b.profit||0)); ownerMap.set(b.ownerName,(ownerMap.get(b.ownerName)||0)+1); }
  const topModel=[...modelMap.entries()].sort((a,b)=>b[1]-a[1])[0]?.[0]||'-';
  const topOwner=[...ownerMap.entries()].sort((a,b)=>b[1]-a[1])[0]?.[0]||'-';
  const best = sold.slice().sort((a,b)=>(b.profit||-1)-(a.profit||-1))[0];
  const worst = sold.slice().sort((a,b)=>(a.profit||Infinity)-(b.profit||Infinity))[0];
  const avgROI = sold.length ? (sold.reduce((s,b)=>s+((b.profit||0)/(b.totalCost||1)),0)/sold.length*100) : 0;
  const avgDays = sold.length ? Math.round(sold.reduce((s,b)=>s+((new Date(b.sellDate)-new Date(b.purchaseDate))/(1000*60*60*24)),0)/sold.length) : 0;

  // Monthly summaries
  const grouped = {};
  for(const b of bikes){
    grouped[b._month] ||= {invest:0, returns:0, repair:0, sold:0, bought:0};
    grouped[b._month].invest += (b.totalCost||0);
    grouped[b._month].repair += (b.repairCost||0);
    if(b.status==='sold'){ grouped[b._month].returns += (b.sellPrice||0); grouped[b._month].sold++; }
    grouped[b._month].bought++;
  }
  const linesMonthly = Object.keys(grouped).sort().map(m=>{
    const g=grouped[m];
    return `${m} :: Invest ${fmt(g.invest,currency)} | Returns ${fmt(g.returns,currency)} | Repair ${fmt(g.repair,currency)} | Bought ${g.bought} | Sold ${g.sold}`;
  });

  // Sold table (text lines)
  const soldLines = sold.map(b=> `Plate ${b.plateNo} | ${b.model} | Cost ${fmt(b.totalCost,currency)} | Sold ${fmt(b.sellPrice,currency)} | Profit ${fmt(b.profit,currency)}`);

  return [
    {heading: `${state.settings.businessName||'Bike Resell Manager'} ‚Äî Summary`,
     lines:[
       `Currency: ${state.settings.currency||'‚Çπ'}`,
       `Investment: ${fmt(invest,currency)} | Returns: ${fmt(returns,currency)} | Net: ${fmt(net,currency)}`,
       `Repair Cost Total: ${fmt(repair,currency)} | Current Cash: ${fmt(cash,currency)}`,
       `Avg ROI: ${avgROI.toFixed(1)}% | Avg Days to Sell: ${avgDays}`,
       `Top Model: ${topModel} | Top Owner: ${topOwner}`,
       `Best: ${best?best.plateNo+' ('+fmt(best.profit,currency)+')':'-'} | Worst: ${worst?worst.plateNo+' ('+fmt(worst.profit,currency)+')':'-'}`
     ]},
    {heading:'Monthly Summaries', lines: linesMonthly.length?linesMonthly:['No data']},
    {heading:'Sold Bikes', lines: soldLines.length?soldLines:['No sold bikes yet']},
    {heading:'Cash Flow Snapshot (30d)',
     lines: (()=>{
       const now=new Date(), past=new Date(now.getTime()-30*24*3600*1000);
       const cap=allCap().filter(c=>new Date(c.date)>=past);
       const inflow = cap.filter(c=>c.change>0).reduce((s,c)=>s+c.change,0);
       const outflow = cap.filter(c=>c.change<0).reduce((s,c)=>s+Math.abs(c.change),0);
       const largestIn = Math.max(0,...cap.filter(c=>c.change>0).map(c=>c.change));
       const largestOut = Math.max(0,...cap.filter(c=>c.change<0).map(c=>Math.abs(c.change)));
       return [
         `Inflow: ${fmt(inflow)} | Outflow: ${fmt(outflow)} | Net: ${fmt(inflow-outflow)}`,
         `Largest Inflow: ${fmt(largestIn)} | Largest Outflow: ${fmt(largestOut)}`
       ];
     })()
    }
  ];
}

/* ---------- GitHub Gist sync ---------- */
const GH = {
  base: 'https://api.github.com',
  headers(){ const h={'Accept':'application/vnd.github+json'}; if(state.settings.pat) h['Authorization']='token '+state.settings.pat; return h; },
  async validate(){
    if(!state.settings.gistId) throw new Error('No Gist ID');
    const r = await fetch(`${this.base}/gists/${state.settings.gistId}`, {headers:this.headers()});
    if(!r.ok) throw new Error('Gist not accessible ('+r.status+')');
    const j = await r.json(); return j;
  },
  async create(initial){
    const body = {description:'Bike Resell Manager DB', public:false, files:{'db.json':{content: JSON.stringify(initial,null,2)}}};
    const r = await fetch(`${this.base}/gists`, {method:'POST', headers:{...this.headers(),'Content-Type':'application/json'}, body: JSON.stringify(body)});
    if(!r.ok) throw new Error('Create failed ('+r.status+')');
    const j = await r.json(); return j;
  },
  async pull(){
    if(!state.settings.gistId) throw new Error('No Gist ID');
    const r = await fetch(`${this.base}/gists/${state.settings.gistId}`, {headers:this.headers()});
    if(!r.ok) throw new Error('Pull failed ('+r.status+')');
    const j = await r.json();
    const file = j.files?.['db.json'];
    if(!file?.content) throw new Error('db.json missing in Gist');
    return JSON.parse(file.content);
  },
  async push(fullDB){
    if(!state.settings.gistId) throw new Error('No Gist ID');
    const body = { files: { 'db.json': { content: JSON.stringify(fullDB,null,2) } } };
    const r = await fetch(`${this.base}/gists/${state.settings.gistId}`, {method:'PATCH', headers:{...this.headers(),'Content-Type':'application/json'}, body: JSON.stringify(body)});
    if(!r.ok) throw new Error('Push failed ('+r.status+')');
    return await r.json();
  }
};
function updateSyncPill(){
  const pill = $("#syncPill");
  if(state.syncing){ pill.textContent='Syncing‚Ä¶'; pill.dataset.state='syncing'; return; }
  if(!navigator.onLine){ pill.textContent='Offline'; pill.dataset.state='offline'; return; }
  if(state.lastSync){ pill.textContent='Last synced '+ new Date(state.lastSync).toLocaleString(); pill.dataset.state='ok'; }
  else { pill.textContent='Online'; pill.dataset.state='ok'; }
}
async function syncNow({pullFirst=true}={}){
  try{
    state.syncing=true; updateSyncPill();
    if(!state.settings.gistId){ toast('Set Gist ID & Token in Settings'); return; }
    if(pullFirst){
      // Pull remote and merge
      const remote = await GH.pull();
      mergeRemote(remote);
    }
    await GH.push(state.db);
    state.lastSync = new Date().toISOString();
    await idb.set('kv','lastSync', state.lastSync);
    toast('Synced successfully');
  }catch(e){
    console.warn(e); toast('Sync error: '+ e.message);
  }finally{
    state.syncing=false; updateSyncPill();
  }
}
function mergeRemote(remote){
  // Last-write-wins using updatedAt where present, else date fields.
  const local = state.db;
  const merged = defaultDB();
  merged.settings = {...local.settings}; // Local settings take precedence
  function mergeArray(localArr=[], remoteArr=[], key='id'){
    const map = new Map();
    for(const r of remoteArr){ map.set(r[key], r); }
    for(const l of localArr){ const r = map.get(l[key]); if(!r){ map.set(l[key], l); } else {
      const lt = new Date(l.updatedAt||l.sellDate||l.purchaseDate||l.date||0).getTime();
      const rt = new Date(r.updatedAt||r.sellDate||r.purchaseDate||r.date||0).getTime();
      map.set(l[key], lt>=rt? l : r);
    }}
    return [...map.values()];
  }
  const months = new Set([...Object.keys(remote.months||{}), ...Object.keys(local.months||{})]);
  for(const m of months){
    const L = local.months[m]||{bikes:[],transactions:[],capitalLedger:[]};
    const R = remote.months[m]||{bikes:[],transactions:[],capitalLedger:[]};
    merged.months[m] = {
      bikes: mergeArray(L.bikes, R.bikes, 'id'),
      transactions: mergeArray(L.transactions, R.transactions, 'id'),
      capitalLedger: mergeArray(L.capitalLedger, R.capitalLedger, 'id')
    };
  }
  merged.meta = { ...local.meta, updatedAt: new Date().toISOString() };
  state.db = merged;
  saveDB();
  renderAll();
}

/* ---------- Operation queue (lightweight) ---------- */
async function queueAndSave(op){
  await idb.putOp({id: uuid('op_'), ts: Date.now(), op});
  await saveDB();
  // background "retry" on connectivity
  triggerBackgroundSync();
}
async function flushOps(){
  const ops = await idb.allOps();
  if(ops.length===0) return;
  // We already apply ops to local immediately. Here ensure remote push.
  try{
    await GH.push(state.db);
    await idb.clearOps();
    state.lastSync = new Date().toISOString();
    await idb.set('kv','lastSync', state.lastSync);
    toast('Background sync complete');
  }catch(e){
    console.warn('Background sync failed', e.message);
  }
}
function triggerBackgroundSync(){
  if(navigator.onLine) flushOps();
}

/* ---------- Event bindings ---------- */
function setupUI(){
  // Tabs
  const tabs=[{btn:'#nav-bikes', tab:'#tab-bikes'},{btn:'#nav-analytics', tab:'#tab-analytics'},{btn:'#nav-settings', tab:'#tab-settings'}];
  tabs.forEach(({btn,tab})=>{
    $(btn).addEventListener('click',()=>{
      tabs.forEach(t=>{ $(t.btn).dataset.active=''; $(t.btn).setAttribute('aria-selected','false'); $(t.tab).dataset.active=''; });
      $(btn).dataset.active='true'; $(btn).setAttribute('aria-selected','true'); $(tab).dataset.active='true';
      if(tab==='#tab-analytics') renderAnalytics();
    });
  });

  // Chips
  $$('.chip').forEach(ch=>{
    ch.addEventListener('click',()=>{
      $$('.chip').forEach(c=>c.setAttribute('aria-pressed','false'));
      ch.setAttribute('aria-pressed','true');
      state.filters.status = ch.dataset.status;
      renderList();
    });
  });

  // Search
  $("#searchInput").addEventListener('input', e=>{ state.filters.search = e.target.value.trim(); renderList(); });
  $("#sortSelect").addEventListener('change', e=>{ state.filters.sort = e.target.value; renderList(); });

  // Filters dialog
  $("#btnFilters").addEventListener('click',()=>{ openDialog('dlgFilters'); });
  $("#applyFilters").addEventListener('click',()=>{
    state.filters.adv = {
      from: $("#fFrom").value || null,
      to: $("#fTo").value || null,
      priceMin: $("#fPriceMin").value || null,
      priceMax: $("#fPriceMax").value || null,
      profitMin: $("#fProfitMin").value || null,
      profitMax: $("#fProfitMax").value || null
    };
    closeDialog('dlgFilters'); renderList();
  });

  // Buy
  $("#btnBuy").addEventListener('click',()=>{ $("#buyForm").reset(); $("#buyDate").value=todayISODate(); openDialog('dlgBuy'); });
  $("#buySubmit").addEventListener('click', async ()=>{
    const plate=$("#buyPlate").value.trim(), model=$("#buyModel").value.trim(), owner=$("#buyOwner").value.trim(),
      price=Number($("#buyPrice").value), date=$("#buyDate").value, repair=Number($("#buyRepair").value||0);
    if(!plate||!model||!owner||!price||!date){ toast('Please fill all required fields'); return; }
    const bike = addBike({plateNo:plate, model, ownerName:owner, purchasePrice:price, repairCost:repair, purchaseDate:date, notes:$("#buyNotes").value});
    await queueAndSave({type:'buy', id: bike.id});
    closeDialog('dlgBuy'); renderAll(); toast('Bike added');
  });

  // Adjust
  $("#btnAdjust").addEventListener('click',()=>{ $("#adjustForm").reset(); $("#adjDate").value=todayISODate(); openDialog('dlgAdjust'); });
  $("#adjustSubmit").addEventListener('click', async ()=>{
    const amount = Number($("#adjAmount").value); const reason = $("#adjReason").value.trim(); const date = $("#adjDate").value || todayISODate();
    if(!reason){ toast('Reason is required'); return; }
    if(!amount || amount===0){ toast('Amount must be non-zero'); return; }
    manualAdjust(amount, reason, toISO(date));
    await queueAndSave({type:'adjust', amt: amount});
    closeDialog('dlgAdjust'); renderAll(); toast('Capital adjusted');
  });

  // Bulk actions
  $("#bulkDelete").addEventListener('click',()=>{
    $("#dlgConfirmBody").textContent = `Delete ${state.selection.size} bikes? This can be undone immediately.`;
    openDialog('dlgConfirm');
    $("#confirmYes").onclick = async ()=>{
      const ids = new Set(state.selection);
      deleteBikes(ids);
      await queueAndSave({type:'delete', ids:[...ids]});
      closeDialog('dlgConfirm');
      const undoIds=[...ids];
      renderAll();
      toast('Deleted. Undo?');
      // Provide quick undo via 3s timeout
      const undoTimeout = setTimeout(()=>{},3000);
      $("#toast").onclick = async ()=>{ clearTimeout(undoTimeout);
        // Undo: simply unmark deleted
        const months=getAllMonths(); for(const m in months){ months[m].bikes.forEach(b=>{ if(undoIds.includes(b.id)) b.deleted=false; });}
        await saveDB(); renderAll(); toast('Undo complete');
      };
      state.selection.clear();
    };
  });
  $("#bulkExport").addEventListener('click',()=>{
    const rows = allBikes().filter(b=>state.selection.has(b.id));
    const csv = bikesCSV(rows);
    download('bikes_selected.csv', csv, 'text/csv');
  });
  $("#bulkSell").addEventListener('click',()=>{ buildMassSellList(); $("#msDefaultDate").value=todayISODate(); openDialog('dlgMassSell'); });
  $("#msSubmit").addEventListener('click', async ()=>{
    const defPrice = Number($("#msDefaultPrice").value||0);
    const defDate = $("#msDefaultDate").value? toISO($("#msDefaultDate").value) : new Date().toISOString();
    const buyer = $("#msBuyer").value;
    const rows = $$('#msList .msrow');
    let count=0;
    for(const r of rows){
      const id = r.dataset.id;
      const price = Number(r.querySelector('input[type="number"]').value || defPrice);
      const dateStr = r.querySelector('input[type="date"]').value;
      const dateISO = dateStr ? toISO(dateStr) : defDate;
      if(price>0){ sellBike(id, price, buyer, dateISO); count++; }
    }
    await queueAndSave({type:'mass-sell', n: count});
    closeDialog('dlgMassSell'); state.selection.clear(); renderAll(); toast(`Sold ${count} bikes`);
  });

  // Analytics
  $("#btnApplyAnalytics").addEventListener('click',()=>renderAnalytics());
  $("#btnDownloadCSV").addEventListener('click', async ()=>{ attemptQuickSync(); download('all_data.csv', allDataCSV(), 'text/csv'); });
  $("#btnDownloadPDF").addEventListener('click', async ()=>{
    attemptQuickSync();
    const pdf = simplePDF(`${state.settings.businessName||'Bike Resell Manager'} ‚Äî Full Report`, buildFullReportSections());
    download('full_report.pdf', pdf, 'application/pdf');
  });

  // Settings
  $("#saveAppearance").addEventListener('click', async ()=>{
    state.settings.businessName = $("#setBiz").value.trim();
    state.settings.currency = $("#setCurrency").value.trim() || '‚Çπ';
    await saveSettings(); renderAll(); toast('Saved');
  });
  $("#btnValidateGist").addEventListener('click', async ()=>{
    state.settings.gistId = $("#setGist").value.trim();
    state.settings.pat = $("#setPAT").value.trim();
    await saveSettings();
    try{ const j = await GH.validate(); toast('Gist OK: '+(j.description||j.id)); }
    catch(e){ toast('Validation failed: '+e.message); }
  });
  $("#btnCreateGist").addEventListener('click', async ()=>{
    state.settings.pat = $("#setPAT").value.trim();
    await saveSettings();
    try{
      const j = await GH.create(state.db);
      state.settings.gistId = j.id; await saveSettings();
      $("#setGist").value = j.id;
      toast('Gist created');
    }catch(e){ toast('Create failed: '+e.message); }
  });
  $("#btnSyncNow").addEventListener('click', ()=>syncNow({pullFirst:true}));

  // Data management exports
  $("#dmFullPDF").addEventListener('click', ()=>{ const pdf = simplePDF(`${state.settings.businessName||'Bike Resell Manager'} ‚Äî Full Report`, buildFullReportSections()); download('full_report.pdf', pdf, 'application/pdf'); });
  $("#dmAllCSV").addEventListener('click', ()=> download('all_data.csv', allDataCSV(), 'text/csv'));
  $("#dmBikesCSV").addEventListener('click', ()=> download('bikes.csv', bikesCSV(allBikes()), 'text/csv'));
  $("#dmTxCSV").addEventListener('click', ()=> download('transactions.csv', txCSV(allTx()), 'text/csv'));
  $("#dmCapCSV").addEventListener('click', ()=> download('capital.csv', capCSV(allCap()), 'text/csv'));

  $("#btnReset").addEventListener('click', async ()=>{
    $("#dlgConfirmBody").textContent = 'This will clear all local cache and settings. You will need to re-sync from Gist or start fresh. Continue?';
    openDialog('dlgConfirm');
    $("#confirmYes").onclick = async ()=>{
      await idb.del('kv','db'); await idb.del('kv','lastSync'); await idb.clearOps();
      closeDialog('dlgConfirm'); toast('Local cache cleared'); await load();
    };
  });

  // Connectivity
  window.addEventListener('online',()=>{ updateSyncPill(); triggerBackgroundSync(); });
  window.addEventListener('offline',()=>{ updateSyncPill(); });

  // Keyboard: ESC closes topmost dialog
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ const open = $$('dialog').find(d=>d.open); if(open) open.close(); }});
}
function buildMassSellList(){
  const list = $("#msList"); list.innerHTML='';
  for(const b of allBikes().filter(b=>state.selection.has(b.id) && b.status!=='sold')){
    const div=document.createElement('div'); div.className='msrow card'; div.dataset.id=b.id;
    div.innerHTML = `<strong>${b.plateNo}</strong> ‚Äî ${b.model}<br/>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div><label>Sell Price</label><input type="number" min="0" placeholder="${b.totalCost}"/></div>
        <div><label>Sell Date</label><input type="date" value="${todayISODate()}"/></div>
      </div>`;
    list.appendChild(div);
  }
}

/* ---------- Quick Sync attempt before exports (non-blocking) ---------- */
async function attemptQuickSync(){
  if(navigator.onLine && state.settings.gistId && state.settings.pat){
    try{ await syncNow({pullFirst:true}); }catch(e){}
  }
}

/* ---------- Service Worker (Blob) ---------- */
(function registerSW(){
  if(!('serviceWorker' in navigator)) return;
  const swCode = `
    const CACHE='brm-cache-v1';
    const APP_SHELL = ['.'];
    self.addEventListener('install', e=>{
      e.waitUntil((async()=>{ const c=await caches.open(CACHE); await c.addAll(APP_SHELL); })());
      self.skipWaiting();
    });
    self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
    self.addEventListener('fetch', e=>{
      const url = new URL(e.request.url);
      if(url.origin===location.origin){
        e.respondWith((async()=>{
          const cached = await caches.match(e.request);
          return cached || fetch(e.request).then(async resp=>{
            const c = await caches.open(CACHE);
            try{ c.put(e.request, resp.clone()); }catch(e){}
            return resp;
          }).catch(()=>cached);
        })());
        return;
      }
      // Network-first for GitHub API with fallback
      if(url.hostname==='api.github.com'){
        e.respondWith(fetch(e.request).catch(()=>new Response(JSON.stringify({message:'offline'}),{status:503,headers:{'Content-Type':'application/json'}})));
      }
    });
  `;
  const blob = new Blob([swCode], {type:'text/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(blob));
})();

/* ---------- Accessibility tweaks ---------- */
document.addEventListener('focusin', (e)=>{ if(e.target.matches('input,select,textarea,button')) e.target.classList.add('focus'); });
document.addEventListener('focusout', (e)=>{ if(e.target.matches('input,select,textarea,button')) e.target.classList.remove('focus'); });

/* ---------- Boot ---------- */
setupUI();
load();
</script>
</body>
</html>
