<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Resell Manager</title>
    <!-- 
      This is a single-file, offline-first, PWA for Bike Resell Management.
      It uses vanilla JavaScript, IndexedDB for local storage, and syncs
      to a single GitHub Gist JSON file.
      All HTML, CSS, and JS are in this file.
    -->

    <!-- Inlined minified jsPDF (v2.5.1) -->
    <!-- This is required for PDF export functionality -->
    <script>
        !function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):"undefined"!=typeof globalThis?globalThis.jspdf=e():(t=t||self).jspdf=e()}(this,(function(){"use strict";
        function t(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function e(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?t(Object(r),!0).forEach((function(t){i(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):t(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function n(t){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function i(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&u(t,e)}function c(t){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function u(t,e){return(u=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function s(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function l(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?s(t):e}function f(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=c(t);if(e){var o=c(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return l(this,n)}}function h(t,e){return(h=t.split(e).filter((function(t){return t}))).length?"."===h[0]?h.slice(1):h:[]}function d(t,e,n){return t.call(n,e)}function p(t,e,n){return"string"==typeof e&&(e=h(e,n)),e.reduce(d,t)}function g(t){return Array.isArray(t)?[].concat(t):Array.from(t)}function m(t){return"object"===n(t)&&null!==t}var v=function(t){return t.replace(/\\s/g," ").trim()};function y(t,e){return t.reduce((function(t,n){return t+e(n)}),"")}function b(t){var e={};return t.forEach((function(t){Object.keys(t).forEach((function(n){e[n]=t[n]}))})),e}function w(t){return("0"+(Number(t).toString(16))).slice(-2)}function k(t,e){void 0===e&&(e=void 0),e=e||"black";var n=e,r=!1;if(Array.isArray(t))n=t[0],r="object"===n(t[0]);else{var o;/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)$/.exec(t);(o=new RegExp("^rgba?\\((.+)\\)$").exec(t))?t=(o=o[1].split(",").map((function(t){return parseInt(t,10)})))[3]<=1?["","","",""]:[t[0],t[1],t[2],t[3]]:t.startsWith("#")&&(t=t.slice(1)),n={w:1,W:1,k:1,K:1,g:1,G:1}[t.charAt(0)]?{w:[1,1,1],W:[1,1,1],k:[0,0,0],K:[0,0,0],g:[.5,.5,.5],G:[.5,.5,.5]}[t.charAt(0)]:{1:[1,1,1],0:[0,0,0]}[t.length]||{3:[t[0]+t[0],t[1]+t[1],t[2]+t[2]].map(w),6:[t.slice(0,2),t.slice(2,4),t.slice(4,6)].map(w)}[t.length]||!1}return[n,"i"==t||r?"i":{true:1,"1":1}[n.K]?"k":"w",n]}function x(t){return[t.r,t.g,t.b]}function C(t){return"string"==typeof t&&A.hasOwnProperty(t)?A[t]:"number"==typeof t?t:void 0}var A={black:[0,0,0],white:[1,1,1],red:[1,0,0],green:[0,1,0],blue:[0,0,1],cyan:[0,1,1],magenta:[1,0,1],yellow:[1,1,0],gray:[.5,.5,.5]};function S(t){return/^(-)?([\d]*\.[\d]+|[\d]+)$/.test(t)}function N(t){var e=t.match(/[rR][gG][bB]([aA])?\(([\d]{1,3}),([\d]{1,3}),([\d]{1,3})(,([\d\.]+))?\)/);if(null!==e)return e[2]=parseInt(e[2]),e[3]=parseInt(e[3]),e[4]=parseInt(e[4]),e[6]&&(e[6]=parseFloat(e[6])),e}function F(t){return"string"==typeof t&&t.startsWith("#")&&(t=t.substring(1)),3===t.length?t.split("").map((function(t){return t+t})):6!==t.length?null:[t.substring(0,2),t.substring(2,4),t.substring(4,6)]}function E(t){return(Array.isArray(t)?t:[t.r,t.g,t.b]).map((function(t){return t>255?255:t<0?0:Math.round(t)}))}function P(t){return E(t).map((function(t){return t.toString(16).padStart(2,"0")})).join("")}var L=function(t){return"#"===t.charAt(0)?t.substring(1):t};function j(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),"number"==typeof t&&(t=t.toString()),"number"==typeof e&&(e=e.toString()),t=t.split("."),e=e.split("."),t[0]===e[0]?(t[1]||"0").localeCompare(e[1]||"0",void 0,{numeric:!0}):(t[0]||"0").localeCompare(e[0]||"0",void 0,{numeric:!0})}function O(t,e){var n=t[0],r=t[1],o=t[2],i=e[0],a=e[1],c=e[2];return(n*i+r*a+o*c)/Math.sqrt(n*n+r*r+o*o)/Math.sqrt(i*i+a*a+c*c)}function M(t,e,n){return Math.min(n,Math.max(e,t))}function I(t){var e={};return Object.keys(t).forEach((function(n){e[n]=t[n]})),e}function R(t,e){return(t=I(t)).width=e,t.style&&(t.style.width=e,t.style.minWidth=e,t.style.maxWidth=e),t}function B(t,e){return(t=I(t)).height=e,t.style&&(t.style.height=e,t.style.minHeight=e,t.style.maxHeight=e),t}function D(t,e){if(t&&e){var n=t.cells;Object.keys(n).forEach((function(t){Object.keys(n[t]).forEach((function(r){var o=n[t][r];e.apply(this,[o])}))}))}}function T(t,e){return(t=I(t)).valign=e,t.style&&(t.style.verticalAlign=e),t}function q(t,e,n){return(t=I(t)).halign=e,t.style&&(t.style.textAlign=e,"right"===e?t.style.paddingLeft=n:t.style.paddingRight=n),t}var U={auto:0,avoid:1,always:2,left:3,right:4};function H(t){return-1!==Object.keys(U).indexOf(t)}var z=[19.05,25.4];function W(t){var n;switch(t){case"pt":n=1;break;case"mm":n=72/z[1];break;case"cm":n=72/z[0];break;case"in":n=7Z[1];break;case"px":n=96/72;break;case"pc":n=12;break;case"em":n=12;break;case"ex":n=6;break;default:throw new Error("Invalid unit "+t)}return n}var V=function(t,e,n,r){return t/e*(n-r)};function G(t,e){var n={font:"helvetica",fontStyle:"normal",fontSize:12,fillColor:20,textColor:200,lineColor:0,lineWidth:.1,lineHeightFactor:1.15,cellPadding:1,minCellHeight:0,minCellWidth:0,pageBreak:"auto"};return Object.keys(n).forEach((function(r){n[r]=p(t,["window",e,r],n[r]),n[r]=p(t,["document",e,r],n[r]),n[r]=p(t,["parent",e,r],n[r]),n[r]=p(t,[e,r],n[r])})),Object.keys(n).forEach((function(r){var o=r.match(/^(\w+)(Color)$/);if(o){var i=n[r];n[o[1]]=C(i),n[o[2]]=i}})),Object.keys(n).forEach((function(t){n[t]=V(n[t],W("pt"),r,0)})),n}var K=function(){function t(e,n){r(this,t),this.rows=e,this.columns=n,this.spans=[],this.styles={}}return o(t,[{key:"get",value:function(t,e){for(var n=this.spans.filter((function(n){return n.isWithin(t,e)})),r=n.filter((function(t){return t.isMain(t,e)})),o=0;o<n.length;o+=1)if(!0===n[o].isMain(t,e))return n[o];return r.length>0?r[0]:n.length>0?n[0]:void 0}},{key:"map",value:function(t){for(var e=[],n=0;n<this.rows;n+=1)for(var r=0;r<this.columns;r+=1){var o=this.get(n,r);o?e.push(t(o)):e.push(t(this.get(n,r)))}return e}},{key:"mapCells",value:function(t){for(var e=[],n=0;nANALYTICS_TAB",
            content: renderAnalyticsTab()
        },
        {
            id: "SETTINGS_TAB",
            content: renderSettingsTab()
        }
    ];

    tabs.forEach(tab => {
        const tabEl = document.createElement('div');
        tabEl.id = tab.id;
        tabEl.className = 'tab-content';
        if (tab.id !== activeTab) {
            tabEl.classList.add('hidden');
        }
        tabEl.innerHTML = tab.content;
        $main.appendChild(tabEl);
    });
}

function renderDashboardTab() {
    const analytics = calculateAnalytics(appState.data);
    const { currency } = appState.settings;
    const {
        currentCash,
        totalProfit,
        totalUnsoldInvestment,
        inventoryCount
    } = analytics;

    const filteredBikes = getFilteredBikes();

    // Determine which bulk actions are visible
    const selectedBikes = getSelectedBikes();
    const bulkActionVisibility = selectedBikes.length > 0 ? '' : 'hidden';
    const canBulkSell = selectedBikes.length > 0 && selectedBikes.every(b => b.status === 'available');

    return `
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Cash in Hand</h3>
                <p>${formatCurrency(currentCash, currency)}</p>
            </div>
            <div class="stat-card">
                <h3>Profit (Sold)</h3>
                <p>${formatCurrency(totalProfit, currency)}</p>
            </div>
            <div class="stat-card">
                <h3>Unsold Investment</h3>
                <p>${formatCurrency(totalUnsoldInvestment, currency)}</p>
            </div>
            <div class="stat-card">
                <h3>Inventory (S/U)</h3>
                <p>${inventoryCount.sold} / ${inventoryCount.available}</p>
            </div>
        </div>

        <div class="quick-actions">
            <button class="btn btn-primary" data-action="show-buy-form">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                Buy Bike
            </button>
            <button class="btn" data-action="show-adjust-capital-form">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v2.5h-2.5a.75.75 0 000 1.5h2.5v2.5a.75.75 0 001.5 0v-2.5h2.5a.75.75 0 000-1.5h-2.5v-2.5z" clip-rule="evenodd" /></svg>
                Adjust Cash
            </button>
        </div>

        <div class="filter-controls">
            <div class="search-bar">
                <input type="search" id="search-input" placeholder="Search Plate, Model, Owner...">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
            </div>
            <div class="filter-chips">
                <button class="chip" data-filter="status" data-value="all">All</button>
                <button class="chip" data-filter="status" data-value="available">Unsold</button>
                <button class="chip" data-filter="status" data-value="sold">Sold</button>
            </div>
            <div class="sort-controls">
                <select id="sort-select">
                    <option value="purchaseDate-desc">Date: Newest First</option>
                    <option value="purchaseDate-asc">Date: Oldest First</option>
                    <option value="profit-desc">Profit: High to Low</option>
                    <option value="totalCost-desc">Cost: High to Low</option>
                </select>
                <button class="btn-icon" data-action="show-advanced-filters">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2.628 1.601C5.028 1.206 7.49 1 10 1s4.973.206 7.372.601a.75.75 0 01.628.74v2.288a2.25 2.25 0 01-.659 1.59l-4.682 4.683a2.25 2.25 0 00-.659 1.59v3.033a.75.75 0 01-1.12.673l-2.75-1.375a.75.75 0 01-.38-.673v-3.033a2.25 2.25 0 00-.659-1.59L3.256 6.22a2.25 2.25 0 01-.659-1.59V2.34a.75.75 0 01.628-.74z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        </div>

        <div id="bulk-action-bar" class="${bulkActionVisibility}">
            <p><span id="selection-count">${selectedBikes.length}</span> selected</p>
            <div>
                <button class="btn" data-action="show-bulk-sell-form" ${!canBulkSell ? 'disabled' : ''}>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.125 5.5A.375.375 0 013.5 5h13a.375.375 0 01.375.375v9A.375.375 0 0116.5 15h-13a.375.375 0 01-.375-.375v-9zM4.25 6.25v7.5h11.5v-7.5H4.25z" /><path d="M10 9a.75.75 0 01.75.75v2.5a.75.75 0 01-1.5 0v-2.5A.75.75 0 0110 9zM12.25 10.75a.75.75 0 000 1.5h2.5a.75.75 0 000-1.5h-2.5zM5.25 10.75a.75.75 0 000 1.5h2.5a.75.75 0 000-1.5h-2.5z" /></svg>
                    Sell
                </button>
                <button class="btn" data-action="bulk-export-csv">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3a1 1 0 00-1 1v4a1 1 0 00.82.978l4 1a1 1 0 10-.36 1.956L10 9.571V15a1 1 0 102 0V9.429l3.48 1.392a1 1 0 10.36-1.956l-4-1A1 1 0 0010 7V4a1 1 0 00-1-1z" /></svg>
                Export CSV
                </button>
                <button class="btn btn-danger" data-action="bulk-delete-bikes">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.67.042 2.48.091V3.75a1.25 1.25 0 10-2.5 0V4.09c.81-.049 1.64-.09 2.48-.09zM8.25 6.5a.75.75 0 01.75.75v7.5a.75.75 0 01-1.5 0v-7.5a.75.75 0 01.75-.75zm3.5 0a.75.75 0 01.75.75v7.5a.75.75 0 01-1.5 0v-7.5a.75.75 0 01.75-.75z" clip-rule="evenodd" /></svg>
                    Delete
                </button>
            </div>
        </div>

        <div id="bike-list" class="bike-list">
            ${filteredBikes.length === 0 ? '<p class="empty-state">No bikes found. Add one to get started!</p>' : filteredBikes.map(bike => renderBikeCard(bike, currency)).join('')}
        </div>
    `;
}

function renderBikeCard(bike, currency) {
    const isSold = bike.status === 'sold';
    const profit = isSold ? (bike.profit || 0) : (bike.sellPrice ? (bike.sellPrice - bike.totalCost) : null);
    const profitClass = profit === null ? '' : (profit > 0 ? 'profit-positive' : 'profit-negative');
    const profitText = profit === null ? `Est. ${formatCurrency(0, currency)}` : `${formatCurrency(profit, currency)}`;

    return `
        <div class="bike-card ${isSold ? 'sold' : ''}" data-bike-id="${bike.id}">
            <div class="bike-card-selection">
                <input type="checkbox" class="bike-select-checkbox" data-bike-id="${bike.id}">
            </div>
            <div class="bike-card-details">
                <div class="bike-card-header">
                    <span class="plate-no">${bike.plateNo}</span>
                    <span class="status status-${bike.status}">${bike.status}</span>
                </div>
                <p class="model">${bike.model}</p>
                <p class="owner">Owner: ${bike.ownerName}</p>
                <div class="bike-card-footer">
                    <span class="cost">Cost: ${formatCurrency(bike.totalCost, currency)}</span>
                    <span class="profit ${profitClass}">Profit: ${profitText}</span>
                </div>
            </div>
            <div class="bike-card-actions">
                ${!isSold ? `<button class="btn btn-small" data-action="show-sell-form" data-bike-id="${bike.id}">Sell</button>` : ''}
                <button class="btn-icon" data-action="show-edit-bike-form" data-bike-id="${bike.id}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                </button>
            </div>
        </div>
    `;
}

function renderAnalyticsTab() {
    const analytics = calculateAnalytics(appState.data);
    const { currency } = appState.settings;

    return `
        <h2>Analytics</h2>
        <div class="analytics-section">
            <h3>Quick Insights</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Investment (Sold)</h3>
                    <p>${formatCurrency(analytics.totalCostOfSoldBikes, currency)}</p>
                </div>
                <div class="stat-card">
                    <h3>Total Returns</h3>
                    <p>${formatCurrency(analytics.totalReturns, currency)}</p>
                </div>
                <div class="stat-card">
                    <h3>Net Profit/Loss</h3>
                    <p class="${analytics.totalProfit >= 0 ? 'profit-positive' : 'profit-negative'}">${formatCurrency(analytics.totalProfit, currency)}</p>
                </div>
                <div class="stat-card">
                    <h3>Total Repair Cost</h3>
                    <p>${formatCurrency(analytics.totalRepairCost, currency)}</p>
                </div>
            </div>
        </div>

        <div class="analytics-section">
            <h3>Inventory & Performance</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Avg. ROI</h3>
                    <p>${analytics.averageROI.toFixed(2)}%</p>
                </div>
                <div class="stat-card">
                    <h3>Avg. Days to Sell</h3>
                    <p>${analytics.averageDaysToSell.toFixed(1)} days</p>
                </div>
                <div class="stat-card">
                    <h3>Best Performer</h3>
                    <p>${analytics.bestPerformer ? `${analytics.bestPerformer.plateNo} (${formatCurrency(analytics.bestPerformer.profit, currency)})` : 'N/A'}</p>
                </div>
                <div class="stat-card">
                    <h3>Worst Performer</h3>
                    <p>${analytics.worstPerformer ? `${analytics.worstPerformer.plateNo} (${formatCurrency(analytics.worstPerformer.profit, currency)})` : 'N/A'}</p>
                </div>
            </div>
        </div>

        <div class="analytics-section">
            <h3>Cash Flow Summary</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Inflow</h3>
                    <p class="profit-positive">${formatCurrency(analytics.cashFlow.inflow, currency)}</p>
                </div>
                <div class="stat-card">
                    <h3>Total Outflow</h3>
                    <p class="profit-negative">${formatCurrency(analytics.cashFlow.outflow, currency)}</p>
                </div>
                <div class="stat-card">
                    <h3>Net Flow</h3>
                    <p class="${analytics.cashFlow.net >= 0 ? 'profit-positive' : 'profit-negative'}">${formatCurrency(analytics.cashFlow.net, currency)}</p>
                </div>
                <div class="stat-card">
                    <h3>Current Cash</h3>
                    <p>${formatCurrency(analytics.currentCash, currency)}</p>
                </div>
            </div>
        </div>

        <div class="analytics-section">
            <h3>Monthly Summaries</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Bikes Sold</th>
                            <th>Net Profit</th>
                            <th>Cash Flow</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.keys(analytics.monthlySummaries).length === 0 ? '<tr><td colspan="4">No data yet.</td></tr>' : ''}
                        ${Object.entries(analytics.monthlySummaries).map(([month, summary]) => `
                            <tr>
                                <td>${month}</td>
                                <td>${summary.bikesSold}</td>
                                <td class="${summary.netProfit >= 0 ? 'profit-positive' : 'profit-negative'}">${formatCurrency(summary.netProfit, currency)}</td>
                                <td class="${summary.cashFlow >= 0 ? 'profit-positive' : 'profit-negative'}">${formatCurrency(summary.cashFlow, currency)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="analytics-section">
            <h3>Reports</h3>
            <div class="button-group">
                <button class="btn" data-action="export-pdf">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.75 2a.75.75 0 01.75.75V5h-2.5V2.75a.75.75 0 01.75-.75zM14 6V2.75A2.75 2.75 0 0011.25 0H5.75A2.75 2.75 0 003 2.75v14.5A2.75 2.75 0 005.75 20h8.5A2.75 2.75 0 0017 17.25V6h-3zM9 10.75a.75.75 0 01.75-.75h.5a.75.75 0 010 1.5h-.5a.75.75 0 01-.75-.75zm4 0a.75.75 0 01.75-.75h.5a.75.75 0 010 1.5h-.5a.75.75 0 01-.75-.75zM9 13.75a.75.75 0 01.75-.75h.5a.75.75 0 010 1.5h-.5a.75.75 0 01-.75-.75zm4 0a.75.75 0 01.75-.75h.5a.75.75 0 010 1.5h-.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>
                    Download Full Report (PDF)
                </button>
                <button class="btn" data-action="export-csv-all">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v2.5h-2.5a.75.75 0 000 1.5h2.5v2.5a.75.75 0 001.5 0v-2.5h2.5a.75.75 0 000-1.5h-2.5v-2.5z" clip-rule="evenodd" /></svg>
                    Download All Data (CSV)
                </button>
            </div>
        </div>
    `;
}

function renderSettingsTab() {
    const { settings } = appState;
    return `
        <h2>Settings</h2>
        <div class="settings-section">
            <h3>Appearance & Finance</h3>
            <form id="settings-finance-form" class="form-layout">
                <div class="form-group">
                    <label for="setting-business-name">Business Name</label>
                    <input type="text" id="setting-business-name" value="${escapeHTML(settings.businessName || '')}" required>
                </div>
                <div class="form-group">
                    <label for="setting-currency">Default Currency</label>
                    <input type="text" id="setting-currency" value="${escapeHTML(settings.currency || 'â‚¹')}" required>
                </div>
                <button type="submit" class="btn btn-primary">Save Finance Settings</button>
            </form>
        </div>

        <div class="settings-section">
            <h3>GitHub Sync</h3>
            <p class="help-text">Store your data in a private GitHub Gist. Create a <a href="https://github.com/settings/tokens/new?scopes=gist" target="_blank" rel="noopener">Personal Access Token (PAT)</a> with only the <code>gist</code> scope.</p>
            <form id="settings-sync-form" class="form-layout">
                <div class="form-group">
                    <label for="setting-gist-id">Gist ID</label>
                    <input type="text" id="setting-gist-id" placeholder="e.g., a1b2c3d4e5f6a1b2c3d4e5f6" value="${escapeHTML(settings.gistId || '')}">
                </div>
                <div class="form-group">
                    <label for="setting-pat">Personal Access Token (PAT)</label>
                    <input type="password" id="setting-pat" placeholder="ghp_..." value="${escapeHTML(settings.pat || '')}" required>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Save Sync Settings</button>
                    <button type="button" class="btn" data-action="validate-create-gist">Validate / Create Gist</button>
                    <button type="button" class="btn" data-action="sync-now">Sync Now</button>
                </div>
            </form>
        </div>

        <div class="settings-section">
            <h3>Data Management</h3>
            <p class="help-text">Export your data or reset your local cache.</p>
            <div class="button-group-vertical">
                <button class="btn" data-action="export-pdf">Download Full PDF Report</button>
                <button class="btn" data-action="export-csv-all">Download All Data CSV</button>
                <button class="btn" data-action="export-csv-bikes">Export Bikes CSV</button>
                <button class="btn" data-action="export-csv-txns">Export Transactions CSV</button>
                <button class="btn" data-action="export-csv-ledger">Export Capital Log CSV</button>
                <button class="btn btn-danger" data-action="reset-local-cache">Reset Local Cache</button>
            </div>
        </div>

        <div class="settings-section">
            <h3>Help</h3>
            <p class="help-text"><strong>Personal Access Token (PAT):</strong> Your PAT is stored *only* in your browser's local database. It is never sent to any server except GitHub's API. For security, use a token with *only* the <code>gist</code> scope. You can revoke this token anytime in your GitHub settings.</p>
            <p class="help-text"><strong>Sync Logic:</strong> The app saves all changes locally first. When you "Sync Now", it pushes your local changes to your Gist. If the Gist has been updated by another device, the sync will be aborted to prevent data loss. In case of a conflict, you may need to "Reset Local Cache" (which pulls the remote data, deleting local changes) or manually resolve the Gist data.</p>
        </div>
    `;
}

// --- Modals & Forms ---

function showBuyForm(bike = null) {
    const isEditing = bike !== null;
    const title = isEditing ? 'Edit Bike' : 'Add Bike (Buy)';
    const today = new Date().toISOString().split('T')[0];

    const formHtml = `
        <form id="buy-bike-form" class="form-layout" data-bike-id="${isEditing ? bike.id : ''}">
            <div class="form-group">
                <label for="bike-plateNo">Bike No/Plate</label>
                <input type="text" id="bike-plateNo" value="${escapeHTML(bike?.plateNo || '')}" required>
            </div>
            <div class="form-group">
                <label for="bike-model">Model</label>
                <input type="text" id="bike-model" value="${escapeHTML(bike?.model || '')}" required>
            </div>
            <div class="form-group">
                <label for="bike-ownerName">Owner Name (Seller)</label>
                <input type="text" id="bike-ownerName" value="${escapeHTML(bike?.ownerName || '')}" required>
            </div>
            <div class="form-group">
                <label for="bike-purchasePrice">Buying Price</label>
                <input type="number" id="bike-purchasePrice" value="${escapeHTML(bike?.purchasePrice || '')}" required>
            </div>
            <div class="form-group">
                <label for="bike-repairCost">Repair Cost</label>
                <input type="number" id="bike-repairCost" value="${escapeHTML(bike?.repairCost || 0)}">
            </div>
            <div class="form-group">
                <label for="bike-purchaseDate">Date of Purchase</label>
                <input type="date" id="bike-purchaseDate" value="${escapeHTML(bike?.purchaseDate ? bike.purchaseDate.split('T')[0] : today)}" required>
            </div>
            <div class="form-group">
                <label for="bike-notes">Notes</label>
                <textarea id="bike-notes">${escapeHTML(bike?.notes || '')}</textarea>
            </div>
        </form>
    `;

    showFormModal(title, formHtml, async (form) => {
        const formData = {
            plateNo: form.querySelector('#bike-plateNo').value,
            model: form.querySelector('#bike-model').value,
            ownerName: form.querySelector('#bike-ownerName').value,
            purchasePrice: parseFloat(form.querySelector('#bike-purchasePrice').value),
            repairCost: parseFloat(form.querySelector('#bike-repairCost').value || 0),
            purchaseDate: new Date(form.querySelector('#bike-purchaseDate').value).toISOString(),
            notes: form.querySelector('#bike-notes').value,
        };

        if (isEditing) {
            formData.id = bike.id;
            formData.yyyymm = getYearMonth(bike.purchaseDate); // original month
            await handleEditBike(formData);
        } else {
            await handleAddBike(formData);
        }
        showToast(`Bike ${isEditing ? 'updated' : 'added'} successfully!`, 'success');
        return true; // Close modal
    });
}

function showSellForm(bike) {
    const title = `Sell Bike: ${bike.plateNo}`;
    const today = new Date().toISOString().split('T')[0];

    const formHtml = `
        <form id="sell-bike-form" class="form-layout">
            <p><strong>Model:</strong> ${escapeHTML(bike.model)}</p>
            <p><strong>Total Cost:</strong> ${formatCurrency(bike.totalCost, appState.settings.currency)}</p>
            <hr/>
            <div class="form-group">
                <label for="sell-price">Selling Price</label>
                <input type="number" id="sell-price" required>
            </div>
            <div class="form-group">
                <label for="sell-date">Date of Sale</label>
                <input type="date" id="sell-date" value="${today}" required>
            </div>
            <div class="form-group">
                <label for="sell-buyer-name">Buyer Name</label>
                <input type="text" id="sell-buyer-name" required>
            </div>
            <div class="form-group">
                <label for="sell-notes">Notes</label>
                <textarea id="sell-notes"></textarea>
            </div>
        </form>
    `;

    showFormModal(title, formHtml, async (form) => {
        const sellData = {
            sellPrice: parseFloat(form.querySelector('#sell-price').value),
            sellDate: new Date(form.querySelector('#sell-date').value).toISOString(),
            buyerName: form.querySelector('#sell-buyer-name').value,
            notes: form.querySelector('#sell-notes').value,
        };

        const profit = sellData.sellPrice - bike.totalCost;
        await handleSellBike(bike, sellData);
        showToast(`Bike sold for ${formatCurrency(sellData.sellPrice, appState.settings.currency)} (Profit: ${formatCurrency(profit, appState.settings.currency)})`, 'success');
        return true;
    });
}

function showBulkSellForm() {
    const selectedBikes = getSelectedBikes().filter(b => b.status === 'available');
    if (selectedBikes.length === 0) {
        showToast('No available bikes selected for bulk sale.', 'error');
        return;
    }

    const title = `Bulk Sell ${selectedBikes.length} Bikes`;
    const today = new Date().toISOString().split('T')[0];

    let bikeListHtml = selectedBikes.map(bike => `
        <div class="bulk-sell-item" data-bike-id="${bike.id}">
            <strong>${escapeHTML(bike.plateNo)}</strong> (${escapeHTML(bike.model)})
            <br>
            <small>Cost: ${formatCurrency(bike.totalCost, appState.settings.currency)}</small>
            <div class="form-group">
                <label for="bulk-sell-price-${bike.id}">Sell Price</label>
                <input type="number" id="bulk-sell-price-${bike.id}" class="bulk-sell-price-input" placeholder="e.g., 60000" required>
            </div>
        </div>
    `).join('<hr>');

    const formHtml = `
        <form id="bulk-sell-form" class="form-layout">
            <p>Enter individual selling prices below. You can use the fields below to set defaults for all.</p>
            <hr/>
            <div class="form-group">
                <label for="bulk-sell-date">Date of Sale (for all)</label>
                <input type="date" id="bulk-sell-date" value="${today}" required>
            </div>
            <div class="form-group">
                <label for="bulk-sell-buyer-name">Buyer Name (for all)</label>
                <input type="text" id="bulk-sell-buyer-name" placeholder="e.g., 'Various' or 'Used Bikes Dealer'">
            </div>
            <hr/>
            <h3>Individual Prices</h3>
            <div id="bulk-sell-list">
                ${bikeListHtml}
            </div>
        </form>
    `;

    showFormModal(title, formHtml, async (form) => {
        const sellDate = new Date(form.querySelector('#bulk-sell-date').value).toISOString();
        const buyerName = form.querySelector('#bulk-sell-buyer-name').value;

        const sellOps = [];
        let totalSold = 0;
        let totalProfit = 0;

        for (const bike of selectedBikes) {
            const priceInput = form.querySelector(`#bulk-sell-price-${bike.id}`);
            const sellPrice = parseFloat(priceInput.value);

            if (!sellPrice || sellPrice <= 0) {
                priceInput.focus();
                priceInput.style.borderColor = 'red';
                showToast(`Please enter a valid price for ${bike.plateNo}`, 'error');
                return false; // Don't close modal
            }

            const sellData = {
                sellPrice,
                sellDate,
                buyerName: buyerName || 'Bulk Sale',
                notes: `Bulk sale.`,
            };
            
            // We create the op payload but don't queue it yet,
            // we'll queue a single "BULK_SELL" op
            const op = createSellBikeOp(bike, sellData);
            sellOps.push(op); // op is { bike, ... }
            totalSold++;
            totalProfit += (sellData.sellPrice - bike.totalCost);
        }

        if (sellOps.length > 0) {
            await queueOp('BULK_SELL', sellOps);
            await optimisticUpdate({ type: 'BULK_SELL', payload: sellOps });
            showToast(`${totalSold} bikes sold. Total Profit: ${formatCurrency(totalProfit, appState.settings.currency)}`, 'success');
        }
        
        return true; // Close modal
    });
}

function showAdjustCapitalForm() {
    const title = 'Adjust Capital';
    const formHtml = `
        <form id="adjust-capital-form" class="form-layout">
            <div class="form-group">
                <label for="adj-amount">Amount</label>
                <input type="number" id="adj-amount" placeholder="e.g., 50000 or -10000" required>
            </div>
            <div class="form-group">
                <label for="adj-reason">Reason</label>
                <input type="text" id="adj-reason" placeholder="e.g., 'Initial capital' or 'Withdrawal'" required>
            </div>
        </form>
    `;

    showFormModal(title, formHtml, async (form) => {
        const amount = parseFloat(form.querySelector('#adj-amount').value);
        const reason = form.querySelector('#adj-reason').value;

        if (!amount) {
            showToast('Amount cannot be zero.', 'error');
            return false;
        }
        if (!reason.trim()) {
            showToast('Reason is required.', 'error');
            return false;
        }

        await handleAdjustCapital({ amount, reason });
        showToast(`Capital adjusted by ${formatCurrency(amount, appState.settings.currency)}`, 'success');
        return true;
    });
}

function showAdvancedFilters() {
    const { filters } = appState.ui;
    const formHtml = `
        <form id="advanced-filter-form" class="form-layout">
            <div class="form-group">
                <label for="filter-date-from">Purchase Date From</label>
                <input type="date" id="filter-date-from" value="${filters.dateFrom || ''}">
            </div>
            <div class="form-group">
                <label for="filter-date-to">Purchase Date To</label>
                <input type="date" id="filter-date-to" value="${filters.dateTo || ''}">
            </div>
            <div class="form-group">
                <label for="filter-cost-min">Min Total Cost</label>
                <input type="number" id="filter-cost-min" value="${filters.costMin || ''}">
            </div>
            <div class="form-group">
                <label for="filter-cost-max">Max Total Cost</label>
                <input type="number" id="filter-cost-max" value="${filters.costMax || ''}">
            </div>
            <div class="form-group">
                <label for="filter-profit-min">Min Profit (for sold)</label>
                <input type="number" id="filter-profit-min" value="${filters.profitMin || ''}">
            </div>
            <div class="form-group">
                <label for="filter-profit-max">Max Profit (for sold)</label>
                <input type="number" id="filter-profit-max" value="${filters.profitMax || ''}">
            </div>
        </form>
    `;

    showFormModal('Advanced Filters', formHtml, (form) => {
        appState.ui.filters.dateFrom = form.querySelector('#filter-date-from').value;
        appState.ui.filters.dateTo = form.querySelector('#filter-date-to').value;
        appState.ui.filters.costMin = form.querySelector('#filter-cost-min').value ? parseFloat(form.querySelector('#filter-cost-min').value) : null;
        appState.ui.filters.costMax = form.querySelector('#filter-cost-max').value ? parseFloat(form.querySelector('#filter-cost-max').value) : null;
        appState.ui.filters.profitMin = form.querySelector('#filter-profit-min').value ? parseFloat(form.querySelector('#filter-profit-min').value) : null;
        appState.ui.filters.profitMax = form.querySelector('#filter-profit-max').value ? parseFloat(form.querySelector('#filter-profit-max').value) : null;
        
        renderApp();
        showToast('Filters applied', 'info');
        return true;
    }, () => {}, 'Apply', 'Clear Filters', () => {
        // Clear filters
        appState.ui.filters = {
            search: appState.ui.filters.search,
            status: appState.ui.filters.status,
            sort: appState.ui.filters.sort,
        };
        renderApp();
        showToast('Filters cleared', 'info');
    });
}


// --- Event Handlers ---

function attachEventListeners() {
    const $app = $('#app-container');

    // --- Navigation ---
    $('#bottom-nav').addEventListener('click', (e) => {
        const $button = e.target.closest('button');
        if (!$button) return;

        const tabId = $button.dataset.tab;
        navigateTo(tabId);
    });

    // --- Delegated Clicks ---
    $app.addEventListener('click', async (e) => {
        const $target = e.target;
        const $button = $target.closest('button');
        const $card = $target.closest('.bike-card');

        // Card click (not a button or checkbox)
        if ($card && !$target.closest('button') && $target.type !== 'checkbox') {
            const bikeId = $card.dataset.bikeId;
            const bike = findBikeById(bikeId);
            if (bike) {
                showBuyForm(bike); // Show edit form
            }
            return;
        }

        // Checkbox click
        if ($target.matches('.bike-select-checkbox')) {
            handleSelectionChange();
            return;
        }

        if (!$button) return;

        const action = $button.dataset.action;
        const bikeId = $button.dataset.bikeId || $target.closest('.bike-card')?.dataset.bikeId;
        let bike;
        if (bikeId) {
            bike = findBikeById(bikeId);
        }

        switch (action) {
            // Dashboard
            case 'show-buy-form':
                showBuyForm();
                break;
            case 'show-adjust-capital-form':
                showAdjustCapitalForm();
                break;
            case 'show-advanced-filters':
                showAdvancedFilters();
                break;
            case 'show-sell-form':
                if (bike) showSellForm(bike);
                break;
            case 'show-edit-bike-form':
                if (bike) showBuyForm(bike);
                break;
            case 'show-bulk-sell-form':
                showBulkSellForm();
                break;
            case 'bulk-export-csv':
                handleBulkExport();
                break;
            case 'bulk-delete-bikes':
                handleBulkDelete();
                break;

            // Settings
            case 'validate-create-gist':
                await handleValidateAndCreateGist();
                break;
            case 'sync-now':
                await syncNow();
                break;
            case 'reset-local-cache':
                handleResetLocalCache();
                break;

            // Exports
            case 'export-pdf':
                await exportPDF();
                break;
            case 'export-csv-all':
                await exportCSV('ALL_DATA');
                break;
            case 'export-csv-bikes':
                await exportCSV('BIKES');
                break;
            case 'export-csv-txns':
                await exportCSV('TRANSACTIONS');
                break;
            case 'export-csv-ledger':
                await exportCSV('CAPITAL_LOG');
                break;
        }
    });

    // --- Delegated Form Submissions ---
    $app.addEventListener('submit', async (e) => {
        e.preventDefault();
        const $form = e.target;

        if ($form.id === 'settings-finance-form') {
            await handleUpdateSettings({
                businessName: $('#setting-business-name').value,
                currency: $('#setting-currency').value,
            });
            showToast('Finance settings saved!', 'success');
        } else if ($form.id === 'settings-sync-form') {
            await handleUpdateSettings({
                gistId: $('#setting-gist-id').value,
                pat: $('#setting-pat').value,
            });
            showToast('Sync settings saved! Validate & Sync now.', 'success');
        }
    });

    // --- Filters ---
    $app.addEventListener('input', (e) => {
        const $target = e.target;
        if ($target.id === 'search-input') {
            appState.ui.filters.search = $target.value;
            renderApp();
        }
    });

    $app.addEventListener('change', (e) => {
        const $target = e.target;
        if ($target.id === 'sort-select') {
            appState.ui.filters.sort = $target.value;
            renderApp();
        }
    });

    $app.addEventListener('click', (e) => {
        const $target = e.target.closest('.chip[data-filter="status"]');
        if ($target) {
            appState.ui.filters.status = $target.dataset.value;
            renderApp();
        }
    });

    // --- Online/Offline Sync ---
    window.addEventListener('online', () => {
        showToast('You are back online. Attempting to sync...', 'info');
        syncNow();
    });
    window.addEventListener('offline', () => {
        setSyncState('offline');
        showToast('You are offline. Changes will be saved locally.', 'info');
    });
}

// --- Handler Functions ---

async function handleAddBike(bikeData) {
    const op = createAddBikeOp(bikeData);
    await queueOp('ADD_BIKE', op);
    await optimisticUpdate({ type: 'ADD_BIKE', payload: op });
}

async function handleEditBike(bikeData) {
    // This is more complex. We need to find the original bike,
    // calculate the *difference* in cost, and adjust capital.
    const originalBike = findBikeById(bikeData.id);
    if (!originalBike) return;

    const op = {
        type: 'EDIT_BIKE',
        payload: {
            bikeId: bikeData.id,
            yyyymm: getYearMonth(originalBike.purchaseDate),
            newData: bikeData
        }
    };
    await queueOp('EDIT_BIKE', op);
    await optimisticUpdate(op);
}

async function handleSellBike(bike, sellData) {
    const op = createSellBikeOp(bike, sellData);
    await queueOp('SELL_BIKE', op.payload);
    await optimisticUpdate({ type: 'SELL_BIKE', payload: op.payload });
}

async function handleAdjustCapital(adjData) {
    const op = {
        type: 'ADJUST_CAPITAL',
        payload: {
            ...adjData,
            id: 'cap_' + Date.now(),
            txn_id: 'txn_' + Date.now(),
            date: new Date().toISOString()
        }
    };
    await queueOp('ADJUST_CAPITAL', op.payload);
    await optimisticUpdate(op);
}

async function handleUpdateSettings(newSettings) {
    const op = {
        type: 'UPDATE_SETTINGS',
        payload: newSettings
    };
    await queueOp('UPDATE_SETTINGS', op.payload);
    await optimisticUpdate(op);
}

function handleSelectionChange() {
    const $actionBar = $('#bulk-action-bar');
    const $count = $('#selection-count');
    const $sellBtn = $actionBar.querySelector('[data-action="show-bulk-sell-form"]');

    const selectedBikes = getSelectedBikes();
    const count = selectedBikes.length;

    if (count > 0) {
        $actionBar.classList.remove('hidden');
        $count.textContent = count;
        // Enable/disable bulk sell button
        const canBulkSell = selectedBikes.every(b => b.status === 'available');
        if (canBulkSell) {
            $sellBtn.removeAttribute('disabled');
        } else {
            $sellBtn.setAttribute('disabled', 'true');
        }
    } else {
        $actionBar.classList.add('hidden');
    }
}

function handleBulkExport() {
    const selectedBikes = getSelectedBikes();
    if (selectedBikes.length === 0) {
        showToast('No bikes selected.', 'error');
        return;
    }
    const csv = generateCSV(selectedBikes, 'BIKES');
    downloadFile(csv, `bike_export_${Date.now()}.csv`, 'text/csv');
}

function handleBulkDelete() {
    const selectedBikes = getSelectedBikes();
    if (selectedBikes.length === 0) {
        showToast('No bikes selected.', 'error');
        return;
    }

    showModal(
        'Delete Bikes',
        `Are you sure you want to delete ${selectedBikes.length} bike(s)? This will also reverse any associated financial transactions (buy/sell). This action cannot be easily undone.`,
        async () => {
            const ops = selectedBikes.map(bike => {
                return {
                    bikeId: bike.id,
                    yyyymm: getYearMonth(bike.purchaseDate),
                    bike: bike // Pass full bike for ledger reversal
                };
            });

            await queueOp('BULK_DELETE', ops);
            await optimisticUpdate({ type: 'BULK_DELETE', payload: ops });
            
            showToast(`${selectedBikes.length} bikes deleted.`, 'success', 5000, true, async () => {
                // UNDO logic
                showToast('Undo is not supported for bulk delete yet.', 'info');
                // This is complex, would require another op 'UNDO_BULK_DELETE'
                // For now, we just show a message.
            });
        },
        () => {},
        'Delete',
        'Cancel'
    );
}

async function handleValidateAndCreateGist() {
    const { pat } = appState.settings;
    if (!pat) {
        showToast('Please enter a Personal Access Token (PAT) first.', 'error');
        return;
    }

    setSyncState('syncing', 'Validating PAT...');
    try {
        const headers = getHeaders(pat);
        const res = await fetch('https://api.github.com/user', { headers });

        if (!res.ok) {
            throw new Error(`Invalid PAT or network issue. Status: ${res.status}`);
        }

        const user = await res.json();
        showToast(`PAT valid for user: ${user.login}`, 'success');
        setSyncState('syncing', 'Creating Gist...');

        const defaultData = getInitialData();
        const content = JSON.stringify(defaultData, null, 2);
        
        const createRes = await fetch('https://api.github.com/gists', {
            method: 'POST',
            headers,
            body: JSON.stringify({
                description: 'Bike Resell Manager Database',
                public: false,
                files: {
                    [GIST_FILENAME]: {
                        content: content
                    }
                }
            })
        });

        if (!createRes.ok) {
            throw new Error('Failed to create Gist.');
        }

        const gist = await createRes.json();
        const newGistId = gist.id;

        showToast(`New Gist created successfully: ${newGistId}`, 'success');
        
        // Save new Gist ID to settings
        await handleUpdateSettings({ gistId: newGistId });
        // Set local data to this new Gist's data
        await setData('data', defaultData);
        await loadStateIntoApp(defaultData);
        setSyncState('synced');

    } catch (err) {
        console.error('Validate/Create Gist Error:', err);
        setSyncState('error', err.message);
        showToast(err.message, 'error');
    }
}

function handleResetLocalCache() {
    showModal(
        'Reset Local Cache',
        'Are you sure? This will delete all your local data and pending changes, and pull the latest data from your GitHub Gist. This is irreversible.',
        async () => {
            const { gistId, pat } = appState.settings;
            if (!gistId || !pat) {
                showToast('Cannot reset: Gist ID or PAT not set.', 'error');
                return;
            }

            try {
                showToast('Resetting... Fetching remote data...', 'info');
                setSyncState('syncing', 'Resetting...');

                const remoteData = await fetchGist(gistId, pat);
                if (remoteData) {
                    await setData('data', remoteData); // Overwrite local data
                    await clearOpQueue(); // Delete all pending ops
                    await loadStateIntoApp(remoteData); // Reload app
                    setSyncState('synced');
                    showToast('Local cache reset and synced with remote.', 'success');
                } else {
                    throw new Error('Failed to fetch remote data.');
                }
            } catch (err) {
                console.error('Reset Cache Error:', err);
                setSyncState('error', err.message);
                showToast(`Reset failed: ${err.message}`, 'error');
            }
        },
        () => {},
        'Reset',
        'Cancel'
    );
}

// --- GitHub API Client ---

function getHeaders(pat) {
    return {
        'Authorization': `token ${pat}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
    };
}

async function fetchGist(gistId, pat) {
    if (!gistId || !pat) {
        console.warn('fetchGist: gistId or pat is missing.');
        return null;
    }
    
    try {
        const headers = getHeaders(pat);
        const res = await fetch(`https://api.github.com/gists/${gistId}`, { headers });

        if (!res.ok) {
            if (res.status === 404) throw new Error('Gist not found.');
            if (res.status === 403 || res.status === 401) throw new Error('Invalid PAT or insufficient permissions.');
            throw new Error(`GitHub API error: ${res.status}`);
        }

        const gist = await res.json();
        if (!gist.files || !gist.files[GIST_FILENAME]) {
            throw new Error(`Gist found, but file '${GIST_FILENAME}' is missing.`);
        }

        const content = gist.files[GIST_FILENAME].content;
        return JSON.parse(content);
    } catch (err) {
        console.error('fetchGist Error:', err);
        setSyncState('error', err.message);
        return null;
    }
}

async function updateGist(gistId, pat, data) {
    if (!gistId || !pat) {
        throw new Error('updateGist: gistId or pat is missing.');
    }

    try {
        const headers = getHeaders(pat);
        const content = JSON.stringify(data, null, 2);

        const res = await fetch(`https://api.github.com/gists/${gistId}`, {
            method: 'PATCH',
            headers,
            body: JSON.stringify({
                files: {
                    [GIST_FILENAME]: {
                        content: content
                    }
                }
            })
        });

        if (!res.ok) {
            throw new Error(`GitHub API error: ${res.status}`);
        }
        
        const gist = await res.json();
        return JSON.parse(gist.files[GIST_FILENAME].content);
    } catch (err) {
        console.error('updateGist Error:', err);
        setSyncState('error', err.message);
        throw err;
    }
}

// --- Sync Engine ---

async function syncNow() {
    if (syncState === 'syncing') {
        showToast('Sync already in progress.', 'info');
        return;
    }
    setSyncState('syncing', 'Starting sync...');

    const { gistId, pat } = appState.settings;
    if (!gistId || !pat) {
        setSyncState('error', 'Missing Gist ID or PAT');
        showToast('Gist ID or PAT not set in Settings.', 'error');
        return;
    }

    try {
        // 1. Get local base data and ops
        const localBaseData = await getData('data') || getInitialData();
        const ops = await getOpQueue();

        // 2. Fetch remote data
        setSyncState('syncing', 'Fetching remote data...');
        const remoteData = await fetchGist(gistId, pat);
        if (!remoteData) {
            // fetchGist already set error state
            return;
        }

        const remoteTs = new Date(remoteData.meta.updatedAt).getTime();
        const localBaseTs = new Date(localBaseData.meta.updatedAt).getTime();

        // 3. Decide sync strategy
        if (ops.length > 0) {
            // User has local changes
            if (remoteTs > localBaseTs) {
                // *** CONFLICT ***
                // Remote has changed since our last pull, AND we have local changes.
                setSyncState('error', 'Conflict: Remote data changed.');
                showToast('CONFLICT: Remote data has changed. Sync aborted. Please reset local cache or manually resolve.', 'error', 10000);
            } else {
                // *** PUSH ***
                // Safe to push local changes
                setSyncState('syncing', 'Pushing local changes...');
                const dataToPush = applyOpsToData(localBaseData, ops);
                dataToPush.meta.updatedAt = new Date().toISOString();

                const pushedData = await updateGist(gistId, pat, dataToPush);

                // 5. Post-push cleanup
                await setData('data', pushedData); // Save the confirmed new state
                await clearOpQueue();
                await loadStateIntoApp(pushedData);
                setSyncState('synced');
                showToast('Local changes pushed successfully!', 'success');
            }
        } else {
            // No local changes
            if (remoteTs > localBaseTs) {
                // *** PULL ***
                setSyncState('syncing', 'Pulling remote updates...');
                await setData('data', remoteData);
                await loadStateIntoApp(remoteData);
                setSyncState('synced');
                showToast('Remote data pulled successfully.', 'success');
            } else {
                // *** IN SYNC ***
                setSyncState('synced');
                showToast('Data is already up to date.', 'info');
            }
        }
    } catch (err) {
        console.error('syncNow Error:', err);
        setSyncState('error', err.message);
        showToast(`Sync failed: ${err.message}`, 'error');
    }
}

// --- Operation Queue & Logic ---

function createAddBikeOp(bikeData) {
    const totalCost = bikeData.purchasePrice + bikeData.repairCost;
    const id = 'bike_' + Date.now();
    const yyyymm = getYearMonth(bikeData.purchaseDate);
    
    return {
        ...bikeData,
        id,
        yyyymm,
        totalCost,
        status: 'available',
        sellPrice: null,
        sellDate: null,
        profit: null
    };
}

function createSellBikeOp(bike, sellData) {
    const profit = sellData.sellPrice - bike.totalCost;
    const sell_yyyymm = getYearMonth(sellData.sellDate);

    return {
        payload: {
            bikeId: bike.id,
            purchase_yyyymm: getYearMonth(bike.purchaseDate),
            sell_yyyymm,
            sellPrice: sellData.sellPrice,
            sellDate: sellData.sellDate,
            buyerName: sellData.buyerName,
            notes: sellData.notes,
            profit: profit
        },
        bike: bike // Pass bike for ledger
    };
}

async function optimisticUpdate(op) {
    // Apply op to in-memory state
    appState.data = applyOpsToData(appState.data, [op]);
    // Re-render UI
    renderApp();
    // Set sync state to pending
    setSyncState('pending');
}

/**
 * Applies a list of operations to a data object.
 * This is a PURE function. It returns a new data object.
 */
function applyOpsToData(data, ops) {
    // Deep clone data to ensure purity
    let newData = JSON.parse(JSON.stringify(data));

    try {
        for (const op of ops) {
            const payload = op.payload;
            
            switch (op.type) {
                case 'ADD_BIKE':
                    newData = addBikeOp(newData, payload);
                    break;
                case 'EDIT_BIKE':
                    newData = editBikeOp(newData, payload);
                    break;
                case 'SELL_BIKE':
                    newData = sellBikeOp(newData, payload.bike, payload);
                    break;
                case 'BULK_SELL':
                    // payload is an array of sell ops
                    for (const sellOp of payload) {
                        newData = sellBikeOp(newData, sellOp.bike, sellOp.payload);
                    }
                    break;
                case 'ADJUST_CAPITAL':
                    newData = adjustCapitalOp(newData, payload);
                    break;
                case 'BULK_DELETE':
                    // payload is an array of { bikeId, yyyymm, bike }
                    for (const deleteOp of payload) {
                        newData = deleteBikeOp(newData, deleteOp);
                    }
                    break;
                case 'UPDATE_SETTINGS':
                    newData.settings = { ...newData.settings, ...payload };
                    break;
            }
        }
    } catch (err) {
        console.error('Error applying op:', op, err);
        // If an op fails, return the original data to prevent corruption
        return data; 
    }
    return newData;
}

// --- Atomic Operation Handlers (mutate and return data object) ---

function addBikeOp(data, payload) {
    const yyyymm = payload.yyyymm;
    ensureMonthExists(data, yyyymm);
    data.months[yyyymm].bikes.push(payload);

    // Add transaction and ledger entries
    const currentCapital = getCurrentCapital(data);
    const balanceAfter = currentCapital - payload.totalCost;

    const txn = {
        id: 'txn_' + Date.now(),
        type: 'buy',
        bikeId: payload.id,
        amount: payload.totalCost,
        date: payload.purchaseDate,
        meta: { seller: payload.ownerName }
    };
    const ledger = {
        id: 'cap_' + Date.now(),
        change: -payload.totalCost,
        balanceAfter: balanceAfter,
        type: 'buy',
        reason: `Bought ${payload.plateNo}`,
        date: payload.purchaseDate
    };
    
    data.months[yyyymm].transactions.push(txn);
    data.months[yyyymm].capitalLedger.push(ledger);
    return data;
}

function editBikeOp(data, payload) {
    const { bikeId, yyyymm, newData } = payload;
    const month = data.months[yyyymm];
    if (!month) return data;

    const bikeIndex = month.bikes.findIndex(b => b.id === bikeId);
    if (bikeIndex === -1) return data;

    const originalBike = month.bikes[bikeIndex];
    
    // Calculate financial difference
    const newTotalCost = newData.purchasePrice + newData.repairCost;
    const costDifference = newTotalCost - originalBike.totalCost; // e.g., new 520, old 500. diff = +20

    // Update bike object
    const updatedBike = {
        ...originalBike,
        ...newData,
        totalCost: newTotalCost
    };
    month.bikes[bikeIndex] = updatedBike;

    // If cost changed, add adjusting transaction
    if (costDifference !== 0) {
        const currentCapital = getCurrentCapital(data);
        const balanceAfter = currentCapital - costDifference; // e.g., capital - 20

        const reason = `Cost adjustment for ${updatedBike.plateNo} (Old: ${originalBike.totalCost}, New: ${newTotalCost})`;
        const ledger = {
            id: 'cap_' + Date.now(),
            change: -costDifference, // Negative diff means more cost, so negative change
            balanceAfter: balanceAfter,
            type: 'manual_adjust',
            reason: reason,
            date: new Date().toISOString()
        };
        const adj_yyyymm = getYearMonth(ledger.date);
        ensureMonthExists(data, adj_yyyymm);
        data.months[adj_yyyymm].capitalLedger.push(ledger);
    }
    return data;
}

function sellBikeOp(data, bike, payload) {
    // Find the bike in its purchase month
    const purchaseMonth = data.months[payload.purchase_yyyymm];
    if (!purchaseMonth) return data;
    
    const bikeToSell = purchaseMonth.bikes.find(b => b.id === payload.bikeId);
    if (!bikeToSell) return data;

    // Update bike status
    bikeToSell.status = 'sold';
    bikeToSell.sellPrice = payload.sellPrice;
    bikeToSell.sellDate = payload.sellDate;
    bikeToSell.profit = payload.profit;
    bikeToSell.notes = (bikeToSell.notes || '') + `\nSold to: ${payload.buyerName}. ${payload.notes}`;

    // Add transaction and ledger entries to the *sell* month
    const sell_yyyymm = payload.sell_yyyymm;
    ensureMonthExists(data, sell_yyyymm);

    const currentCapital = getCurrentCapital(data);
    const balanceAfter = currentCapital + payload.sellPrice;

    const txn = {
        id: 'txn_' + Date.now(),
        type: 'sell',
        bikeId: payload.bikeId,
        amount: payload.sellPrice,
        date: payload.sellDate,
        meta: { buyer: payload.buyerName }
    };
    const ledger = {
        id: 'cap_' + Date.now(),
        change: payload.sellPrice,
        balanceAfter: balanceAfter,
        type: 'sell',
        reason: `Sold ${bikeToSell.plateNo}`,
        date: payload.sellDate
    };

    data.months[sell_yyyymm].transactions.push(txn);
    data.months[sell_yyyymm].capitalLedger.push(ledger);
    return data;
}

function adjustCapitalOp(data, payload) {
    const yyyymm = getYearMonth(payload.date);
    ensureMonthExists(data, yyyymm);

    const currentCapital = getCurrentCapital(data);
    const balanceAfter = currentCapital + payload.amount;

    const txn = {
        id: payload.txn_id,
        type: 'adjust',
        bikeId: null,
        amount: payload.amount,
        date: payload.date,
        meta: { reason: payload.reason }
    };
    const ledger = {
        id: payload.id,
        change: payload.amount,
        balanceAfter: balanceAfter,
        type: 'manual_adjust',
        reason: payload.reason,
        date: payload.date
    };

    data.months[yyyymm].transactions.push(txn);
    data.months[yyyymm].capitalLedger.push(ledger);
    return data;
}

function deleteBikeOp(data, payload) {
    const { bikeId, yyyymm, bike } = payload;
    const month = data.months[yyyymm];
    if (!month) return data;

    // Remove bike
    month.bikes = month.bikes.filter(b => b.id !== bikeId);

    // Create reversing ledger entry
    let capitalChange = 0;
    let reason = `Reversal for deleted bike ${bike.plateNo}.`;

    if (bike.status === 'available') {
        capitalChange = bike.totalCost; // Give back the money spent
        reason += ` (Purchase cost ${bike.totalCost} reversed).`;
    } else if (bike.status === 'sold') {
        // Net profit/loss was (sellPrice - totalCost)
        // We reversed the 'buy' (-totalCost) and 'sell' (+sellPrice)
        // Reversal is (-sellPrice + totalCost)
        capitalChange = bike.totalCost - bike.sellPrice;
        reason += ` (Net sale ${bike.sellPrice - bike.totalCost} reversed).`;
    }

    const currentCapital = getCurrentCapital(data);
    const balanceAfter = currentCapital + capitalChange;
    const today = new Date().toISOString();
    const adj_yyyymm = getYearMonth(today);
    ensureMonthExists(data, adj_yyyymm);

    const ledger = {
        id: 'cap_' + Date.now(),
        change: capitalChange,
        balanceAfter: balanceAfter,
        type: 'manual_adjust',
        reason: reason,
        date: today
    };
    data.months[adj_yyyymm].capitalLedger.push(ledger);
    
    // We could also remove associated txns and ledger entries, but that's
    // much harder. A reversing entry is safer.
    return data;
}

// --- Analytics Engine ---

function calculateAnalytics(data) {
    const allBikes = getAllBikes(data);
    const allLedger = getAllLedgerEntries(data);
    const { currency } = data.settings;

    const soldBikes = allBikes.filter(b => b.status === 'sold');
    const availableBikes = allBikes.filter(b => b.status === 'available');

    const totalCostOfSoldBikes = soldBikes.reduce((sum, b) => sum + b.totalCost, 0);
    const totalReturns = soldBikes.reduce((sum, b) => sum + b.sellPrice, 0);
    const totalProfit = totalReturns - totalCostOfSoldBikes;
    const totalUnsoldInvestment = availableBikes.reduce((sum, b) => sum + b.totalCost, 0);
    const totalRepairCost = allBikes.reduce((sum, b) => sum + b.repairCost, 0);
    const currentCash = getCurrentCapital(data);

    let totalDaysToSell = 0;
    let validROIs = [];
    let bestPerformer = null;
    let worstPerformer = null;

    soldBikes.forEach(b => {
        if (b.sellDate && b.purchaseDate) {
            const sellDate = new Date(b.sellDate);
            const purchaseDate = new Date(b.purchaseDate);
            const daysToSell = (sellDate.getTime() - purchaseDate.getTime()) / (1000 * 3600 * 24);
            totalDaysToSell += daysToSell;
        }
        if (b.totalCost > 0) {
            validROIs.push(b.profit / b.totalCost);
        }
        if (!bestPerformer || b.profit > bestPerformer.profit) {
            bestPerformer = b;
        }
        if (!worstPerformer || b.profit < worstPerformer.profit) {
            worstPerformer = b;
        }
    });

    const averageDaysToSell = soldBikes.length > 0 ? totalDaysToSell / soldBikes.length : 0;
    const averageROI = validROIs.length > 0 ? (validROIs.reduce((s, r) => s + r, 0) / validROIs.length) * 100 : 0;

    // Cash Flow
    let inflow = 0;
    let outflow = 0;
    allLedger.forEach(entry => {
        if (entry.change > 0) inflow += entry.change;
        if (entry.change < 0) outflow += Math.abs(entry.change);
    });

    // Monthly Summaries
    const monthlySummaries = {};
    Object.keys(data.months).forEach(yyyymm => {
        const month = data.months[yyyymm];
        let monthProfit = 0;
        let monthCashFlow = 0;
        let monthBikesSold = 0;

        month.bikes.forEach(b => {
            if (b.status === 'sold' && getYearMonth(b.sellDate) === yyyymm) {
                monthProfit += b.profit;
                monthBikesSold++;
            }
        });

        month.capitalLedger.forEach(entry => {
            monthCashFlow += entry.change;
        });

        if (monthBikesSold > 0 || monthCashFlow !== 0) {
            monthlySummaries[yyyymm] = {
                bikesSold: monthBikesSold,
                netProfit: monthProfit,
                cashFlow: monthCashFlow
            };
        }
    });

    return {
        totalCostOfSoldBikes,
        totalReturns,
        totalProfit,
        totalUnsoldInvestment,
        totalRepairCost,
        currentCash,
        inventoryCount: {
            sold: soldBikes.length,
            available: availableBikes.length
        },
        averageDaysToSell,
        averageROI,
        bestPerformer,
        worstPerformer,
        cashFlow: {
            inflow,
            outflow,
            net: inflow - outflow
        },
        monthlySummaries
    };
}

// --- Export Engine ---

async function exportCSV(type = 'ALL_DATA') {
    // Attempt quick sync first
    if (navigator.onLine) {
        showToast('Syncing before export...', 'info');
        await syncNow();
    }
    
    let csv = '';
    let filename = `export_${type.toLowerCase()}_${Date.now()}.csv`;
    let data;

    switch (type) {
        case 'ALL_DATA':
        case 'BIKES':
            data = getFilteredBikes(); // Use filtered bikes for main export
            if (type === 'ALL_DATA') data = getAllBikes(appState.data); // Use all bikes for "All Data"
            csv = generateCSV(data, 'BIKES');
            filename = `export_bikes_${Date.now()}.csv`;
            break;
        case 'TRANSACTIONS':
            data = getAllTransactions(appState.data);
            csv = generateCSV(data, 'TRANSACTIONS');
            break;
        case 'CAPITAL_LOG':
            data = getAllLedgerEntries(appState.data);
            csv = generateCSV(data, 'CAPITAL_LOG');
            break;
    }

    downloadFile(csv, filename, 'text/csv;charset=utf-8;');
    showToast(`Exported ${type} to ${filename}`, 'success');
}

function generateCSV(data, type) {
    if (!data || data.length === 0) return '';

    const headers = Object.keys(data[0]);
    let csv = headers.join(',') + '\n';

    data.forEach(row => {
        const values = headers.map(header => {
            let val = row[header];
            if (val === null || val === undefined) {
                val = '';
            }
            if (typeof val === 'string') {
                // Escape quotes and wrap in quotes if it contains comma or newline
                if (val.includes(',') || val.includes('\n') || val.includes('"')) {
                    val = `"${val.replace(/"/g, '""')}"`;
                }
            }
            return val;
        });
        csv += values.join(',') + '\n';
    });
    return csv;
}

async function exportPDF() {
    // Attempt quick sync first
    if (navigator.onLine) {
        showToast('Syncing before export...', 'info');
        await syncNow();
    }

    showToast('Generating PDF report...', 'info');
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const data = appState.data;
        const analytics = calculateAnalytics(data);
        const { currency, businessName } = data.settings;

        let y = 15;
        const x = 14;
        const line = () => { y += 5; doc.line(x, y, 200, y); y += 5; };
        const h1 = (text) => { doc.setFontSize(18); doc.text(text, x, y); y += 8; };
        const h2 = (text) => { doc.setFontSize(14); doc.setFont('helvetica', 'bold'); doc.text(text, x, y); y += 6; };
        const p = (text) => { doc.setFontSize(10); doc.setFont('helvetica', 'normal'); doc.text(text, x, y); y += 5; };
        const pair = (label, value) => {
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(label, x, y);
            doc.setFont('helvetica', 'normal');
            doc.text(value.toString(), x + 60, y);
            y += 6;
        };

        // Header
        h1(businessName || 'Bike Resell Report');
        p(`Report Generated: ${new Date().toLocaleString()}`);
        p(`Currency: ${currency}`);
        y += 5;

        // Capital Summary
        h2('Capital Summary');
        pair('Current Cash in Hand:', formatCurrency(analytics.currentCash, currency));
        pair('Total Net Profit (Sold):', formatCurrency(analytics.totalProfit, currency));
        pair('Total Unsold Investment:', formatCurrency(analytics.totalUnsoldInvestment, currency));
        y += 5;

        // Performance
        h2('Performance Metrics');
        pair('Average ROI:', `${analytics.averageROI.toFixed(2)}%`);
        pair('Average Days to Sell:', `${analytics.averageDaysToSell.toFixed(1)} days`);
        pair('Total Repair Costs:', formatCurrency(analytics.totalRepairCost, currency));
        pair('Inventory (Sold/Available):', `${analytics.inventoryCount.sold} / ${analytics.inventoryCount.available}`);
        y += 5;

        // Cash Flow
        h2('Cash Flow');
        pair('Total Inflow:', formatCurrency(analytics.cashFlow.inflow, currency));
        pair('Total Outflow:', formatCurrency(analytics.cashFlow.outflow, currency));
        pair('Net Flow:', formatCurrency(analytics.cashFlow.net, currency));
        y += 5;

        // Sold Bikes Table
        h2('Sold Bike Summary');
        const soldBikes = getAllBikes(data).filter(b => b.status === 'sold');
        if (soldBikes.length > 0) {
            const tableData = soldBikes.map(b => [
                b.plateNo,
                formatCurrency(b.totalCost, currency),
                formatCurrency(b.sellPrice, currency),
                formatCurrency(b.profit, currency),
                (b.profit / b.totalCost * 100).toFixed(1) + '%'
            ]);
            doc.autoTable({
                startY: y,
                head: [['Plate No', 'Total Cost', 'Sell Price', 'Profit', 'ROI']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [41, 128, 185] }
            });
            y = doc.autoTable.previous.finalY + 10;
        } else {
            p('No bikes sold yet.');
        }

        doc.save(`BikeReport_${businessName.replace(' ', '_') || ''}_${Date.now()}.pdf`);
        showToast('PDF report downloaded.', 'success');
    } catch (err) {
        console.error('PDF Export Error:', err);
        showToast('Failed to generate PDF. Is jsPDF loaded?', 'error');
    }
}

// --- Utils ---

function $(selector) {
    return document.querySelector(selector);
}

function $$(selector) {
    return Array.from(document.querySelectorAll(selector));
}

function formatCurrency(amount, currency = 'â‚¹') {
    try {
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR' // Default, 'currency' param is just for the symbol
        }).format(amount).replace('â‚¹', currency);
    } catch (e) {
        // Fallback for invalid currency codes
        return `${currency} ${amount.toFixed(2)}`;
    }
}

function escapeHTML(str) {
    if (str === null || str === undefined) return '';
    return str.toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

function getYearMonth(dateStr) {
    const date = new Date(dateStr);
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
}

function ensureMonthExists(data, yyyymm) {
    if (!data.months[yyyymm]) {
        data.months[yyyymm] = {
            bikes: [],
            transactions: [],
            capitalLedger: []
        };
    }
}

function getAllBikes(data) {
    return Object.values(data.months).flatMap(month => month.bikes);
}

function getAllTransactions(data) {
    return Object.values(data.months).flatMap(month => month.transactions);
}

function getAllLedgerEntries(data) {
    return Object.values(data.months).flatMap(month => month.capitalLedger);
}

function getCurrentCapital(data) {
    const allLedger = getAllLedgerEntries(data);
    if (allLedger.length === 0) return 0;
    
    // Find the latest entry
    allLedger.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
    
    return allLedger[0].balanceAfter;
}

function findBikeById(bikeId) {
    const allBikes = getAllBikes(appState.data);
    return allBikes.find(b => b.id === bikeId);
}

function getFilteredBikes() {
    let bikes = getAllBikes(appState.data);
    const { search, status, sort, dateFrom, dateTo, costMin, costMax, profitMin, profitMax } = appState.ui.filters;

    // Search
    if (search) {
        const s = search.toLowerCase();
        bikes = bikes.filter(b => 
            b.plateNo.toLowerCase().includes(s) ||
            b.model.toLowerCase().includes(s) ||
            b.ownerName.toLowerCase().includes(s)
        );
    }

    // Status Filter
    if (status && status !== 'all') {
        bikes = bikes.filter(b => b.status === status);
    }

    // Advanced Filters
    if (dateFrom) bikes = bikes.filter(b => new Date(b.purchaseDate) >= new Date(dateFrom));
    if (dateTo) bikes = bikes.filter(b => new Date(b.purchaseDate) <= new Date(dateTo));
    if (costMin) bikes = bikes.filter(b => b.totalCost >= costMin);
    if (costMax) bikes = bikes.filter(b => b.totalCost <= costMax);
    if (profitMin) bikes = bikes.filter(b => b.status === 'sold' && b.profit >= profitMin);
    if (profitMax) bikes = bikes.filter(b => b.status === 'sold' && b.profit <= profitMax);

    // Sort
    const [sortKey, sortDir] = sort.split('-');
    const dir = sortDir === 'asc' ? 1 : -1;
    
    bikes.sort((a, b) => {
        let valA, valB;
        switch (sortKey) {
            case 'purchaseDate':
                valA = new Date(a.purchaseDate).getTime();
                valB = new Date(b.purchaseDate).getTime();
                break;
            case 'profit':
                valA = a.profit !== null ? a.profit : -Infinity;
                valB = b.profit !== null ? b.profit : -Infinity;
                break;
            case 'totalCost':
                valA = a.totalCost;
                valB = b.totalCost;
                break;
            default:
                valA = 0;
                valB = 0;
        }
        return (valA - valB) * dir;
    });

    return bikes;
}

function getSelectedBikes() {
    const selectedIds = $$('.bike-select-checkbox:checked').map(cb => cb.dataset.bikeId);
    return getAllBikes(appState.data).filter(b => selectedIds.includes(b.id));
}

function downloadFile(content, fileName, mimeType) {
    const a = document.createElement('a');
    const blob = new Blob([content], { type: mimeType });
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
}

// --- PWA & Init ---

function registerManifest() {
    const manifest = {
      name: "Bike Resell Manager",
      short_name: "BikeResell",
      description: "Manage your bike reselling business, offline-first.",
      start_url: ".",
      display: "standalone",
      background_color: "#f4f4f5", // zinc-100
      theme_color: "#2563eb", // blue-600
      icons: [
        {
          "src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZyBmaWxsPSJub25lIiBzdHJva2U9IiMyNTYzZWIiIHN0cm9rZS13aWR0aD0iOCI+PGNpcmNsZSBjeD0iMzUiIGN5PSI2NSIgcj0iMjUiLz48Y2lyY2xlIGN4PSI2NSIgY3k9IjY1IiByPSIyNSIvPjxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgZD0iTTY1IDY1IDg1IDM1IE0zNSA2NSA1NSAzNSIvPjxwYXRoIGQ9Ik01NSAzNWgzMCIvPjwvZz48L3N2Zz4=",
          "sizes": "192x192",
          "type": "image/svg+xml"
        },
        {
          "src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZyBmaWxsPSJub25lIiBzdHJva2U9IiMyNTYzZWIiIHN0cm9rZS13aWR0aD0iOCI+PGNpcmNsZSBjeD0iMzUiIGN5PSI2NSIgcj0iMjUiLz48Y2lyY2xlIGN4PSI2NSIgY3k9IjY1IiByPSIyNSIvPjxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgZD0iTTY1IDY1IDg1IDM1IE0zNSA2NSA1NSAzNSIvPjxwYXRoIGQ9Ik01NSAzNWgzMCIvPjwvZz48L3N2Zz4=",
          "sizes": "512x512",
          "type": "image/svg+xml"
        }
      ]
    };
    const manifestString = JSON.stringify(manifest);
    // Use unencoded string for data URL as per some specs
    const manifestUrl = 'data:application/manifest+json,' + encodeURIComponent(manifestString);
    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = manifestUrl;
    document.head.appendChild(link);
}

function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        const swCode = `
          const CACHE_NAME = 'bike-resell-cache-v1';
          const APP_SHELL_URL = '/'; // Cache the root URL

          self.addEventListener('install', (event) => {
            event.waitUntil(
              caches.open(CACHE_NAME)
                .then((cache) => cache.add(APP_SHELL_URL))
                .then(() => self.skipWaiting())
            );
          });

          self.addEventListener('activate', (event) => {
            event.waitUntil(
              caches.keys().then((cacheNames) => {
                return Promise.all(
                  cacheNames.map((cacheName) => {
                    if (cacheName !== CACHE_NAME) {
                      return caches.delete(cacheName);
                    }
                  })
                );
              }).then(() => self.clients.claim())
            );
          });

          self.addEventListener('fetch', (event) => {
            const requestUrl = new URL(event.request.url);

            // Only handle navigation requests for the app shell
            if (event.request.mode === 'navigate' && requestUrl.origin === self.location.origin && requestUrl.pathname === '/') {
              event.respondWith(
                caches.match(APP_SHELL_URL)
                  .then((response) => {
                    // Return from cache, or fetch if not cached
                    return response || fetch(APP_SHELL_URL).then((fetchResponse) => {
                      // Cache the new response
                      return caches.open(CACHE_NAME).then((cache) => {
                        cache.put(APP_SHELL_URL, fetchResponse.clone());
                        return fetchResponse;
                      });
                    });
                  })
              );
            }
            // For other requests (e.g., GitHub API), let them pass through
            // return;
          });
        `;
        
        try {
            const swBlob = new Blob([swCode], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(swBlob))
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        } catch (e) {
            console.error('Error creating ServiceWorker blob: ', e);
        }
    }
}


/**
 * Main application initialization
 */
async function initApp() {
    console.log('Initializing Bike Resell Manager...');
    registerManifest();
    registerServiceWorker();

    try {
        db = await initDB();
        console.log('Database initialized.');

        let baseData = await getData('data');
        if (!baseData) {
            console.log('No local data found, initializing default structure.');
            baseData = getInitialData();
            await setData('data', baseData);
        } else {
            console.log('Loaded local data.');
        }

        await loadStateIntoApp(baseData); // This also renders the app
        attachEventListeners();
        
        // Trigger initial sync
        if (navigator.onLine) {
            await syncNow();
        } else {
            setSyncState('offline');
        }

    } catch (err) {
        console.error('Failed to initialize app:', err);
        document.body.innerHTML = `<div style="padding: 20px; text-align: center; color: red;">
            <h2>Fatal Error</h2>
            <p>Could not initialize the application database. Please try clearing your cache or using a different browser.</p>
            <pre>${err.message}</pre>
        </div>`;
    }
}

// Start the app
document.addEventListener('DOMContentLoaded', initApp);


</script>

</body>
</html>

