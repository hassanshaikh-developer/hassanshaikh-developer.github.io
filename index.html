<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,viewport-fit=cover">
<meta name="theme-color" content="#2563eb">
<meta name="description" content="Secure bike sales & credit tracker with offline support">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' blob: data:; connect-src 'self'; font-src 'self' data:; manifest-src 'self'; worker-src 'self';">
<title>Bike Manager</title>
<link rel="manifest" href="./manifest.webmanifest">
<link rel="icon" href="./icons/icon-192.png" type="image/png">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="mobile-web-app-capable" content="yes">
<style>
*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}:after,:before{--tw-content:""}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal}body{margin:0;line-height:inherit;font-family:Inter,sans-serif;overscroll-behavior:none}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]{display:none}
:root{--bg-primary:#ffffff;--bg-secondary:#f9fafb;--bg-tertiary:#f3f4f6;--text-primary:#111827;--text-secondary:#6b7280;--border-primary:#e5e7eb;--blue-500:#3b82f6;--blue-600:#2563eb;--blue-700:#1d4ed8;--blue-50:#eff6ff;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-500:#6b7280;--gray-700:#374151;--gray-800:#1f2937;--gray-900:#111827;--green-500:#10b981;--green-600:#059669;--red-500:#ef4444;--red-600:#dc2626;--amber-500:#f59e0b;--amber-600:#d97706;--shadow-sm:0 1px 2px 0 rgba(0,0,0,.05);--shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px -1px rgba(0,0,0,.1);--shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);--shadow-xl:0 20px 25px -5px rgba(0,0,0,.1),0 8px 10px -6px rgba(0,0,0,.1)}
body{background:#e5e7eb;color:var(--text-primary)}
.hidden{display:none!important}
.flex{display:flex}.inline-flex{display:inline-flex}.grid{display:grid}
.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}
.items-center{align-items:center}.items-stretch{align-items:stretch}
.justify-between{justify-content:space-between}.justify-center{justify-content:center}
.gap-1{gap:.25rem}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}
.space-y-2>*+*{margin-top:.5rem}.space-y-3>*+*{margin-top:.75rem}.space-y-4>*+*{margin-top:1rem}
.fixed{position:fixed}.relative{position:relative}.absolute{position:absolute}.sticky{position:sticky}
.inset-0{inset:0}.inset-x-0{left:0;right:0}.top-0{top:0}.bottom-0{bottom:0}.left-0{left:0}.right-0{right:0}.z-10{z-index:10}.z-20{z-index:20}.z-30{z-index:30}.z-40{z-index:40}.z-50{z-index:50}
.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.overflow-x-hidden{overflow-x:hidden}
.rounded{border-radius:.25rem}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.rounded-2xl{border-radius:1rem}.rounded-full{border-radius:9999px}
.border{border-width:1px}.border-t{border-top-width:1px}.border-b{border-bottom-width:1px}
.border-gray-200{border-color:var(--gray-200)}.border-gray-300{border-color:var(--gray-300)}
.bg-white{background-color:var(--bg-primary)}.bg-gray-50{background-color:#f9fafb}.bg-gray-100{background-color:var(--gray-100)}.bg-gray-200{background-color:var(--gray-200)}.bg-blue-50{background-color:var(--blue-50)}.bg-blue-500{background-color:var(--blue-500)}.bg-blue-600{background-color:var(--blue-600)}.bg-green-500{background-color:var(--green-500)}.bg-green-50{background-color:#ecfdf5}.bg-red-500{background-color:var(--red-500)}.bg-amber-50{background-color:#fffbeb}.bg-amber-500{background-color:var(--amber-500)}
.p-2{padding:.5rem}.p-3{padding:.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}
.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}
.pt-20{padding-top:5rem}.pb-24{padding-bottom:6rem}.pt-24{padding-top:6rem}.pb-28{padding-bottom:7rem}
.text-xs{font-size:.75rem;line-height:1rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}
.font-medium{font-weight:500}.font-semibold{font-weight:600}.font-bold{font-weight:700}
.text-gray-500{color:var(--gray-500)}.text-gray-600{color:var(--gray-700)}.text-gray-700{color:var(--gray-700)}.text-gray-800{color:var(--gray-800)}.text-gray-900{color:var(--gray-900)}.text-white{color:#fff}.text-blue-500{color:var(--blue-500)}.text-blue-600{color:var(--blue-600)}.text-blue-700{color:var(--blue-700)}.text-green-600{color:var(--green-600)}.text-red-500{color:var(--red-500)}.text-red-600{color:var(--red-600)}.text-amber-600{color:var(--amber-600)}
.shadow-sm{box-shadow:var(--shadow-sm)}.shadow{box-shadow:var(--shadow)}.shadow-lg{box-shadow:var(--shadow-lg)}.shadow-xl{box-shadow:var(--shadow-xl)}
.opacity-50{opacity:.5}.opacity-60{opacity:.6}
.transition{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}
.cursor-pointer{cursor:pointer}.cursor-not-allowed{cursor:not-allowed}
.select-none{user-select:none}
.w-full{width:100%}.w-auto{width:auto}.w-6{width:1.5rem}.w-7{width:1.75rem}.w-8{width:2rem}.h-6{height:1.5rem}.h-7{height:1.75rem}.h-8{height:2rem}.min-h-screen{min-height:100vh}.max-w-xs{max-width:20rem}.max-w-2xl{max-width:42rem}.max-w-6xl{max-width:72rem}.max-h-40{max-height:10rem}.max-h-96{max-height:24rem}
.mx-auto{margin-left:auto;margin-right:auto}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.ml-2{margin-left:.5rem}.mr-2{margin-right:.5rem}
.backdrop-blur-sm{backdrop-filter:blur(4px)}
button:disabled{opacity:.5;cursor:not-allowed}button:not(:disabled):hover{opacity:.9}
.form-input{width:100%;padding:12px;background:var(--gray-100);border-radius:10px;border:1px solid var(--gray-100);font-size:16px;transition:all .2s ease;color:var(--text-primary)}.form-input:focus{outline:none;border-color:var(--blue-500);background:var(--bg-primary);box-shadow:0 0 0 2px #bfdbfe}
.form-label{display:block;font-size:13px;font-weight:500;color:var(--gray-500);margin-bottom:6px;padding-left:4px}
.btn-primary{padding:.75rem 1.5rem;background:var(--blue-500);color:#fff;border-radius:.5rem;font-weight:600;transition:background .2s;box-shadow:var(--shadow-sm)}.btn-primary:hover:not(:disabled){background:var(--blue-600)}
.btn-secondary{padding:.75rem 1.5rem;background:var(--bg-primary);color:var(--blue-600);border:1px solid var(--blue-500);border-radius:.5rem;font-weight:600;transition:all .2s}.btn-secondary:hover:not(:disabled){background:var(--blue-50)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:40;transition:opacity .3s;opacity:0;pointer-events:none}.modal-overlay.open{opacity:1;pointer-events:auto}
.modal-sheet{position:fixed;bottom:0;left:0;right:0;background:var(--bg-primary);border-radius:1.5rem 1.5rem 0 0;padding:1.5rem;z-index:50;transform:translateY(100%);transition:transform .3s ease-out;max-height:90vh;overflow-y:auto}.modal-sheet.open{transform:translateY(0)}
.segmented-control{display:flex;background:#e9e9eb;border-radius:9px;padding:2px}.segmented-control button{flex:1;padding:5px 10px;border:none;background:transparent;color:#555;font-size:13px;font-weight:500;border-radius:7px;transition:all .2s}.segmented-control button.active{background:#fff;color:#000;box-shadow:0 1px 4px rgba(0,0,0,.1)}
.nav-item{display:flex;flex-direction:column;align-items:center;padding:.5rem;color:var(--gray-500);transition:color .2s;cursor:pointer;flex:1;gap:.25rem}.nav-item.active{color:var(--blue-600)}.nav-item svg{width:1.5rem;height:1.5rem}.nav-item span{font-size:.75rem;font-weight:500}
.sensitive-mask{filter:blur(6px);opacity:.5;pointer-events:none;user-select:none}
.lock-button{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:9999px;border:1px solid rgba(59,130,246,.3);background:rgba(219,234,254,.6);color:var(--blue-600);font-size:14px;transition:all .2s}.lock-button:hover{background:rgba(37,99,235,.1)}.lock-button.locked{background:rgba(248,113,113,.15);border-color:rgba(248,113,113,.35);color:var(--red-600)}
.bike-card{background:var(--bg-primary);border-radius:1rem;padding:1rem;box-shadow:var(--shadow-sm);transition:all .2s;border:2px solid transparent}.bike-card:hover{box-shadow:var(--shadow);transform:translateY(-2px)}.bike-card.clearance{border-color:#f59e0b;background:#fffbeb}
.toast{position:fixed;bottom:6rem;left:50%;transform:translateX(-50%);background:var(--gray-900);color:#fff;padding:1rem 1.5rem;border-radius:.75rem;box-shadow:var(--shadow-xl);z-index:100;max-width:90%;animation:slideUp .3s ease-out}@keyframes slideUp{from{opacity:0;transform:translate(-50%,20px)}to{opacity:1;transform:translate(-50%,0)}}
.page{display:none}.page.active{display:block}
.icon{width:1.25rem;height:1.25rem;stroke:currentColor;stroke-width:2;fill:none;stroke-linecap:round;stroke-linejoin:round}
#app-wrapper{display:flex;flex-direction:column;min-height:100vh;max-width:72rem;margin:0 auto;background:var(--bg-secondary);box-shadow:var(--shadow-xl)}
@media(min-width:1024px){#app-wrapper{border-radius:1.5rem;overflow:hidden;margin-top:1rem;margin-bottom:1rem}}
#loader{position:fixed;inset:0;background:var(--bg-primary);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:1rem}
.spinner{width:3rem;height:3rem;border:3px solid var(--gray-200);border-top-color:var(--blue-500);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}input[type=number]{-moz-appearance:textfield;appearance:textfield}
.camera-container{position:fixed;inset:0;z-index:9999;background:#000;display:flex;flex-direction:column}
.camera-preview{flex:1;position:relative;overflow:hidden}.camera-preview video{width:100%;height:100%;object-fit:cover}
.camera-controls{background:rgba(0,0,0,.8);padding:1.5rem;display:flex;gap:1rem;justify-content:center;align-items:center}
.camera-btn{width:4rem;height:4rem;border-radius:50%;border:3px solid #fff;background:var(--blue-500);display:flex;align-items:center;justify-content:center;color:#fff;cursor:pointer;transition:transform .2s}.camera-btn:active{transform:scale(.95)}
.image-thumbnail{width:4rem;height:4rem;border-radius:.5rem;object-fit:cover;border:2px solid var(--border-primary);cursor:pointer;transition:all .2s}.image-thumbnail:hover{transform:scale(1.05);box-shadow:var(--shadow-lg)}
@media(prefers-reduced-motion:reduce){*{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}}
</style>
</head>
<body>
<div id="loader">
<div class="spinner"></div>
<p class="text-gray-500 text-sm">Loading Bike Manager...</p>
</div>

<div id="app-wrapper" class="hidden">
<header class="bg-white backdrop-blur-sm border-b border-gray-200 fixed inset-x-0 top-0 z-30">
<div class="max-w-6xl mx-auto px-4 py-4 flex gap-3 justify-between items-center">
<h1 id="page-title" class="text-xl font-bold text-gray-900">Dashboard</h1>
<div class="flex items-center gap-3">
<button id="pwa-install-btn" class="px-3 py-2 rounded-lg bg-blue-500 text-white text-xs font-semibold shadow-sm hidden" type="button">Install</button>
<button id="update-check-btn" class="px-3 py-2 rounded-lg bg-gray-100 text-gray-700 text-xs font-semibold hidden" type="button" title="Check for updates">
<svg class="icon" viewBox="0 0 24 24"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
</button>
<button id="lock-toggle" class="lock-button locked" title="Unlock sensitive data" aria-pressed="false" aria-label="Lock toggle">
<svg class="icon" viewBox="0 0 24 24"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
</button>
<button id="add-btn" class="text-blue-500 hidden" title="Add new" aria-label="Add new item">
<svg class="icon w-7 h-7" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
</button>
</div>
</div>
</header>

<main class="flex-1 overflow-y-auto pt-24 pb-28 px-4">

<div id="page-dashboard" class="page active space-y-4">
<div class="grid grid-cols-2 gap-4">
<div class="bg-white rounded-2xl p-4 shadow-sm">
<span class="text-sm font-medium text-gray-500">Cash</span>
<div class="text-2xl font-bold text-gray-900 mt-1 sensitive-mask" data-sensitive="currency">₹0</div>
</div>
<div class="bg-white rounded-2xl p-4 shadow-sm">
<span class="text-sm font-medium text-gray-500">Revenue</span>
<div class="text-2xl font-bold text-gray-900 mt-1 sensitive-mask" data-sensitive="currency">₹0</div>
</div>
<div class="bg-white rounded-2xl p-4 shadow-sm">
<span class="text-sm font-medium text-gray-500">Profit</span>
<div class="text-2xl font-bold text-gray-900 mt-1 sensitive-mask" data-sensitive="currency">₹0</div>
</div>
<div class="bg-white rounded-2xl p-4 shadow-sm">
<span class="text-sm font-medium text-gray-500">Inventory</span>
<div class="text-2xl font-bold text-gray-900 mt-1">0/0</div>
</div>
</div>
<div id="dashboard-bikes" class="bg-white rounded-2xl p-4 shadow-sm space-y-3"></div>
</div>

<div id="page-bikes" class="page space-y-4">
<div class="bg-white rounded-2xl p-4 shadow-sm space-y-3">
<input type="search" id="bike-search" class="form-input" placeholder="Search bikes..." autocomplete="off">
<div class="segmented-control">
<button data-filter="all" class="active">All</button>
<button data-filter="unsold">Unsold</button>
<button data-filter="sold">Sold</button>
</div>
<button id="camera-btn" class="btn-primary w-full">
<svg class="icon inline" viewBox="0 0 24 24"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
<span class="ml-2">Add Photos</span>
</button>
</div>
<div id="bike-list" class="space-y-3"></div>
</div>

<div id="page-credit" class="page space-y-4">
<div class="bg-white rounded-2xl p-4 shadow-sm space-y-3">
<div class="grid grid-cols-2 gap-3">
<div class="bg-blue-50 rounded-xl p-3">
<p class="text-xs text-blue-600 font-medium uppercase">Total</p>
<p class="text-xl font-bold text-blue-900 mt-1 sensitive-mask" data-sensitive="currency">₹0</p>
</div>
<div class="bg-green-50 rounded-xl p-3">
<p class="text-xs text-green-600 font-medium uppercase">Collected</p>
<p class="text-xl font-bold text-green-600 mt-1 sensitive-mask" data-sensitive="currency">₹0</p>
</div>
</div>
</div>
<div id="credit-list" class="space-y-3"></div>
</div>

<div id="page-analytics" class="page space-y-4">
<div class="bg-white rounded-2xl p-4 shadow-sm">
<h2 class="text-lg font-semibold mb-3">Analytics</h2>
<p class="text-gray-500 text-sm">Coming soon: Charts and insights</p>
</div>
</div>

<div id="page-settings" class="page space-y-4">
<div class="bg-white rounded-2xl p-4 shadow-sm space-y-4">
<h2 class="text-lg font-semibold">Security Settings</h2>
<button id="setup-pin-btn" class="btn-secondary w-full">Setup PIN</button>
<button id="setup-biometric-btn" class="btn-secondary w-full">Enable Biometric</button>
<div class="border-t border-gray-200 pt-4">
<h3 class="font-semibold mb-2">Backup & Restore</h3>
<button id="backup-btn" class="btn-primary w-full mb-2">Export Backup</button>
<button id="restore-btn" class="btn-secondary w-full">Import Backup</button>
</div>
<div class="border-t border-gray-200 pt-4">
<h3 class="font-semibold mb-2">Storage</h3>
<p id="storage-info" class="text-sm text-gray-500">Calculating...</p>
</div>
<button id="clear-all-btn" class="btn-secondary w-full text-red-600">Clear All Data</button>
</div>
</div>

</main>

<nav class="bg-white border-t border-gray-200 fixed inset-x-0 bottom-0 z-30" role="navigation" aria-label="Main navigation">
<div class="max-w-6xl mx-auto flex">
<div class="nav-item active" data-page="dashboard">
<svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
<span>Home</span>
</div>
<div class="nav-item" data-page="bikes">
<svg class="icon" viewBox="0 0 24 24"><circle cx="18.5" cy="17.5" r="3.5"/><circle cx="5.5" cy="17.5" r="3.5"/><circle cx="15" cy="5" r="1"/><path d="M12 17.5V14l-3-3 4-3 2 3h2"/></svg>
<span>Bikes</span>
</div>
<div class="nav-item" data-page="credit">
<svg class="icon" viewBox="0 0 24 24"><rect width="20" height="14" x="2" y="5" rx="2"/><path d="M2 10h20"/></svg>
<span>Credit</span>
</div>
<div class="nav-item" data-page="analytics">
<svg class="icon" viewBox="0 0 24 24"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>
<span>Stats</span>
</div>
<div class="nav-item" data-page="settings">
<svg class="icon" viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
<span>Settings</span>
</div>
</div>
</nav>
</div>

<div id="modal-overlay" class="modal-overlay"></div>
<div id="modal-sheet" class="modal-sheet"></div>

<div id="camera-container" class="camera-container hidden">
<div class="camera-preview">
<video id="camera-video" autoplay playsinline></video>
<canvas id="camera-canvas" class="hidden"></canvas>
</div>
<div class="camera-controls">
<button id="camera-close" class="px-4 py-2 bg-gray-700 text-white rounded-lg">Close</button>
<button id="camera-capture" class="camera-btn">
<svg class="icon w-8 h-8" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>
</button>
<button id="camera-switch" class="px-4 py-2 bg-gray-700 text-white rounded-lg">
<svg class="icon" viewBox="0 0 24 24"><path d="M21 2H3v16h5v4l4-4h5l4-4V2zM11 11V7h2v4h-2zm0 4h2v-2h-2v2z"/></svg>
</button>
</div>
<div id="camera-thumbnails" class="flex gap-2 px-4 pb-4 overflow-x-auto"></div>
</div>

<input type="file" id="file-input" accept="image/*" multiple class="hidden">
<input type="file" id="backup-file-input" accept=".json,.enc.json" class="hidden">

<script type="module">
const APP_VERSION='1.0.0',DB_NAME='BikeManagerDB',DB_VERSION=1;let db=null,sessionKey=null,isLocked=!0,lockTimeout=null,capturedImages=[];

// Utility Functions
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
const uuid=()=>crypto.randomUUID();
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const showToast=(msg,duration=3000)=>{const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),duration)};

// Database Module (IndexedDB)
const DB={
async init(){return new Promise((resolve,reject)=>{const req=indexedDB.open(DB_NAME,DB_VERSION);req.onerror=()=>reject(req.error);req.onsuccess=()=>{db=req.result;resolve(db)};req.onupgradeneeded=e=>{const database=e.target.result;if(!database.objectStoreNames.contains('bikes')){const bikesStore=database.createObjectStore('bikes',{keyPath:'id'});bikesStore.createIndex('sold','sold');bikesStore.createIndex('createdAt','createdAt');bikesStore.createIndex('isSensitive','isSensitive')}
if(!database.objectStoreNames.contains('credit')){const creditStore=database.createObjectStore('credit',{keyPath:'id'});creditStore.createIndex('customerId','customerId');creditStore.createIndex('isPaid','isPaid')}
if(!database.objectStoreNames.contains('images')){database.createObjectStore('images',{keyPath:'id'})}
if(!database.objectStoreNames.contains('settings')){database.createObjectStore('settings',{keyPath:'key'})}
if(!database.objectStoreNames.contains('auth')){database.createObjectStore('auth',{keyPath:'key'})}}})},
async getAll(storeName){const tx=db.transaction(storeName,'readonly');const store=tx.objectStore(storeName);return new Promise((resolve,reject)=>{const req=store.getAll();req.onsuccess=()=>resolve(req.result);req.onerror=()=>reject(req.error)})},
async get(storeName,key){const tx=db.transaction(storeName,'readonly');const store=tx.objectStore(storeName);return new Promise((resolve,reject)=>{const req=store.get(key);req.onsuccess=()=>resolve(req.result);req.onerror=()=>reject(req.error)})},
async put(storeName,data){const tx=db.transaction(storeName,'readwrite');const store=tx.objectStore(storeName);return new Promise((resolve,reject)=>{const req=store.put(data);req.onsuccess=()=>resolve(req.result);req.onerror=()=>reject(req.error)})},
async delete(storeName,key){const tx=db.transaction(storeName,'readwrite');const store=tx.objectStore(storeName);return new Promise((resolve,reject)=>{const req=store.delete(key);req.onsuccess=()=>resolve(req.result);req.onerror=()=>reject(req.error)})},
async clear(storeName){const tx=db.transaction(storeName,'readwrite');const store=tx.objectStore(storeName);return new Promise((resolve,reject)=>{const req=store.clear();req.onsuccess=()=>resolve(req.result);req.onerror=()=>reject(req.error)})}
};

// Crypto Module (WebCrypto API)
const Crypto={
async deriveKey(pin,salt){const enc=new TextEncoder();const keyMaterial=await crypto.subtle.importKey('raw',enc.encode(pin),{name:'PBKDF2'},false,['deriveBits','deriveKey']);return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:250000,hash:'SHA-256'},keyMaterial,{name:'AES-GCM',length:256},true,['encrypt','decrypt'])},
async encrypt(data,key){const iv=crypto.getRandomValues(new Uint8Array(12));const enc=new TextEncoder();const encrypted=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,enc.encode(JSON.stringify(data)));return{iv:Array.from(iv),data:Array.from(new Uint8Array(encrypted))}},
async decrypt(encryptedData,key){const dec=new TextDecoder();const decrypted=await crypto.subtle.decrypt({name:'AES-GCM',iv:new Uint8Array(encryptedData.iv)},key,new Uint8Array(encryptedData.data));return JSON.parse(dec.decode(decrypted))},
async hash(data){const enc=new TextEncoder();const hashBuffer=await crypto.subtle.digest('SHA-256',enc.encode(data));return Array.from(new Uint8Array(hashBuffer)).map(b=>b.toString(16).padStart(2,'0')).join('')},
randomSalt:()=>Array.from(crypto.getRandomValues(new Uint8Array(16)))
};

// Auth Module (PIN + WebAuthn)
const Auth={
async setupPIN(pin){if(!/^\d{4,12}$/.test(pin)){throw new Error('PIN must be 4-12 digits')}
const salt=Crypto.randomSalt();const key=await Crypto.deriveKey(pin,new Uint8Array(salt));const hash=await Crypto.hash(pin);await DB.put('auth',{key:'pin',hash,salt});sessionKey=key;isLocked=false;showToast('PIN setup complete');return true},
async verifyPIN(pin){const stored=await DB.get('auth','pin');if(!stored){throw new Error('No PIN configured')}
const hash=await Crypto.hash(pin);if(hash!==stored.hash){throw new Error('Invalid PIN')}
sessionKey=await Crypto.deriveKey(pin,new Uint8Array(stored.salt));isLocked=false;UI.updateLockState();showToast('Unlocked');Auth.resetLockTimeout();return true},
async setupBiometric(){if(!window.PublicKeyCredential){throw new Error('WebAuthn not supported')}
const challenge=crypto.getRandomValues(new Uint8Array(32));const credential=await navigator.credentials.create({publicKey:{challenge,rp:{name:'Bike Manager',id:window.location.hostname},user:{id:crypto.getRandomValues(new Uint8Array(16)),name:'user@bikemanager',displayName:'Bike Manager User'},pubKeyCredParams:[{type:'public-key',alg:-7},{type:'public-key',alg:-257}],authenticatorSelection:{authenticatorAttachment:'platform',userVerification:'required'},timeout:60000,attestation:'none'}});
await DB.put('auth',{key:'webauthn',credentialId:Array.from(new Uint8Array(credential.rawId)),publicKey:credential.response.getPublicKey?Array.from(new Uint8Array(credential.response.getPublicKey())):null});showToast('Biometric auth enabled');return true},
async verifyBiometric(){const stored=await DB.get('auth','webauthn');if(!stored){throw new Error('Biometric not configured')}
const challenge=crypto.getRandomValues(new Uint8Array(32));const assertion=await navigator.credentials.get({publicKey:{challenge,allowCredentials:[{type:'public-key',id:new Uint8Array(stored.credentialId)}],userVerification:'required',timeout:60000}});
isLocked=false;UI.updateLockState();showToast('Unlocked with biometric');Auth.resetLockTimeout();return true},
lock(){isLocked=true;sessionKey=null;UI.updateLockState();clearTimeout(lockTimeout)},
resetLockTimeout(){clearTimeout(lockTimeout);lockTimeout=setTimeout(()=>Auth.lock(),300000)}
};

// Camera Module (with Image Processing)
const Camera={
stream:null,facingMode:'environment',maxDimension:1920,
async open(){try{const container=$('#camera-container');container.classList.remove('hidden');this.stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:this.facingMode,width:{ideal:1920},height:{ideal:1080}},audio:false});$('#camera-video').srcObject=this.stream}catch(e){showToast('Camera access denied');throw e}},
async capture(){const video=$('#camera-video'),canvas=$('#camera-canvas');let width=video.videoWidth,height=video.videoHeight;if(width>this.maxDimension||height>this.maxDimension){const ratio=Math.min(this.maxDimension/width,this.maxDimension/height);width=Math.floor(width*ratio);height=Math.floor(height*ratio)}
canvas.width=width;canvas.height=height;const ctx=canvas.getContext('2d');ctx.drawImage(video,0,0,width,height);const formats=['image/webp','image/jpeg'];let blob=null;for(const format of formats){try{blob=await new Promise(resolve=>canvas.toBlob(resolve,format,.85));if(blob)break}catch(e){continue}}
if(!blob){showToast('Image capture failed');return}
const id=uuid();const objURL=URL.createObjectURL(blob);capturedImages.push({id,blob,url:objURL,width,height,type:blob.type,size:blob.size,createdAt:new Date().toISOString()});this.updateThumbnails();showToast(`Captured ${capturedImages.length} photo(s)`)},
updateThumbnails(){const container=$('#camera-thumbnails');container.innerHTML='';capturedImages.forEach((img,idx)=>{const thumb=document.createElement('img');thumb.src=img.url;thumb.className='image-thumbnail';thumb.onclick=()=>this.removeImage(idx);container.appendChild(thumb)})},
removeImage(idx){URL.revokeObjectURL(capturedImages[idx].url);capturedImages.splice(idx,1);this.updateThumbnails();showToast('Photo removed')},
async saveImages(bikeId){for(const img of capturedImages){const arrayBuffer=await img.blob.arrayBuffer();await DB.put('images',{id:img.id,bikeId,data:arrayBuffer,type:img.type,width:img.width,height:img.height,size:img.size,createdAt:img.createdAt})}
this.clearImages();showToast(`${capturedImages.length} images saved`)},
clearImages(){capturedImages.forEach(img=>URL.revokeObjectURL(img.url));capturedImages=[];this.updateThumbnails()},
close(){if(this.stream){this.stream.getTracks().forEach(t=>t.stop());this.stream=null}
this.clearImages();$('#camera-container').classList.add('hidden')},
async switchCamera(){this.facingMode=this.facingMode==='environment'?'user':'environment';this.close();await this.open()}
};

// Backup Module (Encrypted with Compression)
const Backup={
async export(){try{if(!sessionKey){showToast('Please unlock first');return}
const bikes=await DB.getAll('bikes');const credit=await DB.getAll('credit');const settings=await DB.getAll('settings');const images=await DB.getAll('images');const data={version:1,timestamp:new Date().toISOString(),bikes,credit,settings,imageCount:images.length};const json=JSON.stringify(data);const compressed=await this.compress(json);const salt=Crypto.randomSalt();const key=sessionKey||await Crypto.deriveKey('temp',new Uint8Array(salt));const encrypted=await Crypto.encrypt(compressed,key);const checksum=await Crypto.hash(json);const backup={version:1,kdf:'PBKDF2-HMAC-SHA-256',iterations:250000,cipher:'AES-GCM',salt,iv:encrypted.iv,data:encrypted.data,checksum,compressed:true};const backupJson=JSON.stringify(backup);const blob=new Blob([backupJson],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`bike-manager-backup-${new Date().toISOString().split('T')[0]}.enc.json`;a.click();URL.revokeObjectURL(url);showToast('Encrypted backup exported')}catch(e){showToast('Backup failed: '+e.message);console.error(e)}},
async import(file){try{const text=await file.text();const backup=JSON.parse(text);if(!backup.version||!backup.data){throw new Error('Invalid backup format')}
if(!sessionKey){const pin=prompt('Enter PIN to decrypt backup:');if(!pin)return;const stored=await DB.get('auth','pin');if(!stored){showToast('No PIN configured');return}
sessionKey=await Crypto.deriveKey(pin,new Uint8Array(stored.salt))}
const decrypted=await Crypto.decrypt({iv:backup.iv,data:backup.data},sessionKey);const json=backup.compressed?await this.decompress(decrypted):decrypted;const data=JSON.parse(json);if(backup.checksum){const checksum=await Crypto.hash(json);if(checksum!==backup.checksum){throw new Error('Checksum mismatch - data may be corrupted')}}
const action=confirm(`Import ${data.bikes?.length||0} bikes and ${data.credit?.length||0} credit records?\n\nOK = Replace all data\nCancel = Abort`);if(!action)return;
await DB.clear('bikes');await DB.clear('credit');if(data.bikes)for(const b of data.bikes)await DB.put('bikes',b);if(data.credit)for(const c of data.credit)await DB.put('credit',c);if(data.settings)for(const s of data.settings)await DB.put('settings',s);showToast('Backup imported successfully');await UI.render()}catch(e){showToast('Import failed: '+e.message);console.error(e)}},
async compress(str){if(!window.CompressionStream)return str;const stream=new Blob([str]).stream().pipeThrough(new CompressionStream('gzip'));const compressed=await new Response(stream).arrayBuffer();return Array.from(new Uint8Array(compressed))},
async decompress(arr){if(!window.DecompressionStream)return arr;const stream=new Blob([new Uint8Array(arr)]).stream().pipeThrough(new DecompressionStream('gzip'));const decompressed=await new Response(stream).text();return decompressed}
};

// PWA Module
const PWA={
deferredPrompt:null,
init(){window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();this.deferredPrompt=e;$('#pwa-install-btn').classList.remove('hidden')});
if('serviceWorker'in navigator){navigator.serviceWorker.register('./sw.js').then(reg=>{console.log('SW registered:',reg.scope);reg.addEventListener('updatefound',()=>{const newWorker=reg.installing;newWorker.addEventListener('statechange',()=>{if(newWorker.state==='installed'&&navigator.serviceWorker.controller){showToast('Update available! Refresh to update.');$('#update-check-btn').classList.remove('hidden')}})})}).catch(err=>console.error('SW registration failed:',err))}
this.checkStandalone()},
async install(){if(!this.deferredPrompt)return showToast('Already installed or not installable');
this.deferredPrompt.prompt();const{outcome}=await this.deferredPrompt.userChoice;if(outcome==='accepted'){showToast('App installed!');$('#pwa-install-btn').classList.add('hidden')}
this.deferredPrompt=null},
checkStandalone(){if(window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone){$('#pwa-install-btn').classList.add('hidden')}},
async checkForUpdates(){if('serviceWorker'in navigator){const reg=await navigator.serviceWorker.getRegistration();if(reg){await reg.update();showToast('Checking for updates...')}}}
};

// UI Module
const UI={
currentPage:'dashboard',
async init(){this.bindEvents();await this.loadSettings();await this.render();PWA.init();$('#loader').style.display='none';$('#app-wrapper').classList.remove('hidden')},
bindEvents(){$$('.nav-item').forEach(item=>{item.onclick=()=>this.navigate(item.dataset.page)});
$('#lock-toggle').onclick=()=>this.handleLock();
$('#add-btn').onclick=()=>this.handleAdd();
$('#camera-btn').onclick=()=>Camera.open();
$('#camera-close').onclick=()=>Camera.close();
$('#camera-capture').onclick=()=>Camera.capture();
$('#camera-switch').onclick=()=>Camera.switchCamera();
$('#setup-pin-btn').onclick=()=>this.showPINSetup();
$('#setup-biometric-btn').onclick=()=>this.setupBiometric();
$('#backup-btn').onclick=()=>Backup.export();
$('#restore-btn').onclick=()=>$('#backup-file-input').click();
$('#backup-file-input').onchange=e=>{const file=e.target.files[0];if(file)Backup.import(file)};
$('#pwa-install-btn').onclick=()=>PWA.install();
$('#update-check-btn').onclick=()=>PWA.checkForUpdates();
$('#clear-all-btn').onclick=()=>this.clearAllData();
$$('.segmented-control button').forEach(btn=>{btn.onclick=()=>{btn.parentElement.querySelector('.active')?.classList.remove('active');btn.classList.add('active');this.render()}});
$('#bike-search').oninput=()=>this.render()},
navigate(page){this.currentPage=page;$$('.page').forEach(p=>p.classList.remove('active'));$(`#page-${page}`).classList.add('active');$$('.nav-item').forEach(i=>i.classList.remove('active'));$(`.nav-item[data-page="${page}"]`).classList.add('active');const titles={dashboard:'Dashboard',bikes:'Bikes',credit:'Credit',analytics:'Analytics',settings:'Settings'};$('#page-title').textContent=titles[page]||page;$('#add-btn').classList.toggle('hidden',page!=='bikes'&&page!=='credit')},
async render(){if(this.currentPage==='dashboard')await this.renderDashboard();
if(this.currentPage==='bikes')await this.renderBikes();
if(this.currentPage==='credit')await this.renderCredit();
await this.updateStorageInfo()},
async renderDashboard(){const bikes=await DB.getAll('bikes');const sold=bikes.filter(b=>b.sold);const unsold=bikes.filter(b=>!b.sold);const totalRevenue=sold.reduce((sum,b)=>sum+(b.salePrice||0),0);const totalCost=sold.reduce((sum,b)=>sum+(b.purchasePrice||0)+(b.repairCost||0),0);const profit=totalRevenue-totalCost;const cash=sold.reduce((sum,b)=>sum+(b.salePrice||0)-(b.creditAmount||0),0);const metrics=[{el:$('#page-dashboard .bg-white:nth-child(1) .text-2xl'),val:cash},{el:$('#page-dashboard .bg-white:nth-child(2) .text-2xl'),val:totalRevenue},{el:$('#page-dashboard .bg-white:nth-child(3) .text-2xl'),val:profit},{el:$('#page-dashboard .bg-white:nth-child(4) .text-2xl'),val:`${sold.length}/${bikes.length}`,isCurrency:false}];
metrics.forEach(m=>{if(m.el){m.el.textContent=m.isCurrency===false?m.val:`₹${m.val.toLocaleString('en-IN')}`;if(m.el.classList.contains('sensitive-mask')&&isLocked){m.el.textContent='••••'}}});
const container=$('#dashboard-bikes');container.innerHTML='<h2 class="text-lg font-semibold mb-2">Recent Bikes</h2>';unsold.slice(0,5).forEach(bike=>{const card=document.createElement('div');card.className='bike-card';card.innerHTML=`<div class="flex justify-between items-center"><div><p class="font-semibold">${bike.name||'Unnamed'}</p><p class="text-sm text-gray-500">₹${(bike.purchasePrice||0).toLocaleString('en-IN')}</p></div><button class="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm">View</button></div>`;container.appendChild(card)})},
async renderBikes(){const bikes=await DB.getAll('bikes');const filter=$('.segmented-control .active')?.dataset.filter||'all';const search=$('#bike-search').value.toLowerCase();const filtered=bikes.filter(b=>{if(filter==='sold'&&!b.sold)return false;if(filter==='unsold'&&b.sold)return false;if(search&&!(b.name||'').toLowerCase().includes(search))return false;return true});
const container=$('#bike-list');container.innerHTML='';if(filtered.length===0){container.innerHTML='<p class="text-center text-gray-500 py-8">No bikes found</p>';return}
filtered.forEach(bike=>{const card=document.createElement('div');card.className='bike-card';const status=bike.sold?'<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-semibold">Sold</span>':'<span class="px-2 py-1 bg-amber-100 text-amber-700 rounded text-xs font-semibold">Unsold</span>';card.innerHTML=`<div class="flex justify-between items-start mb-2"><div><p class="font-semibold text-lg">${bike.name||'Unnamed Bike'}</p><p class="text-sm text-gray-500">${bike.brand||''} ${bike.model||''}</p></div>${status}</div><div class="grid grid-cols-2 gap-2 text-sm"><div><span class="text-gray-500">Purchase:</span> <span class="font-semibold ${isLocked&&bike.isSensitive?'sensitive-mask':''}">${isLocked&&bike.isSensitive?'••••':'₹'+(bike.purchasePrice||0).toLocaleString('en-IN')}</span></div><div><span class="text-gray-500">Sale:</span> <span class="font-semibold ${isLocked&&bike.isSensitive?'sensitive-mask':''}">${isLocked&&bike.isSensitive?'••••':'₹'+(bike.salePrice||0).toLocaleString('en-IN')}</span></div></div><div class="flex gap-2 mt-3"><button class="btn-secondary flex-1 text-sm py-2" onclick="UI.editBike('${bike.id}')">Edit</button><button class="px-3 py-2 bg-red-500 text-white rounded-lg text-sm" onclick="UI.deleteBike('${bike.id}')">Delete</button></div>`;container.appendChild(card)})},
async renderCredit(){const credit=await DB.getAll('credit');const total=credit.reduce((sum,c)=>sum+(c.amount||0),0);const collected=credit.filter(c=>c.isPaid).reduce((sum,c)=>sum+(c.amount||0),0);const metrics=[{el:$('#page-credit .bg-blue-50 .text-xl'),val:total},{el:$('#page-credit .bg-green-50 .text-xl'),val:collected}];
metrics.forEach(m=>{if(m.el){m.el.textContent=`₹${m.val.toLocaleString('en-IN')}`;if(m.el.classList.contains('sensitive-mask')&&isLocked){m.el.textContent='••••'}}});
const container=$('#credit-list');container.innerHTML='';if(credit.length===0){container.innerHTML='<p class="text-center text-gray-500 py-8">No credit records</p>';return}
credit.forEach(c=>{const card=document.createElement('div');card.className='bg-white rounded-2xl p-4 shadow-sm';const status=c.isPaid?'<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-semibold">Paid</span>':'<span class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs font-semibold">Pending</span>';card.innerHTML=`<div class="flex justify-between items-start mb-2"><div><p class="font-semibold">${c.customerName||'Unknown'}</p><p class="text-sm text-gray-500">${c.bikeName||''}</p></div>${status}</div><div class="text-lg font-bold ${isLocked?'sensitive-mask':''}">${isLocked?'••••':'₹'+(c.amount||0).toLocaleString('en-IN')}</div><button class="btn-secondary w-full mt-2 text-sm" onclick="UI.editCredit('${c.id}')">View Details</button>`;container.appendChild(card)})},
async updateStorageInfo(){if(!navigator.storage||!navigator.storage.estimate)return;const estimate=await navigator.storage.estimate();const used=(estimate.usage||0)/1024/1024;const quota=(estimate.quota||0)/1024/1024;const info=$('#storage-info');if(info){info.textContent=`Using ${used.toFixed(2)} MB of ${quota.toFixed(2)} MB`}},
updateLockState(){const btn=$('#lock-toggle');btn.classList.toggle('locked',isLocked);btn.title=isLocked?'Unlock':'Lock';btn.setAttribute('aria-pressed',!isLocked);$$('[data-sensitive]').forEach(el=>{el.classList.toggle('sensitive-mask',isLocked);if(isLocked){el.textContent='••••'}});if(!isLocked)this.render()},
async handleLock(){if(isLocked){const pin=await DB.get('auth','pin');const webauthn=await DB.get('auth','webauthn');if(!pin){this.showPINSetup();return}
if(webauthn){try{await Auth.verifyBiometric()}catch(e){this.showPINPrompt()}}else{this.showPINPrompt()}}else{Auth.lock()}},
showPINSetup(){const pin=prompt('Setup a PIN (4-12 digits):');if(!pin)return;if(!/^\d{4,12}$/.test(pin)){showToast('Invalid PIN format');return}
const confirm=prompt('Confirm PIN:');if(pin!==confirm){showToast('PINs do not match');return}
Auth.setupPIN(pin).then(()=>this.updateLockState()).catch(e=>showToast(e.message))},
showPINPrompt(){const pin=prompt('Enter PIN:');if(!pin)return;Auth.verifyPIN(pin).catch(e=>{showToast('Invalid PIN');this.showPINPrompt()})},
async setupBiometric(){try{await Auth.setupBiometric()}catch(e){showToast(e.message)}},
async loadSettings(){const theme=await DB.get('settings','theme');if(theme?.value==='dark'){document.body.classList.add('dark')}},
handleAdd(){if(this.currentPage==='bikes')this.addBike();if(this.currentPage==='credit')this.addCredit()},
addBike(){const name=prompt('Bike name (required, 1-120 characters):');if(!name||name.length<1||name.length>120){showToast('Invalid name');return}
const purchaseStr=prompt('Purchase price (₹):');const purchasePrice=parseFloat(purchaseStr)||0;if(purchasePrice<0){showToast('Invalid price');return}
const bike={id:uuid(),name:name.trim(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),sold:false,purchasePrice,salePrice:0,repairCost:0,isSensitive:false};DB.put('bikes',bike).then(()=>{showToast('Bike added');this.render()})},
editBike(id){showToast('Edit functionality coming soon')},
deleteBike(id){if(!confirm('Delete this bike?'))return;DB.delete('bikes',id).then(()=>{showToast('Bike deleted');this.render()})},
addCredit(){const name=prompt('Customer name (required):');if(!name||name.length<1||name.length>100){showToast('Invalid name');return}
const amountStr=prompt('Credit amount (₹, positive number):');const amount=parseFloat(amountStr);if(isNaN(amount)||amount<=0){showToast('Invalid amount');return}
const credit={id:uuid(),customerName:name.trim(),amount,isPaid:false,createdAt:new Date().toISOString()};DB.put('credit',credit).then(()=>{showToast('Credit added');this.render()})},
editCredit(id){showToast('Edit functionality coming soon')},
async clearAllData(){const confirm=prompt('Type DELETE to confirm clearing all data:');if(confirm!=='DELETE')return;await DB.clear('bikes');await DB.clear('credit');await DB.clear('images');showToast('All data cleared');this.render()}
};

// Migration Module (localStorage to IndexedDB)
const Migration={
async run(){try{const legacyKey='bikeManagerData';const raw=localStorage.getItem(legacyKey);if(!raw)return;const legacy=JSON.parse(raw);if(!legacy.bikes&&!legacy.data)return;const bikes=(legacy.bikes||legacy.data?.bikes||[]);const credit=(legacy.credit||legacy.data?.credit||[]);console.log(`Migrating ${bikes.length} bikes, ${credit.length} credit records`);for(const bike of bikes){if(!bike.id)bike.id=uuid();if(!bike.createdAt)bike.createdAt=new Date().toISOString();if(!bike.updatedAt)bike.updatedAt=bike.createdAt;await DB.put('bikes',bike)}
for(const c of credit){if(!c.id)c.id=uuid();if(!c.createdAt)c.createdAt=new Date().toISOString();await DB.put('credit',c)}
localStorage.removeItem(legacyKey);sessionStorage.clear();showToast(`Migrated ${bikes.length} bikes successfully`);return true}catch(e){console.error('Migration error:',e);return false}}
};

// App Initialization
(async()=>{try{await DB.init();await Migration.run();await UI.init()}catch(e){console.error('Init error:',e);showToast('Failed to initialize app')}})();

// Export for debugging
window.APP={DB,Crypto,Auth,Camera,Backup,PWA,UI};
</script>
</body>
</html>