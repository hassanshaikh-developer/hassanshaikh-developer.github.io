<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#2563eb">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' blob: data:; connect-src 'self'; font-src 'self' data:; worker-src 'self';">
<title>Bike Manager</title>
<link rel="manifest" href="./manifest.webmanifest">
<link rel="icon" href="./icons/icon-192.png">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<style>
:root{--blue-50:#eff6ff;--blue-100:#dbeafe;--blue-200:#bfdbfe;--blue-500:#3b82f6;--blue-600:#2563eb;--blue-700:#1d4ed8;--blue-900:#1e3a8a;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-400:#9ca3af;--gray-500:#6b7280;--gray-600:#4b5563;--gray-700:#374151;--gray-800:#1f2937;--gray-900:#111827;--red-50:#fef2f2;--red-500:#ef4444;--red-600:#dc2626;--green-50:#f0fdf4;--green-500:#22c55e;--green-600:#16a34a;--yellow-50:#fefce8;--yellow-500:#eab308}*,:before,:after{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background:var(--gray-200);color:var(--gray-900);overscroll-behavior:none;-webkit-tap-highlight-color:rgba(0,0,0,.1)}button,input,select,textarea{font:inherit;color:inherit;border:none;outline:none}button{cursor:pointer;background:transparent}img{max-width:100%;height:auto;display:block}.hidden{display:none!important}.flex{display:flex}.flex-col{flex-direction:column}.flex-1{flex:1 1 0%}.items-center{align-items:center}.justify-between{justify-content:space-between}.gap-2{gap:.5rem}.gap-3{gap:.75rem}.gap-4{gap:1rem}.space-y-2>*+*{margin-top:.5rem}.space-y-3>*+*{margin-top:.75rem}.space-y-4>*+*{margin-top:1rem}.p-4{padding:1rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-4{padding-top:1rem;padding-bottom:1rem}.text-xs{font-size:.75rem;line-height:1rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.font-medium{font-weight:500}.font-semibold{font-weight:600}.font-bold{font-weight:700}.text-gray-500{color:var(--gray-500)}.text-gray-600{color:var(--gray-600)}.text-gray-700{color:var(--gray-700)}.text-gray-900{color:var(--gray-900)}.text-blue-500{color:var(--blue-500)}.text-blue-600{color:var(--blue-600)}.text-white{color:#fff}.bg-white{background:#fff}.bg-gray-100{background:var(--gray-100)}.bg-gray-200{background:var(--gray-200)}.bg-blue-500{background:var(--blue-500)}.bg-blue-600{background:var(--blue-600)}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.rounded-2xl{border-radius:1rem}.rounded-full{border-radius:9999px}.shadow{box-shadow:0 1px 3px 0 rgba(0,0,0,.1)}.shadow-sm{box-shadow:0 1px 2px 0 rgba(0,0,0,.05)}.shadow-lg{box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}.border{border:1px solid var(--gray-200)}.border-b{border-bottom:1px solid var(--gray-200)}.fixed{position:fixed}.sticky{position:sticky}.top-0{top:0}.inset-x-0{left:0;right:0}.z-10{z-index:10}.z-20{z-index:20}.z-30{z-index:30}.z-40{z-index:40}.z-50{z-index:50}.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.transition{transition-property:all;transition-duration:.2s;transition-timing-function:ease}header{background:rgba(255,255,255,.9);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border-bottom:1px solid var(--gray-200);position:fixed;left:0;right:0;top:0;z-index:30;padding:1rem}header .container{max-width:1280px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem}header h1{font-size:1.25rem;font-weight:700;color:var(--gray-900)}header .actions{display:flex;align-items:center;gap:.75rem}header button{padding:.5rem .75rem;background:var(--blue-500);color:#fff;border-radius:.5rem;font-size:.875rem;font-weight:600;box-shadow:0 1px 2px rgba(0,0,0,.05);transition:background .2s}header button:hover{background:var(--blue-600)}header button.lock-btn{background:rgba(248,113,113,.15);border:1px solid rgba(248,113,113,.35);color:var(--red-600);width:40px;height:40px;display:flex;align-items:center;justify-content:center;padding:0;border-radius:50%}header button.lock-btn.unlocked{background:rgba(219,234,254,.6);border-color:rgba(59,130,246,.3);color:var(--blue-600)}.lock-btn svg{width:1.25rem;height:1.25rem}#app{max-width:1280px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;background:var(--gray-100);padding-top:5rem;padding-bottom:5rem}main{flex:1;padding:1rem;overflow-y:auto}.page{display:none}.page.active{display:block}.card{background:#fff;border-radius:1rem;padding:1rem;box-shadow:0 1px 3px rgba(0,0,0,.1)}.card-title{font-size:1rem;font-weight:600;color:var(--gray-700);margin-bottom:.75rem}.metric-card{background:#fff;border-radius:1rem;padding:1rem;box-shadow:0 1px 2px rgba(0,0,0,.05)}.metric-card .label{font-size:.875rem;color:var(--gray-500);font-weight:500}.metric-card .value{font-size:1.5rem;font-weight:700;color:var(--gray-900);margin-top:.25rem}.sensitive-mask{filter:blur(6px);opacity:.5;pointer-events:none;user-select:none}.sensitive-mask.unlocked{filter:none;opacity:1;pointer-events:auto;user-select:auto}.form-input{width:100%;padding:.75rem;background:var(--gray-100);border:1px solid var(--gray-100);border-radius:.625rem;font-size:1rem;transition:all .2s}.form-input:focus{background:#fff;border-color:var(--blue-500);box-shadow:0 0 0 2px var(--blue-200)}.form-label{display:block;font-size:.813rem;font-weight:500;color:var(--gray-500);margin-bottom:.375rem;padding-left:.25rem}.btn{padding:.625rem 1rem;background:var(--blue-500);color:#fff;border-radius:.5rem;font-size:.875rem;font-weight:600;transition:all .2s;border:none;cursor:pointer}.btn:hover{background:var(--blue-600);transform:translateY(-1px)}.btn-secondary{background:var(--gray-100);color:var(--gray-700)}.btn-secondary:hover{background:var(--gray-200)}.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:40;opacity:0;transition:opacity .3s;pointer-events:none}.modal-overlay.open{opacity:1;pointer-events:auto}.modal{position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:1rem 1rem 0 0;padding:1.5rem;z-index:50;transform:translateY(100%);transition:transform .3s ease-out;max-height:90vh;overflow-y:auto}.modal.open{transform:translateY(0)}@media(min-width:768px){.modal{position:relative;transform:none!important;max-width:600px;margin:2rem auto;border-radius:1rem}}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}.modal-header h2{font-size:1.25rem;font-weight:700}.modal-header .close-btn{width:32px;height:32px;border-radius:50%;background:var(--gray-100);display:flex;align-items:center;justify-content:center;color:var(--gray-600);cursor:pointer;transition:background .2s}.modal-header .close-btn:hover{background:var(--gray-200)}.segmented-control{display:flex;background:var(--gray-200);border-radius:.625rem;padding:2px}.segmented-control button{flex:1;padding:.375rem .625rem;border:none;background:transparent;color:var(--gray-600);font-size:.813rem;font-weight:500;border-radius:.5rem;transition:all .2s}.segmented-control button.active{background:#fff;color:var(--gray-900);box-shadow:0 1px 4px rgba(0,0,0,.1)}.nav-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--gray-200);display:flex;justify-content:space-around;padding:.75rem 0;z-index:30}.nav-item{display:flex;flex-direction:column;align-items:center;gap:.25rem;padding:.5rem;color:var(--gray-500);font-size:.75rem;transition:color .2s;cursor:pointer}.nav-item svg{width:1.5rem;height:1.5rem}.nav-item.active{color:var(--blue-600)}.nav-item.active svg{color:var(--blue-600)}.grid{display:grid}.grid-cols-2{grid-template-columns:repeat(2,1fr)}.grid-cols-3{grid-template-columns:repeat(3,1fr)}@media(min-width:640px){.sm\\:grid-cols-2{grid-template-columns:repeat(2,1fr)}}@media(min-width:1024px){.lg\\:grid-cols-4{grid-template-columns:repeat(4,1fr)}}.list-item{background:#fff;border-radius:.75rem;padding:1rem;margin-bottom:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.05);cursor:pointer;transition:all .2s}.list-item:hover{box-shadow:0 4px 6px rgba(0,0,0,.1);transform:translateY(-1px)}.list-item-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.5rem}.list-item-title{font-size:1rem;font-weight:600;color:var(--gray-900)}.list-item-meta{font-size:.813rem;color:var(--gray-500);margin-top:.25rem}.list-item-value{font-size:1.125rem;font-weight:700;color:var(--blue-600)}.badge{display:inline-flex;padding:.25rem .625rem;border-radius:9999px;font-size:.75rem;font-weight:600}.badge-success{background:var(--green-50);color:var(--green-600)}.badge-warning{background:var(--yellow-50);color:var(--yellow-500)}.badge-danger{background:var(--red-50);color:var(--red-600)}.toast{position:fixed;top:6rem;right:1rem;background:var(--gray-900);color:#fff;padding:1rem 1.5rem;border-radius:.5rem;box-shadow:0 10px 15px rgba(0,0,0,.2);z-index:60;transform:translateX(400px);transition:transform .3s ease-out}.toast.show{transform:translateX(0)}.camera-preview{position:relative;width:100%;aspect-ratio:4/3;background:var(--gray-900);border-radius:.75rem;overflow:hidden}.camera-preview video{width:100%;height:100%;object-fit:cover}.camera-controls{position:absolute;bottom:1rem;left:0;right:0;display:flex;justify-content:center;gap:1rem}.camera-controls button{width:60px;height:60px;border-radius:50%;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center}.image-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:.5rem}.image-grid-item{position:relative;aspect-ratio:1;border-radius:.5rem;overflow:hidden;cursor:pointer}.image-grid-item img{width:100%;height:100%;object-fit:cover}.image-grid-item .delete-btn{position:absolute;top:.25rem;right:.25rem;width:28px;height:28px;background:rgba(0,0,0,.7);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}.image-grid-item:hover .delete-btn{opacity:1}.spinner{width:40px;height:40px;border:4px solid var(--gray-200);border-top-color:var(--blue-500);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}input[type=number]{-moz-appearance:textfield;appearance:textfield}@media(prefers-reduced-motion:reduce){*,:before,:after{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}}
</style>
</head>
<body>

<header>
  <div class="container">
    <h1 id="page-title">Dashboard</h1>
    <div class="actions">
      <button id="pwa-install-btn" class="hidden">Install App</button>
      <button id="update-btn" class="hidden">Update Available</button>
      <button id="lock-btn" class="lock-btn locked" title="Unlock sensitive data" aria-label="Toggle sensitive data lock">
        <svg id="lock-icon-locked" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
        <svg id="lock-icon-unlocked" class="hidden" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>
      </button>
      <button id="add-btn" class="hidden" aria-label="Add new item">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      </button>
    </div>
  </div>
</header>

<div id="app">
  <main>
    
    <!-- Dashboard Page -->
    <div id="page-dashboard" class="page active">
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div class="metric-card">
            <div class="label">Cash in Hand</div>
            <div class="value sensitive-mask" id="metric-cash">₹0</div>
          </div>
          <div class="metric-card">
            <div class="label">Total Revenue</div>
            <div class="value sensitive-mask" id="metric-revenue">₹0</div>
          </div>
          <div class="metric-card">
            <div class="label">Total Profit</div>
            <div class="value sensitive-mask" id="metric-profit">₹0</div>
          </div>
          <div class="metric-card">
            <div class="label">Brand Earnings</div>
            <div class="value sensitive-mask" id="metric-brand">₹0</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="metric-card">
            <div class="label">Unsold Investment</div>
            <div class="value" id="metric-investment">₹0</div>
          </div>
          <div class="metric-card">
            <div class="label">Inventory (S/U)</div>
            <div class="value" id="metric-inventory">0 / 0</div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Payment Reminders</div>
          <div id="reminders-list" class="space-y-2">
            <p class="text-sm text-gray-500">No upcoming reminders</p>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Recent Unsold Bikes</div>
          <div id="recent-bikes" class="space-y-2">
            <p class="text-sm text-gray-500">No bikes yet</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Bikes Page -->
    <div id="page-bikes" class="page">
      <div class="space-y-3">
        <input type="search" id="bike-search" placeholder="Search bikes..." class="form-input">
        <div class="segmented-control">
          <button data-filter="all" class="active">All</button>
          <button data-filter="unsold">Unsold</button>
          <button data-filter="sold">Sold</button>
        </div>
        <div id="bike-list" class="space-y-2">
          <p class="text-sm text-gray-500">No bikes found</p>
        </div>
      </div>
    </div>

    <!-- Credit Page -->
    <div id="page-credit" class="page">
      <div class="space-y-3">
        <div class="grid grid-cols-3 gap-3">
          <div class="metric-card">
            <div class="label">Total</div>
            <div class="value sensitive-mask" id="credit-total">₹0</div>
          </div>
          <div class="metric-card">
            <div class="label">Collected</div>
            <div class="value sensitive-mask" id="credit-collected">₹0</div>
          </div>
          <div class="metric-card">
            <div class="label">Pending</div>
            <div class="value sensitive-mask" id="credit-pending">₹0</div>
          </div>
        </div>
        <div id="credit-list" class="space-y-2">
          <p class="text-sm text-gray-500">No credit transactions</p>
        </div>
      </div>
    </div>

    <!-- Analytics Page -->
    <div id="page-analytics" class="page">
      <div class="space-y-4">
        <div class="card">
          <div class="card-title">Sales Analytics</div>
          <p class="text-sm text-gray-500">Analytics visualization coming soon</p>
        </div>
      </div>
    </div>

    <!-- Settings Page -->
    <div id="page-settings" class="page">
      <div class="space-y-3">
        <div class="card">
          <div class="card-title">Security</div>
          <button id="setup-pin-btn" class="btn">Setup PIN</button>
          <button id="setup-biometric-btn" class="btn" style="margin-top:0.5rem">Setup Biometric Auth</button>
          <button id="backup-btn" class="btn" style="margin-top:0.5rem">Backup Data</button>
          <button id="restore-btn" class="btn" style="margin-top:0.5rem">Restore Data</button>
        </div>
        <div class="card">
          <div class="card-title">App Info</div>
          <p class="text-sm">Version: 2.0.0</p>
          <button id="check-update-btn" class="btn" style="margin-top:0.5rem">Check for Updates</button>
        </div>
      </div>
    </div>

  </main>

  <!-- Bottom Navigation -->
  <nav class="nav-bar">
    <div class="nav-item active" data-page="dashboard">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
      <span>Dashboard</span>
    </div>
    <div class="nav-item" data-page="bikes">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18.5" cy="17.5" r="3.5"></circle><circle cx="5.5" cy="17.5" r="3.5"></circle><circle cx="15" cy="5" r="1"></circle><path d="M12 17.5V14l-3-3 4-3 2 3h2"></path></svg>
      <span>Bikes</span>
    </div>
    <div class="nav-item" data-page="credit">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"></rect><line x1="2" y1="10" x2="22" y2="10"></line></svg>
      <span>Credit</span>
    </div>
    <div class="nav-item" data-page="analytics">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
      <span>Analytics</span>
    </div>
    <div class="nav-item" data-page="settings">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6m0 6v6m5.66-13.66l-4.24 4.24m-2.84 2.84l-4.24 4.24m13.08 0l-4.24-4.24m-2.84-2.84l-4.24-4.24"></path></svg>
      <span>Settings</span>
    </div>
  </nav>
</div>

<!-- Modals -->
<div id="modal-overlay" class="modal-overlay"></div>
<div id="modal" class="modal">
  <div class="modal-header">
    <h2 id="modal-title">Modal</h2>
    <div class="close-btn" id="modal-close">✕</div>
  </div>
  <div id="modal-content"></div>
</div>

<!-- PIN Setup Modal -->
<div id="pin-modal" class="modal">
  <div class="modal-header">
    <h2>Setup PIN</h2>
    <div class="close-btn" id="pin-modal-close">✕</div>
  </div>
  <div class="space-y-3">
    <div>
      <label class="form-label">Enter PIN (4-12 digits)</label>
      <input type="password" id="pin-input" class="form-input" pattern="[0-9]{4,12}" required inputmode="numeric" maxlength="12">
    </div>
    <div>
      <label class="form-label">Confirm PIN</label>
      <input type="password" id="pin-confirm" class="form-input" pattern="[0-9]{4,12}" required inputmode="numeric" maxlength="12">
    </div>
    <button id="pin-save-btn" class="btn">Save PIN</button>
  </div>
</div>

<!-- Camera Modal -->
<div id="camera-modal" class="modal">
  <div class="modal-header">
    <h2>Capture Images</h2>
    <div class="close-btn" id="camera-modal-close">✕</div>
  </div>
  <div class="space-y-3">
    <div class="camera-preview" id="camera-preview">
      <video id="camera-video" autoplay playsinline></video>
      <div class="camera-controls">
        <button id="camera-capture-btn">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>
        </button>
      </div>
    </div>
    <div id="captured-images" class="image-grid"></div>
    <div class="flex gap-2">
      <button id="camera-done-btn" class="btn flex-1">Done</button>
      <button id="camera-cancel-btn" class="btn-secondary flex-1">Cancel</button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast">Message</div>

<script type="module">
'use strict';

// ============================================================================
// Constants & Config
// ============================================================================
const APP_VERSION = '2.0.0';
const DB_NAME = 'BikeManagerDB';
const DB_VERSION = 1;
const PBKDF2_ITERATIONS = 250000;
const AUTO_LOCK_TIMEOUT = 300000; // 5 minutes
const RP_ID = window.location.hostname;
const RP_NAME = 'Bike Manager';

// ============================================================================
// Utility Functions
// ============================================================================
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

const generateUUID = () => {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
};

const showToast = (message, duration = 3000) => {
  const toast = $('#toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), duration);
};

const formatCurrency = (amount) => {
  return `₹${amount?.toLocaleString('en-IN') || 0}`;
};

const formatDate = (date) => {
  return new Date(date).toLocaleDateString('en-IN', {
    day: '2-digit',
    month: 'short',
    year: 'numeric'
  });
};

// ============================================================================
// IndexedDB Module
// ============================================================================
const DB = (() => {
  let db = null;

  const init = () => {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        db = request.result;
        resolve(db);
      };
      
      request.onupgradeneeded = (e) => {
        const database = e.target.result;
        
        // Entries store
        if (!database.objectStoreNames.contains('entries')) {
          const entriesStore = database.createObjectStore('entries', { keyPath: 'id' });
          entriesStore.createIndex('createdAt', 'createdAt', { unique: false });
          entriesStore.createIndex('status', 'status', { unique: false });
        }
        
        // Images store
        if (!database.objectStoreNames.contains('images')) {
          database.createObjectStore('images', { keyPath: 'id' });
        }
        
        // Settings store
        if (!database.objectStoreNames.contains('settings')) {
          database.createObjectStore('settings', { keyPath: 'key' });
        }
        
        // Auth store
        if (!database.objectStoreNames.contains('auth')) {
          database.createObjectStore('auth', { keyPath: 'key' });
        }
      };
    });
  };

  const get = (store, key) => {
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([store], 'readonly');
      const objectStore = transaction.objectStore(store);
      const request = objectStore.get(key);
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  };

  const getAll = (store) => {
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([store], 'readonly');
      const objectStore = transaction.objectStore(store);
      const request = objectStore.getAll();
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  };

  const put = (store, value) => {
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([store], 'readwrite');
      const objectStore = transaction.objectStore(store);
      const request = objectStore.put(value);
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  };

  const remove = (store, key) => {
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([store], 'readwrite');
      const objectStore = transaction.objectStore(store);
      const request = objectStore.delete(key);
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  };

  const clear = (store) => {
    return new Promise((resolve, reject) => {
      const transaction = db.transaction([store], 'readwrite');
      const objectStore = transaction.objectStore(store);
      const request = objectStore.clear();
      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  };

  return { init, get, getAll, put, remove, clear };
})();

// ============================================================================
// Crypto Module
// ============================================================================
const Crypto = (() => {
  let masterKey = null;
  
  const deriveKey = async (pin, salt) => {
    const encoder = new TextEncoder();
    const pinBuffer = encoder.encode(pin);
    const importedKey = await crypto.subtle.importKey(
      'raw',
      pinBuffer,
      'PBKDF2',
      false,
      ['deriveBits', 'deriveKey']
    );
    
    return crypto.subtle.deriveKey(
      {
        name: 'PBKDF2',
        salt,
        iterations: PBKDF2_ITERATIONS,
        hash: 'SHA-256'
      },
      importedKey,
      { name: 'AES-GCM', length: 256 },
      true,
      ['encrypt', 'decrypt']
    );
  };

  const hashPin = async (pin, salt) => {
    const key = await deriveKey(pin, salt);
    const exported = await crypto.subtle.exportKey('raw', key);
    return btoa(String.fromCharCode(...new Uint8Array(exported)));
  };

  const setupPin = async (pin) => {
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const hash = await hashPin(pin, salt);
    
    await DB.put('auth', {
      key: 'pin',
      hash,
      salt: btoa(String.fromCharCode(...salt)),
      iterations: PBKDF2_ITERATIONS
    });
    
    masterKey = await deriveKey(pin, salt);
    return true;
  };

  const verifyPin = async (pin) => {
    const authData = await DB.get('auth', 'pin');
    if (!authData) return false;
    
    const salt = Uint8Array.from(atob(authData.salt), c => c.charCodeAt(0));
    const hash = await hashPin(pin, salt);
    
    if (hash === authData.hash) {
      masterKey = await deriveKey(pin, salt);
      return true;
    }
    return false;
  };

  const encrypt = async (data) => {
    if (!masterKey) throw new Error('Not unlocked');
    
    const encoder = new TextEncoder();
    const dataBuffer = encoder.encode(JSON.stringify(data));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    
    const encryptedBuffer = await crypto.subtle.encrypt(
      { name: 'AES-GCM', iv },
      masterKey,
      dataBuffer
    );
    
    return {
      ciphertext: btoa(String.fromCharCode(...new Uint8Array(encryptedBuffer))),
      iv: btoa(String.fromCharCode(...iv))
    };
  };

  const decrypt = async (encryptedData) => {
    if (!masterKey) throw new Error('Not unlocked');
    
    const iv = Uint8Array.from(atob(encryptedData.iv), c => c.charCodeAt(0));
    const ciphertext = Uint8Array.from(atob(encryptedData.ciphertext), c => c.charCodeAt(0));
    
    const decryptedBuffer = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv },
      masterKey,
      ciphertext
    );
    
    const decoder = new TextDecoder();
    return JSON.parse(decoder.decode(decryptedBuffer));
  };

  const lock = () => {
    masterKey = null;
  };

  const isUnlocked = () => !!masterKey;

  return { setupPin, verifyPin, encrypt, decrypt, lock, isUnlocked };
})();

// ============================================================================
// WebAuthn Module
// ============================================================================
const WebAuthn = (() => {
  const isAvailable = () => {
    return window.PublicKeyCredential !== undefined &&
           navigator.credentials !== undefined;
  };

  const register = async () => {
    if (!isAvailable()) {
      throw new Error('WebAuthn not supported');
    }

    const challenge = crypto.getRandomValues(new Uint8Array(32));
    const userId = crypto.getRandomValues(new Uint8Array(16));

    const publicKeyOptions = {
      challenge,
      rp: { id: RP_ID, name: RP_NAME },
      user: {
        id: userId,
        name: 'user@bikemanager.app',
        displayName: 'Bike Manager User'
      },
      pubKeyCredParams: [
        { type: 'public-key', alg: -7 },  // ES256
        { type: 'public-key', alg: -257 } // RS256
      ],
      authenticatorSelection: {
        authenticatorAttachment: 'platform',
        userVerification: 'required'
      },
      timeout: 60000,
      attestation: 'none'
    };

    const credential = await navigator.credentials.create({
      publicKey: publicKeyOptions
    });

    await DB.put('auth', {
      key: 'webauthn',
      credentialId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId))),
      userId: btoa(String.fromCharCode(...userId))
    });

    return true;
  };

  const authenticate = async () => {
    if (!isAvailable()) {
      throw new Error('WebAuthn not supported');
    }

    const authData = await DB.get('auth', 'webauthn');
    if (!authData) {
      throw new Error('No credential registered');
    }

    const challenge = crypto.getRandomValues(new Uint8Array(32));
    const credentialId = Uint8Array.from(atob(authData.credentialId), c => c.charCodeAt(0));

    const publicKeyOptions = {
      challenge,
      allowCredentials: [{
        type: 'public-key',
        id: credentialId
      }],
      userVerification: 'required',
      timeout: 60000
    };

    const assertion = await navigator.credentials.get({
      publicKey: publicKeyOptions
    });

    return !!assertion;
  };

  return { isAvailable, register, authenticate };
})();

// ============================================================================
// Camera Module
// ============================================================================
const Camera = (() => {
  let stream = null;
  let capturedImages = [];

  const start = async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } },
        audio: false
      });
      const video = $('#camera-video');
      video.srcObject = stream;
      return true;
    } catch (err) {
      console.error('Camera error:', err);
      return false;
    }
  };

  const stop = () => {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
  };

  const capture = async () => {
    const video = $('#camera-video');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    return new Promise((resolve) => {
      canvas.toBlob((blob) => {
        const imageId = generateUUID();
        capturedImages.push({ id: imageId, blob });
        resolve({ id: imageId, blob });
      }, 'image/webp', 0.85);
    });
  };

  const getCaptured = () => capturedImages;
  
  const clearCaptured = () => {
    capturedImages = [];
  };

  const removeImage = (id) => {
    capturedImages = capturedImages.filter(img => img.id !== id);
  };

  return { start, stop, capture, getCaptured, clearCaptured, removeImage };
})();

// ============================================================================
// Backup/Restore Module
// ============================================================================
const Backup = (() => {
  const exportData = async () => {
    const entries = await DB.getAll('entries');
    const images = await DB.getAll('images');
    const settings = await DB.getAll('settings');

    const data = {
      version: 1,
      exportDate: new Date().toISOString(),
      entries,
      images: images.map(img => ({
        id: img.id,
        data: img.blob ? await blobToBase64(img.blob) : null
      })),
      settings
    };

    if (Crypto.isUnlocked()) {
      const encrypted = await Crypto.encrypt(data);
      return {
        encrypted: true,
        version: 1,
        ...encrypted
      };
    }

    return {
      encrypted: false,
      version: 1,
      data
    };
  };

  const importData = async (backupData, merge = false) => {
    let data = backupData;

    if (backupData.encrypted) {
      if (!Crypto.isUnlocked()) {
        throw new Error('Unlock required to restore encrypted backup');
      }
      data = await Crypto.decrypt({
        ciphertext: backupData.ciphertext,
        iv: backupData.iv
      });
    } else {
      data = backupData.data;
    }

    if (!merge) {
      await DB.clear('entries');
      await DB.clear('images');
    }

    // Restore entries
    for (const entry of data.entries) {
      await DB.put('entries', entry);
    }

    // Restore images
    for (const img of data.images) {
      if (img.data) {
        const blob = await base64ToBlob(img.data);
        await DB.put('images', { id: img.id, blob });
      }
    }

    return true;
  };

  const downloadBackup = async () => {
    const data = await exportData();
    const json = JSON.stringify(data);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `bike-manager-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const blobToBase64 = (blob) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  };

  const base64ToBlob = async (base64) => {
    const response = await fetch(`data:image/webp;base64,${base64}`);
    return response.blob();
  };

  return { exportData, importData, downloadBackup };
})();

// ============================================================================
// App State
// ============================================================================
const State = {
  currentPage: 'dashboard',
  isLocked: true,
  bikes: [],
  creditTransactions: [],
  settings: {}
};

// ============================================================================
// UI Functions
// ============================================================================
const UI = (() => {
  const showPage = (pageName) => {
    $$('.page').forEach(page => page.classList.remove('active'));
    $$('.nav-item').forEach(item => item.classList.remove('active'));
    
    $(`#page-${pageName}`)?.classList.add('active');
    $(`.nav-item[data-page="${pageName}"]`)?.classList.add('active');
    
    State.currentPage = pageName;
    updatePageTitle(pageName);
    updateAddButton(pageName);
  };

  const updatePageTitle = (pageName) => {
    const titles = {
      dashboard: 'Dashboard',
      bikes: 'Bikes',
      credit: 'Credit',
      analytics: 'Analytics',
      settings: 'Settings'
    };
    $('#page-title').textContent = titles[pageName] || pageName;
  };

  const updateAddButton = (pageName) => {
    const addBtn = $('#add-btn');
    if (['bikes', 'credit'].includes(pageName)) {
      addBtn.classList.remove('hidden');
    } else {
      addBtn.classList.add('hidden');
    }
  };

  const updateLockUI = () => {
    const lockBtn = $('#lock-btn');
    const lockedIcon = $('#lock-icon-locked');
    const unlockedIcon = $('#lock-icon-unlocked');
    
    if (State.isLocked) {
      lockBtn.classList.add('locked');
      lockBtn.classList.remove('unlocked');
      lockedIcon.classList.remove('hidden');
      unlockedIcon.classList.add('hidden');
      $$('.sensitive-mask').forEach(el => el.classList.remove('unlocked'));
    } else {
      lockBtn.classList.remove('locked');
      lockBtn.classList.add('unlocked');
      lockedIcon.classList.add('hidden');
      unlockedIcon.classList.remove('hidden');
      $$('.sensitive-mask').forEach(el => el.classList.add('unlocked'));
    }
  };

  const showModal = (id) => {
    const modal = $(`#${id}`);
    const overlay = $('#modal-overlay');
    if (modal && overlay) {
      overlay.classList.add('open');
      modal.classList.add('open');
    }
  };

  const hideModal = (id) => {
    const modal = $(`#${id}`);
    const overlay = $('#modal-overlay');
    if (modal && overlay) {
      overlay.classList.remove('open');
      modal.classList.remove('open');
    }
  };

  const renderDashboard = () => {
    // Calculate metrics
    const bikes = State.bikes;
    const unsoldBikes = bikes.filter(b => b.status === 'unsold');
    const soldBikes = bikes.filter(b => b.status === 'sold');
    
    const totalInvestment = unsoldBikes.reduce((sum, b) => sum + (b.purchasePrice || 0), 0);
    const totalRevenue = soldBikes.reduce((sum, b) => sum + (b.salePrice || 0), 0);
    const totalProfit = soldBikes.reduce((sum, b) => sum + ((b.salePrice || 0) - (b.purchasePrice || 0)), 0);
    
    $('#metric-investment').textContent = formatCurrency(totalInvestment);
    $('#metric-inventory').textContent = `${soldBikes.length} / ${unsoldBikes.length}`;
    $('#metric-cash').textContent = formatCurrency(totalRevenue);
    $('#metric-revenue').textContent = formatCurrency(totalRevenue);
    $('#metric-profit').textContent = formatCurrency(totalProfit);
    $('#metric-brand').textContent = formatCurrency(0);
    
    // Render recent bikes
    const recentBikes = $('#recent-bikes');
    if (unsoldBikes.length === 0) {
      recentBikes.innerHTML = '<p class="text-sm text-gray-500">No unsold bikes</p>';
    } else {
      recentBikes.innerHTML = unsoldBikes.slice(0, 5).map(bike => `
        <div class="list-item">
          <div class="list-item-header">
            <div class="list-item-title">${bike.name || 'Untitled'}</div>
            <div class="list-item-value">${formatCurrency(bike.purchasePrice)}</div>
          </div>
          <div class="list-item-meta">${formatDate(bike.createdAt)}</div>
        </div>
      `).join('');
    }
  };

  const renderBikes = () => {
    const bikeList = $('#bike-list');
    const bikes = State.bikes;
    
    if (bikes.length === 0) {
      bikeList.innerHTML = '<p class="text-sm text-gray-500">No bikes found</p>';
      return;
    }
    
    bikeList.innerHTML = bikes.map(bike => `
      <div class="list-item" data-id="${bike.id}">
        <div class="list-item-header">
          <div>
            <div class="list-item-title">${bike.name || 'Untitled'}</div>
            <div class="list-item-meta">${bike.plateNumber || 'No plate'}</div>
          </div>
          <div>
            <span class="badge ${bike.status === 'sold' ? 'badge-success' : 'badge-warning'}">
              ${bike.status || 'unsold'}
            </span>
          </div>
        </div>
        <div class="flex justify-between items-center" style="margin-top:0.5rem">
          <div class="text-sm text-gray-600">Purchase: ${formatCurrency(bike.purchasePrice)}</div>
          ${bike.salePrice ? `<div class="text-sm font-semibold">Sale: ${formatCurrency(bike.salePrice)}</div>` : ''}
        </div>
      </div>
    `).join('');
  };

  const renderCredit = () => {
    const creditList = $('#credit-list');
    const transactions = State.creditTransactions;
    
    const totalCredit = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
    const collected = transactions.filter(t => t.status === 'collected').reduce((sum, t) => sum + t.amount, 0);
    const pending = totalCredit - collected;
    
    $('#credit-total').textContent = formatCurrency(totalCredit);
    $('#credit-collected').textContent = formatCurrency(collected);
    $('#credit-pending').textContent = formatCurrency(pending);
    
    if (transactions.length === 0) {
      creditList.innerHTML = '<p class="text-sm text-gray-500">No credit transactions</p>';
      return;
    }
    
    creditList.innerHTML = transactions.map(txn => `
      <div class="list-item">
        <div class="list-item-header">
          <div class="list-item-title">${txn.customerName || 'Unknown'}</div>
          <div class="list-item-value">${formatCurrency(txn.amount)}</div>
        </div>
        <div class="list-item-meta">
          ${formatDate(txn.date)} • ${txn.status || 'pending'}
        </div>
      </div>
    `).join('');
  };

  return {
    showPage,
    updateLockUI,
    showModal,
    hideModal,
    renderDashboard,
    renderBikes,
    renderCredit
  };
})();

// ============================================================================
// Event Handlers
// ============================================================================
const handleLockToggle = async () => {
  if (State.isLocked) {
    // Try biometric first
    if (WebAuthn.isAvailable()) {
      try {
        const authData = await DB.get('auth', 'webauthn');
        if (authData) {
          const success = await WebAuthn.authenticate();
          if (success) {
            // Get PIN to unlock crypto
            const pin = prompt('Enter PIN to complete unlock:');
            if (pin && await Crypto.verifyPin(pin)) {
              State.isLocked = false;
              UI.updateLockUI();
              showToast('Unlocked successfully');
              return;
            }
          }
        }
      } catch (err) {
        console.log('Biometric auth failed, falling back to PIN');
      }
    }
    
    // Fallback to PIN
    const pin = prompt('Enter PIN:');
    if (pin) {
      const valid = await Crypto.verifyPin(pin);
      if (valid) {
        State.isLocked = false;
        UI.updateLockUI();
        showToast('Unlocked successfully');
      } else {
        showToast('Invalid PIN');
      }
    }
  } else {
    State.isLocked = true;
    Crypto.lock();
    UI.updateLockUI();
    showToast('Locked');
  }
};

const handlePinSetup = async () => {
  UI.showModal('pin-modal');
  
  $('#pin-save-btn').onclick = async () => {
    const pin = $('#pin-input').value;
    const confirm = $('#pin-confirm').value;
    
    if (!pin || pin.length < 4 || pin.length > 12) {
      showToast('PIN must be 4-12 digits');
      return;
    }
    
    if (pin !== confirm) {
      showToast('PINs do not match');
      return;
    }
    
    await Crypto.setupPin(pin);
    UI.hideModal('pin-modal');
    showToast('PIN setup complete');
    
    $('#pin-input').value = '';
    $('#pin-confirm').value = '';
  };
};

const handleBiometricSetup = async () => {
  try {
    if (!WebAuthn.isAvailable()) {
      showToast('Biometric auth not supported on this device');
      return;
    }
    
    await WebAuthn.register();
    showToast('Biometric authentication registered');
  } catch (err) {
    showToast('Failed to register biometric auth');
    console.error(err);
  }
};

const handleBackup = async () => {
  try {
    await Backup.downloadBackup();
    showToast('Backup downloaded');
  } catch (err) {
    showToast('Backup failed');
    console.error(err);
  }
};

const handleRestore = async () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = async (e) => {
    try {
      const file = e.target.files[0];
      if (!file) return;
      
      const text = await file.text();
      const data = JSON.parse(text);
      
      const merge = confirm('Merge with existing data? (Cancel = Replace all)');
      await Backup.importData(data, merge);
      
      await loadData();
      UI.renderDashboard();
      UI.renderBikes();
      UI.renderCredit();
      
      showToast('Data restored successfully');
    } catch (err) {
      showToast('Restore failed');
      console.error(err);
    }
  };
  input.click();
};

const handleCameraOpen = async () => {
  UI.showModal('camera-modal');
  Camera.clearCaptured();
  
  const started = await Camera.start();
  if (!started) {
    showToast('Camera access denied');
    UI.hideModal('camera-modal');
    return;
  }
  
  $('#camera-capture-btn').onclick = async () => {
    const image = await Camera.capture();
    renderCapturedImages();
  };
  
  $('#camera-done-btn').onclick = async () => {
    const images = Camera.getCaptured();
    // Store images in IndexedDB
    for (const img of images) {
      await DB.put('images', img);
    }
    Camera.stop();
    UI.hideModal('camera-modal');
    showToast(`${images.length} image(s) captured`);
  };
  
  $('#camera-cancel-btn').onclick = () => {
    Camera.stop();
    UI.hideModal('camera-modal');
  };
};

const renderCapturedImages = () => {
  const container = $('#captured-images');
  const images = Camera.getCaptured();
  
  container.innerHTML = images.map(img => {
    const url = URL.createObjectURL(img.blob);
    return `
      <div class="image-grid-item">
        <img src="${url}" alt="Captured">
        <button class="delete-btn" data-id="${img.id}">✕</button>
      </div>
    `;
  }).join('');
  
  $$('.delete-btn').forEach(btn => {
    btn.onclick = () => {
      Camera.removeImage(btn.dataset.id);
      renderCapturedImages();
    };
  });
};

// ============================================================================
// Data Management
// ============================================================================
const loadData = async () => {
  State.bikes = await DB.getAll('entries');
  State.creditTransactions = []; // Load from credit store if exists
  
  // Sort bikes by date
  State.bikes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
};

const migrateFromLocalStorage = async () => {
  // Check if old data exists in localStorage
  try {
    const oldData = localStorage.getItem('bikes');
    if (oldData) {
      const bikes = JSON.parse(oldData);
      for (const bike of bikes) {
        if (!bike.id) bike.id = generateUUID();
        if (!bike.createdAt) bike.createdAt = new Date().toISOString();
        await DB.put('entries', bike);
      }
      localStorage.removeItem('bikes');
      showToast('Data migrated from old storage');
    }
  } catch (err) {
    console.error('Migration error:', err);
  }
};

// ============================================================================
// PWA Functions
// ============================================================================
const setupPWA = () => {
  // Register service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').then(reg => {
      console.log('Service Worker registered');
      
      // Check for updates
      reg.addEventListener('updatefound', () => {
        const newWorker = reg.installing;
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            $('#update-btn').classList.remove('hidden');
            $('#update-btn').onclick = () => {
              newWorker.postMessage({ type: 'SKIP_WAITING' });
              window.location.reload();
            };
          }
        });
      });
    });
  }
  
  // Install prompt
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    $('#pwa-install-btn').classList.remove('hidden');
    $('#pwa-install-btn').onclick = async () => {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        $('#pwa-install-btn').classList.add('hidden');
      }
      deferredPrompt = null;
    };
  });
  
  // Hide install button if already installed
  if (window.matchMedia('(display-mode: standalone)').matches) {
    $('#pwa-install-btn').classList.add('hidden');
  }
};

// ============================================================================
// Auto-lock
// ============================================================================
let lockTimer;
const resetLockTimer = () => {
  clearTimeout(lockTimer);
  lockTimer = setTimeout(() => {
    if (!State.isLocked) {
      State.isLocked = true;
      Crypto.lock();
      UI.updateLockUI();
      showToast('Auto-locked due to inactivity');
    }
  }, AUTO_LOCK_TIMEOUT);
};

// ============================================================================
// Initialization
// ============================================================================
const init = async () => {
  try {
    await DB.init();
    await migrateFromLocalStorage();
    await loadData();
    
    // Setup UI
    UI.renderDashboard();
    UI.renderBikes();
    UI.renderCredit();
    UI.updateLockUI();
    
    // Setup PWA
    setupPWA();
    
    // Event listeners
    $$('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        UI.showPage(item.dataset.page);
      });
    });
    
    $('#lock-btn').addEventListener('click', handleLockToggle);
    $('#setup-pin-btn').addEventListener('click', handlePinSetup);
    $('#setup-biometric-btn').addEventListener('click', handleBiometricSetup);
    $('#backup-btn').addEventListener('click', handleBackup);
    $('#restore-btn').addEventListener('click', handleRestore);
    
    $('#modal-close').addEventListener('click', () => UI.hideModal('modal'));
    $('#pin-modal-close').addEventListener('click', () => UI.hideModal('pin-modal'));
    $('#camera-modal-close').addEventListener('click', () => {
      Camera.stop();
      UI.hideModal('camera-modal');
    });
    
    $('#check-update-btn').addEventListener('click', () => {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistration().then(reg => {
          reg?.update();
          showToast('Checking for updates...');
        });
      }
    });
    
    // Auto-lock setup
    ['mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
      document.addEventListener(event, resetLockTimer, true);
    });
    resetLockTimer();
    
    showToast('App loaded successfully');
  } catch (err) {
    console.error('Initialization error:', err);
    showToast('Failed to initialize app');
  }
};

// Start the app
init();
</script>

</body>
</html>
