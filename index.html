<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#2563eb">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' blob: data:; connect-src 'self'; font-src 'self' data:; worker-src 'self';">
<title>Bike Manager</title>
<link rel="manifest" href="./manifest.webmanifest">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%232563eb' width='100' height='100'/><circle fill='%23fff' cx='50' cy='50' r='30'/></svg>">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<style>
:root {
--blue-50:#eff6ff;--blue-100:#dbeafe;--blue-500:#3b82f6;--blue-600:#2563eb;--blue-700:#1d4ed8;
--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-400:#9ca3af;
--gray-500:#6b7280;--gray-600:#4b5563;--gray-700:#374151;--gray-800:#1f2937;--gray-900:#111827;
--green-50:#f0fdf4;--green-100:#dcfce7;--green-600:#16a34a;--green-700:#15803d;
--red-50:#fef2f2;--red-100:#fee2e2;--red-600:#dc2626;--red-700:#b91c1c;
--amber-100:#fef3c7;--amber-600:#d97706;
--purple-100:#f3e8ff;--purple-700:#7e22ce;
--spacing-xs:.25rem;--spacing-sm:.5rem;--spacing:.75rem;--spacing-md:1rem;--spacing-lg:1.5rem;--spacing-xl:2rem;
}
*,::before,::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
-webkit-font-smoothing:antialiased;background:var(--gray-50);color:var(--gray-900);overscroll-behavior:none;
min-height:100vh;display:flex;flex-direction:column}
button,input,select,textarea{font:inherit;color:inherit}
button{cursor:pointer;border:none;background:transparent}
button:disabled{opacity:.6;cursor:not-allowed}
.hidden{display:none!important}
.container{max-width:1200px;margin:0 auto;padding:var(--spacing-md)}
.page{flex:1;overflow-y:auto;padding:var(--spacing-md);padding-bottom:5rem}
.card{background:#fff;border-radius:.75rem;padding:var(--spacing-md);box-shadow:0 1px 3px rgba(0,0,0,.1)}
.btn{padding:.625rem var(--spacing-lg);border-radius:.5rem;font-weight:600;font-size:.875rem;
transition:all .2s;display:inline-flex;align-items:center;gap:var(--spacing-sm)}
.btn-primary{background:var(--blue-600);color:#fff}
.btn-primary:hover:not(:disabled){background:var(--blue-700)}
.btn-secondary{background:var(--gray-100);color:var(--gray-700)}
.btn-danger{background:var(--red-600);color:#fff}
.btn-success{background:var(--green-600);color:#fff}
.input{width:100%;padding:.75rem;background:var(--gray-100);border:1px solid var(--gray-100);
border-radius:.625rem;font-size:1rem;transition:all .2s}
.input:focus{outline:none;border-color:var(--blue-500);background:#fff;box-shadow:0 0 0 2px var(--blue-100)}
.input:invalid:not(:placeholder-shown){border-color:var(--red-600)}
.label{display:block;font-size:.8125rem;font-weight:500;color:var(--gray-600);margin-bottom:var(--spacing-xs);padding-left:.25rem}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50;display:flex;align-items:center;
justify-content:center;padding:var(--spacing-md);opacity:0;transition:opacity .3s}
.modal-overlay.open{opacity:1}
.modal{background:#fff;border-radius:1rem;padding:var(--spacing-lg);max-width:500px;width:100%;
max-height:90vh;overflow-y:auto;transform:scale(.9);transition:transform .3s}
.modal-overlay.open .modal{transform:scale(1)}
.nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--gray-200);
display:flex;justify-content:space-around;padding:var(--spacing-sm) 0;z-index:40}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:.25rem;padding:var(--spacing-xs) var(--spacing-md);
color:var(--gray-500);font-size:.625rem;font-weight:500;transition:color .2s}
.nav-item.active{color:var(--blue-600)}
.nav-item svg{width:1.5rem;height:1.5rem}
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--gray-200);padding:var(--spacing);
display:flex;align-items:center;justify-content:space-between;z-index:30}
.header-title{font-size:1.25rem;font-weight:700;color:var(--gray-900)}
.header-actions{display:flex;gap:var(--spacing-sm);align-items:center}
.icon-btn{width:2.5rem;height:2.5rem;display:inline-flex;align-items:center;justify-content:center;
border-radius:9999px;color:var(--gray-600);transition:all .2s}
.icon-btn:hover{background:var(--gray-100)}
.icon-btn.locked{color:var(--red-600);background:var(--red-50)}
.toast{position:fixed;top:1rem;left:50%;transform:translateX(-50%);background:var(--gray-900);
color:#fff;padding:var(--spacing) var(--spacing-lg);border-radius:.5rem;font-size:.875rem;
z-index:100;pointer-events:none;opacity:0;transition:opacity .3s}
.toast.show{opacity:1}
.toast.error{background:var(--red-600)}
.metric{text-align:center;padding:var(--spacing-md)}
.metric-label{font-size:.75rem;color:var(--gray-500);text-transform:uppercase;letter-spacing:.05em;margin-bottom:var(--spacing-xs)}
.metric-value{font-size:1.5rem;font-weight:700;color:var(--gray-900)}
.grid{display:grid;gap:var(--spacing-md)}
.grid-2{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
.grid-3{grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}
.list-item{background:#fff;border-radius:.75rem;padding:var(--spacing-md);margin-bottom:var(--spacing-sm);
box-shadow:0 1px 3px rgba(0,0,0,.05);transition:box-shadow .2s}
.list-item:hover{box-shadow:0 4px 12px rgba(0,0,0,.1)}
.list-item-title{font-weight:600;color:var(--gray-900);margin-bottom:.25rem}
.list-item-meta{font-size:.8125rem;color:var(--gray-500)}
.badge{display:inline-flex;align-items:center;padding:.25rem .625rem;border-radius:9999px;
font-size:.75rem;font-weight:600}
.badge-green{background:var(--green-100);color:var(--green-700)}
.badge-red{background:var(--red-100);color:var(--red-700)}
.badge-blue{background:var(--blue-100);color:var(--blue-700)}
.badge-amber{background:var(--amber-100);color:var(--amber-600)}
.segmented{display:flex;background:var(--gray-200);border-radius:.5rem;padding:.125rem;gap:.125rem}
.segmented button{flex:1;padding:.375rem .75rem;border-radius:.375rem;font-size:.8125rem;
font-weight:500;color:var(--gray-600);transition:all .2s}
.segmented button.active{background:#fff;color:var(--gray-900);box-shadow:0 1px 3px rgba(0,0,0,.1)}
.sensitive-mask{filter:blur(6px);opacity:.5;user-select:none}
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
input[type=number]{appearance:textfield}
@media(prefers-reduced-motion:reduce){*,::before,::after{animation-duration:.01ms!important;transition-duration:.01ms!important}}
.camera-preview{position:relative;width:100%;aspect-ratio:4/3;background:var(--gray-900);border-radius:.5rem;overflow:hidden}
.camera-preview video{width:100%;height:100%;object-fit:cover}
.image-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:var(--spacing-sm)}
.image-item{position:relative;aspect-ratio:1;border-radius:.5rem;overflow:hidden;background:var(--gray-200)}
.image-item img{width:100%;height:100%;object-fit:cover}
.image-item button{position:absolute;top:.25rem;right:.25rem;width:1.5rem;height:1.5rem;
border-radius:9999px;background:rgba(0,0,0,.7);color:#fff;font-size:.75rem}
</style>
</head>
<body>
<div id="loader" class="modal-overlay"><div class="modal"><p>Loading...</p></div></div>
<div id="toast" class="toast"></div>

<div id="app" class="hidden">
<header class="header">
<h1 id="page-title" class="header-title">Dashboard</h1>
<div class="header-actions">
<button id="sensitive-toggle" class="icon-btn" title="Toggle sensitive data" aria-label="Lock/Unlock">üîí</button>
<button id="add-button" class="icon-btn hidden" title="Add new" aria-label="Add">‚ûï</button>
</div>
</header>

<main id="page-dashboard" class="page">
<div class="grid grid-2">
<div class="metric card"><div class="metric-label">Cash</div><div id="metric-cash" class="metric-value">‚Çπ0</div></div>
<div class="metric card"><div class="metric-label">Profit</div><div id="metric-profit" class="metric-value">‚Çπ0</div></div>
<div class="metric card"><div class="metric-label">Revenue</div><div id="metric-revenue" class="metric-value">‚Çπ0</div></div>
<div class="metric card"><div class="metric-label">Investment</div><div id="metric-investment" class="metric-value">‚Çπ0</div></div>
</div>
<div class="card" style="margin-top:1rem"><h3 style="font-weight:600;margin-bottom:.5rem">Unsold Bikes</h3><div id="unsold-bikes"></div></div>
</main>

<main id="page-bikes" class="page hidden">
<div class="segmented" style="margin-bottom:1rem">
<button data-filter="all" class="active">All</button>
<button data-filter="unsold">Unsold</button>
<button data-filter="sold">Sold</button>
</div>
<input type="search" id="bike-search" class="input" placeholder="Search bikes by name, plate..." style="margin-bottom:1rem">
<div id="bike-list"></div>
</main>

<main id="page-analytics" class="page hidden">
<div class="card" style="margin-bottom:1rem">
<h3 style="font-weight:600;margin-bottom:.5rem">Cash Flow</h3>
<div class="grid grid-2">
<div><span class="label">Inflow</span><div id="analytics-inflow" style="font-weight:600;color:var(--green-600)">‚Çπ0</div></div>
<div><span class="label">Outflow</span><div id="analytics-outflow" style="font-weight:600;color:var(--red-600)">‚Çπ0</div></div>
</div>
</div>
<div class="card">
<h3 style="font-weight:600;margin-bottom:.5rem">Metrics</h3>
<div class="grid grid-2">
<div><span class="label">Total Sales</span><div id="analytics-sales">0</div></div>
<div><span class="label">Avg Profit</span><div id="analytics-avg-profit">‚Çπ0</div></div>
</div>
</div>
</main>

<main id="page-credit" class="page hidden">
<div class="grid grid-3" style="margin-bottom:1rem">
<div class="metric card"><div class="metric-label">Total</div><div id="credit-total" class="metric-value">‚Çπ0</div></div>
<div class="metric card"><div class="metric-label">Collected</div><div id="credit-collected" class="metric-value">‚Çπ0</div></div>
<div class="metric card"><div class="metric-label">Pending</div><div id="credit-pending" class="metric-value">‚Çπ0</div></div>
</div>
<div id="credit-list"></div>
</main>

<main id="page-expenses" class="page hidden">
<div id="expense-list"></div>
</main>

<main id="page-settings" class="page hidden">
<div class="card" style="margin-bottom:1rem">
<h3 style="font-weight:600;margin-bottom:1rem">Security</h3>
<div style="margin-bottom:.5rem"><span class="label">PIN Status</span><span id="pin-status">Not set</span></div>
<button id="setup-pin" class="btn btn-primary">Setup PIN</button>
<button id="enable-biometric" class="btn btn-secondary" style="margin-left:.5rem">Enable Biometric</button>
</div>
<div class="card" style="margin-bottom:1rem">
<h3 style="font-weight:600;margin-bottom:1rem">Backup & Restore</h3>
<button id="backup-btn" class="btn btn-primary">Backup Data</button>
<button id="restore-btn" class="btn btn-secondary" style="margin-left:.5rem">Restore Data</button>
<input type="file" id="restore-file" accept=".enc.json" class="hidden">
</div>
<div class="card">
<h3 style="font-weight:600;margin-bottom:1rem">Data</h3>
<button id="reset-btn" class="btn btn-danger">Reset All Data</button>
</div>
</main>

<nav class="nav">
<button class="nav-item active" data-page="dashboard"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span>Home</span></button>
<button class="nav-item" data-page="bikes"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg><span>Bikes</span></button>
<button class="nav-item" data-page="credit"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg><span>Credit</span></button>
<button class="nav-item" data-page="analytics"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg><span>Stats</span></button>
<button class="nav-item" data-page="settings"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg><span>Settings</span></button>
</nav>
</div>

<div id="modal-overlay" class="modal-overlay">
<div class="modal">
<h2 id="modal-title" style="font-weight:700;font-size:1.25rem;margin-bottom:1rem">Modal</h2>
<div id="modal-body"></div>
<div style="display:flex;gap:.5rem;margin-top:1.5rem">
<button id="modal-save" class="btn btn-primary">Save</button>
<button id="modal-cancel" class="btn btn-secondary">Cancel</button>
</div>
</div>
</div>

<div id="pin-modal" class="modal-overlay">
<div class="modal">
<h2 style="font-weight:700;font-size:1.25rem;margin-bottom:1rem">Enter PIN</h2>
<p id="pin-message" style="color:var(--gray-600);margin-bottom:1rem">Enter your 4-6 digit PIN</p>
<input type="password" id="pin-input" class="input" inputmode="numeric" pattern="[0-9]*" maxlength="12" autocomplete="off" placeholder="PIN" style="margin-bottom:1rem">
<p id="pin-error" class="hidden" style="color:var(--red-600);font-size:.875rem;margin-bottom:1rem"></p>
<div style="display:flex;gap:.5rem">
<button id="pin-submit" class="btn btn-primary">Submit</button>
<button id="pin-cancel" class="btn btn-secondary">Cancel</button>
<button id="pin-biometric" class="btn btn-secondary hidden">Use Biometric</button>
</div>
</div>
</div>

<div id="camera-modal" class="modal-overlay">
<div class="modal">
<h2 style="font-weight:700;font-size:1.25rem;margin-bottom:1rem">Capture Photos</h2>
<div id="camera-preview" class="camera-preview"><video id="camera-video" autoplay playsinline></video></div>
<div id="captured-images" class="image-grid" style="margin-top:1rem"></div>
<div style="display:flex;gap:.5rem;margin-top:1rem">
<button id="camera-capture" class="btn btn-primary">Capture</button>
<button id="camera-done" class="btn btn-success">Done</button>
<button id="camera-cancel" class="btn btn-secondary">Cancel</button>
</div>
</div>
</div>

<script type="module">
const __APP_VERSION__='1.0.0';
const DB_NAME='BikeManagerDB';const DB_VERSION=1;
const STORES={entries:'entries',images:'images',settings:'settings',auth:'auth'};
const PBKDF2_ITERATIONS=250000;
const AES_ALGORITHM='AES-GCM';

// Utility functions
const $=(s,ctx=document)=>ctx.querySelector(s);
const $$=(s,ctx=document)=>[...ctx.querySelectorAll(s)];
const uuid=()=>crypto.randomUUID();
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const fmt=(n)=>new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR',maximumFractionDigits:0}).format(n);
const esc=v=>String(v||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

// Toast notification
let toastTimer;
const toast=(msg,isError=false)=>{
const t=$('#toast');
t.textContent=msg;
t.classList.toggle('error',isError);
t.classList.add('show');
clearTimeout(toastTimer);
toastTimer=setTimeout(()=>t.classList.remove('show'),3000);
};

// IndexedDB wrapper
const db=(()=>{
let _db;
const open=()=>new Promise((res,rej)=>{
if(_db)return res(_db);
const req=indexedDB.open(DB_NAME,DB_VERSION);
req.onerror=()=>rej(req.error);
req.onsuccess=()=>{_db=req.result;res(_db);};
req.onupgradeneeded=e=>{
const d=e.target.result;
if(!d.objectStoreNames.contains(STORES.entries))d.createObjectStore(STORES.entries,{keyPath:'id'});
if(!d.objectStoreNames.contains(STORES.images))d.createObjectStore(STORES.images);
if(!d.objectStoreNames.contains(STORES.settings))d.createObjectStore(STORES.settings);
if(!d.objectStoreNames.contains(STORES.auth))d.createObjectStore(STORES.auth);
};
});
const get=async(store,key)=>{
const d=await open();
return new Promise((res,rej)=>{
const tx=d.transaction(store,'readonly');
const req=tx.objectStore(store).get(key);
req.onsuccess=()=>res(req.result);
req.onerror=()=>rej(req.error);
});
};
const set=async(store,value,key)=>{
const d=await open();
return new Promise((res,rej)=>{
const tx=d.transaction(store,'readwrite');
const req=key?tx.objectStore(store).put(value,key):tx.objectStore(store).put(value);
req.onsuccess=()=>res(req.result);
req.onerror=()=>rej(req.error);
});
};
const del=async(store,key)=>{
const d=await open();
return new Promise((res,rej)=>{
const tx=d.transaction(store,'readwrite');
const req=tx.objectStore(store).delete(key);
req.onsuccess=()=>res();
req.onerror=()=>rej(req.error);
});
};
const getAll=async(store)=>{
const d=await open();
return new Promise((res,rej)=>{
const tx=d.transaction(store,'readonly');
const req=tx.objectStore(store).getAll();
req.onsuccess=()=>res(req.result);
req.onerror=()=>rej(req.error);
});
};
const clear=async(store)=>{
const d=await open();
return new Promise((res,rej)=>{
const tx=d.transaction(store,'readwrite');
const req=tx.objectStore(store).clear();
req.onsuccess=()=>res();
req.onerror=()=>rej(req.error);
});
};
return{get,set,del,getAll,clear};
})();

// Crypto module
const crypto_=(()=>{
const deriveKey=async(pin,salt)=>{
const enc=new TextEncoder();
const keyMaterial=await crypto.subtle.importKey('raw',enc.encode(pin),{name:'PBKDF2'},false,['deriveBits','deriveKey']);
return await crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:PBKDF2_ITERATIONS,hash:'SHA-256'},keyMaterial,{name:AES_ALGORITHM,length:256},false,['encrypt','decrypt']);
};
const encrypt=async(data,pin)=>{
const salt=crypto.getRandomValues(new Uint8Array(16));
const iv=crypto.getRandomValues(new Uint8Array(12));
const key=await deriveKey(pin,salt);
const enc=new TextEncoder();
const cipher=await crypto.subtle.encrypt({name:AES_ALGORITHM,iv},key,enc.encode(JSON.stringify(data)));
return{salt:Array.from(salt),iv:Array.from(iv),cipher:Array.from(new Uint8Array(cipher))};
};
const decrypt=async(encrypted,pin)=>{
const{salt,iv,cipher}=encrypted;
const key=await deriveKey(pin,new Uint8Array(salt));
const dec=new TextDecoder();
const plain=await crypto.subtle.decrypt({name:AES_ALGORITHM,iv:new Uint8Array(iv)},key,new Uint8Array(cipher));
return JSON.parse(dec.decode(plain));
};
const hashPIN=async(pin,salt)=>{
const enc=new TextEncoder();
const keyMaterial=await crypto.subtle.importKey('raw',enc.encode(pin),{name:'PBKDF2'},false,['deriveBits']);
const bits=await crypto.subtle.deriveBits({name:'PBKDF2',salt,iterations:PBKDF2_ITERATIONS,hash:'SHA-256'},keyMaterial,256);
return Array.from(new Uint8Array(bits));
};
return{encrypt,decrypt,hashPIN};
})();

// Auth module
const auth=(()=>{
let sessionKey=null;
let isLocked=true;
const setupPIN=async(pin)=>{
if(!/^\d{4,12}$/.test(pin))throw new Error('PIN must be 4-12 digits');
const salt=crypto.getRandomValues(new Uint8Array(16));
const hash=await crypto_.hashPIN(pin,salt);
await db.set(STORES.auth,{salt:Array.from(salt),hash},'pin');
toast('PIN set successfully');
};
const verifyPIN=async(pin)=>{
const stored=await db.get(STORES.auth,'pin');
if(!stored)throw new Error('PIN not set');
const hash=await crypto_.hashPIN(pin,new Uint8Array(stored.salt));
const match=hash.every((v,i)=>v===stored.hash[i]);
if(!match)throw new Error('Incorrect PIN');
sessionKey=pin;
isLocked=false;
return true;
};
const setupBiometric=async()=>{
if(!window.PublicKeyCredential)throw new Error('Biometric not supported');
const challenge=crypto.getRandomValues(new Uint8Array(32));
const credential=await navigator.credentials.create({
publicKey:{
challenge,
rp:{name:'Bike Manager',id:location.hostname},
user:{id:crypto.getRandomValues(new Uint8Array(16)),name:'user',displayName:'User'},
pubKeyCredParams:[{type:'public-key',alg:-7},{type:'public-key',alg:-257}],
authenticatorSelection:{authenticatorAttachment:'platform',userVerification:'required'},
timeout:60000
}
});
await db.set(STORES.auth,{id:credential.id,rawId:Array.from(new Uint8Array(credential.rawId))},'biometric');
toast('Biometric enabled');
};
const verifyBiometric=async()=>{
const stored=await db.get(STORES.auth,'biometric');
if(!stored)throw new Error('Biometric not set up');
const challenge=crypto.getRandomValues(new Uint8Array(32));
const assertion=await navigator.credentials.get({
publicKey:{
challenge,
allowCredentials:[{type:'public-key',id:new Uint8Array(stored.rawId)}],
userVerification:'required',
timeout:60000
}
});
if(!assertion)throw new Error('Biometric verification failed');
const pinData=await db.get(STORES.auth,'pin');
if(pinData){
const mockPIN='0'.repeat(6);
sessionKey=mockPIN;
}
isLocked=false;
return true;
};
const lock=()=>{
sessionKey=null;
isLocked=true;
};
const unlock=async(pin)=>await verifyPIN(pin);
const isUnlocked=()=>!isLocked;
const getKey=()=>sessionKey;
return{setupPIN,verifyPIN,setupBiometric,verifyBiometric,lock,unlock,isUnlocked,getKey};
})();

// Camera module
const camera=(()=>{
let stream=null;
let capturedImages=[];
const start=async()=>{
try{
stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
const video=$('#camera-video');
video.srcObject=stream;
await video.play();
return true;
}catch(e){
toast('Camera access denied',true);
return false;
}
};
const stop=()=>{
if(stream){
stream.getTracks().forEach(t=>t.stop());
stream=null;
}
};
const capture=async()=>{
const video=$('#camera-video');
const canvas=document.createElement('canvas');
const maxDim=1920;
let w=video.videoWidth,h=video.videoHeight;
if(w>maxDim||h>maxDim){
if(w>h){
h=(h/w)*maxDim;
w=maxDim;
}else{
w=(w/h)*maxDim;
h=maxDim;
}
}
canvas.width=w;
canvas.height=h;
const ctx=canvas.getContext('2d');
ctx.drawImage(video,0,0,w,h);
const blob=await new Promise(res=>canvas.toBlob(res,'image/webp',.85));
const id=uuid();
const url=URL.createObjectURL(blob);
capturedImages.push({id,blob,url,width:w,height:h,size:blob.size});
await db.set(STORES.images,blob,id);
return{id,url};
};
const getImages=()=>[...capturedImages];
const reset=()=>{
capturedImages.forEach(img=>URL.revokeObjectURL(img.url));
capturedImages=[];
};
return{start,stop,capture,getImages,reset};
})();

// Camera modal handlers
const openCameraModal=()=>{
$('#camera-modal').classList.add('open');
camera.start().then(started=>{
if(!started){
$('#camera-modal').classList.remove('open');
}
});
};

$('#camera-capture').addEventListener('click',async()=>{
const{id,url}=await camera.capture();
const container=$('#captured-images');
const div=document.createElement('div');
div.className='image-item';
div.innerHTML=`<img src="${url}" alt="Captured"><button onclick="removeImage('${id}')">‚úï</button>`;
container.appendChild(div);
toast('Photo captured');
});

$('#camera-done').addEventListener('click',()=>{
camera.stop();
$('#camera-modal').classList.remove('open');
const images=camera.getImages();
toast(`${images.length} photo(s) saved`);
});

$('#camera-cancel').addEventListener('click',()=>{
camera.stop();
camera.reset();
$('#captured-images').innerHTML='';
$('#camera-modal').classList.remove('open');
});

window.removeImage=async id=>{
camera.getImages().forEach(img=>{
if(img.id===id){
URL.revokeObjectURL(img.url);
}
});
await db.del(STORES.images,id);
const imgs=camera.getImages().filter(img=>img.id!==id);
camera.reset();
imgs.forEach(img=>camera.getImages().push(img));
$(`[data-image-id="${id}"]`)?.remove();
toast('Photo removed');
};

// Backup module
const backup=(()=>{
const exportData=async()=>{
if(!auth.isUnlocked()){
toast('Unlock to backup',true);
return;
}
const entries=await db.getAll(STORES.entries);
const settings=await db.getAll(STORES.settings);
const data={version:1,entries,settings,timestamp:new Date().toISOString()};
const pin=auth.getKey();
if(!pin){
toast('Session expired',true);
return;
}
const encrypted=await crypto_.encrypt(data,pin);
const json=JSON.stringify({version:1,data:encrypted});
const blob=new Blob([json],{type:'application/json'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`bike-backup-${new Date().toISOString().split('T')[0]}.enc.json`;
a.click();
URL.revokeObjectURL(url);
toast('Backup downloaded');
};
const importData=async(file)=>{
if(!auth.isUnlocked()){
toast('Unlock to restore',true);
return;
}
const text=await file.text();
const parsed=JSON.parse(text);
if(parsed.version!==1)throw new Error('Unsupported backup version');
const pin=auth.getKey();
if(!pin){
toast('Session expired',true);
return;
}
const decrypted=await crypto_.decrypt(parsed.data,pin);
if(!confirm(`Restore ${decrypted.entries?.length||0} entries? This will replace current data.`))return;
await db.clear(STORES.entries);
for(const entry of decrypted.entries||[]){
await db.set(STORES.entries,entry);
}
toast('Data restored');
location.reload();
};
return{exportData,importData};
})();

// App state
const state={
page:'dashboard',
filter:'all',
search:'',
locked:true,
bikes:[],
expenses:[],
payments:[]
};

// Render functions
const renderDashboard=()=>{
const bikes=state.bikes;
const unsold=bikes.filter(b=>!b.sold);
const sold=bikes.filter(b=>b.sold);
const investment=unsold.reduce((s,b)=>s+(b.purchasePrice||0)+(b.repairPrice||0),0);
const revenue=sold.reduce((s,b)=>s+(b.sellingPrice||0),0);
const cost=sold.reduce((s,b)=>s+(b.purchasePrice||0)+(b.repairPrice||0),0);
const profit=revenue-cost;
const cashReceived=state.payments.reduce((s,p)=>s+p.amount,0);
const expenseTotal=state.expenses.reduce((s,e)=>s+e.amount,0);
const cash=cashReceived-cost-expenseTotal;
const mask=state.locked;
$('#metric-cash').textContent=mask?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢':fmt(cash);
$('#metric-profit').textContent=mask?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢':fmt(profit);
$('#metric-revenue').textContent=mask?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢':fmt(revenue);
$('#metric-investment').textContent=fmt(investment);
const unsoldHTML=unsold.length?unsold.slice(0,5).map(b=>`
<div class="list-item">
<div class="list-item-title">${esc(b.name||'Bike')}</div>
<div class="list-item-meta">${fmt((b.purchasePrice||0)+(b.repairPrice||0))}</div>
</div>
`).join(''):'<p style="color:var(--gray-500)">No unsold bikes</p>';
$('#unsold-bikes').innerHTML=unsoldHTML;
};

const renderBikes=()=>{
const filtered=state.bikes.filter(b=>{
if(state.filter==='unsold'&&b.sold)return false;
if(state.filter==='sold'&&!b.sold)return false;
if(state.search){
const s=state.search.toLowerCase();
return(b.name||'').toLowerCase().includes(s)||(b.plate||'').toLowerCase().includes(s);
}
return true;
});
const html=filtered.length?filtered.map(b=>{
const cost=(b.purchasePrice||0)+(b.repairPrice||0);
const profit=b.sold?((b.sellingPrice||0)-cost):0;
return`
<div class="list-item">
<div style="display:flex;justify-content:space-between;align-items:start">
<div style="flex:1">
<div class="list-item-title">${esc(b.name||'Bike')} ${b.sold?'<span class="badge badge-green">Sold</span>':'<span class="badge badge-amber">Unsold</span>'}</div>
${b.plate?`<div class="list-item-meta">${esc(b.plate)}</div>`:''}
<div class="list-item-meta">Cost: ${fmt(cost)} ${b.sold?` | Sold: ${fmt(b.sellingPrice||0)} | Profit: ${fmt(profit)}`:`| Target: ${fmt(b.targetPrice||0)}`}</div>
${b.sold&&b.customerName?`<div class="list-item-meta">Customer: ${esc(b.customerName)} ${b.paymentMode==='credit'?'<span class="badge badge-blue">Credit</span>':''}</div>`:''}
</div>
<div style="display:flex;gap:.5rem">
<button onclick="editBike('${b.id}')" class="icon-btn" title="Edit">‚úèÔ∏è</button>
<button onclick="deleteBike('${b.id}')" class="icon-btn" title="Delete">üóëÔ∏è</button>
</div>
</div>
</div>
`;}).join(''):'<p style="color:var(--gray-500);text-align:center;padding:2rem">No bikes found</p>';
$('#bike-list').innerHTML=html;
};

window.editBike=id=>{
const bike=state.bikes.find(b=>b.id===id);
if(bike)openBikeModal(bike);
};

window.deleteBike=async id=>{
if(!confirm('Delete this bike?'))return;
await db.del(STORES.entries,id);
state.bikes=state.bikes.filter(b=>b.id!==id);
toast('Bike deleted');
render();
};

const renderAnalytics=()=>{
const sold=state.bikes.filter(b=>b.sold);
const cashReceived=state.payments.reduce((s,p)=>s+p.amount,0);
const totalCost=sold.reduce((s,b)=>s+(b.purchasePrice||0)+(b.repairPrice||0),0);
const expenseTotal=state.expenses.reduce((s,e)=>s+e.amount,0);
const revenue=sold.reduce((s,b)=>s+(b.sellingPrice||0),0);
const inflow=cashReceived;
const outflow=totalCost+expenseTotal;
const avgProfit=sold.length?(revenue-totalCost)/sold.length:0;
const mask=state.locked;
if($('#analytics-inflow'))$('#analytics-inflow').textContent=mask?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢':fmt(inflow);
if($('#analytics-outflow'))$('#analytics-outflow').textContent=mask?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢':fmt(outflow);
if($('#analytics-sales'))$('#analytics-sales').textContent=sold.length;
if($('#analytics-avg-profit'))$('#analytics-avg-profit').textContent=mask?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢':fmt(avgProfit);
};

const renderCredit=()=>{
const credits=state.bikes.filter(b=>b.sold&&b.paymentMode==='credit');
const total=credits.reduce((s,b)=>s+(b.sellingPrice||0),0);
const collected=credits.reduce((s,b)=>s+(b.creditPaid||0),0);
const pending=total-collected;
const mask=state.locked;
$('#credit-total').textContent=mask?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢':fmt(total);
$('#credit-collected').textContent=mask?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢':fmt(collected);
$('#credit-pending').textContent=mask?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢':fmt(pending);
const html=credits.length?credits.map(b=>`
<div class="list-item">
<div class="list-item-title">${esc(b.customerName||'Customer')}</div>
<div class="list-item-meta">${esc(b.name||'Bike')} | Total: ${fmt(b.sellingPrice||0)}</div>
<div class="list-item-meta">Paid: ${fmt(b.creditPaid||0)} | Pending: ${fmt((b.sellingPrice||0)-(b.creditPaid||0))}</div>
</div>
`).join(''):'<p style="color:var(--gray-500)">No credit records</p>';
$('#credit-list').innerHTML=html;
};

const renderExpenses=()=>{
const html=state.expenses.length?state.expenses.map(e=>`
<div class="list-item">
<div class="list-item-title">${esc(e.description||'Expense')}</div>
<div class="list-item-meta">${fmt(e.amount||0)} | ${new Date(e.date).toLocaleDateString()}</div>
</div>
`).join(''):'<p style="color:var(--gray-500)">No expenses</p>';
$('#expense-list').innerHTML=html;
};

const render=()=>{
const pages={dashboard:renderDashboard,bikes:renderBikes,credit:renderCredit,expenses:renderExpenses,analytics:renderAnalytics};
if(pages[state.page])pages[state.page]();
};

// Add button handler
let currentModalType=null;
$('#add-button').addEventListener('click',()=>{
if(state.page==='bikes')openBikeModal();
else if(state.page==='expenses')openExpenseModal();
});

// Open bike modal
const openBikeModal=(bike=null)=>{
currentModalType='bike';
const editing=!!bike;
$('#modal-title').textContent=editing?'Edit Bike':'Add Bike';
$('#modal-body').innerHTML=`
<div style="margin-bottom:1rem"><label class="label">Bike Name *</label><input type="text" id="form-bike-name" class="input" required minlength="2" maxlength="50" value="${esc(bike?.name||'')}" placeholder="e.g., Honda CB Shine"></div>
<div style="margin-bottom:1rem"><label class="label">Number Plate</label><input type="text" id="form-bike-plate" class="input" maxlength="20" value="${esc(bike?.plate||'')}" placeholder="KA01AB1234"></div>
<div style="margin-bottom:1rem"><label class="label">Purchase Price *</label><input type="number" id="form-bike-purchase" class="input" required min="0" step="100" value="${bike?.purchasePrice||''}"></div>
<div style="margin-bottom:1rem"><label class="label">Repair Cost</label><input type="number" id="form-bike-repair" class="input" min="0" step="100" value="${bike?.repairPrice||0}"></div>
<div style="margin-bottom:1rem"><label class="label">Purchase Date *</label><input type="date" id="form-bike-date" class="input" required value="${bike?.purchaseDate||new Date().toISOString().split('T')[0]}"></div>
${bike?.sold?`
<div style="margin-bottom:1rem"><label class="label">Selling Price *</label><input type="number" id="form-bike-selling" class="input" required min="0" step="100" value="${bike?.sellingPrice||''}"></div>
<div style="margin-bottom:1rem"><label class="label">Customer Name</label><input type="text" id="form-bike-customer" class="input" maxlength="50" value="${esc(bike?.customerName||'')}"></div>
<div style="margin-bottom:1rem"><label class="label">Payment Mode</label><select id="form-bike-payment" class="input"><option value="cash" ${bike?.paymentMode==='cash'?'selected':''}>Cash</option><option value="credit" ${bike?.paymentMode==='credit'?'selected':''}>Credit</option><option value="emi" ${bike?.paymentMode==='emi'?'selected':''}>EMI</option></select></div>
${bike?.paymentMode==='credit'?`<div style="margin-bottom:1rem"><label class="label">Credit Paid</label><input type="number" id="form-bike-credit-paid" class="input" min="0" step="100" value="${bike?.creditPaid||0}"></div>`:''}
`:'<div style="margin-bottom:1rem"><label><input type="checkbox" id="form-bike-sold"> Mark as Sold</label></div>'}
`;
$('#modal-overlay').classList.add('open');
const soldCheckbox=$('#form-bike-sold');
if(soldCheckbox){
soldCheckbox.addEventListener('change',e=>{
if(e.target.checked){
$('#modal-body').innerHTML+=`
<div style="margin-bottom:1rem"><label class="label">Selling Price *</label><input type="number" id="form-bike-selling" class="input" required min="0" step="100"></div>
<div style="margin-bottom:1rem"><label class="label">Customer Name</label><input type="text" id="form-bike-customer" class="input" maxlength="50"></div>
<div style="margin-bottom:1rem"><label class="label">Payment Mode</label><select id="form-bike-payment" class="input"><option value="cash">Cash</option><option value="credit">Credit</option></select></div>
`;
}
});
}
$('#modal-save').onclick=async()=>{
const name=$('#form-bike-name')?.value.trim();
const plate=$('#form-bike-plate')?.value.trim();
const purchase=parseFloat($('#form-bike-purchase')?.value)||0;
const repair=parseFloat($('#form-bike-repair')?.value)||0;
const date=$('#form-bike-date')?.value;
const sold=$('#form-bike-sold')?.checked||bike?.sold||false;
if(!name||purchase<=0||!date){
toast('Please fill required fields',true);
return;
}
const bikeData={
id:bike?.id||uuid(),
type:'bike',
name,
plate,
purchasePrice:purchase,
repairPrice:repair,
purchaseDate:date,
sold,
createdAt:bike?.createdAt||new Date().toISOString(),
updatedAt:new Date().toISOString()
};
if(sold){
const selling=parseFloat($('#form-bike-selling')?.value)||0;
const customer=$('#form-bike-customer')?.value.trim()||'';
const payment=$('#form-bike-payment')?.value||'cash';
const creditPaid=parseFloat($('#form-bike-credit-paid')?.value)||0;
if(selling<=0){
toast('Selling price required',true);
return;
}
bikeData.sellingPrice=selling;
bikeData.customerName=customer;
bikeData.paymentMode=payment;
if(payment==='credit')bikeData.creditPaid=creditPaid;
}
await db.set(STORES.entries,bikeData);
if(editing){
const idx=state.bikes.findIndex(b=>b.id===bike.id);
if(idx>=0)state.bikes[idx]=bikeData;
}else{
state.bikes.push(bikeData);
}
$('#modal-overlay').classList.remove('open');
toast(editing?'Bike updated':'Bike added');
render();
};
};

// Open expense modal
const openExpenseModal=(expense=null)=>{
currentModalType='expense';
const editing=!!expense;
$('#modal-title').textContent=editing?'Edit Expense':'Add Expense';
$('#modal-body').innerHTML=`
<div style="margin-bottom:1rem"><label class="label">Description *</label><input type="text" id="form-expense-desc" class="input" required minlength="2" maxlength="100" value="${esc(expense?.description||'')}" placeholder="e.g., Fuel, Rent"></div>
<div style="margin-bottom:1rem"><label class="label">Amount *</label><input type="number" id="form-expense-amount" class="input" required min="1" step="10" value="${expense?.amount||''}"></div>
<div style="margin-bottom:1rem"><label class="label">Date *</label><input type="date" id="form-expense-date" class="input" required value="${expense?.date||new Date().toISOString().split('T')[0]}"></div>
`;
$('#modal-overlay').classList.add('open');
$('#modal-save').onclick=async()=>{
const desc=$('#form-expense-desc')?.value.trim();
const amount=parseFloat($('#form-expense-amount')?.value)||0;
const date=$('#form-expense-date')?.value;
if(!desc||amount<=0||!date){
toast('Please fill all fields',true);
return;
}
const expenseData={
id:expense?.id||uuid(),
type:'expense',
description:desc,
amount,
date,
createdAt:expense?.createdAt||new Date().toISOString(),
updatedAt:new Date().toISOString()
};
await db.set(STORES.entries,expenseData);
if(editing){
const idx=state.expenses.findIndex(e=>e.id===expense.id);
if(idx>=0)state.expenses[idx]=expenseData;
}else{
state.expenses.push(expenseData);
}
$('#modal-overlay').classList.remove('open');
toast(editing?'Expense updated':'Expense added');
render();
};
};

// Modal cancel
$('#modal-cancel').addEventListener('click',()=>{
$('#modal-overlay').classList.remove('open');
});

// Navigation
$$('.nav-item').forEach(btn=>{
btn.addEventListener('click',()=>{
const page=btn.dataset.page;
$$('.page').forEach(p=>p.classList.add('hidden'));
$(`#page-${page}`).classList.remove('hidden');
$$('.nav-item').forEach(n=>n.classList.remove('active'));
btn.classList.add('active');
$('#page-title').textContent=btn.querySelector('span').textContent;
state.page=page;
$('#add-button').classList.toggle('hidden',!['bikes','expenses'].includes(page));
render();
});
});

// Filter bikes
$$('[data-filter]').forEach(btn=>{
btn.addEventListener('click',()=>{
$$('[data-filter]').forEach(b=>b.classList.remove('active'));
btn.classList.add('active');
state.filter=btn.dataset.filter;
renderBikes();
});
});

// Search bikes
$('#bike-search').addEventListener('input',e=>{
state.search=e.target.value;
renderBikes();
});

// Lock toggle
$('#sensitive-toggle').addEventListener('click',async()=>{
if(state.locked){
const pin=await promptPIN('unlock');
if(pin){
try{
await auth.unlock(pin);
state.locked=false;
$('#sensitive-toggle').classList.remove('locked');
$('#sensitive-toggle').textContent='üîì';
toast('Unlocked');
render();
}catch(e){
toast(e.message,true);
}
}
}else{
auth.lock();
state.locked=true;
$('#sensitive-toggle').classList.add('locked');
$('#sensitive-toggle').textContent='üîí';
toast('Locked');
render();
}
});

// PIN modal
const promptPIN=(mode='unlock')=>new Promise(res=>{
const modal=$('#pin-modal');
const input=$('#pin-input');
const error=$('#pin-error');
const submit=$('#pin-submit');
const cancel=$('#pin-cancel');
const biometric=$('#pin-biometric');
$('#pin-message').textContent=mode==='setup'?'Enter a 4-12 digit PIN':'Enter your PIN to unlock';
input.value='';
error.classList.add('hidden');
modal.classList.add('open');
biometric.classList.toggle('hidden',mode==='setup'||!window.PublicKeyCredential);
const cleanup=()=>{
modal.classList.remove('open');
submit.removeEventListener('click',onSubmit);
cancel.removeEventListener('click',onCancel);
biometric.removeEventListener('click',onBiometric);
};
const onSubmit=async()=>{
const pin=input.value.trim();
if(!/^\d{4,12}$/.test(pin)){
error.textContent='PIN must be 4-12 digits';
error.classList.remove('hidden');
return;
}
cleanup();
res(pin);
};
const onCancel=()=>{
cleanup();
res(null);
};
const onBiometric=async()=>{
try{
await auth.verifyBiometric();
cleanup();
res('biometric');
}catch(e){
error.textContent=e.message;
error.classList.remove('hidden');
}
};
submit.addEventListener('click',onSubmit);
cancel.addEventListener('click',onCancel);
biometric.addEventListener('click',onBiometric);
});

// Setup PIN
$('#setup-pin').addEventListener('click',async()=>{
const pin=await promptPIN('setup');
if(pin&&pin!=='biometric'){
try{
await auth.setupPIN(pin);
$('#pin-status').textContent='Set';
}catch(e){
toast(e.message,true);
}
}
});

// Enable biometric
$('#enable-biometric').addEventListener('click',async()=>{
if(!auth.isUnlocked()){
toast('Unlock first',true);
return;
}
try{
await auth.setupBiometric();
}catch(e){
toast(e.message,true);
}
});

// Backup
$('#backup-btn').addEventListener('click',async()=>{
try{
await backup.exportData();
}catch(e){
toast(e.message,true);
}
});

// Restore
$('#restore-btn').addEventListener('click',()=>$('#restore-file').click());
$('#restore-file').addEventListener('change',async e=>{
const file=e.target.files[0];
if(!file)return;
try{
await backup.importData(file);
}catch(e){
toast(e.message,true);
}
e.target.value='';
});

// Reset
$('#reset-btn').addEventListener('click',async()=>{
if(!confirm('Delete ALL data? This cannot be undone!'))return;
await db.clear(STORES.entries);
await db.clear(STORES.images);
await db.clear(STORES.settings);
await db.clear(STORES.auth);
toast('Data reset');
location.reload();
});

// PWA update check
let swRegistration;
const checkForUpdate=async()=>{
if(!swRegistration)return;
try{
await swRegistration.update();
}catch(e){
console.warn('Update check failed:',e);
}
};

// Storage quota check
const checkStorageQuota=async()=>{
if(!navigator.storage||!navigator.storage.estimate)return;
try{
const{usage,quota}=await navigator.storage.estimate();
const percent=((usage/quota)*100).toFixed(1);
if(percent>80){
toast(`Storage ${percent}% full`,true);
}
}catch(e){
console.warn('Quota check failed:',e);
}
};

// Initialize
(async()=>{
try{
const pinData=await db.get(STORES.auth,'pin');
$('#pin-status').textContent=pinData?'Set':'Not set';
const entries=await db.getAll(STORES.entries);
state.bikes=entries.filter(e=>e.type==='bike')||[];
state.expenses=entries.filter(e=>e.type==='expense')||[];
state.payments=entries.filter(e=>e.type==='payment')||[];
// Migrate from localStorage if needed
const oldData=localStorage.getItem('bikeManagerData');
if(oldData&&state.bikes.length===0){
const parsed=JSON.parse(oldData);
for(const bike of parsed.bikes||[]){
await db.set(STORES.entries,{...bike,id:bike.id||uuid(),type:'bike'});
}
state.bikes=parsed.bikes||[];
toast('Migrated from old storage');
localStorage.removeItem('bikeManagerData');
}
render();
$('#app').classList.remove('hidden');
$('#loader').classList.add('hidden');
// Register SW
if('serviceWorker'in navigator){
swRegistration=await navigator.serviceWorker.register('./sw.js');
swRegistration.addEventListener('updatefound',()=>{
const newWorker=swRegistration.installing;
newWorker.addEventListener('statechange',()=>{
if(newWorker.state==='installed'&&navigator.serviceWorker.controller){
if(confirm('New version available. Update now?')){
newWorker.postMessage('SKIP_WAITING');
location.reload();
}
}
});
});
// Check for updates periodically
setInterval(checkForUpdate,1000*60*30);
}
// Check storage quota
await checkStorageQuota();
// Auto-lock after inactivity (5 minutes)
let inactivityTimer;
const resetInactivity=()=>{
clearTimeout(inactivityTimer);
if(!state.locked){
inactivityTimer=setTimeout(()=>{
if(!state.locked){
$('#sensitive-toggle').click();
}
},1000*60*5);
}
};
['click','touchstart','keypress'].forEach(evt=>{
document.addEventListener(evt,resetInactivity,{passive:true});
});
resetInactivity();
}catch(e){
console.error(e);
toast('Failed to load app',true);
}
})();
</script>
</body>
</html>
