<!DOCTYPE html>
<html lang="en" class=""> <!-- 'dark' class will be added here -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Manager v9.0</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles for animations and specific elements */
        :root {
            color-scheme: light;
        }
        .dark {
            color-scheme: dark;
        }
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        /* Style for the active filter button */
        .filter-active {
            @apply bg-blue-600 text-white dark:bg-blue-500;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            @apply bg-gray-200 dark:bg-gray-800;
        }
        ::-webkit-scrollbar-thumb {
            @apply bg-gray-400 dark:bg-gray-600 rounded-lg;
        }
        ::-webkit-scrollbar-thumb:hover {
            @apply bg-gray-500 dark:bg-gray-500;
        }
        /* Custom modal backdrop */
        .modal-backdrop {
            @apply fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center z-40 p-4 opacity-0 invisible transition-opacity duration-300;
        }
        .modal-open {
            @apply opacity-100 visible;
        }
        .modal-content {
            @apply bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg relative transition-transform duration-300 transform scale-95;
        }
        .modal-open .modal-content {
            @apply scale-100;
        }
    </style>
    <script>
        // Apply dark mode immediately from localStorage
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100">

    <!-- Main Application Wrapper -->
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8">

        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
            <h1 class="text-3xl font-bold text-blue-700 dark:text-blue-500">Bike Manager v9.0</h1>
            <div class="flex items-center gap-3">
                <div class="text-xs text-gray-500 dark:text-gray-400 p-2 bg-gray-200 dark:bg-gray-800 rounded-lg" id="auth-status">
                    Connecting...
                </div>
                <button id="dark-mode-toggle" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Toggle dark mode">
                    <!-- Moon Icon -->
                    <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon hidden"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                    <!-- Sun Icon -->
                    <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun hidden"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="hidden">
            <!-- Stats Dashboard & Chart -->
            <section id="dashboard-section" class="grid grid-cols-1 lg:grid-cols-5 gap-4 mb-6">
                <!-- Stats Grid -->
                <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-4" aria-live="polite">
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow">
                        <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Total Profit (Sold)</h2>
                        <p id="stat-profit" class="text-3xl font-bold text-green-600 dark:text-green-500">₹ 0</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow">
                        <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Unsold Investment</h2>
                        <p id="stat-investment" class="text-3xl font-bold text-yellow-600 dark:text-yellow-500">₹ 0</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow">
                        <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Bikes Sold</h2>
                        <p id="stat-sold" class="text-3xl font-bold text-gray-800 dark:text-gray-200">0</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow">
                        <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Bikes Unsold</h2>
                        <p id="stat-unsold" class="text-3xl font-bold text-gray-800 dark:text-gray-200">0</p>
                    </div>
                </div>
                <!-- Chart -->
                <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-5 rounded-lg shadow flex items-center justify-center min-h-[200px]">
                    <canvas id="stats-chart" class="max-w-full max-h-[300px]"></canvas>
                </div>
            </section>

            <!-- Controls: Search, Filter, Actions -->
            <section class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-6 space-y-4">
                <!-- Row 1: Search and Filters -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <!-- Search -->
                    <div class="relative w-full md:w-1/3">
                        <label for="search-bikes" class="sr-only">Search bikes</label>
                        <input type="search" id="search-bikes" placeholder="Search bikes by name or model..." class="w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-gray-500">
                            <!-- Search Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        </div>
                    </div>
                    <!-- Filters -->
                    <div id="filter-buttons" class="flex flex-wrap gap-2">
                        <button data-filter="all" class="filter-btn filter-active px-4 py-2 rounded-lg text-sm font-medium border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">All</button>
                        <button data-filter="latest" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">Latest</button>
                        <button data-filter="sold" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">Sold</button>
                        <button data-filter="unsold" class="filter-btn px-4 py-2 rounded-lg text-sm font-medium border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">Unsold</button>
                    </div>
                </div>
                <!-- Row 2: Actions -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div class="flex flex-wrap gap-2">
                        <button id="export-button" class="action-btn flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <!-- Download Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                            Export Selected
                        </button>
                        <button id="delete-selected-button" class="action-btn flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <!-- Trash Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            Delete Selected
                        </button>
                        <span id="selection-count" class="flex items-center text-sm text-gray-600 dark:text-gray-400 px-3">0 selected</span>
                    </div>
                    <button id="add-bike-button" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-auto">
                        <!-- Plus Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        Buy New Bike
                    </button>
                </div>
            </section>

            <!-- Bike List Table -->
            <section id="bike-list-section" class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full min-w-max">
                        <thead class="bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                            <tr>
                                <th class="p-4 w-12">
                                    <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-300 dark:border-gray-500 text-blue-600 bg-white dark:bg-gray-700 focus:ring-blue-500">
                                </th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Bike Name</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Model</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Buy Price</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Sell Price</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date Added</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bike-list-tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Rows will be injected here by JavaScript -->
                            <!-- Empty State -->
                            <tr id="empty-state-row" class="hidden">
                                <td colspan="8" class="text-center p-16">
                                    <h3 class="text-xl font-medium text-gray-700 dark:text-gray-300">No bikes found.</h3>
                                    <p class="text-gray-500 dark:text-gray-400 mt-2">Click "Buy New Bike" to add your first one!</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

        </main>
    </div>

    <!-- Modals -->

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 dark:bg-gray-900 dark:bg-opacity-90 flex flex-col items-center justify-center z-50 transition-opacity duration-300">
        <!-- Spinner Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2 spinner text-blue-600 dark:text-blue-500"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        <p class="text-lg font-medium text-gray-700 dark:text-gray-300 mt-4">Connecting to database...</p>
    </div>

    <!-- Add New Bike Modal -->
    <div id="add-bike-modal" class="modal-backdrop">
        <div class="modal-content">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" aria-label="Close add bike form">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            <h2 class="text-2xl font-semibold mb-4">Buy New Bike</h2>
            <form id="add-bike-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="add-bike-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bike Name</label>
                        <input type="text" id="add-bike-name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="add-bike-model" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Model</label>
                        <input type="text" id="add-bike-model" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="add-buy-price" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Buy Price (₹)</label>
                    <input type="number" id="add-buy-price" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mt-4">
                    <label for="add-service-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Service Notes</label>
                    <textarea id="add-service-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Add Bike</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Bike Modal -->
    <div id="edit-bike-modal" class="modal-backdrop">
        <div class="modal-content">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" aria-label="Close edit bike form">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            <h2 class="text-2xl font-semibold mb-4">Edit Bike</h2>
            <form id="edit-bike-form">
                <input type="hidden" id="edit-bike-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-bike-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Bike Name</label>
                        <input type="text" id="edit-bike-name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="edit-bike-model" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Model</label>
                        <input type="text" id="edit-bike-model" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="edit-buy-price" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Buy Price (₹)</label>
                    <input type="number" id="edit-buy-price" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mt-4">
                    <label for="edit-service-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Service Notes</label>
                    <textarea id="edit-service-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mark Sold Modal -->
    <div id="mark-sold-modal" class="modal-backdrop">
        <div class="modal-content">
            <button class="modal-close absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" aria-label="Close mark sold form">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            <h2 class="text-2xl font-semibold mb-4">Mark Bike as Sold</h2>
            <form id="mark-sold-form">
                <input type="hidden" id="mark-sold-bike-id">
                <h3 class="text-lg font-medium" id="mark-sold-bike-name"></h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4" id="mark-sold-buy-price"></p>
                
                <div class="mt-4">
                    <label for="sell-price" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sell Price (₹)</label>
                    <input type="number" id="sell-price" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>

                <div class="mt-2 bg-green-100 dark:bg-green-900 border border-green-200 dark:border-green-700 text-green-800 dark:text-green-200 p-3 rounded-lg hidden" id="profit-display">
                    Calculated Profit: <span class="font-bold" id="profit-amount"></span>
                </div>

                <div class="flex justify-end mt-6">
                    <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">Mark as Sold</T>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-delete-modal" class="modal-backdrop">
        <div class="modal-content max-w-sm">
            <h2 class="text-2xl font-semibold mb-4">Are you sure?</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-6" id="confirm-delete-message">This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button id="confirm-delete-cancel" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400">
                    Cancel
                </button>
                <button id="confirm-delete-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Notification / Toast Area -->
    <div id="notification-area" class="fixed bottom-4 right-4 z-50 space-y-2">
        <!-- Notifications will be injected here -->
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc,
            addDoc,
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query,
            writeBatch,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE MANAGEMENT ---
            let state = {
                bikes: [],
                isLoading: true,
                filter: 'all', // 'all', 'sold', 'unsold', 'latest'
                searchTerm: '',
                selectedBikeIds: new Set(),
                isDarkMode: false,
                isAuthReady: false,
                
                // Firebase State
                app: null,
                auth: null,
                db: null,
                userId: null,
                bikesCollectionRef: null,
                bikesUnsubscribe: null, // To stop the listener
                
                // Modal State
                isAddBikeModalOpen: false,
                isEditBikeModalOpen: false,
                editingBike: null,
                isMarkSoldModalOpen: false,
                markingBike: null,
                isConfirmModalOpen: false,
                deleteCallback: null,

                // Chart State
                chartInstance: null,
            };

            // --- DOM ELEMENT SELECTORS ---
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            const dom = {
                html: document.documentElement,
                app: $('#app'),
                mainContent: $('#main-content'),
                loadingOverlay: $('#loading-overlay'),
                
                // Header
                authStatus: $('#auth-status'),
                darkModeToggle: $('#dark-mode-toggle'),
                themeIconMoon: $('#theme-icon-moon'),
                themeIconSun: $('#theme-icon-sun'),

                // Stats & Chart
                statProfit: $('#stat-profit'),
                statInvestment: $('#stat-investment'),
                statSold: $('#stat-sold'),
                statUnsold: $('#stat-unsold'),
                statsChart: $('#stats-chart'),

                // Controls
                searchBikesInput: $('#search-bikes'),
                filterButtonsContainer: $('#filter-buttons'),
                exportButton: $('#export-button'),
                deleteSelectedButton: $('#delete-selected-button'),
                selectionCount: $('#selection-count'),
                addBikeButton: $('#add-bike-button'),

                // Bike List
                bikeListSection: $('#bike-list-section'),
                bikeListTbody: $('#bike-list-tbody'),
                selectAllCheckbox: $('#select-all-checkbox'),
                emptyStateRow: $('#empty-state-row'),

                // Add Bike Modal
                addBikeModal: $('#add-bike-modal'),
                addBikeForm: $('#add-bike-form'),
                addBikeNameInput: $('#add-bike-name'),
                addBikeModelInput: $('#add-bike-model'),
                addBuyPriceInput: $('#add-buy-price'),
                addServiceNotesInput: $('#add-service-notes'),

                // Edit Bike Modal
                editBikeModal: $('#edit-bike-modal'),
                editBikeForm: $('#edit-bike-form'),
                editBikeIdInput: $('#edit-bike-id'),
                editBikeNameInput: $('#edit-bike-name'),
                editBikeModelInput: $('#edit-bike-model'),
                editBuyPriceInput: $('#edit-buy-price'),
                editServiceNotesInput: $('#edit-service-notes'),

                // Mark Sold Modal
                markSoldModal: $('#mark-sold-modal'),
                markSoldForm: $('#mark-sold-form'),
                markSoldBikeIdInput: $('#mark-sold-bike-id'),
                markSoldBikeName: $('#mark-sold-bike-name'),
                markSoldBuyPrice: $('#mark-sold-buy-price'),
                sellPriceInput: $('#sell-price'),
                profitDisplay: $('#profit-display'),
                profitAmount: $('#profit-amount'),

                // Confirm Delete Modal
                confirmDeleteModal: $('#confirm-delete-modal'),
                confirmDeleteMessage: $('#confirm-delete-message'),
                confirmDeleteCancel: $('#confirm-delete-cancel'),
                confirmDeleteConfirm: $('#confirm-delete-confirm'),

                // Notifications
                notificationArea: $('#notification-area'),
            };

            // --- STATE SETTER ---
            function setState(newState) {
                Object.assign(state, newState);
                renderApp();
            }

            // --- FIREBASE FUNCTIONS ---

            /**
             * Initializes the Firebase app, auth, and Firestore.
             * Sets up the authentication listener.
             */
            async function initFirebase() {
                // Get config from global vars provided by the environment
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing.");
                    showNotification("Application is not configured.", "error");
                    setState({ isLoading: false });
                    dom.loadingOverlay.innerHTML = "<p>Application is not configured. Please check console.</p>";
                    return;
                }

                try {
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    setLogLevel('Debug'); // Enable Firestore debug logging

                    // Set persistence to local to keep user signed in
                    await setPersistence(auth, browserLocalPersistence);

                    setState({ app, auth, db });

                    // Listen for auth state changes
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            // User is signed in
                            const userId = user.uid;
                            const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'bikes');
                            
                            setState({ 
                                userId: userId, 
                                isAuthReady: true,
                                bikesCollectionRef: collectionRef
                            });
                            
                            dom.authStatus.textContent = `User ID: ${userId.substring(0, 8)}...`;
                            
                            // Detach old listener if it exists
                            if (state.bikesUnsubscribe) {
                                state.bikesUnsubscribe();
                            }
                            // Attach the real-time listener for bikes
                            attachBikeListener();
                        } else {
                            // User is signed out or not yet signed in
                            setState({ isAuthReady: false, userId: null, bikes: [], isLoading: true });
                            dom.authStatus.textContent = "Authenticating...";
                            
                            // Sign in
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                                // onAuthStateChanged will be triggered again with the new user
                            } catch (error) {
                                console.error("Authentication failed:", error);
                                showNotification("Authentication failed.", "error");
                                setState({ isLoading: false });
                            }
                        }
                    });

                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    showNotification("Application failed to start.", "error");
                    setState({ isLoading: false });
                }
            }

            /**
             * Attaches the Firestore real-time snapshot listener.
             */
            function attachBikeListener() {
                if (!state.isAuthReady || !state.bikesCollectionRef) {
                    return;
                }
                
                setState({ isLoading: true });
                
                const q = query(state.bikesCollectionRef);
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const bikes = [];
                    querySnapshot.forEach((doc) => {
                        bikes.push({ id: doc.id, ...doc.data() });
                    });
                    setState({ bikes: bikes, isLoading: false });
                }, (error) => {
                    console.error("Error listening to bike collection:", error);
                    showNotification("Failed to load bike data.", "error");
                    setState({ isLoading: false });
                });

                // Store the unsubscribe function to clean up later
                setState({ bikesUnsubscribe: unsubscribe });
            }

            // C.R.U.D. Functions
            async function addBikeToFirestore(bike) {
                try {
                    await addDoc(state.bikesCollectionRef, bike);
                    showNotification("Bike added successfully!", "success");
                    handleCloseAddBike();
                } catch (error) {
                    console.error("Error adding document: ", error);
                    showNotification("Failed to add bike.", "error");
                }
            }

            async function updateBikeInFirestore(bikeId, updatedData) {
                try {
                    const bikeDocRef = doc(state.bikesCollectionRef, bikeId);
                    await updateDoc(bikeDocRef, updatedData);
                    showNotification("Bike updated successfully!", "success");
                } catch (error) {
                    console.error("Error updating document: ", error);
                    showNotification("Failed to update bike.", "error");
                }
            }

            async function deleteBikeFromFirestore(bikeId) {
                try {
                    const bikeDocRef = doc(state.bikesCollectionRef, bikeId);
                    await deleteDoc(bikeDocRef);
                    showNotification("Bike deleted.", "success");
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    showNotification("Failed to delete bike.", "error");
                }
            }

            async function batchDeleteBikes(bikeIds) {
                if (bikeIds.size === 0) return;
                
                try {
                    const batch = writeBatch(state.db);
                    bikeIds.forEach(id => {
                        const bikeDocRef = doc(state.bikesCollectionRef, id);
                        batch.delete(bikeDocRef);
                    });
                    await batch.commit();
                    showNotification(`${bikeIds.size} bike(s) deleted.`, "success");
                    setState({ selectedBikeIds: new Set() });
                } catch (error) {
                    console.error("Error batch deleting documents: ", error);
                    showNotification("Failed to delete bikes.", "error");
                }
            }


            // --- RENDER & UI FUNCTIONS ---

            /**
             * Main render function.
             */
            function renderApp() {
                // Render Loading State
                dom.loadingOverlay.classList.toggle('hidden', !state.isLoading);
                dom.mainContent.classList.toggle('hidden', state.isLoading);

                // Render Dark Mode
                dom.html.classList.toggle('dark', state.isDarkMode);
                dom.themeIconMoon.classList.toggle('hidden', state.isDarkMode);
                dom.themeIconSun.classList.toggle('hidden', !state.isDarkMode);

                // Render Modals
                dom.addBikeModal.classList.toggle('modal-open', state.isAddBikeModalOpen);
                dom.editBikeModal.classList.toggle('modal-open', state.isEditBikeModalOpen);
                dom.markSoldModal.classList.toggle('modal-open', state.isMarkSoldModalOpen);
                dom.confirmDeleteModal.classList.toggle('modal-open', state.isConfirmModalOpen);

                if (state.isLoading) return;

                // Calculate stats and filter bikes
                const stats = calculateStats();
                const visibleBikes = getFilteredBikes();

                // Render Stats
                dom.statProfit.textContent = formatCurrency(stats.totalProfit);
                dom.statInvestment.textContent = formatCurrency(stats.unsoldInvestment);
                dom.statSold.textContent = stats.soldCount;
                dom.statUnsold.textContent = stats.unsoldCount;

                // Render Chart
                renderStatsChart(stats);

                // Render Filters
                $$('.filter-btn').forEach(btn => {
                    btn.classList.toggle('filter-active', btn.dataset.filter === state.filter);
                });

                // Render Search
                dom.searchBikesInput.value = state.searchTerm;

                // Render Action Buttons
                const hasSelection = state.selectedBikeIds.size > 0;
                dom.exportButton.disabled = !hasSelection;
                dom.deleteSelectedButton.disabled = !hasSelection;
                dom.selectionCount.textContent = `${state.selectedBikeIds.size} selected`;

                // Render Bike List
                renderBikeList(visibleBikes);
            }

            /**
             * Renders or updates the dashboard pie chart.
             */
            function renderStatsChart(stats) {
                const ctx = dom.statsChart.getContext('2d');
                const data = {
                    labels: ['Sold', 'Unsold'],
                    datasets: [{
                        data: [stats.soldCount, stats.unsoldCount],
                        backgroundColor: [
                            '#16a34a', // green-600
                            '#eab308'  // yellow-500
                        ],
                        hoverBackgroundColor: [
                            '#15803d', // green-700
                            '#ca8a04'  // yellow-600
                        ],
                        borderColor: state.isDarkMode ? '#4b5563' : '#ffffff', // gray-700 or white
                        borderWidth: 2
                    }]
                };

                const options = {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: state.isDarkMode ? '#d1d5db' : '#374151' // gray-300 or gray-700
                            }
                        },
                        tooltip: {
                            bodyFont: {
                                size: 14,
                            },
                        }
                    }
                };

                if (state.chartInstance) {
                    // Update existing chart
                    state.chartInstance.data = data;
                    state.chartInstance.options = options;
                    state.chartInstance.update();
                } else {
                    // Create new chart
                    state.chartInstance = new Chart(ctx, {
                        type: 'pie',
                        data: data,
                        options: options
                    });
                }
            }


            /**
             * Renders the list of bikes into the table.
             */
            function renderBikeList(bikesToRender) {
                dom.bikeListTbody.innerHTML = '';

                if (bikesToRender.length === 0) {
                    dom.emptyStateRow.classList.remove('hidden');
                    dom.bikeListTbody.appendChild(dom.emptyStateRow);
                    dom.selectAllCheckbox.checked = false;
                    dom.selectAllCheckbox.disabled = true;
                    return;
                }

                dom.emptyStateRow.classList.add('hidden');
                dom.selectAllCheckbox.disabled = false;

                const fragment = document.createDocumentFragment();
                bikesToRender.forEach(bike => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700/50';
                    tr.dataset.id = bike.id;
                    const isSelected = state.selectedBikeIds.has(bike.id);

                    tr.innerHTML = `
                        <td class="p-4 w-12">
                            <input type="checkbox" data-id="${bike.id}" class="bike-checkbox h-4 w-4 rounded border-gray-300 dark:border-gray-500 text-blue-600 bg-white dark:bg-gray-700 focus:ring-blue-500" ${isSelected ? 'checked' : ''}>
                        </td>
                        <td class="p-4 text-sm font-medium">
                            ${bike.isSold
                                ? '<span class="px-2 py-0.5 rounded-full bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 text-xs">Sold</span>'
                                : '<span class="px-2 py-0.5 rounded-full bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 text-xs">Unsold</span>'
                            }
                        </td>
                        <td class="p-4 text-sm text-gray-800 dark:text-gray-200 font-medium">${escapeHTML(bike.name)}</td>
                        <td class="p-4 text-sm text-gray-600 dark:text-gray-400">${escapeHTML(bike.model)}</td>
                        <td class="p-4 text-sm text-gray-600 dark:text-gray-400">${formatCurrency(bike.buyPrice)}</td>
                        <td class="p-4 text-sm text-gray-600 dark:text-gray-400">${bike.isSold ? formatCurrency(bike.sellPrice) : 'N/A'}</td>
                        <td class="p-4 text-sm text-gray-600 dark:text-gray-400">${new Date(bike.dateAdded).toLocaleDateString()}</td>
                        <td class="p-4 text-sm">
                            <div class="flex gap-2">
                                ${!bike.isSold ? `
                                <button class="action-mark-sold p-1 text-green-600 hover:text-green-800 dark:text-green-500 dark:hover:text-green-400" data-id="${bike.id}" aria-label="Mark Sold">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
                                </button>
                                ` : ''}
                                <button class="action-edit p-1 text-blue-600 hover:text-blue-800 dark:text-blue-500 dark:hover:text-blue-400" data-id="${bike.id}" aria-label="Edit">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                </button>
                                <button class="action-delete p-1 text-red-600 hover:text-red-800 dark:text-red-500 dark:hover:text-red-400" data-id="${bike.id}" aria-label="Delete">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                </button>
                            </div>
                        </td>
                    `;
                    fragment.appendChild(tr);
                });
                dom.bikeListTbody.appendChild(fragment);

                // Update "Select All" checkbox
                dom.selectAllCheckbox.checked = bikesToRender.length > 0 &&
                    bikesToRender.every(bike => state.selectedBikeIds.has(bike.id));
            }

            /**
             * Displays a toast notification.
             */
            function showNotification(message, type = 'info') {
                const toast = document.createElement('div');
                let bgColor, textColor, icon;

                switch (type) {
                    case 'success':
                        bgColor = 'bg-green-500'; textColor = 'text-white';
                        icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>`;
                        break;
                    case 'error':
                        bgColor = 'bg-red-500'; textColor = 'text-white';
                        icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>`;
                        break;
                    default:
                        bgColor = 'bg-blue-500'; textColor = 'text-white';
                        icon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>`;
                        break;
                }

                toast.className = `flex items-center gap-3 p-4 rounded-lg shadow-lg ${bgColor} ${textColor} transform transition-all duration-300 opacity-0 translate-y-2`;
                toast.setAttribute('role', 'status');
                toast.innerHTML = `
                    <div class="flex-shrink-0">${icon}</div>
                    <p class="font-medium">${escapeHTML(message)}</p>
                `;
                dom.notificationArea.appendChild(toast);

                setTimeout(() => {
                    toast.classList.remove('opacity-0', 'translate-y-2');
                    toast.classList.add('opacity-100', 'translate-y-0');
                }, 10);

                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-2');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }

            // --- DATA & HELPER FUNCTIONS ---

            function calculateStats() {
                const soldBikes = state.bikes.filter(b => b.isSold);
                const unsoldBikes = state.bikes.filter(b => !b.isSold);
                const totalProfit = soldBikes.reduce((acc, b) => acc + ((b.sellPrice || 0) - (b.buyPrice || 0)), 0);
                const unsoldInvestment = unsoldBikes.reduce((acc, b) => acc + (b.buyPrice || 0), 0);
                return { totalProfit, unsoldInvestment, soldCount: soldBikes.length, unsoldCount: unsoldBikes.length };
            }

            function getFilteredBikes() {
                const searchTerm = state.searchTerm.toLowerCase();
                return state.bikes
                    .filter(bike => {
                        const matchesSearch = searchTerm === '' ||
                            bike.name.toLowerCase().includes(searchTerm) ||
                            bike.model.toLowerCase().includes(searchTerm) ||
                            (bike.notes && bike.notes.toLowerCase().includes(searchTerm));
                        const matchesFilter = state.filter === 'all' ||
                            (state.filter === 'sold' && bike.isSold) ||
                            (state.filter === 'unsold' && !bike.isSold) ||
                            state.filter === 'latest';
                        return matchesSearch && matchesFilter;
                    })
                    .sort((a, b) => {
                        if (state.filter === 'latest') {
                            return new Date(b.dateAdded) - new Date(a.dateAdded);
                        }
                        return new Date(a.dateAdded) - new Date(b.dateAdded);
                    });
            }

            function formatCurrency(amount) {
                return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount || 0);
            }

            function escapeHTML(str) {
                if (typeof str !== 'string') return '';
                return str.replace(/[&<>"']/g, match => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[match]));
            }

            // --- EVENT HANDLERS ---

            // Dark Mode
            function handleToggleDarkMode() {
                const newIsDarkMode = !state.isDarkMode;
                localStorage.setItem('darkMode', newIsDarkMode);
                setState({ isDarkMode: newIsDarkMode });
            }

            // Modals
            function handleOpenAddBike() { setState({ isAddBikeModalOpen: true }); }
            function handleCloseAddBike() { dom.addBikeForm.reset(); setState({ isAddBikeModalOpen: false }); }
            
            function handleOpenEditModal(bikeId) {
                const bike = state.bikes.find(b => b.id === bikeId);
                if (bike) {
                    dom.editBikeIdInput.value = bike.id;
                    dom.editBikeNameInput.value = bike.name;
                    dom.editBikeModelInput.value = bike.model || '';
                    dom.editBuyPriceInput.value = bike.buyPrice;
                    dom.editServiceNotesInput.value = bike.notes || '';
                    setState({ isEditBikeModalOpen: true, editingBike: bike });
                }
            }
            function handleCloseEditBike() { dom.editBikeForm.reset(); setState({ isEditBikeModalOpen: false, editingBike: null }); }
            
            function handleOpenMarkSoldModal(bikeId) {
                const bike = state.bikes.find(b => b.id === bikeId);
                if (bike) {
                    dom.markSoldBikeIdInput.value = bike.id;
                    dom.markSoldBikeName.textContent = bike.name;
                    dom.markSoldBuyPrice.textContent = `Buy Price: ${formatCurrency(bike.buyPrice)}`;
                    dom.sellPriceInput.value = bike.buyPrice; // Default sell price to buy price
                    updateProfitDisplay(bike.buyPrice, bike.buyPrice);
                    setState({ isMarkSoldModalOpen: true, markingBike: bike });
                }
            }
            function handleCloseMarkSold() { dom.markSoldForm.reset(); dom.profitDisplay.classList.add('hidden'); setState({ isMarkSoldModalOpen: false, markingBike: null }); }

            function handleOpenConfirmDelete(message, callback) {
                dom.confirmDeleteMessage.textContent = message;
                setState({ isConfirmModalOpen: true, deleteCallback: callback });
            }
            function handleCloseConfirmDelete() { setState({ isConfirmModalOpen: false, deleteCallback: null }); }


            // Add/Edit Forms
            function handleAddBikeSubmit(e) {
                e.preventDefault();
                const newBike = {
                    name: dom.addBikeNameInput.value.trim(),
                    model: dom.addBikeModelInput.value.trim(),
                    buyPrice: parseFloat(dom.addBuyPriceInput.value),
                    notes: dom.addServiceNotesInput.value.trim(),
                    sellPrice: null,
                    isSold: false,
                    dateAdded: new Date().toISOString(),
                };
                if (!newBike.name || isNaN(newBike.buyPrice) || newBike.buyPrice < 0) {
                    showNotification('Please enter a valid name and buy price.', 'error');
                    return;
                }
                addBikeToFirestore(newBike);
            }

            function handleEditBikeSubmit(e) {
                e.preventDefault();
                const bikeId = dom.editBikeIdInput.value;
                const updatedData = {
                    name: dom.editBikeNameInput.value.trim(),
                    model: dom.editBikeModelInput.value.trim(),
                    buyPrice: parseFloat(dom.editBuyPriceInput.value),
                    notes: dom.editServiceNotesInput.value.trim(),
                };
                if (!updatedData.name || isNaN(updatedData.buyPrice) || updatedData.buyPrice < 0) {
                    showNotification('Please enter a valid name and buy price.', 'error');
                    return;
                }
                updateBikeInFirestore(bikeId, updatedData);
                handleCloseEditBike();
            }
            
            // Mark Sold Form
            function handleMarkSoldSubmit(e) {
                e.preventDefault();
                const bikeId = dom.markSoldBikeIdInput.value;
                const sellPrice = parseFloat(dom.sellPriceInput.value);

                if (isNaN(sellPrice) || sellPrice < 0) {
                    showNotification('Please enter a valid sell price.', 'error');
                    return;
                }
                updateBikeInFirestore(bikeId, { isSold: true, sellPrice: sellPrice });
                handleCloseMarkSold();
            }
            
            function updateProfitDisplay(buyPrice, sellPrice) {
                const profit = (sellPrice || 0) - (buyPrice || 0);
                dom.profitAmount.textContent = formatCurrency(profit);
                dom.profitDisplay.classList.remove('hidden');
                dom.profitAmount.classList.toggle('text-red-600', profit < 0);
                dom.profitAmount.classList.toggle('text-green-800', profit >= 0);
                dom.profitAmount.classList.toggle('dark:text-red-400', profit < 0);
                dom.profitAmount.classList.toggle('dark:text-green-200', profit >= 0);
            }

            // Filter & Search
            function handleFilterClick(e) {
                const button = e.target.closest('.filter-btn');
                if (button && button.dataset.filter) {
                    setState({ filter: button.dataset.filter });
                }
            }
            function handleSearchInput(e) { setState({ searchTerm: e.target.value }); }

            // Bike List & Bulk Actions
            function handleSelectAll(e) {
                const isChecked = e.target.checked;
                const visibleBikeIds = getFilteredBikes().map(b => b.id);
                const newSelectedIds = new Set(state.selectedBikeIds);
                if (isChecked) {
                    visibleBikeIds.forEach(id => newSelectedIds.add(id));
                } else {
                    visibleBikeIds.forEach(id => newSelectedIds.delete(id));
                }
                setState({ selectedBikeIds: newSelectedIds });
            }

            function handleBikeListClick(e) {
                // Handle Checkbox
                const checkbox = e.target.closest('.bike-checkbox');
                if (checkbox) {
                    const id = checkbox.dataset.id;
                    const isChecked = checkbox.checked;
                    const newSelectedIds = new Set(state.selectedBikeIds);
                    if (isChecked) newSelectedIds.add(id);
                    else newSelectedIds.delete(id);
                    setState({ selectedBikeIds: newSelectedIds });
                    return;
                }
                
                // Handle Row Actions
                const actionEdit = e.target.closest('.action-edit');
                if (actionEdit) {
                    handleOpenEditModal(actionEdit.dataset.id);
                    return;
                }
                
                const actionDelete = e.target.closest('.action-delete');
                if (actionDelete) {
                    const bikeId = actionDelete.dataset.id;
                    const bike = state.bikes.find(b => b.id === bikeId);
                    handleOpenConfirmDelete(`Delete "${bike.name}"?`, () => {
                        deleteBikeFromFirestore(bikeId);
                    });
                    return;
                }
                
                const actionMarkSold = e.target.closest('.action-mark-sold');
                if (actionMarkSold) {
                    handleOpenMarkSoldModal(actionMarkSold.dataset.id);
                    return;
                }
            }
            
            function handleDeleteSelected() {
                if (state.selectedBikeIds.size === 0) return;
                handleOpenConfirmDelete(`Delete ${state.selectedBikeIds.size} selected bike(s)?`, () => {
                    batchDeleteBikes(state.selectedBikeIds);
                });
            }

            function handleConfirmDelete() {
                if (typeof state.deleteCallback === 'function') {
                    state.deleteCallback();
                }
                handleCloseConfirmDelete();
            }

            function handleExportSelected() {
                if (state.selectedBikeIds.size === 0) return;
                const bikesToExport = state.bikes.filter(bike => state.selectedBikeIds.has(bike.id));
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "ID,Name,Model,BuyPrice,SellPrice,IsSold,DateAdded,Notes\n";
                bikesToExport.forEach(bike => {
                    const row = [
                        bike.id,
                        `"${bike.name.replace(/"/g, '""')}"`,
                        `"${(bike.model || '').replace(/"/g, '""')}"`,
                        bike.buyPrice,
                        bike.sellPrice || '',
                        bike.isSold,
                        bike.dateAdded,
                        `"${(bike.notes || '').replace(/"/g, '""')}"`
                    ].join(',');
                    csvContent += row + "\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "bike_export.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // --- INITIALIZATION ---
            function init() {
                // Attach all event listeners
                dom.darkModeToggle.addEventListener('click', handleToggleDarkMode);
                dom.addBikeButton.addEventListener('click', handleOpenAddBike);
                dom.addBikeForm.addEventListener('submit', handleAddBikeSubmit);
                dom.editBikeForm.addEventListener('submit', handleEditBikeSubmit);
                dom.markSoldForm.addEventListener('submit', handleMarkSoldSubmit);
                dom.sellPriceInput.addEventListener('input', (e) => {
                    if (state.markingBike) {
                        updateProfitDisplay(state.markingBike.buyPrice, parseFloat(e.target.value));
                    }
                });

                // Close modal buttons
                $$('.modal-close').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const modal = e.target.closest('.modal-backdrop');
                        if (modal === dom.addBikeModal) handleCloseAddBike();
                        if (modal === dom.editBikeModal) handleCloseEditBike();
                        if (modal === dom.markSoldModal) handleCloseMarkSold();
                    });
                });
                
                // Confirm Delete
                dom.confirmDeleteCancel.addEventListener('click', handleCloseConfirmDelete);
                dom.confirmDeleteConfirm.addEventListener('click', handleConfirmDelete);

                // Filters & Search
                dom.filterButtonsContainer.addEventListener('click', handleFilterClick);
                dom.searchBikesInput.addEventListener('input', handleSearchInput);

                // List
                dom.selectAllCheckbox.addEventListener('change', handleSelectAll);
                dom.bikeListTbody.addEventListener('click', handleBikeListClick);
                
                // Bulk Actions
                dom.deleteSelectedButton.addEventListener('click', handleDeleteSelected);
                dom.exportButton.addEventListener('click', handleExportSelected);
                
                // Load dark mode preference
                setState({ isDarkMode: localStorage.getItem('darkMode') === 'true' });

                // Start Firebase
                initFirebase();
            }

            // Start the application
            init();
        });
    </script>
</body>
</html>

