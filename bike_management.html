<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Resale Manager</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Phosphor Icons (for UI icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- 3. Configure Tailwind & Set Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Safe-area insets for mobile (e.g., iPhone notch/home bar) */
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background-color: #f1f5f9; }

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- 
      App Container 
      This is the main "phone" wrapper. On desktop, it centers the app.
      On mobile, it expands to fill the screen.
    -->
    <div class="max-w-lg mx-auto bg-white min-h-screen shadow-lg flex flex-col">

        <!-- Header -->
        <header class="bg-white border-b border-gray-200 p-4 sticky top-0 z-20">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-bold text-gray-800">Bike Resale</h1>
                <!-- Sync Status Indicator -->
                <div id="sync-status" class="flex items-center space-x-2 text-sm text-gray-500">
                    <span id="sync-status-text">Not Configured</span>
                    <i id="sync-status-icon" class="ph ph-warning-circle text-red-500"></i>
                </div>
            </div>
        </header>

        <!-- Main Content Area (Tabs will be rendered here) -->
        <main id="app-content" class="flex-1 p-4 overflow-y-auto">
            <!-- Content will be dynamically inserted by JavaScript -->
        </main>

        <!-- Bottom Navigation Bar -->
        <nav class="bg-white border-t border-gray-200 p-2 sticky bottom-0 z-20 grid grid-cols-3 gap-2">
            <button data-tab="dashboard" class="nav-tab-button p-2 rounded-lg flex flex-col items-center text-blue-600 bg-blue-50">
                <i class="ph-fill ph-house text-2xl"></i>
                <span class="text-xs font-medium">Dashboard</span>
            </button>
            <button data-tab="analytics" class="nav-tab-button p-2 rounded-lg flex flex-col items-center text-gray-500 hover:bg-gray-50">
                <i class="ph ph-chart-bar text-2xl"></i>
                <span class="text-xs font-medium">Analytics</span>
            </button>
            <button data-tab="settings" class="nav-tab-button p-2 rounded-lg flex flex-col items-center text-gray-500 hover:bg-gray-50">
                <i class="ph ph-gear text-2xl"></i>
                <span class="text-xs font-medium">Settings</span>
            </button>
        </nav>
    </div>

    <!-- 
      Modal Container 
      Used for all forms (Add Bike, Sell Bike, Adjust Capital)
    -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black/50 z-40 flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h3 id="modal-title" class="text-lg font-semibold">Modal Title</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600">
                    <i class="ph ph-x text-2xl"></i>
                </button>
            </div>
            <!-- Modal Body (form content injected here) -->
            <div id="modal-body" class="p-4 overflow-y-auto">
                <!-- Dynamic form content goes here -->
            </div>
        </div>
    </div>

    <!-- 
      Toast Notification
      Used for success/error messages
    -->
    <div id="toast" class="hidden fixed top-5 right-5 z-50 max-w-xs w-full">
        <div id="toast-content" class="rounded-lg shadow-lg p-3 flex items-center space-x-3">
            <i id="toast-icon" class="ph ph-check-circle text-2xl"></i>
            <span id="toast-message" class="text-sm font-medium"></span>
        </div>
    </div>

    <!-- 
      JavaScript Application Logic 
    -->
    <script type="module">
        // === CONSTANTS ===
        const GIST_API_URL = 'https://api.github.com/gists';
        const DB_FILENAME = 'bike_resale_db.json';
        const LOCAL_STORAGE_KEY = 'bikeResaleManager';

        // === DOM ELEMENTS ===
        const appContent = document.getElementById('app-content');
        const navButtons = document.querySelectorAll('.nav-tab-button');
        const syncStatusText = document.getElementById('sync-status-text');
        const syncStatusIcon = document.getElementById('sync-status-icon');
        
        // Modal Elements
        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // Toast Elements
        const toast = document.getElementById('toast');
        const toastContent = document.getElementById('toast-content');
        const toastIcon = document.getElementById('toast-icon');
        const toastMessage = document.getElementById('toast-message');

        // === APPLICATION STATE ===
        let state = {
            settings: {
                gistId: '',
                pat: '', // Personal Access Token
                currency: '₹',
                initialCapital: 0,
            },
            data: {
                bikes: [], // { id, model, pPrice, pDate, notes, status ('in-stock', 'sold'), sPrice, sDate, profit }
                capitalLedger: [], // { id, ts, type ('initial', 'buy', 'sell', 'adjust'), amount, reason, bikeId }
            },
            ui: {
                activeTab: 'dashboard',
                syncStatus: 'idle', // 'idle', 'syncing', 'synced', 'error'
                lastSync: null,
                filter: {
                    search: '',
                    status: 'all', // 'all', 'in-stock', 'sold'
                }
            },
            gistFile: { // To store Gist file info for updates
                etag: null,
                fileContent: '', // Store raw content to check for changes
            }
        };

        // === HELPER FUNCTIONS ===
        const generateId = () => `id_${Math.random().toString(36).substr(2, 9)}`;
        const getTodayDate = () => new Date().toISOString().split('T')[0];
        
        const formatCurrency = (amount) => {
            const num = Number(amount);
            const color = num > 0 ? 'text-green-600' : num < 0 ? 'text-red-600' : 'text-gray-700';
            return `<span class="${color}">${state.settings.currency}${Math.abs(num).toLocaleString('en-IN')}</span>`;
        };
        
        const formatProfit = (amount) => {
            if (amount === null || amount === undefined) return `<span class="text-gray-500">-</span>`;
            return formatCurrency(amount);
        };
        
        const formatDate = (isoDate) => {
            if (!isoDate) return '-';
            return new Date(isoDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        };

        // Debounce function to limit API calls
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // === LOCAL STORAGE ===
        function saveStateToLocal() {
            try {
                const stateToSave = { ...state };
                // Don't save PAT in local storage if user clears it
                if (!state.settings.pat) {
                    stateToSave.settings.pat = '';
                }
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(stateToSave));
            } catch (e) {
                console.error("Failed to save state to localStorage", e);
                showToast("Error saving data locally.", 'error');
            }
        }

        function loadStateFromLocal() {
            try {
                const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    // Merge saved state with default state to avoid missing keys on update
                    state = {
                        ...state,
                        ...parsedState,
                        settings: { ...state.settings, ...parsedState.settings },
                        data: { ...state.data, ...parsedState.data },
                        ui: { ...state.ui, ...parsedState.ui, syncStatus: 'idle' } // Always reset sync status
                    };
                }
            } catch (e) {
                console.error("Failed to load state from localStorage", e);
                localStorage.removeItem(LOCAL_STORAGE_KEY); // Clear corrupted data
            }
        }

        // === TOAST & MODAL UI ===
        function showToast(message, type = 'success', duration = 3000) {
            toastMessage.textContent = message;
            
            // Clear old classes
            toastContent.classList.remove('bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');
            toastIcon.classList.remove('ph-check-circle', 'ph-warning');

            if (type === 'success') {
                toastContent.classList.add('bg-green-100', 'text-green-700');
                toastIcon.classList.add('ph-check-circle');
            } else {
                toastContent.classList.add('bg-red-100', 'text-red-700');
                toastIcon.classList.add('ph-warning');
            }

            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, duration);
        }

        function openModal(title, content) {
            modalTitle.textContent = title;
            modalBody.innerHTML = content;
            modalContainer.classList.remove('hidden');
            // Attach form-specific listeners if any
            attachFormListeners();
        }

        function closeModal() {
            modalContainer.classList.add('hidden');
            modalBody.innerHTML = ''; // Clear content
        }

        modalCloseBtn.addEventListener('click', closeModal);
        modalContainer.addEventListener('click', (e) => {
            // Close if clicking on the backdrop
            if (e.target === modalContainer) {
                closeModal();
            }
        });

        // === GIST API SERVICE ===
        const GistStore = {
            async _request(endpoint = '', method = 'GET', body = null) {
                const { gistId, pat } = state.settings;
                if (!gistId || !pat) {
                    return { success: false, error: 'Gist ID or PAT not set.' };
                }

                const url = `${GIST_API_URL}/${gistId}${endpoint}`;
                const headers = {
                    'Accept': 'application/vnd.github.v3+json',
                    'Authorization': `token ${pat}`,
                };

                const options = { method, headers };
                if (body) {
                    options.body = JSON.stringify(body);
                }

                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorData = await response.json();
                        return { success: false, error: errorData.message || `HTTP Error: ${response.status}` };
                    }
                    // Handle 204 No Content for successful PATCH/DELETE
                    if (response.status === 204) {
                        return { success: true, data: null };
                    }
                    const data = await response.json();
                    return { success: true, data, headers: response.headers };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },

            async fetchDb() {
                updateSyncStatus('syncing', 'Syncing...');
                const res = await this._request();

                if (!res.success) {
                    updateSyncStatus('error', 'Sync Failed');
                    showToast(`Error fetching Gist: ${res.error}`, 'error');
                    return false;
                }

                const gistData = res.data;
                const dbFile = gistData.files[DB_FILENAME];

                if (!dbFile) {
                    // File doesn't exist, let's create it on the first save
                    updateSyncStatus('synced', 'Ready (new Gist)');
                    showToast('Gist is empty. Ready to save.', 'success');
                    state.gistFile.etag = res.headers.get('etag');
                    return true;
                }

                try {
                    const dbContent = JSON.parse(dbFile.content);
                    // Merge remote data into local state
                    state.settings = { ...state.settings, ...dbContent.settings };
                    state.data = { ...state.data, ...dbContent.data };
                    state.gistFile.etag = res.headers.get('etag');
                    state.gistFile.fileContent = dbFile.content; // Store raw content

                    updateSyncStatus('synced', 'Synced');
                    showToast('Data synced from Gist.', 'success');
                    saveStateToLocal();
                    return true;
                } catch (e) {
                    updateSyncStatus('error', 'Parse Error');
                    showToast('Failed to parse data from Gist.', 'error');
                    return false;
                }
            },

            async saveDb() {
                updateSyncStatus('syncing', 'Saving...');

                const contentToSave = {
                    settings: {
                        initialCapital: state.settings.initialCapital,
                        currency: state.settings.currency,
                    },
                    data: state.data,
                    meta: {
                        lastSync: new Date().toISOString()
                    }
                };

                const stringContent = JSON.stringify(contentToSave, null, 2);

                // Don't save if content hasn't changed
                if (stringContent === state.gistFile.fileContent) {
                    updateSyncStatus('synced', 'No Changes');
                    return true;
                }

                const body = {
                    description: 'Bike Resale Manager Database',
                    files: {
                        [DB_FILENAME]: {
                            content: stringContent
                        }
                    }
                };

                const res = await this._request('', 'PATCH', body);

                if (!res.success) {
                    updateSyncStatus('error', 'Save Failed');
                    showToast(`Error saving to Gist: ${res.error}`, 'error');
                    return false;
                }

                // Update ETag and local content cache
                state.gistFile.etag = res.headers.get('etag');
                state.gistFile.fileContent = stringContent;

                updateSyncStatus('synced', 'Saved');
                showToast('Data saved to Gist.', 'success');
                saveStateToLocal(); // Save the new synced state
                return true;
            }
        };

        // Debounced version of saveDb
        const debouncedSaveDb = debounce(GistStore.saveDb, 2000);

        // === BUSINESS LOGIC / STATE MUTATIONS ===
        
        function addBike(bikeData) {
            const purchasePrice = parseFloat(bikeData.pPrice);
            
            // 1. Create Bike Record
            const newBike = {
                id: generateId(),
                model: bikeData.model,
                pPrice: purchasePrice,
                pDate: bikeData.pDate,
                notes: bikeData.notes,
                status: 'in-stock',
                sPrice: null,
                sDate: null,
                profit: null
            };
            state.data.bikes.push(newBike);

            // 2. Create Capital Ledger Entry
            const ledgerEntry = {
                id: generateId(),
                ts: new Date().toISOString(),
                type: 'buy',
                amount: -purchasePrice, // Negative amount
                reason: `Buy: ${bikeData.model}`,
                bikeId: newBike.id
            };
            state.data.capitalLedger.push(ledgerEntry);
            
            closeModal();
            showToast('Bike added successfully!', 'success');
            triggerSave();
        }

        function sellBike(bikeId, sellPrice, sellDate) {
            const bike = state.data.bikes.find(b => b.id === bikeId);
            if (!bike) {
                showToast('Error: Bike not found.', 'error');
                return;
            }

            const salePrice = parseFloat(sellPrice);
            const profit = salePrice - bike.pPrice;

            // 1. Update Bike Record
            bike.status = 'sold';
            bike.sPrice = salePrice;
            bike.sDate = sellDate;
            bike.profit = profit;

            // 2. Create Capital Ledger Entry
            const ledgerEntry = {
                id: generateId(),
                ts: new Date().toISOString(),
                type: 'sell',
                amount: salePrice, // Positive amount
                reason: `Sell: ${bike.model}`,
                bikeId: bike.id
            };
            state.data.capitalLedger.push(ledgerEntry);

            closeModal();
            showToast('Bike sold!', 'success');
            triggerSave();
        }
        
        function addCapitalAdjustment(amount, reason) {
            const adjAmount = parseFloat(amount);
            if (isNaN(adjAmount) || adjAmount === 0) {
                showToast('Invalid amount.', 'error');
                return;
            }
            
            const ledgerEntry = {
                id: generateId(),
                ts: new Date().toISOString(),
                type: 'adjust',
                amount: adjAmount,
                reason: reason || (adjAmount > 0 ? 'Manual Deposit' : 'Manual Withdrawal'),
                bikeId: null
            };
            state.data.capitalLedger.push(ledgerEntry);
            
            closeModal();
            showToast('Capital adjusted.', 'success');
            triggerSave();
        }

        function deleteBike(bikeId) {
            if (!confirm('Are you sure you want to delete this bike?\nThis will also remove its capital transactions and cannot be undone.')) {
                return;
            }

            // 1. Remove bike
            state.data.bikes = state.data.bikes.filter(b => b.id !== bikeId);
            // 2. Remove related capital ledger entries
            state.data.capitalLedger = state.data.capitalLedger.filter(l => l.bikeId !== bikeId);
            
            showToast('Bike record deleted.', 'success');
            triggerSave();
        }

        // === COMPUTED STATE / GETTERS ===
        
        function calculateCurrentCapital() {
            return state.settings.initialCapital + state.data.capitalLedger.reduce((sum, entry) => sum + entry.amount, 0);
        }
        
        function getTotalStockValue() {
            return state.data.bikes
                .filter(b => b.status === 'in-stock')
                .reduce((sum, bike) => sum + bike.pPrice, 0);
        }

        function getTotalProfit() {
            return state.data.bikes
                .filter(b => b.status === 'sold' && b.profit !== null)
                .reduce((sum, bike) => sum + bike.profit, 0);
        }

        function getFilteredBikes() {
            const { search, status } = state.ui.filter;
            const searchTerm = search.toLowerCase();

            return state.data.bikes.filter(bike => {
                const matchesStatus = (status === 'all') || (bike.status === status);
                const matchesSearch = !searchTerm || bike.model.toLowerCase().includes(searchTerm) || (bike.notes && bike.notes.toLowerCase().includes(searchTerm));
                return matchesStatus && matchesSearch;
            }).sort((a, b) => new Date(b.pDate) - new Date(a.pDate)); // Sort by purchase date descending
        }

        // === RENDER FUNCTIONS ===

        /**
         * Main render function, delegates to tab-specific renderers
         */
        function render() {
            // Update active nav button
            navButtons.forEach(btn => {
                const tab = btn.dataset.tab;
                if (tab === state.ui.activeTab) {
                    btn.classList.add('text-blue-600', 'bg-blue-50');
                    btn.classList.remove('text-gray-500', 'hover:bg-gray-50');
                    btn.querySelector('i').classList.add('ph-fill');
                } else {
                    btn.classList.remove('text-blue-600', 'bg-blue-50');
                    btn.classList.add('text-gray-500', 'hover:bg-gray-50');
                    btn.querySelector('i').classList.remove('ph-fill');
                }
            });

            // Render active tab content
            switch (state.ui.activeTab) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'analytics':
                    renderAnalytics();
                    break;
                case 'settings':
                    renderSettings();
                    break;
                default:
                    appContent.innerHTML = `<p>Unknown tab: ${state.ui.activeTab}</p>`;
            }
            
            // Re-attach global listeners for dynamic content
            attachGlobalListeners();
        }

        /**
         * Renders the Dashboard tab
         */
        function renderDashboard() {
            const capital = calculateCurrentCapital();
            const stockValue = getTotalStockValue();
            const inStockCount = state.data.bikes.filter(b => b.status === 'in-stock').length;
            const totalProfit = getTotalProfit();
            
            const filteredBikes = getFilteredBikes();

            appContent.innerHTML = `
                <!-- Quick Stats Grid -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <label class="text-sm font-medium text-blue-700 block">Current Capital</label>
                        <div class="text-2xl font-bold text-blue-900">${formatCurrency(capital)}</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <label class="text-sm font-medium text-green-700 block">Total Profit</label>
                        <div class="text-2xl font-bold text-green-900">${formatProfit(totalProfit)}</div>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-lg">
                        <label class="text-sm font-medium text-indigo-700 block">Stock Value</label>
                        <div class="text-2xl font-bold text-indigo-900">${formatCurrency(stockValue)}</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <label class="text-sm font-medium text-gray-700 block">Bikes in Stock</label>
                        <div class="text-2xl font-bold text-gray-900">${inStockCount}</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button id="show-add-bike-modal" class="bg-blue-600 text-white font-medium py-3 rounded-lg shadow flex items-center justify-center space-x-2 hover:bg-blue-700">
                        <i class="ph-fill ph-motorcycle text-xl"></i>
                        <span>Add Bike</span>
                    </button>
                    <button id="show-adjust-capital-modal" class="bg-gray-700 text-white font-medium py-3 rounded-lg shadow flex items-center justify-center space-x-2 hover:bg-gray-800">
                        <i class="ph-fill ph-arrows-counter-clockwise text-xl"></i>
                        <span>Adjust Capital</span>
                    </button>
                </div>
                
                <!-- Bike Inventory Section -->
                <h2 class="text-lg font-semibold text-gray-800 mb-3">Bike Inventory</h2>
                
                <!-- Filters -->
                <div class="flex space-x-2 mb-4">
                    <div class="flex-1 relative">
                        <input type="text" id="filter-search" value="${state.ui.filter.search}" placeholder="Search models..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <select id="filter-status" class="border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all" ${state.ui.filter.status === 'all' ? 'selected' : ''}>All</option>
                        <option value="in-stock" ${state.ui.filter.status === 'in-stock' ? 'selected' : ''}>In Stock</option>
                        <option value="sold" ${state.ui.filter.status === 'sold' ? 'selected' : ''}>Sold</option>
                    </select>
                </div>

                <!-- Bike List -->
                <div id="bike-list" class="space-y-3">
                    ${filteredBikes.length === 0 
                        ? `<div class="text-center text-gray-500 p-6 bg-gray-50 rounded-lg">
                                <i class="ph ph-bicycle text-4xl mb-2"></i>
                                <p>No bikes found. ${state.ui.filter.search || state.ui.filter.status !== 'all' ? 'Try adjusting your filters.' : 'Add your first bike!'}</p>
                           </div>`
                        : filteredBikes.map(renderBikeCard).join('')
                    }
                </div>
            `;
        }
        
        function renderBikeCard(bike) {
            const isSold = bike.status === 'sold';
            return `
                <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                    <div class="p-4">
                        <div class="flex justify-between items-start">
                            <h3 class="text-lg font-semibold text-gray-900">${bike.model}</h3>
                            <span class="px-2 py-0.5 rounded-full text-xs font-medium ${isSold ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                                ${isSold ? 'Sold' : 'In Stock'}
                            </span>
                        </div>
                        <p class="text-sm text-gray-500 mb-3">${bike.notes || 'No notes'}</p>
                        
                        <div class="grid grid-cols-2 gap-2 text-sm mb-4">
                            <div>
                                <label class="text-xs text-gray-500 block">Buy Price</label>
                                <span class="font-medium">${formatCurrency(-bike.pPrice)}</span>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block">Buy Date</label>
                                <span class="font-medium">${formatDate(bike.pDate)}</span>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block">Sell Price</label>
                                <span class="font-medium">${isSold ? formatCurrency(bike.sPrice) : '-'}</span>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block">Profit</label>
                                <span class="font-medium">${formatProfit(bike.profit)}</span>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            ${!isSold ? `
                                <button data-action="show-sell-modal" data-id="${bike.id}" class="flex-1 bg-green-500 text-white text-sm font-medium py-2 px-3 rounded-lg hover:bg-green-600">Sell</button>
                            ` : ''}
                            <button data-action="delete-bike" data-id="${bike.id}" class="flex-1 bg-red-100 text-red-700 text-sm font-medium py-2 px-3 rounded-lg hover:bg-red-200">Delete</button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the Analytics tab
         */
        function renderAnalytics() {
            const totalInvestment = state.data.capitalLedger
                .filter(l => l.type === 'buy')
                .reduce((sum, l) => sum + l.amount, 0); // Is negative
            
            const totalReturns = state.data.capitalLedger
                .filter(l => l.type === 'sell')
                .reduce((sum, l) => sum + l.amount, 0);

            const totalProfit = getTotalProfit();
            const capital = calculateCurrentCapital();
            const stockValue = getTotalStockValue();
            
            // Capital Ledger (reversed)
            const ledgerHtml = state.data.capitalLedger
                .slice() // Create copy
                .reverse() // Show newest first
                .map(l => `
                    <tr class="border-b">
                        <td class="py-2 pr-2">
                            <span class="block text-sm text-gray-900">${l.reason}</span>
                            <span class="block text-xs text-gray-500">${new Date(l.ts).toLocaleString('en-GB')}</span>
                        </td>
                        <td class="py-2 pl-2 text-right">${formatCurrency(l.amount)}</td>
                    </tr>
                `).join('');

            appContent.innerHTML = `
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Business Analytics</h2>
                
                <div class="space-y-3 mb-6">
                    <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">Current Capital</span>
                        <span class="font-bold">${formatCurrency(capital)}</span>
                    </div>
                    <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">Total Profit (Realized)</span>
                        <span class="font-bold">${formatProfit(totalProfit)}</span>
                    </div>
                    <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">Current Stock Value</span>
                        <span class="font-medium">${formatCurrency(stockValue)}</span>
                    </div>
                    <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">Total Investment (Cost)</span>
                        <span class="font-medium">${formatCurrency(totalInvestment)}</span>
                    </div>
                    <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">Total Returns (Sales)</span>
                        <span class="font-medium">${formatCurrency(totalReturns)}</span>
                    </div>
                </div>

                <h2 class="text-lg font-semibold text-gray-800 mb-4">Capital Ledger</h2>
                <div class="bg-white border rounded-lg p-3 max-h-96 overflow-y-auto">
                    ${ledgerHtml.length === 0
                        ? `<p class="text-gray-500 text-center py-4">No capital movements. Set your initial capital in Settings.</p>`
                        : `<table class="w-full"><tbody>${ledgerHtml}</tbody></table>`
                    }
                </div>
                
                <h2 class="text-lg font-semibold text-gray-800 mt-6 mb-4">Data Export</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button id="export-bikes-csv" class="bg-green-600 text-white font-medium py-3 rounded-lg shadow hover:bg-green-700">Export Bikes (CSV)</button>
                    <button id="export-ledger-csv" class="bg-green-600 text-white font-medium py-3 rounded-lg shadow hover:bg-green-700">Export Ledger (CSV)</button>
                </div>
            `;
        }

        /**
         * Renders the Settings tab
         */
        function renderSettings() {
            appContent.innerHTML = `
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Settings</h2>
                
                <div class="space-y-4">
                    <!-- Gist Settings -->
                    <div>
                        <label for="gistId" class="block text-sm font-medium text-gray-700 mb-1">Gist ID</label>
                        <input type="text" id="gistId" value="${state.settings.gistId || ''}" placeholder="e.g., a1b2c3d4e5f6..." class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="pat" class="block text-sm font-medium text-gray-700 mb-1">Personal Access Token</label>
                        <input type="password" id="pat" value="${state.settings.pat || ''}" placeholder="ghp_..." class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Requires 'gist' scope. Token is saved locally.</p>
                    </div>

                    <!-- App Settings -->
                    <div>
                        <label for="initialCapital" class="block text-sm font-medium text-gray-700 mb-1">Initial Capital</label>
                        <input type="number" id="initialCapital" value="${state.settings.initialCapital || 0}" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Set this once. ${state.settings.currency}</p>
                    </div>
                     <div>
                        <label for="currency" class="block text-sm font-medium text-gray-700 mb-1">Currency Symbol</label>
                        <input type="text" id="currency" value="${state.settings.currency || '₹'}" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <button id="save-settings" class="w-full bg-blue-600 text-white font-medium py-3 rounded-lg shadow hover:bg-blue-700">Save Settings</label>
                    
                    <hr class="my-4">
                    
                    <!-- Sync Actions -->
                    <h3 class="text-md font-semibold text-gray-700">Sync Actions</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="force-sync-download" class="w-full bg-green-600 text-white font-medium py-3 rounded-lg shadow hover:bg-green-700">Download from Gist</button>
                        <button id="force-sync-upload" class="w-full bg-blue-600 text-white font-medium py-3 rounded-lg shadow hover:bg-blue-700">Upload to Gist</button>
                    </div>

                    <!-- Danger Zone -->
                    <h3 class="text-md font-semibold text-red-700 mt-6">Danger Zone</h3>
                    <button id="clear-local-data" class="w-full bg-red-100 text-red-700 font-medium py-3 rounded-lg hover:bg-red-200">Clear All Local Data</button>
                </div>
            `;
        }
        
        // === FORM RENDERERS ===
        
        function renderAddBikeForm() {
            const content = `
                <form id="add-bike-form" class="space-y-4">
                    <div>
                        <label for="bikeModel" class="block text-sm font-medium text-gray-700 mb-1">Bike Model</label>
                        <input type="text" id="bikeModel" required class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Hero Splendor 2021">
                    </div>
                    <div>
                        <label for="purchasePrice" class="block text-sm font-medium text-gray-700 mb-1">Purchase Price (${state.settings.currency})</label>
                        <input type="number" id="purchasePrice" required min="0" step="100" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="30000">
                    </div>
                    <div>
                        <label for="purchaseDate" class="block text-sm font-medium text-gray-700 mb-1">Purchase Date</label>
                        <input type="date" id="purchaseDate" required value="${getTodayDate()}" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="bikeNotes" class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                        <textarea id="bikeNotes" rows="3" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., New tires, single owner"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-medium py-3 rounded-lg shadow hover:bg-blue-700">Add Bike</button>
                </form>
            `;
            openModal('Add New Bike', content);
        }
        
        function renderSellBikeForm(bike) {
            const content = `
                <form id="sell-bike-form" class="space-y-4" data-id="${bike.id}">
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="font-medium text-gray-800">${bike.model}</p>
                        <p class="text-sm text-gray-600">Buy Price: ${formatCurrency(-bike.pPrice)} on ${formatDate(bike.pDate)}</p>
                    </div>
                    <div>
                        <label for="sellPrice" class="block text-sm font-medium text-gray-700 mb-1">Sell Price (${state.settings.currency})</label>
                        <input type="number" id="sellPrice" required min="0" step="100" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="35000">
                    </div>
                    <div>
                        <label for="sellDate" class="block text-sm font-medium text-gray-700 mb-1">Sell Date</label>
                        <input type="date" id="sellDate" required value="${getTodayDate()}" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-medium py-3 rounded-lg shadow hover:bg-green-700">Confirm Sale</button>
                </form>
            `;
            openModal('Sell Bike', content);
        }
        
        function renderAdjustCapitalForm() {
             const content = `
                <form id="adjust-capital-form" class="space-y-4">
                    <div>
                        <label for="adjAmount" class="block text-sm font-medium text-gray-700 mb-1">Amount (${state.settings.currency})</label>
                        <input type="number" id="adjAmount" required step="100" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="5000 (or -1000 to withdraw)">
                    </div>
                    <div>
                        <label for="adjReason" class="block text-sm font-medium text-gray-700 mb-1">Reason</label>
                        <input type="text" id="adjReason" required class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Added personal cash">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-medium py-3 rounded-lg shadow hover:bg-blue-700">Adjust Capital</button>
                </form>
            `;
            openModal('Adjust Capital', content);
        }
        
        // === CSV EXPORT ===
        
        function exportToCsv(filename, rows) {
            if (rows.length === 0) {
                showToast('No data to export.', 'error');
                return;
            }
            
            const header = Object.keys(rows[0]).join(',');
            const csv = [
                header,
                ...rows.map(row => 
                    Object.values(row).map(value => {
                        const str = String(value);
                        // Escape quotes and wrap in quotes if it contains comma or newline
                        if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                            return `"${str.replace(/"/g, '""')}"`;
                        }
                        return str;
                    }).join(',')
                )
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-IS-8859-1;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // === EVENT HANDLERS ===
        
        function handleNavClick(e) {
            const button = e.target.closest('.nav-tab-button');
            if (button) {
                state.ui.activeTab = button.dataset.tab;
                render();
            }
        }

        function handleSaveSettings() {
            const gistId = document.getElementById('gistId').value.trim();
            const pat = document.getElementById('pat').value.trim();
            const initialCapital = parseFloat(document.getElementById('initialCapital').value) || 0;
            const currency = document.getElementById('currency').value.trim() || '₹';

            state.settings.gistId = gistId;
            state.settings.pat = pat;
            state.settings.currency = currency;

            // Only update initial capital if it hasn't been set before, or if it's being changed
            if (state.settings.initialCapital !== initialCapital) {
                const oldInitial = state.settings.initialCapital;
                // Find and remove old initial capital entry if exists
                state.data.capitalLedger = state.data.capitalLedger.filter(l => l.type !== 'initial');
                
                // Add new initial capital entry
                if (initialCapital > 0) {
                     state.data.capitalLedger.unshift({
                        id: generateId(),
                        ts: new Date('2000-01-01').toISOString(), // Always first
                        type: 'initial',
                        amount: initialCapital,
                        reason: 'Initial Capital',
                        bikeId: null
                    });
                }
                state.settings.initialCapital = initialCapital;
            }

            saveStateToLocal();
            showToast('Settings saved!', 'success');
            
            // Trigger a sync if credentials changed
            if (gistId && pat) {
                GistStore.fetchDb().then(render);
            } else {
                render();
            }
        }
        
        function handleFilterChange() {
            state.ui.filter.search = document.getElementById('filter-search').value;
            state.ui.filter.status = document.getElementById('filter-status').value;
            renderDashboard(); // Re-render dashboard to show filtered list
        }

        function handleDashboardClick(e) {
            const target = e.target.closest('button');
            if (!target) return;

            const action = target.dataset.action;
            const id = target.dataset.id;
            
            if (target.id === 'show-add-bike-modal') {
                renderAddBikeForm();
            } else if (target.id === 'show-adjust-capital-modal') {
                renderAdjustCapitalForm();
            } else if (action === 'show-sell-modal') {
                const bike = state.data.bikes.find(b => b.id === id);
                if (bike) renderSellBikeForm(bike);
            } else if (action === 'delete-bike') {
                deleteBike(id);
            }
        }
        
        function handleAnalyticsClick(e) {
            const target = e.target;
            if (target.id === 'export-bikes-csv') {
                exportToCsv('bikes_export.csv', state.data.bikes);
            } else if (target.id === 'export-ledger-csv') {
                exportToCsv('capital_ledger_export.csv', state.data.capitalLedger);
            }
        }
        
        function handleSettingsClick(e) {
            const target = e.target;
            if (target.id === 'save-settings') {
                handleSaveSettings();
            } else if (target.id === 'force-sync-download') {
                GistStore.fetchDb().then(render);
            } else if (target.id === 'force-sync-upload') {
                GistStore.saveDb().then(render);
            } else if (target.id === 'clear-local-data') {
                if (confirm('Are you sure? This will delete all data from this device. It will NOT delete data from Gist.')) {
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    location.reload();
                }
            }
        }
        
        /**
         * Attach listeners to dynamic modal forms
         */
        function attachFormListeners() {
            const addBikeForm = document.getElementById('add-bike-form');
            if (addBikeForm) {
                addBikeForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const bikeData = {
                        model: e.target.elements.bikeModel.value,
                        pPrice: e.target.elements.purchasePrice.value,
                        pDate: e.target.elements.purchaseDate.value,
                        notes: e.target.elements.bikeNotes.value,
                    };
                    addBike(bikeData);
                });
            }
            
            const sellBikeForm = document.getElementById('sell-bike-form');
            if (sellBikeForm) {
                sellBikeForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const bikeId = e.target.dataset.id;
                    const sellPrice = e.target.elements.sellPrice.value;
                    const sellDate = e.target.elements.sellDate.value;
                    sellBike(bikeId, sellPrice, sellDate);
                });
            }
            
            const adjustCapitalForm = document.getElementById('adjust-capital-form');
            if (adjustCapitalForm) {
                adjustCapitalForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const amount = e.target.elements.adjAmount.value;
                    const reason = e.target.elements.adjReason.value;
                    addCapitalAdjustment(amount, reason);
                });
            }
        }
        
        /**
         * Attach listeners to dynamic tab content
         */
        function attachGlobalListeners() {
            // Dashboard listeners
            if (state.ui.activeTab === 'dashboard') {
                appContent.removeEventListener('click', handleDashboardClick); // Avoid duplicates
                appContent.addEventListener('click', handleDashboardClick);
                
                const search = document.getElementById('filter-search');
                const status = document.getElementById('filter-status');
                if (search) search.addEventListener('input', debounce(handleFilterChange, 300));
                if (status) status.addEventListener('change', handleFilterChange);
            }
            
            // Analytics listeners
            if (state.ui.activeTab === 'analytics') {
                appContent.removeEventListener('click', handleAnalyticsClick);
                appContent.addEventListener('click', handleAnalyticsClick);
            }
            
            // Settings listeners
            if (state.ui.activeTab === 'settings') {
                appContent.removeEventListener('click', handleSettingsClick);
                appContent.addEventListener('click', handleSettingsClick);
            }
        }

        // === APP INITIALIZATION ===
        
        /**
         * Update the sync status UI
         */
        function updateSyncStatus(status, text) {
            state.ui.syncStatus = status;
            syncStatusText.textContent = text;
            
            // Clear old classes
            syncStatusIcon.classList.remove('ph-warning-circle', 'text-red-500', 'ph-clock', 'text-gray-500', 'animate-spin', 'ph-check-circle', 'text-green-500');

            switch (status) {
                case 'idle':
                    syncStatusIcon.classList.add('ph-clock', 'text-gray-500');
                    break;
                case 'syncing':
                    syncStatusIcon.classList.add('ph-arrows-clockwise', 'text-blue-500', 'animate-spin');
                    break;
                case 'synced':
                    syncStatusIcon.classList.add('ph-check-circle', 'text-green-500');
                    state.ui.lastSync = new Date();
                    syncStatusText.textContent = `Synced ${state.ui.lastSync.toLocaleTimeString()}`;
                    break;
                case 'error':
                    syncStatusIcon.classList.add('ph-warning-circle', 'text-red-500');
                    break;
            }
        }
        
        /**
         * Trigger a save to local and a debounced save to Gist
         */
        function triggerSave() {
            saveStateToLocal();
            // Re-render to reflect new data
            render();
            
            // If Gist is configured, trigger debounced save
            if (state.settings.gistId && state.settings.pat) {
                updateSyncStatus('syncing', 'Saving...');
                debouncedSaveDb();
            }
        }

        /**
         * App Init Function
         */
        function init() {
            // 1. Load state from localStorage
            loadStateFromLocal();

            // 2. Set up navigation
            document.querySelector('nav').addEventListener('click', handleNavClick);

            // 3. Initial Render
            render();

            // 4. Auto-sync on load if configured
            if (state.settings.gistId && state.settings.pat) {
                GistStore.fetchDb().then(render); // Fetch, then re-render with new data
            } else {
                updateSyncStatus('error', 'Not Configured');
            }
        }

        // Start the app!
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
