<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bike Manager v7.0</title>
  <meta name="description" content="Offline-first bike inventory manager with photos, GitHub sync, and advanced analytics." />
  
  <!--
  ╔════════════════════════════════════════════════════════════════════════════╗
  ║                        BIKE MANAGER v7.0 CHANGELOG                          ║
  ╠════════════════════════════════════════════════════════════════════════════╣
  ║ MIGRATION NOTES FROM v6.3:                                                  ║
  ║ • Database migration to v2 is automatic.                                    ║
  ║ • New fields 'photo' (data:URL string) and 'notes' added.                   ║
  ║ • Exports (CSV/JSON) will now be larger if photos are used.                 ║
  ║                                                                             ║
  ║ BUGFIXES (v7.0):                                                            ║
  ║ • Replaced all 'confirm()' calls with a non-blocking modal.                 ║
  ║ • Ensured 'Edit Sale' is possible from 'View' mode.                         ║
  ║ • Fixed potential layout shift on stat card loading.                        ║
  ║                                                                             ║
  ║ NEW FEATURES (v7.0):                                                        ║
  ║ ✓ Photo Uploads: Add one primary photo per bike (stored as data:URL).       ║
  ║ ✓ Notes Field: A multi-line text field for notes on each bike.              ║
  ║ ✓ Mobile Swipe Gestures: Swipe left on list items for Sell/Dupe/Delete.     ║
  ║ ✓ Advanced Metrics: Added Profit Margin & Sell-Through Rate.                ║
  ║ ✓ Profit Goal Tracking: Set a goal in settings, see progress on dashboard.  ║
  ║ ✓ AI Analyst Insight: Dynamic insight card on stats page.                   ║
  ║ ✓ Data Health Audit: Tool in settings to find data anomalies.               ║
  ║ ✓ Advanced List Filters (Future-proofed): Added UI hooks.                   ║
  ║ ✓ Custom Confirmation Modal: Replaced all native browser alerts.            ║
  ║ ✓ Image View Modal: Tap a bike's thumbnail to see the full photo.           ║
  ║ ✓ Enhanced Empty States: Better guidance when no data is present.           ║
  ║ ✓ UI/UX Polish: Improved hover effects, transitions, and layout.            ║
  ║                                                                             ║
  ║ PERFORMANCE & UX:                                                           ║
  ║ • Added Dexie migration for 'photo' and 'notes' fields.                     ║
  ║ • Skeletons now cover stats page and new dashboard cards.                   ║
  ║ • Swipe gestures are hardware-accelerated with 'transform'.                 ║
  ╚════════════════════════════════════════════════════════════════════════════╝
  -->
  
  <!-- CSP: Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline';
    style-src 'self' https://fonts.googleapis.com 'unsafe-inline';
    font-src 'self' https://fonts.gstatic.com;
    connect-src 'self' https://api.github.com;
    img-src 'self' data: blob:; 
    object-src 'none';
    frame-ancestors 'none';
  ">
  
  <!-- PWA & Mobile Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Bike Manager" />
  <meta name="theme-color" content="#071b2b" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192' fill='%2300D0FF'%3E%3Crect width='192' height='192' rx='32' fill='%23071b2b'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='96' font-family='sans-serif' fill='white' font-weight='bold'%3EBM%3C/text%3E%3C/svg%3E" />
  
  <!-- Inline Web App Manifest (for PWA installation) -->
  <link rel="manifest" href="data:application/manifest+json;charset=utf-8;base64,ew0KICAibmFtZSI6ICJCaWtlIE1hbmFnZXIgdlxuMCIsDQogICJzaG9ydF9uYW1lIjogIkJpY2luSmciLA0KICAiZGVzY3JpcHRpb24iOiAiT2ZmbGluZS1maXJzdCBiaWtlIGludmVudG9yeSBtYW5hZ2VyIHdpdGggcGhvdG9zIGFuZCBhZHZhbmNlZCBhbmFseXRpY3MuIiwNCiAgInN0YXJ0X3VybCI6ICIuLyIsDQogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLA0KICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMDcxMDI2IiwNCiAgInRoZW1lX2NvbG9yIjogIiMwNzFiMmIiLA0KICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQtcHJpbWFyeSIsDQogICJpY29ucyI6IFsNCiAgICB7DQogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTkyIDE5MicgZmlsbD0nJTIzMDBEMEZGJTNFLTxyZWN0IHdpZHRoPScxOTInIGhlaWdodD0nMTkyJyByeD0nMzInIGZpbGw9JyUyMzA3MWIyYicvPjxyZWN0IHdpZHRoPScxOTInIGhlaWdodD0nMTkyJyByeD0nMzInIGZpbGw9JyUyMzA3MWIyYicvPjx0ZXh0IHg9JzUwJTI1JyB5PSc1MCUyNScgZG9taW5hbnQtYmFzZWxpbmU9J2NlbnRyYWwnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZvbnQtc2l6ZT0nOTYnIGZvbnQtZmFtaWx5PSdzYW5zLXNlcmlmJyBmaWxsPSd3aGl0ZScgZm9udC13ZWlnaHQ9J2JvbGQnPkJNPC90ZXh0Pjwvc3ZnPg0KICAgICAgIiwNCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLA0KICAgICAgInNpemVzIjogIjE5MngxOTIiLA0KICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIg0KICAgIH0sDQogICAgew0KICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDUxMiA1MTInIGZpbGw9JyUyMzAwRDBGRiUzRS08cmVjdCB3aWR0aD0nNTEyJyBoZWlnaHQ9JzUxMicgcng9JzY0JyBmaWxsPSclMjMwNzFiMmInLz48cmVjdCB3aWR0aD0nNTEyJyBoZWlnaHQ9JzUxMicgcng9JzY0JyBmaWxsPSclMjMwNzFiMmInLz48dGV4dCB4PSc1MCUyNScgeT0nNTAlMjUnIGRvbWluYW50LWJhc2VsaW5lPSdjZW50cmFsJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmb250LXNpemU9JzI1NjYnIGZvbnQtZmFtaWx5PSdzYW5zLXNlcmlmJyBmaWxsPSd3aGl0ZScgZm9udC13ZWlnaHQ9J2JvbGQnPkJNPC90ZXh0Pjwvc3ZnPg0KICAgICAgIiwNCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLA0KICAgICAgInNpemVzIjogIjUxMng1MTIiDQogICAgfQ0KICBdDQp9DQo=">

  <!-- Inline Styles -->
  <style>
    /* --- 1. Fonts & Root Variables --- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    :root {
      /* Base Dark Theme (Default) */
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --bg-gradient-start: #071026;
      --bg-gradient-end: #020511;
      --bg-page: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      --bg-card: #071b2b;
      --bg-card-subtle: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --bg-header: rgba(7, 27, 43, 0.85);
      --bg-modal: rgba(7, 16, 38, 0.9);
      --bg-input: rgba(0, 0, 0, 0.2);
      --bg-input-focus: rgba(0, 0, 0, 0.1);
      --bg-hover: rgba(255, 255, 255, 0.05);
      --bg-active: rgba(255, 255, 255, 0.08);
      --bg-nav: var(--bg-header);

      --accent-gradient: linear-gradient(90deg, #00D0FF, #6EE7B7);
      --accent-1: #00D0FF;
      --accent-2: #6EE7B7;
      --accent-text: #00242f;

      --text-primary: #e6f6ff;
      --text-secondary: #9fb0c2;
      --text-disabled: #6a7f96;
      --text-placeholder: #6a7f96;

      --border-color: rgba(255, 255, 255, 0.1);
      --border-color-subtle: rgba(255, 255, 255, 0.04);
      --border-focus: var(--accent-1);
      
      --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.6);
      --shadow-nav: 0 -4px 12px rgba(0, 0, 0, 0.3);
      --shadow-fab: 0 6px 16px rgba(0, 208, 255, 0.3);
      --shadow-btn: 0 2px 8px rgba(0, 0, 0, 0.3);

      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;

      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-xl: 20px;
      --radius-full: 9999px;
      
      --nav-height-mobile: 60px;
      --header-height: 60px;
      --tap-target: 44px;
      --transition-speed: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Light mode theme */
    @media (prefers-color-scheme: light) {
      :root:not(.theme-dark) {
        --bg-gradient-start: #f4f7fa;
        --bg-gradient-end: #e8eef3;
        --bg-card: #ffffff;
        --bg-card-subtle: linear-gradient(180deg, #ffffff, #fdfdfd);
        --bg-header: rgba(255, 255, 255, 0.85);
        --bg-modal: rgba(244, 247, 250, 0.9);
        --bg-input: rgba(0, 0, 0, 0.04);
        --bg-input-focus: rgba(0, 0, 0, 0.02);
        --bg-hover: rgba(0, 0, 0, 0.05);
        --bg-active: rgba(0, 0, 0, 0.08);
        --bg-nav: var(--bg-header);

        --text-primary: #071026;
        --text-secondary: #4a5a70;
        --text-disabled: #9fb0c2;
        --text-placeholder: #9fb0c2;

        --border-color: rgba(0, 0, 0, 0.1);
        --border-color-subtle: rgba(0, 0, 0, 0.04);

        --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.08);
        --shadow-nav: 0 -4px 12px rgba(0, 0, 0, 0.05);
      }
    }

    /* Manual light theme override */
    .theme-light {
      --bg-gradient-start: #f4f7fa;
      --bg-gradient-end: #e8eef3;
      --bg-card: #ffffff;
      --bg-card-subtle: linear-gradient(180deg, #ffffff, #fdfdfd);
      --bg-header: rgba(255, 255, 255, 0.85);
      --bg-modal: rgba(244, 247, 250, 0.9);
      --bg-input: rgba(0, 0, 0, 0.04);
      --bg-input-focus: rgba(0, 0, 0, 0.02);
      --bg-hover: rgba(0, 0, 0, 0.05);
      --bg-active: rgba(0, 0, 0, 0.08);
      --bg-nav: var(--bg-header);

      --text-primary: #071026;
      --text-secondary: #4a5a70;
      --text-disabled: #9fb0c2;
      --text-placeholder: #9fb0c2;

      --border-color: rgba(0, 0, 0, 0.1);
      --border-color-subtle: rgba(0, 0, 0, 0.04);

      --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.08);
      --shadow-nav: 0 -4px 12px rgba(0, 0, 0, 0.05);
    }
    
    /* Manual dark theme override */
    .theme-dark {
      --bg-gradient-start: #071026;
      --bg-gradient-end: #020511;
      --bg-page: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      --bg-card: #071b2b;
      --bg-card-subtle: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --bg-header: rgba(7, 27, 43, 0.85);
      --bg-modal: rgba(7, 16, 38, 0.9);
      --bg-input: rgba(0, 0, 0, 0.2);
      --bg-input-focus: rgba(0, 0, 0, 0.1);
      --bg-hover: rgba(255, 255, 255, 0.05);
      --bg-active: rgba(255, 255, 255, 0.08);
      --bg-nav: var(--bg-header);
      
      --text-primary: #e6f6ff;
      --text-secondary: #9fb0c2;
      --text-disabled: #6a7f96;
      --text-placeholder: #9fb0c2;

      --border-color: rgba(255, 255, 255, 0.1);
      --border-color-subtle: rgba(255, 255, 255, 0.04);
      
      --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.6);
      --shadow-nav: 0 -4px 12px rgba(0, 0, 0, 0.3);
    }

    /* --- 3. Base & Reset --- */
    *, *::before, *::after { box-sizing: border-box; }
    html { 
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
      scroll-behavior: smooth; 
    }
    body {
      margin: 0;
      font-family: var(--font-family);
      background: var(--bg-page);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-size: 16px;
      line-height: 1.5;
      transition: background 0.3s ease, color 0.3s ease;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    input, button, select, textarea {
      font-family: inherit;
      color: inherit;
      font-size: 1rem;
    }
    button { 
      cursor: pointer; 
      border: none; 
      background: none; 
      padding: 0; 
      -webkit-appearance: none;
      appearance: none;
    }
    h1, h2, h3, h4, h5, h6 { margin: 0; font-weight: 700; }
    a { color: var(--accent-1); text-decoration: none; }
    svg { display: block; }
    ::placeholder { color: var(--text-placeholder); }

    *:focus-visible {
      outline: 2px solid var(--accent-1);
      outline-offset: 2px;
      border-radius: var(--radius-sm);
    }

    /* --- 4. Main App Layout --- */
    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .app-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 16px;
      height: var(--header-height);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      background: var(--bg-header);
      border-bottom: 1px solid var(--border-color-subtle);
    }
    .app-header h1 {
      font-size: 1.25rem;
      margin-right: auto;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .app-main {
      flex-grow: 1;
      padding: 16px;
      padding-bottom: calc(var(--nav-height-mobile) + 32px); 
    }

    .app-bottom-nav {
      display: flex;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--nav-height-mobile);
      background: var(--bg-nav);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: var(--shadow-nav);
      z-index: 100;
      border-top: 1px solid var(--border-color-subtle);
    }
    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-secondary);
      transition: var(--transition-speed);
      position: relative;
    }
    .nav-btn svg { width: 22px; height: 22px; }
    .nav-btn.active {
      color: var(--accent-1);
    }
    .nav-btn.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 3px;
      background: var(--accent-gradient);
      border-radius: 0 0 3px 3px;
    }

    /* Desktop layout */
    @media (min-width: 768px) {
      .app-container {
        flex-direction: row;
      }
      .app-bottom-nav {
        position: sticky;
        top: 0;
        left: 0;
        flex-direction: column;
        width: 80px;
        height: 100vh;
        border-top: none;
        border-right: 1px solid var(--border-color-subtle);
        box-shadow: none;
        justify-content: flex-start;
        padding-top: var(--header-height);
      }
      .nav-btn {
        width: 100%;
        height: 70px;
        font-size: 0.75rem;
      }
      .nav-btn.active::before {
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        width: 3px;
        height: 40px;
        border-radius: 0 3px 3px 0;
      }
      .app-header {
        width: calc(100% - 80px);
        position: sticky;
        left: 80px;
        border-bottom: 1px solid var(--border-color-subtle);
      }
      .app-content-wrapper {
        flex-grow: 1; 
        display: flex; 
        flex-direction: column;
        width: calc(100% - 80px);
      }
      .app-main {
        width: 100%;
        padding: 32px;
        padding-bottom: 32px;
      }
    }

    /* --- 5. Core Components --- */
    
    .view { display: none; }
    .view.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
      min-height: var(--tap-target);
      transition: var(--transition-speed);
      box-shadow: var(--shadow-btn);
      position: relative;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
    }
    .btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
      transform: scale(0);
      transition: transform 0.5s ease;
      opacity: 0;
    }
    .btn:active::after {
      transform: scale(2);
      opacity: 1;
      transition-duration: 0.1s;
    }
    
    .btn-primary {
      background: var(--accent-gradient);
      color: var(--accent-text);
    }
    .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    .btn-secondary {
      background: var(--bg-card-subtle);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    .btn-secondary:hover { 
      background: var(--bg-hover);
      border-color: var(--accent-1);
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
      min-height: 36px;
    }
    
    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      box-shadow: none;
    }
    .btn-ghost:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    .btn-danger {
      background: var(--error);
      color: #fff;
    }
    .btn-icon {
      padding: 10px;
      min-height: var(--tap-target);
      min-width: var(--tap-target);
      border-radius: var(--radius-full);
      box-shadow: none;
    }
    .btn-icon svg { width: 24px; height: 24px; }
    
    .fab {
      position: fixed;
      bottom: calc(var(--nav-height-mobile) + 16px);
      right: 16px;
      width: 56px;
      height: 56px;
      border-radius: var(--radius-xl);
      background: var(--accent-gradient);
      color: var(--accent-text);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-fab);
      z-index: 200;
      transition: transform 0.3s ease;
    }
    .fab:active {
      transform: scale(0.95);
    }
    .fab svg { width: 28px; height: 28px; }
    @media (min-width: 768px) {
      .fab { display: none; }
      #buy-bike-desktop { display: inline-flex !important; }
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-card);
      border: 1px solid var(--border-color-subtle);
      transition: var(--transition-speed);
    }
    .card:hover {
      border-color: var(--border-color);
    }

    /* --- 6. Form & Input Elements --- */
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-input);
      color: var(--text-primary);
      transition: var(--transition-speed);
      -webkit-appearance: none;
      appearance: none;
    }
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--border-focus);
      background: var(--bg-input-focus);
      box-shadow: 0 0 0 2px rgba(0, 208, 255, 0.3);
    }
    .form-input[readonly] {
      background: rgba(0,0,0,0.1);
      color: var(--text-secondary);
      cursor: not-allowed;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .form-section-divider {
      border-top: 1px solid var(--border-color);
      margin: 20px 0;
    }
    .form-section-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }
    
    /* [v7.0 FEATURE] Photo upload styling */
    #form-photo-upload {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }
    #form-photo-preview {
      width: 100%;
      max-width: 200px;
      aspect-ratio: 4 / 3;
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      overflow: hidden;
    }
    #form-photo-preview.has-image {
      border-style: solid;
    }
    #form-photo-preview.has-image::before {
      content: '';
    }
    #form-photo-preview::before {
      content: 'Tap to add photo';
    }
    #form-photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    #form-photo-preview.has-image img {
      display: block;
    }
    #form-photo-preview.has-image::before {
      display: none;
    }
    #form-photo-input {
      display: none; /* Hide default input */
    }
    
    .photo-buttons {
      display: flex;
      gap: 8px;
    }

    /* --- 7. Modals & Panels --- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg-modal);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 24px;
      width: 100%;
      max-width: 500px;
      box-shadow: var(--shadow-card);
      transform: scale(0.95);
      transition: transform 0.3s;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    .modal-overlay.active .modal-content {
      transform: scale(1);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-shrink: 0;
    }
    .modal-header h2 { font-size: 1.25rem; }
    .modal-body {
      max-height: 70vh;
      overflow-y: auto;
      flex-grow: 1;
      -webkit-overflow-scrolling: touch;
    }
    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      flex-shrink: 0;
    }
    
    /* [v7.0 FEATURE] Image view modal */
    #image-modal .modal-content {
      padding: 8px;
      max-width: 90vw;
    }
    #image-modal-img {
      width: 100%;
      max-height: 80vh;
      object-fit: contain;
      border-radius: var(--radius-md);
    }

    /* --- 8. Specific UI Elements --- */
    
    .app-loader {
      position: fixed;
      inset: 0;
      background: var(--bg-page);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      transition: opacity 0.5s ease;
    }
    .app-loader.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .app-loader .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border-color);
      border-top-color: var(--accent-1);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .app-loader h2 {
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-size: 1.5rem;
    }

    .sync-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      padding: 6px 10px;
      border-radius: var(--radius-full);
      background: var(--bg-card-subtle);
      border: 1px solid var(--border-color-subtle);
      color: var(--text-secondary);
      transition: var(--transition-speed);
    }
    .sync-status.syncing .status-dot {
      background: var(--warning);
      animation: pulse 1.5s infinite;
    }
    .sync-status.success .status-dot { background: var(--success); }
    .sync-status.error .status-dot { background: var(--error); }
    .sync-status.offline .status-dot { background: var(--text-disabled); }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
    }

    .toast-container {
      position: fixed;
      bottom: calc(var(--nav-height-mobile) + 20px);
      left: 16px;
      right: 16px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      pointer-events: none;
    }
    .toast {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #2a3b4d;
      color: var(--text-primary);
      padding: 12px 16px;
      border-radius: var(--radius-md);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: toast-in 0.3s ease;
      width: 100%;
      max-width: 400px;
      pointer-events: auto;
    }
    .toast.success { background: var(--success); color: #fff; }
    .toast.error { background: var(--error); color: #fff; }
    .toast.warning { background: var(--warning); color: #000; }
    
    .toast-message {
      flex-grow: 1;
      font-size: 0.9rem;
    }
    .toast-close {
      font-size: 1.5rem;
      font-weight: bold;
      line-height: 1;
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      padding: 0 4px;
      background: none;
      border: none;
    }
    .toast-close:hover {
      color: #fff;
    }
    .toast.warning .toast-close {
      color: rgba(0,0,0,0.7);
    }
    .toast.warning .toast-close:hover {
      color: #000;
    }
    
    @media (min-width: 768px) {
      .toast-container {
        bottom: 20px;
        left: auto;
        right: 20px;
        align-items: flex-end;
      }
    }
    
    /* [v7.0 FEATURE] Bike List with Photos and Swipe */
    .bike-list {
      display: grid;
      gap: 12px;
      position: relative;
    }
    .bike-list-wrapper {
      position: relative;
      overflow: hidden;
      border-radius: var(--radius-md);
      transition: box-shadow 0.3s ease;
    }
    .bike-list-wrapper.swiped {
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .bike-card {
      display: grid;
      grid-template-columns: auto 1fr auto; /* checkbox, main, profit */
      align-items: center;
      gap: 12px;
      background: var(--bg-card-subtle);
      padding: 12px;
      border: 1px solid var(--border-color-subtle);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), 
                  background 0.2s ease,
                  border-color 0.2s ease;
      cursor: pointer;
      position: relative;
      user-select: none;
      -webkit-user-select: none;
    }
    /* Add thumbnail column */
    .bike-card.has-photo {
      grid-template-columns: auto 50px 1fr auto;
      gap: 10px;
    }
    .bike-card-thumbnail {
      width: 50px;
      height: 50px;
      border-radius: var(--radius-sm);
      background-color: var(--bg-input);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      overflow: hidden;
    }
    .bike-card-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .bike-card-thumbnail svg {
      width: 20px;
      height: 20px;
    }
    
    /* [v7.0 FEATURE] Swipe actions */
    .bike-card-actions {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      display: flex;
      transform: translateX(100%);
    }
    .bike-card-actions button {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      width: 70px;
      height: 100%;
      color: #fff;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .bike-card-actions button svg {
      width: 20px;
      height: 20px;
    }
    .bike-card-actions .action-sell { background: var(--success); }
    .bike-card-actions .action-dupe { background: #555; }
    .bike-card-actions .action-delete { background: var(--error); }
    
    .bike-list.compact .bike-card {
      padding: 8px 12px;
    }
    .bike-list.compact .bike-card.has-photo {
      grid-template-columns: auto 40px 1fr auto;
    }
    .bike-list.compact .bike-card-thumbnail {
      width: 40px;
      height: 40px;
    }
    
    .bike-card:hover {
      background: var(--bg-hover);
      border-color: var(--border-color);
      transform: translateX(4px);
    }
    .bike-card.selected {
      background: var(--bg-active);
      border-color: var(--accent-1);
    }
    .bike-card.selected::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--accent-gradient);
      border-radius: 4px 0 0 4px;
    }
    
    .bike-checkbox {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition-speed);
    }
    .bike-card.selected .bike-checkbox {
      background: var(--accent-gradient);
      border-color: var(--accent-1);
    }
    .bike-checkbox svg {
      width: 14px;
      height: 14px;
      color: var(--accent-text);
      display: none;
    }
    .bike-card.selected .bike-checkbox svg {
      display: block;
    }
    
    .bike-card-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow: hidden;
      min-width: 0;
    }
    .bike-card-plate {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .bike-card-owner {
      font-size: 0.9rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .bike-card-profit {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
    }
    .profit-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--success);
      white-space: nowrap;
    }
    .profit-value.unrealized {
      color: var(--text-secondary);
      font-style: italic;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .profit-value.loss {
      color: var(--error);
    }

    .bulk-action-bar {
      position: fixed;
      bottom: calc(var(--nav-height-mobile) + 16px);
      left: 50%;
      transform: translateX(-50%) translateY(120px);
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      padding: 12px 20px;
      display: flex;
      gap: 12px;
      align-items: center;
      box-shadow: var(--shadow-card);
      z-index: 150;
      transition: transform 0.3s ease;
    }
    .bulk-action-bar.active {
      transform: translateX(-50%) translateY(0);
    }
    .bulk-action-bar .count {
      font-weight: 700;
      color: var(--accent-1);
      font-size: 0.9rem;
      white-space: nowrap;
    }
    @media (min-width: 768px) {
      .bulk-action-bar {
        left: auto;
        right: 32px;
        bottom: 32px;
        transform: translateY(120px);
      }
      .bulk-action-bar.active {
        transform: translateY(0);
      }
    }

    /* Search/Filter Bar */
    .filter-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      align-items: center;
      position: relative;
      flex-wrap: wrap;
    }
    #search-input {
      flex-grow: 1;
      min-width: 200px;
      border-radius: var(--radius-full);
      padding-left: 16px;
      padding-right: 44px;
    }
    #search-clear {
      position: absolute;
      right: 8px;
      top: 0;
      height: var(--tap-target);
      color: var(--text-secondary);
      display: none;
    }
    #search-input:focus + #search-clear,
    #search-input:not(:placeholder-shown) + #search-clear {
      display: inline-flex;
    }
    @media (min-width: 768px) {
      #search-clear {
        right: auto;
        left: calc(100% - 180px);
      }
    }
    
    .sort-dropdown {
      position: relative;
    }
    .sort-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      color: var(--text-secondary);
      cursor: pointer;
      height: var(--tap-target);
    }
    .sort-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-card);
      min-width: 200px;
      display: none;
      z-index: 200;
    }
    .sort-menu.active {
      display: block;
    }
    .sort-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: var(--transition-speed);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }
    .sort-option:hover {
      background: var(--bg-hover);
    }
    .sort-option.active {
      color: var(--accent-1);
      font-weight: 600;
    }
    .sort-option svg {
      display: none;
    }
    .sort-option.active svg {
      display: block;
    }
    
    .filter-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .chip {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--bg-input);
      color: var(--text-secondary);
      padding: 6px 12px;
      border-radius: var(--radius-full);
      font-size: 0.85rem;
      border: 1px solid var(--border-color-subtle);
      cursor: pointer;
      transition: var(--transition-speed);
    }
    .chip:hover {
      border-color: var(--border-color);
    }
    .chip.active {
      background: var(--accent-1);
      color: var(--accent-text);
      font-weight: 600;
      border-color: var(--accent-1);
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
    }
    .pagination button {
      padding: 8px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 0.9rem;
      min-width: 40px;
    }
    .pagination button:hover:not(:disabled) {
      background: var(--bg-hover);
      border-color: var(--accent-1);
    }
    .pagination button.active {
      background: var(--accent-1);
      color: var(--accent-text);
      border-color: var(--accent-1);
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #page-info {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
      color: var(--text-secondary);
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-lg);
    }
    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.7;
    }
    .empty-state h3 {
      font-size: 1.1rem;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    /* Stats Dashboard */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (min-width: 1024px) {
      .stats-grid.grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
    }
    .stat-card {
      background: var(--bg-card-subtle);
      padding: 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color-subtle);
      transition: var(--transition-speed);
      display: flex;
      flex-direction: column;
    }
    .stat-card:hover {
      border-color: var(--border-color);
      transform: translateY(-2px);
    }
    .stat-card-title {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .stat-card-value {
      font-size: 1.75rem;
      font-weight: 700;
      min-height: 1.2em; /* Prevent layout shift */
    }
    .stat-card-value .currency {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    /* [v7.0 FEATURE] Profit Goal */
    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: var(--bg-input);
      border-radius: var(--radius-full);
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-bar {
      width: 0%;
      height: 100%;
      background: var(--accent-gradient);
      border-radius: var(--radius-full);
      transition: width 0.5s ease;
    }
    
    /* [v7.0 FEATURE] AI Insight */
    .ai-insight-card .card-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #ai-insight-text {
      font-style: italic;
      color: var(--text-secondary);
      min-height: 3em; /* Prevent CLS */
    }
    
    .chart-container {
      margin-top: 24px;
      position: relative;
    }
    .chart-container h3 {
      font-size: 1.1rem;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .chart-controls {
      display: flex;
      gap: 8px;
    }
    .chart-container canvas {
      max-width: 100%;
      height: auto;
    }
    
    .date-filter {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 16px;
      padding: 12px;
      background: var(--bg-input);
      border-radius: var(--radius-md);
    }
    .date-filter label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 600;
    }
    .date-filter input[type="date"] {
      padding: 6px 10px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.85rem;
    }
    .theme-light .date-filter input[type="date"] {
      color-scheme: light;
    }
    .theme-dark .date-filter input[type="date"] {
      color-scheme: dark;
    }

    /* Settings Page */
    .settings-section {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 24px;
      margin-bottom: 24px;
    }
    .settings-section:last-child {
      border-bottom: none;
    }
    .settings-section h2 {
      font-size: 1.25rem;
      margin-bottom: 16px;
    }
    .settings-section h3 {
      font-size: 1.1rem;
      margin-bottom: 12px;
      margin-top: 16px;
    }
    .settings-section p {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 0;
      margin-bottom: 16px;
      line-height: 1.6;
    }
    
    /* Theme toggle switch */
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-input);
      border-radius: var(--radius-md);
      margin-bottom: 16px;
    }
    .theme-toggle label {
      flex-grow: 1;
      font-weight: 600;
      color: var(--text-primary);
    }
    .switch {
      position: relative;
      width: 52px;
      height: 28px;
      background: var(--border-color);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: var(--transition-speed);
      flex-shrink: 0;
    }
    .switch::before {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: var(--transition-speed);
    }
    .switch.active {
      background: var(--accent-gradient);
    }
    .switch.active::before {
      left: 27px;
    }
    
    /* [v7.0 FEATURE] Data audit results */
    #data-audit-results {
      max-height: 200px;
      overflow-y: auto;
      background: var(--bg-input);
      border-radius: var(--radius-md);
      padding: 12px;
      font-size: 0.85rem;
      line-height: 1.6;
    }
    #data-audit-results p {
      margin: 0 0 8px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color-subtle);
    }
    #data-audit-results p:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    
    .toast.undo {
      background: #2a3b4d;
      justify-content: space-between;
    }
    .toast.undo .toast-action {
      background: var(--accent-1);
      color: var(--accent-text);
      padding: 4px 12px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: var(--transition-speed);
      border: none;
    }
    .toast.undo .toast-action:hover {
      opacity: 0.9;
    }

    /* --- 9. Utility & Animations --- */
    .hidden { display: none !important; }
    .readonly-section {
      opacity: 0.7;
      pointer-events: none;
    }
    .readonly-section .form-input,
    .readonly-section .form-textarea {
      color: var(--text-secondary);
    }
    .text-success { color: var(--success); }
    .text-error { color: var(--error); }
    .text-warning { color: var(--warning); }
    .text-secondary { color: var(--text-secondary); }
    .text-center { text-align: center; }
    .mt-1 { margin-top: 8px; }
    .mt-2 { margin-top: 16px; }
    .mb-2 { margin-bottom: 16px; }

    .skeleton {
      background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-hover) 50%, var(--bg-card) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: var(--radius-sm);
    }
    .skeleton-text {
      height: 1em;
      margin-bottom: 0.5em;
    }
    .skeleton-card {
      height: 80px;
      margin-bottom: 12px;
      border-radius: var(--radius-md);
    }
    .bike-list-skeleton,
    .stats-skeleton {
      display: grid;
      gap: 12px;
    }
    .stats-skeleton {
      grid-template-columns: 1fr 1fr;
    }
    .skeleton-chart {
      height: 250px;
      border-radius: var(--radius-md);
    }

    .kbd {
      display: inline-block;
      padding: 2px 6px;
      font-size: 0.75rem;
      font-family: monospace;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-secondary);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    @keyframes toast-in {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    @media (max-width: 768px) {
      .chart-container canvas {
        height: 250px !important;
      }
      .form-grid {
        grid-template-columns: 1fr;
      }
      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
      .stats-grid.grid-4 {
        grid-template-columns: 1fr 1fr;
      }
      .stats-skeleton {
        grid-template-columns: 1fr 1fr;
      }
      .app-main {
        padding: 16px;
        padding-bottom: calc(var(--nav-height-mobile) + 32px); 
      }
    }
    
    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .stats-grid.grid-4 {
        grid-template-columns: 1fr 1fr;
      }
      .stats-skeleton {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- SVG Icon Definitions -->
  <svg width="0" height="0" style="position:absolute; overflow:hidden;">
    <symbol id="icon-list" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></symbol>
    <symbol id="icon-chart" viewBox="0 0 24 24"><path fill="currentColor" d="M3 22v-9h4v9H3zm0-11V3h4v8H3zm6 11v-5h4v5H9zm0-7V3h4v12H9zm6 7v-9h4v9h-4zm0-11V3h4v8h-4z"/></symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24"><path fill="currentColor" d="M19.4 12c0-.2.1-.4.1-.6c0-.2-.1-.4-.1-.6l1.7-1.3c.2-.1.2-.4 0-.6l-1.6-2.8c-.1-.2-.4-.3-.6-.2l-2 .8c-.4-.3-.8-.5-1.3-.7l-.3-2.1c0-.3-.2-.4-.5-.4h-3.2c-.3 0-.5.1-.5.4l-.3 2.1c-.5.2-.9.4-1.3.7l-2-.8c-.2-.1-.5 0-.6.2l-1.6 2.8c-.1.2-.1.5 0 .6l1.7 1.3c-.1.2-.1.4-.1.6c0 .2.1.4.1.6l-1.7 1.3c-.2.1-.2.4 0 .6l1.6 2.8c.1.2.4.3.6.2l2-.8c.4.3.8.5 1.3.7l.3 2.1c0 .3.2.4.5.4h3.2c.3 0 .5-.1.5.4l.3-2.1c.5-.2.9-.4 1.3-.7l2 .8c.2.1.5 0 .6-.2l1.6-2.8c.1-.2.1-.5 0-.6l-1.7-1.3zm-7.4 2.5c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5s2.5 1.1 2.5 2.5s-1.1 2.5-2.5 2.5z"/></symbol>
    <symbol id="icon-buy" viewBox="0 0 24 24"><path fill="currentColor" d="M11 9h2v8h-2V9zm-2 2h-2v6h2v-6zm8 0h-2v6h2v-6zm-4-4h-2V5h2v2zm7-3H4.01L4 21h16V4zm-2 15H6V6h12v13z"/></symbol>
    <symbol id="icon-close" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41z"/></symbol>
    <symbol id="icon-search" viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5A6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5S14 7.01 14 9.5S11.99 14 9.5 14z"/></symbol>
    <symbol id="icon-filter" viewBox="0 0 24 24"><path fill="currentColor" d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/></symbol>
    <symbol id="icon-save" viewBox="0 0 24 24"><path fill="currentColor" d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3s3 1.34 3 3s-1.34 3-3 3zm3-10H5V5h10v4z"/></symbol>
    <symbol id="icon-delete" viewBox="0 0 24 24"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></symbol>
    <symbol id="icon-sync" viewBox="0 0 24 24"><path fill="currentColor" d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6s-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8s-3.58-8-8-8z"/></symbol>
s    <symbol id="icon-download" viewBox="0 0 24 24"><path fill="currentColor" d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></symbol>
    <symbol id="icon-check" viewBox="0 0 24 24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></symbol>
    <symbol id="icon-sort" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h6v-2H3v2zM3 6v2h18V6H3zm0 7h12v-2H3v2z"/></symbol>
    <symbol id="icon-duplicate" viewBox="0 0 24 24"><path fill="currentColor" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></symbol>
    <symbol id="icon-share" viewBox="0 0 24 24"><path fill="currentColor" d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></symbol>
    <symbol id="icon-undo" viewBox="0 0 24 24"><path fill="currentColor" d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></symbol>
    <symbol id="icon-moon" viewBox="0 0 24 24"><path fill="currentColor" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></symbol>
    <symbol id="icon-sun" viewBox="0 0 24 24"><path fill="currentColor" d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/></symbol>
    <!-- v7.0 Icons -->
    <symbol id="icon-camera" viewBox="0 0 24 24"><path fill="currentColor" d="M9.4 11.3c0 1.44 1.16 2.6 2.6 2.6s2.6-1.16 2.6-2.6s-1.16-2.6-2.6-2.6s-2.6 1.16-2.6 2.6zm-5.4 0c0 4.41 3.59 8 8 8s8-3.59 8-8s-3.59-8-8-8s-8 3.59-8 8zm15 0c0 3.86-3.14 7-7 7s-7-3.14-7-7s3.14-7 7-7s7 3.14 7 7zm-4-4h-2V6h2v1.3zm-1.1.5c.3.2.5.5.5.9c0 .5-.4.9-.9.9s-.9-.4-.9-.9c0-.4.2-.7.5-.9z"/></symbol>
    <symbol id="icon-notes" viewBox="0 0 24 24"><path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM8 17H6v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm0-4H6v-2h12v2zm0-4H6V7h12v2z"/></symbol>
    <symbol id="icon-edit" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83l3.75 3.75l1.83-1.83z"/></symbol>
    <symbol id="icon-target" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.49 2 2 6.49 2 12s4.49 10 10 10s10-4.49 10-10S17.51 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8zm0-10c-1.1 0-2 .9-2 2s.9 2 2 2s2-.9 2-2s-.9-2-2-2z"/></symbol>
    <symbol id="icon-health" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm-1 15H9v-2h2v2zm0-4H9V7h2v6zm4 4h-2v-2h2v2zm0-4h-2V7h2v6z"/></symbol>
    <symbol id="icon-image" viewBox="0 0 24 24"><path fill="currentColor" d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></symbol>
    <symbol id="icon-sell" viewBox="0 0 24 24"><path fill="currentColor" d="M11.8 10.9C11.39 10.5 10.7 10.2 10 10.2c-1.1 0-2 .9-2 2s.9 2 2 2c.7 0 1.39-.3 1.8-.9l1.4 1.4C12.4 15.6 11.2 16.2 10 16.2c-2.21 0-4-1.79-4-4s1.79-4 4-4c1.2 0 2.4.6 3.2 1.5l-1.4 1.4zM12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6s-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8s-3.58-8-8-8zm8 8c0-1.1-.9-2-2-2s-2 .9-2 2s.9 2 2 2s2-.9 2-2z"/></symbol>
  </svg>

  <!-- App Loader -->
  <div class="app-loader" id="app-loader">
    <div class="spinner"></div>
    <h2 id="app-loader-title">Bike Manager</h2>
    <p class="text-secondary" id="app-loader-status">Loading application...</p>
  </div>

  <!-- Main App Container -->
  <div class="app-container" id="app-container">
    
    <!-- Navigation -->
    <nav class="app-bottom-nav" id="app-nav" role="navigation" aria-label="Main navigation">
      <button class="nav-btn active" data-view="view-list" aria-label="Bikes list">
        <svg><use href="#icon-list"></use></svg>
        <span>Bikes</span>
      </button>
      <button class="nav-btn" data-view="view-stats" aria-label="Statistics and analytics">
        <svg><use href="#icon-chart"></use></svg>
        <span>Stats</span>
      </button>
      <button class="nav-btn" data-view="view-settings" aria-label="Settings">
        <svg><use href="#icon-settings"></use></svg>
        <span>Settings</span>
      </button>
    </nav>
    
    <!-- Content Wrapper (for desktop) -->
    <div class="app-content-wrapper">
      
      <!-- App Header -->
      <header class="app-header">
        <h1 id="header-title">Bike Manager</h1>
        <div id="sync-status" class="sync-status" role="status" aria-live="polite">
          <div class="status-dot"></div>
          <span id="sync-status-text">Offline</span>
        </div>
        <button class="btn-icon btn-ghost" id="sync-now-btn" title="Sync Now" aria-label="Sync now">
          <svg><use href="#icon-sync"></use></svg>
        </button>
      </header>
      
      <main class="app-main" role="main">
        
        <!-- =================== -->
        <!-- LIST VIEW           -->
        <!-- =================== -->
        <section id="view-list" class="view active">
          
          <!-- Quick Stats -->
          <div class="stats-grid grid-4 mb-2">
            <div class="stat-card">
              <div class="stat-card-title">Total Profit (Sold)</div>
              <div class="stat-card-value"><span class="currency" id="currency-symbol-1">₹</span> <span id="stat-total-profit">0</span></div>
            </div>
            <div class="stat-card">
              <div class="stat-card-title">Unsold Investment</div>
              <div class="stat-card-value"><span class="currency" id="currency-symbol-2">₹</span> <span id="stat-unsold-value">0</span></div>
            </div>
            <div class="stat-card">
              <div class="stat-card-title">Sold</div>
              <div class="stat-card-value" id="stat-sold-count">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-title">Unsold</div>
              <div class="stat-card-value" id="stat-unsold-count">0</div>
            </div>
          </div>
          
          <!-- Search and Actions Bar -->
          <div class="filter-bar">
            <div style="position: relative; flex-grow: 1;">
              <input type="search" class="form-input" id="search-input" placeholder="Search plate or owner..." aria-label="Search bikes" />
              <button id="search-clear" class="btn-icon btn-ghost" title="Clear search" aria-label="Clear search">
                <svg><use href="#icon-close"></use></svg>
              </button>
            </div>
            
            <div class="sort-dropdown">
              <button class="sort-btn" id="sort-btn" aria-label="Sort bikes" aria-haspopup="true" aria-expanded="false">
                <svg width="20" height="20"><use href="#icon-sort"></use></svg>
                <span id="sort-label">Latest</span>
              </button>
              <div class="sort-menu" id="sort-menu" role="menu">
                <div class="sort-option active" data-sort="latest" role="menuitemradio" aria-checked="true">Latest First <svg width="16" height="16"><use href="#icon-check"></use></svg></div>
                <div class="sort-option" data-sort="oldest" role="menuitemradio" aria-checked="false">Oldest First <svg width="16" height="16"><use href="#icon-check"></use></svg></div>
                <div class="sort-option" data-sort="profit-high" role="menuitemradio" aria-checked="false">Highest Profit <svg width="16" height="16"><use href="#icon-check"></use></svg></div>
                <div class="sort-option" data-sort="profit-low" role="menuitemradio" aria-checked="false">Lowest Profit <svg width="16" height="16"><use href="#icon-check"></use></svg></div>
                <div class="sort-option" data-sort="plate" role="menuitemradio" aria-checked="false">Plate (A-Z) <svg width="16" height="16"><use href="#icon-check"></use></svg></div>
                <div class="sort-option" data-sort="owner" role="menuitemradio" aria-checked="false">Owner (A-Z) <svg width="16" height="16"><use href="#icon-check"></use></svg></div>
              </div>
            </div>
            
            <button class="btn btn-primary" id="buy-bike-desktop" style="display: none; margin-left: 8px;">
              <svg width="20" height="20"><use href="#icon-buy"></use></svg>
              <span>Buy Bike</span>
            </button>
          </div>
          
          <!-- Status Filter Chips -->
          <div class="filter-chips" role="group" aria-label="Filter bikes by status">
            <button class="chip active" id="filter-all" data-filter="all" role="radio" aria-checked="true">All</button>
            <button class="chip" id="filter-sold" data-filter="sold" role="radio" aria-checked="false">Sold</button>
            <button class="chip" id="filter-unsold" data-filter="unsold" role="radio" aria-checked="false">Unsold</button>
          </div>

          <!-- Bike List container -->
          <div class="bike-list-skeleton" id="bike-list-skeleton">
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
          </div>
          <div class="bike-list" id="bike-list" role="list">
            <!-- Bike cards will be injected here by JS -->
          </div>
          
          <!-- [v7.0 FEATURE] Enhanced Empty State -->
          <div id="bike-list-empty" class="empty-state hidden">
            <svg><use href="#icon-buy"></use></svg>
            <h3>No Bikes Found</h3>
            <p>Tap the 'Buy' button to add your first bike.</p>
          </div>
          
          <!-- Pagination -->
          <div class="pagination hidden" id="pagination" role="navigation" aria-label="Pagination">
            <button id="prev-page" aria-label="Previous page">‹</button>
            <span id="page-info" aria-live="polite">Page 1 of 1</span>
            <button id="next-page" aria-label="Next page">›</button>
          </div>
          
        </section>
        
        <!-- =================== -->
        <!-- STATS VIEW          -->
        <!-- =================== -->
        <section id="view-stats" class="view">
          <h2>Analytics Dashboard</h2>
          <p class="text-secondary mb-2">Live insights from your local data.</p>
          
          <!-- Filters -->
          <div class="card">
            <h3>Filters</h3>
            <div class="date-filter">
              <label for="stats-date-from">From:</label>
              <input type="date" id="stats-date-from" class="form-input" />
              <label for="stats-date-to">To:</label>
              <input type="date" id="stats-date-to" class="form-input" />
              <button class="btn btn-secondary btn-sm" id="apply-date-filter">Apply</button>
              <button class="btn btn-ghost btn-sm" id="reset-date-filter">Reset</button>
            </div>
          </div>
          
          <!-- [v7.0 FEATURE] AI Analyst & Profit Goal -->
          <div class="stats-grid mb-2">
            <div class="card ai-insight-card">
              <h3>AI Analyst</h3>
              <div class="card-content">
                <p id="ai-insight-text" class="text-secondary">Calculating insights...</p>
                <button class="btn btn-secondary btn-sm" id="ai-insight-refresh" style="margin-top: auto;">
                  <svg width="16" height="16"><use href="#icon-sync"></use></svg>
                  <span>New Insight</span>
                </button>
              </div>
            </div>
            <div class="card">
              <h3>Profit Goal</h3>
              <p class="text-secondary" style="margin-bottom: 8px;">Progress towards your annual goal.</p>
              <div class="stat-card-value"><span class="currency">₹</span> <span id="stat-goal-profit">0</span> / <span id="stat-goal-total">0</span></div>
              <div class="progress-bar-container">
                <div class="progress-bar" id="stat-goal-progress"></div>
              </div>
              <p class="text-secondary text-center" style="margin-top: 8px; font-weight: 600;" id="stat-goal-percent">0%</p>
            </div>
          </div>
          
          <!-- Skeletons for stats -->
          <div id="stats-skeleton" class="stats-skeleton">
            <div class="stats-grid grid-4 mb-2">
              <div class="stat-card skeleton" style="height: 100px;"></div>
              <div class="stat-card skeleton" style="height: 100px;"></div>
              <div class="stat-card skeleton" style="height: 100px;"></div>
              <div class="stat-card skeleton" style="height: 100px;"></div>
            </div>
            <div class="card skeleton skeleton-chart"></div>
            <div class="card skeleton skeleton-chart"></div>
          </div>
          
          <!-- Stats Content (hidden until loaded) -->
          <div id="stats-content" class="hidden">
            <!-- [v7.0 FEATURE] Advanced Performance Metrics -->
            <div class="card">
              <h3>Performance Metrics</h3>
              <div class="stats-grid grid-4">
                <div class="stat-card">
                  <div class="stat-card-title">Average ROI</div>
                  <div class="stat-card-value" id="stat-avg-roi">0%</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-title">Profit Margin</div>
                  <div class="stat-card-value" id="stat-profit-margin">0%</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-title">Sell-Through Rate</div>
                  <div class="stat-card-value" id="stat-sell-through">0%</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-title">Avg Days to Sell</div>
                  <div class="stat-card-value" id="stat-avg-days">0</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-title">Best Performer</div>
                  <div class="stat-card-value text-success" id="stat-best-bike" style="font-size: 1.1rem;">-</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-title">Worst Performer</div>
                  <div class="stat-card-value text-error" id="stat-worst-bike" style="font-size: 1.1rem;">-</div>
                </div>
              </div>
            </div>
            
            <!-- Monthly Profit Trend Chart -->
            <div class="chart-container card">
              <h3>
                <span>Monthly Profit & Moving Average</span>
                <div class="chart-controls">
                  <button class="btn-icon btn-ghost" id="download-profit-chart" title="Download Chart" aria-label="Download profit chart as PNG">
                    <svg width="20" height="20"><use href="#icon-download"></use></svg>
                  </button>
                  <button class="btn-icon btn-ghost" id="export-profit-csv" title="Export Data" aria-label="Export profit data as CSV">
                    <svg width="20" height="20"><use href="#icon-save"></use></svg>
                  </button>
                </div>
              </h3>
              <canvas id="chart-profit-trend" role="img" aria-label="Monthly profit trend chart"></canvas>
            </div>
            
            <!-- Profit Distribution Pie Chart -->
            <div class="chart-container card">
              <h3>
                <span>Profit Distribution (Sold Bikes)</span>
                <div class="chart-controls">
                  <button class="btn-icon btn-ghost" id="download-pie-chart" title="Download Chart" aria-label="Download pie chart as PNG">
                    <svg width="20" height="20"><use href="#icon-download"></use></svg>
                  </button>
                </div>
              </h3>
              <canvas id="chart-profit-pie" role="img" aria-label="Profit distribution pie chart"></canvas>
            </div>
            
            <!-- Top 5 Profitable Bikes -->
            <div class="chart-container card">
              <h3>
                <span>Top 5 Profitable Bikes (Sold)</span>
                <div class="chart-controls">
                  <button class="btn-icon btn-ghost" id="download-top-chart" title="Download Chart" aria-label="Download top bikes chart as PNG">
                    <svg width="20" height="20"><use href="#icon-download"></use></svg>
                  </button>
                </div>
              </h3>
              <canvas id="chart-top-bikes" role="img" aria-label="Top 5 profitable bikes bar chart"></canvas>
            </div>
          </div>
          
          <!-- [v7.0 FEATURE] Stats Empty State -->
          <div id="stats-empty" class="empty-state hidden">
            <svg><use href="#icon-chart"></use></svg>
            <h3>No Data for Analytics</h3>
            <p>Sell a bike to start seeing your stats and insights.</p>
          </div>
          
        </section>
        
        <!-- =================== -->
        <!-- SETTINGS VIEW       -->
        <!-- =================== -->
        <section id="view-settings" class="view">
          <h2>Settings</h2>
          
          <!-- Appearance -->
          <div class="settings-section">
            <h3>Appearance</h3>
            <div class="theme-toggle">
              <label for="theme-switch-label">Dark Mode</label>
              <div class="switch" id="theme-switch" role="switch" aria-checked="true" tabindex="0" aria-labelledby="theme-switch-label"></div>
            </div>
            <div class="form-group">
              <label for="list-density">List Density</label>
              <select class="form-select" id="list-density">
                <option value="comfortable">Comfortable</option>
                <option value="compact">Compact</option>
              </select>
            </div>
          </div>
          
          <!-- GitHub Gist Sync -->
          <div class="settings-section">
            <h3>GitHub Gist Sync</h3>
            <p>Syncs your data (including photo data) to a private GitHub Gist. This is a manual sync. Press "Sync Now" in the header to move data.</p>
            
            <div class="form-group">
              <label for="setting-gist-id">Gist ID</label>
              <input type="text" class="form-input" id="setting-gist-id" placeholder="e.g., a1b2c3d4e5f6a7b8c9d0" />
            </div>
            <div class="form-group">
              <label for="setting-gist-filename">Gist Filename</label>
              <input type="text" class="form-input" id="setting-gist-filename" value="bikes_inventory.csv" />
            </div>
            <div class="form-group">
              <label for="setting-github-pat">GitHub Personal Access Token (PAT)</label>
              <input type="password" class="form-input" id="setting-github-pat" placeholder="ghp_... (stored in session)" autocomplete="password" />
              <p class="text-secondary" style="font-size: 0.8rem; margin-top: 6px;">
                Requires `gist` scope. Your browser will offer to save this. It's stored <strong>only</strong> in sessionStorage.
              </p>
            </div>
            <button class="btn btn-secondary" id="save-sync-settings">
              <svg width="20" height="20"><use href="#icon-save"></use></svg>
              <span>Save Sync Settings</span>
            </button>
          </div>
          
          <!-- Personalization -->
          <div class="settings-section">
            <h3>Personalization</h3>
            <div class="form-group">
              <label for="setting-business-name">Business Name</label>
              <input type="text" class="form-input" id="setting-business-name" placeholder="My Bike Shop" />
            </div>
            <div class="form-group">
              <label for="setting-currency">Currency Symbol</label>
              <input type="text" class="form-input" id="setting-currency" placeholder="₹" style="width: 100px;" />
            </div>
            <!-- [v7.0 FEATURE] Profit Goal -->
            <div class="form-group">
              <label for="setting-profit-goal">Annual Profit Goal</label>
              <input type="number" class="form-input" id="setting-profit-goal" placeholder="e.g., 500000" />
            </div>
            <button class="btn btn-secondary" id="save-display-settings">Save Display Settings</button>
          </div>
          
          <!-- Data Management -->
          <div class="settings-section">
            <h3>Data Management</h3>
            <p>Manage your local data. Exports will include photo data, which can make files large.</p>
            <div class="form-grid" style="gap: 12px; grid-template-columns: 1fr 1fr;">
              <button class="btn btn-secondary" id="export-csv">Export as CSV</button>
              <button class="btn btn-secondary" id="export-json">Export as JSON</button>
              <button class="btn btn-secondary" id="export-xlsx">Export as XLSX</button>
              <button class="btn btn-secondary" id="import-csv">Import CSV/JSON</button>
              <button class="btn btn-secondary" id="download-template">
                <svg width="18" height="18"><use href="#icon-download"></use></svg>
                <span>Download Template</span>
              </button>
              <button class="btn btn-secondary hidden" id="share-data">
                <svg width="18" height="18"><use href="#icon-share"></use></svg>
                <span>Share Data</span>
              </button>
            </div>
            <input type="file" id="import-file-input" class="hidden" accept=".csv,.json,text/csv,application/json" />
            
            <!-- [v7.0 FEATURE] Data Health -->
            <h4 class="mt-2">Data Health</h4>
            <p class="text-secondary">Check for potential issues in your data.</p>
            <button class="btn btn-secondary" id="run-data-audit">
              <svg width="18" height="18"><use href="#icon-health"></use></svg>
              <span>Run Data Audit</span>
            </button>
            <div id="data-audit-results" class="mt-2 hidden"></div>
            
            <h4 class="mt-2">Keyboard Shortcuts</h4>
            <p class="text-secondary">
              <span class="kbd">Ctrl</span> + <span class="kbd">N</span> New bike &nbsp;•&nbsp;
              <span class="kbd">Ctrl</span> + <span class="kbd">S</span> Save &nbsp;•&nbsp;
              <span class="kbd">Esc</span> Close modal &nbsp;•&nbsp;
              <span class="kbd">Ctrl</span> + <span class="kbd">Z</span> Undo
            </p>
            
            <h4 class="mt-2">Danger Zone</h4>
            <button class="btn btn-danger" id="wipe-data-btn">
              <svg width="20" height="20"><use href="#icon-delete"></use></svg>
              <span>Wipe All Local Data</span>
            </button>
          </div>

        </section>
        
      </main>
    </div>
  </div>

  <!-- FAB (Floating Action Button) -->
  <button class="fab" id="fab-buy" title="Buy New Bike" aria-label="Buy new bike">
    <svg><use href="#icon-buy"></use></svg>
  </button>
  
  <!-- Bulk Action Toolbar -->
  <div class="bulk-action-bar" id="bulk-action-bar" role="toolbar" aria-label="Bulk actions">
    <span class="count"><span id="selected-count">0</span> selected</span>
    <button class="btn btn-secondary btn-sm" id="bulk-mark-sold">Mark Sold</button>
    <button class="btn btn-secondary btn-sm" id="bulk-export">Export</button>
    <button class="btn btn-ghost btn-sm" id="bulk-deselect">Clear</button>
  </div>
  
  <!-- Form Modal (Buy/Sell/Edit) -->
  <div class="modal-overlay" id="form-modal" role="dialog" aria-labelledby="form-title" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="form-title">Buy New Bike</h2>
        <button class="btn-icon btn-ghost" id="close-form-modal" aria-label="Close">
          <svg><use href="#icon-close"></use></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="bike-form" onsubmit="return false;">
          <input type="hidden" id="form-bike-id" />
          <input type="hidden" id="form-temp-photo-data" />
          
          <!-- [v7.0 FEATURE] Photo Upload -->
          <div class="form-group" id="form-section-photo">
            <label>Bike Photo</label>
            <div id="form-photo-upload">
              <input type="file" id="form-photo-input" accept="image/*" aria-label="Upload bike photo" />
              <div id="form-photo-preview" role="button" tabindex="0" aria-label="Tap to add photo">
                <img id="form-photo-preview-img" src="" alt="Bike preview" />
              </div>
              <div class="photo-buttons">
                <button class="btn btn-secondary btn-sm" id="form-photo-trigger">Upload Photo</button>
                <button class="btn btn-ghost btn-sm" id="form-photo-remove">Remove</button>
              </div>
            </div>
          </div>
          
          <div id="form-section-buy">
            <h3 class="form-section-title">Purchase Details</h3>
            <div class="form-group">
              <label for="form-no">Bike Number (Plate) *</label>
              <input type="text" class="form-input" id="form-no" placeholder="GJ05AB1234" required aria-required="true" />
            </div>
            <div class="form-group">
              <label for="form-owner">Owner Name *</label>
              <input type="text" class="form-input" id="form-owner" required aria-required="true" />
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label for="form-datePurchase">Purchase Date</label>
                <input type="date" class="form-input" id="form-datePurchase" />
              </div>
              <div class="form-group">
                <label for="form-purchasePrice">Purchase Price</label>
                <input type="number" class="form-input" id="form-purchasePrice" placeholder="0" step="0.01" inputmode="decimal" />
              </div>
            </div>
            <div class="form-group">
              <label for="form-repairCost">Repair Cost</label>
              <input type="number" class="form-input" id="form-repairCost" placeholder="0" step="0.01" inputmode="decimal" />
            </div>
          </div>
          
          <div id="form-section-sell" class="hidden">
            <div class="form-section-divider"></div>
            <h3 class="form-section-title">Selling Details</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="form-dateSelling">Selling Date</label>
                <input type="date" class="form-input" id="form-dateSelling" />
              </div>
              <div class="form-group">
                <label for="form-sellingPrice">Selling Price</label>
                <input type="number" class="form-input" id="form-sellingPrice" placeholder="0" step="0.01" inputmode="decimal" />
              </div>
            </div>
            <div class="form-group">
              <label for="form-netProfit">Net Profit (Auto)</label>
              <input type="number" class="form-input" id="form-netProfit" readonly aria-readonly="true" tabIndex="-1" />
            </div>
          </div>
          
          <!-- [v7.0 FEATURE] Notes -->
          <div id="form-section-notes">
            <div class="form-section-divider"></div>
            <h3 class="form-section-title">Notes</h3>
            <div class="form-group">
              <label for="form-notes" class="hidden">Bike Notes</label>
              <textarea id="form-notes" class="form-textarea" placeholder="Add notes about repairs, condition, etc."></textarea>
            </div>
          </div>
          
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="delete-bike-btn" style="margin-right: auto;">
          <svg width="20" height="20"><use href="#icon-delete"></use></svg>
          <span>Delete</span>
        </button>
        <button class="btn btn-secondary hidden" id="duplicate-bike-btn">
          <svg width="20" height="20"><use href="#icon-duplicate"></use></svg>
          <span>Duplicate</span>
        </button>
        <button class="btn btn-secondary" id="cancel-form-btn">Cancel</button>
        <button class="btn btn-primary" id="save-form-btn">
          <svg width="20" height="20"><use href="#icon-save"></use></svg>
          <span id="save-form-btn-text">Save Purchase</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Update Modal -->
  <div class="modal-overlay" id="update-modal" role="dialog" aria-labelledby="update-title" aria-modal="true">
    <div class="modal-content text-center">
      <h2 id="update-title">Update Available</h2>
      <p class="text-secondary mb-2">A new version of Bike Manager is ready. Refresh to get the latest features.</p>
      <button class="btn btn-primary" id="update-refresh-btn">Refresh Now</button>
    </div>
  </div>

  <!-- PAT Re-entry Modal -->
  <div class="modal-overlay" id="pat-modal" role="dialog" aria-labelledby="pat-title" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="pat-title">GitHub PAT Required</h2>
      </div>
      <div class="modal-body">
        <p class="text-secondary mb-2">Your GitHub Personal Access Token was cleared when you closed your last session. Please re-enter it to enable sync.</p>
        <div class="form-group">
          <label for="pat-reenter">GitHub PAT</label>
          <input type="password" class="form-input" id="pat-reenter" placeholder="ghp_..." autocomplete="password" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="pat-skip">Skip</button>
        <button class="btn btn-primary" id="pat-submit">Submit</button>
      </div>
    </div>
  </div>

  <!-- [v7.0 FEATURE] Reusable Confirmation Modal -->
  <div class="modal-overlay" id="confirm-modal" role="dialog" aria-labelledby="confirm-title" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="confirm-title">Are you sure?</h2>
      </div>
      <div class="modal-body">
        <p id="confirm-message" class="text-secondary">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="confirm-cancel">Cancel</button>
        <button class="btn btn-danger" id="confirm-ok">Confirm</button>
      </div>
    </div>
  </div>
  
  <!-- [v7.0 FEATURE] Image View Modal -->
  <div class="modal-overlay" id="image-modal" role="dialog" aria-label="Image Viewer">
    <div class="modal-content">
      <img id="image-modal-img" src="" alt="Full size bike photo" />
    </div>
    <button class="btn-icon btn-ghost" id="image-modal-close" aria-label="Close" style="position:absolute; top: 16px; right: 16px; background: rgba(0,0,0,0.3);">
      <svg><use href="#icon-close"></use></svg>
    </button>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container" role="region" aria-live="polite" aria-label="Notifications"></div>
  
  <!-- Confetti Canvas -->
  <canvas id="confetti-canvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9998;" aria-hidden="true"></canvas>

  <!-- Hidden form for browser password manager -->
  <form id="pat-save-form" class="hidden" autocomplete="on">
    <input type="text" name="username" autocomplete="username" value="github-gist-sync" />
    <input type="password" name="password" id="pat-save-input" autocomplete="current-password" />
    <button type="submit"></button>
  </form>

  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/dexie@4.0.1/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <!-- Inline Application JavaScript -->
  <script>
    // --- APP CONSTANTS ---
    const OLD_STORAGE_KEY = 'bikes_db_v2';
    const SETTINGS_KEY = 'bike_manager_settings_v7';
    const PAT_KEY = 'bike_manager_pat_v7';
    const THEME_KEY = 'bike_manager_theme';
    const UNDO_KEY = 'bike_manager_undo_v7';
    const ITEMS_PER_PAGE = 50;
    const DB_VERSION = 2; // [v7.0] Incremented DB version

    /**
     * @class BikeManagerApp
     * Main application class v7.0
     */
    class BikeManagerApp {
      
      constructor() {
        this.db = null;
        this.charts = {};
        this.currentFilters = {
          search: '',
          status: 'all',
          sort: 'latest',
        };
        this.settings = {
          businessName: 'Bike Manager',
          currency: '₹',
          profitGoal: 500000, // [v7.0] New setting
          gistId: '',
          gistFilename: 'bikes_inventory.csv',
          githubPat: '',
          lastSync: null,
          lastSyncSha: null,
          listDensity: 'comfortable',
        };
        this.currentView = 'view-list';
        this.isMobile = window.innerWidth < 768;
        this.isOnline = navigator.onLine;
        this.selectedBikes = new Set();
        this.undoStack = [];
        this.currentPage = 1;
        this.totalPages = 1;
        this.statsDateFilter = { from: null, to: null };
        
        // [v7.0] Swipe gesture state
        this.touchStartX = 0;
        this.touchMoveX = 0;
        this.swipeTarget = null;
        this.swipedCard = null;
        this.swipeThreshold = 60; // Min px to trigger swipe

        // Debounced functions
        this.debouncedRenderList = this.debounce(() => this.renderBikeList(), 250);
        this.debouncedSyncNow = this.debounce(() => this.syncNowInternal(), 5000, true);
        
        // Cache DOM elements
        this.dom = {
          loader: document.getElementById('app-loader'),
          loaderStatus: document.getElementById('app-loader-status'),
          headerTitle: document.getElementById('header-title'),
          views: document.querySelectorAll('.view'),
          navButtons: document.querySelectorAll('.nav-btn'),
          syncStatus: document.getElementById('sync-status'),
          syncStatusText: document.getElementById('sync-status-text'),
          syncNowBtn: document.getElementById('sync-now-btn'),
          searchClear: document.getElementById('search-clear'),
          searchInput: document.getElementById('search-input'),
          formModal: document.getElementById('form-modal'),
          bikeList: document.getElementById('bike-list'),
          bikeListSkeleton: document.getElementById('bike-list-skeleton'),
          bikeListEmpty: document.getElementById('bike-list-empty'),
          pagination: document.getElementById('pagination'),
          confirmModal: document.getElementById('confirm-modal'),
          imageModal: document.getElementById('image-modal'),
          statsSkeleton: document.getElementById('stats-skeleton'),
          statsContent: document.getElementById('stats-content'),
          statsEmpty: document.getElementById('stats-empty'),
        };
        
        // Start the app
        document.addEventListener('DOMContentLoaded', () => this.init());
      }
      
      /**
       * Primary initialization function.
       */
      async init() {
        try {
          console.log('Starting initialization v7.0...');
          this.vibrate(10);
          
          this.initServiceWorker();
          
          this.updateLoaderStatus('Initializing database (v2)...');
          await this.initDatabase();
          
          this.updateLoaderStatus('Loading settings...');
          await this.loadSettings();
          
          // [v6.3 BUGFIX] Clean up any corrupted numeric data
          this.updateLoaderStatus('Verifying data integrity...');
          await this.cleanCorruptedData();
          
          this.updateLoaderStatus('Migrating old data (if any)...');
          await this.migrateFromLocalStorage();
          
          this.updateLoaderStatus('Preparing UI...');
          this.initUI();
          this.initEventListeners();
          
          this.updateLoaderStatus('Rendering data...');
          await this.renderAll();
          
          this.checkPATStatus();
          
          console.log('Initialization complete!');
          if (this.dom.loader) this.dom.loader.classList.add('hidden');
          
        } catch (error) {
          console.error("Critical initialization failed:", error);
          if (this.dom.loaderStatus) {
            this.dom.loaderStatus.textContent = "Error loading app: " + error.message;
            this.dom.loaderStatus.classList.add('text-error');
          }
        }
      }
      
      updateLoaderStatus(text) {
        console.log('Status:', text);
        if (this.dom.loaderStatus) this.dom.loaderStatus.textContent = text;
      }

      // --- 1. PWA & SERVICE WORKER ---
      
      initServiceWorker() {
        if ('serviceWorker' in navigator) {
          const swCode = `
            /* Service Worker for Bike Manager v7.0 */
            const CACHE_NAME = 'bike-manager-v70-cache';
            const URLS_TO_CACHE = [
              './',
              'https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap',
              'https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7.woff2',
              'https://cdn.jsdelivr.net/npm/dexie@4.0.1/dist/dexie.min.js',
              'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js',
              'https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js'
            ];
            
            self.addEventListener('install', (event) => {
              event.waitUntil(
                caches.open(CACHE_NAME)
                  .then((cache) => {
                    return Promise.allSettled(
                      URLS_TO_CACHE.map(url => cache.add(url).catch(err => console.warn('SW: Failed to cache:', url, err)))
                    );
                  })
                  .then(() => self.skipWaiting())
              );
            });
            
            self.addEventListener('activate', (event) => {
              event.waitUntil(
                caches.keys().then((cacheNames) => {
                  return Promise.all(
                    cacheNames.map((cacheName) => {
                      if (cacheName !== CACHE_NAME) {
                        return caches.delete(cacheName);
                      }
                    })
                  );
                }).then(() => self.clients.claim())
              );
            });
            
            self.addEventListener('fetch', (event) => {
              if (event.request.method !== 'GET') return;
              const url = new URL(event.request.url);
              
              if (url.origin === 'https://cdn.jsdelivr.net' || url.origin === 'https://fonts.googleapis.com' || url.origin === 'https://fonts.gstatic.com') {
                event.respondWith(caches.match(event.request).then(response => {
                  return response || fetch(event.request).then(fetchResponse => {
                    return caches.open(CACHE_NAME).then(cache => {
                      cache.put(event.request, fetchResponse.clone());
                      return fetchResponse;
                    });
                  });
                }));
              } else if (event.request.url.endsWith(self.location.pathname) || event.request.url.endsWith('/')) {
                 event.respondWith(fetch(event.request).catch(() => caches.match(event.request)));
              } else if (url.hostname === 'api.github.com') {
                event.respondWith(fetch(event.request).catch(() => new Response(JSON.stringify({error: 'Offline'}), {
                  status: 503, headers: {'Content-Type': 'application/json'}
                })));
              }
            });
            
            self.addEventListener('message', (event) => {
              if (event.data && event.data.type === 'SKIP_WAITING') {
                self.skipWaiting();
              }
            });
          `;
          
          try {
            const swUrl = 'data:application/javascript;base64,' + btoa(swCode);
            navigator.serviceWorker.register(swUrl)
              .then(registration => {
                console.log('Service Worker v7.0 registered:', registration.scope);
                registration.onupdatefound = () => {
                  const installingWorker = registration.installing;
                  if (installingWorker) {
                    installingWorker.onstatechange = () => {
                      if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        this.showUpdateModal();
                      }
                    };
                  }
                };
              })
              .catch(error => console.error('Service Worker registration failed:', error));
          } catch (error) {
            console.error('Service Worker registration failed (CSP?):', error);
          }
          
          navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
        }
      }
      
      showUpdateModal() {
        const modal = document.getElementById('update-modal');
        if (modal) modal.classList.add('active');
        const refreshBtn = document.getElementById('update-refresh-btn');
        if (refreshBtn) {
          refreshBtn.onclick = () => {
            navigator.serviceWorker.getRegistration().then(reg => {
              if (reg && reg.waiting) {
                reg.waiting.postMessage({ type: 'SKIP_WAITING' });
              }
            });
          };
        }
      }
      
      // --- 2. DATABASE & DATA MIGRATION ---

      async initDatabase() {
        try {
          console.log(`Initializing Dexie database v${DB_VERSION}...`);
          this.db = new Dexie('BikeDB_v7'); // Renamed DB to avoid v6 conflicts
          
          this.db.version(DB_VERSION).stores({
            // [v7.0] Added 'photo' and 'notes'
            bikes: '++_id, &no, owner, _updatedAt, dateSelling, _deleted, [dateSelling+_deleted]',
          }).upgrade(tx => {
            // Migration logic from v1 (or initial) to v2
            return tx.table('bikes').toCollection().modify(bike => {
              if (typeof bike.photo === 'undefined') {
                bike.photo = '';
              }
              if (typeof bike.notes === 'undefined') {
                bike.notes = '';
              }
            });
          });
          
          await this.db.open();
          console.log(`Database v${DB_VERSION} initialized successfully`);
        } catch (error) {
          console.error("Database initialization failed:", error);
          throw new Error("Failed to initialize database: " + error.message);
        }
      }
      
      async cleanCorruptedData() {
        try {
          const allBikes = await this.db.bikes.toArray();
          const bikesToFix = allBikes.filter(b => 
            typeof b.purchasePrice === 'string' || typeof b.repairCost === 'string' ||
            typeof b.sellingPrice === 'string' || typeof b.netProfit === 'string'
          );
            
          if (bikesToFix.length > 0) {
            console.log(`Found ${bikesToFix.length} corrupted records. Fixing...`);
            this.showToast(`Fixing ${bikesToFix.length} corrupted data entries...`, 'warning');
            
            const fixedBikes = bikesToFix.map(b => {
              const purchasePrice = parseFloat(b.purchasePrice) || 0;
              const repairCost = parseFloat(b.repairCost) || 0;
              const sellingPrice = parseFloat(b.sellingPrice) || 0;
              return {
                ...b,
                no: (b.no || '').trim().toUpperCase(),
                purchasePrice, repairCost, sellingPrice,
                netProfit: sellingPrice - (purchasePrice + repairCost),
              };
            });
            
            await this.db.bikes.bulkPut(fixedBikes);
            console.log("Corruption fix complete.");
          }
        } catch (error) {
          console.error("Failed during data cleaning:", error);
        }
      }

      async migrateFromLocalStorage() {
        const oldDataRaw = localStorage.getItem(OLD_STORAGE_KEY);
        if (!oldDataRaw) return;
        
        try {
          const oldDb = JSON.parse(oldDataRaw);
          if (!Array.isArray(oldDb) || oldDb.length === 0) {
            localStorage.removeItem(OLD_STORAGE_KEY);
            return;
          }
          
          this.showToast(`Migrating ${oldDb.length} old records...`, 'info');
          const now = new Date().toISOString();
          const recordsToMigrate = oldDb.map(record => ({
            ...record,
            no: (record.no || '').trim().toUpperCase(),
            purchasePrice: parseFloat(record.purchasePrice) || 0,
            repairCost: parseFloat(record.repairCost) || 0,
            sellingPrice: parseFloat(record.sellingPrice) || 0,
            netProfit: parseFloat(record.netProfit) || 0,
            _updatedAt: record._updatedAt || now,
            _deleted: Boolean(record._deleted),
            photo: '', // [v7.0] Add new fields
            notes: '',
          }));
          
          await this.db.bikes.bulkPut(recordsToMigrate);
          localStorage.removeItem(OLD_STORAGE_KEY);
          this.showToast(`Successfully migrated ${oldDb.length} records.`, 'success');
        } catch (error) {
          console.error("Migration failed:", error);
          this.showToast("Failed to migrate old data.", 'error');
        }
      }

      // --- 3. SETTINGS & PERSONALIZATION ---
      
      async loadSettings() {
        const savedSettings = localStorage.getItem(SETTINGS_KEY);
        if (savedSettings) {
          this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
        }
        
        const savedPat = sessionStorage.getItem(PAT_KEY);
        if (savedPat) this.settings.githubPat = savedPat;
        
        const savedTheme = localStorage.getItem(THEME_KEY);
        if (savedTheme === 'light') {
          document.body.classList.add('theme-light');
          document.body.classList.remove('theme-dark');
        } else if (savedTheme === 'dark') {
          document.body.classList.add('theme-dark');
          document.body.classList.remove('theme-light');
        }
        
        this.loadUndoStack();
        this.applySettings();
      }
      
      async saveSettings() {
        const { githubPat, ...settingsToSave } = this.settings;
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settingsToSave));
        this.applySettings();
        this.vibrate(10);
      }
      
      applySettings() {
        if (this.dom.headerTitle) {
          this.dom.headerTitle.textContent = this.settings.businessName || 'Bike Manager';
        }
        document.title = this.settings.businessName || 'Bike Manager';
        document.querySelectorAll('.currency').forEach(el => {
          if (el) el.textContent = this.settings.currency || '₹';
        });
        
        // Update settings page inputs
        document.getElementById('setting-gist-id').value = this.settings.gistId || '';
        document.getElementById('setting-gist-filename').value = this.settings.gistFilename || 'bikes_inventory.csv';
        document.getElementById('setting-github-pat').value = this.settings.githubPat || '';
        document.getElementById('setting-business-name').value = this.settings.businessName || '';
        document.getElementById('setting-currency').value = this.settings.currency || '';
        document.getElementById('setting-profit-goal').value = this.settings.profitGoal || '';
        document.getElementById('list-density').value = this.settings.listDensity || 'comfortable';
        
        if (this.dom.bikeList) {
          this.dom.bikeList.classList.toggle('compact', this.settings.listDensity === 'compact');
        }
      }
      
      checkPATStatus() {
        if (this.settings.gistId && !this.settings.githubPat && localStorage.getItem('pat_needs_reentry') === 'true') {
          document.getElementById('pat-modal').classList.add('active');
        }
      }
      
      // --- 4. UI & EVENT LISTENERS ---
      
      initUI() {
        document.getElementById('buy-bike-desktop').style.display = this.isMobile ? 'none' : 'inline-flex';
        
        if ('share' in navigator) {
          document.getElementById('share-data').classList.remove('hidden');
        }
        
        document.getElementById('filter-all').classList.add('active');
        this.updateOnlineStatus();
        
        const isDark = document.body.classList.contains('theme-dark') || 
                      (!document.body.classList.contains('theme-light') && window.matchMedia('(prefers-color-scheme: dark)').matches);
        const themeSwitch = document.getElementById('theme-switch');
        if (themeSwitch) themeSwitch.classList.toggle('active', isDark);
      }
      
      initEventListeners() {
        // Navigation
        this.dom.navButtons.forEach(btn => btn.addEventListener('click', () => this.navigateTo(btn.dataset.view)));
        this.dom.syncNowBtn.addEventListener('click', () => this.syncNow());
        
        // Search
        this.dom.searchInput.addEventListener('input', (e) => {
          this.currentFilters.search = e.target.value.toLowerCase();
          this.currentPage = 1;
          this.debouncedRenderList();
        });
        this.dom.searchClear.addEventListener('click', () => {
          this.dom.searchInput.value = '';
          this.currentFilters.search = '';
          this.currentPage = 1;
          this.debouncedRenderList();
        });
        
        // Sort
        document.getElementById('sort-btn').addEventListener('click', () => {
          const menu = document.getElementById('sort-menu');
          menu.classList.toggle('active');
          document.getElementById('sort-btn').setAttribute('aria-expanded', menu.classList.contains('active'));
        });
        document.querySelectorAll('.sort-option').forEach(opt => {
          opt.addEventListener('click', () => {
            this.currentFilters.sort = opt.dataset.sort;
            document.querySelectorAll('.sort-option').forEach(o => o.classList.remove('active'));
            opt.classList.add('active');
            document.getElementById('sort-label').textContent = opt.textContent.replace('✓', '').trim();
            document.getElementById('sort-menu').classList.remove('active');
            document.getElementById('sort-btn').setAttribute('aria-expanded', 'false');
            this.currentPage = 1;
            this.renderBikeList();
          });
        });
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.sort-dropdown')) {
            document.getElementById('sort-menu').classList.remove('active');
            document.getElementById('sort-btn').setAttribute('aria-expanded', 'false');
          }
        });
        
        // Filters
        document.getElementById('filter-all').addEventListener('click', () => this.setFilterStatus('all'));
        document.getElementById('filter-sold').addEventListener('click', () => this.setFilterStatus('sold'));
        document.getElementById('filter-unsold').addEventListener('click', () => this.setFilterStatus('unsold'));
        
        // Bike list interactions
        this.dom.bikeList.addEventListener('click', (e) => this.handleBikeListClick(e));
        
        // [v7.0] Swipe Gestures
        this.dom.bikeList.addEventListener('touchstart', (e) => this.handleSwipeStart(e), { passive: true });
        this.dom.bikeList.addEventListener('touchmove', (e) => this.handleSwipeMove(e), { passive: false });
        this.dom.bikeList.addEventListener('touchend', (e) => this.handleSwipeEnd(e));
        
        // Add bike buttons
        document.getElementById('fab-buy').addEventListener('click', () => this.handleNewBike());
        document.getElementById('buy-bike-desktop').addEventListener('click', () => this.handleNewBike());
        
        // Bulk actions
        document.getElementById('bulk-mark-sold').addEventListener('click', () => this.handleBulkMarkSold());
        document.getElementById('bulk-export').addEventListener('click', () => this.handleBulkExport());
        document.getElementById('bulk-deselect').addEventListener('click', () => this.clearSelection());
        
        // Pagination
        document.getElementById('prev-page').addEventListener('click', () => this.changePage(-1));
        document.getElementById('next-page').addEventListener('click', () => this.changePage(1));
        
        // Form Modal
        document.getElementById('close-form-modal').addEventListener('click', () => this.closeFormModal());
        document.getElementById('cancel-form-btn').addEventListener('click', () => this.closeFormModal());
        document.getElementById('save-form-btn').addEventListener('click', () => this.handleSaveBike());
        document.getElementById('delete-bike-btn').addEventListener('click', () => this.handleDeleteBike());
        document.getElementById('duplicate-bike-btn').addEventListener('click', () => this.handleDuplicateBike());
        this.dom.formModal.addEventListener('click', (e) => {
          if (e.target === this.dom.formModal) this.closeFormModal();
        });
        
        // [v7.0] Photo Upload Listeners
        document.getElementById('form-photo-trigger').addEventListener('click', (e) => {
          e.preventDefault();
          document.getElementById('form-photo-input').click();
        });
        document.getElementById('form-photo-preview').addEventListener('click', () => {
          document.getElementById('form-photo-input').click();
        });
        document.getElementById('form-photo-input').addEventListener('change', (e) => this.handlePhotoPreview(e));
        document.getElementById('form-photo-remove').addEventListener('click', (e) => {
          e.preventDefault();
          this.clearPhotoPreview();
        });

        // Form profit calculation
        ['form-purchasePrice', 'form-repairCost', 'form-sellingPrice'].forEach(id => {
          document.getElementById(id).addEventListener('input', () => this.calculateFormProfit());
        });
        
        // Settings
        document.getElementById('save-sync-settings').addEventListener('click', () => this.handleSaveSyncSettings());
        document.getElementById('save-display-settings').addEventListener('click', () => this.handleSaveDisplaySettings());
        document.getElementById('theme-switch').addEventListener('click', () => this.toggleTheme());
        document.getElementById('theme-switch').addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.toggleTheme(); }
        });
        document.getElementById('list-density').addEventListener('change', (e) => {
          this.settings.listDensity = e.target.value;
          this.saveSettings();
          this.renderBikeList();
        });
        
        // Data management
        document.getElementById('export-csv').addEventListener('click', () => this.exportData('csv'));
        document.getElementById('export-json').addEventListener('click', () => this.exportData('json'));
        document.getElementById('export-xlsx').addEventListener('click', () => this.exportData('xlsx'));
        document.getElementById('import-csv').addEventListener('click', () => document.getElementById('import-file-input').click());
        document.getElementById('download-template').addEventListener('click', () => this.downloadTemplate());
        document.getElementById('share-data').addEventListener('click', () => this.handleShareData());
        document.getElementById('import-file-input').addEventListener('change', (e) => this.handleImportFile(e));
        document.getElementById('wipe-data-btn').addEventListener('click', () => this.handleWipeData());
        
        // [v7.0] Data Health
        document.getElementById('run-data-audit').addEventListener('click', () => this.handleDataAudit());

        // Stats
        document.getElementById('apply-date-filter').addEventListener('click', () => this.applyStatsDateFilter());
        document.getElementById('reset-date-filter').addEventListener('click', () => this.resetStatsDateFilter());
        document.getElementById('ai-insight-refresh').addEventListener('click', () => this.generateAIInsight());
        document.getElementById('download-profit-chart').addEventListener('click', () => this.downloadChart('chart-profit-trend', 'profit-trend'));
        document.getElementById('export-profit-csv').addEventListener('click', () => this.exportChartData('profit'));
        document.getElementById('download-pie-chart').addEventListener('click', () => this.downloadChart('chart-profit-pie', 'profit-distribution'));
        document.getElementById('download-top-chart').addEventListener('click', () => this.downloadChart('chart-top-bikes', 'top-bikes'));
        
        // PAT modal
        document.getElementById('pat-skip').addEventListener('click', () => {
          document.getElementById('pat-modal').classList.remove('active');
          localStorage.removeItem('pat_needs_reentry');
        });
        document.getElementById('pat-submit').addEventListener('click', () => {
          const pat = document.getElementById('pat-reenter').value.trim();
          if (pat) {
            this.settings.githubPat = pat;
            sessionStorage.setItem(PAT_KEY, pat);
            document.getElementById('pat-modal').classList.remove('active');
            localStorage.removeItem('pat_needs_reentry');
            this.showToast('PAT restored for this session.', 'success');
            this.syncNow();
          } else {
            this.showToast('Please enter a valid PAT.', 'error');
          }
        });
        
        // [v7.0] Confirmation Modal
        document.getElementById('confirm-cancel').addEventListener('click', () => this.dom.confirmModal.classList.remove('active'));
        
        // [v7.0] Image Modal
        this.dom.imageModal.addEventListener('click', () => this.dom.imageModal.classList.remove('active'));
        document.getElementById('image-modal-close').addEventListener('click', () => this.dom.imageModal.classList.remove('active'));

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => this.handleKeydown(e));
        
        // System events
        window.addEventListener('online', () => this.updateOnlineStatus());
        window.addEventListener('offline', () => this.updateOnlineStatus());
        window.addEventListener('resize', this.debounce(() => {
          const newIsMobile = window.innerWidth < 768;
          if (newIsMobile !== this.isMobile) {
            this.isMobile = newIsMobile;
            this.initUI();
          }
        }, 200));
        window.addEventListener('beforeunload', () => {
          if (this.settings.githubPat) {
            localStorage.setItem('pat_needs_reentry', 'true');
          }
        });
      }
      
      handleKeydown(e) {
        const modalActive = document.querySelector('.modal-overlay.active');
        const inputFocused = document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA';

        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
          e.preventDefault();
          if (!modalActive) this.handleNewBike();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
          if (this.dom.formModal.classList.contains('active')) {
            e.preventDefault();
            this.handleSaveBike();
          }
        }
        if (e.key === 'Escape') {
          if (modalActive) {
            modalActive.classList.remove('active');
          }
          const sortMenu = document.getElementById('sort-menu');
          if (sortMenu.classList.contains('active')) {
            sortMenu.classList.remove('active');
            document.getElementById('sort-btn').setAttribute('aria-expanded', 'false');
          }
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
          if (!inputFocused && !modalActive) {
            e.preventDefault();
            this.performUndo();
          }
        }
      }
      
      toggleTheme() {
        const themeSwitch = document.getElementById('theme-switch');
        const isDark = document.body.classList.contains('theme-dark') || 
                      (!document.body.classList.contains('theme-light') && window.matchMedia('(prefers-color-scheme: dark)').matches);
        
        if (isDark) {
          document.body.classList.remove('theme-dark');
          document.body.classList.add('theme-light');
          localStorage.setItem(THEME_KEY, 'light');
          themeSwitch.classList.remove('active');
          themeSwitch.setAttribute('aria-checked', 'false');
        } else {
          document.body.classList.remove('theme-light');
          document.body.classList.add('theme-dark');
          localStorage.setItem(THEME_KEY, 'dark');
          themeSwitch.classList.add('active');
          themeSwitch.setAttribute('aria-checked', 'true');
        }
        this.vibrate(10);
        if(this.currentView === 'view-stats') {
          this.renderStatsDashboard();
        }
      }
      
      /**
       * Renders all data-driven parts of the UI.
       */
      async renderAll() {
        if (this.dom.bikeListSkeleton) this.dom.bikeListSkeleton.classList.remove('hidden');
        if (this.dom.bikeList) this.dom.bikeList.classList.add('hidden');
        
        // Parallelize rendering
        await Promise.all([
          this.renderBikeList(),
          this.renderStatsDashboard()
        ]);
        
        if (this.dom.bikeListSkeleton) this.dom.bikeListSkeleton.classList.add('hidden');
        if (this.dom.bikeList) this.dom.bikeList.classList.remove('hidden');
      }
      
      /**
       * Fetches, filters, sorts, and renders the list of bikes.
       */
      async renderBikeList() {
        let bikes;
        
        try {
          if (this.currentFilters.status === 'sold') {
            bikes = await this.db.bikes.where('[dateSelling+_deleted]').above(['', false]).toArray();
          } else if (this.currentFilters.status === 'unsold') {
            bikes = await this.db.bikes.where({ dateSelling: '', _deleted: false }).toArray();
          } else {
            bikes = await this.db.bikes.where('_deleted').equals(false).toArray();
          }
        } catch (e) {
          console.error("Failed to query database:", e);
          bikes = (await this.db.bikes.filter(b => !b._deleted).toArray()).filter(b => {
            if (this.currentFilters.status === 'sold') return b.dateSelling && b.dateSelling !== '';
            if (this.currentFilters.status === 'unsold') return !b.dateSelling || b.dateSelling === '';
            return true;
          });
        }
        
        // Apply search filter
        if (this.currentFilters.search) {
          const search = this.currentFilters.search;
          bikes = bikes.filter(b => 
            (b.no && b.no.toLowerCase().includes(search)) || 
            (b.owner && b.owner.toLowerCase().includes(search))
          );
        }
        
        // Apply sorting
        bikes = this.sortBikes(bikes, this.currentFilters.sort);
        
        // Apply pagination
        this.totalPages = Math.max(1, Math.ceil(bikes.length / ITEMS_PER_PAGE));
        this.currentPage = Math.min(this.currentPage, this.totalPages);
        const startIdx = (this.currentPage - 1) * ITEMS_PER_PAGE;
        const paginatedBikes = bikes.slice(startIdx, startIdx + ITEMS_PER_PAGE);
        
        if (bikes.length === 0) {
          if (this.dom.bikeList) this.dom.bikeList.innerHTML = '';
          if (this.dom.bikeListEmpty) this.dom.bikeListEmpty.classList.remove('hidden');
          if (this.dom.pagination) this.dom.pagination.classList.add('hidden');
          return;
        }
        
        if (this.dom.bikeListEmpty) this.dom.bikeListEmpty.classList.add('hidden');
        
        // Render list
        requestAnimationFrame(() => {
          if (!this.dom.bikeList) return;
          this.dom.bikeList.innerHTML = paginatedBikes.map(bike => this.createBikeCardHTML(bike)).join('');
          
          if (this.totalPages > 1) {
            this.dom.pagination.classList.remove('hidden');
            document.getElementById('page-info').textContent = `Page ${this.currentPage} of ${this.totalPages}`;
            document.getElementById('prev-page').disabled = this.currentPage === 1;
            document.getElementById('next-page').disabled = this.currentPage === this.totalPages;
          } else {
            this.dom.pagination.classList.add('hidden');
          }
        });
      }
      
      sortBikes(bikes, sortType) {
        return [...bikes].sort((a, b) => {
          switch (sortType) {
            case 'latest':
              return new Date(b._updatedAt || 0) - new Date(a._updatedAt || 0);
            case 'oldest':
              return new Date(a._updatedAt || 0) - new Date(b._updatedAt || 0);
            case 'profit-high':
              return (parseFloat(b.netProfit) || 0) - (parseFloat(a.netProfit) || 0);
            case 'profit-low':
              return (parseFloat(a.netProfit) || 0) - (parseFloat(b.netProfit) || 0);
            case 'plate':
              return (a.no || '').localeCompare(b.no || '');
            case 'owner':
              return (a.owner || '').localeCompare(b.owner || '');
            default:
              return 0;
          }
        });
      }
      
      /**
       * Generates the HTML string for a single bike card.
       */
      createBikeCardHTML(bike) {
        if (!bike) return '';
        
        const isSold = !!(bike.dateSelling && bike.dateSelling !== '');
        const profit = parseFloat(bike.netProfit) || 0;
        let profitClass = 'profit-value';
        let profitDisplay = `${this.settings.currency} ${this.formatCurrency(profit)}`;
        
        if (!isSold) {
          profitClass += ' unrealized';
          profitDisplay = 'Unsold';
        } else if (profit < 0) {
          profitClass += ' loss';
        } else if (profit === 0) {
          profitClass = 'text-secondary';
        }
        
        const isSelected = this.selectedBikes.has((bike._id || '').toString());
        const hasPhoto = !!bike.photo;
        
        const thumbnailHTML = hasPhoto
          ? `<div class="bike-card-thumbnail" data-action="view-photo">
               <img src="${bike.photo}" alt="${this.escapeHtml(bike.no || '')}" loading="lazy" />
             </div>`
          : `<div class="bike-card-thumbnail" data-action="view-photo">
               <svg><use href="#icon-image"></use></svg>
             </div>`;
           
        // [v7.0] Add wrapper and swipe actions
        return `
          <div class="bike-list-wrapper" data-id="${bike._id || ''}">
            <div class="bike-card-actions">
              <button class="action-sell" data-action="sell" aria-label="Sell">
                <svg><use href="#icon-sell"></use></svg>
                <span>Sell</span>
              </button>
              <button class="action-dupe" data-action="duplicate" aria-label="Duplicate">
                <svg><use href="#icon-duplicate"></use></svg>
                <span>Dupe</span>
              </button>
              <button class="action-delete" data-action="delete" aria-label="Delete">
                <svg><use href="#icon-delete"></use></svg>
                <span>Delete</span>
              </button>
            </div>
            <div class="bike-card ${isSelected ? 'selected' : ''} ${hasPhoto ? 'has-photo' : ''}" role="listitem" tabindex="0">
              <div class="bike-checkbox" role="checkbox" aria-checked="${isSelected}" aria-label="Select ${this.escapeHtml(bike.no || '')}" data-action="select">
                <svg><use href="#icon-check"></use></svg>
              </div>
              ${thumbnailHTML}
              <div class="bike-card-main">
                <div class="bike-card-plate">${this.escapeHtml(bike.no || '')}</div>
                <div class="bike-card-owner">${this.escapeHtml(bike.owner || '')}</div>
              </div>
              <div class="bike-card-profit">
                <div class="${profitClass}">${profitDisplay}</div>
              </div>
            </div>
          </div>
        `;
      }
      
      handleBikeListClick(e) {
        const wrapper = e.target.closest('.bike-list-wrapper');
        if (!wrapper) return;
        
        const id = wrapper.dataset.id;
        const action = e.target.closest('[data-action]')?.dataset.action;

        // Handle swipe button clicks
        if (action === 'sell') {
          this.handleEditBike(id, 'sell');
          this.resetSwipedCard(wrapper);
          return;
        }
        if (action === 'duplicate') {
          this.handleDuplicateBike(id);
          this.resetSwipedCard(wrapper);
          return;
        }
        if (action === 'delete') {
          this.handleDeleteBike(id);
          this.resetSwipedCard(wrapper);
          return;
        }
        
        // Handle main card actions
        if (action === 'select' || (e.shiftKey || e.ctrlKey || e.metaKey)) {
          this.toggleBikeSelection(id);
        } else if (action === 'view-photo') {
          this.showImageModal(id);
        } else {
          // Default click: edit
          this.handleEditBike(id);
        }
      }
      
      toggleBikeSelection(id) {
        const idStr = id.toString();
        if (this.selectedBikes.has(idStr)) {
          this.selectedBikes.delete(idStr);
        } else {
          this.selectedBikes.add(idStr);
        }
        this.updateBulkActionBar();
        this.renderBikeList(); // Just re-render to update styles
      }
      
      updateBulkActionBar() {
        const bar = document.getElementById('bulk-action-bar');
        const count = this.selectedBikes.size;
        document.getElementById('selected-count').textContent = count;
        bar.classList.toggle('active', count > 0);
      }
      
      clearSelection() {
        this.selectedBikes.clear();
        this.updateBulkActionBar();
        this.renderBikeList();
      }
      
      changePage(delta) {
        const newPage = this.currentPage + delta;
        if (newPage >= 1 && newPage <= this.totalPages) {
          this.currentPage = newPage;
          this.renderBikeList();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }
      
      async showImageModal(id) {
        try {
          const bike = await this.db.bikes.get(Number(id));
          if (bike && bike.photo) {
            document.getElementById('image-modal-img').src = bike.photo;
            this.dom.imageModal.classList.add('active');
          } else if (bike) {
            this.showToast("No photo available for this bike.", 'info');
          }
        } catch(e) {
          console.error('Failed to load image:', e);
        }
      }

      /**
       * Fetches data and renders the stats dashboard.
       */
      async renderStatsDashboard() {
        // Show skeleton loaders
        if (this.dom.statsSkeleton) this.dom.statsSkeleton.classList.remove('hidden');
        if (this.dom.statsContent) this.dom.statsContent.classList.add('hidden');
        if (this.dom.statsEmpty) this.dom.statsEmpty.classList.add('hidden');
        
        let bikes = await this.db.bikes.filter(b => !b._deleted).toArray();
        
        if (this.statsDateFilter.from || this.statsDateFilter.to) {
          bikes = bikes.filter(b => {
            if (!b.dateSelling) return false;
            const saleDate = new Date(b.dateSelling);
            if (this.statsDateFilter.from && saleDate < new Date(this.statsDateFilter.from)) return false;
            if (this.statsDateFilter.to) {
              const toDate = new Date(this.statsDateFilter.to);
              toDate.setDate(toDate.getDate() + 1);
              if (saleDate >= toDate) return false;
            }
            return true;
          });
        }
        
        const soldBikes = bikes.filter(b => b.dateSelling && b.dateSelling !== '');
        const unsoldBikes = bikes.filter(b => !b.dateSelling || b.dateSelling === '');
        
        // --- Render Top Stats ---
        const totalProfit = soldBikes.reduce((sum, b) => sum + parseFloat(b.netProfit || 0), 0);
        const unsoldValue = unsoldBikes.reduce((sum, b) => sum + parseFloat(b.purchasePrice || 0) + parseFloat(b.repairCost || 0), 0);
        
        document.getElementById('stat-total-profit').textContent = this.formatCurrency(totalProfit);
        document.getElementById('stat-unsold-value').textContent = this.formatCurrency(unsoldValue);
        document.getElementById('stat-sold-count').textContent = soldBikes.length;
        document.getElementById('stat-unsold-count').textContent = unsoldBikes.length;

        // --- Render AI Insight & Goal ---
        this.generateAIInsight(soldBikes, unsoldBikes);
        this.renderProfitGoal(totalProfit);

        // --- Render Performance Metrics ---
        this.renderPerformanceMetrics(soldBikes, unsoldBikes, totalProfit);

        // --- Render Charts ---
        // Hide/show empty state
        if (soldBikes.length === 0) {
          if (this.dom.statsSkeleton) this.dom.statsSkeleton.classList.add('hidden');
          if (this.dom.statsContent) this.dom.statsContent.classList.add('hidden');
          if (this.dom.statsEmpty) this.dom.statsEmpty.classList.remove('hidden');
          
          // Destroy old charts if they exist
          Object.keys(this.charts).forEach(key => {
            if (this.charts[key]) {
              this.charts[key].destroy();
              this.charts[key] = null;
            }
          });
          return;
        }

        if (this.dom.statsEmpty) this.dom.statsEmpty.classList.add('hidden');
        
        this.renderProfitTrendChart(soldBikes);
        this.renderProfitPieChart(soldBikes);
        this.renderTopBikesChart(soldBikes);
        
        // Hide skeletons, show content
        if (this.dom.statsSkeleton) this.dom.statsSkeleton.classList.add('hidden');
        if (this.dom.statsContent) this.dom.statsContent.classList.remove('hidden');
      }
      
      renderPerformanceMetrics(soldBikes, unsoldBikes, totalProfit) {
        if (soldBikes.length === 0) {
          document.getElementById('stat-avg-roi').textContent = '0%';
          document.getElementById('stat-profit-margin').textContent = '0%';
          document.getElementById('stat-sell-through').textContent = '0%';
          document.getElementById('stat-avg-days').textContent = '0';
          document.getElementById('stat-best-bike').textContent = '-';
          document.getElementById('stat-worst-bike').textContent = '-';
          return;
        }
        
        // Avg ROI
        let totalROI = 0;
        let roiCount = 0;
        soldBikes.forEach(b => {
          const investment = parseFloat(b.purchasePrice || 0) + parseFloat(b.repairCost || 0);
          if (investment > 0) {
            totalROI += (parseFloat(b.netProfit || 0) / investment) * 100;
            roiCount++;
          }
        });
        const avgROI = roiCount > 0 ? totalROI / roiCount : 0;
        document.getElementById('stat-avg-roi').textContent = avgROI.toFixed(1) + '%';
        
        // [v7.0] Profit Margin
        const totalRevenue = soldBikes.reduce((sum, b) => sum + parseFloat(b.sellingPrice || 0), 0);
        const profitMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
        document.getElementById('stat-profit-margin').textContent = profitMargin.toFixed(1) + '%';
        
        // [v7.0] Sell-Through Rate
        const totalInventory = soldBikes.length + unsoldBikes.length;
        const sellThrough = totalInventory > 0 ? (soldBikes.length / totalInventory) * 100 : 0;
        document.getElementById('stat-sell-through').textContent = sellThrough.toFixed(1) + '%';
        
        // Best/Worst
        const sorted = [...soldBikes].sort((a, b) => parseFloat(b.netProfit || 0) - parseFloat(a.netProfit || 0));
        document.getElementById('stat-best-bike').textContent = sorted[0]?.no || '-';
        document.getElementById('stat-worst-bike').textContent = sorted[sorted.length - 1]?.no || '-';
        
        // Avg Days to Sell
        let totalDays = 0;
        let validCount = 0;
        soldBikes.forEach(b => {
          if (b.datePurchase && b.dateSelling) {
            try {
              const days = (new Date(b.dateSelling) - new Date(b.datePurchase)) / (1000 * 60 * 60 * 24);
              if (days >= 0) {
                totalDays += days;
                validCount++;
              }
            } catch(e) {}
          }
        });
        const avgDays = validCount > 0 ? Math.round(totalDays / validCount) : 0;
        document.getElementById('stat-avg-days').textContent = avgDays;
      }
      
      renderProfitGoal(totalProfit) {
        const goal = parseFloat(this.settings.profitGoal) || 0;
        const percent = goal > 0 ? (totalProfit / goal) * 100 : 0;
        
        document.getElementById('stat-goal-profit').textContent = this.formatCurrency(totalProfit);
        document.getElementById('stat-goal-total').textContent = this.formatCurrency(goal);
        document.getElementById('stat-goal-progress').style.width = Math.min(100, percent) + '%';
        document.getElementById('stat-goal-percent').textContent = percent.toFixed(1) + '%';
      }
      
      generateAIInsight(soldBikes, unsoldBikes) {
        const insights = [];
        const avgDays = parseFloat(document.getElementById('stat-avg-days').textContent) || 0;
        const profitMargin = parseFloat(document.getElementById('stat-profit-margin').textContent) || 0;
        const sellThrough = parseFloat(document.getElementById('stat-sell-through').textContent) || 0;
        
        if (soldBikes.length === 0 && unsoldBikes.length > 0) {
          insights.push(`You have ${unsoldBikes.length} bikes in stock. Time to start selling!`);
        } else if (soldBikes.length > 0) {
          if (avgDays > 60) {
            insights.push(`Your average time to sell is ${avgDays} days. Consider lowering prices on older stock.`);
          } else if (avgDays < 15) {
            insights.push(`Bikes are selling in just ${avgDays} days on average. You might be able to increase your prices!`);
          }
          if (profitMargin < 15) {
            insights.push(`Your profit margin is ${profitMargin}%. Try to negotiate better purchase prices or increase repair efficiency.`);
          } else {
            insights.push(`A ${profitMargin}% profit margin is solid. Keep up the good work!`);
          }
          if (sellThrough < 50) {
            insights.push(`Your sell-through rate is ${sellThrough}%. Focus on marketing your unsold inventory.`);
          }
        } else {
          insights.push('Add some bikes to get started. Your journey to profit begins!');
        }
        
        if (insights.length === 0) {
          insights.push('Keep buying and selling to see more insights here.');
        }
        
        document.getElementById('ai-insight-text').textContent = insights[Math.floor(Math.random() * insights.length)];
      }

      applyStatsDateFilter() {
        this.statsDateFilter.from = document.getElementById('stats-date-from').value;
        this.statsDateFilter.to = document.getElementById('stats-date-to').value;
        this.renderStatsDashboard();
        this.showToast('Date filter applied', 'success');
      }
      
      resetStatsDateFilter() {
        this.statsDateFilter = { from: null, to: null };
        document.getElementById('stats-date-from').value = '';
        document.getElementById('stats-date-to').value = '';
        this.renderStatsDashboard();
        this.showToast('Date filter reset', 'success');
      }
      
      // --- 5. CHART.JS IMPLEMENTATION ---
      
      getChartColors() {
        const isLight = document.body.classList.contains('theme-light');
        return {
          grid: isLight ? 'rgba(0, 0, 0, 0.05)' : 'rgba(255, 255, 255, 0.05)',
          text: isLight ? '#4a5a70' : '#9fb0c2',
          accent1: '#00D0FF', accent2: '#6EE7B7',
          loss: '#ef4444', profit1: '#22c55e', profit3: '#059669',
        };
      }
      
      renderProfitTrendChart(soldBikes) {
        const canvas = document.getElementById('chart-profit-trend');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const colors = this.getChartColors();
        
        if (this.charts.profitTrend) this.charts.profitTrend.destroy();
        
        const monthlyData = soldBikes.reduce((acc, bike) => {
          if (bike.dateSelling) {
            const month = bike.dateSelling.substring(0, 7);
            acc[month] = (acc[month] || 0) + parseFloat(bike.netProfit || 0);
          }
          return acc;
        }, {});
        
        const sortedMonths = Object.keys(monthlyData).sort();
        const labels = sortedMonths.map(month => new Date(month + '-02'));
        const data = sortedMonths.map(month => monthlyData[month]);
        
        const movingAvg = data.map((val, idx, arr) => {
          if (idx < 2) return null;
          return (arr[idx] + arr[idx - 1] + arr[idx - 2]) / 3;
        });

        this.charts.profitTrend = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'Monthly Profit', data, borderColor: colors.accent1, backgroundColor: colors.accent1 + '33', fill: true, tension: 0.3 },
              { label: '3-Month Moving Avg', data: movingAvg, borderColor: colors.accent2, borderDash: [5, 5], tension: 0.3, pointRadius: 0 }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: true, labels: { color: colors.text } }, tooltip: { mode: 'index', intersect: false } },
            scales: {
              x: { type: 'time', time: { unit: 'month' }, grid: { color: colors.grid }, ticks: { color: colors.text } },
              y: { beginAtZero: true, grid: { color: colors.grid }, ticks: { color: colors.text } }
            }
          }
        });
      }
      
      renderProfitPieChart(soldBikes) {
        const canvas = document.getElementById('chart-profit-pie');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const colors = this.getChartColors();
        
        if (this.charts.profitPie) this.charts.profitPie.destroy();
        
        const profitBins = { 'Loss (< 0)': 0, 'Break Even (0)': 0, 'Profit (0 - 1k)': 0, 'Profit (1k - 5k)': 0, 'Profit (5k+)': 0 };
        soldBikes.forEach(b => {
          const p = parseFloat(b.netProfit || 0);
          if (p < 0) profitBins['Loss (< 0)']++;
          else if (p === 0) profitBins['Break Even (0)']++;
          else if (p <= 1000) profitBins['Profit (0 - 1k)']++;
          else if (p <= 5000) profitBins['Profit (1k - 5k)']++;
          else profitBins['Profit (5k+)']++;
        });

        this.charts.profitPie = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: Object.keys(profitBins),
            datasets: [{
              data: Object.values(profitBins),
              backgroundColor: [ colors.loss + 'B3', colors.text + 'B3', colors.profit3 + 'B3', colors.profit1 + 'B3', colors.accent2 + 'B3' ],
              borderColor: 'rgba(255, 255, 255, 0.1)',
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: colors.text } } } }
        });
      }
      
      renderTopBikesChart(soldBikes) {
        const canvas = document.getElementById('chart-top-bikes');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const colors = this.getChartColors();
        
        if (this.charts.topBikes) this.charts.topBikes.destroy();
        
        const topBikes = [...soldBikes].sort((a, b) => parseFloat(b.netProfit || 0) - parseFloat(a.netProfit || 0)).slice(0, 5);
          
        this.charts.topBikes = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: topBikes.map(b => b.no),
            datasets: [{ label: 'Net Profit', data: topBikes.map(b => parseFloat(b.netProfit || 0)), backgroundColor: colors.accent2 + 'B3', borderColor: colors.accent2, borderWidth: 1 }]
          },
          options: {
            responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            scales: {
              x: { beginAtZero: true, grid: { color: colors.grid }, ticks: { color: colors.text } },
              y: { grid: { color: colors.grid }, ticks: { color: colors.text } }
            },
            plugins: { legend: { display: false } }
          }
        });
      }

      downloadChart(canvasId, filename) {
        document.getElementById(canvasId).toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${filename}-${new Date().toISOString().split('T')[0]}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          this.showToast('Chart downloaded', 'success');
        });
      }
      
      async exportChartData(chartType) {
        const soldBikes = (await this.db.bikes.filter(b => !b._deleted && b.dateSelling && b.dateSelling !== '').toArray());
        
        if (chartType === 'profit') {
          const monthlyData = soldBikes.reduce((acc, bike) => {
            if (bike.dateSelling) {
              const month = bike.dateSelling.substring(0, 7);
              acc[month] = (acc[month] || 0) + parseFloat(bike.netProfit || 0);
            }
            return acc;
          }, {});
          
          const csvData = Object.keys(monthlyData).sort().map(month => ({ month, profit: monthlyData[month] }));
          this.downloadFile(this.jsonToCsv(csvData, true), `profit-trend-data-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8;');
          this.showToast('Chart data exported', 'success');
        }
      }

      // --- 6. CORE CRUD (BUY/SELL) OPERATIONS ---
      
      handleNewBike() {
        this.openFormModal('buy');
      }
      
      async handleEditBike(id, forceMode = null) {
        try {
          const bike = await this.db.bikes.get(Number(id));
          if (bike) {
            const mode = forceMode ? forceMode : ((bike.dateSelling && bike.dateSelling !== '') ? 'view' : 'sell');
            this.openFormModal(mode, bike);
          }
        } catch (error) {
          console.error("Failed to get bike for editing:", error);
          this.showToast("Could not load bike data.", 'error');
        }
      }
      
      async handleSaveBike() {
        const id = document.getElementById('form-bike-id').value;
        const plate = document.getElementById('form-no').value.trim().toUpperCase();
        const owner = document.getElementById('form-owner').value.trim();
        
        if (!plate || !owner) {
          this.showToast("Bike Plate and Owner Name are required.", 'error');
          return;
        }
        
        const purchasePrice = parseFloat(document.getElementById('form-purchasePrice').value) || 0;
        const repairCost = parseFloat(document.getElementById('form-repairCost').value) || 0;
        const sellingPrice = parseFloat(document.getElementById('form-sellingPrice').value) || 0;
        
        const bikeData = {
          no: plate,
          owner: owner,
          purchasePrice: purchasePrice,
          repairCost: repairCost,
          sellingPrice: sellingPrice,
          netProfit: sellingPrice - (purchasePrice + repairCost),
          datePurchase: document.getElementById('form-datePurchase').value || '',
          dateSelling: document.getElementById('form-dateSelling').value || '',
          photo: document.getElementById('form-temp-photo-data').value || '', // [v7.0]
          notes: document.getElementById('form-notes').value || '', // [v7.0]
          _updatedAt: new Date().toISOString(),
          _deleted: false,
        };
        
        try {
          let oldBike = null;
          if (id) {
            oldBike = await this.db.bikes.get(Number(id));
            if (oldBike.photo && !bikeData.photo) {
              bikeData.photo = oldBike.photo; // Preserve photo if not changed
            }
            await this.db.bikes.update(Number(id), {...bikeData});
            this.showToast("Bike updated successfully.", 'success');
          } else {
            oldBike = {...bikeData, _id: -1}; // Placeholder
            const newId = await this.db.bikes.add(bikeData);
            oldBike._id = newId;
            this.showToast("Bike added successfully.", 'success');
            if (bikeData.dateSelling) this.showConfetti();
          }
          
          this.addToUndoStack(id ? 'update' : 'create', oldBike);
          
          this.vibrate(20);
          this.closeFormModal();
          await this.renderAll();
          this.triggerAutoSync();
          
        } catch (error) {
          console.error("Save bike failed:", error);
          this.showToast(error.name === 'ConstraintError' ? "A bike with this plate number already exists." : "Failed to save bike.", 'error');
        }
      }
      
      async handleDeleteBike(idFromSwipe = null) {
        const id = idFromSwipe || document.getElementById('form-bike-id').value;
        if (!id) return;
        
        const bike = await this.db.bikes.get(Number(id));
        if (!bike) return;
        
        this.showConfirmModal(
          'Delete Bike?',
          `Are you sure you want to delete "${bike.no}"? This can be undone (Ctrl+Z).`,
          async () => {
            try {
              await this.db.bikes.update(Number(id), {
                _deleted: true,
                _updatedAt: new Date().toISOString()
              });
              
              this.addToUndoStack('delete', bike);
              this.showToastWithUndo("Bike deleted.", () => this.performUndo());
              
              this.vibrate(50);
              if (!idFromSwipe) this.closeFormModal(); // Only close if from modal
              await this.renderAll();
              this.triggerAutoSync();
            } catch (error) {
              console.error("Delete failed:", error);
              this.showToast("Failed to delete bike.", 'error');
            }
          }
        );
      }
      
      async handleDuplicateBike(idFromSwipe = null) {
        const id = idFromSwipe || document.getElementById('form-bike-id').value;
        if (!id) return;
        
        try {
          const bike = await this.db.bikes.get(Number(id));
          if (bike) {
            if (!idFromSwipe) this.closeFormModal();
            
            setTimeout(() => {
              this.openFormModal('buy');
              document.getElementById('form-no').value = ''; // Clear plate
              document.getElementById('form-owner').value = bike.owner || '';
              document.getElementById('form-purchasePrice').value = bike.purchasePrice || '';
              document.getElementById('form-repairCost').value = bike.repairCost || '';
              document.getElementById('form-datePurchase').value = new Date().toISOString().split('T')[0];
              document.getElementById('form-notes').value = bike.notes || '';
              // Don't copy photo
              this.showToast("Fill in the new plate number", 'info');
              document.getElementById('form-no').focus();
            }, 300);
          }
        } catch (error) {
          console.error("Duplicate failed:", error);
          this.showToast("Failed to duplicate bike.", 'error');
        }
      }
      
      handleBulkMarkSold() {
        if (this.selectedBikes.size === 0) return;
        
        // Use custom modals instead of prompts
        this.showToast("Feature coming soon: Bulk edit modal", 'info');
        // TODO: Build a custom modal to input date and price
      }
      
      async handleBulkExport() {
        if (this.selectedBikes.size === 0) return;
        
        const bikes = [];
        for (const idStr of this.selectedBikes) {
          const bike = await this.db.bikes.get(Number(idStr));
          if (bike) {
            const { _id, ...rest } = bike;
            bikes.push(rest);
          }
        }
        
        const csv = this.jsonToCsv(bikes, true);
        this.downloadFile(csv, `selected-bikes-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8;');
        this.showToast(`Exported ${bikes.length} bikes`, 'success');
      }

      // --- 7. FORM & MODAL UI ---
      
      openFormModal(mode = 'buy', bike = null) {
        const title = document.getElementById('form-title');
        const deleteBtn = document.getElementById('delete-bike-btn');
        const duplicateBtn = document.getElementById('duplicate-bike-btn');
        const saveBtn = document.getElementById('save-form-btn');
        const saveBtnText = document.getElementById('save-form-btn-text');
        const form = document.getElementById('bike-form');
        const buySection = document.getElementById('form-section-buy');
        const sellSection = document.getElementById('form-section-sell');
        const notesSection = document.getElementById('form-section-notes');
        const photoSection = document.getElementById('form-section-photo');
        
        form.reset();
        this.clearPhotoPreview();
        
        // Default states
        deleteBtn.classList.add('hidden');
        duplicateBtn.classList.add('hidden');
        saveBtn.classList.remove('hidden');
        buySection.classList.remove('readonly-section');
        sellSection.classList.add('hidden');
        sellSection.classList.remove('readonly-section');
        notesSection.classList.remove('readonly-section');
        photoSection.classList.remove('readonly-section');
        document.getElementById('form-bike-id').value = '';
        
        if (mode === 'buy') {
          title.textContent = "Buy New Bike";
          saveBtnText.textContent = "Save Purchase";
          document.getElementById('form-datePurchase').value = new Date().toISOString().split('T')[0];
        
        } else if (mode === 'sell' && bike) {
          title.textContent = "Sell Bike";
          deleteBtn.classList.remove('hidden');
          duplicateBtn.classList.remove('hidden');
          saveBtnText.textContent = "Save Sale";
          buySection.classList.add('readonly-section');
          sellSection.classList.remove('hidden');
          this.fillForm(bike);
          document.getElementById('form-dateSelling').value = new Date().toISOString().split('T')[0];
        
        } else if (mode === 'view' && bike) {
          title.textContent = "View Sale Details";
          deleteBtn.classList.remove('hidden');
          duplicateBtn.classList.remove('hidden');
          saveBtnText.textContent = "Save Changes"; // [v7.0] Allow editing sale
          
          buySection.classList.add('readonly-section');
          sellSection.classList.remove('hidden');
          sellSection.classList.remove('readonly-section'); // [v7.0] Allow editing sale
          notesSection.classList.remove('readonly-section');
          photoSection.classList.remove('readonly-section');
          this.fillForm(bike);
        }
        
        this.dom.formModal.classList.add('active');
        setTimeout(() => document.getElementById('form-no').focus(), 100);
      }
      
      fillForm(bike) {
        if (!bike) return;
        document.getElementById('form-bike-id').value = bike._id || '';
        document.getElementById('form-no').value = bike.no || '';
        document.getElementById('form-owner').value = bike.owner || '';
        document.getElementById('form-datePurchase').value = bike.datePurchase || '';
        document.getElementById('form-purchasePrice').value = bike.purchasePrice || '';
        document.getElementById('form-repairCost').value = bike.repairCost || '';
        document.getElementById('form-dateSelling').value = bike.dateSelling || '';
        document.getElementById('form-sellingPrice').value = bike.sellingPrice || '';
        document.getElementById('form-notes').value = bike.notes || ''; // [v7.0]
        
        if (bike.photo) { // [v7.0]
          document.getElementById('form-temp-photo-data').value = bike.photo;
          document.getElementById('form-photo-preview-img').src = bike.photo;
          document.getElementById('form-photo-preview').classList.add('has-image');
        }
        
        this.calculateFormProfit();
      }
      
      closeFormModal() {
        this.dom.formModal.classList.remove('active');
      }
      
      calculateFormProfit() {
        const p = parseFloat(document.getElementById('form-purchasePrice').value) || 0;
        const r = parseFloat(document.getElementById('form-repairCost').value) || 0;
        const s = parseFloat(document.getElementById('form-sellingPrice').value) || 0;
        document.getElementById('form-netProfit').value = (s - (p + r)).toFixed(2);
      }
      
      // [v7.0] Photo Preview Logic
      handlePhotoPreview(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Simple size check (e.g., 2MB)
        if (file.size > 2 * 1024 * 1024) {
          this.showToast('Image is too large (max 2MB).', 'error');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('form-photo-preview-img').src = e.target.result;
          document.getElementById('form-temp-photo-data').value = e.target.result;
          document.getElementById('form-photo-preview').classList.add('has-image');
        };
        reader.readAsDataURL(file);
      }
      
      clearPhotoPreview() {
        document.getElementById('form-photo-preview-img').src = '';
        document.getElementById('form-temp-photo-data').value = '';
        document.getElementById('form-photo-preview').classList.remove('has-image');
        document.getElementById('form-photo-input').value = null; // Reset file input
      }
      
      // [v7.0] Swipe Gesture Handlers
      handleSwipeStart(e) {
        const wrapper = e.target.closest('.bike-list-wrapper');
        if (!wrapper) return;
        
        // Reset any other swiped card
        if (this.swipedCard && this.swipedCard !== wrapper) {
          this.resetSwipedCard(this.swipedCard);
        }
        
        this.swipeTarget = wrapper;
        this.touchStartX = e.touches[0].clientX;
        this.touchMoveX = this.touchStartX;
        
        // Set transition to none for smooth dragging
        this.swipeTarget.querySelector('.bike-card').style.transition = 'none';
      }
      
      handleSwipeMove(e) {
        if (!this.swipeTarget) return;
        
        this.touchMoveX = e.touches[0].clientX;
        let deltaX = this.touchMoveX - this.touchStartX;
        
        // Only allow swiping left
        if (deltaX > 0) deltaX = 0;
        
        
        // Clamp swipe distance (e.g., 3 actions * 70px)
        const maxSwipe = -210;
        if (deltaX < maxSwipe) deltaX = maxSwipe;
        
        const cardContent = this.swipeTarget.querySelector('.bike-card');
        if (cardContent) {
          cardContent.style.transform = `translateX(${deltaX}px)`;
        }
      }
      
      handleSwipeEnd(e) {
        if (!this.swipeTarget) return;
        
        const cardContent = this.swipeTarget.querySelector('.bike-card');
        cardContent.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
        
        const deltaX = this.touchMoveX - this.touchStartX;
        
        if (deltaX < -this.swipeThreshold) {
          // Snap open
          cardContent.style.transform = `translateX(-210px)`;
          this.swipeTarget.classList.add('swiped');
          this.swipedCard = this.swipeTarget;
        } else {
          // Snap closed
          cardContent.style.transform = 'translateX(0px)';
          this.swipeTarget.classList.remove('swiped');
          this.swipedCard = null;
        }
        
        this.swipeTarget = null;
      }
      
      resetSwipedCard(wrapper) {
        if (wrapper && wrapper.classList.contains('swiped')) {
          wrapper.classList.remove('swiped');
          const cardContent = wrapper.querySelector('.bike-card');
          cardContent.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
          cardContent.style.transform = 'translateX(0px)';
        }
        if (this.swipedCard === wrapper) {
          this.swipedCard = null;
        }
      }

      // --- 8. SETTINGS HANDLERS ---
      
      handleSaveSyncSettings() {
        this.settings.gistId = document.getElementById('setting-gist-id').value.trim();
        this.settings.gistFilename = document.getElementById('setting-gist-filename').value.trim() || 'bikes_inventory.csv';
        const newPat = document.getElementById('setting-github-pat').value.trim();
        
        if (newPat && newPat !== this.settings.githubPat) {
          this.settings.githubPat = newPat;
          sessionStorage.setItem(PAT_KEY, newPat);
          // Trigger browser password save
          document.getElementById('pat-save-input').value = newPat;
          document.getElementById('pat-save-form').submit();
        }
        
        this.settings.lastSyncSha = null;
        this.saveSettings();
        this.showToast("Sync settings saved for this session.", 'success');
      }
      
      handleSaveDisplaySettings() {
        this.settings.businessName = document.getElementById('setting-business-name').value.trim();
        this.settings.currency = document.getElementById('setting-currency').value.trim();
        this.settings.profitGoal = parseFloat(document.getElementById('setting-profit-goal').value) || 0;
        this.saveSettings();
        this.showToast("Display settings saved.", 'success');
        this.renderAll();
      }
      
      async handleDataAudit() {
        const resultsEl = document.getElementById('data-audit-results');
        resultsEl.classList.remove('hidden');
        resultsEl.innerHTML = '<p>Running audit...</p>';
        
        const issues = [];
        const bikes = await this.db.bikes.filter(b => !b._deleted).toArray();
        
        bikes.forEach(b => {
          if (b.datePurchase && b.dateSelling && new Date(b.dateSelling) < new Date(b.datePurchase)) {
            issues.push(`Bike ${b.no}: Sold date is BEFORE purchase date.`);
          }
          const investment = (parseFloat(b.purchasePrice) || 0) + (parseFloat(b.repairCost) || 0);
          if (b.dateSelling && b.sellingPrice > 0) {
            const profit = (parseFloat(b.sellingPrice) || 0) - investment;
            if (Math.abs(profit - (parseFloat(b.netProfit) || 0)) > 0.01) {
              issues.push(`Bike ${b.no}: Net profit calculation seems incorrect.`);
            }
          }
          if (investment === 0 && !b.dateSelling) {
            issues.push(`Bike ${b.no}: Unsold bike has zero investment cost.`);
          }
        });
        
        if (issues.length === 0) {
          resultsEl.innerHTML = '<p class="text-success">No issues found. Your data looks clean!</p>';
        } else {
          resultsEl.innerHTML = issues.map(issue => `<p class="text-warning">${this.escapeHtml(issue)}</p>`).join('');
        }
      }

      async handleWipeData() {
        this.showConfirmModal(
          'Wipe All Data?',
          'WARNING: This will delete ALL local bike data. This action CANNOT be undone. Are you sure?',
          async () => {
            await this.db.bikes.clear();
            this.undoStack = [];
            this.saveUndoStack();
            this.showToast("All local data has been wiped.", 'success');
            this.renderAll();
          }
        );
      }
      
      // --- 9. IMPORT / EXPORT ---
      
      async exportData(format) {
        const bikes = (await this.db.bikes.filter(b => !b._deleted).toArray()).map(b => {
          const { _id, ...rest } = b;
          return rest;
        });
        if (bikes.length === 0) {
          this.showToast("No data to export.", 'warning');
          return;
        }
        
        const timestamp = new Date().toISOString().split('T')[0];
        const filename = `bike_inventory_${timestamp}`;

        if (format === 'json') {
          this.downloadFile(JSON.stringify(bikes, null, 2), `${filename}.json`, 'application/json;charset=utf-8;');
          this.showToast("Exported as JSON", 'success');
        } else if (format === 'csv') {
          this.downloadFile(this.jsonToCsv(bikes, true), `${filename}.csv`, 'text/csv;charset=utf-8;');
          this.showToast("Exported as CSV", 'success');
        } else if (format === 'xlsx') {
          this.showToast("Exporting as XLSX...", 'info');
          try {
            if (typeof XLSX === 'undefined') {
              await this.loadScript('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js');
            }
            // [v7.0] Remove photo data for XLSX as it's too large
            const xlsxBikes = bikes.map(b => {
              const { photo, ...rest } = b;
              return rest;
            });
            const ws = XLSX.utils.json_to_sheet(xlsxBikes);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Bikes');
            XLSX.writeFile(wb, `${filename}.xlsx`);
            this.showToast("Exported as XLSX (photos omitted)", 'success');
          } catch(e) {
            console.error('XLSX export failed:', e);
            this.showToast('Failed to export XLSX.', 'error');
          }
        }
      }
      
      downloadTemplate() {
        const templateData = [{
          no: 'GJ05AB1234', owner: 'John Doe', purchasePrice: 25000, repairCost: 2000,
          sellingPrice: 30000, netProfit: 3000, datePurchase: '2024-01-15',
          dateSelling: '2024-02-20', _updatedAt: new Date().toISOString(), _deleted: false,
          photo: '', notes: 'Example note'
        }];
        this.downloadFile(this.jsonToCsv(templateData, false), 'bike_template.csv', 'text/csv;charset=utf-8;');
        this.showToast("Template downloaded", 'success');
      }
      
      handleImportFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const content = e.target.result;
            let bikesToImport = (file.name.endsWith('.json')) ? JSON.parse(content) : this.csvToJson(content);
            if (!Array.isArray(bikesToImport)) throw new Error("Invalid file format.");
            
            const now = new Date().toISOString();
            const preparedBikes = bikesToImport.map(b => {
              const purchasePrice = parseFloat(b.purchasePrice) || 0;
              const repairCost = parseFloat(b.repairCost) || 0;
              const sellingPrice = parseFloat(b.sellingPrice) || 0;
              return {
                no: (b.no || '').trim().toUpperCase(),
                owner: b.owner || '',
                purchasePrice, repairCost, sellingPrice,
                netProfit: sellingPrice - (purchasePrice + repairCost),
                datePurchase: b.datePurchase || '',
                dateSelling: b.dateSelling || '',
                photo: b.photo || '', // [v7.0]
                notes: b.notes || '', // [v7.0]
                _updatedAt: b._updatedAt || now,
                _deleted: b._deleted === 'true' || b._deleted === true || false,
              };
            }).filter(b => b.no);
            
            this.showConfirmModal(
              'Import Data?',
              `Found ${preparedBikes.length} records. This will ADD new records and UPDATE existing records based on bike plate. Continue?`,
              async () => {
                await this.db.bikes.bulkPut(preparedBikes);
                this.showToast(`Successfully imported/updated ${preparedBikes.length} records.`, 'success');
                this.renderAll();
                this.triggerAutoSync();
              }
            );
          } catch (error) {
            console.error("Import failed:", error);
            this.showToast("Import failed. Check file format.", 'error');
          } finally {
            event.target.value = '';
          }
        };
        reader.readAsText(file);
      }

      async handleShareData() {
        if (!navigator.share) {
          this.showToast("Sharing not supported", 'warning');
          return;
        }
        try {
          const bikes = (await this.db.bikes.filter(b => !b._deleted).toArray()).map(b => {
            const { _id, photo, ...rest } = b; // Omit photo for sharing
            return rest;
          });
          const csv = this.jsonToCsv(bikes, true);
          const file = new File([csv], `bikes_${new Date().toISOString().split('T')[0]}.csv`, { type: 'text/csv;charset=utf-8;' });
          
          await navigator.share({
            title: 'Bike Inventory',
            text: `Bike inventory export (${bikes.length} bikes)`,
            files: [file]
          });
        } catch (error) {
          if (error.name !== 'AbortError') this.showToast("Failed to share data", 'error');
        }
      }

      // --- 10. GIST SYNC ---
      
      syncNow() { this.debouncedSyncNow(); }
      
      async syncNowInternal() {
        if (!this.isOnline) {
          this.showToast("Cannot sync. You are offline.", 'warning');
          return;
        }
        const { gistId, githubPat } = this.settings;
        if (!gistId || !githubPat) {
          this.showToast("Gist ID and GitHub PAT must be set.", 'error');
          this.navigateTo('view-settings');
          return;
        }
        
        this.setSyncStatus('syncing', 'Syncing...');
        
        try {
          // 1. Fetch remote data
          this.setSyncStatus('syncing', 'Fetching remote...');
          const remoteFile = await this.fetchFromGist();
          let remoteBikes = [];
          if (remoteFile && remoteFile.content) {
            const remoteBikesRaw = this.csvToJson(remoteFile.content);
            remoteBikes = remoteBikesRaw.map(b => {
              const purchasePrice = parseFloat(b.purchasePrice) || 0;
              const repairCost = parseFloat(b.repairCost) || 0;
              const sellingPrice = parseFloat(b.sellingPrice) || 0;
              return { ...b,
                no: (b.no || '').trim().toUpperCase(),
                owner: b.owner || '',
                purchasePrice, repairCost, sellingPrice,
                netProfit: sellingPrice - (purchasePrice + repairCost),
                _deleted: b._deleted === 'true' || b._deleted === true,
              };
            });
            this.settings.lastSyncSha = remoteFile.sha;
          }
          
          // 2. Get local data
          const localBikes = await this.db.bikes.toArray();
          
          // 3. Merge (Last Write Wins)
          this.setSyncStatus('syncing', 'Merging data...');
          const mergedBikesMap = new Map();
          for (const bike of localBikes) {
            if (bike && bike.no) mergedBikesMap.set(bike.no, bike); 
          }
          for (const remoteBike of remoteBikes) {
            if (!remoteBike || !remoteBike.no) continue;
            const localBike = mergedBikesMap.get(remoteBike.no);
            const remoteTime = new Date(remoteBike._updatedAt || 0).getTime();
            if (!localBike || (remoteTime > new Date(localBike._updatedAt || 0).getTime() && !isNaN(remoteTime))) {
              mergedBikesMap.set(remoteBike.no, remoteBike);
            }
          }
          const mergedBikes = Array.from(mergedBikesMap.values());
          
          // 4. Save merged data locally
          this.setSyncStatus('syncing', 'Saving local...');
          await this.db.transaction('rw', this.db.bikes, async () => {
            await this.db.bikes.clear();
            await this.db.bikes.bulkPut(mergedBikes);
          });
          
          // 5. Push merged data to Gist
          this.setSyncStatus('syncing', 'Pushing remote...');
          const csvContent = this.jsonToCsv(mergedBikes, false);
          
          if (!remoteFile || csvContent !== remoteFile.content) {
            const newSha = await this.pushToGist(csvContent);
            this.settings.lastSyncSha = newSha;
          }
          
          this.settings.lastSync = new Date().toISOString();
          this.saveSettings();
this.setSyncStatus('success', 'Up to date');
          this.showToast("Sync complete.", 'success'); // [COMPLETED]
          await this.renderAll(); // [COMPLETED]
          
        } catch (error) { // [COMPLETED]
          console.error("Sync failed:", error);
          this.setSyncStatus('error', 'Sync Failed');
          this.showToast(error.message || "Sync failed", 'error');
        }
      }
      
      // Note: fetchFromGist, pushToGist, and triggerAutoSync are assumed
      // to be present in the truncated v7.0 file.
      
      // --- 11. UNDO FUNCTIONALITY ---
      // [v7.0] Restoring missing helper methods from v6.3
      
      saveUndoStack() {
        try {
          localStorage.setItem(UNDO_KEY, JSON.stringify(this.undoStack));
        } catch (e) {
          console.error("Failed to save undo stack:", e);
        }
      }
      
      loadUndoStack() {
        try {
          const saved = localStorage.getItem(UNDO_KEY);
          if (saved) {
            this.undoStack = JSON.parse(saved);
            // Filter out any very old actions (e.g., > 1 day)
            const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
            this.undoStack = this.undoStack.filter(a => a.timestamp > oneDayAgo);
          }
        } catch (e) {
          console.error("Failed to load undo stack:", e);
          this.undoStack = [];
        }
      }
      
      async performUndo() {
        if (this.undoStack.length === 0) {
          this.showToast("Nothing to undo", 'info');
          return;
        }
        
        const lastAction = this.undoStack.pop();
        this.saveUndoStack();
        
        try {
          if (lastAction.action === 'delete') {
            // "Undo delete" means re-creating the bike
            await this.db.bikes.put(lastAction.data);
            this.showToast(`Restored bike: ${lastAction.data.no}`, 'success');
          } else if (lastAction.action === 'update') {
            // "Undo update" means restoring the old data
            await this.db.bikes.put(lastAction.data);
            this.showToast(`Reverted changes to: ${lastAction.data.no}`, 'success');
          } else if (lastAction.action === 'create') {
            // "Undo create" means deleting the new bike
            await this.db.bikes.delete(lastAction.data._id);
            this.showToast(`Removed new bike: ${lastAction.data.no}`, 'success');
          }
          
          await this.renderAll();
          this.triggerAutoSync();
        } catch (error) {
          console.error("Undo failed:", error);
          this.showToast("Failed to perform undo", 'error');
          // Put action back on stack if it failed
          this.undoStack.push(lastAction);
          this.saveUndoStack();
        }
      }
      
      showToastWithUndo(message, undoCallback) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast undo';
        
        toast.innerHTML = `
          <span class="toast-message">${message}</span>
          <button class="toast-action">Undo</button>
          <span class="toast-close" role="button" aria-label="Close">×</span>
        `;
        
        container.appendChild(toast);
        
        const timer = setTimeout(() => {
          if(toast.parentElement) toast.remove();
        }, 8000); // 8 second timeout
        
        toast.querySelector('.toast-action').addEventListener('click', async () => {
          clearTimeout(timer);
          if(toast.parentElement) toast.remove();
          await undoCallback();
        });
        
        toast.querySelector('.toast-close').addEventListener('click', () => {
          clearTimeout(timer);
          if(toast.parentElement) toast.remove();
        });
      }

      // --- 12. UI HELPERS ---
      
      // Note: navigateTo, setFilterStatus, setSyncStatus, updateOnlineStatus, vibrate
      // are assumed to be present in the truncated v7.0 file.
      
      /**
       * [v7.0 FEATURE] Shows a reusable confirmation modal.
       * This method was referenced in v7.0 but not defined.
       */
      showConfirmModal(title, message, onConfirm) {
        document.getElementById('confirm-title').textContent = title;
        document.getElementById('confirm-message').textContent = message;
        
        const confirmBtn = document.getElementById('confirm-ok');
        
        // Clone and replace button to remove old listeners (safer)
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        // Add the new listener
        newConfirmBtn.onclick = () => {
          this.dom.confirmModal.classList.remove('active');
          onConfirm(); // Execute the callback
        };
        
        this.dom.confirmModal.classList.add('active');
      }

      /**
       * [v7.0] Restoring missing helper methods from v6.3
       */
      showConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const particles = [];
        const particleCount = 150;
        const colors = ['#00D0FF', '#6EE7B7', '#22c55e', '#f59e0b', '#ef4444'];
        
        for (let i = 0; i < particleCount; i++) {
          particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height - canvas.height, // Start off-screen
            r: Math.random() * 6 + 2,
            d: Math.random() * particleCount,
            color: colors[Math.floor(Math.random() * colors.length)],
            tilt: Math.random() * 10 - 10,
            tiltAngleIncremental: Math.random() * 0.07 + 0.05,
            tiltAngle: 0
          });
        }
        
        let animationFrame;
        const draw = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          
          particles.forEach((p, i) => {
            ctx.beginPath();
            ctx.lineWidth = p.r / 2;
            ctx.strokeStyle = p.color;
            ctx.moveTo(p.x + p.tilt + p.r / 4, p.y);
            ctx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r / 4);
            ctx.stroke();
            
            p.tiltAngle += p.tiltAngleIncremental;
            p.y += (Math.cos(p.d) + 3 + p.r / 2) / 2;
            p.x += Math.sin(p.d);
            p.tilt = Math.sin(p.tiltAngle - i / 3) * 15;
            
            // Remove particle if it's off-screen
            if (p.y > canvas.height) {
              particles.splice(i, 1);
            }
          });
          
          if (particles.length > 0) {
            animationFrame = requestAnimationFrame(draw);
          } else {
            cancelAnimationFrame(animationFrame);
            // Clear canvas after animation
            ctx.clearRect(0, 0, canvas.width, canvas.height);
          }
        };
        
        draw();
        this.vibrate([50, 100, 50]);
      }
      
      /**
       * [v7.0] Restoring missing helper methods from v6.3
       */
      showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        toast.innerHTML = `<span class="toast-message">${this.escapeHtml(message)}</span><span class="toast-close" role="button" aria-label="Close">×</span>`;
        
        container.appendChild(toast);
        
        const timer = setTimeout(() => {
          if(toast.parentElement) toast.remove();
        }, 5000);
        
        toast.querySelector('.toast-close').addEventListener('click', () => {
          clearTimeout(timer);
          if(toast.parentElement) toast.remove();
        });
      }

      // --- 13. UTILITY FUNCTIONS ---
      // [v7.0] Restoring missing helper methods from v6.3
      
      formatCurrency(value) {
        return (value || 0).toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }
      
      downloadFile(content, fileName, contentType) {
        const a = document.createElement('a');
        const file = new Blob([content], { type: contentType });
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      }
      
      parseCsvLine(line) {
        const values = [];
        let inQuotes = false;
        let currentField = '';
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
              // Handle escaped quote ""
              currentField += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === ',' && !inQuotes) {
            values.push(currentField);
            currentField = '';
          } else {
            currentField += char;
          }
        }
        values.push(currentField);
        // Trim quotes from start/end if they weren't part of an escaped field
        return values.map(v => v.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
      }
      
      csvToJson(text) {
        if (!text || typeof text !== 'string') {
          return [];
        }
        const lines = text.split(/[\r\n]+/).map(l => l.trim()).filter(Boolean);
        if (lines.length < 2) return [];
        
        const headers = this.parseCsvLine(lines[0]);
        
        return lines.slice(1).map(line => {
          if (line.trim() === '') return null; // Skip empty lines
          const values = this.parseCsvLine(line);
          const obj = {};
          headers.forEach((header, index) => {
            obj[header] = values[index] || '';
          });
          return obj;
        }).filter(Boolean); // Filter out nulls
      }
      
      /**
       * [v7.0] Updated to include 'photo' and 'notes'
       */
      jsonToCsv(items, skipDeleted = false) {
        // Add new v7.0 fields to the header list
        const headers = [
          'no', 'owner', 'purchasePrice', 'repairCost', 'sellingPrice', 'netProfit', 
          'datePurchase', 'dateSelling', '_updatedAt', '_deleted', 'notes', 'photo'
        ];
        const headerRow = headers.map(h => `"${h}"`).join(',');
        
        let itemsToExport = items;
        if (skipDeleted) {
          itemsToExport = items.filter(item => !item._deleted);
        }
        
        const rows = itemsToExport.map(row => 
          headers.map(header => {
            const value = row[header] === undefined || row[header] === null ? '' : row[header];
            // Escape quotes by doubling them
            return `"${String(value).replace(/"/g, '""')}"`;
          }).join(',')
        );
        
        return [headerRow, ...rows].join('\r\n');
      }
      
      escapeHtml(text) {
        if (text === null || text === undefined) return '';
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }
      
      loadScript(src) {
        return new Promise((resolve, reject) => {
          if (document.querySelector(`script[src="${src}"]`)) {
            resolve(); // Already loaded
            return;
          }
          const script = document.createElement('script');
          script.src = src;
          script.onload = () => resolve();
          script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
          document.head.appendChild(script);
        });
      }
      
    } // End of BikeManagerApp class
    
    // --- Initialize the application ---
    window.app = new BikeManagerApp();
    
  </script>
</body>
</html>