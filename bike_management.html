<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Resell Management</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF and jsPDF-AutoTable for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf-autotable.umd.min.js"></script>

    <style>
        /* Custom styles for a polished, mobile-first feel */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* Prevents pull-to-refresh */
        }
        /* Make scrollbars subtle */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Hide content sections by default */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Active nav button style */
        .nav-button.active {
            color: #2563eb; /* blue-600 */
        }
        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* Toast notification */
        #toast-notification {
            transition: opacity 0.3s, transform 0.3s;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto pb-20">
        <!-- Bikes Tab -->
        <div id="bikes-tab" class="tab-content active p-4 space-y-4">
            <h1 class="text-2xl font-bold text-gray-800">Available Bikes</h1>
            <!-- Search and Filter -->
            <div class="flex gap-2">
                <input id="search-bar" type="text" placeholder="Search by Plate, Model, Owner..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="status-filter" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">All Status</option>
                    <option value="available">Available</option>
                    <option value="sold">Sold</option>
                </select>
            </div>
            <!-- Bike List -->
            <div id="bike-list" class="space-y-3">
                <!-- Bike card template -->
                <!-- 
                <div class="bg-white p-4 rounded-lg shadow space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-semibold text-gray-900">MH12AB1234 - Hero Splendor+</span>
                        <span class="px-3 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Available</span>
                    </div>
                    <p class="text-sm text-gray-600">Owner: Rohit Mehta</p>
                    <p class="text-sm text-gray-600">Purchased: 2025-11-04 for ₹50,000</p>
                    <p class="text-sm text-gray-600">Total Cost: ₹52,000 (Repair: ₹2,000)</p>
                    <button class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">Sell Bike</button>
                </div>
                -->
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content p-4 space-y-4">
            <h1 class="text-2xl font-bold text-gray-800">Analytics</h1>
            
            <!-- Summary Cards -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-lg shadow text-center">
                    <p class="text-sm text-gray-500">Net Profit</p>
                    <p id="analytics-profit" class="text-2xl font-bold text-green-600">₹0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow text-center">
                    <p class="text-sm text-gray-500">Average ROI</p>
                    <p id="analytics-roi" class="text-2xl font-bold text-blue-600">0%</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow text-center">
                    <p class="text-sm text-gray-500">Current Capital</p>
                    <p id="analytics-capital" class="text-2xl font-bold text-gray-800">₹0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow text-center">
                    <p class="text-sm text-gray-500">Total Repair Cost</p>
                    <p id="analytics-repairs" class="text-2xl font-bold text-yellow-600">₹0</p>
                </div>
            </div>

            <!-- Export Buttons -->
            <div class="bg-white p-4 rounded-lg shadow space-y-3">
                <h2 class="text-lg font-semibold">Reports & Exports</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button id="export-pdf-report" class="w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h8V4H6z" clip-rule="evenodd" /><path d="M9 11a1 1 0 10-2 0v3a1 1 0 102 0v-3zM13 11a1 1 0 10-2 0v3a1 1 0 102 0v-3z" /></svg>
                        Download Full PDF Report
                    </button>
                    <button id="export-all-csv" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2H6zm3 1a1 1 0 000 2h2a1 1 0 100-2H9zM8 6a1 1 0 011 1v4a1 1 0 11-2 0V7a1 1 0 011-1zm3 0a1 1 0 10-2 0v4a1 1 0 102 0V7z" clip-rule="evenodd" /></svg>
                        Download All Data (CSV)
                    </button>
                </div>
            </div>

            <!-- Rankings -->
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-2">Rankings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-medium text-gray-700">Top Models (by Profit)</h3>
                        <div id="analytics-top-models" class="mt-1 text-sm text-gray-600">No data</div>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-700">Top Owners (by Purchase Price)</h3>
                        <div id="analytics-top-owners" class="mt-1 text-sm text-gray-600">No data</div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content p-4 space-y-4">
            <h1 class="text-2xl font-bold text-gray-800">Settings</h1>

            <!-- Gist Sync -->
            <div class="bg-white p-4 rounded-lg shadow space-y-3">
                <h2 class="text-lg font-semibold">GitHub Gist Sync</h2>
                <p class="text-sm text-gray-600">Syncs your data to a private GitHub Gist for backup and multi-device use.</p>
                <div class="space-y-2">
                    <input id="gist-token" type="password" placeholder="GitHub Personal Access Token" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input id="gist-id" type="text" placeholder="Gist ID" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-2">
                    <button id="save-gist-settings" class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">Save</button>
                    <button id="force-sync" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">Sync Now</button>
                </div>
                <p class="text-xs text-gray-500">Last Sync: <span id="last-sync-time">Never</span></p>
            </div>

            <!-- Data Management -->
            <div class="bg-white p-4 rounded-lg shadow space-y-3">
                <h2 class="text-lg font-semibold">Data Management (Export & Backup)</h2>
                <p class="text-sm text-gray-600">Download your local data. Exports will auto-sync with Gist if online.</p>
                <div class="grid grid-cols-1 gap-3">
                    <button id="export-bikes-csv" class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">Export Bikes CSV</button>
                    <button id="export-transactions-csv" class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">Export Transactions CSV</button>
                    <button id="export-capital-log-csv" class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">Export Capital Log CSV</button>
                    <button id="clear-local-data" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Clear All Local Data</button>
                </div>
            </div>

            <!-- Manual Capital Adjustment -->
            <div class="bg-white p-4 rounded-lg shadow space-y-3">
                <h2 class="text-lg font-semibold">Manual Capital Adjustment</h2>
                <form id="capital-adjust-form" class="space-y-2">
                    <input id="capital-amount" type="number" placeholder="Amount (e.g., 10000 or -500)" class="w-full px-4 py-2 border rounded-lg" required>
                    <input id="capital-reason" type="text" placeholder="Reason (e.g., Initial Investment)" class="w-full px-4 py-2 border rounded-lg" required>
                    <button type="submit" class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">Add Adjustment</button>
                </form>
                <h3 class="font-medium text-gray-700 pt-2">Adjustment Log</h3>
                <div id="capital-log-display" class="max-h-40 overflow-y-auto text-sm text-gray-600 space-y-1">
                    <!-- Log entries here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-inner border-t border-gray-200 flex justify-around">
        <button data-tab="bikes-tab" class="nav-button active flex-1 flex flex-col items-center p-3 text-gray-600 hover:text-blue-500 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v11.494m-6.75-8.642l13.5 0M4.376 18.75l15.248 0M12 4.043l-8.25 4.87L12 13.785l8.25-4.872L12 4.043zM3.375 12.31l8.625 5.106 8.625-5.106-8.625-5.106L3.375 12.31z" /></svg>
            <span class="text-xs font-medium">Bikes</span>
        </button>
        <button data-tab="analytics-tab" class="nav-button flex-1 flex flex-col items-center p-3 text-gray-600 hover:text-blue-500 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
            <span class="text-xs font-medium">Analytics</span>
        </button>
        <button data-tab="settings-tab" class="nav-button flex-1 flex flex-col items-center p-3 text-gray-600 hover:text-blue-500 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.573-1.066z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            <span class="text-xs font-medium">Settings</span>
        </button>
    </nav>

    <!-- FAB (Floating Action Button) to Add Bike -->
    <button id="add-bike-button" class="fixed bottom-20 right-5 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
    </button>

    <!-- Modals -->

    <!-- Add Bike Modal -->
    <div id="add-bike-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white w-full max-w-md p-6 rounded-lg shadow-xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Add New Bike</h2>
                <button id="close-add-bike-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="add-bike-form" class="space-y-3">
                <div>
                    <label for="plateNo" class="block text-sm font-medium text-gray-700">Bike Number / Plate No.*</label>
                    <input type="text" id="plateNo" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    <p id="plateNo-error" class="text-red-500 text-xs mt-1 hidden">This field is required.</p>
                </div>
                <div>
                    <label for="model" class="block text-sm font-medium text-gray-700">Model Name*</label>
                    <input type="text" id="model" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    <p id="model-error" class="text-red-500 text-xs mt-1 hidden">This field is required.</p>
                </div>
                <div>
                    <label for="ownerName" class="block text-sm font-medium text-gray-700">Owner Name*</label>
                    <input type="text" id="ownerName" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    <p id="ownerName-error" class="text-red-500 text-xs mt-1 hidden">This field is required.</p>
                </div>
                <div>
                    <label for="purchasePrice" class="block text-sm font-medium text-gray-700">Buying Price*</label>
                    <input type="number" id="purchasePrice" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    <p id="purchasePrice-error" class="text-red-500 text-xs mt-1 hidden">This field is required.</p>
                </div>
                <div>
                    <label for="repairCost" class="block text-sm font-medium text-gray-700">Repair Cost (default 0)</label>
                    <input type="number" id="repairCost" placeholder="0" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="purchaseDate" class="block text-sm font-medium text-gray-700">Date of Purchase*</label>
                    <input type="date" id="purchaseDate" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    <p id="purchaseDate-error" class="text-red-500 text-xs mt-1 hidden">This field is required.</p>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition">Save Bike</button>
            </form>
        </div>
    </div>

    <!-- Sell Bike Modal -->
    <div id="sell-bike-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white w-full max-w-md p-6 rounded-lg shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Sell Bike</h2>
                <button id="close-sell-bike-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="sell-bike-form" class="space-y-3">
                <input type="hidden" id="sell-bike-id">
                <p>Selling: <span id="sell-bike-model" class="font-semibold"></span></p>
                <p>Total Cost: <span id="sell-bike-total-cost" class="font-semibold"></span></p>
                <div>
                    <label for="sellPrice" class="block text-sm font-medium text-gray-700">Selling Price*</label>
                    <input type="number" id="sellPrice" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="sellDate" class="block text-sm font-medium text-gray-700">Date of Sale*</label>
                    <input type="date" id="sellDate" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition">Confirm Sale</button>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-text" class="text-white text-lg mt-2">Syncing...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white max-w-xs z-50 hidden opacity-0 translate-x-10">
        <p id="toast-message"></p>
    </div>


    <!-- ============================================= -->
    <!-- SCRIPT BLOCK -->
    <!-- ============================================= -->
    <script type="module">
        // Import PDF generation tools from CDN
        const { jsPDF } = window.jspdf;
        const autoTable = window.jspdf.autoTable;

        const app = {
            state: {
                bikes: [], // Array of bike objects
                capitalLog: [], // Array of { id, date, type, amount, reason, bikeId }
                currentCapital: 0,
                gistId: null,
                gistToken: null,
                lastSync: null,
                isLoading: false,
                filters: {
                    search: '',
                    status: 'all'
                }
            },

            // --- DATABASE (LocalStorage) ---
            db: {
                save() {
                    try {
                        const dataToSave = {
                            bikes: app.state.bikes,
                            capitalLog: app.state.capitalLog,
                            gistId: app.state.gistId,
                            gistToken: app.state.gistToken,
                            lastSync: app.state.lastSync,
                        };
                        localStorage.setItem('bikeResellApp', JSON.stringify(dataToSave));
                    } catch (e) {
                        console.error("Error saving to localStorage", e);
                        app.ui.showToast("Error saving data. Storage might be full.", "error");
                    }
                },
                load() {
                    try {
                        const data = localStorage.getItem('bikeResellApp');
                        if (data) {
                            const parsedData = JSON.parse(data);
                            app.state.bikes = parsedData.bikes || [];
                            app.state.capitalLog = parsedData.capitalLog || [];
                            app.state.gistId = parsedData.gistId || null;
                            app.state.gistToken = parsedData.gistToken || null;
                            app.state.lastSync = parsedData.lastSync ? new Date(parsedData.lastSync) : null;
                        }
                    } catch (e) {
                        console.error("Error loading from localStorage", e);
                        app.ui.showToast("Error loading local data. It might be corrupted.", "error");
                    }
                },
                clear() {
                    if (confirm("Are you sure you want to clear ALL local data? This cannot be undone.")) {
                        localStorage.removeItem('bikeResellApp');
                        app.state.bikes = [];
                        app.state.capitalLog = [];
                        app.state.currentCapital = 0;
                        app.state.gistId = null;
                        app.state.gistToken = null;
                        app.state.lastSync = null;
                        app.logic.recalculateCapital();
                        app.ui.renderAll();
                        app.ui.showToast("Local data cleared.", "success");
                    }
                }
            },

            // --- GITHUB GIST SYNC ---
            github: {
                // Generic fetch wrapper for Gist API
                async fetchGist(url, options = {}) {
                    if (!app.state.gistToken) {
                        throw new Error("GitHub Token not set.");
                    }
                    
                    const response = await fetch(url, {
                        ...options,
                        headers: {
                            ...options.headers,
                            'Authorization': `token ${app.state.gistToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'X-GitHub-Api-Version': '2022-11-28'
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`GitHub API Error: ${errorData.message || response.statusText}`);
                    }
                    return response.json();
                },

                // Pulls all data down from Gist, merges with local
                async pullData() {
                    if (!app.state.gistId) {
                        return; // No Gist ID, skip pull
                    }
                    app.ui.setLoading(true, "Pulling data from Gist...");
                    try {
                        const gist = await app.github.fetchGist(`https://api.github.com/gists/${app.state.gistId}`);
                        
                        let remoteBikes = [];
                        let remoteCapitalLogs = [];

                        const dataFiles = Object.keys(gist.files).filter(name => name.startsWith('bike-data-'));
                        
                        for (const filename of dataFiles) {
                            const file = gist.files[filename];
                            if (file.truncated) {
                                // Content is truncated, fetch raw_url
                                const res = await fetch(file.raw_url);
                                const content = await res.json();
                                remoteBikes.push(...(content.bikes || []));
                                remoteCapitalLogs.push(...(content.capitalLog || []));
                            } else {
                                const content = JSON.parse(file.content);
                                remoteBikes.push(...(content.bikes || []));
                                remoteCapitalLogs.push(...(content.capitalLog || []));
                            }
                        }

                        // Merge logic: Simple "local overrides remote" based on ID
                        const localBikes = app.state.bikes;
                        const localLogs = app.state.capitalLog;

                        const mergedBikes = app.logic.mergeData(localBikes, remoteBikes, 'id');
                        const mergedLogs = app.logic.mergeData(localLogs, remoteCapitalLogs, 'id');

                        app.state.bikes = mergedBikes;
                        app.state.capitalLog = mergedLogs;
                        
                        app.db.save();
                        app.logic.recalculateCapital();
                        app.ui.renderAll();
                        app.ui.showToast("Data pulled from Gist.", "success");

                    } catch (error) {
                        console.error("Error pulling data:", error);
                        app.ui.showToast(`Pull failed: ${error.message}`, "error");
                    } finally {
                        app.ui.setLoading(false);
                    }
                },

                // Pushes local state up to Gist, split by month
                async pushData(silent = false) {
                    if (!app.state.gistId || !app.state.gistToken) {
                        if (!silent) app.ui.showToast("Gist ID or Token not set.", "error");
                        return;
                    }
                    
                    if (!silent) app.ui.setLoading(true, "Pushing data to Gist...");
                    
                    try {
                        // Group all data by month
                        const monthlyData = {};
                        
                        [...app.state.bikes, ...app.state.capitalLog].forEach(item => {
                            const date = new Date(item.purchaseDate || item.date);
                            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                            if (!monthlyData[monthKey]) {
                                monthlyData[monthKey] = { bikes: [], capitalLog: [] };
                            }
                        });

                        app.state.bikes.forEach(bike => {
                            const date = new Date(bike.purchaseDate);
                            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                            monthlyData[monthKey].bikes.push(bike);
                        });
                        
                        app.state.capitalLog.forEach(log => {
                            const date = new Date(log.date);
                            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                            monthlyData[monthKey].capitalLog.push(log);
                        });

                        // Create file payload for Gist API
                        const filesToUpdate = {};
                        for (const monthKey in monthlyData) {
                            const filename = `bike-data-${monthKey}.json`;
                            filesToUpdate[filename] = {
                                content: JSON.stringify(monthlyData[monthKey], null, 2)
                            };
                        }

                        if (Object.keys(filesToUpdate).length === 0) {
                            if (!silent) app.ui.showToast("No data to push.", "info");
                            return;
                        }

                        // Send PATCH request to update Gist
                        await app.github.fetchGist(`https://api.github.com/gists/${app.state.gistId}`, {
                            method: 'PATCH',
                            body: JSON.stringify({
                                description: 'Bike Resell Data (Updated)',
                                files: filesToUpdate
                            })
                        });

                        app.state.lastSync = new Date();
                        app.db.save();
                        app.ui.renderSettings(); // Update last sync time
                        if (!silent) app.ui.showToast("Sync to Gist successful!", "success");

                    } catch (error) {
                        console.error("Error pushing data:", error);
                        if (!silent) app.ui.showToast(`Sync failed: ${error.message}`, "error");
                        throw error; // Re-throw for export functions
                    } finally {
                        if (!silent) app.ui.setLoading(false);
                    }
                }
            },

            // --- CORE APP LOGIC ---
            logic: {
                init() {
                    app.db.load();
                    app.logic.recalculateCapital();
                    app.ui.init();
                    app.ui.renderAll();
                    
                    if (!app.state.gistId || !app.state.gistToken) {
                        app.ui.showToast("Please set Gist Token and ID in Settings.", "info");
                        app.ui.navigateToTab('settings-tab');
                    } else {
                        // Auto-pull data on load
                        app.github.pullData();
                    }
                },
                
                // Helper to merge arrays of objects, preferring items from arrA
                mergeData(arrA, arrB, key) {
                    const map = new Map();
                    arrA.forEach(item => map.set(item[key], item));
                    arrB.forEach(item => {
                        if (!map.has(item[key])) {
                            map.set(item[key], item);
                        }
                    });
                    return Array.from(map.values());
                },

                // Adds a new bike
                addBike(formData) {
                    // Validate
                    let isValid = true;
                    if (!formData.plateNo) {
                        app.ui.showValidationError('plateNo', 'This field is required.');
                        isValid = false;
                    } else if (app.state.bikes.some(b => b.plateNo === formData.plateNo)) {
                        app.ui.showValidationError('plateNo', 'This Plate No. already exists.');
                        isValid = false;
                    } else {
                        app.ui.hideValidationError('plateNo');
                    }

                    // Add validation for other required fields...
                    ['model', 'ownerName', 'purchasePrice', 'purchaseDate'].forEach(field => {
                        if (!formData[field]) {
                            app.ui.showValidationError(field, 'This field is required.');
                            isValid = false;
                        } else {
                            app.ui.hideValidationError(field);
                        }
                    });

                    if (!isValid) return;

                    const purchasePrice = parseFloat(formData.purchasePrice);
                    const repairCost = parseFloat(formData.repairCost || 0);
                    const totalCost = purchasePrice + repairCost;
                    const purchaseDate = new Date(formData.purchaseDate).toISOString();
                    
                    const newBike = {
                        id: `bike_${new Date().getTime()}`,
                        plateNo: formData.plateNo,
                        model: formData.model,
                        ownerName: formData.ownerName,
                        purchasePrice: purchasePrice,
                        repairCost: repairCost,
                        totalCost: totalCost,
                        purchaseDate: purchaseDate,
                        sellPrice: null,
                        sellDate: null,
                        profit: null,
                        status: 'available'
                    };

                    // Add capital log entry for the purchase
                    app.logic.addCapitalEntry(-totalCost, `Purchase: ${newBike.model} (${newBike.plateNo})`, 'buy', purchaseDate, newBike.id);

                    app.state.bikes.push(newBike);
                    app.db.save();
                    app.logic.recalculateCapital();
                    app.ui.renderAll();
                    app.ui.hideModal('add-bike-modal');
                    app.ui.showToast('Bike added successfully!', 'success');
                    app.github.pushData(true); // Auto-push in background
                },
                
                // Sells an existing bike
                sellBike(bikeId, sellPrice, sellDate) {
                    const bikeIndex = app.state.bikes.findIndex(b => b.id === bikeId);
                    if (bikeIndex === -1) {
                        app.ui.showToast('Error: Bike not found.', 'error');
                        return;
                    }
                    
                    const bike = app.state.bikes[bikeIndex];
                    const sellDateISO = new Date(sellDate).toISOString();
                    const profit = parseFloat(sellPrice) - bike.totalCost;

                    bike.sellPrice = parseFloat(sellPrice);
                    bike.sellDate = sellDateISO;
                    bike.profit = profit;
                    bike.status = 'sold';

                    // Add capital log entry for the sale
                    app.logic.addCapitalEntry(bike.sellPrice, `Sale: ${bike.model} (${bike.plateNo})`, 'sell', sellDateISO, bike.id);

                    app.db.save();
                    app.logic.recalculateCapital();
                    app.ui.renderAll();
                    app.ui.hideModal('sell-bike-modal');
                    app.ui.showToast('Bike sold!', 'success');
                    app.github.pushData(true); // Auto-push in background
                },

                // Adds a manual capital adjustment
                addCapitalEntry(amount, reason, type = 'adjust', date = null, bikeId = null) {
                    const entry = {
                        id: `cap_${new Date().getTime()}`,
                        date: date || new Date().toISOString(),
                        type: type, // 'buy', 'sell', 'adjust'
                        amount: parseFloat(amount),
                        reason: reason,
                        bikeId: bikeId
                    };
                    app.state.capitalLog.push(entry);
                },

                // Recalculates total capital from the log
                recalculateCapital() {
                    app.state.currentCapital = app.state.capitalLog.reduce((sum, entry) => sum + entry.amount, 0);
                },
                
                // --- Analytics Helpers ---
                getAnalyticsData() {
                    const soldBikes = app.state.bikes.filter(b => b.status === 'sold');
                    const netProfit = soldBikes.reduce((sum, b) => sum + b.profit, 0);
                    const totalRepairCost = app.state.bikes.reduce((sum, b) => sum + b.repairCost, 0);
                    const totalInvestment = app.state.bikes.reduce((sum, b) => sum + b.totalCost, 0);
                    const averageROI = totalInvestment > 0 ? (netProfit / totalInvestment) * 100 : 0;

                    return {
                        netProfit,
                        totalRepairCost,
                        totalInvestment,
                        averageROI,
                        currentCapital: app.state.currentCapital
                    };
                },
                
                getRankingData(key, valueKey, aggregator = 'sum') {
                    const map = new Map();
                    app.state.bikes.forEach(bike => {
                        const groupKey = bike[key];
                        const value = bike[valueKey] || 0;
                        if (!map.has(groupKey)) {
                            map.set(groupKey, { total: 0, count: 0 });
                        }
                        const entry = map.get(groupKey);
                        entry.total += value;
                        entry.count += 1;
                    });

                    let data = Array.from(map.entries()).map(([name, { total, count }]) => ({
                        name,
                        value: aggregator === 'sum' ? total : total / count
                    }));

                    return data.sort((a, b) => b.value - a.value).slice(0, 5); // Top 5
                },
                
                getMonthlyStats() {
                    const monthly = {};
                    app.state.bikes.forEach(bike => {
                        const pMonth = new Date(bike.purchaseDate).toISOString().slice(0, 7);
                        monthly[pMonth] = monthly[pMonth] || { buys: 0, sells: 0, repairs: 0, profit: 0 };
                        monthly[pMonth].buys += bike.totalCost;
                        monthly[pMonth].repairs += bike.repairCost;
                        
                        if (bike.status === 'sold') {
                            const sMonth = new Date(bike.sellDate).toISOString().slice(0, 7);
                            monthly[sMonth] = monthly[sMonth] || { buys: 0, sells: 0, repairs: 0, profit: 0 };
                            monthly[sMonth].sells += bike.sellPrice;
                            monthly[sMonth].profit += bike.profit;
                        }
                    });
                    
                    return Object.entries(monthly)
                        .map(([month, data]) => ({ month, ...data }))
                        .sort((a, b) => a.month.localeCompare(b.month));
                },

                // --- Export Helpers ---
                // Triggers sync, then runs the export function
                async exportWrapper(exportFn, loadingText = 'Preparing export...') {
                    app.ui.setLoading(true, loadingText);
                    try {
                        await app.github.pushData(true); // Silent push (auto-backup)
                    } catch (e) {
                        app.ui.showToast("Gist sync failed, exporting local data only.", "warning");
                        // Don't block export if sync fails, just warn
                    }
                    
                    try {
                        await exportFn();
                    } catch (e) {
                        console.error("Export failed:", e);
                        app.ui.showToast(`Export failed: ${e.message}`, "error");
                    } finally {
                        app.ui.setLoading(false);
                    }
                },
                
                // Helper to create and download a CSV
                downloadCSV(data, headers, filename) {
                    const sanitize = (val) => {
                        if (val === null || val === undefined) return '';
                        let str = String(val);
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            str = `"${str.replace(/"/g, '""')}"`;
                        }
                        return str;
                    };

                    const headerKeys = Object.keys(headers);
                    const csvRows = [headerKeys.map(k => headers[k]).join(',')]; // Header row

                    for (const row of data) {
                        const values = headerKeys.map(key => sanitize(row[key]));
                        csvRows.push(values.join(','));
                    }
                    
                    const csvContent = csvRows.join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    app.logic.downloadBlob(blob, filename);
                },
                
                // Helper to trigger blob download
                downloadBlob(blob, filename) {
                    const link = document.createElement('a');
                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', filename);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }
                }
            },

            // --- UI/VIEW LAYER ---
            ui: {
                init() {
                    // Tab Navigation
                    document.querySelector('nav').addEventListener('click', (e) => {
                        const navButton = e.target.closest('.nav-button');
                        if (navButton) {
                            app.ui.navigateToTab(navButton.dataset.tab);
                        }
                    });

                    // Modals
                    document.getElementById('add-bike-button').addEventListener('click', () => {
                        document.getElementById('add-bike-form').reset();
                        app.ui.hideAllErrors();
                        // Set default purchase date to today
                        document.getElementById('purchaseDate').valueAsDate = new Date();
                        app.ui.showModal('add-bike-modal');
                    });
                    document.getElementById('close-add-bike-modal').addEventListener('click', () => app.ui.hideModal('add-bike-modal'));
                    document.getElementById('close-sell-bike-modal').addEventListener('click', () => app.ui.hideModal('sell-bike-modal'));

                    // Forms
                    document.getElementById('add-bike-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        const data = Object.fromEntries(formData.entries());
                        app.logic.addBike(data);
                    });
                    
                    document.getElementById('sell-bike-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const bikeId = document.getElementById('sell-bike-id').value;
                        const sellPrice = document.getElementById('sellPrice').value;
                        const sellDate = document.getElementById('sellDate').value;
                        if (bikeId && sellPrice && sellDate) {
                            app.logic.sellBike(bikeId, sellPrice, sellDate);
                        }
                    });
                    
                    document.getElementById('capital-adjust-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const amount = parseFloat(document.getElementById('capital-amount').value);
                        const reason = document.getElementById('capital-reason').value;
                        if (amount && reason) {
                            app.logic.addCapitalEntry(amount, reason, 'adjust');
                            app.db.save();
                            app.logic.recalculateCapital();
                            app.ui.renderCapitalLog();
                            app.ui.renderAnalytics();
                            document.getElementById('capital-adjust-form').reset();
                            app.github.pushData(true); // Auto-push
                        }
                    });

                    // Settings
                    document.getElementById('save-gist-settings').addEventListener('click', () => {
                        app.state.gistToken = document.getElementById('gist-token').value;
                        app.state.gistId = document.getElementById('gist-id').value;
                        app.db.save();
                        app.ui.showToast('Gist settings saved!', 'success');
                    });
                    document.getElementById('force-sync').addEventListener('click', () => app.github.pushData());
                    document.getElementById('clear-local-data').addEventListener('click', () => app.db.clear());
                    
                    // Filters
                    document.getElementById('search-bar').addEventListener('input', (e) => {
                        app.state.filters.search = e.target.value.toLowerCase();
                        app.ui.renderBikeList();
                    });
                    document.getElementById('status-filter').addEventListener('change', (e) => {
                        app.state.filters.status = e.target.value;
                        app.ui.renderBikeList();
                    });
                    
                    // --- Export Button Listeners ---
                    document.getElementById('export-pdf-report').addEventListener('click', () => {
                        app.logic.exportWrapper(app.export.fullPDFReport, 'Generating PDF Report...');
                    });
                    document.getElementById('export-all-csv').addEventListener('click', () => {
                        app.logic.exportWrapper(app.export.allDataCSV, 'Generating Master CSV...');
                    });
                    document.getElementById('export-bikes-csv').addEventListener('click', () => {
                        app.logic.exportWrapper(app.export.bikesCSV, 'Exporting Bikes CSV...');
                    });
                    // Note: Transactions CSV and Capital Log CSV are the same data.
                    document.getElementById('export-transactions-csv').addEventListener('click', () => {
                        app.logic.exportWrapper(app.export.capitalLogCSV, 'Exporting Transactions CSV...');
                    });
                    document.getElementById('export-capital-log-csv').addEventListener('click', () => {
                        app.logic.exportWrapper(app.export.capitalLogCSV, 'Exporting Capital Log CSV...');
                    });
                },

                renderAll() {
                    app.ui.renderBikeList();
                    app.ui.renderAnalytics();
                    app.ui.renderSettings();
                    app.ui.renderCapitalLog();
                },

                navigateToTab(tabId) {
                    // Hide all content
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    // Deactivate all nav buttons
                    document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                    
                    // Show target content
                    document.getElementById(tabId).classList.add('active');
                    // Activate target nav button
                    document.querySelector(`.nav-button[data-tab="${tabId}"]`).classList.add('active');
                    
                    // Show/Hide FAB
                    document.getElementById('add-bike-button').classList.toggle('hidden', tabId !== 'bikes-tab');
                },

                renderBikeList() {
                    const listEl = document.getElementById('bike-list');
                    const { search, status } = app.state.filters;
                    
                    const filteredBikes = app.state.bikes
                        .filter(bike => {
                            const matchesStatus = (status === 'all') || (bike.status === status);
                            const matchesSearch = !search ||
                                bike.plateNo.toLowerCase().includes(search) ||
                                bike.model.toLowerCase().includes(search) ||
                                bike.ownerName.toLowerCase().includes(search);
                            return matchesStatus && matchesSearch;
                        })
                        .sort((a, b) => new Date(b.purchaseDate) - new Date(a.purchaseDate)); // Newest first

                    if (filteredBikes.length === 0) {
                        listEl.innerHTML = `<p class="text-gray-500 text-center mt-4">No bikes found.</p>`;
                        return;
                    }

                    listEl.innerHTML = filteredBikes.map(bike => {
                        const isAvailable = bike.status === 'available';
                        const statusClass = isAvailable ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
                        
                        return `
                        <div class="bg-white p-4 rounded-lg shadow space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold text-gray-900">${bike.plateNo} - ${bike.model}</span>
                                <span class="px-3 py-1 text-xs font-medium rounded-full ${statusClass}">${bike.status}</span>
                            </div>
                            <p class="text-sm text-gray-600">Owner: ${bike.ownerName}</p>
                            <p class="text-sm text-gray-600">Purchased: ${new Date(bike.purchaseDate).toLocaleDateString()} for ${app.ui.formatCurrency(bike.purchasePrice)}</p>
                            <p class="text-sm text-gray-600">Total Cost: ${app.ui.formatCurrency(bike.totalCost)} (Repair: ${app.ui.formatCurrency(bike.repairCost)})</p>
                            ${isAvailable ? 
                                `<button data-id="${bike.id}" class="sell-button w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">Sell Bike</button>` :
                                `<div class="text-sm text-gray-600">
                                    <p>Sold: ${new Date(bike.sellDate).toLocaleDateString()} for ${app.ui.formatCurrency(bike.sellPrice)}</p>
                                    <p class="font-medium ${bike.profit >= 0 ? 'text-green-600' : 'text-red-600'}">Profit: ${app.ui.formatCurrency(bike.profit)}</p>
                                </div>`
                            }
                        </div>
                        `;
                    }).join('');
                    
                    // Add event listeners for sell buttons
                    listEl.querySelectorAll('.sell-button').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const bikeId = e.target.dataset.id;
                            const bike = app.state.bikes.find(b => b.id === bikeId);
                            if (bike) {
                                document.getElementById('sell-bike-id').value = bike.id;
                                document.getElementById('sell-bike-model').textContent = `${bike.plateNo} - ${bike.model}`;
                                document.getElementById('sell-bike-total-cost').textContent = app.ui.formatCurrency(bike.totalCost);
                                document.getElementById('sell-bike-form').reset();
                                document.getElementById('sellDate').valueAsDate = new Date();
                                app.ui.showModal('sell-bike-modal');
                            }
                        });
                    });
                },
                
                renderAnalytics() {
                    const stats = app.logic.getAnalyticsData();
                    document.getElementById('analytics-profit').textContent = app.ui.formatCurrency(stats.netProfit);
                    document.getElementById('analytics-roi').textContent = `${stats.averageROI.toFixed(1)}%`;
                    document.getElementById('analytics-capital').textContent = app.ui.formatCurrency(stats.currentCapital);
                    document.getElementById('analytics-repairs').textContent = app.ui.formatCurrency(stats.totalRepairCost);
                    
                    // Rankings
                    const topModels = app.logic.getRankingData('model', 'profit');
                    const topOwners = app.logic.getRankingData('ownerName', 'purchasePrice');
                    
                    document.getElementById('analytics-top-models').innerHTML = topModels.length ? 
                        topModels.map(m => `<div>${m.name}: <span class="font-medium ${m.value >= 0 ? 'text-green-700' : 'text-red-700'}">${app.ui.formatCurrency(m.value)}</span></div>`).join('') :
                        'No data';
                        
                    document.getElementById('analytics-top-owners').innerHTML = topOwners.length ? 
                        topOwners.map(o => `<div>${o.name}: <span class="font-medium">${app.ui.formatCurrency(o.value)}</span></div>`).join('') :
                        'No data';
                },

                renderSettings() {
                    document.getElementById('gist-token').value = app.state.gistToken || '';
                    document.getElementById('gist-id').value = app.state.gistId || '';
                    document.getElementById('last-sync-time').textContent = app.state.lastSync ? app.state.lastSync.toLocaleString() : 'Never';
                },
                
                renderCapitalLog() {
                    const logEl = document.getElementById('capital-log-display');
                    const sortedLog = [...app.state.capitalLog].sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    logEl.innerHTML = sortedLog.map(entry => {
                        const color = entry.amount > 0 ? 'text-green-600' : 'text-red-600';
                        return `
                        <div class="flex justify-between items-center">
                            <span>${new Date(entry.date).toLocaleDateString()}: ${entry.reason}</span>
                            <span class="${color} font-medium">${app.ui.formatCurrency(entry.amount)}</span>
                        </div>
                        `;
                    }).join('');
                },
                
                // --- UI Helpers ---
                formatCurrency(amount) {
                    return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);
                },
                
                showModal(id) { document.getElementById(id).classList.remove('hidden'); },
                hideModal(id) { document.getElementById(id).classList.add('hidden'); },
                
                setLoading(isLoading, text = 'Loading...') {
                    app.state.isLoading = isLoading;
                    const overlay = document.getElementById('loading-overlay');
                    document.getElementById('loading-text').textContent = text;
                    overlay.classList.toggle('hidden', !isLoading);
                },
                
                showToast(message, type = 'info') {
                    const toast = document.getElementById('toast-notification');
                    const msgEl = document.getElementById('toast-message');
                    
                    msgEl.textContent = message;
                    
                    toast.classList.remove('bg-blue-500', 'bg-green-500', 'bg-red-500', 'bg-yellow-500', 'hidden', 'opacity-0', 'translate-x-10');
                    
                    let bgColor = 'bg-blue-500';
                    if (type === 'success') bgColor = 'bg-green-500';
                    if (type === 'error') bgColor = 'bg-red-500';
                    if (type === 'warning') bgColor = 'bg-yellow-500';
                    
                    toast.classList.add(bgColor, 'opacity-100');
                    
                    setTimeout(() => {
                        toast.classList.remove('opacity-100');
                        toast.classList.add('opacity-0', 'translate-x-10');
                        setTimeout(() => toast.classList.add('hidden'), 300);
                    }, 3000);
                },
                
                showValidationError(field, message) {
                    const errorEl = document.getElementById(`${field}-error`);
                    if (errorEl) {
                        errorEl.textContent = message;
                        errorEl.classList.remove('hidden');
                    }
                    document.getElementById(field).classList.add('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
                },
                
                hideValidationError(field) {
                    const errorEl = document.getElementById(`${field}-error`);
                    if (errorEl) {
                        errorEl.classList.add('hidden');
                    }
                    document.getElementById(field).classList.remove('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
                },
                
                hideAllErrors() {
                    document.querySelectorAll('.text-red-500.text-xs').forEach(el => el.classList.add('hidden'));
                    document.querySelectorAll('#add-bike-form input').forEach(el => {
                        el.classList.remove('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
                    });
                }
            },
            
            // --- EXPORT FUNCTIONS ---
            export: {
                // Analytics Tab -> Download Full PDF Report
                async fullPDFReport() {
                    const doc = new jsPDF();
                    const stats = app.logic.getAnalyticsData();
                    const monthlyStats = app.logic.getMonthlyStats();
                    const topModels = app.logic.getRankingData('model', 'profit');
                    const topOwners = app.logic.getRankingData('ownerName', 'purchasePrice');
                    
                    doc.setFontSize(18);
                    doc.text("Bike Resell - Full Report", 14, 22);
                    doc.setFontSize(11);
                    doc.text(`Report Generated: ${new Date().toLocaleString()}`, 14, 28);
                    
                    // Summary Table
                    autoTable(doc, {
                        startY: 35,
                        head: [['Metric', 'Value']],
                        body: [
                            ['Net Profit', app.ui.formatCurrency(stats.netProfit)],
                            ['Current Capital', app.ui.formatCurrency(stats.currentCapital)],
                            ['Total Repair Cost', app.ui.formatCurrency(stats.totalRepairCost)],
                            ['Total Investment', app.ui.formatCurrency(stats.totalInvestment)],
                            ['Average ROI', `${stats.averageROI.toFixed(1)}%`],
                        ]
                    });
                    
                    let lastY = doc.lastAutoTable.finalY + 10;
                    
                    // Per-Month Summary
                    autoTable(doc, {
                        startY: lastY,
                        head: [['Month', 'Buys', 'Repairs', 'Sells', 'Profit']],
                        body: monthlyStats.map(m => [
                            m.month,
                            app.ui.formatCurrency(m.buys),
                            app.ui.formatCurrency(m.repairs),
                            app.ui.formatCurrency(m.sells),
                            app.ui.formatCurrency(m.profit)
                        ]),
                        didDrawPage: (data) => lastY = data.cursor.y + 10
                    });
                    
                    // Rankings
                    autoTable(doc, {
                        startY: lastY,
                        head: [['Top Model', 'Profit']],
                        body: topModels.map(m => [m.name, app.ui.formatCurrency(m.value)]),
                        didDrawPage: (data) => lastY = data.cursor.y + 10
                    });
                    
                    autoTable(doc, {
                        startY: lastY,
                        head: [['Top Owner', 'Purchase Value']],
                        body: topOwners.map(o => [o.name, app.ui.formatCurrency(o.value)]),
                        didDrawPage: (data) => lastY = data.cursor.y + 10
                    });

                    // All Bikes List
                    doc.addPage();
                    doc.text("All Bikes", 14, 22);
                    autoTable(doc, {
                        startY: 30,
                        head: [['Plate No', 'Model', 'Owner', 'Total Cost', 'Sell Price', 'Profit', 'Status']],
                        body: app.state.bikes.map(b => [
                            b.plateNo,
                            b.model,
                            b.ownerName,
                            app.ui.formatCurrency(b.totalCost),
                            app.ui.formatCurrency(b.sellPrice),
                            app.ui.formatCurrency(b.profit),
                            b.status
                        ])
                    });
                    
                    // Capital Log
                    doc.addPage();
                    doc.text("Capital Ledger", 14, 22);
                    autoTable(doc, {
                        startY: 30,
                        head: [['Date', 'Type', 'Reason', 'Amount']],
                        body: app.state.capitalLog.map(l => [
                            new Date(l.date).toLocaleString(),
                            l.type,
                            l.reason,
                            app.ui.formatCurrency(l.amount)
                        ])
                    });
                    
                    doc.save(`Bike-Report-${new Date().toISOString().slice(0, 10)}.pdf`);
                },
                
                // Analytics Tab -> Download All Data (CSV)
                // This combines bikes and capital log into one "master ledger"
                async allDataCSV() {
                    const masterLedger = [];
                    app.state.capitalLog.forEach(log => {
                        masterLedger.push({
                            date: log.date,
                            type: log.type,
                            description: log.reason,
                            amount: log.amount,
                            profit: log.type === 'sell' ? app.state.bikes.find(b => b.id === log.bikeId)?.profit || 0 : '',
                            bike_plate: log.bikeId ? app.state.bikes.find(b => b.id === log.bikeId)?.plateNo || '' : '',
                            model: log.bikeId ? app.state.bikes.find(b => b.id === log.bikeId)?.model || '' : '',
                        });
                    });
                    
                    masterLedger.sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    const headers = {
                        date: 'Date',
                        type: 'Type',
                        description: 'Description',
                        amount: 'Amount',
                        profit: 'Profit',
                        bike_plate: 'Plate No',
                        model: 'Model'
                    };
                    
                    app.logic.downloadCSV(masterLedger, headers, 'All-Data-Ledger.csv');
                },
                
                // Settings Tab -> Export Bikes CSV
                async bikesCSV() {
                    const headers = {
                        id: 'ID',
                        plateNo: 'Plate No',
                        model: 'Model',
                        ownerName: 'Owner Name',
                        purchaseDate: 'Purchase Date',
                        purchasePrice: 'Purchase Price',
                        repairCost: 'Repair Cost',
                        totalCost: 'Total Cost',
                        status: 'Status',
                        sellDate: 'Sell Date',
                        sellPrice: 'Sell Price',
                        profit: 'Profit'
                    };
                    app.logic.downloadCSV(app.state.bikes, headers, 'Bikes-Export.csv');
                },
                
                // Settings Tab -> Export Capital Log CSV (also used for Transactions)
                async capitalLogCSV() {
                    const headers = {
                        id: 'ID',
                        date: 'Date',
                        type: 'Type',
                        amount: 'Amount',
                        reason: 'Reason',
                        bikeId: 'Bike ID'
                    };
                    app.logic.downloadCSV(app.state.capitalLog, headers, 'Capital-Log-Export.csv');
                }
            }
        };

        // Start the application
        app.logic.init();

    </script>
</body>
</html>
